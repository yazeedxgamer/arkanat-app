function convertArabicNumeralsToEnglish(str) {
  if (!str) return '';
  return str.toString().replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
}
let pageHiddenTimestamp = null;
const INACTIVITY_REFRESH_TIME = 5 * 60 * 1000; // 5 دقائق

document.addEventListener('visibilitychange', () => {
    if (currentUser && currentUser.role === 'حارس أمن') {
        if (document.visibilityState === 'hidden') {
            pageHiddenTimestamp = Date.now();
        } else if (document.visibilityState === 'visible' && pageHiddenTimestamp) {
            const inactiveDuration = Date.now() - pageHiddenTimestamp;

            if (inactiveDuration > INACTIVITY_REFRESH_TIME) {
                console.log('Page was inactive for more than 10 minutes for a guard. Refreshing...');
                location.reload();
            }
            
            pageHiddenTimestamp = null;
        }
    }
});

/**
 * دالة لتنسيق التاريخ فقط بالصيغة الميلادية (DD/MM/YYYY)
 * @param {string | Date} dateInput - التاريخ المراد تنسيقه
 * @returns {string} - التاريخ المنسق أو 'غير محدد'
 */
function formatGregorianDate(dateInput) {
    if (!dateInput) return 'غير محدد';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) {
            return 'تاريخ غير صالح';
        }
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // الشهر يبدأ من 0
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    } catch (e) {
        console.error("Date formatting error:", e);
        return 'غير محدد';
    }
}

/**
 * دالة لتنسيق التاريخ والوقت بالصيغة الميلادية (DD/MM/YYYY, HH:MM AM/PM)
 * @param {string | Date} dateInput - التاريخ والوقت المراد تنسيقه
 * @returns {string} - التاريخ والوقت المنسق أو 'غير محدد'
 */
function formatGregorianDateTime(dateInput) {
    if (!dateInput) return 'غير محدد';
    try {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) {
            return 'تاريخ غير صالح';
        }
        const formattedDate = formatGregorianDate(date);
        const formattedTime = date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        return `${formattedDate} - ${formattedTime}`;
    } catch (e) {
        console.error("DateTime formatting error:", e);
        return 'غير محدد';
    }
}
/**
 * دالة مساعدة للتحقق مما إذا كانت وردية الحارس فعالة الآن (نسخة مطورة)
 * @param {object} guard - كائن بيانات الحارس مع تفاصيل شاغره الوظيفي
 * @returns {boolean} - true إذا كانت الوردية فعالة الآن
 */
function isGuardShiftActiveNow(guard) {
    const schedule = guard.job_vacancies?.schedule_details?.[0];
    if (!schedule) return false;

    const now = new Date();
    const scheduleForToday = getScheduleForDate(schedule, now);
    if (!scheduleForToday) {
        return false;
    }

    const currentTime = now.toTimeString().substring(0, 5);
    const periods = scheduleForToday.periods; // استخدام فترات اليوم الصحيحة

    for (const period of periods) {
        const startTime = period.start_time;
        const endTime = period.end_time;

        if (!startTime || !endTime) continue;
        if (endTime < startTime) {
            if (currentTime >= startTime || currentTime < endTime) {
                return true;
            }
        } else { // التعامل مع الورديات النهارية العادية
            if (currentTime >= startTime && currentTime < endTime) {
                return true;
            }
        }
    }

    return false; // ليس ضمن أي فترة عمل فعالة الآن
}
    async function exportHrAttendanceLogToExcel() {
    const exportBtn = document.getElementById('export-hr-log-btn');
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري التجهيز...';

    try {
        const dateFromStr = document.getElementById('att-log-date-from').value;
        const dateToStr = document.getElementById('att-log-date-to').value;

        if (!dateFromStr || !dateToStr) {
            throw new Error('الرجاء تحديد تاريخ البداية والنهاية في الفلاتر أولاً.');
        }

        const startDate = new Date(dateFromStr);
        const endDate = new Date(dateToStr);

        let usersQuery = supabaseClient.from('users')
            .select(`id, name, region, project, location, city, job_vacancies!users_vacancy_id_fkey(schedule_details)`)
            .eq('role', 'حارس أمن');

        const region = document.getElementById('hr-filter-region-attlog').value;
        const city = document.getElementById('hr-filter-city-attlog').value;
        const project = document.getElementById('hr-filter-project-attlog').value;
        const location = document.getElementById('hr-filter-location-attlog').value;
        const searchVal = document.getElementById('hr-filter-search-attlog').value;

        if (searchVal) usersQuery = usersQuery.or(`name.ilike.%${searchVal}%`);
        if (region) usersQuery = usersQuery.eq('region', region);
        if (city) usersQuery = usersQuery.eq('city', city);
        if (project) usersQuery = usersQuery.filter('project', 'cs', `{${project}}`);
        if (location) usersQuery = usersQuery.eq('location', location);

        const { data: filteredGuards, error: guardsError } = await usersQuery;
        if (guardsError) throw guardsError;
        if (filteredGuards.length === 0) throw new Error('لا يوجد حراس يطابقون الفلاتر المحددة.');

        const guardIds = filteredGuards.map(g => g.id);

        const { data: records, error: recordsError } = await supabaseClient.from('attendance')
            .select(`*`)
            .in('guard_id', guardIds)
            .gte('created_at', startDate.toISOString())
            .lte('created_at', new Date(new Date(dateToStr).setDate(new Date(dateToStr).getDate() + 1)).toISOString());
        if (recordsError) throw recordsError;

        const recordsMap = new Map();
        records.forEach(rec => {
            const dateKey = new Date(rec.created_at).toISOString().split('T')[0];
            const mapKey = `${rec.guard_id}-${dateKey}`;
            recordsMap.set(mapKey, rec);
        });

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('سجل الحضور', { views: [{ rightToLeft: true }] });
        const staticHeaders = ['اسم الحارس', 'المنطقة', 'المشروع', 'الموقع', 'الوردية', 'إجمالي الغياب', 'إجمالي الاستئذان', 'إجمالي الانسحاب'];
        const subHeaders = ['الحالة', 'الحضور', 'الانصراف', 'ملاحظات'];

        const headerRow1 = worksheet.addRow([]); // صف التواريخ
        const headerRow2 = worksheet.addRow(staticHeaders); // صف العناوين الأساسية والفرعية

        staticHeaders.forEach((header, i) => {
            worksheet.mergeCells(1, i + 1, 2, i + 1);
            worksheet.getCell(1, i + 1).value = header;
        });

        const dateArray = [];
        for (let d = new Date(dateFromStr); d <= new Date(dateToStr); d.setDate(d.getDate() + 1)) {
            dateArray.push(new Date(d));
        }

        let currentColumn = staticHeaders.length + 1;
        dateArray.forEach(date => {
            const dateString = `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
            worksheet.mergeCells(1, currentColumn, 1, currentColumn + 3);
            worksheet.getCell(1, currentColumn).value = dateString;
            subHeaders.forEach((sub, i) => { worksheet.getCell(2, currentColumn + i).value = sub; });
            currentColumn += 5;
        });

        filteredGuards.forEach(guard => {
            const defaultShiftDetails = guard.job_vacancies?.schedule_details?.[0];
            let absentCount = 0, permissionCount = 0, withdrawalCount = 0;
            const dailyData = dateArray.map(date => {
                const scheduleForDay = getScheduleForDate(defaultShiftDetails, date);
                const mapKey = `${guard.id}-${date.toISOString().split('T')[0]}`;
                const attendance = recordsMap.get(mapKey);
                let status = '';

                if (attendance) {
                    status = attendance.status;
                    if (status === 'اكمل المناوبة' && scheduleForDay) {
                        const checkinDate = new Date(attendance.created_at);
                        const checkoutDate = attendance.checkout_at ? new Date(attendance.checkout_at) : null;
                        const dailyWorkHours = scheduleForDay.periods.reduce((total, p) => {
                            let diff = (new Date(`1970-01-01T${p.end_time}`) - new Date(`1970-01-01T${p.start_time}`)) / 3600000;
                            if (diff < 0) diff += 24;
                            return total + diff;
                        }, 0);

                        if(checkoutDate && ((checkoutDate - checkinDate) / 3600000 > (dailyWorkHours + 4))) {
                        status = 'انصراف تلقائي';
                        }
                    }
                } else {
                    status = scheduleForDay ? 'غياب' : 'راحة';
                }

                if (status.includes('غياب')) absentCount++;
                if (status.includes('استئذان')) permissionCount++;
                if (status.includes('انسحاب')) withdrawalCount++;

                return { status, scheduleForDay, attendance };
            });

            const projectNameClean = String(guard.project || '').replace(/[\[\]"]/g, '');
            const rowData = [guard.name, guard.region, projectNameClean, guard.location, createShiftTimeLabel(defaultShiftDetails), absentCount, permissionCount, withdrawalCount];

            dailyData.forEach(data => {
                if (data.attendance) {
                    rowData.push(data.status, formatTimeAMPM(new Date(data.attendance.created_at).toTimeString().substring(0, 5)), data.attendance.checkout_at ? formatTimeAMPM(new Date(data.attendance.checkout_at).toTimeString().substring(0, 5)) : '-', data.attendance.notes || '-', '');
                } else {
                    if (data.status === 'غياب') {
                        rowData.push('لا يوجد', '-', '-', '-', '');
                    } else { // راحة
                        rowData.push('راحة', '-', '-', '-', '');
                    }
                }
            });
            worksheet.addRow(rowData);
        });
        const statusColors = {
            'حاضر': 'FFC6EFCE', // أخضر
            'اكمل المناوبة': 'FFC7DFFF', // سماوي
            'انصراف تلقائي': 'FFE9D5FF', // بنفسجي فاتح
            'غياب': 'FFFFC7CE', // أحمر
            'لا يوجد': 'FFFFF8E1', // بيج فاتح
            'انسحاب': 'FFFFE0B2', // برتقالي
            'انسحاب (انصراف مبكر)': 'FFFFE0B2',
            'استئذان': 'FFFFEB9C', // أصفر
            'راحة': 'FFF1F5F9', // رمادي فاتح جداً
        };

        const mainHeaderStyle = { font: { bold: true, color: { argb: 'FFFFFFFF' }, name: 'Cairo', size: 11 }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } }, alignment: { horizontal: 'center', vertical: 'middle' }, border: { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } } };
        const dateHeaderStyle = { ...mainHeaderStyle, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4A5568' } } };
        const subHeaderStyle = { ...mainHeaderStyle, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF3b82f6' } } };
        const delimiterHeaderStyle = { ...subHeaderStyle, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF6b7280' } } };

        worksheet.getRow(1).eachCell(cell => Object.assign(cell, mainHeaderStyle));
        worksheet.getRow(2).eachCell(cell => { if(cell.value) Object.assign(cell, mainHeaderStyle) });

        for(let i = 0; i < dateArray.length; i++) {
            const col = staticHeaders.length + 1 + (i*5);
            worksheet.getCell(1, col).style = dateHeaderStyle;
            for (let j=0; j<4; j++) { worksheet.getCell(2, col + j).style = subHeaderStyle; }
            worksheet.getCell(2, col).style = delimiterHeaderStyle;
            worksheet.getCell(2, col+3).style = delimiterHeaderStyle;
        }

        worksheet.eachRow((row, rowNumber) => {
            if (rowNumber > 2) {
                for (let i = 0; i < dateArray.length; i++) {
                    const dayStartCol = staticHeaders.length + 1 + (i * 5);
                    const statusCell = row.getCell(dayStartCol);
                    const statusValue = statusCell.value;
                    const color = statusColors[statusValue];
                    if (color) {
                        const fillStyle = { type: 'pattern', pattern: 'solid', fgColor: { argb: color } };
                        for (let j = 0; j < 4; j++) {
                            row.getCell(dayStartCol + j).fill = fillStyle;
                        }
                    }
                }
            }
        });

        worksheet.columns.forEach(column => { column.width = 15; column.alignment = { horizontal: 'center', vertical: 'middle' }; });
        worksheet.getColumn(1).width = 25;
        for (let i = 0; i < dateArray.length; i++) {
            const spacerColIndex = staticHeaders.length + (i * 5) + 5;
            worksheet.getColumn(spacerColIndex).width = 3;
        }

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `سجل_الحضور_${dateFromStr}_الى_${dateToStr}.xlsx`;
        link.click();

    } catch (error) {
        alert('حدث خطأ أثناء التصدير: ' + error.message);
        console.error(error);
    } finally {
        exportBtn.disabled = false;
        exportBtn.innerHTML = '<i class="ph-bold ph-file-xls"></i> تصدير Excel';
    }
}
function updateUIVisibility(role) {
    if (!currentUser) return;

    const allLinks = document.querySelectorAll('.sidebar-nav li');
    const customPermissions = currentUser.ui_permissions?.allowed_pages || [];
    const highCommandLinkItem = document.getElementById('high-command-link');
    if (highCommandLinkItem) {
        if (currentUser.name === 'High Commander') {
            highCommandLinkItem.style.display = 'block';
        } else {
            highCommandLinkItem.style.display = 'none';
        }
    }
    const deptRequestsLinkItem = document.getElementById('dept-requests-link');
    const managerRolesList = [
        'ادارة العمليات', 
        'ادارة الموارد البشرية', 
        'ادارة العقود', 
        'المالية', 
        'التسويق', 
        'الشؤون القانونية'
    ];
    const isManager = managerRolesList.includes(currentUser.role) || [
        'is_hr_manager', 'is_ops_manager', 'is_contracts_manager', 
        'is_finance_manager', 'is_marketing_manager', 'is_legal_manager'
    ].some(perm => currentUser[perm] === true);

    if (deptRequestsLinkItem) {
        if (isManager && currentUser.name !== 'High Commander') {
            deptRequestsLinkItem.style.display = 'block';
        } else {
            deptRequestsLinkItem.style.display = 'none';
        }
    }
    const superAdminLink = document.getElementById('super-admin-link');
    if (superAdminLink) {
        if (currentUser.role === 'مدير النظام' || currentUser.name === 'High Commander') {
            superAdminLink.style.display = 'block';
        } else {
            superAdminLink.style.display = 'none';
        }
    }

    const managerMap = {
        is_hr_manager: 'ادارة الموارد البشرية',
        is_ops_manager: 'ادارة العمليات',
        is_contracts_manager: 'ادارة العقود',
        is_finance_manager: 'المالية',
        is_marketing_manager: 'التسويق',
        is_legal_manager: 'الشؤون القانونية'
    };

    allLinks.forEach(item => {
        let canView = false;
        const pageLink = item.querySelector('a');
        if (!pageLink) return;
        if (item.id === 'super-admin-link' || item.id === 'high-command-link' || item.id === 'dept-requests-link') return;

        const pageId = pageLink.dataset.page;
        const requiredPermission = item.dataset.permission;
        const allowedRoles = item.dataset.role ? item.dataset.role.split(',') : [];
        if (pageId === 'page-admin-monitor') {
            if (currentUser.name === 'High Commander' || isManager || currentUser.role === 'مدير النظام') {
                canView = true;
            } else {
                canView = false;
            }
        }
        if (currentUser.name === 'High Commander') {
            item.style.display = 'block';
            return; // ننتقل للعنصر التالي فوراً
        }
        if (customPermissions.includes(pageId)) {
            canView = true;
        } 
        else if (currentUser.role === 'مدير النظام') {
            if (!currentUser.ui_permissions || !currentUser.ui_permissions.allowed_pages) {
                canView = true;
            }
        }
        else {
            if (allowedRoles.includes('all')) {
                canView = true;
            } else {
                let hasManagerRole = false;
                for (const managerFlag in managerMap) {
                    if (currentUser[managerFlag] === true) {
                        hasManagerRole = true;
                        const departmentRole = managerMap[managerFlag];
                        if (allowedRoles.includes(departmentRole) || requiredPermission === managerFlag) {
                            canView = true;
                        }
                    }
                }

                if (!hasManagerRole) {
                    const hasRole = allowedRoles.includes(role);
                    if (hasRole) {
                        if (requiredPermission && requiredPermission.startsWith('can_')) {
                            if (currentUser[requiredPermission] === true) canView = true;
                        } else if (['ادارة الموارد البشرية', 'ادارة العمليات', 'ادارة العقود', 'المالية', 'التسويق', 'الشؤون القانونية'].includes(role) && customPermissions) {
                             if (customPermissions.includes(pageId)) canView = true;
                        } else {
                            const standardRoles = ['حارس أمن', 'مشرف', 'ادارة العمليات', 'ادارة الموارد البشرية', 'ادارة العقود', 'المالية', 'التسويق', 'الشؤون القانونية', 'ادارة العهد'];
                            if (standardRoles.includes(role)) canView = true;
                        }
                    }
                }
            }
        }
        if (currentUser.employment_status === 'تغطية' && (pageId === 'page-my-requests' || pageId === 'page-my-schedule')) {
            canView = false;
        }
        if (pageId === 'page-dept-permissions') {
            if (currentUser.name === 'High Commander' || currentUser.role === 'مدير النظام' || isManager) {
                canView = true;
            } else {
                canView = false;
            }
        }
        if (pageId === 'page-admin-history') {
             if (currentUser.name === 'High Commander' || currentUser.role === 'ادارة الموارد البشرية' || currentUser.role === 'مدير النظام') {
                 canView = true;
             } else {
                 canView = false;
             }
        }
        if (pageId === 'page-my-requests') {
            if (role === 'حارس أمن' || role === 'مشرف') canView = true;
            else canView = false;
        }
        if (pageId === 'page-admin-requests') {
            if (role !== 'حارس أمن' && role !== 'مشرف') canView = true;
            else canView = false;
        }
        if (pageId === 'page-admin-attendance') {
            if (role !== 'حارس أمن' && role !== 'مشرف') {
                canView = true;
            } else {
                canView = false;
            }
        }
        if (pageId === 'page-admin-payroll') {
            if (currentUser.name === 'High Commander' || currentUser.role === 'ادارة الموارد البشرية') {
                canView = true;
            } else {
                canView = false;
            }
        }
        if (pageId === 'page-attendance') {
            if (role === 'حارس أمن' && !currentUser.is_exempt_from_attendance) {
                canView = true;
            } else {
                canView = false;
            }
        }

        item.style.display = canView ? 'block' : 'none';
    });

    const managerTabs = document.querySelectorAll('.manager-only-tab');
    managerTabs.forEach(tab => {
        const requiredPermission = tab.dataset.permission;
        if (currentUser.name === 'High Commander' || currentUser.role === 'مدير النظام' || currentUser[requiredPermission] === true) {
            tab.style.display = 'flex';
        } else {
            tab.style.display = 'none';
        }
    });
}


/**
 * دالة مركزية لتهيئة واجهة المستخدم والإشتراكات المباشرة بعد تسجيل الدخول
 * @param {object} userProfile - بيانات المستخدم الذي سجل دخوله
 */
async function initializeUserSession(userProfile) {
    currentUser = userProfile;

    // --- بداية الإضافة: طلب إذن الموقع للتطبيق (لبيئة الجوال Capacitor) ---
    if (window.Capacitor) {
        try {
            const { Geolocation } = Capacitor.Plugins;
            const permissionStatus = await Geolocation.checkPermissions();
            if (permissionStatus.location !== 'granted') {
                await Geolocation.requestPermissions();
            }
        } catch (e) {
            console.log("Error requesting permissions: ", e);
        }
    }
    // --- نهاية الإضافة ---

    // الاشتراك في التحديثات المباشرة لصلاحيات المستخدم
    supabaseClient
        .channel(`realtime:user:${currentUser.id}`)
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'users',
            filter: `id=eq.${currentUser.id}`
        }, async (payload) => {
            showToast('تم تحديث صلاحياتك من قبل المدير.', 'info');
            await refreshCurrentUser();
            updateUIVisibility(currentUser.role);
            
            // منطق الطرد الفوري أو إعادة التوجيه
            const currentPageId = sessionStorage.getItem('lastVisitedPage');
            if (currentPageId) {
                const currentPageLink = document.querySelector(`.sidebar-nav a[data-page="${currentPageId}"]`);
                if (currentPageLink && currentPageLink.parentElement.style.display === 'none') {
                    const firstAvailableLink = document.querySelector('.sidebar-nav li[style*="display: block"] a');
                    if (firstAvailableLink) {
                        firstAvailableLink.click();
                    } else {
                        document.getElementById('logout-btn').click();
                    }
                }
            }
        })
        .subscribe();

    // تخزين الجلسة وتحديث الواجهة
    sessionStorage.setItem('currentUser', JSON.stringify(userProfile));
    updateUIVisibility(currentUser.role);
    document.getElementById('login-page').style.display = 'none';
    document.querySelector('.dashboard-container').classList.remove('hidden');
    
    const userProfileSpan = document.querySelector('.user-profile span');
    if (userProfileSpan) userProfileSpan.textContent = `مرحباً، ${currentUser.name}`;

    // عرض الإعلانات والاشتراك بها
    displayActiveAnnouncements();
    supabaseClient
        .channel('public:announcements')
        .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'announcements' },
            (payload) => {
                console.log('Real-time announcement update received!', payload);
                displayActiveAnnouncements();
            }
        )
        .subscribe();

    console.log('Subscribed to real-time announcements channel.');

    // تحديث التنبيهات والشارات
    updateNotificationBell();
    setInterval(updateNotificationBell, 60000);

    updateSidebarBadges(); 
    setInterval(updateSidebarBadges, 60000); 

    // اشتراك مباشر لتحديث الشارات
    const realtimeChannel = supabaseClient
        .channel('public:all_tables:badges')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'employee_requests' }, () => updateSidebarBadges())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'job_applications' }, () => updateSidebarBadges())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'coverage_applicants' }, () => updateSidebarBadges())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'directives' }, () => updateSidebarBadges())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'job_vacancies', filter: `id=eq.${userProfile.vacancy_id}` }, (payload) => {
            console.log('Vacancy details changed, checking if attendance page is active.');
            if (document.querySelector('#page-attendance:not(.hidden)')) {
                console.log('Attendance page is active, reloading data...');
                loadAttendancePage();
            }
        })
        .subscribe();

    handleRouteChange(true);

    // التحقق من وجود جلسة حضور نشطة للحراس لاستئناف التتبع
    if (currentUser.role === 'حارس أمن') {
        supabaseClient
            .from('attendance')
            .select('*')
            .eq('guard_id', currentUser.id)
            .eq('status', 'حاضر') 
            .is('checkout_at', null)
            .maybeSingle()
            .then(({ data: activeRecord }) => {
                if (activeRecord) {
                    console.log("تم اكتشاف جلسة حضور نشطة. محاولة تفعيل التتبع...");
                    
                    // محاولة استخراج بيانات الموقع من "لقطة الوردية"
                    let trackingDetails = activeRecord.shift_snapshot;

                    // إذا لم تكن اللقطة موجودة، نستخدم بيانات الموظف الحالية
                    if (!trackingDetails || !trackingDetails.geofence_link) {
                        const vacancy = userProfile.job_vacancies;
                        const contractLocs = vacancy?.contracts?.contract_locations;
                        const locationData = contractLocs?.find(l => l.name === userProfile.location);
                        
                        if (locationData && locationData.geofence_link) {
                            trackingDetails = {
                                ...vacancy, 
                                geofence_link: locationData.geofence_link,
                                geofence_radius: locationData.geofence_radius || 200
                            };
                        }
                    }

                    // تشغيل التتبع إذا توفرت البيانات
                    if (trackingDetails && trackingDetails.geofence_link) {
                        startPersistentTracking(trackingDetails, activeRecord.id).catch(err => {
                            console.warn("لم يتم تفعيل التتبع التلقائي (ربما تم الرفض):", err);
                        });
                    }
                }
            });
    }
}

async function refreshCurrentUser() {
    if (currentUser && currentUser.id) {
        const { data, error } = await supabaseClient
            .from('users')
            .select('*, can_edit_attendance, can_edit_contracts, can_delete_contracts, can_delete_vacancies, can_manage_admin_staff, is_ops_manager, is_hr_manager, is_contracts_manager, is_finance_manager, is_marketing_manager, is_legal_manager, ui_permissions')
            .eq('id', currentUser.id)
            .single();
        if (data) {
            currentUser = data;
            sessionStorage.setItem('currentUser', JSON.stringify(data));
        }
    }
}
document.addEventListener('DOMContentLoaded', () => {
    const assignmentModal = document.getElementById('site-assignment-modal');
    if (!assignmentModal) return;

    const regionFilter = document.getElementById('assignment-filter-region');
    const cityFilter = document.getElementById('assignment-filter-city');
    const searchInput = document.getElementById('assignment-search-input');

    const triggerRender = () => {
        const filters = {
            region: regionFilter.value,
            city: cityFilter.value,
            search: searchInput.value
        };
        renderAssignmentTree(filters);
    };

    regionFilter.addEventListener('change', () => {
        const selectedRegion = regionFilter.value;
        cityFilter.innerHTML = '<option value="">اختر منطقة أولاً</option>';
        cityFilter.disabled = true;

        if (selectedRegion && window.allContractsForAssignment) {
            const cities = new Set();
            window.allContractsForAssignment.forEach(c => {
                c.contract_locations.forEach(l => {
                    if (l.region === selectedRegion) cities.add(l.city);
                });
            });
            populateDropdown(cityFilter, [...cities].sort(), 'كل المدن');
        }
        triggerRender();
    });

    cityFilter.addEventListener('change', triggerRender);

    searchInput.addEventListener('input', () => {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(triggerRender, 300);
    });
});

async function handleRouteChange(isInitialLoad = false) {
    if (inventoryPageSubscription) { supabaseClient.removeChannel(inventoryPageSubscription); inventoryPageSubscription = null; }
    if (attendancePageInterval) {
        clearInterval(attendancePageInterval);
        attendancePageInterval = null;
    }
    if (!isInitialLoad) {
        await refreshCurrentUser();
        updateUIVisibility(currentUser.role); 
    }

    if (activeSubscription) {
        supabaseClient.removeChannel(activeSubscription);
        activeSubscription = null;
    }
    if (pageRefreshInterval) {
        clearInterval(pageRefreshInterval);
        pageRefreshInterval = null;
    }
    if (adminMonitorInterval) { 
        clearInterval(adminMonitorInterval); 
        adminMonitorInterval = null; 
    }

    const path = window.location.pathname;
    let linkToActivate = document.querySelector(`.sidebar-nav a[href="${path}"]`);
    if (!linkToActivate) {
        linkToActivate = document.querySelector('.sidebar-nav li[style*="display: block"] a');
        if (linkToActivate) {
            history.replaceState(null, '', linkToActivate.getAttribute('href'));
        } else {
            alert('لا توجد لديك صلاحيات للوصول لأي صفحة حالياً.');
            document.getElementById('logout-btn').click();
            return;
        }
    }
    if (linkToActivate.parentElement.style.display === 'none') {
        alert('ليس لديك صلاحية للوصول إلى هذه الصفحة.');
        const defaultLink = document.querySelector('.sidebar-nav li[style*="display: block"] a');
        if (defaultLink) {
            history.replaceState(null, '', defaultLink.getAttribute('href'));
            handleRouteChange(); // إعادة تشغيل الدالة لتوجيهه للصفحة الصحيحة
        }
        return; // إيقاف التنفيذ
    }

    const targetPageId = linkToActivate.dataset.page;
    sessionStorage.setItem('lastVisitedPage', targetPageId);

    const activeBadge = linkToActivate.querySelector('.menu-badge');
    if (activeBadge && !activeBadge.classList.contains('hidden')) {
        setTimeout(() => { activeBadge.classList.add('hidden'); }, 500);
    }

    document.getElementById('main-title').textContent = linkToActivate.querySelector('span').textContent;
    document.querySelectorAll('.sidebar-nav a').forEach(navLink => navLink.classList.remove('active'));
    linkToActivate.classList.add('active');

    document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
    const targetPage = document.getElementById(targetPageId);

    if (targetPage) {
        targetPage.classList.remove('hidden');

        const pageLoaders = {
            'page-geo': () => { initializeGeoFilters(); initializeMap(); },
            'page-employees': () => { initializeFilters('hr-employees'); loadEmployeeTabData(); },
            'page-hr-attendance-log': () => { initializeFilters('hr-attlog'); loadHrAttendanceLogPage(); },
            'page-attendance-management': () => { initializeFilters('hr-attmgmt'); loadAttendanceManagementPage(); },
            'page-payroll': () => {
                document.getElementById('payroll-results-container').innerHTML = '<p style="text-align: center;">الرجاء اختيار الشهر والضغط على "توليد المسير" لعرض البيانات.</p>';
                initializeFilters('hr-payroll');
            },
            'page-vacancies': () => { initializeFilters('vc'); loadVacancyTabData(); },'page-payroll-settings': loadPayrollSettingsPage,
            'page-contracts': () => { initializeContractFilters(); fetchContracts(); },
            'page-penalties': loadPenaltiesPage,'page-manage-system': () => loadDepartmentManagementPage('page-manage-system'),
            'page-coverage': loadCoverageKanbanPage,'page-admin-attendance': loadAdminAttendancePage,
            'page-inventory': loadInventoryPage,'page-admin-payroll': loadAdminPayrollPage,'page-payroll-dashboard': loadPayrollDashboardPage,
            'page-vehicles': loadVehiclesPage,'page-admin-history': loadAdminHistoryPage,
            'page-guard-assets': loadGuardAssetsPage,'page-high-command': loadHighCommandPage,'page-dept-permissions': loadDeptPermissionsPage,'page-dept-requests': loadDeptPermissionsPage,'page-dept-requests': loadCmdInbox,
            'page-admin-assets': loadAdminAssetsPage,'page-admin-requests': loadAdminRequestsPage,
            'page-asset-reports': loadAssetReportsPage,
            'page-supervisor-applications': () => { loadSupervisorApplicationsPage(); pageRefreshInterval = setInterval(loadSupervisorApplicationsPage, 60000); },
            'page-attendance': loadAttendancePage, 'page-my-requests': loadMyRequestsPage, 'page-permission-requests': loadPermissionRequests,
            'page-ops-review-requests': loadOpsReviewRequestsPage, 'page-visits': fetchVisits, 'page-my-profile': loadMyProfilePage,'page-my-requests': loadMyRequestsPage,
            'page-cfo-approvals': loadCfoApprovalsPage,
            'page-ceo-approvals': loadCeoApprovalsPage,'page-hr-admin-reviews': loadHrAdminReviews,
            'page-auditor-approvals': loadAuditorApprovalsPage,
            'page-finance-ready-to-pay': loadFinanceReadyToPayPage,
            'page-finance-archive': loadFinanceArchivePage,'page-supervisor-resignations': loadSupervisorResignationsPage,
'page-legal-resignations': loadLegalResignationsPage,
'page-finance-loans': loadFinanceLoansPage,'page-finance-new-request': loadFinanceNewRequestPage,
            'page-admin-dashboard': loadAdminDashboardPage, 'page-announcements': loadAnnouncementsPage, 'page-user-management': loadUserManagementPage,'page-admin-staff': loadAdminStaffData,
            'page-manage-ops': () => loadDepartmentManagementPage('page-manage-ops'),
            'page-manage-hr': () => loadDepartmentManagementPage('page-manage-hr'),
            'page-manage-contracts': () => loadDepartmentManagementPage('page-manage-contracts'),
            'page-manage-finance': () => loadDepartmentManagementPage('page-manage-finance'),
            'page-manage-marketing': () => loadDepartmentManagementPage('page-manage-marketing'),
            'page-manage-legal': () => loadDepartmentManagementPage('page-manage-legal'),
            'page-ops-nominees': loadOpsNomineesPage, 'page-directives-ops': loadOpsDirectivesPage, 'page-guard-attendance': () => { initializeGuardAttendanceFilters(); loadGuardAttendancePage(); },
            'page-patrol': loadSupervisorPatrolPage, 'page-supervisor-schedules': () => { initializeFilters('ss'); loadSupervisorSchedulesPage(); }, 'page-supervisor-permission-requests': loadSupervisorPermissionRequestsPage,
            'page-supervisor-custody': loadSupervisorCustodyPage, 'page-finance-custody': loadFinanceCustodyPage,
            'page-hr-data-entry': () => { document.getElementById('import-results-container').innerHTML = ''; }, 'page-official-holidays': loadHolidaysPage,
            'page-hr-ops-hiring': loadHrOpsHiringPage, 'page-leave-requests': loadLeaveRequests,'page-legal-penalties': loadLegalPenaltiesPage,
            'page-resignation-requests': loadResignationRequests,'page-end-of-service': loadEndOfServicePage, 'page-loan-requests': loadLoanRequests, 'page-requests-archive': () => loadArchivePage('leave'),
            'page-my-directives': loadMyDirectivesPage, 'page-my-schedule': loadMySchedulePage, 'page-my-visits': loadMyVisitsPage,'page-marketing-clients': loadMarketingClientsPage,'page-marketing-calendar': loadMarketingCalendarPage,'page-legal-calendar': loadLegalCalendarPage,'page-legal-employee-lookup': loadLegalEmployeeLookupPage,'page-blacklist': loadBlacklistPage,'page-lawsuits': loadLawsuitsPage,'page-settlements': loadSettlementsPage,
            'page-hr-sms': () => {}
        };

        if (pageLoaders[targetPageId]) {
            pageLoaders[targetPageId]();
        }
    }
}
/**
 * دالة لحساب تفاصيل الوردية القادمة لموظف (نسخة مطورة)
 * @param {object} schedule - كائن يحتوي على تفاصيل الوردية
 * @returns {object | null} - كائن يحتوي على تفاصيل الوقت المتبقي أو null
 */
function calculateNextShift(schedule) {
    if (!schedule) return null;

    const now = new Date();
    let nextShiftStartDate = null;
    for (let i = 0; i < 14; i++) {
        const checkDate = new Date();
        checkDate.setDate(now.getDate() + i);
        checkDate.setHours(0, 0, 0, 0); // للتعامل مع التواريخ فقط

        const scheduleForDay = getScheduleForDate(schedule, checkDate);

        if (scheduleForDay && scheduleForDay.periods.length > 0) {
            for (const period of scheduleForDay.periods) {
                const [startHours, startMinutes] = period.start_time.split(':').map(Number);
                const potentialShiftTime = new Date(checkDate);
                potentialShiftTime.setHours(startHours, startMinutes, 0, 0);

                if (potentialShiftTime > now) {
                    nextShiftStartDate = potentialShiftTime;
                    break; // أوقف البحث عن فترات أخرى في هذا اليوم
                }
            }
        }
        if (nextShiftStartDate) {
            break; // أوقف البحث في الأيام التالية لأننا وجدنا أقرب وردية
        }
    }

    if (!nextShiftStartDate) return null; // لم نجد أي وردية قادمة
    const scheduleForNextShiftDay = getScheduleForDate(schedule, nextShiftStartDate);
    const nextPeriod = scheduleForNextShiftDay.periods.find(p => {
         const [startHours, startMinutes] = p.start_time.split(':').map(Number);
         return nextShiftStartDate.getHours() === startHours && nextShiftStartDate.getMinutes() === startMinutes;
    });

    if (!nextPeriod) return null; // حالة نادرة جداً

    const [endHours, endMinutes] = nextPeriod.end_time.split(':').map(Number);
    const nextShiftEndDate = new Date(nextShiftStartDate);
    nextShiftEndDate.setHours(endHours, endMinutes, 0, 0);
    if (nextShiftEndDate <= nextShiftStartDate) {
        nextShiftEndDate.setDate(nextShiftEndDate.getDate() + 1);
    }

    const diffMs = nextShiftStartDate - now;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const remainingMins = diffMins % 60;
    const isToday = now.toDateString() === nextShiftStartDate.toDateString();

    let formattedCountdown = '';
    if (isToday) {
        if (diffHours > 0) formattedCountdown += `${diffHours} ساعة و `;
        formattedCountdown += `${remainingMins} دقيقة`;
    }

    const dayName = nextShiftStartDate.toLocaleDateString('ar-SA', { weekday: 'long' });
    const timeAMPM = nextShiftStartDate.toLocaleTimeString('ar-SA', { hour: 'numeric', minute: '2-digit', hour12: true });

    return {
        nextShiftStartDate: nextShiftStartDate,
        nextShiftEndDate: nextShiftEndDate,
        isToday: isToday,
        formattedCountdown: formattedCountdown,
        formattedDateTime: `يوم ${dayName}، الساعة ${timeAMPM}`
    };
}
/**
 * الدالة المركزية لتحديد الحالة الدقيقة للحارس (العقل المدبر)
 * @param {object} user - كائن بيانات المستخدم الحالي
 * @param {object} activeShift - كائن الوردية النشطة (أساسية أو تغطية)
 * @returns {Promise<object>} - كائن يصف الحالة الحالية والبيانات المرتبطة بها
 */
async function determineGuardAttendanceState(user, activeShift) {
if (activeShift.type === 'substitute') {
        const today = new Date();
        const dayKey = today.toLocaleString('en-US', { weekday: 'short' });
        const projectParam = user.project ? (Array.isArray(user.project) ? user.project : [user.project]) : [];
        const { data: scheduleData, error } = await supabaseClient
            .rpc('get_primary_schedule', {
                p_project: projectParam,
                p_location: user.location
            });

        if (!error && scheduleData) {
            let primarySchedule = null;
            if (Array.isArray(scheduleData)) {
                primarySchedule = scheduleData.length > 0 ? scheduleData[0] : null;
            } else {
                primarySchedule = scheduleData; // في حال عادت ككائن مباشر
            }

            if (primarySchedule) {
                const primaryScheduleForToday = getScheduleForDate(primarySchedule, today);
                if (!primaryScheduleForToday) { 
                    const forcedSchedule = JSON.parse(JSON.stringify(primarySchedule)); // نسخ عميق
                    let defaultPeriods = forcedSchedule.periods;
                    if (!defaultPeriods && forcedSchedule.start_time) {
                        defaultPeriods = [{ start_time: forcedSchedule.start_time, end_time: forcedSchedule.end_time }];
                    }

                    if (defaultPeriods && defaultPeriods.length > 0) {
                        if (!forcedSchedule.day_overrides) forcedSchedule.day_overrides = {};
                        forcedSchedule.day_overrides[dayKey] = {
                            periods: defaultPeriods
                        };
                        
                        activeShift.snapshot.schedule_details = [forcedSchedule];
                    }
                }
            }
        } else if (error) {
            console.error("Error fetching primary schedule:", error);
        }
    }
    const now = new Date();
    const twentyFourHoursAgo = new Date(Date.now() - 36 * 60 * 60 * 1000).toISOString();
    const { data: recentRecords } = await supabaseClient
        .from('attendance')
        .select('*')
        .eq('guard_id', user.id)
        .gte('created_at', twentyFourHoursAgo);
    const records = recentRecords || [];
const openRecord = records.find(rec => !rec.checkout_at && rec.status === 'حاضر');
if (openRecord) {
    const schedule = openRecord.shift_snapshot?.schedule_details?.[0];
    if (schedule) {
        const periods = schedule.periods || [schedule];
        const checkinTime = new Date(openRecord.created_at);
        const correspondingPeriod = periods.find(p => {
            const [startH, startM] = p.start_time.split(':').map(Number);
            let periodStart = new Date(checkinTime);
            periodStart.setHours(startH, startM, 0, 0);
            return Math.abs(checkinTime - periodStart) < 60 * 60 * 1000;
        });
        if (correspondingPeriod) {
            const [endH, endM] = correspondingPeriod.end_time.split(':').map(Number);
            let periodEnd = new Date(checkinTime);
            periodEnd.setHours(endH, endM, 0, 0);
            if (periodEnd <= new Date(openRecord.created_at)) { periodEnd.setDate(periodEnd.getDate() + 1); }
            const gracePeriodEndTime = new Date(periodEnd.getTime() + 30 * 60 * 1000); // إضافة 30 دقيقة

            if (now > gracePeriodEndTime) { // المقارنة مع وقت السماح الجديد
                const currentSchedule = activeShift.snapshot.schedule_details[0];
                const currentPeriods = currentSchedule.periods || [currentSchedule];
                const hasMorePeriodsToday = currentPeriods.some(p => {
                    const [startH, startM] = p.start_time.split(':').map(Number);
                    let periodStartTime = new Date();
                    periodStartTime.setHours(startH, startM, 0, 0);
                    return periodStartTime > now;
                });

                if (!hasMorePeriodsToday) {
                    return { status: 'STALE_CHECK_IN', record: openRecord, period: correspondingPeriod };
                }
            }
        }
    }
    return { status: 'ALREADY_CHECKED_IN', record: openRecord };
}
const schedule = activeShift.snapshot.schedule_details[0];

const todaySchedule = getScheduleForDate(schedule, now);

if (!todaySchedule) { // إذا كان اليوم يوم راحة
    const nextShift = calculateNextShift(schedule);
    if (nextShift && (new Date(nextShift.nextShiftStartDate) - now) < 4 * 60 * 60 * 1000) {
        const firstPeriod = (schedule.periods || [schedule])[0];
        const countdown = nextShift.formattedCountdown || `${Math.floor((nextShift.nextShiftStartDate - now) / 3600000)} س و ${Math.floor(((nextShift.nextShiftStartDate - now) % 3600000) / 60000)} د`;
        return { status: 'WAITING_FOR_SHIFT', countdown: countdown, period: firstPeriod, allPeriodsToday: [] };
    }
    return { status: 'ALL_PERIODS_DONE', nextShift: nextShift };
}

const periods = todaySchedule.periods;
const completedRecordsToday = records
            .filter(r => r.checkout_at && new Date(r.created_at).toDateString() === now.toDateString())
            .sort((a, b) => new Date(a.created_at) - new Date(b.created_at)); // ترتيب السجلات زمنياً
        let availableRecords = [...completedRecordsToday];
        
        const uncompletedPeriods = periods.filter(p => {
            const [startH, startM] = p.start_time.split(':').map(Number);
            const matchIndex = availableRecords.findIndex(rec => {
                const checkinTime = new Date(rec.created_at);
                let periodStart = new Date(checkinTime);
                periodStart.setHours(startH, startM, 0, 0);
                return Math.abs(checkinTime - periodStart) < 8 * 60 * 60 * 1000;
            });

            if (matchIndex !== -1) {
                availableRecords.splice(matchIndex, 1);
                return false; // هذه الفترة مكتملة
            }
            return true; // هذه الفترة غير مكتملة (ستظهر للحارس)
        });
if (uncompletedPeriods.length > 0) {
    for (const period of uncompletedPeriods) {
        const [startH, startM] = period.start_time.split(':').map(Number);
        let periodStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startH, startM, 0, 0);

        const gracePeriodStart = new Date(periodStartTime.getTime() - 15 * 60 * 1000);
        const gracePeriodEnd = new Date(periodStartTime.getTime() + 120 * 60 * 1000);

        if (now >= gracePeriodStart && now <= gracePeriodEnd) {
            return { status: 'CAN_CHECK_IN', period: period }; // حان وقت الفترة التالية
        }
    }
}
const latestRecordOverall = records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
if (latestRecordOverall && (latestRecordOverall.status.includes('استئذان') || latestRecordOverall.status.includes('انسحاب'))) {
    return { status: 'LOCKED_OUT_ACTION', lastStatus: latestRecordOverall.status };
}
const latestCheckoutRecord = records
    .filter(r => r.checkout_at)
    .sort((a, b) => new Date(b.checkout_at) - new Date(a.checkout_at))[0];

if (latestCheckoutRecord && uncompletedPeriods.length === 0) {
    const timeSinceCheckout = now - new Date(latestCheckoutRecord.checkout_at);
    if (timeSinceCheckout < 15 * 60 * 1000) { // أقل من 15 دقيقة
        return { status: 'JUST_FINISHED_FINAL_SHIFT', nextShift: calculateNextShift(schedule) };
    }
}

if (uncompletedPeriods.length > 0) {
    const nextUpcomingPeriod = uncompletedPeriods.sort((a, b) => a.start_time.localeCompare(b.start_time))
        .find(p => {
            const [startH, startM] = p.start_time.split(':').map(Number);
            let periodStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startH, startM, 0, 0);
            return now < periodStartTime;
        });

    if (nextUpcomingPeriod) {
        const [startH, startM] = nextUpcomingPeriod.start_time.split(':').map(Number);
        let periodStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startH, startM, 0, 0);
        const diffMs = periodStartTime - now;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const remainingMins = diffMins % 60;
        let countdown = '';
        if (diffHours > 0) countdown += `${diffHours} ساعة و `;
        countdown += `${remainingMins} دقيقة`;
        return { status: 'WAITING_FOR_SHIFT', countdown: countdown, period: nextUpcomingPeriod, allPeriodsToday: periods };
    }
}

if (uncompletedPeriods.length === 0) {
    return { status: 'ALL_PERIODS_DONE', nextShift: calculateNextShift(schedule) };
}
return { status: 'LOCKED_OUT_ABSENT', nextShift: calculateNextShift(schedule), allPeriodsToday: periods };
}
async function updateSidebarBadges() {
    if (!currentUser) return;
    let supervisorProjects = [];
if (currentUser.role === 'مشرف' && currentUser.assigned_locations && currentUser.assigned_locations.length > 0) {
    supervisorProjects = [...new Set(currentUser.assigned_locations.map(loc => loc.contract))];
}
    const badgeConfig = {
        'page-loan-requests': {
            roles: ['ادارة الموارد البشرية', 'مدير النظام'],
            query: () => supabaseClient.from('employee_requests').select('*', { count: 'exact', head: true }).eq('request_type', 'loan').eq('status', 'بانتظار موافقة الموارد البشرية')
        },
        'page-leave-requests': {
            roles: ['ادارة الموارد البشرية', 'مدير النظام'],
            query: () => supabaseClient.from('employee_requests').select('*', { count: 'exact', head: true }).eq('request_type', 'leave').eq('status', 'بانتظار موافقة الموارد البشرية')
        },
        'page-resignation-requests': {
            roles: ['ادارة الموارد البشرية', 'مدير النظام'],
            query: () => supabaseClient.from('employee_requests').select('*', { count: 'exact', head: true }).eq('request_type', 'resignation').eq('status', 'بانتظار موافقة الموارد البشرية')
        },
        'page-permission-requests': {
            roles: ['ادارة العمليات', 'مدير النظام'],
            query: () => supabaseClient.from('employee_requests').select('*', { count: 'exact', head: true }).eq('request_type', 'permission').eq('status', 'بانتظار موافقة العمليات')
        },
        'page-ops-review-requests': {
            roles: ['ادارة العمليات', 'مدير النظام'],
            query: () => supabaseClient.rpc('count_ops_review_requests', { p_region: currentUser.region }, { count: 'exact' })
        },
        'page-hr-ops-hiring': {
            roles: ['ادارة الموارد البشرية', 'مدير النظام'],
            query: () => supabaseClient.from('job_applications').select('*', { count: 'exact', head: true }).eq('status', 'approved')
        },
        'page-supervisor-permission-requests': {
            roles: ['مشرف', 'مدير النظام'],
            query: () => supabaseClient.rpc('count_supervisor_permission_requests', { p_projects: supervisorProjects }, { count: 'exact' })
        },
        'page-supervisor-applications': {
            roles: ['مشرف', 'مدير النظام'],
            query: () => supabaseClient.rpc('count_supervisor_job_applications', { p_projects: supervisorProjects }, { count: 'exact' })
        },
        'page-ops-nominees': {
            roles: ['ادارة العمليات', 'مدير النظام'],
            query: () => supabaseClient.rpc('count_ops_nominees', { p_region: currentUser.region }, { count: 'exact' })
        },
        'page-coverage-requests': {
            roles: ['ادارة العمليات', 'مدير النظام'],
            query: () => supabaseClient.rpc('count_ops_coverage_requests', { p_region: currentUser.region }, { count: 'exact' })
        },
        'page-supervisor-coverage-apps': {
            roles: ['مشرف', 'مدير النظام'],
            query: () => supabaseClient.rpc('count_supervisor_coverage_apps', { p_projects: supervisorProjects }, { count: 'exact' })
        },
        'page-my-directives': {
            roles: ['مشرف', 'حارس أمن', 'مدير النظام'], // الأدوار التي ستظهر لها الشارة
            query: () => supabaseClient.rpc('count_pending_directives_for_user', { p_user_id: currentUser.id }, { count: 'exact' })
        }
    };

    for (const pageId in badgeConfig) {
        const config = badgeConfig[pageId];
        if (config.roles.includes(currentUser.role)) {
            const link = document.querySelector(`.sidebar-nav a[data-page="${pageId}"]`);
            const badge = link ? link.querySelector('.menu-badge') : null;
            if (badge) {
                const { count, error } = await config.query();
                if (!error && count > 0) {
                    badge.textContent = count > 9 ? '9+' : count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }
    }
}
async function downloadContractTemplate() {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('قالب إدخال المشاريع');
    worksheet.columns = [
        { header: 'اسم المشروع', key: 'ProjectName', width: 40 },
        { header: 'تاريخ نهاية العقد', key: 'ContractEndDate', width: 20 },
        { header: 'المنطقة', key: 'ContractRegion', width: 15 },
        { header: 'المدينة', key: 'City', width: 20 },
        { header: 'اسم الموقع', key: 'LocationName', width: 30 },
        { header: 'إحداثيات الموقع', key: 'LocationCoords', width: 25 },
        { header: 'اسم الوردية', key: 'ShiftName', width: 20 },
        { header: 'عدد الحراس', key: 'GuardsCount', width: 15 },
        { header: 'وقت البدء', key: 'StartTime', width: 15 },
        { header: 'وقت الانتهاء', key: 'EndTime', width: 15 },
        { header: 'أيام العمل (1=الأحد..7=السبت)', key: 'WorkDays', width: 45 }
    ];
    worksheet.getRow(1).eachCell(cell => {
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF198754' } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });

    worksheet.views = [{ state: 'frozen', ySplit: 1 }];

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'قالب_إدخال_المشاريع_والمواقع.xlsx';
    link.click();
}
async function processContractFile(file) {
    const resultsContainer = document.getElementById('contract-import-results-container');
    const uploadBtn = document.getElementById('import-contracts-btn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري المعالجة...';
    resultsContainer.innerHTML = '<p style="text-align:center; padding: 20px;">بدأت المعالجة، يرجى الانتظار...</p>';

    try {
        const buffer = await file.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buffer);
        const worksheet = workbook.getWorksheet(1);

        const headerMap = {};
        worksheet.getRow(1).eachCell((cell, colNumber) => {
            headerMap[cell.value] = colNumber;
        });
        
        const dayMap = { '1': 'Sun', '2': 'Mon', '3': 'Tue', '4': 'Wed', '5': 'Thu', '6': 'Fri', '7': 'Sat' };
        const groupedData = {};

        worksheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {
            if (rowNumber > 1) {
                const projectName = row.getCell(headerMap['اسم المشروع']).value;
                const locationName = row.getCell(headerMap['اسم الموقع']).value;
                if (!projectName || !locationName) return;

                if (!groupedData[projectName]) {
                    groupedData[projectName] = {
                        company_name: projectName,
                        end_date: row.getCell(headerMap['تاريخ نهاية العقد']).value || null,
                        region: row.getCell(headerMap['المنطقة']).value,
                        city: row.getCell(headerMap['المدينة']).value,
                        status: 'active',
                        locations: {}
                    };
                }

                if (!groupedData[projectName].locations[locationName]) {
                     groupedData[projectName].locations[locationName] = {
                        name: locationName,
                        city: row.getCell(headerMap['المدينة']).value,
                        region: groupedData[projectName].region,
                        geofence_link: row.getCell(headerMap['إحداثيات الموقع']).value || null,
                        geofence_radius: 200,
                        shifts: []
                    };
                }
                
                const startTimeValue = row.getCell(headerMap['وقت البدء']).value;
                const endTimeValue = row.getCell(headerMap['وقت الانتهاء']).value;
                let workHours = 0;
                
                const formatExcelTime = (timeValue) => {
                    if (typeof timeValue === 'number' && timeValue < 1) {
                        const totalSeconds = timeValue * 24 * 60 * 60;
                        const hours = Math.floor(totalSeconds / 3600);
                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    }
                    if(typeof timeValue === 'object' && timeValue.text) return timeValue.text;
                    if(typeof timeValue === 'object' && timeValue instanceof Date) {
                        return `${String(timeValue.getHours()).padStart(2, '0')}:${String(timeValue.getMinutes()).padStart(2, '0')}`;
                    }
                    return timeValue;
                };

                const startTime = formatExcelTime(startTimeValue);
                const endTime = formatExcelTime(endTimeValue);

                if (startTime && endTime) {
                    const start = new Date(`1970-01-01T${startTime}`);
                    const end = new Date(`1970-01-01T${endTime}`);
                    let diff = (end - start) / (1000 * 60 * 60);
                    if (diff < 0) diff += 24;
                    workHours = parseFloat(diff.toFixed(2));
                }

                const workDaysInput = String(row.getCell(headerMap['أيام العمل (1=الأحد..7=السبت)']).value || '');
                const workDaysArray = workDaysInput.split(',').map(num => dayMap[num.trim()]).filter(day => day);

                groupedData[projectName].locations[locationName].shifts.push({
                    name: row.getCell(headerMap['اسم الوردية']).value,
                    guards_count: parseInt(row.getCell(headerMap['عدد الحراس']).value, 10) || 1,
                    start_time: startTime,
                    end_time: endTime,
                    work_hours: workHours,
                    days: workDaysArray
                });
            }
        });

        let successCount = 0;
        let errorCount = 0;
        let resultsLog = [];

        for (const projectName in groupedData) {
            try {
                const contract = groupedData[projectName];
                const { data: existingContract } = await supabaseClient.from('contracts').select('id').eq('company_name', projectName).maybeSingle();
                if (existingContract) {
                    throw new Error('هذا المشروع موجود بالفعل في النظام.');
                }

                const locationsArray = Object.values(contract.locations);
                
                const finalContractData = {
                    company_name: contract.company_name,
                    end_date: contract.end_date,
                    region: contract.region,
                    city: [contract.city],
                    status: 'active',
                    contract_locations: locationsArray
                };

                const { error } = await supabaseClient.from('contracts').insert([finalContractData]);
                if (error) throw error;
                
                successCount++;
                resultsLog.push({ name: projectName, status: 'success', message: `تمت إضافة المشروع بنجاح مع ${locationsArray.length} موقع.` });
            } catch (e) {
                errorCount++;
                resultsLog.push({ name: projectName, status: 'error', message: e.message });
            }
        }

        let reportHtml = `
            <h4 style="text-align:center; margin: 20px 0;">اكتملت المعالجة: ${successCount} نجاح، ${errorCount} فشل</h4>
            <div class="table-container"><table><thead><tr><th>اسم المشروع</th><th>الحالة</th><th>ملاحظات</th></tr></thead><tbody>
            ${resultsLog.map(r => `<tr style="background-color: ${r.status === 'success' ? '#f0fff4' : '#fff5f5'};">
                <td>${r.name}</td>
                <td><span class="status ${r.status === 'success' ? 'active' : 'inactive'}">${r.status === 'success' ? 'نجاح' : 'فشل'}</span></td>
                <td>${r.message}</td>
            </tr>`).join('')}
            </tbody></table></div>`;
        resultsContainer.innerHTML = reportHtml;
        fetchContracts();

    } catch (error) {
        console.error("The process failed with this error:", error);
        resultsContainer.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">خطأ فادح: ${error.message}</p>`;
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="ph-bold ph-file-xls"></i> استيراد من ملف';
        document.getElementById('contract-import-input').value = '';
    }
}
async function downloadEmployeeTemplate() {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('قالب إدخال الموظفين');
worksheet.columns = [
    { header: 'الاسم الكامل', key: 'name', width: 30 },
    { header: 'رقم الهوية', key: 'id_number', width: 15 },
    { header: 'رقم الجوال', key: 'phone', width: 15 },
    { header: 'تاريخ المباشرة', key: 'start_date', width: 15 },
    { header: 'رقم الآيبان', key: 'iban', width: 30 },
    { header: 'اسم البنك', key: 'bank', width: 15 },
    { header: 'حالة الموظف', key: 'status', width: 15 },
    { header: 'اسم المشروع', key: 'project', width: 25 },
    { header: 'اسم الموقع', key: 'location', width: 25 },
    { header: 'اسم الوردية', key: 'shift', width: 20 },
    { header: 'مسجل بالتأمينات (نعم/لا)', key: 'is_insured', width: 25 },
    { header: 'مبلغ خصم التأمينات', key: 'insurance_amount', width: 20 }
];
    worksheet.views = [{ state: 'frozen', ySplit: 1 }];
    worksheet.getRow(1).eachCell(cell => {
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } };
        cell.alignment = { horizontal: 'center' };
    });
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'قالب_إدخال_الموظفين.xlsx';
    link.click();
}
async function processContractFile(file) {
    const resultsContainer = document.getElementById('contract-import-results-container');
    const uploadBtn = document.getElementById('import-contracts-btn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري المعالجة...';
    resultsContainer.innerHTML = '<p style="text-align:center; padding: 20px;">بدأت المعالجة، يرجى الانتظار...</p>';

    try {
        const buffer = await file.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buffer);
        const worksheet = workbook.getWorksheet(1);

        const headerMap = {};
        worksheet.getRow(1).eachCell((cell, colNumber) => {
            headerMap[cell.value] = colNumber;
        });
        
        const dayMap = { '1': 'Sun', '2': 'Mon', '3': 'Tue', '4': 'Wed', '5': 'Thu', '6': 'Fri', '7': 'Sat' };
        const groupedData = {};
        for (let rowNumber = 2; rowNumber <= worksheet.rowCount; rowNumber++) {
            const row = worksheet.getRow(rowNumber);
            if (row.cellCount === 0) continue; // تخطي الصفوف الفارغة تمامًا

            const projectName = row.getCell(headerMap['اسم المشروع']).value;
            const locationName = row.getCell(headerMap['اسم الموقع']).value;
            if (!projectName || !locationName) continue;

            if (!groupedData[projectName]) {
                groupedData[projectName] = {
                    company_name: projectName,
                    end_date: row.getCell(headerMap['تاريخ نهاية العقد']).value || null,
                    region: row.getCell(headerMap['المنطقة']).value,
                    city: row.getCell(headerMap['المدينة']).value,
                    status: 'active',
                    locations: {}
                };
            }

            if (!groupedData[projectName].locations[locationName]) {
                 groupedData[projectName].locations[locationName] = {
                    name: locationName,
                    city: row.getCell(headerMap['المدينة']).value,
                    region: groupedData[projectName].region,
                    geofence_link: row.getCell(headerMap['إحداثيات الموقع']).value || null,
                    geofence_radius: 200,
                    shifts: []
                };
            }
            
            const startTimeValue = row.getCell(headerMap['وقت البدء']).value;
            const endTimeValue = row.getCell(headerMap['وقت الانتهاء']).value;
            let workHours = 0;
            
            const formatExcelTime = (timeValue) => {
                if (typeof timeValue === 'number' && timeValue < 1) {
                    const totalSeconds = timeValue * 24 * 60 * 60;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
                if(typeof timeValue === 'object' && timeValue.text) return timeValue.text;
                if(typeof timeValue === 'object' && timeValue instanceof Date) {
                    return `${String(timeValue.getHours()).padStart(2, '0')}:${String(timeValue.getMinutes()).padStart(2, '0')}`;
                }
                return timeValue;
            };

            const startTime = formatExcelTime(startTimeValue);
            const endTime = formatExcelTime(endTimeValue);

            if (startTime && endTime) {
                const start = new Date(`1970-01-01T${startTime}`);
                const end = new Date(`1970-01-01T${endTime}`);
                let diff = (end - start) / (1000 * 60 * 60);
                if (diff < 0) diff += 24;
                workHours = parseFloat(diff.toFixed(2));
            }

            const workDaysInput = String(row.getCell(headerMap['أيام العمل (1=الأحد..7=السبت)']).value || '');
            const workDaysArray = workDaysInput.split(',').map(num => dayMap[num.trim()]).filter(day => day);

            groupedData[projectName].locations[locationName].shifts.push({
                name: row.getCell(headerMap['اسم الوردية']).value,
                guards_count: parseInt(row.getCell(headerMap['عدد الحراس']).value, 10) || 1,
                start_time: startTime,
                end_time: endTime,
                work_hours: workHours,
                days: workDaysArray
            });
        }

        let successCount = 0;
        let errorCount = 0;
        let resultsLog = [];

        for (const projectName in groupedData) {
            try {
                const contract = groupedData[projectName];
                const { data: existingContract } = await supabaseClient.from('contracts').select('id').eq('company_name', projectName).maybeSingle();
                if (existingContract) {
                    throw new Error('هذا المشروع موجود بالفعل في النظام.');
                }

                const locationsArray = Object.values(contract.locations);
                
                const finalContractData = {
                    company_name: contract.company_name,
                    end_date: contract.end_date,
                    region: contract.region,
                    city: [contract.city],
                    status: 'active',
                    contract_locations: locationsArray
                };

                const { error } = await supabaseClient.from('contracts').insert([finalContractData]);
                if (error) throw error;
                
                successCount++;
                resultsLog.push({ name: projectName, status: 'success', message: `تمت إضافة المشروع بنجاح مع ${locationsArray.length} موقع.` });
            } catch (e) {
                errorCount++;
                resultsLog.push({ name: projectName, status: 'error', message: e.message });
            }
        }

        let reportHtml = `
            <h4 style="text-align:center; margin: 20px 0;">اكتملت المعالجة: ${successCount} نجاح، ${errorCount} فشل</h4>
            <div class="table-container"><table><thead><tr><th>اسم المشروع</th><th>الحالة</th><th>ملاحظات</th></tr></thead><tbody>
            ${resultsLog.map(r => `<tr style="background-color: ${r.status === 'success' ? '#f0fff4' : '#fff5f5'};">
                <td>${r.name}</td>
                <td><span class="status ${r.status === 'success' ? 'active' : 'inactive'}">${r.status === 'success' ? 'نجاح' : 'فشل'}</span></td>
                <td>${r.message}</td>
            </tr>`).join('')}
            </tbody></table></div>`;
        resultsContainer.innerHTML = reportHtml;
        fetchContracts();

    } catch (error) {
        console.error("The process failed with this error:", error);
        resultsContainer.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">خطأ فادح: ${error.message}</p>`;
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="ph-bold ph-file-xls"></i> استيراد من ملف';
        document.getElementById('contract-import-input').value = '';
    }
}
function getDaysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
}

window.addEventListener('error', function(event) {
    const errorData = {
        user_id: window.currentUser?.auth_user_id || null,
        user_name: window.currentUser?.name || 'غير مسجل',
        error_message: event.message,
        stack_trace: event.error?.stack || 'N/A',
        user_agent: navigator.userAgent
    };
    supabaseClient.from('error_logs').insert(errorData).then(({ error }) => {
        if (error) console.error('Failed to log error to Supabase:', error);
    });
});
async function displayActiveAnnouncements() {
    if (announcementCheckInterval) {
        clearInterval(announcementCheckInterval);
        announcementCheckInterval = null;
    }

    const banner = document.getElementById('announcement-banner');
    if (!banner) return;

    banner.classList.add('hidden');
    banner.innerHTML = '';

    try {
        const now = new Date().toISOString();

        const { data: activeAnnouncements, error } = await supabaseClient
            .from('announcements')
            .select('content, type, end_date, target_roles') // تأكدنا من جلب target_roles
            .eq('is_active', true)
            .lte('start_date', now)
            .gte('end_date', now)
            .order('created_at', { ascending: false });

        if (error) throw error;
        const myRole = currentUser.role;
        const relevantAnnouncements = activeAnnouncements.filter(ann => {
            const targets = ann.target_roles || ['all'];
            return targets.includes('all') || targets.includes(myRole);
        });

        if (relevantAnnouncements && relevantAnnouncements.length > 0) {
            const announcement = relevantAnnouncements[0]; // عرض أحدث إعلان مطابق

            const icons = {
                info: 'ph-info',
                warning: 'ph-warning-circle',
                critical: 'ph-warning-diamond'
            };
            const iconClass = icons[announcement.type] || 'ph-info';

            banner.innerHTML = `
                <i class="ph-bold ${iconClass}"></i>
                <p>${announcement.content}</p>
                <button id="close-announcement-btn" title="إخفاء الإعلان">
                    <i class="ph-bold ph-x"></i>
                </button>
            `;

            banner.classList.remove('type-info', 'type-warning', 'type-critical');
            banner.classList.add(`type-${announcement.type}`);

            banner.classList.remove('hidden');

            document.getElementById('close-announcement-btn').addEventListener('click', () => {
                banner.classList.add('hidden');
                if (announcementCheckInterval) clearInterval(announcementCheckInterval);
            });

            announcementCheckInterval = setInterval(() => {
                const endDate = new Date(announcement.end_date);
                if (new Date() > endDate) {
                    console.log('Announcement expired based on UTC, hiding banner.');
                    displayActiveAnnouncements();
                }
            }, 5000);
        }

    } catch (err) {
        console.error("Error fetching announcements:", err);
    }
}
async function processEmployeeFile(file) {
    const resultsContainer = document.getElementById('import-results-container');
    const uploadBtn = document.getElementById('upload-employees-file-btn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري المعالجة الذكية...';
    resultsContainer.innerHTML = '<p style="text-align:center;">بدأت المعالجة، قد تستغرق العملية بعض الوقت...</p>';

    try {
        const buffer = await file.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buffer);
        const worksheet = workbook.getWorksheet(1);
        const headerMap = {};
        const expectedHeaders = ['الاسم الكامل', 'رقم الهوية', 'رقم الجوال', 'تاريخ المباشرة', 'رقم الآيبان', 'اسم البنك', 'حالة الموظف', 'اسم المشروع', 'اسم الموقع', 'اسم الوردية', 'مسجل بالتأمينات (نعم/لا)', 'مبلغ خصم التأمينات'];
        worksheet.getRow(1).eachCell((cell, colNumber) => {
            if (expectedHeaders.includes(cell.value)) {
                headerMap[cell.value] = colNumber;
            }
        });
        if (Object.keys(headerMap).length !== expectedHeaders.length) {
            throw new Error('القالب المستخدم غير صحيح أو أن هناك أعمدة مفقودة. الرجاء تحميل القالب الرسمي.');
        }

        let employeesData = [];
        worksheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {
            if (rowNumber > 1) {
                employeesData.push({
                    rowNum: rowNumber,
                    name: row.getCell(headerMap['الاسم الكامل']).value,
                    id_number: row.getCell(headerMap['رقم الهوية']).value,
                    phone: row.getCell(headerMap['رقم الجوال']).value,
                    start_date: row.getCell(headerMap['تاريخ المباشرة']).value,
                    iban: row.getCell(headerMap['رقم الآيبان']).value,
                    bank: row.getCell(headerMap['اسم البنك']).value,
                    status: row.getCell(headerMap['حالة الموظف']).value,
                    project: row.getCell(headerMap['اسم المشروع']).value,
                    location: row.getCell(headerMap['اسم الموقع']).value,
                    shift: row.getCell(headerMap['اسم الوردية']).value,
                    isInsured: row.getCell(headerMap['مسجل بالتأمينات (نعم/لا)']).value,
                    insuranceAmount: row.getCell(headerMap['مبلغ خصم التأمينات']).value,
                });
            }
        });
        if (employeesData.length === 0) throw new Error('الملف فارغ.');
        const { data, error } = await supabaseClient.functions.invoke('smart-process-employees', {
            body: { employeesData }
        });

        if (error) throw error;
        if (data.error) throw new Error(data.error);
        
        const finalResults = data.results;
        const successCount = finalResults.filter(r => r.result.status === 'success').length;
        const errorCount = finalResults.filter(r => r.result.status === 'error').length;
        let reportHtml = `
            <h4 style="text-align:center; margin-bottom: 20px;">
                اكتملت المعالجة: ${successCount} نجاح، ${errorCount} فشل
            </h4>
            <div class="table-container">
                <table>
                    <thead><tr><th>#</th><th>الاسم</th><th>الحالة</th><th>ملاحظات</th></tr></thead>
                    <tbody>
                        ${finalResults.map(r => `
                            <tr style="background-color: ${r.result.status === 'success' ? '#f0fff4' : '#fff5f5'};">
                                <td>${r.rowNum}</td>
                                <td>${r.name}</td>
                                <td><span class="status ${r.result.status === 'success' ? 'active' : 'inactive'}">${r.result.status === 'success' ? 'نجاح' : 'فشل'}</span></td>
                                <td style="text-align: right;">${r.result.message}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        resultsContainer.innerHTML = reportHtml;
        loadEmployeeTabData();
        loadVacancyTabData();

    } catch (e) {
        resultsContainer.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">حدث خطأ فادح: ${e.message}</p>`;
        console.error("Employee File Processing Error:", e);
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="ph-bold ph-upload-simple"></i> اختيار ورفع ملف Excel';
    }
}

/**
 * Creates a Supabase 'or' filter string for a supervisor's assigned sites.
 * @param {Array<object>} assignedLocations - Array of {contract, site}.
 * @returns {string} - A filter string for Supabase queries.
 */
function createSupervisorSiteFilter(assignedLocations) {
    if (!assignedLocations || assignedLocations.length === 0) {
        return 'id.eq.0'; 
    }
    const siteFilters = assignedLocations.map(loc => {
        const cleanContract = loc.contract.trim().replace(/\s+/g, ' ');
        const cleanSite = loc.site.trim().replace(/\s+/g, ' ');
        return `and(project.cs.{"${cleanContract}"},location.eq."${cleanSite}")`;
    });
    return siteFilters.join(',');
}


function createProjectFilter(query, projectData, columnName = 'project') {
    if (!projectData || !Array.isArray(projectData) || projectData.length === 0) {
        return query.eq('id', '00000000-0000-0000-0000-000000000000'); 
    }
    const toPostgresArrayLiteral = (arr) => {
        const formattedElements = arr.map(element => `"${element.replace(/"/g, '""')}"`);
        return `{${formattedElements.join(',')}}`;
    };
    return query.filter(columnName, 'ov', toPostgresArrayLiteral(projectData));
}
async function exportVacanciesToExcel() {
    if (vacanciesExportData.length === 0) {
        return alert('لا توجد بيانات مفلترة لتصديرها.');
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('تقرير الشواغر', {
        views: [{ rightToLeft: true }]
    });

    worksheet.columns = [
        { header: 'المشروع', key: 'project', width: 30 },
        { header: 'الموظف المعين', key: 'assigned_user', width: 25 },
        { header: 'حالة الشاغر', key: 'status', width: 25 },
        { header: 'المنطقة', key: 'region', width: 15 },
        { header: 'المدينة', key: 'city', width: 20 },
        { header: 'الموقع', key: 'location', width: 30 },
        { header: 'الوردية', key: 'shift', width: 40 },
        { header: 'الراتب الإجمالي', key: 'total_salary', width: 20, style: { numFmt: '#,##0.00 "ر.س"' } }
    ];
    worksheet.addRows(vacanciesExportData);
    worksheet.getRow(1).eachCell(cell => {
        cell.font = { name: 'Cairo', bold: true, color: { argb: 'FFFFFFFF' } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });
    worksheet.getColumn('status').eachCell({ includeEmpty: true }, (cell, rowNumber) => {
        if (rowNumber > 1) {
            const statusValue = cell.value;
            let fillColor = 'FFFFFFFF'; // White (default)
            if (statusValue === 'مفتوح') {
                fillColor = 'FFC6EFCE'; // Green
            } else if (statusValue === 'مغلق (مرتبط بشخص)') {
                fillColor = 'FFFFC7CE'; // Red
            } else if (statusValue === 'مغلق (فارغ)') {
                fillColor = 'FFFFEB9C'; // Yellow
            }
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        }
    });
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `تقرير_الشواغر-${new Date().toISOString().split('T')[0]}.xlsx`;
    link.click();
}
let pendingPaymentsData = [];
let absenteeReportData = [];
firebase.initializeApp(config.firebaseConfig);
const messaging = firebase.messaging();
function requestNotificationPermission() {
    messaging.requestPermission()
        .then(() => messaging.getToken({
            vapidKey: "BO_qk6HKfERdBr4geUGLjQKk0D7830kjunWm3CY9q2WMQ2lkj5006t92lY-uVIlGarAZBYGKKz4jCLq7aMYqb7o"
        }))
        .then(token => {
            console.log("توكن FCM:", token);
        })
        .catch(err => {
            console.error("خطأ أثناء طلب الإذن:", err);
        });
}

messaging.onMessage(payload => {
    console.log("رسالة أثناء فتح الصفحة:", payload);
});

/**
 * دالة محسّنة لتحليل الإحداثيات من رابط خرائط جوجل أو من نص إحداثيات مباشر
 * @param {string} input - رابط خرائط جوجل أو نص بصيغة "lat,lng"
 * @returns {object|null} - كائن يحتوي على خط الطول والعرض أو null
 */
function parseCoordinates(input) {
    if (!input || typeof input !== 'string') return null;
    let match = input.match(/^(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)$/);
    if (match && match.length >= 3) {
        return {
            lat: parseFloat(match[1]),
            lng: parseFloat(match[2])
        };
    }
    match = input.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
    if (match && match.length >= 3) {
        return {
            lat: parseFloat(match[1]),
            lng: parseFloat(match[2])
        };
    }

    return null; // إذا فشلت كل المحاولات
}

/**
 * دالة لحساب المسافة بين نقطتين على الأرض (بالمتر)
 * @param {object} coords1 - الإحداثيات الأولى {lat, lng}
 * @param {object} coords2 - الإحداثيات الثانية {lat, lng}
 * @returns {number} - المسافة بالمتر
 */
function calculateDistance(coords1, coords2) {
    const R = 6371e3; // نصف قطر الأرض بالمتر
    const φ1 = coords1.lat * Math.PI / 180;
    const φ2 = coords2.lat * Math.PI / 180;
    const Δφ = (coords2.lat - coords1.lat) * Math.PI / 180;
    const Δλ = (coords2.lng - coords1.lng) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c; // المسافة بالمتر
}
function showCustomAlert(title, message, type = 'info') { // types: info, success, error
    const modal = document.getElementById('custom-alert-modal');
    const modalTitle = document.getElementById('custom-alert-title');
    const modalMessage = document.getElementById('custom-alert-message');
    const modalHeader = document.getElementById('custom-alert-header');

    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalHeader.className = 'modal-header'; // إعادة تعيين الكلاسات
    modalHeader.classList.add(type);

    modal.classList.remove('hidden');
}
function showLocationPermissionWarning() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    let instructionsHtml = '';

    if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        instructionsHtml = `
            <p style="margin-bottom: 15px;">لا يمكنك متابعة ورديتك بدون تفعيل صلاحية الموقع.</p>
            <ol style="text-align: right; padding-right: 20px;">
                <li>اذهب إلى <b>الإعدادات (Settings)</b>.</li>
                <li>اختر <b>الخصوصية والأمن (Privacy & Security)</b>.</li>
                <li>اختر <b>خدمات الموقع (Location Services)</b>.</li>
                <li>ابحث عن المتصفح (Safari أو Chrome) وقم بالسماح له بالوصول للموقع.</li>
            </ol>
        `;
    } else if (/android/i.test(userAgent)) {
        instructionsHtml = `
            <p style="margin-bottom: 15px;">لا يمكنك متابعة ورديتك بدون تفعيل صلاحية الموقع.</p>
            <ol style="text-align: right; padding-right: 20px;">
                <li>اذهب إلى <b>الإعدادات (Settings)</b>.</li>
                <li>اختر <b>التطبيقات (Apps)</b>.</li>
                <li>ابحث عن المتصفح <b>Chrome</b>.</li>
                <li>اختر <b>الأذونات (Permissions)</b> ثم <b>الموقع (Location)</b> واختر "السماح".</li>
            </ol>
        `;
    } else {
        instructionsHtml = '<p>يجب عليك إعادة تفعيل صلاحية الموقع من إعدادات المتصفح لمتابعة ورديتك.</p>';
    }
    const modal = document.getElementById('custom-alert-modal');
    const modalTitle = document.getElementById('custom-alert-title');
    const modalMessage = document.getElementById('custom-alert-message');

    modalTitle.textContent = 'تحذير: صلاحية الموقع معطلة';
    modalMessage.innerHTML = instructionsHtml; // نستخدم innerHTML هنا لعرض القائمة بشكل صحيح
    modal.classList.remove('hidden');
}

const supabaseClient = supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
async function initializeContractFilters() {
    const data = await getFilterData(); // إعادة استخدام الدالة الموجودة لجلب البيانات
    const regionSelect = document.getElementById('contract-filter-region');
    if (!regionSelect) return;

    const regions = Object.keys(data).sort();
    regionSelect.innerHTML = '<option value="">كل المناطق</option>';
    regions.forEach(region => {
        regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
    });
}
let map; // متغير الخريطة ليكون عاماً
let markersLayer = L.layerGroup(); // طبقة لتجميع علامات الحراس
let guardMarkers = new Map(); // متغير لتخزين علامات الحراس على الخريطة
let siteMarkersLayer = L.featureGroup(); // تم التغيير إلى featureGroup لدعم getBounds
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}
let currentUser = null; // متغير لتخزين معلومات المستخدم الذي سجل دخوله
let guardAttendanceSubscription = null; // متغير لتخزين اشتراك الحضور المباشر
let statsInterval = null; // متغير لتخزين مؤقت تحديث الإحصائيات
let pageRefreshInterval = null; // مؤقت لتحديث الصفحات تلقائياً
let adminMonitorInterval = null; // مؤقت تحديث صفحة مراقبة الإدارة
let locationPermissionStatus = null; // لمراقبة صلاحية الموقع للحارس المسجل حضوره
let attendancePageInterval = null; // مؤقت لتحديث صفحة الحضور تلقائياً
let allSiteLocations = []; // لتخزين قائمة بكل المواقع المتاحة في النظام
let currentAssignedLocations = []; // لتخزين قائمة المواقع المعينة للمشرف الذي يتم تعديله حاليًا
let hrDebounceTimer; // مؤقت لتأخير البحث في صفحة الموظفين
let updateCheckInterval = null; // مؤقت للتحقق الدوري من التحديثات
let activeSubscription = null; // للاحتفاظ بالاشتراك المباشر الفعال
let announcementCheckInterval = null; // مؤقت للتحقق من انتهاء الإعلانات
let patrolWatcherId = null; // متغير لتخزين معرّف عملية تتبع الجولة
let payrollExportData = []; // لتخزين بيانات مسير الرواتب الجاهزة للتصدير
let vacanciesExportData = []; // لتخزين بيانات الشواغر المفلترة الجاهزة للتصدير
let availableVacancyData = []; // <-- إضافة جديدة لتخزين الشواغر المتاحة
let currentlyDisplayedGuardIds = []; // لتخزين الحراس المفلترين// =======================================================
/**
 * دالة لتنسيق رقم الجوال السعودي ليناسب رابط واتساب
 * @param {string} phone - رقم الجوال
 * @returns {string|null} - الرقم المنسق (e.g., 9665...) أو null
 */
function formatPhoneNumberForWhatsApp(phone) {
    if (!phone) return null;
    let formattedPhone = phone.toString().replace(/[^0-9]/g, '');
    if (formattedPhone.startsWith('05') && formattedPhone.length >= 10) {
        return `966${formattedPhone.substring(1)}`;
    }
    if (formattedPhone.startsWith('966') && formattedPhone.length >= 12) {
        return formattedPhone;
    }
    return null;
}
document.addEventListener('change', function(event) {
    if (event.target.id === 'employee-role') {
        toggleManagerialFields(event.target.value);
    }
});
function formatTimeAMPM(timeString) {
    if (!timeString) return 'غير محدد';
    const [hours, minutes] = timeString.split(':');
    let h = parseInt(hours);
    const ampm = h >= 12 ? 'م' : 'ص';
    h = h % 12;
    h = h ? h : 12; // الساعة 0 أو 12 تبقى 12
    const m = String(minutes).padStart(2, '0');
    return `${h}:${m} ${ampm}`;
}

function createShiftTimeLabel(shift) {
    if (!shift) return '(غير محدد)';

    let periods = [];
    if (shift.periods && Array.isArray(shift.periods) && shift.periods.length > 0) {
        periods = shift.periods;
    } else if (shift.start_time && shift.end_time) {
        periods = [shift]; // تحويل الهيكل القديم إلى مصفوفة ليسهل التعامل معه
    }

    if (periods.length > 0) {
        const periodsText = periods.map(period => {
            const startTime = formatTimeAMPM(period.start_time);
            const endTime = formatTimeAMPM(period.end_time);
            return `${startTime} - ${endTime}`;
        }).join(' و '); // الربط بـ "و" سيحدث فقط إذا كان هناك أكثر من فترة
        return `(${periodsText})`;
    }
    return '(وقت غير محدد)';
}
/**
 * الدالة المركزية "العقل المدبر" لجلب الجدول الصحيح ليوم معين
 * @param {object} schedule - كائن الوردية الكامل من الداتا بيس
 * @param {Date} targetDate - التاريخ المطلوب معرفة جدوله
 * @returns {object | null} - كائن يحتوي على الفترات الزمنية الصحيحة أو null إذا كان يوم راحة
 */
function getScheduleForDate(schedule, targetDate) {
    if (!schedule || !targetDate) return null;

    const dayKey = targetDate.toLocaleString('en-US', { weekday: 'short' }); // 'Sun', 'Mon', etc.
    if (schedule.day_overrides && schedule.day_overrides[dayKey]) {
        return {
            isOverride: true,
            periods: schedule.day_overrides[dayKey].periods
        };
    }
    if (schedule.days && schedule.days.includes(dayKey)) {
        let periods = schedule.periods;
        if (!periods && schedule.start_time && schedule.end_time) {
            periods = [{
                start_time: schedule.start_time,
                end_time: schedule.end_time
            }];
        }

        if (periods) {
            return {
                isOverride: false,
                periods: periods
            };
        }
    }
    return null;
}

/**
 * دالة جديدة لعرض تفاصيل الوردية بشكل احترافي في بطاقات المشرفين
 * @param {object} schedule - كائن الوردية الكامل
 * @returns {string} - كود HTML لعرض التفاصيل
 */
function renderFullScheduleDetailsHtml(schedule) {
    if (!schedule) {
        return `<div class="info-line" style="color: var(--denied-color);"><i class="ph-bold ph-warning-circle"></i><strong>الحالة:</strong> غير مسكن على شاغر</div>`;
    }

    const dayTranslations = { Sat: 'السبت', Sun: 'الأحد', Mon: 'الاثنين', Tue: 'الثلاثاء', Wed: 'الأربعاء', Thu: 'الخميس', Fri: 'الجمعة' };
    const workDays = (schedule.days || []).map(day => dayTranslations[day] || day).join('، ');

    let html = `
        <div class="info-line"><i class="ph-bold ph-clock"></i><strong>الوقت الافتراضي:</strong> ${createShiftTimeLabel(schedule)}</div>
        <div class="info-line"><i class="ph-bold ph-calendar-check"></i><strong>الأيام الافتراضية:</strong> ${workDays}</div>
    `;

    if (schedule.day_overrides && Object.keys(schedule.day_overrides).length > 0) {
        html += `<div class="info-line" style="margin-top:10px; padding-top:10px; border-top: 1px dashed #ccc;"><i class="ph-bold ph-warning"></i><strong>استثناءات:</strong></div><ul>`;
        for (const dayKey in schedule.day_overrides) {
            const override = schedule.day_overrides[dayKey];
            const dayName = dayTranslations[dayKey] || dayKey;
            const overrideTimeLabel = createShiftTimeLabel(override); // نستخدم نفس الدالة لعرض الوقت
            html += `<li style="font-size: 0.9rem;"><strong>${dayName}:</strong> ${overrideTimeLabel}</li>`;
        }
        html += `</ul>`;
    }

    return html;
}
function checkForUpdates() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(reg => {
            if (reg) {
                reg.update();
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            newWorker.postMessage({ action: 'SKIP_WAITING' });
                        }
                    });
                });
            }
        });
    }
}

/**
 * دالة لإرسال إشعار لمستخدم معين أو لمجموعة مستخدمين.
 * @param {number[] | number} userIds - الـ ID الخاص بالمستخدم أو مصفوفة من IDs.
 * @param {string} title - عنوان الإشعار.
 * @param {string} body - نص الإشعار.
 * @param {string} [link='/'] - الرابط الذي سيتم فتحه عند النقر.
 */
async function sendNotification(userIds, title, body, link = '/') {
    const targetUserIds = Array.isArray(userIds) ? userIds : [userIds];

    if (targetUserIds.length === 0) return;

    try {
        const notificationRecords = targetUserIds.map(id => ({
            user_id: id,
            title: title,
            body: body,
            link: link
        }));
        await supabaseClient.from('notifications').insert(notificationRecords);
        for (const userId of targetUserIds) {
            supabaseClient.functions.invoke('send-fcm-notification', {
                body: { userId, title, body, link },
            }).then(({ data, error }) => {
                if (error) {
                    console.error(`Error invoking FCM for user ${userId}:`, error);
                } else {
                    console.log(`FCM function invoked for user ${userId}:`, data);
                }
            });
        }
    } catch (e) {
        console.error('An unexpected error occurred in sendNotification:', e);
    }
}
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const icon = type === 'success' ? 'ph-check-circle' : 'ph-x-circle';
    toast.className = `toast-message ${type}`;
    toast.innerHTML = `<i class="ph-bold ${icon}"></i> <p>${message}</p>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000); // إزالة التنبيه بعد 4 ثوانٍ
}
async function updateNotificationBell() {
    if (!currentUser) return;
    const { count, error } = await supabaseClient
        .from('notifications')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', currentUser.id) // <-- هنا كان الخطأ
        .eq('is_read', false);

    const badge = document.getElementById('notification-count-badge');
    if (error) {
        console.error("Error fetching notification count:", error);
        badge.classList.add('hidden');
        return;
    }

    if (count > 0) {
        badge.textContent = count > 9 ? '9+' : count;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}
function stopPatrolTracking() {
    if (patrolWatcherId) {
        navigator.geolocation.clearWatch(patrolWatcherId);
        patrolWatcherId = null;
        console.log('تم إيقاف تتبع الجولة.');
    }
}




function startPatrolTracking(patrolId) {
    stopPatrolTracking(); // إيقاف أي متتبع قديم أولاً
    console.log(`بدء تتبع الجولة رقم: ${patrolId}`);

    patrolWatcherId = navigator.geolocation.watchPosition(
        async (position) => {
            const { latitude, longitude } = position.coords;
            const newCoordinate = { lat: latitude, lng: longitude, time: new Date().toISOString() };
            await supabaseClient.from('guard_locations')
                .upsert({ guard_id: currentUser.id, latitude, longitude }, { onConflict: 'guard_id' });
            const { data: currentPatrol, error: fetchError } = await supabaseClient
                .from('patrols')
                .select('path')
                .eq('id', patrolId)
                .single();

            if (fetchError) return console.error("Error fetching current path:", fetchError);
            const newPath = (currentPatrol.path || []);
            newPath.push(newCoordinate);
            await supabaseClient
                .from('patrols')
                .update({ path: newPath })
                .eq('id', patrolId);
        },
        (error) => {
            console.error("خطأ في تتبع الجولة:", error);
            stopPatrolTracking();
        },
        { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
    );
}



async function loadArchivePage(requestType) {
    const containerId = `archive-${requestType}-tab`;
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = `<p style="text-align: center; padding-top: 20px;">جاري تحميل الأرشيف...</p>`;

    const { data: requests, error } = await supabaseClient
        .from('employee_requests')
        .select(`*, users:user_id(name)`)
        .eq('request_type', requestType)
        .not('status', 'in', '("معلق", "بانتظار موافقة العمليات", "بانتظار موافقة الموارد البشرية")') // جلب المقبول والمرفوض فقط
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = `<p style="color:red;">حدث خطأ في تحميل الأرشيف.</p>`;
        return console.error(error);
    }
    if (requests.length === 0) {
        container.innerHTML = `<div class="empty-state" style="margin-top:20px;"><i class="ph-bold ph-archive"></i><h4>الأرشيف فارغ</h4><p>لا توجد طلبات مكتملة (مقبولة أو مرفوضة) لعرضها حالياً.</p></div>`;
        return;
    }

    const requestTypeTranslations = { leave: 'إجازة', resignation: 'استقالة', loan: 'سلفة' };
    const requestIcons = { leave: 'ph-calendar-blank', resignation: 'ph-file-x', loan: 'ph-hand-coins' };

    container.innerHTML = `<div class="archive-grid">${requests.map(request => {
        const statusClass = request.status === 'مقبول' ? 'approved' : 'denied';
        const typeText = requestTypeTranslations[request.request_type] || request.request_type;
        const iconClass = requestIcons[request.request_type] || 'ph-file';

        let detailsHtml = '';
        if (request.details) {
            if (request.details.start_date) detailsHtml += `<p><strong>تاريخ البدء:</strong> ${formatGregorianDate(request.details.start_date)}</p>`;
            if (request.details.days) detailsHtml += `<p><strong>المدة:</strong> ${request.details.days} أيام</p>`;
            if (request.details.amount) detailsHtml += `<p><strong>المبلغ:</strong> ${request.details.amount} ر.س</p>`;
            if (request.details.reason) detailsHtml += `<p><strong>السبب:</strong> ${request.details.reason}</p>`;
        }

        let footerHtml = '';
        if (request.status === 'مرفوض' && request.rejection_reason) {
            footerHtml = `<div class="archive-card-footer"><strong>سبب الرفض:</strong> ${request.rejection_reason}</div>`;
        }

        return `
            <div class="archive-card status-${statusClass}">
                <div class="archive-card-header">
                    <h4><i class="ph-fill ${iconClass}"></i> ${typeText}</h4>
                    <span class="status-badge ${statusClass}">${request.status}</span>
                </div>
                <div class="archive-card-body">
                    <p><strong>المقدم:</strong> ${request.users ? request.users.name : 'غير معروف'}</p>
                    <p><strong>تاريخ الطلب:</strong> ${formatGregorianDate(request.created_at)}</p>
                    ${detailsHtml}
                </div>
                ${footerHtml}
            </div>
        `;
    }).join('')}</div>`;
}

async function loadVehicleInvoicesView() {
    const container = document.getElementById('vehicle-invoices-list-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الفواتير...</p>';

    try {
        const { data: invoices, error } = await supabaseClient
            .from('vehicle_invoices')
            .select(`
                *,
                vehicle:vehicles(vehicle_type, license_plate),
                uploader:users(name)
            `)
            .order('invoice_date', { ascending: false });

        if (error) throw error;

        if (invoices.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا توجد فواتير</h4><p>لم يتم رفع أي فواتير للمركبات بعد.</p></div>';
            return;
        }

        container.innerHTML = `
            <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>المركبة</th>
                        <th>نوع الفاتورة</th>
                        <th>تاريخ الفاتورة</th>
                        <th>القيمة</th>
                        <th>الموظف (المُضيف)</th>
                        <th>ملاحظات</th>
                        <th>المرفق</th>
                        ${currentUser.role === 'مدير النظام' ? '<th>إجراءات</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${invoices.map(invoice => {
                        const vehicleName = invoice.vehicle ? `${invoice.vehicle.vehicle_type} (${invoice.vehicle.license_plate})` : 'مركبة محذوفة';
                        const invoiceType = invoice.invoice_type === 'أخرى' ? invoice.invoice_type_other : invoice.invoice_type;
                        
                        return `
                            <tr>
                                <td>${vehicleName}</td>
                                <td>${invoiceType}</td>
                                <td>${formatGregorianDate(invoice.invoice_date)}</td>
                                <td>${invoice.amount.toFixed(2)} ر.س</td>
                                <td>${invoice.uploader ? invoice.uploader.name : '-'}</td>
                                <td>${invoice.notes || '-'}</td>
                                <td>
                                    <button class="btn btn-secondary btn-sm view-invoice-file-btn" data-url="${invoice.file_url}" title="عرض المرفق">
                                        <i class="ph-bold ph-eye"></i>
                                    </button>
                                </td>
                                ${currentUser.role === 'مدير النظام' ? `
                                <td style="white-space: nowrap;">
                                    <button class="btn btn-secondary btn-sm edit-invoice-btn" data-invoice-id="${invoice.id}" title="تعديل">
                                        <i class="ph-bold ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-invoice-btn" data-invoice-id="${invoice.id}" data-file-url="${invoice.file_url}" title="حذف">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </td>
                                ` : ''}
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
}

async function loadVehicleViolationsView() {
    const container = document.getElementById('vehicle-violations-list-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل المخالفات...</p>';

    try {
        const { data: violations, error } = await supabaseClient
            .from('vehicle_violations')
            .select(`
                *,
                vehicle:vehicles(vehicle_type, license_plate),
                user:user_id(name)
            `)
            .order('violation_date', { ascending: false });
        if (error) throw error;

        if (violations.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا توجد مخالفات</h4><p>لم يتم تسجيل أي مخالفات للمركبات بعد.</p></div>';
            return;
        }

        container.innerHTML = `
            <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>المركبة</th>
                        <th>الموظف (المتسبب)</th>
                        <th>نوع المخالفة</th>
                        <th>التاريخ والوقت</th>
                        <th>القيمة</th>
                        <th>المسؤولية</th>
                        <th>الحالة</th>
                        <th>المرفق</th>
                    </tr>
                </thead>
                <tbody>
                    ${violations.map(v => {
                        const vehicleName = v.vehicle ? `${v.vehicle.vehicle_type} (${v.vehicle.license_plate})` : 'مركبة محذوفة';
                        const userName = v.user ? v.user.name : 'موظف محذوف';
                        const violationType = v.violation_type === 'أخرى' ? v.violation_type_other : v.violation_type;
                        const violationDateTime = `${formatGregorianDate(v.violation_date)} - ${formatTimeAMPM(v.violation_time)}`;
                        
                        return `
                            <tr>
                                <td>${vehicleName}</td>
                                <td>${userName}</td>
                                <td>${violationType}</td>
                                <td>${violationDateTime}</td>
                                <td>${v.amount.toFixed(2)} ر.س</td>
                                <td><span class="status ${v.responsibility === 'يخصم من الموظف' ? 'inactive' : 'pending'}">${v.responsibility}</span></td>
                                <td><span class="status ${v.status === 'مدفوعة' ? 'active' : 'inactive'}">${v.status}</span></td>
                                <td>
                                    ${v.file_url ? `<button class="btn btn-secondary btn-sm view-violation-file-btn" data-url="${v.file_url}" title="عرض المرفق"><i class="ph-bold ph-eye"></i></button>` : '-'}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
}
async function loadOpsReviewRequestsPage() {
    const regularContainer = document.getElementById('ops-review-requests-container');
    const managerContainer = document.getElementById('ops-manager-review-container');

    if (!regularContainer || !managerContainer || !currentUser) {
        return;
    }
    regularContainer.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات...</p>';
    
    let regularQuery = supabaseClient
        .from('employee_requests')
        .select(`*, users:user_id!inner(name, region)`)
        .eq('status', 'معلق') // <-- جلب الطلبات المعلقة فقط
        .not('request_type', 'eq', 'permission');
    if (currentUser.role === 'ادارة العمليات' && !currentUser.is_ops_manager) {
        regularQuery = regularQuery.eq('users.region', currentUser.region);
    } else if (currentUser.role !== 'مدير النظام' && !currentUser.is_ops_manager) {
        regularQuery = regularQuery.eq('id', '00000000-0000-0000-0000-000000000000');
    }

    const { data: regularRequests, error: regularError } = await regularQuery;

    if (regularError) { 
        regularContainer.innerHTML = '<p style="color:red;">حدث خطأ في جلب الطلبات.</p>'; 
        console.error(regularError);
    } else if (regularRequests.length === 0) { 
        regularContainer.innerHTML = '<p style="text-align: center;">لا توجد طلبات معلقة حالياً.</p>'; 
    } else {
        regularContainer.innerHTML = '';
        regularRequests.forEach(request => {
            const cardHtml = renderOpsRequestCard(request, 'ops_escalate'); // <-- استخدام الدالة المساعدة
            regularContainer.insertAdjacentHTML('beforeend', cardHtml);
        });
    }
    if (currentUser.role === 'مدير النظام' || currentUser.is_ops_manager) {
        managerContainer.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات...</p>';

        let managerQuery = supabaseClient
            .from('employee_requests')
            .select(`*, users:user_id!inner(name, region)`)
            .eq('status', 'بانتظار موافقة مدير العمليات') // <-- جلب طلبات الاعتماد
            .not('request_type', 'eq', 'permission');

        const { data: managerRequests, error: managerError } = await managerQuery;

        if (managerError) { 
            managerContainer.innerHTML = '<p style="color:red;">حدث خطأ في جلب الطلبات.</p>'; 
            console.error(managerError);
        } else if (managerRequests.length === 0) { 
            managerContainer.innerHTML = '<p style="text-align: center;">لا توجد طلبات بانتظار اعتماد المدير.</p>'; 
        } else {
            managerContainer.innerHTML = '';
            managerRequests.forEach(request => {
                const cardHtml = renderOpsRequestCard(request, 'ops_manager_escalate'); // <-- استخدام الدالة المساعدة
                managerContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
    }
    if (activeSubscription) supabaseClient.removeChannel(activeSubscription);
    activeSubscription = supabaseClient
        .channel('public:employee_requests:ops')
        .on(
            'postgres_changes',
            { 
                event: '*', 
                schema: 'public', 
                table: 'employee_requests',
                filter: 'status=in.("معلق","بانتظار موافقة مدير العمليات")'
            },
            (payload) => {
                console.log('Realtime update for OPS requests!', payload);
                loadOpsReviewRequestsPage(); // إعادة تحميل كلا التبويبين
            }
        )
        .subscribe();

    console.log('Subscribed to real-time ops employee requests.');
}
/**
 * دالة مساعدة لإنشاء كود HTML لبطاقة طلب في صفحة العمليات
 * @param {object} request - كائن الطلب
 * @param {string} approvalStage - المرحلة ('ops_escalate' أو 'ops_manager_escalate')
 * @returns {string} - كود HTML للبطاقة
 */
function renderOpsRequestCard(request, approvalStage) {
    const requestTypeTranslations = { leave: 'إجازة', resignation: 'استقالة', loan: 'سلفة', permission: 'استئذان' };
    const typeText = requestTypeTranslations[request.request_type] || request.request_type;
    let detailsHtml = '';
    if (request.details) {
        if (request.details.days) detailsHtml += `<p><strong>المدة:</strong> ${request.details.days} أيام</p>`;
        if (request.details.amount) detailsHtml += `<p><strong>المبلغ:</strong> ${request.details.amount} ر.س</p>`;
        if (request.details.reason) detailsHtml += `<p><strong>السبب:</strong> ${request.details.reason}</p>`;
    }
    const buttonText = (approvalStage === 'ops_manager_escalate') ? 'اعتماد ورفع للموارد' : 'اعتماد ورفع للمدير';

    return `
        <div class="review-request-card">
            <div class="review-request-header status-pending">
                <h4>طلب ${typeText}</h4>
                <span class="status-badge">${request.status}</span>
            </div>
            <div class="review-request-body">
                <div class="request-meta-grid" style="grid-template-columns: 1fr;">
                    <div class="request-meta-item">
                        <i class="ph-bold ph-user-circle"></i>
                        <span><strong>مقدم الطلب:</strong> ${request.users ? request.users.name : 'غير معروف'}</span>
                    </div>
                </div>
                <div class="request-main-details">${detailsHtml}</div>
            </div>
            <div class="review-request-footer">
                <button class="btn btn-success request-action-button" data-approval-stage="${approvalStage}" data-action="approve" data-request-id="${request.id}">
                    <i class="ph-bold ph-arrow-fat-up"></i> ${buttonText}
                </button>
                <button class="btn btn-danger request-action-button" data-approval-stage="${approvalStage}" data-action="reject" data-request-id="${request.id}">
                    <i class="ph-bold ph-x-circle"></i> رفض مباشر
                </button>
            </div>
        </div>`;
}

 async function viewPatrolPath(patrolId) {
    document.querySelector('a[data-page="page-geo"]').click();
    setTimeout(async () => {
        try {
            const { data: patrol, error } = await supabaseClient
                .from('patrols')
                .select('path')
                .eq('id', patrolId)
                .single();

            if (error || !patrol || !patrol.path || patrol.path.length === 0) {
                return showToast('لا يوجد مسار مسجل لهذه الجولة أو حدث خطأ.', 'error');
            }
            markersLayer.clearLayers();

            const latLngs = patrol.path.map(p => [p.lat, p.lng]);
            const startPoint = latLngs[0];
            const endPoint = latLngs.length > 1 ? latLngs[latLngs.length - 1] : null;
            const startIcon = L.divIcon({
                className: 'map-marker-icon marker-start',
                html: `<i class="ph-fill ph-flag"></i>`,
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            });

            const endIcon = L.divIcon({
                className: 'map-marker-icon marker-end',
                html: `<i class="ph-fill ph-flag-checkered"></i>`,
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            });

            const stopIcon = L.divIcon({
                className: 'map-marker-icon marker-stop',
                html: `<i class="ph-fill ph-pause"></i>`,
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            });
            if (latLngs.length > 1) {
                L.polyline(latLngs, { color: '#003388', weight: 8, opacity: 0.5, lineCap: 'round', lineJoin: 'round' }).addTo(markersLayer);
                const polyline = L.polyline(latLngs, { color: '#3b82f6', weight: 5, opacity: 0.9 }).addTo(markersLayer);
                map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
            } else if (startPoint) {
                map.setView(startPoint, 16);
            }
            const STOP_DURATION_MINUTES = 5;
            const STOP_RADIUS_METERS = 50;

            for (let i = 1; i < patrol.path.length; i++) {
                const prevPoint = patrol.path[i - 1];
                const currentPoint = patrol.path[i];

                const distance = calculateDistance(
                    { lat: prevPoint.lat, lng: prevPoint.lng },
                    { lat: currentPoint.lat, lng: currentPoint.lng }
                );

                const timeDiffMinutes = (new Date(currentPoint.time) - new Date(prevPoint.time)) / (1000 * 60);

                if (timeDiffMinutes >= STOP_DURATION_MINUTES && distance <= STOP_RADIUS_METERS) {
                    const stopLocation = [prevPoint.lat, prevPoint.lng];
                    const popupText = `<b>نقطة توقف</b><br>المدة: حوالي ${Math.round(timeDiffMinutes)} دقيقة`;
                    L.marker(stopLocation, { icon: stopIcon }).addTo(markersLayer).bindPopup(popupText);
                }
            }
            if (startPoint) {
                L.marker(startPoint, { icon: startIcon }).addTo(markersLayer).bindPopup('<b>بداية الجولة</b>');
            }
            if (endPoint) {
                L.marker(endPoint, { icon: endIcon }).addTo(markersLayer).bindPopup('<b>نهاية الجولة</b>');
            }

        } catch (err) {
            console.error("Error viewing patrol path:", err);
            showToast('فشل تحميل مسار الجولة.', 'error');
        }
    }, 500); // 500ms delay
}
async function loadOpsDirectivesPage() {
    const page = document.getElementById('page-directives-ops');
    if (!page || !currentUser) return;

    const container = page.querySelector('#ops-users-list-container');
    const searchInput = page.querySelector('#ops-directive-search-input');
    const roleFilter = page.querySelector('#ops-directive-role-filter');
    let allEmployees = [];

    const fetchData = async () => {
        container.innerHTML = '<p style="text-align: center;">جاري تحميل قائمة الموظفين...</p>';
        const regionParam = (currentUser.is_ops_manager || currentUser.role === 'مدير النظام') ? null : currentUser.region;

        const { data, error } = await supabaseClient.rpc('get_ops_employees_for_directives', {
            p_region: regionParam
        });

        if (error) {
            container.innerHTML = '<p style="color:red;">حدث خطأ في جلب الموظفين.</p>';
            console.error("Error fetching ops employees:", error);
            return;
        }
        allEmployees = data || [];
        renderEmployees();
    };

    const renderEmployees = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedRole = roleFilter.value;
        const filteredEmployees = allEmployees.filter(emp => {
            const matchesSearch = !searchTerm || 
                                (emp.name && emp.name.toLowerCase().includes(searchTerm)) || 
                                (emp.id_number && emp.id_number.includes(searchTerm));
            
            const matchesRole = !selectedRole || emp.role === selectedRole;
            
            return matchesSearch && matchesRole;
        });

        if (filteredEmployees.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-users"></i><h4>لا توجد نتائج</h4><p>لم يتم العثور على موظفين.</p></div>';
        } else {
            container.innerHTML = filteredEmployees.map(emp => {
                const projectDisplay = (Array.isArray(emp.project) ? emp.project.join(', ') : emp.project) || 'غير مسكن';
                return `
                    <div class="contract-card">
                        <div class="contract-card-body" style="flex-direction: row; justify-content: space-between; align-items: center;">
                            <div>
                                <h5 style="margin:0 0 5px 0; font-size: 1.2rem;">${emp.name} <span class="status-badge pending" style="font-size: 0.8rem;">${emp.role}</span></h5>
                                <p style="margin:0; color: var(--text-secondary);"><i class="ph-bold ph-briefcase"></i> ${projectDisplay}</p>
                            </div>
                            <button class="btn btn-primary open-directive-modal-btn" data-recipient-id="${emp.id}" data-recipient-name="${emp.name}">
                                <i class="ph-bold ph-paper-plane-tilt"></i> إرسال
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
    };
    searchInput.removeEventListener('input', renderEmployees);
    roleFilter.removeEventListener('change', renderEmployees);
    
    searchInput.addEventListener('input', renderEmployees);
    roleFilter.addEventListener('change', renderEmployees);
    
    fetchData();
}
/**
 * دالة مساعدة للتحقق إذا كانت وردية الحارس فعالة الآن بالضبط
 * (محدثة لدعم الورديات الليلية التي تعبر منتصف الليل)
 * @param {object} schedule - كائن جدول المواعيد
 * @returns {boolean} - true إذا كانت الوردية تعمل الآن
 */
function isShiftCurrentlyActive(schedule) {
    if (!schedule) return false;
    const now = new Date();
    const currentTime = now.toTimeString().substring(0, 5);
    const scheduleForToday = getScheduleForDate(schedule, now);
    if (scheduleForToday) {
        for (const period of scheduleForToday.periods) {
            const { start_time, end_time } = period;
            if (!start_time || !end_time) continue;

            if (end_time < start_time) { // وردية ليلية تبدأ اليوم وتنتهي غداً
                if (currentTime >= start_time) return true;
            } else { // وردية عادية
                if (currentTime >= start_time && currentTime < end_time) return true;
            }
        }
    }
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const scheduleForYesterday = getScheduleForDate(schedule, yesterday);

    if (scheduleForYesterday) {
        for (const period of scheduleForYesterday.periods) {
            const { start_time, end_time } = period;
            if (!start_time || !end_time) continue;
            if (end_time < start_time && currentTime < end_time) {
                return true;
            }
        }
    }

    return false; // ليس ضمن أي فترة عمل فعالة الآن
}
function getGuardStatus(guard, allTodayRecords) {
    const now = new Date();
    const schedule = guard.job_vacancies?.schedule_details?.[0];
    const openRecord = allTodayRecords.find(r => !r.checkout_at && r.status === 'حاضر');
    if (openRecord) {
        return { text: 'حاضر', class: 'present', time: `منذ ${formatTimeAMPM(new Date(openRecord.created_at).toTimeString().substring(0, 5))}` };
    }
    if (!schedule) return null; // لا يوجد جدول، لا تعرض الحارس

    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);

    const scheduleForToday = getScheduleForDate(schedule, today);
    const scheduleForYesterday = getScheduleForDate(schedule, yesterday);
    const currentTime = now.toTimeString().substring(0, 5);

    let activeShiftInfo = null;
    let shiftType = null;
    if (scheduleForYesterday) {
        const lastPeriodYesterday = scheduleForYesterday.periods[scheduleForYesterday.periods.length - 1];
        if (lastPeriodYesterday.end_time < lastPeriodYesterday.start_time && currentTime < lastPeriodYesterday.end_time) {
            activeShiftInfo = { startTime: lastPeriodYesterday.start_time, endTime: lastPeriodYesterday.end_time, startDate: yesterday.toISOString().split('T')[0] };
            shiftType = 'overnight';
        }
    }
    if (!activeShiftInfo && scheduleForToday) {
        const periods = scheduleForToday.periods;
        const firstPeriod = periods[0];
        const lastPeriod = periods[periods.length - 1];

        const [startH, startM] = firstPeriod.start_time.split(':').map(Number);
        let shiftStartTime = new Date();
        shiftStartTime.setHours(startH, startM, 0, 0);

        let isDuringShift = false;
        for (const period of periods) {
            if (period.end_time > period.start_time) {
                if (currentTime >= period.start_time && currentTime < period.end_time) isDuringShift = true;
            } else {
                if (currentTime >= period.start_time || currentTime < period.end_time) isDuringShift = true;
            }
        }

        const [endH, endM] = lastPeriod.end_time.split(':').map(Number);
        let shiftEndTime = new Date();
        shiftEndTime.setHours(endH, endM, 0, 0);
        if (lastPeriod.end_time < firstPeriod.start_time && now < shiftEndTime) { } 
        else if (lastPeriod.end_time < firstPeriod.start_time) { shiftEndTime.setDate(shiftEndTime.getDate() + 1); }

        const minutesAfterShiftEnd = (now - shiftEndTime) / 60000;
        if (isDuringShift || (now > shiftEndTime && minutesAfterShiftEnd <= 90)) {
            activeShiftInfo = { startTime: firstPeriod.start_time, endTime: lastPeriod.end_time, startDate: now.toISOString().split('T')[0] };
            shiftType = isDuringShift ? 'during_shift' : 'after_shift';
        }
    }
    if (activeShiftInfo) {
        const latestRecord = allTodayRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
        let recordFoundForShift = false; // متغير لتتبع إذا وجدنا سجل مطابق

        if (latestRecord) {
            const recordDate = new Date(latestRecord.created_at).toISOString().split('T')[0];
            if (recordDate === activeShiftInfo.startDate) {
            recordFoundForShift = true; // وجدنا سجل لهذا اليوم

            if (latestRecord.checkout_at) {
                if (latestRecord.status.includes('انسحاب')) {
                    return { text: 'انسحاب', class: 'absent', time: `في ${formatTimeAMPM(new Date(latestRecord.checkout_at).toTimeString().substring(0, 5))}` };
                }
                if (latestRecord.status.includes('استئذان')) {
                    return { text: 'استئذان', class: 'permission', time: `في ${formatTimeAMPM(new Date(latestRecord.checkout_at).toTimeString().substring(0, 5))}` };
                }
                if (latestRecord.status.includes('غياب')) {
                    if ((!latestRecord.notes || latestRecord.notes.includes('غياب آلي')) && !latestRecord.is_excused) {
                        return { text: 'غياب', class: 'absent', time: 'مسجل آلياً', action: 'CAN_OVERWRITE_ABSENT', shiftInfo: activeShiftInfo, recordId: latestRecord.id };
                    }
                    return { text: 'غياب', class: 'absent', time: 'مسجل', action: 'ABSENT_REGISTERED' };
                }
                    
                } else if (latestRecord.status.includes('غياب')) { // نستخدم else if
                    if ((!latestRecord.notes || latestRecord.notes.includes('غياب آلي')) && !latestRecord.is_excused) {
                        return { text: 'غياب', class: 'absent', time: 'مسجل آلياً', action: 'CAN_OVERWRITE_ABSENT', shiftInfo: activeShiftInfo, recordId: latestRecord.id };
                    }
                    return { text: 'غياب', class: 'absent', time: 'مسجل', action: 'ABSENT_REGISTERED' };
                }
            }
        }
        if (!recordFoundForShift || (latestRecord && latestRecord.status.includes('اكمل المناوبة'))) {
            if (shiftType === 'during_shift') {
                const [startH, startM] = activeShiftInfo.startTime.split(':').map(Number);
                let shiftStartTime = new Date();
                shiftStartTime.setHours(startH, startM, 0, 0);
                if (shiftType === 'overnight') shiftStartTime.setDate(shiftStartTime.getDate() - 1);
                
                const minutesSinceStart = (now - shiftStartTime) / 60000;
                if (minutesSinceStart > 120) {
                    return { text: 'غياب', class: 'absent', time: 'لم يسجل حضور', action: 'CAN_MARK_ABSENT', shiftInfo: activeShiftInfo };
                }
                return { text: 'متأخر', class: 'late', time: 'لم يسجل حضور', action: 'CAN_MARK_ABSENT', shiftInfo: activeShiftInfo };
            }
            if (shiftType === 'after_shift') {
                return { text: 'غياب', class: 'absent', time: 'انتهت ورديته', action: 'CAN_MARK_ABSENT', shiftInfo: activeShiftInfo };
            }
        }
    }
    if (scheduleForToday) {
        const periods = scheduleForToday.periods;
        const firstPeriod = periods[0];
        
        if (firstPeriod && firstPeriod.start_time) {
            const [startH, startM] = firstPeriod.start_time.split(':').map(Number);
            let shiftStartTime = new Date();
            shiftStartTime.setHours(startH, startM, 0, 0);

            if (now < shiftStartTime) {
                const minutesToStart = (shiftStartTime - now) / 60000;
                if (minutesToStart <= 90) {
                    return { text: 'وردية قادمة', class: 'off', time: `تبدأ ${formatTimeAMPM(firstPeriod.start_time)}` };
                }
            }
        }
    }

    return null; // لا تعرض الحارس
}
async function loadGuardAttendancePage() {
    const container = document.getElementById('guard-attendance-container');
    if (!container.querySelector('.guard-cards-grid')) {
        container.innerHTML = '<p style="text-align: center;">جاري تحميل بيانات الفريق...</p>';
    }
    if (!currentUser) return;
if (navigator.permissions) {
    try {
        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
        if (permissionStatus.state === 'denied') {
            const statusTextContainer = document.getElementById('attendance-status');
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            let instructionsHtml = '';
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                instructionsHtml = `
                    <div class="permission-denied-message">
                        <h4><i class="ph-bold ph-map-pin-slash"></i> صلاحية الموقع معطلة (iPhone)</h4>
                        <p>لتسجيل الحضور، يجب تفعيل الصلاحية يدويًا. اتبع الخطوات التالية:</p>
                        <ol>
                            <li>اذهب إلى <b>الإعدادات (Settings)</b>.</li>
                            <li>اختر <b>الخصوصية والأمن (Privacy & Security)</b>.</li>
                            <li>اختر <b>خدمات الموقع (Location Services)</b>.</li>
                            <li>ابحث عن المتصفح (Safari أو Chrome) وقم بالسماح له بالوصول للموقع.</li>
                        </ol>
                    </div>
                `;
            }
            else if (/android/i.test(userAgent)) {
                instructionsHtml = `
                    <div class="permission-denied-message">
                        <h4><i class="ph-bold ph-map-pin-slash"></i> صلاحية الموقع معطلة (Android)</h4>
                        <p>لتسجيل الحضور، يجب تفعيل الصلاحية يدويًا. اتبع الخطوات التالية:</p>
                        <ol>
                            <li>اذهب إلى <b>الإعدادات (Settings)</b>.</li>
                            <li>اختر <b>التطبيقات (Apps)</b>.</li>
                            <li>ابحث عن المتصفح <b>Chrome</b>.</li>
                            <li>اختر <b>الأذونات (Permissions)</b> ثم <b>الموقع (Location)</b> واختر "السماح".</li>
                        </ol>
                    </div>
                `;
            }
            else {
                 instructionsHtml = `
                    <div class="permission-denied-message">
                        <h4><i class="ph-bold ph-map-pin-slash"></i> صلاحية الموقع معطلة</h4>
                        <p>لقد قمت برفض إذن الوصول للموقع سابقًا. لا يمكنك تسجيل الحضور حتى يتم تفعيل الصلاحية يدويًا من إعدادات المتصفح.</p>
                    </div>
                `;
            }

            statusTextContainer.innerHTML = instructionsHtml;
            return; // إيقاف تحميل باقي الصفحة
        }
    } catch (permError) {
        console.warn("Could not check location permissions:", permError);
    }
}

    try {
        const filters = {
            searchVal: document.getElementById('ga-filter-search').value,
            region: document.getElementById('ga-filter-region').value,
            city: document.getElementById('ga-filter-city').value,
            project: document.getElementById('ga-filter-project').value,
            location: document.getElementById('ga-filter-location').value,
            statusVal: document.getElementById('ga-filter-status').value,
        };

        const { finalFilteredGuards } = await getFilteredAttendanceData(filters);
        currentlyDisplayedGuardIds = finalFilteredGuards.map(guard => guard.id);

        const stats = finalFilteredGuards.reduce((acc, g) => {
            const statusText = g.statusInfo.text;
            if (statusText === 'حاضر') acc.present++;
            else if (statusText === 'غياب' || statusText === 'متأخر') acc.absent++;
            else if (statusText === 'انسحاب') acc.withdrawal++;
            else if (statusText === 'استئذان') acc.permission++;
            else if (statusText === 'وردية قادمة') acc.off++;
            return acc;
        }, { present: 0, absent: 0, withdrawal: 0, permission: 0, off: 0 });

        const scheduledCount = stats.present + stats.absent + stats.withdrawal + stats.permission;

        document.getElementById('stats-guard-present').textContent = stats.present;
        document.getElementById('stats-guard-absent').textContent = stats.absent;
        document.getElementById('stats-guard-withdrawal').textContent = stats.withdrawal;
        document.getElementById('stats-guard-permission').textContent = stats.permission;
        document.getElementById('stats-guard-off').textContent = stats.off;
        document.getElementById('stats-guard-scheduled').textContent = scheduledCount;
const { count: coverageCount } = await supabaseClient.from('users').select('*', { count: 'exact', head: true }).eq('employment_status', 'تغطية');
document.getElementById('stats-guard-coverage').textContent = coverageCount || 0;
let vacancyQuery = supabaseClient
    .from('job_vacancies')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'open');
if (currentUser.role === 'مشرف' && currentUser.assigned_locations) {
    if (currentUser.assigned_locations.length > 0) {
        const siteFilters = currentUser.assigned_locations.map(loc => 
            `and(project.eq.${loc.contract},specific_location.eq.${loc.site})`
        ).join(',');

        vacancyQuery = vacancyQuery.or(siteFilters);
    } else {
        vacancyQuery = vacancyQuery.eq('id', '00000000-0000-0000-0000-000000000000');
    }
} else if (currentUser.role === 'ادارة العمليات' && currentUser.region) {
    vacancyQuery = vacancyQuery.eq('region', currentUser.region);
}
if (filters.region) vacancyQuery = vacancyQuery.eq('region', filters.region);
if (filters.city) vacancyQuery = vacancyQuery.eq('location', filters.city);
if (filters.project) vacancyQuery = vacancyQuery.eq('project', filters.project);
if (filters.location) vacancyQuery = vacancyQuery.eq('specific_location', filters.location);

const { count: vacancyCount, error: vacancyError } = await vacancyQuery;
if (vacancyError) console.error("Error fetching filtered vacancies count:", vacancyError);

document.getElementById('stats-guard-vacancies').textContent = vacancyCount || 0;

        const cardsHtml = finalFilteredGuards.map(guard => {
            const schedule = guard.coverageInfo ? guard.coverageInfo.shiftDetails : guard.job_vacancies?.schedule_details?.[0];
            const scheduleForToday = getScheduleForDate(schedule, new Date());
            
            const projectDisplay = guard.coverageInfo ? guard.coverageInfo.shiftDetails.project : ((Array.isArray(guard.project) ? guard.project.join(', ') : guard.project) || 'غير محدد');
            const isCoverage = !!guard.coverageInfo;
            const cardClass = isCoverage ? `status-${guard.statusInfo.class} coverage-card` : `status-${guard.statusInfo.class}`;
            let coverageReasonHtml = '';
            if (isCoverage) {
                const reason = guard.coverageInfo.reason || 'تغطية عامة';
                coverageReasonHtml = `
                    <div style="margin-top: 8px; padding: 6px; background-color: #f3e8ff; border-radius: 6px; border: 1px dashed #8b5cf6; color: #6d28d9; font-size: 0.9rem; font-weight: bold; text-align: center;">
                        <i class="ph-bold ph-shield-check"></i> ${reason}
                    </div>
                `;
            }
            
            let actionButtons = '';
            const statusAction = guard.statusInfo.action;

            if ((statusAction === 'CAN_MARK_ABSENT' || statusAction === 'CAN_OVERWRITE_ABSENT') && (currentUser.role === 'مشرف' || currentUser.role === 'ادارة العمليات' || currentUser.role === 'مدير النظام')) {
                 const snapshotData = {
                    project: guard.coverageInfo ? guard.coverageInfo.shiftDetails.project : guard.job_vacancies?.project,
                    location: guard.coverageInfo ? guard.coverageInfo.shiftDetails.location : guard.job_vacancies?.specific_location,
                    region: guard.coverageInfo ? guard.coverageInfo.shiftDetails.region : guard.job_vacancies?.region,
                    city: guard.coverageInfo ? guard.coverageInfo.shiftDetails.city : guard.job_vacancies?.location,
                    schedule_details: [schedule]
                };
                const shiftInfo = guard.statusInfo.shiftInfo;
                const recordIdAttribute = statusAction === 'CAN_OVERWRITE_ABSENT' ? `data-record-id-to-overwrite="${guard.statusInfo.recordId}"` : '';
                const buttonTitle = statusAction === 'CAN_OVERWRITE_ABSENT' ? "الكتابة فوق الغياب الآلي" : "تسجيل غياب يدوي";

                actionButtons += `<button class="btn btn-danger open-manual-absence-btn" 
                                    data-guard-id="${guard.id}" 
                                    data-guard-name="${guard.name}"
                                    data-shift-snapshot='${JSON.stringify(snapshotData)}'
                                    data-shift-start="${shiftInfo.startDate}T${shiftInfo.startTime}"
                                    data-shift-end="${shiftInfo.startDate}T${shiftInfo.endTime}"
                                    data-is-overnight="${shiftInfo.endTime < shiftInfo.startTime ? 'true' : 'false'}"
                                    ${recordIdAttribute}
                                    title="${buttonTitle}">
                                    <i class="ph-bold ph-user-minus"></i>
                                </button>`;
            }

            const directiveButton = `<button class="btn btn-secondary btn-sm open-directive-modal-btn" data-recipient-id="${guard.id}" data-recipient-name="${guard.name}" title="إرسال توجيه"><i class="ph-bold ph-paper-plane-tilt"></i></button>`;
            const mapButton = guard.statusInfo.class === 'present' ? `<button class="btn btn-secondary btn-sm view-on-map-btn" data-guard-id="${guard.id}" title="عرض في الخريطة"><i class="ph-bold ph-map-pin-line"></i></button>` : '';
            
            let adminEditButton = '';
            if (currentUser.role === 'مدير النظام' || currentUser.role === 'ادارة العمليات') {
                const currentRecordId = guard.statusInfo.recordId || (guard.statusInfo.record ? guard.statusInfo.record.id : '');
                
                const snapshotData = {
                    project: guard.coverageInfo ? guard.coverageInfo.shiftDetails.project : guard.job_vacancies?.project,
                    location: guard.coverageInfo ? guard.coverageInfo.shiftDetails.location : guard.job_vacancies?.specific_location,
                    region: guard.coverageInfo ? guard.coverageInfo.shiftDetails.region : guard.job_vacancies?.region,
                    city: guard.coverageInfo ? guard.coverageInfo.shiftDetails.city : guard.job_vacancies?.location,
                    schedule_details: [schedule]
                };
                adminEditButton = `<button class="btn btn-secondary btn-sm admin-edit-attendance-btn" 
                                    data-guard-id="${guard.id}" 
                                    data-name="${guard.name}" 
                                    data-id="${currentRecordId}" 
                                    data-shift-data='${JSON.stringify(snapshotData)}'
                                    title="تعديل/تحضير يدوي">
                                    <i class="ph-bold ph-pencil-simple"></i>
                                   </button>`;
            }

            if (guard.coverageInfo) {
                actionButtons = `<button class="btn btn-danger btn-sm cancel-assignment-btn" data-guard-id="${guard.id}" data-guard-name="${guard.name}" title="إلغاء تكليف هذا الحارس"><i class="ph-bold ph-user-minus"></i></button>`;
            } else if (guard.employment_status === 'اساسي') {
                const canBeCovered = ['غياب', 'متأخر', 'وردية قادمة', 'انسحاب'].includes(guard.statusInfo.text);
                if (canBeCovered) {
                    actionButtons += `<button class="btn btn-secondary btn-sm proactive-coverage-btn" data-need='${JSON.stringify({ absent_guard_id: guard.id, absent_guard_name: guard.name, project: guard.project, location: guard.location, city: guard.city, region: guard.region, schedule_details: [guard.job_vacancies?.schedule_details[0]] })}' title="إنشاء تغطية استباقية"><i class="ph-bold ph-shield-plus"></i></button>`;
                }
            }

            const shiftTimeHtmlText = createShiftTimeLabel(scheduleForToday || schedule); // fallback to base schedule if today not found
            const shiftTimeHtml = `<p style="color: var(--accent-color); font-weight: 700;"><i class="ph-fill ph-clock"></i> ${shiftTimeHtmlText}${scheduleForToday?.isOverride ? ' <span class="status-badge pending" style="font-size:0.7rem;">استثناء</span>' : ''}</p>`;

            const formattedWhatsAppNumber = formatPhoneNumberForWhatsApp(guard.phone);
            const callButtonHtml = guard.phone ? `<a href="tel:${guard.phone}" class="btn btn-secondary btn-sm" title="اتصال مباشر"><i class="ph-bold ph-phone-call"></i></a>` : '';
            const whatsappButtonHtml = formattedWhatsAppNumber ? `<a href="https://wa.me/${formattedWhatsAppNumber}" target="_blank" class="btn btn-success btn-sm" title="محادثة واتساب"><i class="ph-bold ph-whatsapp-logo"></i></a>` : '';

            return `<div class="guard-card ${cardClass}">
                        <div class="guard-card-body">
                            <div class="guard-card-info">
                                <h4>${guard.name} ${isCoverage ? '<span style="font-size:0.8rem; background:#8b5cf6; color:white; padding:2px 6px; border-radius:4px;">تغطية</span>' : ''}</h4>
                                <p><i class="ph-fill ph-map-pin"></i> ${projectDisplay} / ${guard.location || 'غير محدد'}</p>
                                <p><i class="ph-fill ph-phone"></i> ${guard.phone || 'غير مسجل'} </p>
                                ${shiftTimeHtml}
                            </div>
                            
                            ${coverageReasonHtml}

                            <div class="guard-card-status" style="margin-top: 10px;">
                                <span class="status-indicator ${guard.statusInfo.class}"></span>
                                <span>${guard.statusInfo.text}</span>
                                ${statusAction === 'ABSENT_REGISTERED' ? `<button class="btn btn-secondary" disabled style="background-color: #6b7280; opacity: 0.7; cursor: not-allowed; margin-right: auto; padding: 4px 10px; font-size: 0.8rem;"><i class="ph-bold ph-check-circle"></i> مسجل</button>` : (statusAction === 'CAN_MARK_ABSENT' || statusAction === 'CAN_OVERWRITE_ABSENT' ? '' : `<span class="time" style="margin-right: auto;">${guard.statusInfo.time}</span>`)}
                            </div>
                        </div>
                        <div class="guard-card-actions">
                            ${actionButtons}${mapButton}${directiveButton}${whatsappButtonHtml}${callButtonHtml}${adminEditButton}
                        </div>
                    </div>`;
        }).join('');

        container.innerHTML = `<div class="guard-cards-grid">${cardsHtml || '<p style="text-align:center; padding: 40px;">لا يوجد حراس يطابقون شروط الفلترة.</p>'}</div>`;

        if (!activeSubscription) {
            activeSubscription = supabaseClient.channel('public:attendance_and_users').on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, () => loadGuardAttendancePage()).on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => loadGuardAttendancePage()).subscribe();
        }
    } catch (err) {
        container.innerHTML = `<p style="color: red;">حدث خطأ: ${err.message}</p>`;
        console.error("Guard Attendance Error:", err);
    }
}
async function exportPayrollDataToCsv(data, filename) {
    if (data.length === 0) {
        return alert('لا توجد بيانات للتصدير.');
    }
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('مسير رواتب', {
        views: [{ rightToLeft: true }] // جعل الورقة تبدأ من اليمين لليسار
    });
    const logoUrl = 'https://i.imgur.com/WTIY72K.png';

    try {
        const response = await fetch(logoUrl);
        const imageBuffer = await response.arrayBuffer();
        const imageId = workbook.addImage({
            buffer: imageBuffer,
            extension: 'png',
        });

        worksheet.addBackgroundImage(imageId);
    } catch (e) {
        console.error("لا يمكن تحميل الشعار. تأكد من أن الرابط صحيح ومتاح للعامة.", e);
    }
    const headerStyle = {
        font: { name: 'Arial', size: 12, bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } },
        alignment: { horizontal: 'center', vertical: 'middle' },
        border: { bottom: { style: 'medium', color: { argb: 'FF000000' } } }
    };
    const cellStyle = { font: { name: 'Arial', size: 10 }, alignment: { horizontal: 'center', vertical: 'middle' } };
    const moneyStyle = { ...cellStyle, numFmt: '#,##0.00 "ر.س"' };
    const totalStyle = { ...moneyStyle, font: { ...cellStyle.font, bold: true }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE7E6E6' } } };
    const processedData = data.map(row => {
        const employeeType = row['المسمى الوظيفي'] === 'حارس بديل' ? 'بديل' : 'اساسي';
        return { ...row, "حالة الموظف": employeeType };
    });
    worksheet.columns = Object.keys(processedData[0]).map(key => ({
        header: key,
        key: key,
        width: 18,
        style: cellStyle
    }));
    worksheet.addRows(processedData);

    const nonMoneyColumns = ['ايام العمل', 'ساعات العمل', 'راحة', 'ايام الغياب'];

    worksheet.eachRow({ includeEmpty: false }, function(row, rowNumber) {
        row.height = 25;
        row.eachCell({ includeEmpty: true }, function(cell, colNumber) {
            if (rowNumber === 1) {
                cell.style = headerStyle;
                return;
            }

            const key = worksheet.getColumn(colNumber).key;
            if (key === 'اجمالي الراتب' || key === 'مجموع الاستقطاعات' || key === 'الصافي') {
                cell.style = totalStyle;
            }
            
            if (typeof cell.value === 'number' && !nonMoneyColumns.includes(key)) {
                cell.numFmt = moneyStyle.numFmt;
            }
        });
    });
    workbook.xlsx.writeBuffer().then(function(buffer) {
        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename.replace('.csv', '.xlsx');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
}
function renderAttendanceTable(container, records, coverageData, showActions) {
    if (!records || records.length === 0) {
        container.innerHTML = `<p style="text-align: center;">لا توجد سجلات لعرضها.</p>`;
        return;
    }

    records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    const actionHeader = showActions ? '<th>إجراء</th>' : '';
    let tableHtml = `
        <div class="table-container">
            <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>تاريخ السجل</th><th>الحارس</th><th>المشروع / الموقع</th><th>الوردية</th>
                        <th>الحضور</th><th>الانصراف</th><th>مدة الوردية</th><th>الحالة</th>
                        <th>ملاحظات</th>${actionHeader}
                    </tr>
                </thead>
                <tbody>`;

    records.forEach(record => {
        if (!record.users) return;
        const snapshot = record.shift_snapshot;
        const user = record.users;
        const projectDisplay = snapshot ? snapshot.project : (Array.isArray(user.project) ? user.project.join(', ') : (user.project || 'غير محدد'));
        const locationDisplay = snapshot ? snapshot.location : (user.location || 'غير محدد');
        const shiftDetails = snapshot ? snapshot.schedule_details[0] : user.job_vacancies?.schedule_details?.[0];

        let actionCell = showActions ? '<td>-</td>' : '';
        let notesHtml = record.notes || '-';
        let statusText = record.status;
        let statusClass = '';
        let rowClass = '';
        let durationHtml = '-';
        let checkinHtml = (record.isInferred && (record.status === 'غياب' || record.status === 'راحة')) ? '-' : formatGregorianDateTime(record.created_at);
        let checkoutHtml = record.checkout_at ? formatGregorianDateTime(record.checkout_at) : '-';
        let recordDateHtml = formatGregorianDate(record.created_at);
        
        const statusClasses = { 'حاضر': 'active', 'اكمل المناوبة': 'completed', 'غياب': 'inactive', 'انسحاب': 'inactive', 'استئذان': 'permission', 'راحة': 'off' };
        statusClass = statusClasses[record.status] || 'pending';

        if (record.isInferred) {
            if (record.status === 'غياب') notesHtml = 'غياب مستنتج';
            if (record.notes && record.notes.includes('أول يوم مباشرة')) notesHtml = `<span style="font-weight:bold; color:var(--approved-color);">${record.notes}</span>`;
            
            if (showActions && record.status !== 'راحة') {
                actionCell = `<td><button class="btn btn-primary btn-sm add-inferred-record-btn" data-guard-id="${record.guard_id}" data-guard-name="${user.name}" data-date="${new Date(record.created_at).toISOString().split('T')[0]}" title="إضافة سجل لهذا اليوم"><i class="ph-bold ph-plus-circle"></i> إضافة سجل</button></td>`;
            } else {
                 actionCell = showActions ? '<td>-</td>' : '';
            }
        } else {
            const checkinDate = new Date(record.created_at);
            const checkoutDate = record.checkout_at ? new Date(record.checkout_at) : null;
            let rowClass = '';
                statusText = record.status; // اعتمد على الحالة الحقيقية دائمًا
                if (record.status === 'اكمل المناوبة' && record.notes && record.notes.includes('انصراف تلقائي')) {
                    rowClass = 'auto-checkout-row';
                    statusText = 'انصراف تلقائي'; // غير النص فقط في هذه الحالة المحددة
                }

            const recordDateString = checkinDate.toISOString().split('T')[0];
            if (['غياب', 'انسحاب', 'استئذان'].includes(record.status) && coverageData.has(`${user.id}_${recordDateString}`)) {
                statusText = `${record.status} (تم تغطيته)`;
            }
            
            if (statusText.includes('(تم تغطيته)')) {
                statusClass = 'covered';
            }
            if (checkoutDate) {
                const diffMs = checkoutDate - checkinDate;
                const hours = Math.floor(diffMs / 3600000);
                const minutes = Math.floor((diffMs % 3600000) / 60000);
                durationHtml = `${hours} س و ${minutes} د`;
            }
            if (showActions) {
                actionCell = `<td><div style="display: flex; gap: 5px;"><button class="btn btn-secondary btn-sm att-mgmt-edit-btn" data-id="${record.id}" data-name="${user.name}" title="تعديل السجل"><i class="ph-bold ph-pencil-simple"></i></button><button class="btn btn-secondary btn-sm att-mgmt-edit-snapshot-btn" data-id="${record.id}" data-guard-id="${record.guard_id}" title="تعديل اللقطة"><i class="ph-bold ph-camera-rotate"></i></button><button class="btn btn-danger btn-sm att-mgmt-delete-btn" data-id="${record.id}" title="حذف السجل"><i class="ph-bold ph-trash"></i></button></div></td>`;
            }
        }
        
        if (record.status === 'راحة') {
            checkinHtml = '-'; checkoutHtml = '-'; durationHtml = '-';
        }
        
        const shiftTimeHtml = createShiftTimeLabel(shiftDetails);

        tableHtml += `<tr class="${rowClass}">
            <td>${recordDateHtml}</td><td>${user.name}</td><td>${projectDisplay} / ${locationDisplay}</td>
            <td>${shiftDetails ? `${shiftDetails.name || 'وردية'} ${shiftTimeHtml}` : 'غير محددة'}</td>
            <td>${checkinHtml}</td><td>${checkoutHtml}</td><td>${durationHtml}</td>
            <td><span class="status ${statusClass}">${statusText}</span></td><td>${notesHtml}</td>${actionCell}
        </tr>`;
    });

    tableHtml += '</tbody></table></div>';
    container.innerHTML = tableHtml;
}
async function loadAdminDashboardPage() {
    if (!document.getElementById('admin-audit-log-table-container')) {
        document.getElementById('admin-audit-log').innerHTML += '<div id="admin-audit-log-table-container"></div>';
        document.getElementById('admin-feedback').innerHTML += '<div id="admin-feedback-container"></div>';
        document.getElementById('admin-error-log').innerHTML += '<div id="admin-error-log-table-container"></div>';
    }
    loadAuditLogs();
    const adminPage = document.getElementById('page-admin-dashboard');
    adminPage.addEventListener('click', (event) => {
        event.preventDefault();
        if (pageRefreshInterval) {
            clearInterval(pageRefreshInterval);
            pageRefreshInterval = null;
        }
        const target = event.target;
        if (target.closest('#audit-search-btn')) {
            const filters = {
                searchTerm: document.getElementById('audit-search-input').value,
                actionType: document.getElementById('audit-action-filter').value,
                role: document.getElementById('audit-role-filter').value
            };
            loadAuditLogs(filters);
        }
        const tabLink = target.closest('.tab-link');
        if (tabLink) {
            adminPage.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            tabLink.classList.add('active');
            
            const targetTabId = tabLink.dataset.tab;
            adminPage.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(targetTabId)?.classList.add('active');

            if (targetTabId === 'admin-audit-log') loadAuditLogs();
            if (targetTabId === 'admin-feedback') loadFeedback();
            if (targetTabId === 'admin-error-log') loadErrorLogs();
            if (targetTabId === 'admin-archive') loadEmployeeArchive();
        }
        const updateFeedbackBtn = target.closest('.update-feedback-status');
        if(updateFeedbackBtn){
        }
    });// الدالة الكاملة والنهائية لتحميل وعرض بيانات لوحة التحكم
async function loadAdminDashboardPage() {
    loadAuditLogs();

    const adminPage = document.getElementById('page-admin-dashboard');
    if (!adminPage.dataset.listenerAttached) {
        adminPage.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.closest('#audit-search-btn')) {
                event.preventDefault();
                const filters = {
                    searchTerm: document.getElementById('audit-search-input').value,
                    actionType: document.getElementById('audit-action-filter').value,
                    role: document.getElementById('audit-role-filter').value
                };
                loadAuditLogs(filters);
            }
            const tabLink = target.closest('.tab-link');
            if (tabLink) {
                event.preventDefault();
                adminPage.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                tabLink.classList.add('active');
                
                const targetTabId = tabLink.dataset.tab;
                adminPage.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(targetTabId)?.classList.add('active');

                if (targetTabId === 'admin-audit-log') loadAuditLogs();
                if (targetTabId === 'admin-feedback') loadFeedback();
                if (targetTabId === 'admin-error-log') loadErrorLogs();
            }
            const updateFeedbackBtn = target.closest('.update-feedback-status');
            if (updateFeedbackBtn) {
                event.preventDefault();
                const feedbackId = updateFeedbackBtn.dataset.id;
                const newStatus = updateFeedbackBtn.dataset.status;

                if (confirm(`هل أنت متأكد من تغيير حالة الرسالة إلى "${newStatus}"؟`)) {
                    updateFeedbackBtn.disabled = true;
                    updateFeedbackBtn.textContent = 'جاري...';
                    
                    const { error } = await supabaseClient
                        .from('feedback')
                        .update({ status: newStatus })
                        .eq('id', feedbackId);

                    if (error) {
                        alert('حدث خطأ أثناء تحديث الحالة.');
                        console.error('Update feedback error:', error);
                    } else {
                        alert('تم تحديث الحالة بنجاح.');
                        loadFeedback(); // إعادة تحميل قائمة الشكاوى لتحديث الواجهة
                    }
                }
            }
        });
        adminPage.dataset.listenerAttached = 'true';
    }
}
}
async function loadAuditLogs(filters = {}) {
    const container = document.getElementById('admin-audit-log-table-container'); // حاوية الجدول الجديدة
    container.innerHTML = '<p style="text-align: center;">جاري تحميل سجل الأحداث...</p>';

    try {
        let query = supabaseClient
            .from('audit_logs')
            .select(`*, users:users!audit_logs_user_id_fkey(role)`) // جلب الدور من جدول المستخدمين
            .order('created_at', { ascending: false })
            .limit(100);
        if (filters.searchTerm) {
            query = query.or(`user_name.ilike.%${filters.searchTerm}%,details->>id_number.ilike.%${filters.searchTerm}%`);
        }
        if (filters.actionType) {
            query = query.eq('action_type', filters.actionType);
        }
        if (filters.role) {
            query = query.eq('users.role', filters.role);
        }

        const { data, error } = await query;
        if (error) throw error;
        if (data.length === 0) return container.innerHTML = '<p>لا توجد نتائج تطابق بحثك.</p>';

        container.innerHTML = `
            <div class="table-container"><table>
                <thead><tr><th>الوقت والتاريخ</th><th>اسم المستخدم</th><th>دوره</th><th>الإجراء</th><th>تفاصيل</th></tr></thead>
                <tbody>
                    ${data.map(log => `
                        <tr>
                            <td>${formatGregorianDateTime(log.created_at)}</td>
                            <td>${log.user_name || 'نظام'}</td>
                            <td>${log.users?.role || 'غير محدد'}</td>
                            <td><span class="status pending">${log.action_type}</span></td>
                            <td>${JSON.stringify(log.details)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table></div>`;
    } catch(err) {
        container.innerHTML = `<p style="color:red;">حدث خطأ: ${err.message}</p>`;
        console.error("Audit Log Error:", err);
    }
}
async function loadFeedback() {
    const container = document.getElementById('admin-feedback');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الشكاوى والاقتراحات...</p>';
    const { data, error } = await supabaseClient.from('feedback').select('*').order('created_at', { ascending: false });
    if (error) return container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    if (data.length === 0) return container.innerHTML = '<p>لا توجد رسائل جديدة.</p>';

    container.innerHTML = `<div class="all-requests-container">${data.map(fb => `
        <div class="review-request-card">
            <div class="review-request-header ${fb.status === 'تم الحل' ? 'status-approved' : 'status-pending'}">
                <h4>${fb.feedback_type} من: ${fb.user_name || 'زائر'}</h4>
                <span class="status-badge">${fb.status}</span>
            </div>
            <div class="review-request-body"><p>${fb.content}</p></div>
            ${fb.status === 'جديدة' ? `
            <div class="review-request-footer">
                <button class="btn btn-primary btn-sm update-feedback-status" data-id="${fb.id}" data-status="تم الحل">
                    <i class="ph-bold ph-check-circle"></i> تحديد كـ "تم الحل"
                </button>
            </div>` : ''}
        </div>
    `).join('')}</div>`;
}
async function loadErrorLogs() {
    const container = document.getElementById('admin-error-log');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل سجل الأخطاء...</p>';
    const { data, error } = await supabaseClient.from('error_logs').select('*').order('created_at', { ascending: false }).limit(100);
    if (error) return container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    if (data.length === 0) return container.innerHTML = '<p>لا توجد أخطاء مسجلة. هذا شيء جيد!</p>';
    
    container.innerHTML = `
        <div class="table-container"><table>
            <thead><tr><th>وقت الخطأ</th><th>المستخدم</th><th>رسالة الخطأ</th></tr></thead>
            <tbody>
                ${data.map(log => `
                    <tr style="color: var(--denied-color);">
                        <td>${formatGregorianDateTime(log.created_at)}</td>
                        <td>${log.user_name || 'غير معروف'}</td>
                        <td>${log.error_message}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table></div>`;
}
async function loadSupervisorPatrolPage() {
    const page = document.getElementById('page-patrol');
    if (!page) return;

    const statusText = page.querySelector('#patrol-status');
    const startBtn = page.querySelector('#start-patrol-btn');
    const endBtn = page.querySelector('#end-patrol-btn');

    statusText.innerHTML = '<p>جاري التحقق من حالة الجولة...</p>';
    startBtn.classList.add('hidden');
    endBtn.classList.add('hidden');
    const { data, error } = await supabaseClient
        .from('patrols')
        .select('id, start_time')
        .eq('supervisor_id', currentUser.id)
        .eq('status', 'active')
        .limit(1);

    if (error) {
        statusText.innerHTML = '<p>حدث خطأ أثناء التحقق من حالتك.</p>';
        return console.error(error);
    }

    const activePatrol = data && data.length > 0 ? data[0] : null;

    if (activePatrol) {
        const startTime = new Date(activePatrol.start_time).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
        statusText.innerHTML = `<p>أنت حالياً في جولة ميدانية بدأت الساعة <strong>${startTime}</strong>.</p>`;
        endBtn.dataset.patrolId = activePatrol.id;
        endBtn.classList.remove('hidden');
        startPatrolTracking(activePatrol.id);
    } else {
        statusText.innerHTML = `<p>أنت لست في جولة حالياً. اضغط على "بدء الجولة" لتسجيل جولة جديدة.</p>`;
        startBtn.classList.remove('hidden');
    }
}
async function loadVacanciesPage() {
    const listContainer = document.getElementById('vacancies-list-container');
    listContainer.innerHTML = '<p style="text-align: center;">جاري حساب الإحصائيات وتحميل الشواغر...</p>';
    let totalRequired = 0;
    const { data: contracts } = await supabaseClient.from('contracts').select('locations_and_guards').eq('status', 'active');
    if (contracts) {
        contracts.forEach(contract => {
            if (contract.locations_and_guards) {
                contract.locations_and_guards.forEach(location => {
                    if(location.shifts) {
                        location.shifts.forEach(shift => {
                            totalRequired += parseInt(shift.guards_count) || 0;
                        });
                    }
                });
            }
        });
    }

    const { count: assignedEmployees } = await supabaseClient.from('users').select('*', { count: 'exact', head: true }).not('contract_id', 'is', null);

    document.getElementById('hr-stats-required').textContent = totalRequired;
    document.getElementById('hr-stats-assigned').textContent = assignedEmployees || 0;
    document.getElementById('hr-stats-gap').textContent = totalRequired - (assignedEmployees || 0);
    const { data: vacancies, error } = await supabaseClient.from('job_vacancies').select('*, contracts(company_name)');

    if (error) {
        console.error('Error fetching vacancies:', error);
        listContainer.innerHTML = '<p class="text-center text-red-500">حدث خطأ في تحميل الشواغر.</p>';
        return;
    }

    if (vacancies.length === 0) {
        listContainer.innerHTML = '<p style="text-align: center;">لا توجد شواغر مضافة حالياً.</p>';
        return;
    }

    listContainer.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>المسمى الوظيفي</th>
                    <th>المشروع</th>
                    <th>تابع لعقد</th>
                    <th>الحالة</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody>
                ${vacancies.map(vacancy => `
                    <tr>
                        <td>${vacancy.title}</td>
                        <td>${vacancy.project || 'غير محدد'}</td>
                        <td>${vacancy.contracts ? vacancy.contracts.company_name : 'غير تابع لعقد'}</td>
                        <td><span class="status ${vacancy.status === 'open' ? 'active' : 'inactive'}">${vacancy.status === 'open' ? 'مفتوح' : 'مغلق'}</span></td>
                        <td>
                            <button class="btn-action edit-vacancy-btn" data-id="${vacancy.id}"><i class="ph-bold ph-pencil-simple"></i></button>
                            <button class="btn-action delete-vacancy-btn" data-id="${vacancy.id}"><i class="ph-bold ph-trash"></i></button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

/**
 * دالة لإنشاء كود HTML لفترة عمل واحدة (بداية ونهاية)
 * @param {object} period - كائن يحتوي على start_time و end_time
 * @param {number} index - ترتيب الفترة (0 للفترة الأولى)
 * @returns {string} - كود HTML
 */
function createPeriodHtml(period = {}, index = 0) {
    return `
    <div class="shift-period-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <div class="form-group" style="flex: 1; margin-bottom: 0;"><label>من:</label><input type="time" class="shift-time-input shift-start-time" value="${period.start_time || ''}"></div>
        <div class="form-group" style="flex: 1; margin-bottom: 0;"><label>إلى:</label><input type="time" class="shift-time-input shift-end-time" value="${period.end_time || ''}"></div>
        ${index > 0 ? '<button type="button" class="delete-btn delete-period-btn" title="حذف الفترة"><i class="ph-bold ph-x"></i></button>' : '<div style="width: 34px; height: 34px;"></div>' /* عنصر فارغ للحفاظ على المحاذاة */}
    </div>
    `;
}

/**
 * دالة لإنشاء كود HTML لوردية عمل كاملة (مع فتراتها)
 * @param {object} shift - كائن يحتوي على تفاصيل الوردية
 * @returns {string} - كود HTML
 */
function createShiftGroupHtml(shift = {}) {
    const name = shift.name || '';
    const guardsCount = shift.guards_count || 1;
    const workHours = shift.work_hours || 0;
    const days = shift.days || [];
    const periods = (shift.periods && shift.periods.length > 0) ? shift.periods : [{ start_time: '', end_time: '' }];

    const guardPrice = shift.guard_price || 0;

    const dayNames = {Sat: 'السبت', Sun: 'الأحد', Mon: 'الاثنين', Tue: 'الثلاثاء', Wed: 'الأربعاء', Thu: 'الخميس', Fri: 'الجمعة'};
    const daysHtml = Object.keys(dayNames).map(dayKey => {
        const isChecked = days.includes(dayKey) ? 'checked' : '';
        return `<label><input type="checkbox" value="${dayKey}" class="shift-day-checkbox" ${isChecked}>${dayNames[dayKey]}</label>`;
    }).join('');

    const periodsHtml = periods.map((period, index) => createPeriodHtml(period, index)).join('');
    let overridesHtml = '';
    if (shift.day_overrides) {
        for (const dayKey in shift.day_overrides) {
            const overrideData = shift.day_overrides[dayKey];
            overridesHtml += createDayOverrideHtml({ day: dayKey, periods: overrideData.periods });
        }
    }

    return `
        <div class="shift-entry-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="form-group" style="flex-grow: 1; margin: 0;">
                    <label>مسمى الوردية</label>
                    <input type="text" class="shift-name" value="${name}" placeholder="مثال: وردية A">
                </div>
                <button type="button" class="delete-btn delete-shift-btn" title="حذف الوردية بالكامل"><i class="ph-bold ph-trash"></i></button>
            </div>

            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="form-group">
                    <label>عدد الحراس</label>
                    <input type="number" class="shift-guards-count" value="${guardsCount}" min="1">
                </div>
                <div class="form-group">
                    <label>إجمالي ساعات العمل</label>
                    <input type="number" class="shift-work-hours" value="${parseFloat(workHours).toFixed(2)}" readonly style="background-color: #e9ecef; text-align: center;">
                </div>
                <div class="form-group">
                    <label>سعر الحارس</label>
                    <input type="number" class="shift-guard-price" value="${guardPrice}" min="0">
                </div>
            </div>

            <div class="shift-section-container">
                <h5>الأوقات الافتراضية للوردية</h5>
                <div class="shift-periods-container default-periods">${periodsHtml}</div>
                <button type="button" class="btn btn-secondary btn-sm add-period-btn" style="margin-top: 5px;"><i class="ph-bold ph-plus"></i> إضافة فترة أخرى</button>
            </div>

            <div class="shift-section-container">
                <h5>أيام العمل الافتراضية</h5>
                <div class="days-selector">${daysHtml}</div>
            </div>

            <div class="shift-section-container">
                <div class="exceptions-header">
                    <h5>استثناءات الأيام (أوقات مختلفة لأيام معينة)</h5>
                    <button type="button" class="btn btn-secondary add-day-override-btn">
                        <i class="ph-bold ph-plus-circle"></i> إضافة استثناء
                    </button>
                </div>
                <div class="day-overrides-container">${overridesHtml}</div>
            </div>
        </div>
    `;
}
function createDayOverrideHtml(override = { day: '', periods: [{ start_time: '', end_time: '' }] }) {
    const dayNames = {Sat: 'السبت', Sun: 'الأحد', Mon: 'الاثنين', Tue: 'الثلاثاء', Wed: 'الأربعاء', Thu: 'الخميس', Fri: 'الجمعة'};
    const dayOptions = Object.keys(dayNames).map(dayKey => 
        `<option value="${dayKey}" ${override.day === dayKey ? 'selected' : ''}>${dayNames[dayKey]}</option>`
    ).join('');
    const periodsHtml = override.periods.map((period, index) => createPeriodHtml(period, index)).join('');

    return `
        <div class="day-override-card">
            <div class="day-override-header">
                <div class="form-group">
                    <label>اليوم المحدد للاستثناء</label>
                    <select class="override-day-select">
                        <option value="">-- اختر اليوم --</option>
                        ${dayOptions}
                    </select>
                </div>
                <button type="button" class="delete-btn delete-override-btn" title="حذف هذا الاستثناء"><i class="ph-bold ph-x-circle"></i></button>
            </div>
            <div class="shift-periods-container override-periods">
                ${periodsHtml}
            </div>
             <button type="button" class="btn btn-secondary btn-sm add-period-btn" style="margin-top: 5px;"><i class="ph-bold ph-plus"></i> إضافة فترة أخرى لهذا اليوم</button>
        </div>
    `;
}


/**
 * دالة لإنشاء كود HTML لموقع كامل (مع وردياته)
 * @param {object} location - كائن يحتوي على تفاصيل الموقع
 * @returns {string} - كود HTML
 */
function createLocationGroupHtml(location = {}) {
    const locationName = location.name || '';
    const shifts = location.shifts && location.shifts.length > 0 ? location.shifts : [{}];
    const shiftsHtml = shifts.map(shift => createShiftGroupHtml(shift)).join('');

    const selectedRegion = location.region || '';
    const regions = ['الوسطى', 'الشمالية', 'الغربية', 'الجنوبية', 'الشرقية'];
    const regionOptions = regions.map(r => `<option value="${r}" ${r === selectedRegion ? 'selected' : ''}>${r}</option>`).join('');

    return `
        <div class="location-entry-card">
            <div class="location-header">
                <div class="form-group" style="flex-grow:1; margin:0;">
                     <label>اسم الموقع (الفرع)</label>
                     <input type="text" class="location-name-input" value="${locationName}" placeholder="مثال: فرع غرناطة">
                </div>
                <button type="button" class="delete-btn delete-location-card-btn"><i class="ph-bold ph-trash"></i></button>
            </div>

            <div class="form-grid" style="grid-template-columns: 1fr 1fr; align-items: end; margin-top: 15px;">
                <div class="form-group">
                    <label>المنطقة</label>
                    <select class="location-region-select">${regionOptions}</select>
                </div>
                <div class="form-group">
                    <label>المدينة</label>
                    <input type="text" class="location-city-input" placeholder="مثال: الرياض" value="${location.city || ''}">
                </div>
            </div>

            <div class="form-grid" style="grid-template-columns: 3fr 1fr; align-items: end; margin-top: 15px;">
                <div class="form-group">
                <label>الإحداثيات</label>
                <input type="text" class="location-geofence-link" placeholder="مثال: 24.7136, 46.6753" value="${location.geofence_link || ''}">
                <small class="coords-address-preview" style="display: block; margin-top: 5px; color: var(--text-secondary); font-size: 0.85rem; min-height: 20px;"></small>
            </div>
                <div class="form-group">
                    <label>نطاق التواجد (متر)</label>
                    <input type="number" class="location-geofence-radius" value="${location.geofence_radius || 200}">
                </div>
            </div>

            <h5 style="margin-top: 20px; margin-bottom: 15px; border-top: 1px solid var(--border-color); padding-top: 20px;">تفاصيل إضافية للموقع</h5>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>عدد الدوريات</label>
                    <input type="number" class="location-patrols-count" value="${location.patrols_count || 0}" min="0">
                </div>
                <div class="form-group">
                    <label>عدد المرافق السكنية</label>
                    <input type="number" class="location-facilities-count" value="${location.facilities_count || 0}" min="0">
                </div>
                <div class="form-group">
                    <label>عدد أجهزة البرافو</label>
                    <input type="number" class="location-devices-count" value="${location.devices_count || 0}" min="0">
                </div>
                <div class="form-group">
                    <label>سعر الدورية</label>
                    <input type="number" class="location-patrols-price" value="${location.patrols_price || 0}" min="0">
                </div>
                <div class="form-group">
                    <label>سعر المرفق</label>
                    <input type="number" class="location-facilities-price" value="${location.facilities_price || 0}" min="0">
                </div>
                <div class="form-group">
                    <label>سعر الجهاز</label>
                    <input type="number" class="location-devices-price" value="${location.devices_price || 0}" min="0">
                </div>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>الشروط والالتزامات الخاصة بالموقع</label>
                <textarea class="location-terms" rows="4" placeholder="اكتب هنا أي شروط أو التزامات خاصة بهذا الموقع...">${location.terms || ''}</textarea>
            </div>

            <div class="shifts-container-for-location">${shiftsHtml}</div>
            <button class="btn btn-secondary add-shift-to-card-btn" style="width: 100%; margin-top: 15px;">
                <i class="ph-bold ph-plus-circle"></i> إضافة وردية أخرى لهذا الموقع
            </button>
        </div>
    `;
}
/**
 * دالة لإنشاء كود HTML الخاص بالنجوم
 * @param {number} rating - التقييم من 1 إلى 5
 * @returns {string} - كود HTML للنجوم
 */
function renderStars(rating) {
    let starsHtml = '';
    const currentRating = rating || 0; // إذا لم يكن هناك تقييم، اعتبره صفر
    for (let i = 1; i <= 5; i++) {
        if (i <= currentRating) {
            starsHtml += `<i class="ph-fill ph-star" style="color: #f59e0b;"></i>`;
        } else {
            starsHtml += `<i class="ph-bold ph-star" style="color: #cbd5e1;"></i>`;
        }
    }
    return starsHtml;
}

async function loadMyProfilePage() {
    const infoContainer = document.getElementById('guard-info-container');
    infoContainer.classList.add('hidden');
    if (currentUser.role === 'حارس أمن' && currentUser.employment_status !== 'تغطية') {
        try {
            const { data: userData, error } = await supabaseClient
                .from('users')
                .select('*, job_vacancies!users_vacancy_id_fkey(*)')
                .eq('id', currentUser.id)
                .single();

            if (error) throw error;
            const vacancy = userData.job_vacancies;
            let totalSalary = 0;
            if (vacancy) {
                totalSalary = (vacancy.base_salary || 0) + (vacancy.housing_allowance || 0) + (vacancy.transport_allowance || 0) + (vacancy.other_allowances || 0);
            }
            document.getElementById('profile-name').textContent = userData.name || 'غير متوفر';
            document.getElementById('profile-id-number').textContent = userData.id_number || 'غير متوفر';
            document.getElementById('profile-total-salary').textContent = totalSalary > 0 ? `${totalSalary.toLocaleString('ar-SA')} ر.س` : 'غير محدد';
            document.getElementById('profile-bank-name').textContent = userData.bank_name || 'غير متوفر';
            document.getElementById('profile-iban').textContent = userData.iban || 'غير متوفر';
            document.getElementById('profile-project').textContent = Array.isArray(userData.project) ? userData.project.join(', ') : (userData.project || 'غير محدد');
            document.getElementById('profile-location').textContent = userData.location || 'غير محدد';
            infoContainer.classList.remove('hidden');

        } catch (err) {
            console.error("Error fetching guard profile data:", err);
            infoContainer.innerHTML = '<p style="text-align:center; color:red; padding: 20px;">حدث خطأ في تحميل البيانات الوظيفية.</p>';
            infoContainer.classList.remove('hidden');
        }
    }
}
async function loadPermissionRequests() {
    const container = document.getElementById('permission-requests-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات...</p>';

    try {
        const userRegion = (currentUser.role === 'ادارة العمليات' && !currentUser.is_ops_manager && currentUser.region) ? currentUser.region : null;
        const { data: requests, error } = await supabaseClient.rpc('get_ops_pending_permission_requests', {
            p_region: userRegion
        });

        if (error) throw error;
        const userIds = requests.map(r => r.user_id);
        if (userIds.length > 0) {
            const { data: usersData, error: usersError } = await supabaseClient
                .from('users')
                .select('id, name')
                .in('id', userIds);
            if (usersError) throw usersError;

            const requestsWithUsers = requests.map(req => ({
                ...req,
                user: usersData.find(u => u.id === req.user_id)
            }));

            renderRequests(requestsWithUsers, 'permission-requests-container', 'استئذان', 'ops_final_approval');
        } else {
            renderRequests([], 'permission-requests-container', 'استئذان', 'ops_final_approval');
        }
        if (activeSubscription) supabaseClient.removeChannel(activeSubscription);
        activeSubscription = supabaseClient
            .channel('public:employee_requests:permissions')
            .on(
                'postgres_changes',
                { 
                    event: '*', 
                    schema: 'public', 
                    table: 'employee_requests',
                    filter: 'request_type=eq.permission'
                },
                (payload) => {
                    console.log('Realtime update for permission requests!', payload);
                    loadPermissionRequests();
                    loadSupervisorPermissionRequestsPage(); // (تحديث صفحة المشرف أيضاً)
                }
            )
            .subscribe();

        console.log('Subscribed to real-time permission requests.');

    } catch (error) {
        console.error('خطأ في جلب طلبات الاستئذان:', error);
        container.innerHTML = '<p style="color:red;">حدث خطأ.</p>';
    }
}

async function showRecipientInfo(userId) {
    const modal = document.getElementById('recipient-info-modal');
    const container = document.getElementById('recipient-info-container');
    modal.classList.remove('hidden');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل البيانات...</p>';

    try {
        const { data: user, error } = await supabaseClient
            .from('users')
            .select('name, id_number, phone, start_of_work_date, role')
            .eq('id', userId)
            .single();

        if (error) throw error;

        container.innerHTML = `
            <p><strong>الاسم الكامل:</strong> ${user.name || '-'}</p>
            <p><strong>رقم الهوية:</strong> ${user.id_number || '-'}</p>
            <p><strong>رقم الجوال:</strong> ${user.phone || '-'}</p>
            <p><strong>المسمى الوظيفي:</strong> ${user.role || '-'}</p>
            <p><strong>تاريخ المباشرة:</strong> ${formatGregorianDate(user.start_of_work_date)}</p>
        `;
    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
}
async function loadEmployeeDataIssuesReport() {
    const modal = document.getElementById('employee-data-check-modal');
    const body = document.getElementById('employee-data-check-body');
    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري فحص بيانات الموظفين...</p>';

    try {
        const { data: issues, error } = await supabaseClient.rpc('get_employees_with_data_issues');
        if (error) throw error;

        if (issues.length === 0) {
            body.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--success-color);"><strong>ممتاز!</strong> لا توجد أي مشاكل في بيانات تسكين الموظفين.</p>';
            return;
        }

        body.innerHTML = `
            <p>تم العثور على ${issues.length} موظف لديهم عدم تطابق في بيانات التسكين. يوصى بمعالجتها.</p>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>اسم الموظف</th>
                            <th>المشكلة المكتشفة</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${issues.map(i => `
                            <tr>
                                <td>${i.user_name}</td>
                                <td style="color: var(--denied-color);">${i.problem_description}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm handle-employee-data-fix-btn" data-user-id="${i.user_id}" data-vacancy-id="${i.vacancy_id}">
                                        <i class="ph-bold ph-magic-wand"></i> معالجة تلقائية
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
    } catch (err) {
        body.innerHTML = `<p style="color:red; text-align:center;">حدث خطأ: ${err.message}</p>`;
    }
}

async function handleEmployeeDataFix(userId, vacancyId) {
    if (!userId || !vacancyId) return alert('خطأ: بيانات الموظف أو الشاغر غير مكتملة.');

    try {
        const { data: vacancyData, error: vacancyError } = await supabaseClient
            .from('job_vacancies').select('region, location, project, specific_location').eq('id', vacancyId).single();
        if (vacancyError || !vacancyData) throw new Error('لم يتم العثور على بيانات الشاغر المرتبط.');

        const updatePayload = {
            region: vacancyData.region,
            city: vacancyData.location,
            project: [vacancyData.project], // تأكد من أنه مصفوفة
            location: vacancyData.specific_location
        };

        const { error: userUpdateError } = await supabaseClient.from('users').update(updatePayload).eq('id', userId);
        if (userUpdateError) throw userUpdateError;

        showToast('تمت معالجة بيانات الموظف بنجاح!', 'success');
        await loadEmployeeDataIssuesReport(); // إعادة تحميل التقرير
        await loadEmployeeTabData(); // تحديث القائمة الرئيسية

    } catch(error) {
        alert(`فشلت المعالجة: ${error.message}`);
    }
}



/**
 * تملأ القائمة المنسدلة للأدوار الوظيفية بناءً on نوع الموظفين
 * @param {string} staffType - 'field' للحراس والمشرفين, 'admin' للإداريين
 */
function populateRoleDropdown(staffType) {
    const roleSelect = document.getElementById('employee-role');
    if (!roleSelect) return;

    let optionsHtml = '';
    if (staffType === 'field') {
        optionsHtml = `
            <option value="حارس أمن">حارس أمن</option>
            <option value="مشرف">مشرف</option>
        `;
    } else if (staffType === 'admin') {
        optionsHtml = `
            <option value="ادارة العمليات">ادارة العمليات</option>
            <option value="ادارة الموارد البشرية">ادارة الموارد البشرية</option>
            <option value="ادارة العقود">ادارة العقود</option>
            <option value="المالية">المالية</option>
            <option value="التسويق">التسويق</option>
            <option value="الشؤون القانونية">الشؤون القانونية</option>
            <option value="ادارة العهد">ادارة العهد</option>
            <option value="مدير النظام">مدير النظام</option>
        `;
    }

    roleSelect.innerHTML = optionsHtml;
}

function toggleManagerialFields(role) {
    const placementSection = document.getElementById('job-placement-section');
    const statusGroup = document.getElementById('employee-status-group');
    const uniformGroup = document.getElementById('employee-uniform-group');
    const assignmentGroup = document.getElementById('manager-assignment-group');
    const contractSelect = document.getElementById('employee-contract');
    const vacancySelect = document.getElementById('employee-vacancy');

    if (!placementSection || !statusGroup || !uniformGroup || !assignmentGroup) {
        console.error("أحد العناصر المطلوبة للفلترة غير موجود في الصفحة.");
        return;
    }

    const isGuardRole = (role === 'حارس أمن');
    const isSupervisorOrOps = (role === 'مشرف' || role === 'ادارة العمليات');
    const isAdminStaff = (role !== 'حارس أمن' && role !== 'مشرف');

    const adminFieldsSection = document.getElementById('admin-employee-fields');
    if (adminFieldsSection) {
        adminFieldsSection.classList.toggle('hidden', !isAdminStaff);
    }
    placementSection.style.display = isGuardRole ? 'block' : 'none';
    statusGroup.style.display = isGuardRole ? 'block' : 'none';
    uniformGroup.style.display = isGuardRole ? 'block' : 'none';
    if (isSupervisorOrOps) {
        assignmentGroup.classList.remove('hidden'); // إزالة كلاس الإخفاء القوي
    } else {
        assignmentGroup.classList.add('hidden'); // إعادة كلاس الإخفاء القوي
    }
    contractSelect.required = isGuardRole;
    vacancySelect.required = isGuardRole;
    if (isSupervisorOrOps) {
        const sitesBtnGroup = document.getElementById('assign-sites-btn-group');
        const regionGroup = document.getElementById('assign-region-group');
        const gridContainer = document.getElementById('managerial-fields-grid');

        if (role === 'مشرف') {
            sitesBtnGroup.style.display = 'block';
            regionGroup.style.gridColumn = 'auto';
            gridContainer.style.gridTemplateColumns = '1fr 1fr';
        } else { // ادارة العمليات
            sitesBtnGroup.style.display = 'none';
            regionGroup.style.gridColumn = '1 / -1';
            gridContainer.style.gridTemplateColumns = '1fr';
        }
    }
}
async function populateSiteAssignmentModal(employeeData) {
    const treeContainer = document.getElementById('assignment-tree-container');
    const regionFilter = document.getElementById('assignment-filter-region');
    
    treeContainer.innerHTML = '<p style="text-align: center;">جاري جلب المواقع وحساب المشرفين...</p>';
    regionFilter.innerHTML = '<option value="">جاري التحميل...</option>';
    document.getElementById('assignment-filter-city').innerHTML = '<option value="">اختر منطقة أولاً</option>';
    document.getElementById('assignment-filter-city').disabled = true;
    document.getElementById('assignment-search-input').value = '';
    const { data: sitesWithCounts, error } = await supabaseClient.rpc('get_sites_with_supervisor_counts');

    if (error) {
        treeContainer.innerHTML = '<p style="color:red;">فشل جلب المواقع.</p>';
        console.error("Error fetching sites with counts:", error);
        return;
    }
    const contractsMap = new Map();
    sitesWithCounts.forEach(site => {
        if (!contractsMap.has(site.contract_name)) {
            contractsMap.set(site.contract_name, {
                id: site.contract_id,
                company_name: site.contract_name,
                contract_locations: []
            });
        }
        contractsMap.get(site.contract_name).contract_locations.push({
            name: site.site_name,
            region: site.region,
            city: site.city,
            supervisor_count: site.supervisor_count // إضافة العدد هنا
        });
    });

    window.allContractsForAssignment = Array.from(contractsMap.values()).sort((a,b) => a.company_name.localeCompare(b.company_name));
    currentAssignedLocations = employeeData.assigned_locations || [];

    const allRegions = new Set(sitesWithCounts.map(s => s.region));
    regionFilter.innerHTML = '<option value="">كل المناطق</option>';
    [...allRegions].sort().forEach(region => {
        regionFilter.innerHTML += `<option value="${region}">${region}</option>`;
    });

    renderAssignmentTree();
}
function renderAssignmentTree(filters = {}) {
    const treeContainer = document.getElementById('assignment-tree-container');
    treeContainer.innerHTML = '';
    const lowerSearchTerm = (filters.search || '').toLowerCase();

    let contractsToRender = JSON.parse(JSON.stringify(window.allContractsForAssignment));

    if (filters.region) {
        contractsToRender = contractsToRender.map(c => ({...c, contract_locations: c.contract_locations.filter(l => l.region === filters.region)})).filter(c => c.contract_locations.length > 0);
    }
    if (filters.city) {
        contractsToRender = contractsToRender.map(c => ({...c, contract_locations: c.contract_locations.filter(l => l.city === filters.city)})).filter(c => c.contract_locations.length > 0);
    }
    if (lowerSearchTerm) {
        contractsToRender = contractsToRender.map(contract => {
            const matchingLocations = contract.contract_locations.filter(loc => loc.name.toLowerCase().includes(lowerSearchTerm));
            if (matchingLocations.length > 0) return { ...contract, contract_locations: matchingLocations };
            if (contract.company_name.toLowerCase().includes(lowerSearchTerm)) return contract;
            return null;
        }).filter(Boolean);
    }

    if (contractsToRender.length === 0) {
        treeContainer.innerHTML = '<div class="empty-state"><h4>لا توجد نتائج</h4><p>لم يتم العثور على مواقع تطابق شروط الفلترة.</p></div>';
        return;
    }

    contractsToRender.forEach(contract => {
        const sitesInContract = contract.contract_locations;
        const assignedSitesInContract = currentAssignedLocations.filter(loc => loc.contract === contract.company_name);
        let masterCheckboxState = '';
        if (assignedSitesInContract.length === 0) { masterCheckboxState = ''; }
        else if (assignedSitesInContract.length === sitesInContract.length) { masterCheckboxState = 'checked'; }
        else { masterCheckboxState = 'indeterminate'; }

        const contractGroup = document.createElement('div');
        contractGroup.className = 'assignment-contract-group';
        contractGroup.innerHTML = `
            <div class="assignment-contract-header ${masterCheckboxState === 'checked' ? 'all-selected' : ''}">
                <input type="checkbox" class="master-checkbox" data-contract-name="${contract.company_name}">
                <h5>${contract.company_name}</h5>
            </div>
            <div class="assignment-sites-list">
                ${sitesInContract.map(loc => `
                    <label class="assignment-site-item">
                        <input type="checkbox" class="site-checkbox" 
                               data-location='${JSON.stringify({ contract: contract.company_name, site: loc.name, region: loc.region, city: loc.city })}'
                               ${currentAssignedLocations.some(assigned => assigned.site === loc.name && assigned.contract === contract.company_name) ? 'checked' : ''}>
                        <span class="site-name">${loc.name}</span>
                        <span class="site-supervisor-count">(${loc.supervisor_count || 0})</span>
                    </label>
                `).join('')}
            </div>
        `;
        const masterCheckbox = contractGroup.querySelector('.master-checkbox');
        if (masterCheckboxState === 'indeterminate') { masterCheckbox.indeterminate = true; }
        else { masterCheckbox.checked = (masterCheckboxState === 'checked'); }
        treeContainer.appendChild(contractGroup);
    });
}
async function fetchUsers() {
    const { data: users, error } = await supabaseClient
        .from('users')
        .select('name, role, last_login, status');

    if (error) {
        console.error('خطأ في جلب المستخدمين:', error);
        return;
    }
    const tableBody = document.querySelector('#page-users tbody');
    tableBody.innerHTML = ''; 
    if (users.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا يوجد مستخدمين لعرضهم حالياً.</td></tr>';
        return;
    }
    users.forEach(user => {
        const lastLogin = user.last_login 
            ? new Date(user.last_login).toLocaleString('ar-SA', { dateStyle: 'medium', timeStyle: 'short' }) 
            : 'لم يسجل الدخول';

        const row = `
            <tr>
                <td>${user.name || 'غير متوفر'}</td>
                <td>${user.role || 'غير محدد'}</td>
                <td>${lastLogin}</td>
                <td>
                    <span class="status ${user.status === 'active' ? 'active' : 'inactive'}">
                        ${user.status === 'active' ? 'نشط' : 'غير نشط'}
                    </span>
                </td>
                <td>
                    <button class="btn-action edit"><i class="ph-bold ph-pencil-simple"></i></button>
                    <button class="btn-action delete"><i class="ph-bold ph-trash"></i></button>
                </td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
    });
}
async function loadCompletedCoveragesForApproval() {
    const container = document.getElementById('coverage-approval-list');
    if (!container || !currentUser) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل التغطيات المكتملة...</p>';

    let query = supabaseClient
        .from('coverage_shifts')
        .select(`*, coverage_applicants!inner(full_name), coverage_payments!inner(id)`)
        .eq('status', 'completed_pending_ops_approval');

    if (currentUser.role === 'ادارة العمليات') query = query.eq('region', currentUser.region);

    const { data: shifts, error } = await query;
    if (error) { container.innerHTML = '<p style="color:red">خطأ في جلب البيانات.</p>'; return console.error(error); }
    if (shifts.length === 0) { container.innerHTML = '<p>لا توجد تغطيات مكتملة بانتظار الاعتماد حالياً.</p>'; return; }

    container.innerHTML = shifts.map(shift => `
        <div class="review-request-card">
            <div class="review-request-header status-pending">
                <h4>اعتماد تغطية مكتملة</h4>
            </div>
            <div class="review-request-body">
                <p><strong>الحارس:</strong> ${shift.coverage_applicants[0].full_name}</p>
                <p><strong>المشروع:</strong> ${shift.project} - ${shift.location}</p>
                <p><strong>قيمة التغطية:</strong> ${shift.coverage_pay} ر.س</p>
            </div>
            <div class="review-request-footer">
                <button class="btn btn-success ops-approve-completed-coverage-btn" data-payment-id="${shift.coverage_payments[0].id}">
                    <i class="ph-bold ph-check-circle"></i> اعتماد وإرسال للمالية
                </button>
            </div>
        </div>
    `).join('');
}
async function fetchContracts() {
    const listContainer = document.querySelector('#contracts-list-container');
    if (!listContainer) return;
    listContainer.innerHTML = '<p style="text-align: center;">جاري تحميل العقود...</p>';

    try {
        const searchVal = document.getElementById('contract-filter-search').value;

        let query = supabaseClient
            .from('contracts')
            .select('*')
            .order('created_at', { ascending: false });

        if (searchVal) query = query.ilike('company_name', `%${searchVal}%`);

        const { data: contracts, error } = await query;
        if (error) throw error;

        if (contracts.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center;">لا توجد عقود تطابق شروط الفلترة.</p>';
            return;
        }

        const contractsHtml = contracts.map(contract => {
            let totalGuards = 0, totalGuardsPrice = 0, totalPatrolsPrice = 0, totalFacilitiesPrice = 0, totalDevicesPrice = 0;
            let totalPatrolsCount = 0, totalFacilitiesCount = 0, totalDevicesCount = 0;

            if (contract.contract_locations && Array.isArray(contract.contract_locations)) {
                contract.contract_locations.forEach(location => {
                    totalPatrolsCount += location.patrols_count || 0;
                    totalPatrolsPrice += (location.patrols_count || 0) * (location.patrols_price || 0);
                    totalFacilitiesCount += location.facilities_count || 0;
                    totalFacilitiesPrice += (location.facilities_count || 0) * (location.facilities_price || 0);
                    totalDevicesCount += location.devices_count || 0;
                    totalDevicesPrice += (location.devices_count || 0) * (location.devices_price || 0);

                    if (location.shifts && Array.isArray(location.shifts)) {
                        location.shifts.forEach(shift => {
                            const guardsInShift = shift.guards_count || 0;
                            totalGuards += guardsInShift;
                            totalGuardsPrice += (shift.guard_price || 0) * guardsInShift;
                        });
                    }
                });
            }

            const subTotal = totalGuardsPrice + totalPatrolsPrice + totalFacilitiesPrice + totalDevicesPrice;
            const commission = subTotal * ((contract.commission_percentage || 0) / 100);
            const finalTotal = subTotal + commission;

            let remainingDaysHtml = '';
            if (contract.end_date) {
                const endDate = new Date(contract.end_date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);
                const diffTime = endDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays < 0) {
                    remainingDaysHtml = `<div class="info-line" style="color: #ef4444;"><i class="ph-bold ph-warning-circle"></i><strong>الحالة:</strong> العقد منتهي</div>`;
                } else if (diffDays === 0) {
                    remainingDaysHtml = `<div class="info-line" style="color: #f59e0b;"><i class="ph-bold ph-hourglass-high"></i><strong>الحالة:</strong> ينتهي اليوم</div>`;
                } else {
                    remainingDaysHtml = `<div class="info-line"><i class="ph-bold ph-timer"></i><strong>المتبقي:</strong> ${diffDays} يوم</div>`;
                }
            } else {
                remainingDaysHtml = `<div class="info-line"><i class="ph-bold ph-calendar-x"></i><strong>المتبقي:</strong> غير محدد</div>`;
            }

            let editButtonHtml = '';
            if (currentUser.role === 'مدير النظام' || currentUser.can_edit_contracts) {
                editButtonHtml = `<button class="btn btn-secondary edit-contract-btn" data-id="${contract.id}"><i class="ph-bold ph-pencil-simple"></i> تعديل</button>`;
            }

            let deleteButtonHtml = '';
            if (currentUser.role === 'مدير النظام' || currentUser.can_delete_contracts) {
                deleteButtonHtml = `<button class="btn btn-danger delete-contract-btn" data-id="${contract.id}"><i class="ph-bold ph-trash"></i> حذف</button>`;
            }

            return `
                <div class="contract-card">
                    <div class="contract-card-header"><h4>${contract.company_name}</h4></div>
                    <div class="contract-card-body">
                        <div class="info-line"><i class="ph-bold ph-money" style="color: #22c55e;"></i><strong>القيمة الإجمالية:</strong> ${finalTotal.toLocaleString('en-US')} ر.س</div>
                        <div class="info-line"><i class="ph-bold ph-users"></i><strong>إجمالي الحراس:</strong> ${totalGuards}</div>
                        ${remainingDaysHtml}
                        <hr style="margin: 10px 0;">
                        <div class="info-line"><i class="ph-bold ph-car"></i><strong>الدوريات:</strong> ${totalPatrolsCount} (${totalPatrolsPrice.toLocaleString('en-US')} ر.س)</div>
                        <div class="info-line"><i class="ph-bold ph-buildings"></i><strong>المرافق:</strong> ${totalFacilitiesCount} (${totalFacilitiesPrice.toLocaleString('en-US')} ر.س)</div>
                        <div class="info-line"><i class="ph-bold ph-broadcast"></i><strong>الأجهزة:</strong> ${totalDevicesCount} (${totalDevicesPrice.toLocaleString('en-US')} ر.س)</div>
                    </div>
                    <div class="contract-card-footer">
                        <button class="btn btn-primary view-contract-btn" data-id="${contract.id}"><i class="ph-bold ph-eye"></i> عرض التفاصيل</button>
                        ${editButtonHtml}
                        ${deleteButtonHtml}
                    </div>
                </div>
            `;
        }).join('');

        listContainer.innerHTML = `<div class="contracts-container">${contractsHtml}</div>`;

    } catch (error) {
        console.error('خطأ في جلب العقود:', error);
        listContainer.innerHTML = `<p style="text-align: center; color: red;">حدث خطأ أثناء تحميل العقود: ${error.message}</p>`;
    }
}
async function loadAttendancePage() {
    if (attendancePageInterval) {
        clearInterval(attendancePageInterval);
        attendancePageInterval = null;
    }

    const attendanceContent = document.querySelector('#page-attendance');
    attendanceContent.innerHTML = `
        <div class="page-header"><h3>تسجيل الحضور والانصراف</h3></div>
        <div class="attendance-card">
            <div id="attendance-status" class="attendance-status-text"><p>جاري التحقق من حالتك ونوع ورديتك...</p></div>
            <div id="attendance-actions" style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                <div id="location-btn-container"></div>
                <button id="check-in-btn" class="btn btn-success btn-lg hidden">تسجيل حضور</button>
                <button id="check-out-btn" class="btn btn-danger btn-lg hidden">تسجيل انصراف</button>
                <button id="stale-checkin-fix-btn" class="btn btn-primary btn-lg hidden">تسجيل انصراف للفترة السابقة وبدء الفترة الجديدة</button>
            </div>
            <div id="location-status" class="location-status"></div>
        </div>`;

    if (!currentUser) return;

    const statusText = document.getElementById('attendance-status');
    const checkInBtn = document.getElementById('check-in-btn');
    const checkOutBtn = document.getElementById('check-out-btn');
    const staleFixBtn = document.getElementById('stale-checkin-fix-btn');
    const locationBtnContainer = document.getElementById('location-btn-container');
    stopPersistentTracking();

    try {
        let activeShift = null;
        const today = new Date().toISOString().split('T')[0];
        const { data: activeCoverage } = await supabaseClient.rpc('get_active_coverage_for_user', { p_user_id: currentUser.id });
        if (activeCoverage && activeCoverage.length > 0) {
            const coverageShiftDetails = activeCoverage[0];
            const { data: contract } = await supabaseClient.from('contracts').select('contract_locations').eq('company_name', coverageShiftDetails.project).single();
            const locationData = contract.contract_locations.find(loc => loc.name === coverageShiftDetails.location);
            activeShift = {
                type: 'coverage',
                details: { ...coverageShiftDetails, geofence_link: locationData?.geofence_link, geofence_radius: locationData?.geofence_radius },
                snapshot: {
                    project: coverageShiftDetails.project, location: coverageShiftDetails.location, region: coverageShiftDetails.region, city: coverageShiftDetails.city,
                    schedule_details: [{ 
    name: `تغطية`, 
    periods: [{
        start_time: coverageShiftDetails.start_time, 
        end_time: coverageShiftDetails.end_time
    }],
    days: [new Date(today).toLocaleString('en-US', { weekday: 'short' })] 
}]
                }
            };
} else if (currentUser.employment_status === 'بديل راحة') {
    const { data: userWithVacancy } = await supabaseClient.from('users').select('*, job_vacancies!users_vacancy_id_fkey(*, contracts(contract_locations))').eq('id', currentUser.id).single();
    if (userWithVacancy?.job_vacancies) {
         const vacancy = Array.isArray(userWithVacancy.job_vacancies) ? userWithVacancy.job_vacancies[0] : userWithVacancy.job_vacancies;
         if(vacancy){
            const locData = vacancy.contracts?.contract_locations?.find(l => l.name === vacancy.specific_location);

            activeShift = {
                type: 'substitute', // نوع جديد لتمييزه
                details: { 
                    ...vacancy,
                    geofence_link: locData?.geofence_link,
                    geofence_radius: locData?.geofence_radius || 200
                },
                snapshot: { 
                    project: vacancy.project, 
                    location: vacancy.specific_location, 
                    region: vacancy.region, 
                    city: vacancy.location,
                    schedule_details: [] 
                }
            };
         }
    }
        } else {
            const { data: userWithVacancy } = await supabaseClient.from('users').select('*, job_vacancies!users_vacancy_id_fkey(*, contracts(contract_locations))').eq('id', currentUser.id).single();
            if (userWithVacancy?.job_vacancies) {
                const vacancy = Array.isArray(userWithVacancy.job_vacancies) ? userWithVacancy.job_vacancies[0] : userWithVacancy.job_vacancies;
                if (vacancy) {
                    const locationData = vacancy.contracts ? vacancy.contracts.contract_locations.find(loc => loc.name === vacancy.specific_location) : null;
                    activeShift = {
                        type: 'regular',
                        details: { ...vacancy, geofence_link: locationData?.geofence_link, geofence_radius: locationData?.geofence_radius },
                        snapshot: { project: vacancy.project, location: vacancy.specific_location, region: vacancy.region, city: vacancy.location, schedule_details: vacancy.schedule_details, base_salary: vacancy.base_salary, housing_allowance: vacancy.housing_allowance, transport_allowance: vacancy.transport_allowance, other_allowances: vacancy.other_allowances }
                    };
                }
            }
        }

        if (!activeShift) {
            statusText.innerHTML = `<p>أنت غير معين على أي وردية عمل (أساسية أو تغطية) حالياً.</p>`;
            return;
        }
        if (activeShift.type === 'regular') {
            const { data: existingCoverage } = await supabaseClient.from('coverage_shifts').select('id').eq('covered_user_id', currentUser.id).gte('created_at', new Date(new Date().setHours(0,0,0,0)).toISOString()).limit(1);
            if (existingCoverage && existingCoverage.length > 0) {
                statusText.innerHTML = `<div class="lockout-message"><h4>تم تسجيلك غياب</h4><p>لقد قام المشرف بطرح ورديتك للتغطية، لا يمكنك تسجيل الحضور. إذا كان هذا الإجراء خاطئاً تواصل مع مشرفك المباشر.</p></div>`;
                return;
            }
        }
        if (activeShift.details.geofence_link) {
            const coords = activeShift.details.geofence_link.replace(/\s/g, '');
            const locationLink = `https://www.google.com/maps/search/?api=1&query=${coords}`;
            locationBtnContainer.innerHTML = `<a href="${locationLink}" target="_blank" class="btn btn-secondary" style="width: 100%;"><i class="ph-bold ph-map-pin"></i> موقع العمل</a>`;
        }
        const state = await determineGuardAttendanceState(currentUser, activeShift);
switch (state.status) {
    case 'ALREADY_CHECKED_IN':
        const clockInTime = new Date(state.record.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        statusText.innerHTML = `<p>حالتك الحالية: <strong>مسجل حضور</strong> منذ الساعة ${clockInTime}</p>`;
        checkOutBtn.classList.remove('hidden');
        checkOutBtn.dataset.attendanceId = state.record.id;
        startPersistentTracking(activeShift.details, state.record.id);
        break;

    case 'STALE_CHECK_IN':
        statusText.innerHTML = `<div class="lockout-message"><h4>تنبيه: لقد نسيت تسجيل الانصراف!</h4><p>النظام يظهر أنك ما زلت مسجلاً للحضور من فترة سابقة انتهت. الرجاء معالجة الأمر للمتابعة.</p><p style="font-size: 0.9rem;">إذا كان هذا الإجراء خاطئاً تواصل مع مشرفك المباشر.</p></div>`;
        staleFixBtn.classList.remove('hidden');
        staleFixBtn.dataset.recordId = state.record.id;
        staleFixBtn.dataset.periodEndTime = state.period.end_time;
        break;
    
    case 'CAN_CHECK_IN':
        statusText.innerHTML = `<p>فترتك القادمة (${formatTimeAMPM(state.period.start_time)}) فعالة. يمكنك تسجيل حضورك الآن.</p>`;
        checkInBtn.classList.remove('hidden');
        checkInBtn.dataset.activeShift = JSON.stringify(activeShift);
        break;
    case 'WAITING_FOR_SHIFT':
    case 'LOCKED_OUT_ABSENT':
    case 'ALL_PERIODS_DONE':
    case 'JUST_FINISHED_FINAL_SHIFT':
        let titleHtml;
        if (state.status === 'WAITING_FOR_SHIFT') {
            titleHtml = `<h4 style="color: var(--accent-color);">فترتك التالية تبدأ بعد ${state.countdown}</h4>`;
        } else if (state.status === 'LOCKED_OUT_ABSENT') {
            const nextShiftText = state.nextShift ? `ورديتك القادمة هي ${state.nextShift.formattedDateTime}.` : 'يرجى مراجعة جدولك مع المشرف.';
            titleHtml = `<div class="lockout-message"><h4>تم تسجيلك غائب</h4><p>بسبب تأخرك عن وقت الحضور المسموح به.</p><p style="font-weight: 600;">${nextShiftText}</p><p style="font-size: 0.9rem;">إذا كان هذا الإجراء خاطئاً تواصل مع مشرفك المباشر.</p></div>`;
        } else { // ALL_PERIODS_DONE أو JUST_FINISHED_FINAL_SHIFT
            const nextShiftText = state.nextShift ? `ورديتك القادمة هي ${state.nextShift.formattedDateTime}.` : 'لا توجد ورديات مجدولة لك حالياً.';
            const mainTitle = (state.status === 'JUST_FINISHED_FINAL_SHIFT') ? 'اكتمل عملك لهذا اليوم' : 'لا توجد فترات عمل متبقية اليوم';
            titleHtml = `<div class="lockout-message"><h4 style="color: var(--accent-color);">${mainTitle}</h4><p>${nextShiftText}</p></div>`;
        }
        let periodsListHtml = '';
        if (state.allPeriodsToday && state.allPeriodsToday.length > 0) {
            periodsListHtml = `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: right;">
                    <h5 style="margin: 0 0 10px 0; font-size: 1rem; color: var(--text-secondary);">جدول فتراتك الكامل لليوم:</h5>
                    <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 5px; align-items: center;">
                        ${state.allPeriodsToday.map(p => `
                            <li style="font-weight: 600; font-size: 1.1rem;">
                                <i class="ph-fill ph-clock" style="color: var(--accent-color);"></i>
                                ${formatTimeAMPM(p.start_time)} - ${formatTimeAMPM(p.end_time)}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
        
        statusText.innerHTML = `<div class="lockout-message">${titleHtml}${periodsListHtml}</div>`;
        if(state.status === 'WAITING_FOR_SHIFT' || state.status === 'ALL_PERIODS_DONE') {
            attendancePageInterval = setInterval(loadAttendancePage, 60000);
        }
        break;

    case 'LOCKED_OUT_ACTION':
        statusText.innerHTML = `<div class="lockout-message"><h4>تم تسجيل ${state.lastStatus}</h4><p>يمكنك تسجيل حضورك مرة أخرى مع بداية ورديتك القادمة.</p></div>`;
        break;

    case 'NO_SCHEDULE':
        statusText.innerHTML = `<p>ليس لديك وردية عمل مجدولة لهذا اليوم.</p>`;
        break;
}
        let isPageLoading = false;
        if (activeSubscription) { supabaseClient.removeChannel(activeSubscription); activeSubscription = null; }
        activeSubscription = supabaseClient.channel(`guard-attendance-user-${currentUser.id}`)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance', filter: `guard_id=eq.${currentUser.id}`}, () => { if (!isPageLoading) { isPageLoading = true; loadAttendancePage(); setTimeout(() => { isPageLoading = false; }, 3000); }})
            .on('postgres_changes', { event: '*', schema: 'public', table: 'users', filter: `id=eq.${currentUser.id}`}, () => { if (!isPageLoading) { isPageLoading = true; loadAttendancePage(); setTimeout(() => { isPageLoading = false; }, 3000); }})
            .on('postgres_changes', { event: '*', schema: 'public', table: 'job_vacancies', filter: `id=eq.${currentUser.vacancy_id}`}, () => { if (!isPageLoading) { isPageLoading = true; loadAttendancePage(); setTimeout(() => { isPageLoading = false; }, 3000); }})
            .on('postgres_changes', { event: '*', schema: 'public', table: 'coverage_shifts', filter: `covered_user_id=eq.${currentUser.id}`}, () => { if (!isPageLoading) { isPageLoading = true; loadAttendancePage(); setTimeout(() => { isPageLoading = false; }, 3000); }})
            .subscribe();

    } catch (error) {
        statusText.innerHTML = `<p style="color: var(--denied-color);">${error.message}</p>`;
        console.error("Attendance Page Error:", error);
    }
}
async function loadMapStatistics(filters = {}) {
    const statsElements = {
        present: document.getElementById('map-stats-present'),
        scheduled: document.getElementById('map-stats-scheduled'),
        coverage: document.getElementById('map-stats-coverage'),
        vacancies: document.getElementById('map-stats-vacancies'),
        absent: document.getElementById('map-stats-absent'),
        permission: document.getElementById('map-stats-permission'),
        withdrawal: document.getElementById('map-stats-withdrawal')
    };

    if (!statsElements.present || !currentUser) return;
    Object.values(statsElements).forEach(el => { if (el) el.textContent = '...'; });

    try {
    const mapFilters = { ...filters, isActiveOnly: false };
    const { finalFilteredGuards } = await getFilteredAttendanceData(mapFilters);

    const stats = finalFilteredGuards.reduce((acc, g) => {
            const statusText = g.statusInfo.text;
            if (statusText === 'حاضر') acc.present++;
            else if (statusText === 'غياب' || statusText === 'متأخر') acc.absent++;
            else if (statusText === 'انسحاب') acc.withdrawal++;
            else if (statusText === 'استئذان') acc.permission++;
            return acc;
        }, { present: 0, absent: 0, withdrawal: 0, permission: 0 });

        const scheduledCount = stats.present + stats.absent + stats.withdrawal + stats.permission;

        statsElements.present.textContent = stats.present;
        statsElements.scheduled.textContent = scheduledCount;
        statsElements.absent.textContent = stats.absent;
        statsElements.permission.textContent = stats.permission;
        if (statsElements.withdrawal) statsElements.withdrawal.textContent = stats.withdrawal;

        const { count: coverageCount } = await supabaseClient.from('users').select('*', { count: 'exact', head: true }).eq('employment_status', 'تغطية');
        statsElements.coverage.textContent = coverageCount || 0;
        const { count: vacancyCount } = await supabaseClient.from('job_vacancies').select('*', { count: 'exact', head: true }).eq('status', 'open');
        statsElements.vacancies.textContent = vacancyCount || 0;

    } catch (error) {
        console.error("Failed to load map statistics:", error);
        Object.values(statsElements).forEach(el => { if (el) { el.textContent = 'خطأ'; } });
    }
}
async function startPersistentTracking(fullUser, attendanceId) {
    stopPersistentTracking(); 
    const locationStatus = document.getElementById('location-status');
    if (locationStatus) locationStatus.innerHTML = `<p style="color: #22c55e;">التتبع المباشر فعال.</p>`;
    let wakeLock = null;
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            window.wakeLock = wakeLock; // تخزينه بشكل عام لإلغائه لاحقاً
            console.log('Screen Wake Lock is active.');
        }
    } catch (err) {
        console.error(`${err.name}, ${err.message}`);
    }

    const UPDATE_INTERVAL_MS = 5000; // الفحص كل 10 ثواني
    let consecutiveOutOfBounds = 0;
    const OUT_OF_BOUNDS_THRESHOLD = 2; // تسجيل الانسحاب بعد محاولتين

    let firstFailureTimestamp = null;
    const FAILURE_THRESHOLD_MS = 60 * 1000;

    const handleTrackingError = (geoError) => {
        console.warn("خطأ مؤقت في التتبع (تتم إعادة المحاولة تلقائياً):", geoError.message);
        if (firstFailureTimestamp === null) {
            firstFailureTimestamp = Date.now();
        } else {
            if ((Date.now() - firstFailureTimestamp) > FAILURE_THRESHOLD_MS) {
                console.error("فشل التتبع لمدة تزيد عن دقيقة. سيتم تحديث الصفحة.");
                window.location.reload();
            }
        }
    };

    try {
        let siteCoords, radius;

        if (fullUser.contracts) {
            const contract = fullUser.contracts;
            const locationData = contract.contract_locations.find(loc => loc.name === fullUser.specific_location);
            if (!locationData || !locationData.geofence_link) throw new Error('لم يتم تحديد إحداثيات الموقع في العقد.');
            siteCoords = parseCoordinates(locationData.geofence_link);
            radius = locationData.geofence_radius || 200;
        } 
        else if (fullUser.geofence_link) {
            siteCoords = parseCoordinates(fullUser.geofence_link);
            radius = fullUser.geofence_radius || 200;
        } 
        else {
            throw new Error('لا يمكن تحديد بيانات الموقع الجغرافي لهذه الوردية.');
        }

        if (!siteCoords) throw new Error('إحداثيات موقع العمل غير صالحة.');

        const updateLocation = () => {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    firstFailureTimestamp = null;
                    if (locationStatus.innerHTML.includes('خطأ')) {
                        locationStatus.innerHTML = `<p style="color: #22c55e;">التتبع المباشر فعال.</p>`;
                    }

                    const { latitude, longitude, accuracy } = position.coords;
                    supabaseClient.from('guard_locations').upsert({ guard_id: currentUser.id, latitude, longitude }, { onConflict: 'guard_id' }).then();

                    const distance = calculateDistance(siteCoords, { lat: latitude, lng: longitude });
                    const effectiveDistance = distance - accuracy;

                    if (effectiveDistance > radius) {
                        consecutiveOutOfBounds++;
                        console.log(`خارج النطاق، مرة رقم: ${consecutiveOutOfBounds}`);
                        if (consecutiveOutOfBounds >= OUT_OF_BOUNDS_THRESHOLD) {
                            const { data: pendingPermission, error: permError } = await supabaseClient
                            .from('employee_requests')
                            .select('id')
                            .eq('user_id', currentUser.id)
                            .eq('request_type', 'permission')
                            .in('status', ['بانتظار موافقة المشرف', 'بانتظار موافقة العمليات'])
                            .limit(1)
                            .single();

                        if (permError && permError.code !== 'PGRST116') { // PGRST116 = لم يتم العثور على صفوف
                            console.error("خطأ أثناء التحقق من الاستئذان، سيتم تسجيل الانسحاب احتياطياً.", permError);
                        }

                        if (pendingPermission) {
                            console.log("الحارس خارج النطاق، ولكنه قدم طلب استئذان قيد المراجعة. تم إيقاف تسجيل الانسحاب.");
                            consecutiveOutOfBounds = 0; // إعادة تصفير العداد
                        } else {
                            stopPersistentTracking();
                            showToast(`تم تسجيل انسحاب للحارس: ${currentUser.name}`, 'error');
                            await supabaseClient.from('attendance').update({ status: 'انسحاب', checkout_at: new Date() }).eq('id', attendanceId);
                            loadAttendancePage();
                        }
                            stopPersistentTracking();
                            showToast(`تم تسجيل انسحاب للحارس: ${currentUser.name}`, 'error');
                            await supabaseClient.from('attendance').update({ status: 'انسحاب', checkout_at: new Date() }).eq('id', attendanceId);
                            loadAttendancePage();
                        }
                    } else {
                        consecutiveOutOfBounds = 0;
                    }
                },
                handleTrackingError,
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        };

        updateLocation();
        locationUpdateInterval = setInterval(updateLocation, UPDATE_INTERVAL_MS);

    } catch(err) {
        console.error("فشل بدء التتبع:", err.message);
        if (locationStatus) locationStatus.innerHTML = `<p style="color: #dc3545;">${err.message}</p>`;
    }
}
let locationUpdateInterval = null;
function stopPersistentTracking() {
    if (locationUpdateInterval) {
        clearInterval(locationUpdateInterval);
        locationUpdateInterval = null;
        const locationStatus = document.getElementById('location-status');
        if (locationStatus) locationStatus.innerHTML = '';
        console.log('تم إيقاف التتبع المباشر.');
    }
    if (locationPermissionStatus) {
        locationPermissionStatus.onchange = null; // إزالة الحدث
        locationPermissionStatus = null; // حذف الكائن
        console.log('تم إيقاف مراقبة صلاحية الموقع.');
    }
}
async function fetchJobs() {
    const { data: jobs, error } = await supabaseClient
        .from('jobs')
        .select('title, location, type, status'); // نحدد الأعمدة المطلوبة

    if (error) {
        console.error('خطأ في جلب الوظائف:', error);
        const jobsContent = document.querySelector('#page-jobs');
        jobsContent.innerHTML = '<p style="text-align: center;">حدث خطأ أثناء تحميل الوظائف.</p>';
        return;
    }

    const jobsContent = document.querySelector('#page-jobs');
    jobsContent.innerHTML = '';

    if (jobs.length === 0) {
        jobsContent.innerHTML = '<p style="text-align: center;">لا توجد وظائف متاحة حالياً.</p>';
        return;
    }
    const jobsContainer = document.createElement('div');
    jobsContainer.className = 'jobs-container';

    jobs.forEach(job => {
        const card = `
            <div class="job-card">
                <div class="job-card-header">
                    <h3>${job.title || 'بدون عنوان'}</h3>
                    <span class="status ${job.status === 'active' ? 'active' : 'inactive'}">${job.status === 'active' ? 'شاغرة' : 'مغلقة'}</span>
                </div>
                <div class="job-card-body">
                    <p><i class="ph-bold ph-map-pin"></i> ${job.location || 'غير محدد'}</p>
                    <p><i class="ph-bold ph-clock"></i> ${job.type || 'غير محدد'}</p>
                </div>
                <div class="job-card-footer">
                    <button class="btn btn-secondary">عرض التفاصيل</button>
                </div>
            </div>
        `;
        jobsContainer.insertAdjacentHTML('beforeend', card);
    });

    jobsContent.appendChild(jobsContainer);
}
async function loadUserManagementPage() {
    const container = document.getElementById('user-management-table-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل قائمة المستخدمين...</p>';
    const searchTerm = document.getElementById('user-mgmt-search').value;
    const showGuards = document.getElementById('user-mgmt-toggle-guards').checked;

    let query = supabaseClient
        .from('users')
        .select('*') // سيجلب جميع الحقول بما فيها الصلاحيات الجديدة
        .not('employment_status', 'eq', 'مؤرشف');
    if (searchTerm) {
        query = query.or(`name.ilike.%${searchTerm}%,id_number.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
    }
    if (!showGuards) {
        query = query.not('role', 'in', '("حارس أمن", "مشرف")');
    }

    const { data: users, error } = await query.order('name', { ascending: true });

    if (error) { container.innerHTML = '<p style="color:red;">حدث خطأ في جلب المستخدمين.</p>'; return; }

    if (users.length === 0) {
        container.innerHTML = '<div class="empty-state" style="margin-top:0;"><i class="ph-bold ph-users"></i><h4>لا توجد نتائج</h4><p>لم يتم العثور على مستخدمين يطابقون بحثك.</p></div>';
        return;
    }

    let headers = `<th>الاسم</th><th>الدور</th><th>الحالة</th><th>الجوال</th>`;
    
    if (currentUser.role === 'مدير النظام') {
        headers += `
            <th>تعديل الحضور</th><th>تعديل العقود</th><th>حذف العقود</th>
            <th>حذف الشاغر</th><th>إدارة الإداريين</th>
            <th>مدير عمليات</th><th>مدير موارد</th><th>مدير عقود</th><th>مدير مالي</th><th>مدير تسويق</th><th>مدير قانوني</th>
            
            <th style="background-color: #dcfce7; color: #166534;">CFO (المدير المالي)</th>
            <th style="background-color: #dcfce7; color: #166534;">المدقق المالي</th>
            <th style="background-color: #fee2e2; color: #991b1b;">CEO (المدير التنفيذي)</th>
        `;
    }
    headers += '<th>إجراءات</th>';

    container.innerHTML = `
        <table>
            <thead><tr>${headers}</tr></thead>
            <tbody>
                ${users.map(user => {
                    let permissionCells = '';
                    if (currentUser.role === 'مدير النظام') {
                        const attendanceCheckbox = (user.role === 'ادارة الموارد البشرية') ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="can_edit_attendance" ${user.can_edit_attendance ? 'checked' : ''}>` : '-';
                        const adminStaffPermissionCheckbox = (user.role === 'ادارة الموارد البشرية') ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="can_manage_admin_staff" ${user.can_manage_admin_staff ? 'checked' : ''}>` : '-';

                        const editContractCheckbox = user.role === 'ادارة العقود' ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="can_edit_contracts" ${user.can_edit_contracts ? 'checked' : ''}>` : '-';
                        const deleteContractCheckbox = user.role === 'ادارة العقود' ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="can_delete_contracts" ${user.can_delete_contracts ? 'checked' : ''}>` : '-';
                        const deleteVacancyCheckbox = user.role === 'ادارة الموارد البشرية' ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="can_delete_vacancies" ${user.can_delete_vacancies ? 'checked' : ''}>` : '-';
                        const managerPermissions = [
                            { key: 'is_ops_manager', role: 'ادارة العمليات' }, 
                            { key: 'is_hr_manager', role: 'ادارة الموارد البشرية' },
                            { key: 'is_contracts_manager', role: 'ادارة العقود' }, 
                            { key: 'is_finance_manager', role: 'المالية' },
                            { key: 'is_marketing_manager', role: 'التسويق' }, 
                            { key: 'is_legal_manager', role: 'الشؤون القانونية' }
                        ];
                        const managerCheckboxes = managerPermissions.map(p => 
                            user.role === p.role ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="${p.key}" ${user[p.key] ? 'checked' : ''}>` : '-'
                        ).map(html => `<td>${html}</td>`).join('');
                        const cfoCheckbox = user.role === 'المالية' 
                            ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="is_cfo" ${user.is_cfo ? 'checked' : ''}>` 
                            : '-';
                        const auditorCheckbox = user.role === 'المالية' 
                            ? `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="is_auditor" ${user.is_auditor ? 'checked' : ''}>` 
                            : '-';
                        const ceoCheckbox = `<input type="checkbox" class="permission-checkbox" data-user-id="${user.id}" data-permission="is_ceo" ${user.is_ceo ? 'checked' : ''}>`;

                        permissionCells = `
                            <td>${attendanceCheckbox}</td><td>${editContractCheckbox}</td>
                            <td>${deleteContractCheckbox}</td><td>${deleteVacancyCheckbox}</td>
                            <td>${adminStaffPermissionCheckbox}</td>${managerCheckboxes}
                            <td style="background-color: #f0fdf4;">${cfoCheckbox}</td>
                            <td style="background-color: #f0fdf4;">${auditorCheckbox}</td>
                            <td style="background-color: #fef2f2;">${ceoCheckbox}</td>
                        `;
                    }

                    return `
                        <tr>
                            <td style="text-align: right;">${user.name}</td>
                            <td>${user.role}</td>
                            <td><span class="status ${user.status === 'active' ? 'active' : 'inactive'}">${user.status === 'active' ? 'نشط' : 'غير نشط'}</span></td>
                            <td>${user.phone || '-'}</td>
                            ${permissionCells}
                            <td>
                                <div style="display: flex; gap: 5px; justify-content: center;">
                                    <button class="btn btn-secondary btn-sm admin-edit-user-btn" data-id="${user.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i></button>
                                    <button class="btn btn-danger btn-sm admin-archive-user-btn" data-id="${user.id}" data-name="${user.name}" title="أرشفة"><i class="ph-bold ph-archive"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>`;
}
async function loadAdminStaffData() {
    const container = document.getElementById('admin-staff-list-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الموظفين الإداريين...</p>';
    supabaseClient
        .from('company_branches')
        .select('*', { count: 'exact', head: true })
        .then(({ count, error }) => {
            if (!error) {
                const branchStatEl = document.getElementById('admin-stats-branches');
                if (branchStatEl) branchStatEl.textContent = count || 0;
            }
        });

    const searchVal = document.getElementById('admin-staff-search-input').value;
    const roleVal = document.getElementById('admin-staff-role-filter').value;

    let query = supabaseClient
        .from('users')
        .select(`id, name, role, phone, employment_status, region`)
        .not('employment_status', 'eq', 'مؤرشف')
        .not('role', 'in', '("حارس أمن","مشرف")');

    if (searchVal) {
        query = query.or(`name.ilike.%${searchVal}%,id_number.ilike.%${searchVal}%`);
    }
    if (roleVal) {
        query = query.eq('role', roleVal);
    }

    const { data: employees, error } = await query.order('name');

    if (error) {
        container.innerHTML = '<p style="color:red;">حدث خطأ في تحميل الموظفين.</p>';
        console.error("Admin Staff Load Error:", error); // <-- إضافة سطر طباعة الخطأ في الكونسول
        return;
    }
    if (employees) {
        document.getElementById('admin-stats-total').textContent = employees.length;
        const uniqueDepartments = new Set(employees.map(emp => emp.role));
        document.getElementById('admin-stats-departments').textContent = uniqueDepartments.size;
    }

    if (employees.length === 0) {
        container.innerHTML = '<p style="text-align: center;">لا يوجد موظفون إداريون يطابقون بحثك.</p>';
        return;
    }

    container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>الدور</th>
                    <th>رقم الجوال</th>
                    <th>الحالة الوظيفية</th>
                    <th>المنطقة</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody>
                ${employees.map(emp => {
                    let regionHtml = emp.region || '-';
                    if (emp.role === 'ادارة الموارد البشرية' || emp.role === 'ادارة العمليات') {
                        const regions = ['الوسطى', 'الغربية', 'الشرقية', 'الشمالية', 'الجنوبية'];
                        regionHtml = `
                            <select class="admin-staff-region-select" data-user-id="${emp.id}" style="padding: 5px; border-radius: 6px;">
                                <option value="">بلا منطقة</option>
                                ${regions.map(r => `<option value="${r}" ${emp.region === r ? 'selected' : ''}>${r}</option>`).join('')}
                            </select>
                        `;
                    }

                    return `
                        <tr>
                            <td>${emp.name || '-'}</td>
                            <td>${emp.role || '-'}</td>
                            <td>${emp.phone || '-'}</td>
                            <td><span class="status active">${emp.employment_status || '-'}</span></td>
                            <td>${regionHtml}</td> 
                            <td>
                                <button class="btn btn-secondary btn-sm admin-edit-user-btn" data-id="${emp.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i></button>
                                <button class="btn btn-danger btn-sm admin-archive-user-btn" data-id="${emp.id}" data-name="${emp.name}" title="تعطيل"><i class="ph-bold ph-archive"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}
document.addEventListener('input', function(event) {
    if (event.target.classList.contains('admin-staff-filter')) {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(loadAdminStaffData, 500);
    }
if (event.target.classList.contains('admin-staff-region-select')) {
    const userId = event.target.dataset.userId;
    const newRegion = event.target.value || null;

    supabaseClient.from('users').update({ region: newRegion }).eq('id', userId).then(({ error }) => {
        if (error) {
            showToast('فشل تحديث المنطقة.', 'error');
        } else {
            showToast('تم تحديث المنطقة بنجاح.', 'success');
        }
    });
}
});
async function loadDepartmentManagementPage(pageId) {
    const pageElement = document.getElementById(pageId);
    if (!pageElement) return;

    const department = pageElement.dataset.department; // سيأتي هنا 'مدير النظام' للصفحة الجديدة
    const container = pageElement.querySelector('.table-container');
    container.innerHTML = `<p style="text-align: center;">جاري تحميل موظفي قسم ${department}...</p>`;
    const allLinks = Array.from(document.querySelectorAll('.sidebar-nav li a'));
    let departmentPages = [];

    if (department === 'مدير النظام') {
        departmentPages = allLinks
            .filter(a => a.parentElement.id !== 'super-admin-link') // استثناء صفحة التحكم العليا
            .map(a => ({
                id: a.dataset.page,
                name: a.querySelector('span').textContent
            }));
    } else {
        departmentPages = allLinks
            .filter(a => a.closest('li').dataset.role && a.closest('li').dataset.role.includes(department))
            .map(a => ({
                id: a.dataset.page,
                name: a.querySelector('span').textContent
            }));
    }
    if (department === 'ادارة الموارد البشرية') {
        const excludedPages = ['page-admin-staff', 'page-attendance-management'];
        departmentPages = departmentPages.filter(p => !excludedPages.includes(p.id));
    }
    const { data: employees, error } = await supabaseClient
        .from('users')
        .select('id, name, ui_permissions, role') // جلبنا الدور للتأكد
        .eq('role', department)
        .not('employment_status', 'eq', 'مؤرشف')
        .not('id', 'eq', currentUser.id); // استثناء النفس

    if (error) {
        container.innerHTML = `<p style="color:red;">حدث خطأ في جلب الموظفين.</p>`;
        return;
    }

    if (employees.length === 0) {
        container.innerHTML = `<p style="text-align: center;">لا يوجد موظفون آخرون في هذا القسم.</p>`;
        return;
    }
    const employeeCardsHtml = employees.map(emp => {
        const userPermissions = emp.ui_permissions?.allowed_pages || [];
        
        const checkboxesHtml = departmentPages.map(p => {
            let isChecked = userPermissions.includes(p.id);
            if (department === 'مدير النظام' && (!emp.ui_permissions || !emp.ui_permissions.allowed_pages)) {
                isChecked = true; 
            }

            return `
                <label>
                    <input type="checkbox" class="ui-permission-checkbox" data-user-id="${emp.id}" data-page-id="${p.id}" ${isChecked ? 'checked' : ''}>
                    ${p.name}
                </label>
            `;
        }).join('');

        return `
            <div class="permission-card">
                <div class="permission-card-header">
                    <h5>${emp.name}</h5>
                    <button class="btn btn-danger btn-sm admin-archive-user-btn" data-id="${emp.id}" data-name="${emp.name}" title="تعطيل الحساب">
                        <i class="ph-bold ph-user-minus"></i> تعطيل
                    </button>
                </div>
                <div class="permission-card-body">
                    <div class="checkbox-grid">
                        ${checkboxesHtml}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = `<div class="department-cards-grid">${employeeCardsHtml}</div>`;
}
let mapSubscription = null; // متغير للتحكم في الاشتراك المباشر
let requestsSubscription = null; // متغير لاشتراك الطلبات المباشر
async function initializeMap() {
    const primaryGuardIcon = L.divIcon({
        className: 'map-guard-marker primary-guard-marker',
        html: `<i class="ph-fill ph-user"></i>`,
        iconSize: [36, 36], iconAnchor: [18, 36]
    });

    const coverageGuardIcon = L.divIcon({
        className: 'map-guard-marker coverage-guard-marker',
        html: `<i class="ph-fill ph-shield-check"></i>`,
        iconSize: [36, 36], iconAnchor: [18, 36]
    });
    const withdrawalGuardIcon = L.divIcon({
        className: 'map-guard-marker withdrawal-guard-marker',
        html: `<i class="ph-fill ph-warning-circle"></i>`,
        iconSize: [36, 36], iconAnchor: [18, 36]
    });

    const filters = {
        region: document.getElementById('geo-filter-region').value,
        city: document.getElementById('geo-filter-city').value,
        project: document.getElementById('geo-filter-project').value,
        location: document.getElementById('geo-filter-location').value,
        search: document.getElementById('map-search-input').value
    };

    loadMapStatistics(filters); 

    if (!map) {
        map = L.map('map').setView([24.7136, 46.6753], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
    }
    setTimeout(() => map.invalidateSize(), 100);

    markersLayer.clearLayers();
    guardMarkers.clear();
    siteMarkersLayer.clearLayers();
    allGuardsOnMap = [];
    if (activeSubscription) { supabaseClient.removeChannel(activeSubscription); activeSubscription = null; }
    
    map.addLayer(markersLayer);
    map.addLayer(siteMarkersLayer);

    try {
        const { data: sites, error: sitesError } = await supabaseClient.rpc('get_all_site_locations');
        if (sitesError) throw sitesError;
        let filteredSites = sites;
        if (currentUser.role === 'مشرف' && currentUser.assigned_locations) {
            const supervisorAssignedSites = new Set(currentUser.assigned_locations.map(loc => `${loc.contract}-${loc.site}`));
            filteredSites = sites.filter(site => supervisorAssignedSites.has(`${site.project_name}-${site.location_name}`));
        }

        const siteIcon = L.divIcon({
            html: '<i class="ph-fill ph-buildings" style="font-size: 24px; color: white; text-shadow: 0 0 3px black;"></i>',
            className: 'custom-map-icon-site',
            iconSize: [30, 30], iconAnchor: [15, 15], popupAnchor: [0, -15]
        });

        filteredSites.forEach(site => {
            const coords = parseCoordinates(site.coordinates);
            const radius = site.radius || 200;
            if (coords) {
                const popupContent = `<div style="font-family: 'Cairo', sans-serif; text-align: right;"><h4>${site.project_name}</h4><p>${site.location_name}</p><p><strong>نطاق الموقع:</strong> ${radius} متر</p></div>`;
                const marker = L.marker([coords.lat, coords.lng], { icon: siteIcon }).bindPopup(popupContent);
                siteMarkersLayer.addLayer(marker);
                L.circle([coords.lat, coords.lng], { radius: radius, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.1, weight: 1 }).addTo(siteMarkersLayer);
            }
        });
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const { data: activeAttendance, error: e1 } = await supabaseClient
            .from('attendance')
            .select('guard_id, status, created_at, checkout_at')
            .gte('created_at', todayStart.toISOString())
            .or('status.eq.حاضر,status.eq.انسحاب'); // <-- التعديل هنا لجلب المنسحبين

        if (e1) throw e1;
        const validGuardIds = new Set();
        const guardStatusMap = new Map(); // لتخزين حالة كل حارس (حاضر/انسحاب)

        activeAttendance.forEach(record => {
            if (record.status === 'حاضر' && !record.checkout_at) {
                validGuardIds.add(record.guard_id);
                guardStatusMap.set(record.guard_id, 'حاضر');
            } 
            else if (record.status === 'انسحاب') {
                validGuardIds.add(record.guard_id);
                guardStatusMap.set(record.guard_id, 'انسحاب');
            }
        });

        const guardIdsArray = Array.from(validGuardIds);

        if (guardIdsArray.length > 0) {
            let guardsQuery = supabaseClient
                .from('users')
                .select(`id, name, project, location, employment_status, vacancy_id, guard_locations!inner(latitude, longitude, created_at)`)
                .in('id', guardIdsArray);

            if (currentUser.role === 'مشرف') {
                const siteFilterString = createSupervisorSiteFilter(currentUser.assigned_locations);
                guardsQuery = guardsQuery.or(siteFilterString);
        } else if (currentUser.role === 'ادارة العمليات' && !currentUser.is_ops_manager) {
            guardsQuery = guardsQuery.eq('region', currentUser.region);
        }

            const { data: presentGuardsDetails, error: e2 } = await guardsQuery;
            const { data: allVacancies, error: e3 } = await supabaseClient.from('job_vacancies').select('id, schedule_details');

            if (e2 || e3) throw (e2 || e3);

            const vacanciesMap = new Map(allVacancies.map(v => [v.id, v]));

            let presentGuards = presentGuardsDetails.map(guard => {
                guard.job_vacancies = vacanciesMap.get(guard.vacancy_id);
                guard.current_status = guardStatusMap.get(guard.id);
                return guard;
            }).filter(isGuardShiftActiveNow); // <-- هذا السطر يخفي الحارس (حتى المنسحب) إذا انتهت ورديته

            const nineHoursAgo = new Date(Date.now() - 9 * 60 * 60 * 1000);
            presentGuards = presentGuards.filter(guard => guard.guard_locations && new Date(guard.guard_locations.created_at) > nineHoursAgo);

            allGuardsOnMap = presentGuards; 

            presentGuards.forEach(guard => {
                const loc = guard.guard_locations;
                if (!loc || !loc.latitude) return;
                const shiftTime = createShiftTimeLabel(guard.job_vacancies?.schedule_details?.[0]);
                const lastUpdate = formatGregorianDateTime(loc.created_at);
                let statusLabel = '';
                let iconToUse;
                
                if (guard.current_status === 'انسحاب') {
                    statusLabel = ' <span style="color: #ef4444; font-weight: bold; font-size: 0.8em;">(منسحب)</span>';
                    iconToUse = withdrawalGuardIcon; // الأيقونة الحمراء
                } else {
                    iconToUse = guard.employment_status === 'تغطية' ? coverageGuardIcon : primaryGuardIcon;
                }

                const popupContent = `<div style="font-family: 'Cairo', sans-serif; font-size: 1rem;">
                    <h4>${guard.name}${statusLabel}</h4>
                    <p><strong>الموقع:</strong> ${guard.location || 'غير محدد'}</p>
                    <p><strong>الوقت:</strong> ${shiftTime}</p>
                    <small style="display: block; text-align: left; margin-top: 10px; color: #6b7280;">آخر تحديث: ${lastUpdate}</small>
                </div>`;

                const marker = L.marker([loc.latitude, loc.longitude], { icon: iconToUse }).bindPopup(popupContent);

                markersLayer.addLayer(marker);
                guardMarkers.set(guard.id, marker);
            });
        }

        if (guardMarkers.size > 0) {
            const guardGroup = new L.featureGroup(Array.from(guardMarkers.values()));
            map.fitBounds(guardGroup.getBounds().pad(0.2));
        } else if (sites.length > 0) {
            map.fitBounds(siteMarkersLayer.getBounds().pad(0.2));
        }

        if (window.zoomToGuardId) {
            const guardIdToFind = parseInt(window.zoomToGuardId, 10);
            if (guardMarkers.has(guardIdToFind)) {
                const markerToZoom = guardMarkers.get(guardIdToFind);
                map.setView(markerToZoom.getLatLng(), 17);
                markerToZoom.openPopup();
            }
            window.zoomToGuardId = null;
        }
        activeSubscription = supabaseClient
            .channel('realtime:map_page_full')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'guard_locations' }, 
            (payload) => { 
                const newLocation = payload.new;
                if (!newLocation || !newLocation.guard_id) return;
                if (guardMarkers.has(newLocation.guard_id)) {
                    guardMarkers.get(newLocation.guard_id).setLatLng([newLocation.latitude, newLocation.longitude]);
                }
             })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, 
            () => { initializeMap(); }) // إعادة تحميل الخريطة عند تغير حالة الحضور (مثلاً من حاضر إلى انسحاب)
            .subscribe();

    } catch (error) {
        console.error('خطأ في جلب مواقع الحراس:', error);
    }
}
if (statsInterval) clearInterval(statsInterval);
statsInterval = setInterval(loadMapStatistics, 60000); 
async function fetchSchedules() {
    const schedulesContent = document.querySelector('#page-schedules');
    schedulesContent.innerHTML = '<p style="text-align: center;">جاري تحميل الجداول...</p>';

    const { data: schedules, error } = await supabaseClient
        .from('schedules')
        .select(`
            start_time,
            end_time,
            users ( name ),
            clients ( name )
        `)
        .order('start_time', { ascending: true }); // ترتيب المناوبات حسب وقت البداية

    if (error) {
        console.error('خطأ في جلب الجداول:', error);
        schedulesContent.innerHTML = '<p style="text-align: center;">حدث خطأ أثناء تحميل الجداول.</p>';
        return;
    }

    if (schedules.length === 0) {
        schedulesContent.innerHTML = '<p style="text-align: center;">لا توجد مناوبات مجدولة حالياً.</p>';
        return;
    }

    schedulesContent.innerHTML = ''; // مسح رسالة التحميل
    const groupedByDay = schedules.reduce((acc, schedule) => {
        const date = new Date(schedule.start_time).toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        if (!acc[date]) {
            acc[date] = [];
        }
        acc[date].push(schedule);
        return acc;
    }, {});
    for (const day in groupedByDay) {
        const dayContainer = document.createElement('div');
        dayContainer.className = 'schedule-day-group';

        let dayHtml = `<h3>${day}</h3><div class="shifts-container">`;

        groupedByDay[day].forEach(shift => {
            const startTime = new Date(shift.start_time).toLocaleTimeString('ar-SA', { hour: 'numeric', minute: '2-digit', hour12: true });
            const endTime = new Date(shift.end_time).toLocaleTimeString('ar-SA', { hour: 'numeric', minute: '2-digit', hour12: true });

            dayHtml += `
                <div class="shift-card">
                    <div class="shift-time">${startTime} - ${endTime}</div>
                    <div class="shift-details">
                        <p><strong>الحارس:</strong> ${shift.users ? shift.users.name : 'غير محدد'}</p>
                        <p><strong>الموقع:</strong> ${shift.clients ? shift.clients.name : 'غير محدد'}</p>
                    </div>
                </div>
            `;
        });

        dayHtml += `</div>`;
        dayContainer.innerHTML = dayHtml;
        schedulesContent.appendChild(dayContainer);
    }
}

/**
 * دالة تحميل الغيابات المعلقة (التبويب الأول)
 */
/**
 * دالة تحميل الغيابات المعلقة (التبويب الأول)
 */
async function loadPendingAbsences() {
    const container = document.getElementById('hr-review-list-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الغيابات المعلقة...</p>';

    try {
        const filterStartDate = new Date('2025-11-08T00:00:00.000Z');

        let query = supabaseClient
            .from('attendance')
            .select(`
                *,
                guard:guard_id (name, phone, id_number),
                submitter:submitted_by_id (name)
            `)
            .eq('status', 'غياب')
            .eq('hr_review_status', 'pending_review')
            .gte('created_at', filterStartDate.toISOString()) // <-- السطر الجديد
            .order('created_at', { ascending: false });
        if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
            query = query.eq('region', currentUser.region);
        }

        const { data: absences, error } = await query;
        if (error) throw error;

        if (absences.length === 0) {
            container.innerHTML = '<div class="empty-state" style="margin-top:0;"><i class="ph-bold ph-check-circle"></i><h4>لا يوجد غياب للمراجعة</h4><p>لا توجد أي سجلات غياب معلقة لهذا اليوم.</p></div>';
            return;
        }

        container.innerHTML = absences.map(absence => {
            const guard = absence.guard;
            const submitter = absence.submitter;
            if (!guard) return '';

            const submittedBy = submitter ? submitter.name : 'آلي (نهاية اليوم)';
            const excuseText = absence.is_excused ? 'بعذر' : 'بدون عذر';
            const excuseClass = absence.is_excused ? 'active' : 'inactive';

            const formattedWhatsApp = formatPhoneNumberForWhatsApp(guard.phone);
            const callBtn = guard.phone ? `<a href="tel:${guard.phone}" class="btn btn-secondary btn-sm" title="اتصال"><i class="ph-bold ph-phone-call"></i></a>` : '';
            const whatsAppBtn = formattedWhatsApp ? `<a href="https://wa.me/${formattedWhatsApp}" target="_blank" class="btn btn-success btn-sm" title="واتساب"><i class="ph-bold ph-whatsapp-logo"></i></a>` : '';

            let attachmentBtn = '';
            if (absence.attachment_url) {
                attachmentBtn = `<button class="btn btn-secondary btn-sm hr-view-absence-attachment-btn" data-url="${absence.attachment_url}" title="عرض المرفق"><i class="ph-bold ph-paperclip"></i></button>`;
            }

            let actionButtons = '';
            if (absence.is_excused) {
                actionButtons = `
                    <button class="btn btn-success hr-approve-absence-btn" data-id="${absence.id}" data-excused="true">اعتماد (بعذر)</button>
                    <button class="btn btn-danger hr-approve-absence-btn" data-id="${absence.id}" data-excused="false">اعتماد (بدون عذر)</button>
                `;
            } else {
                actionButtons = `<button class="btn btn-danger hr-approve-absence-btn" data-id="${absence.id}" data-excused="false">اعتماد الغياب</button>`;
            }
            const shiftDate = formatGregorianDate(absence.created_at);
            const shiftStartTime = formatTimeAMPM(absence.created_at.split('T')[1].substring(0,5));
            const shiftEndTime = formatTimeAMPM(absence.checkout_at.split('T')[1].substring(0,5));
            const project = absence.shift_snapshot?.project || 'غير محدد';
            const location = absence.shift_snapshot?.location || 'غير محدد';

            return `
            <div class="absence-review-card">

                <div class="absence-card-main-info">
                    <h4>${guard.name} <span class="status-badge ${excuseClass}">${excuseText}</span></h4>
                    <p><i class="ph-bold ph-identification-card"></i> ${guard.id_number || 'N/A'}</p>
                    <p><i class="ph-bold ph-map-pin"></i> ${project} / ${location}</p>
                </div>

                <div class="absence-card-details">
                    <span><strong>تاريخ الغياب:</strong> ${shiftDate}</span>
                    <span><strong>وقت الوردية:</strong> ${shiftStartTime} - ${shiftEndTime}</span>
                    <span><strong>المُسجِّل:</strong> ${submittedBy}</span>
                    <span style="font-size: 0.85rem; color: #6b7280;"><strong>ملاحظات:</strong> ${absence.notes || 'لا توجد'}</span>
                </div>

                <div class="absence-card-actions">
                    <div class="decision-buttons">
                        ${actionButtons}
                    </div>
                    <div class="contact-buttons">
                        ${callBtn}
                        ${whatsAppBtn}
                        ${attachmentBtn}
                    </div>
                </div>

            </div>
            `;
        }).join('');
    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
}
async function loadPermissionReviews() {
    const container = document.getElementById('hr-permission-review-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلبات الاستئذان...</p>';

    try {
        let query = supabaseClient
            .from('employee_requests')
            .select(`*, users:user_id!inner(name, vacancy_id, region)`)
            .eq('request_type', 'permission')
            .eq('status', 'بانتظار مراجعة الموارد البشرية') // <-- الحالة الجديدة
            .order('created_at', { ascending: false });
        if (currentUser.role === 'ادارة الموارد البشرية' && !currentUser.is_hr_manager) {
            query = query.eq('users.region', currentUser.region);
        }

        const { data, error } = await query;
        if (error) throw error;
        renderRequests(data, 'hr-permission-review-container', 'استئذان', 'hr_permission_review');

    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
}

/**
 * دالة تحميل أرشيف الغيابات (التبويب الثاني)
 */
async function loadAbsenceArchive(guardId = null) {
    const container = document.getElementById('hr-archive-list-container');
    const searchInput = document.getElementById('hr-absence-archive-search');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الأرشيف...</p>';

    try {
        if (document.getElementById('hr-absence-archive-options').children.length <= 1) { // نتحقق إذا كانت القائمة فارغة أو تحتوي على "جاري التحميل"
            let guardsQuery = supabaseClient
                .from('users')
                .select('id, name, id_number')
                .eq('role', 'حارس أمن')
                .not('employment_status', 'eq', 'مؤرشف');

            if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
                guardsQuery = guardsQuery.eq('region', currentUser.region);
            }

            const { data: guards, error: guardsError } = await guardsQuery;
            if (guardsError) throw guardsError;

            const guardOptions = guards.map(g => ({ id: g.id, text: `${g.name} (${g.id_number || 'N/A'})` }));
            setupSearchableSelect('hr-absence-archive', guardOptions, (selected) => {
                const id = selected ? selected.id : null;
                document.getElementById('hr-absence-archive').value = id;
                loadAbsenceArchive(id);
            });
        }
        let query = supabaseClient
            .from('attendance')
            .select(`*, hr_reviewer:hr_reviewed_by_id(name)`)
            .eq('status', 'غياب')
            .eq('hr_review_status', 'reviewed')
            .order('created_at', { ascending: false });

        if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
            query = query.eq('region', currentUser.region);
        }

        if (guardId) {
            query = query.eq('guard_id', guardId);
        } else {
            query = query.limit(50); // آخر 50 سجل فقط
        }

        const { data: absences, error } = await query;
        if (error) throw error;

        if (absences.length === 0) {
            const message = guardId ? 'لا يوجد سجل غياب معتمد لهذا الحارس.' : 'الأرشيف فارغ حالياً.';
            container.innerHTML = `<p style="text-align: center;">${message}</p>`;
            return;
        }

        container.innerHTML = '<div class="absence-review-list"></div>'; // إضافة الحاوية الجديدة
            const listContainer = container.querySelector('.absence-review-list');

            listContainer.innerHTML = absences.map(absence => {
                const statusText = absence.is_excused ? 'معتمد (بعذر)' : 'معتمد (بدون عذر)';
                const statusClass = absence.is_excused ? 'active' : 'inactive';
                const attachmentBtn = absence.attachment_url 
                    ? `<button class="btn btn-secondary btn-sm hr-view-absence-attachment-btn" data-url="${absence.attachment_url}" title="عرض المرفق"><i class="ph-bold ph-eye"></i> عرض المرفق</button>` 
                    : '';

                const shiftDate = formatGregorianDate(absence.created_at);
                const shiftStartTime = formatTimeAMPM(absence.created_at.split('T')[1].substring(0,5));
                const shiftEndTime = formatTimeAMPM(absence.checkout_at.split('T')[1].substring(0,5));
                const project = absence.shift_snapshot?.project || 'غير محدد';

                return `
                <div class="absence-review-card archive-card">

                    <div class="absence-card-main-info">
                        <h4>${absence.guard_name}</h4>
                        <p><i class="ph-bold ph-map-pin"></i> ${project}</p>
                        <p><strong>الحالة:</strong> <span class="status ${statusClass}">${statusText}</span></p>
                    </div>

                    <div class="absence-card-details">
                        <span><strong>تاريخ الغياب:</strong> ${shiftDate}</span>
                        <span><strong>وقت الوردية:</strong> ${shiftStartTime} - ${shiftEndTime}</span>
                        <span><strong>الملاحظات:</strong> ${absence.notes || '-'}</span>
                    </div>

                    <div class="absence-card-actions">
                        <span class="archive-reviewer">تمت المراجعة بواسطة: <strong>${absence.hr_reviewer?.name || 'غير مسجل'}</strong></span>
                        ${attachmentBtn}
                    </div>

                </div>
                `;
            }).join('');
    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
}
async function loadPenaltiesPage() {
    const page = document.getElementById('page-penalties');
    if (!page) return;
    const activeTab = page.querySelector('.tab-link.active')?.dataset.tab;
    if (activeTab === 'penalties-hr-review-tab') {
        loadPendingAbsences();
    } else if (activeTab === 'penalties-hr-permission-tab') {
        loadPermissionReviews(); // <-- استدعاء الدالة الجديدة
    } else if (activeTab === 'penalties-hr-archive-tab') {
        loadAbsenceArchive();
    } else if (activeTab === 'penalties-log-tab') {
        loadPenaltiesLogSearch(); // (هذه هي الدالة القديمة بعد إعادة تسميتها)
    }
    if (!page.dataset.listenerAttached) {
        page.querySelector('.tabs').addEventListener('click', (event) => {
            event.preventDefault();
            const tabLink = event.target.closest('.tab-link');
            if (!tabLink) return;

            page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            page.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

            tabLink.classList.add('active');
            const targetTabId = tabLink.dataset.tab;
            document.getElementById(targetTabId).classList.remove('hidden');
            if (targetTabId === 'penalties-hr-review-tab') loadPendingAbsences();
            if (targetTabId === 'penalties-hr-permission-tab') loadPermissionReviews();
            if (targetTabId === 'penalties-hr-archive-tab') loadAbsenceArchive();
            if (targetTabId === 'penalties-log-tab') loadPenaltiesLogSearch();
        });
        setupSearchableSelect('hr-absence-archive', [], (selectedOption) => {
            const guardId = selectedOption ? selectedOption.id : null;
            document.getElementById('hr-absence-archive').value = guardId;
            loadAbsenceArchive(guardId); // إعادة تحميل الأرشيف مع فلترة
        });
        document.getElementById('hr-filter-search-penalties')?.addEventListener('input', () => {
            clearTimeout(hrDebounceTimer);
            hrDebounceTimer = setTimeout(loadPenaltiesLogSearch, 300);
        });

        page.dataset.listenerAttached = 'true';
    }
}
async function loadPenaltiesLogSearch() {
    const container = document.getElementById('penalties-employee-list');
    const searchVal = document.getElementById('hr-filter-search-penalties').value;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الحراس...</p>';

    let query = supabaseClient.from('users')
        .select('id, name, project')
        .eq('role', 'حارس أمن')
        .not('employment_status', 'eq', 'مؤرشف');
    if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
        query = query.eq('region', currentUser.region);
    }

    if (searchVal) {
        query = query.or(`name.ilike.%${searchVal}%,id_number.ilike.%${searchVal}%`);
    }

    const { data: employees, error } = await query.order('name');
    if (error) { container.innerHTML = '<p style="color:red;">حدث خطأ.</p>'; return; }
    if (employees.length === 0) { container.innerHTML = '<p>لا توجد نتائج.</p>'; return; }

    container.innerHTML = employees.map(emp => `
        <div class="penalties-employee-item" data-user-id="${emp.id}" data-user-name="${emp.name}">
            <strong>${emp.name}</strong>
            <small>${(Array.isArray(emp.project) ? emp.project.join(', ') : emp.project) || 'غير مسكن'}</small>
        </div>
    `).join('');
}
async function loadPenaltyDetailsForEmployee(userId, userName) {
    const placeholder = document.getElementById('penalties-placeholder');
    const detailsContainer = document.getElementById('penalties-details-container');
    const header = document.getElementById('penalty-details-header');
    const historyContainer = document.getElementById('penalty-history-container');
    const formContainer = detailsContainer.querySelector('.review-request-card:last-child .review-request-body');

    placeholder.classList.add('hidden');
    detailsContainer.classList.remove('hidden');
    header.textContent = `سجل العقوبات لـ: ${userName}`;
    historyContainer.innerHTML = '<p>جاري تحميل السجل...</p>';
    formContainer.innerHTML = ''; // إفراغ الفورم القديم

    const { data: penalties, error } = await supabaseClient.from('penalties').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    if (error) { historyContainer.innerHTML = '<p style="color:red">خطأ في جلب السجل.</p>'; return; }
    if (penalties.length === 0) { historyContainer.innerHTML = '<p>لا يوجد سجل عقوبات لهذا الحارس.</p>'; } 
    else {
        historyContainer.innerHTML = penalties.map(p => `
            <div class="penalty-history-item">
                <div>
                    <strong>${p.reason}</strong> (${p.amount} ر.س)
                    <small style="display:block;">تاريخ الخصم: ${formatGregorianDate(p.deduction_date)}</small>
                </div>
                <small>${formatGregorianDate(p.created_at)}</small>
            </div>
        `).join('');
    }
    formContainer.innerHTML = `
        <input type="hidden" id="penalty-user-id" value="${userId}">
        <div class="form-group"><label>سبب العقوبة / الخصم</label><textarea id="penalty-reason" rows="4" placeholder="مثال: إتلاف ممتلكات..."></textarea></div>
        <div class="form-group"><label>مبلغ الخصم (ر.س)</label><input type="number" id="penalty-amount" placeholder="مثال: 150"></div>
        <div class="form-group"><label>تاريخ تطبيق الخصم</label><input type="date" id="penalty-date"></div>
        <div class="modal-footer" style="padding:0; border:0; margin-top:20px;"><button id="save-penalty-btn" class="btn btn-danger">حفظ وتطبيق الخصم</button></div>
    `;
    document.getElementById('penalty-date').valueAsDate = new Date();
}
async function loadOpsDirectivesHistory() {
    const container = document.getElementById('ops-history-list-container');
    if (!container || !currentUser) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل السجل...</p>';
    const { data: directives, error } = await supabaseClient
        .from('directives')
        .select(`*`) // جلب كل الأعمدة بما فيها السناب شوت
        .eq('sender_id', currentUser.id)
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ في جلب السجل.</p>';
        return console.error(error);
    }

    if (directives.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-clock-counter-clockwise"></i><h4>السجل فارغ</h4><p>لم تقم بإرسال أي توجيهات بعد.</p></div>';
        return;
    }
    container.innerHTML = directives.map(d => {
        const recipient = d.recipient_snapshot;
        if (!recipient) return ''; // تجاهل التوجيهات القديمة التي ليس لها سناب شوت

        const schedule = recipient.schedule;
        const shiftTimeHtml = schedule ? createShiftTimeLabel(schedule) : '(وردية غير محددة)';

        const formattedWhatsAppNumber = formatPhoneNumberForWhatsApp(recipient.phone);
        const callButtonHtml = recipient.phone ? `<a href="tel:${recipient.phone}" class="btn btn-secondary btn-sm" title="اتصال مباشر"><i class="ph-bold ph-phone-call"></i></a>` : '';
        const whatsappButtonHtml = formattedWhatsAppNumber ? `<a href="https://wa.me/${formattedWhatsAppNumber}" target="_blank" class="btn btn-success btn-sm" title="محادثة واتساب"><i class="ph-bold ph-whatsapp-logo"></i></a>` : '';

        let statusHtml;
        switch(d.status) {
            case 'accepted':
                statusHtml = `<div class="directive-response accepted"><i class="ph-bold ph-check-circle"></i><div><strong>تم القبول:</strong><p>${d.acceptance_notes || 'لا توجد ملاحظات.'}</p></div></div>`;
                break;
            case 'rejected':
                statusHtml = `<div class="directive-response rejected"><i class="ph-bold ph-x-circle"></i><div><strong>تم الرفض:</strong><p>${d.rejection_reason || 'لم يتم تحديد سبب.'}</p></div></div>`;
                break;
            default:
                statusHtml = `<div class="directive-response pending"><i class="ph-bold ph-hourglass-high"></i><p>بانتظار الرد من المستلم...</p></div>`;
        }

        return `
            <div class="directive-history-card">
                <div class="directive-card-header">
                    <div class="recipient-info">
                        <h5>إلى: ${recipient.name}</h5>
                        <span><i class="ph-bold ph-map-pin"></i> ${recipient.project || '-'} / ${recipient.location || '-'}</span>
                        <span><i class="ph-bold ph-clock"></i> ${shiftTimeHtml}</span>
                    </div>
                    <div class="recipient-actions">
                        ${callButtonHtml}
                        ${whatsappButtonHtml}
                    </div>
                </div>
                <div class="directive-content">
                    <p>${d.content}</p>
                    <small>${formatGregorianDateTime(d.created_at)}</small>
                </div>
                ${statusHtml}
            </div>
        `;
    }).join('');
}
async function loadMyVisitsPage() {
    const container = document.getElementById('my-visits-list-container');
    if (!container || !currentUser) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل سجل زياراتك...</p>';
    const { data: visits, error } = await supabaseClient
        .from('visits')
        .select(`*, contracts (company_name)`) // الربط مع العقود
        .eq('user_id', currentUser.id)
        .order('visit_time', { ascending: false });

    if (error) {
        container.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ في جلب السجل.</p>';
        return console.error(error);
    }

    if (visits.length === 0) {
        container.innerHTML = '<p style="text-align: center;">لم تقم بتسجيل أي زيارات بعد.</p>';
        return;
    }

    container.innerHTML = visits.map(visit => {
        const formattedDateTime = formatGregorianDateTime(visit.visit_time);
        const locationDisplay = visit.location_name || 'موقع غير محدد';

        return `
            <div class="visit-card" style="margin-bottom: 15px;">
                <div class="visit-icon"><i class="ph-fill ph-car-profile"></i></div>
                <div class="visit-details">
                    <h4>زيارة إلى: ${locationDisplay}</h4>
                    <p class="visit-meta">
                        <span><i class="ph-bold ph-calendar"></i> ${formattedDateTime}</span>
                    </p>
                    <p class="visit-notes">${visit.notes || 'لا توجد ملاحظات.'}</p>
                </div>
            </div>
        `;
    }).join('');
}
async function loadMySchedulePage() {
    const container = document.getElementById('my-schedule-container');
    if (!container || !currentUser) {
        return container.innerHTML = '<p>لا يمكن عرض الجدول.</p>';
    }
    container.innerHTML = '<p style="text-align: center;">جاري تحميل جدولك الأسبوعي...</p>';

    try {
        const { data: userWithVacancy, error } = await supabaseClient
            .from('users')
            .select('*, job_vacancies:job_vacancies!users_vacancy_id_fkey(*, contracts(*))')
            .eq('id', currentUser.id)
            .single();

        if (error) throw error;

        const dayTranslations = { Sun: 'الأحد', Mon: 'الاثنين', Tue: 'الثلاثاء', Wed: 'الأربعاء', Thu: 'الخميس', Fri: 'الجمعة', Sat: 'السبت' };
        const weekDaysOrder = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
if (!userWithVacancy.job_vacancies) throw new Error('لم يتم تعيين وردية عمل لك.');

const schedule = userWithVacancy.job_vacancies.schedule_details?.[0];
if (!schedule) throw new Error('تفاصيل وردية العمل غير موجودة.');

const today = new Date();
const todayDay = today.getDay(); // 0 للأحد, 1 للاثنين...

let scheduleHtml = '<div class="schedule-week-grid">';
weekDaysOrder.forEach((dayKey, index) => {
    const isCurrentDay = (index === todayDay) ? 'current-day' : '';

    const currentDate = new Date();
    currentDate.setDate(today.getDate() - todayDay + index);
    const scheduleForThisDay = getScheduleForDate(schedule, currentDate);

    scheduleHtml += `<div class="schedule-day-card ${isCurrentDay}"><h4>${dayTranslations[dayKey]}</h4>`;

    if (scheduleForThisDay) {
        const timeLabel = createShiftTimeLabel(scheduleForThisDay);
        const isOverrideClass = scheduleForThisDay.isOverride ? 'time override' : 'time';
        scheduleHtml += `
            <div class="details">
                <p class="${isOverrideClass}">${timeLabel}</p>
                <p>${userWithVacancy.job_vacancies.project || ''} - ${userWithVacancy.job_vacancies.specific_location || ''}</p>
                ${scheduleForThisDay.isOverride ? '<span class="status-badge pending" style="font-size: 0.7rem; margin: 5px auto 0;">استثناء</span>' : ''}
            </div>`;
    } else {
        scheduleHtml += `<div class="details"><p class="rest-day"><i class="ph-fill ph-coffee"></i> راحة</p></div>`;
    }

    scheduleHtml += '</div>';
});
        scheduleHtml += '</div>';
        container.innerHTML = scheduleHtml;

    } catch (error) {
        container.innerHTML = `<p style="text-align: center; color: var(--denied-color);">${error.message}</p>`;
        console.error(error);
    }
}
async function loadSupervisorPermissionRequestsPage() {
    const container = document.getElementById('supervisor-permission-requests-container');
    if (!container || !currentUser) {
        container.innerHTML = '<p style="text-align: center;">لا يمكن عرض الطلبات.</p>';
        return;
    }
    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلبات الاستئذان...</p>';

    try {
        const { data, error } = await supabaseClient.rpc('get_supervisor_pending_requests', {
            p_supervisor_id: currentUser.id,
            p_request_type: 'permission' // <-- تحديد النوع "استئذان"
        });

        if (error) throw error;
        const userIds = data.map(r => r.user_id);
        if (userIds.length > 0) {
            const { data: usersData, error: usersError } = await supabaseClient
                .from('users')
                .select('id, name')
                .in('id', userIds);
            if (usersError) throw usersError;

            const requestsWithUsers = data.map(req => ({
                ...req,
                user: usersData.find(u => u.id === req.user_id)
            }));

            renderRequests(requestsWithUsers, 'supervisor-permission-requests-container', 'استئذان', 'supervisor_permission_approval');
        } else {
            renderRequests([], 'supervisor-permission-requests-container', 'استئذان', 'supervisor_permission_approval');
        }

    } catch (error) {
        console.error("Error loading supervisor permissions:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
    }
}
async function loadSupervisorApplicationsPage() {
    const container = document.getElementById('supervisor-applications-container');
    if (!container || !currentUser || !currentUser.assigned_locations || currentUser.assigned_locations.length === 0) {
    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلبات التوظيف...</p>';
    return;
    }
    const supervisorProjects = [...new Set(currentUser.assigned_locations.map(loc => loc.contract))];
        const { data: applications, error } = await supabaseClient
            .from('job_applications')
            .select(`*, job_vacancies!inner(title, project, specific_location, schedule_details)`)
            .eq('status', 'pending_supervisor')
            .in('job_vacancies.project', supervisorProjects); // <-- ✨ السطر الجديد والمهم ✨

        

    if (error) { container.innerHTML = '<p style="color:red;">حدث خطأ.</p>'; return console.error(error); }
    if (applications.length === 0) { container.innerHTML = '<p style="text-align: center;">لا توجد طلبات توظيف جديدة لمراجعتها.</p>'; return; }
    const groupedByVacancy = applications.reduce((acc, app) => {
        const vacancyId = app.vacancy_id;
        if (!acc[vacancyId]) {
            acc[vacancyId] = {
                details: app.job_vacancies,
                applicants: []
            };
        }
        acc[vacancyId].applicants.push(app);
        return acc;
    }, {});

    container.innerHTML = '';
    for (const vacancyId in groupedByVacancy) {
        const group = groupedByVacancy[vacancyId];
        const vacancyDetails = group.details;
        const applicants = group.applicants;

        const groupHtml = `
            <div class="attendance-accordion" style="margin-bottom: 20px;">
                <details open>
                    <summary style="font-size: 1.3rem; display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        ${vacancyDetails.title} - ${vacancyDetails.specific_location || vacancyDetails.project}
                        <small style="display: block; color: var(--accent-color); font-weight: 600;">${createShiftTimeLabel(vacancyDetails.schedule_details?.[0])}</small>
                    </div>
                    <span class="status pending" style="margin-right: auto;">(${applicants.length} متقدم)</span>
                    </summary>
                    <div class="content" style="padding-top: 15px;">
                        ${applicants.map(applicant => `
                            <div class="attendance-card">
                                <span>${applicant.applicant_data.full_name}</span>
                                <div>
                                    <button class="btn btn-secondary btn-sm view-applicant-details-btn" data-appid="${applicant.id}">عرض التفاصيل</button>
                                    <button class="btn btn-success btn-sm nominate-applicant-btn" data-appid="${applicant.id}" data-vid="${vacancyId}">
                                        <i class="ph-bold ph-check-fat"></i> ترشيح
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', groupHtml);
    }
}
async function loadOpsNomineesPage() {
    const container = document.getElementById('ops-nominees-container');
    if (!container || !currentUser || !currentUser.region) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل المرشحين...</p>';
    let query = supabaseClient
    .from('job_applications')
    .select(`*, 
        job_vacancies!inner(title, project, specific_location, region),
        supervisor:supervisor_approver_id (name)
    `)
    .eq('status', 'pending_ops');
if (!currentUser.is_ops_manager && currentUser.role !== 'مدير النظام') {
    query = query.eq('job_vacancies.region', currentUser.region);
}

const { data: applications, error } = await query;

    if (error) { container.innerHTML = '<p style="color:red;">حدث خطأ.</p>'; return console.error(error); }
    if (applications.length === 0) { container.innerHTML = '<p style="text-align: center;">لا يوجد مرشحون جدد لمراجعتهم.</p>'; return; }

    container.innerHTML = '';
    applications.forEach(app => {
        const vacancy = app.job_vacancies;
        const supervisor = app.supervisor;
        const applicant = app.applicant_data;

        const cardHtml = `
        <div class="review-request-card" style="margin-bottom: 20px;">
            <div class="review-request-header status-pending">
                <h4>مرشح لوظيفة: ${vacancy.title}</h4>
                <span class="status-badge">بانتظار الاعتماد</span>
            </div>
            <div class="review-request-body">
                 <div class="request-meta-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="request-meta-item"><i class="ph-bold ph-user"></i><span><strong>المرشح:</strong> ${applicant.full_name}</span></div>
                    <div class="request-meta-item"><i class="ph-bold ph-identification-card"></i><span><strong>الهوية:</strong> ${applicant.id_number}</span></div>
                    <div class="request-meta-item"><i class="ph-bold ph-map-pin"></i><span><strong>لشاغر:</strong> ${vacancy.specific_location || vacancy.project}</span></div>
                    <div class="request-meta-item"><i class="ph-bold ph-user-gear"></i><span><strong>المُرشِّح:</strong> ${supervisor.name}</span></div>
                </div>
            </div>
            <div class="review-request-footer">
                <button class="btn btn-primary ops-review-applicant-btn" data-appid="${app.id}">
                    <i class="ph-bold ph-user-plus"></i> مراجعة واعتماد
                </button>
                <button class="btn btn-danger ops-reject-applicant-btn" data-appid="${app.id}" data-vid="${app.vacancy_id}">
                    <i class="ph-bold ph-x-circle"></i> رفض
                </button>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', cardHtml);
    });
}
async function loadHrOpsHiringPage(tab = 'new') {
    const containerId = (tab === 'new') ? 'hr-ops-hiring-new-container' : 'hr-ops-hiring-archive-container';
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = `<p style="text-align: center;">جاري تحميل...</p>`;
    const statusFilter = (tab === 'new') ? ['approved'] : ['hr_acknowledged'];
let query = supabaseClient
    .from('job_applications')
    .select(`*, job_vacancies!inner(title, project, region)`) // !inner لجلب المنطقة
    .in('status', statusFilter)
    .order('created_at', { ascending: true });
if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
    query = query.eq('job_vacancies.region', currentUser.region);
}

const { data: applications, error } = await query;

    if (error) {
        container.innerHTML = '<p style="color:red;">حدث خطأ في جلب البيانات.</p>';
        return console.error(error);
    }
    if (applications.length === 0) {
        container.innerHTML = `<p style="text-align: center;">لا توجد طلبات في ${tab === 'new' ? 'المراجعات الجديدة' : 'الأرشيف'}.</p>`;
        return;
    }

    container.innerHTML = '';
    applications.forEach(app => {
        const isAcknowledged = app.status === 'hr_acknowledged';
        const cardHtml = `
        <div class="review-request-card" style="margin-bottom: 20px;">
            <div class="review-request-header ${isAcknowledged ? 'status-denied' : 'status-approved'}">
                <h4>توظيف جديد: ${app.applicant_data.full_name}</h4>
                <span class="status-badge">${isAcknowledged ? 'تمت المراجعة' : 'بانتظار المراجعة'}</span>
            </div>
            <div class="review-request-body">
                <p><strong>الوظيفة:</strong> ${app.job_vacancies.title} في مشروع ${app.job_vacancies.project}</p>
                <p><strong>تاريخ التقديم:</strong> ${new Date(app.created_at).toLocaleDateString('ar-SA')}</p>
            </div>
            <div class="review-request-footer">
                <button class="btn btn-secondary view-applicant-details-btn" data-appid="${app.id}"><i class="ph-bold ph-eye"></i> عرض التفاصيل</button>
                <button class="btn btn-primary hr-acknowledge-hire-btn" data-appid="${app.id}" ${isAcknowledged ? 'disabled' : ''}><i class="ph-bold ph-check-square"></i> تأكيد المراجعة ونقل للأرشيف</button>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', cardHtml);
    });
}

let directivePollingInterval = null; // متغير لتخزين عملية التحقق
const notifiedDirectiveIds = new Set(); // لتخزين التوجيهات التي تم التنبيه عنها
function stopPollingForDirectives() {
    if (directivePollingInterval) {
        clearInterval(directivePollingInterval);
        directivePollingInterval = null;
    }
}
async function loadMyDirectivesPage() {
    const page = document.getElementById('page-my-directives');
    const sendTab = page.querySelector('a[data-tab="send-directive-from-supervisor"]');
    const historyTab = page.querySelector('a[data-tab="supervisor-directives-history"]');
    const searchInput = page.querySelector('#directive-search-input');
    if (currentUser.role === 'مشرف') {
        sendTab.style.display = 'flex';
        historyTab.style.display = 'flex';
    } else {
        sendTab.style.display = 'none';
        historyTab.style.display = 'none';
    }
    const incomingContainer = page.querySelector('#my-directives-container');
    incomingContainer.innerHTML = '<p style="text-align: center;">جاري تحميل التوجيهات الواردة...</p>';
    const { data: directives, error: directivesError } = await supabaseClient
        .from('directives').select(`*, sender:sender_id (name, role)`).eq('recipient_id', currentUser.id).order('created_at', { ascending: false });

    if (directivesError) {
        incomingContainer.innerHTML = '<p style="color:red;">خطأ في جلب التوجيهات.</p>';
    } else if (directives.length === 0) {
        incomingContainer.innerHTML = '<div class="empty-state"><i class="ph-bold ph-bell-slash"></i><h4>لا توجد توجيهات</h4><p>لم تستلم أي توجيهات جديدة بعد.</p></div>';
    } else {
        incomingContainer.innerHTML = directives.map(d => {
            const date = formatGregorianDateTime(d.created_at);
            let footer = (d.status === 'pending') ? `<div class="review-request-footer"><button class="btn btn-success directive-action-btn" data-action="accepted" data-directive-id="${d.id}"><i class="ph-bold ph-check"></i> قبول</button><button class="btn btn-danger directive-action-btn" data-action="rejected" data-directive-id="${d.id}"><i class="ph-bold ph-x"></i> رفض</button></div>` : '';
            return `<div class="review-request-card" style="margin-bottom:15px;"><div class="review-request-header status-pending" style="color: var(--text-primary);"><h4>توجيه من: ${d.sender ? d.sender.name : 'غير معروف'}</h4><span class="visit-meta" style="padding:0; border:0; color: #4b5563;">${date}</span></div><div class="review-request-body"><p class="visit-notes">${d.content}</p></div>${footer}</div>`;
        }).join('');
    }
    if (currentUser.role === 'مشرف') {
        const guardsContainer = page.querySelector('#supervisor-guards-list-container');
        
        const fetchAndRenderGuards = async (searchTerm = '') => {
            guardsContainer.innerHTML = '<p style="text-align: center;">جاري تحميل قائمة الحراس...</p>';
            
            const { data: guards, error } = await supabaseClient.rpc('get_supervisor_guards_for_directives', {
                p_supervisor_id: currentUser.id
            });

            if (error) {
                guardsContainer.innerHTML = '<p style="color:red;">خطأ في جلب الحراس.</p>';
                return;
            }

            const filteredGuards = searchTerm
                ? guards.filter(g => g.name.includes(searchTerm) || (g.id_number && g.id_number.includes(searchTerm)))
                : guards;

            if (filteredGuards.length === 0) {
                guardsContainer.innerHTML = '<div class="empty-state"><i class="ph-bold ph-users"></i><h4>لا توجد نتائج</h4><p>لم يتم العثور على حراس يطابقون بحثك.</p></div>';
            } else {
                guardsContainer.innerHTML = filteredGuards.map(guard => `
                    <div class="contract-card">
                        <div class="contract-card-body" style="flex-direction: row; justify-content: space-between; align-items: center;">
                            <div>
                                <h5 style="margin:0 0 5px 0; font-size: 1.2rem;">${guard.name}</h5>
                                <p style="margin:0; color: var(--text-secondary);"><i class="ph-bold ph-map-pin"></i> ${guard.location || 'غير محدد'}</p>
                            </div>
                            <button class="btn btn-primary open-directive-modal-btn" data-recipient-id="${guard.id}" data-recipient-name="${guard.name}">
                                <i class="ph-bold ph-paper-plane-tilt"></i> إرسال
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        };
        searchInput.addEventListener('input', () => {
            fetchAndRenderGuards(searchInput.value);
        });
        fetchAndRenderGuards();
    }
}
async function loadSupervisorSchedulesPage() {
    const container = document.getElementById('supervisor-schedules-container');
    if (!container || !currentUser) return;

    container.innerHTML = '<p style="text-align: center;">جاري تحميل جداول الحراس...</p>';
    const filterStartTime = document.getElementById('ss-filter-shift-start').value;
    const filterEndTime = document.getElementById('ss-filter-shift-end').value;
    const isRangeMode = document.getElementById('ss-filter-range-mode').checked; // <-- الخيار الجديد
    
    const searchTerm = document.getElementById('ss-filter-search').value.toLowerCase();
    const regionVal = document.getElementById('ss-filter-region').value;
    const cityVal = document.getElementById('ss-filter-city').value;
    const projectVal = document.getElementById('ss-filter-project').value;
    const locationVal = document.getElementById('ss-filter-location').value;
    const clearBtn = document.getElementById('ss-clear-time-btn');
    if (clearBtn && !clearBtn.dataset.listener) {
        clearBtn.addEventListener('click', () => {
            document.getElementById('ss-filter-shift-start').value = '';
            document.getElementById('ss-filter-shift-end').value = '';
            document.getElementById('ss-filter-range-mode').checked = false;
            loadSupervisorSchedulesPage();
        });
        clearBtn.dataset.listener = 'true';
    }

    try {
        let query = supabaseClient
            .from('users')
            .select(`*, job_vacancies:users_vacancy_id_fkey(*, contracts(*))`)
            .eq('role', 'حارس أمن')
            .not('employment_status', 'eq', 'مؤرشف');
        if (currentUser.role === 'مشرف') {
            const siteFilterString = createSupervisorSiteFilter(currentUser.assigned_locations);
            query = query.or(siteFilterString);
        } else if (currentUser.role === 'ادارة العمليات' && !currentUser.is_ops_manager) {
             query = query.eq('region', currentUser.region);
        }
        if (regionVal) query = query.eq('region', regionVal);
        if (cityVal) query = query.eq('city', cityVal);
        if (projectVal) query = query.filter('project', 'cs', `{${projectVal}}`);
        if (locationVal) query = query.eq('location', locationVal);

        const { data: guards, error } = await query;
        if (error) throw error;
        let filteredGuards = guards.filter(guard => {
            if (searchTerm) {
                const matchesSearch = (guard.name && guard.name.toLowerCase().includes(searchTerm)) || 
                                      (guard.id_number && guard.id_number.includes(searchTerm));
                if (!matchesSearch) return false;
            }
            if (filterStartTime) {
                const schedule = guard.job_vacancies?.schedule_details?.[0];
                if (!schedule) return false;

                const periods = schedule.periods || [schedule];
                const cleanTime = (t) => t ? t.substring(0, 5) : '';

                return periods.some(p => {
                    const pStart = cleanTime(p.start_time);
                    const pEnd = cleanTime(p.end_time);

                    if (isRangeMode) {
                        if (filterEndTime) {
                            return pStart >= filterStartTime && pStart <= filterEndTime;
                        } else {
                            return pStart >= filterStartTime;
                        }
                    } else {
                        if (filterEndTime) {
                            return pStart === filterStartTime && pEnd === filterEndTime;
                        }
                        return pStart === filterStartTime;
                    }
                });
            }
            return true;
        });

        document.getElementById('ss-stats-total').textContent = filteredGuards.length;

        if (filteredGuards.length === 0) {
            container.innerHTML = '<p style="text-align: center;">لا يوجد حراس يطابقون شروط الفلترة.</p>';
            return;
        }

        container.innerHTML = '';
        filteredGuards.forEach(guard => {
            const schedule = guard.job_vacancies?.schedule_details?.[0];
            const scheduleDetailsHtml = renderFullScheduleDetailsHtml(schedule);
            const projectDisplay = Array.isArray(guard.project) ? guard.project.join(', ') : (guard.project || 'غير محدد');
            const locationDisplay = guard.location || 'غير محدد';
            
            const formattedWhatsAppNumber = formatPhoneNumberForWhatsApp(guard.phone);
            let actionFooter = '';
            let editBtn = '';
            if (currentUser.role === 'مدير النظام' || currentUser.role === 'ادارة العمليات') {
                editBtn = `<button class="btn btn-primary btn-sm edit-guard-schedule-btn" 
                            data-vacancy-id="${guard.vacancy_id}" 
                            data-schedule='${JSON.stringify(schedule || {})}' 
                            title="تعديل الجدول">
                            <i class="ph-bold ph-pencil-simple"></i> تعديل الجدول
                           </button>`;
            }

            actionFooter = `<div class="contract-card-footer" style="justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    ${guard.phone ? `<a href="https://wa.me/${formattedWhatsAppNumber}" target="_blank" class="btn btn-success btn-sm"><i class="ph-bold ph-whatsapp-logo"></i></a>` : ''}
                    ${guard.phone ? `<a href="tel:${guard.phone}" class="btn btn-secondary btn-sm"><i class="ph-bold ph-phone-call"></i></a>` : ''}
                </div>
                ${editBtn}
            </div>`;

            const cardHtml = `
                <div class="contract-card">
                    <div class="contract-card-header">
                        <h4>${guard.name}</h4>
                    </div>
                    <div class="contract-card-body">
                        <div class="info-line" style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
                            <i class="ph-bold ph-map-pin"></i><strong>الموقع:</strong> ${projectDisplay} / ${locationDisplay}
                        </div>
                        <div class="info-line">
                            <i class="ph-bold ph-phone"></i><strong>رقم الجوال:</strong> ${guard.phone || 'غير مسجل'}
                        </div>
                        ${scheduleDetailsHtml}
                    </div>
                    ${actionFooter}
                </div>`;
            
            container.insertAdjacentHTML('beforeend', cardHtml);
        });

    } catch (error) {
        container.innerHTML = `<p style="color:red;">حدث خطأ في جلب البيانات: ${error.message}</p>`;
        console.error(error);
    }
}
function renderCoverageNeedCard(need) {
    const isAbsenceNeed = !!need.absent_guard_id;
    const title = isAbsenceNeed ? `غياب: ${need.absent_guard_name}` : need.absent_guard_name; 
    const location = isAbsenceNeed ? `${(need.project || []).join('')} - ${need.location}` : need.location;
    const shiftTime = createShiftTimeLabel(need.schedule_details[0]);

    const needData = JSON.stringify(need);

    return `
        <div class="kanban-card" style="border-left-color: var(--denied-color);">
            <h5>${title}</h5>
            <p><i class="ph-bold ph-map-pin"></i> ${location}</p>
            <p><i class="ph-bold ph-clock"></i> ${shiftTime}</p>
            <div class="card-footer">
                <button class="btn btn-primary btn-sm publish-coverage-btn" data-need='${needData}'>
                    <i class="ph-bold ph-arrow-circle-right"></i> طرح للتغطية
                </button>
            </div>
        </div>
    `;
}
function renderCoverageOpportunityCard(shift) {
    return `
        <div class="kanban-card" style="border-left-color: var(--approved-color);">
            <h5>${shift.project}</h5>
            <p><i class="ph-bold ph-info"></i> ${shift.reason || 'سبب غير محدد'}</p>
            <p><i class="ph-bold ph-map-pin"></i> ${shift.location}</p>
            <p><i class="ph-bold ph-money"></i> ${shift.coverage_pay} ر.س</p>
            <p><i class="ph-bold ph-clock"></i> ${createShiftTimeLabel(shift)}</p>
            <div class="card-footer" style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                <button class="btn btn-secondary btn-sm edit-coverage-btn" data-shift-id="${shift.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i></button>
                <button class="btn btn-danger btn-sm delete-coverage-btn" data-shift-id="${shift.id}" title="حذف"><i class="ph-bold ph-trash"></i></button>
            </div>
        </div>
    `;
}
function renderCoverageReviewCard(shift) {
    return `
        <div class="kanban-card" style="border-left-color: var(--pending-color);">
            <h5>${shift.project}</h5>
            <p><i class="ph-bold ph-info"></i> ${shift.reason || 'سبب غير محدد'}</p>
            <p><i class="ph-bold ph-map-pin"></i> ${shift.location}</p>
            <p><i class="ph-bold ph-users"></i> ${shift.applicant_count} متقدم</p>
            <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-secondary btn-sm review-applicants-btn" data-shift-id="${shift.id}">
                    <i class="ph-bold ph-user-list"></i> مراجعة المتقدمين
                </button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-sm edit-coverage-btn" data-shift-id="${shift.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i></button>
                    <button class="btn btn-danger btn-sm delete-coverage-btn" data-shift-id="${shift.id}" title="حذف"><i class="ph-bold ph-trash"></i></button>
                </div>
            </div>
        </div>
    `;
}
function renderCoverageFilledCard(shift) {
    const assignedApplicant = shift.coverage_applicants[0];
    const assignedGuardName = assignedApplicant?.users?.name || assignedApplicant?.full_name || 'غير معروف';
    const assignedGuardId = assignedApplicant?.users?.id || null;

    const cancelButtonHtml = assignedGuardId ? `
        <button class="btn btn-danger btn-sm cancel-assignment-btn" data-guard-id="${assignedGuardId}" data-guard-name="${assignedGuardName}" title="إلغاء تكليف هذا الحارس">
            <i class="ph-bold ph-user-minus"></i> استبعاد
        </button>
    ` : '';

    return `
        <div class="kanban-card" style="border-left-color: #6b7280;">
            <div style="padding: 15px;">
                <h5>${shift.project}</h5>
                <p><i class="ph-bold ph-info"></i> ${shift.reason || 'سبب غير محدد'}</p>
                <p><i class="ph-bold ph-map-pin"></i> ${shift.location}</p>
                <p><i class="ph-bold ph-user-circle-check"></i> <strong>تم التسكين:</strong> ${assignedGuardName}</p>
                <p><i class="ph-bold ph-clock"></i> ${createShiftTimeLabel(shift)}</p>
            </div>
            <div class="card-footer" style="justify-content: flex-end;">
                ${cancelButtonHtml}
            </div>
        </div>
    `;
}
async function loadCoverageKanbanPage() {
    const needsCol = document.getElementById('coverage-needs-column');
    const openCol = document.getElementById('coverage-open-column');
    const reviewCol = document.getElementById('coverage-review-column');
    const filledCol = document.getElementById('coverage-filled-column');
    [needsCol, openCol, reviewCol, filledCol].forEach(col => {
        if (col && !col.hasChildNodes()) {
             col.innerHTML = '<p style="text-align: center; padding: 20px;">جاري التحميل...</p>';
        }
    });

    try {
    let openShiftsQuery = supabaseClient.from('coverage_shifts').select(`*, coverage_applicants(count)`).eq('status', 'open').order('created_at');
    let reviewShiftsQuery = supabaseClient.from('coverage_shifts').select(`*, coverage_applicants(count)`).in('status', ['pending_supervisor', 'pending_ops']).order('created_at');
    let filledShiftsQuery = supabaseClient.from('coverage_shifts').select(`*, coverage_applicants!inner(full_name, users:applicant_user_id(id, name))`).eq('status', 'closed').order('created_at');
    if (currentUser.role === 'ادارة العمليات' && currentUser.region && !currentUser.is_ops_manager) {
        openShiftsQuery = openShiftsQuery.eq('region', currentUser.region);
        reviewShiftsQuery = reviewShiftsQuery.eq('region', currentUser.region);
        filledShiftsQuery = filledShiftsQuery.eq('region', currentUser.region);
    } else if (currentUser.role === 'مشرف' && currentUser.assigned_locations && currentUser.assigned_locations.length > 0) {
        const supervisorProjects = [...new Set(currentUser.assigned_locations.map(loc => loc.contract))];
        openShiftsQuery = openShiftsQuery.in('project', supervisorProjects);
        reviewShiftsQuery = reviewShiftsQuery.in('project', supervisorProjects);
        filledShiftsQuery = filledShiftsQuery.in('project', supervisorProjects);
    }
let p_region = null;
let p_projects = null;

if (currentUser.role === 'ادارة العمليات' && currentUser.region && !currentUser.is_ops_manager) {
    p_region = currentUser.region;
} else if (currentUser.role === 'مشرف' && currentUser.assigned_locations && currentUser.assigned_locations.length > 0) {
    p_projects = [...new Set(currentUser.assigned_locations.map(loc => loc.contract))];
}
const [
    { data: openShifts, error: e1 },
    { data: underReviewShifts, error: e2 },
    { data: filledShifts, error: e3 },
    { data: absentGuards, error: e4 },
    { data: manpowerShortages, error: e5 }
] = await Promise.all([
    openShiftsQuery,
    reviewShiftsQuery,
    filledShiftsQuery,
    supabaseClient.rpc('get_absent_guards_for_coverage', { p_region, p_projects }),
    supabaseClient.rpc('get_manpower_shortages_for_coverage', { p_region, p_projects })
]);

        if (e1 || e2 || e3 || e4 || e5) throw new Error("فشل في جلب بعض بيانات التغطية.");
        const allNeeds = [...(absentGuards || []), ...(manpowerShortages || [])];
        if (needsCol) {
            if (allNeeds.length > 0) {
                needsCol.innerHTML = allNeeds.map(renderCoverageNeedCard).join('');
            } else {
                needsCol.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد احتياجات حالياً.</p>';
            }
        }
        const availableOpportunities = openShifts.filter(s => s.coverage_applicants[0].count === 0);
         if (openCol) {
            if (availableOpportunities.length > 0) {
                openCol.innerHTML = availableOpportunities.map(renderCoverageOpportunityCard).join('');
            } else {
                openCol.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد فرص متاحة.</p>';
            }
        }
        const reviewOpportunities = [...openShifts.filter(s => s.coverage_applicants[0].count > 0), ...underReviewShifts].map(s => ({...s, applicant_count: s.coverage_applicants[0].count }));
        if (reviewCol) {
            if (reviewOpportunities.length > 0) {
                reviewCol.innerHTML = reviewOpportunities.map(renderCoverageReviewCard).join('');
            } else {
                reviewCol.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد طلبات للمراجعة.</p>';
            }
        }
        if (filledCol) {
            if (filledShifts.length > 0) {
                filledCol.innerHTML = filledShifts.map(renderCoverageFilledCard).join('');
            } else {
                filledCol.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد تغطيات مسكنة.</p>';
            }
        }
        if (activeSubscription) {
            supabaseClient.removeChannel(activeSubscription);
            activeSubscription = null;
        }
        activeSubscription = supabaseClient
            .channel('coverage-kanban-realtime')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, () => loadCoverageKanbanPage())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'job_vacancies' }, () => loadCoverageKanbanPage())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'coverage_shifts' }, () => loadCoverageKanbanPage())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'coverage_applicants' }, () => loadCoverageKanbanPage())
            .subscribe();


        console.log('Realtime subscription for Kanban board is active.');

    } catch (error) {
        console.error("Error loading Kanban page:", error);
        if(needsCol) needsCol.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
let inventoryPageSubscription = null; // متغير لتخزين الاشتراك المباشر

async function loadInventoryPage() {
    const container = document.getElementById('inventory-cards-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل فئات المخزون...</p>';
    if (inventoryPageSubscription) {
        supabaseClient.removeChannel(inventoryPageSubscription);
        inventoryPageSubscription = null;
    }

    try {
        const { data: stats, error: statsError } = await supabaseClient.rpc('get_detailed_asset_stats');
        if (statsError) throw statsError;
        const { count: vehicleCount, error: vehicleError } = await supabaseClient.from('vehicles').select('*', { count: 'exact', head: true });
        if (vehicleError) throw vehicleError;
        
        const statsMap = new Map(stats.map(s => [s.category_name, s]));
        let cardsHtml = '';
        const cardOrder = ['المركبات', 'أجهزة برافو']; // لترتيب البطاقات الرئيسية أولاً
        cardOrder.forEach(name => {
            const stat = statsMap.get(name);
            if (stat) {
                const isVehicle = name === 'المركبات';
                const count = isVehicle ? vehicleCount : stat.total_count;
                const icon = isVehicle ? 'ph-car' : 'ph-broadcast';
                const color = isVehicle ? '#6366f1' : '#3b82f6';

                cardsHtml += `
                <div class="request-action-card" style="text-align: right; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; background-color: ${color};">
                    <div>
                        <i class="ph-fill ${icon}" style="display: block; text-align: right; font-size: 3rem; margin-bottom: 10px;"></i>
                        <h4 style="text-align: right;">${name}</h4>
                        <div class="inventory-stats-grid">
                            <div><span>الإجمالي</span><strong>${count}</strong></div>
                            ${!isVehicle ? `
                            <div><span>متوفر</span><strong>${stat.in_stock_count}</strong></div>
                            <div><span>مسلمة</span><strong>${stat.assigned_count}</strong></div>` : '<div colspan="2"></div>'}
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary manage-inventory-btn" data-inventory-id="${stat.category_id}" data-category-name="${name}" style="width:100%;">
                            <i class="ph-bold ph-list-dashes"></i> إدارة
                        </button>
                    </div>
                </div>`;
                statsMap.delete(name); // إزالتها من الخريطة لمنع تكرارها
            }
        });
        statsMap.forEach((stat, name) => {
            cardsHtml += `
                <div class="request-action-card" style="text-align: right; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; background-color: #4b5563;">
                    <div>
                        <i class="ph-fill ph-cube" style="display: block; text-align: right; font-size: 3rem; margin-bottom: 10px;"></i>
                        <h4 style="text-align: right;">${name}</h4>
                        <div class="inventory-stats-grid">
                            <div><span>الإجمالي</span><strong>${stat.total_count}</strong></div>
                            <div><span>متوفر</span><strong>${stat.in_stock_count}</strong></div>
                            <div><span>مسلمة</span><strong>${stat.assigned_count}</strong></div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary manage-inventory-btn" data-inventory-id="${stat.category_id}" data-category-name="${name}">
                            <i class="ph-bold ph-list-dashes"></i> إدارة القطع
                        </button>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary edit-inventory-category-btn" data-id="${stat.category_id}" style="flex-grow: 1;">
                                <i class="ph-bold ph-pencil-simple"></i> تعديل الفئة
                            </button>
                            <button class="btn btn-danger delete-inventory-category-btn" data-id="${stat.category_id}" data-name="${name}" title="حذف الفئة" style="min-width: 44px;">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = cardsHtml;
        inventoryPageSubscription = supabaseClient
            .channel('public:inventory_stats')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'asset_items' }, () => {
                console.log('Change detected in asset_items, reloading inventory stats.');
                loadInventoryPage();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'vehicles' }, () => {
                console.log('Change detected in vehicles, reloading inventory stats.');
                loadInventoryPage();
            })
            .subscribe();

    } catch (err) {
        container.innerHTML = `<p style="text-align:center; color:red;">${err.message}</p>`;
    }
}
async function exportInventoryDetailsToExcel() {
    const title = document.getElementById('inventory-details-title').textContent;
    const table = document.getElementById('inventory-details-table');
    if (!table) return showToast('لا توجد بيانات لتصديرها.', 'error');

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('تفاصيل العهدة');
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
    worksheet.addRow(headers);
    table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = Array.from(row.querySelectorAll('td')).map(td => td.textContent);
        worksheet.addRow(rowData);
    });
    worksheet.getRow(1).font = { bold: true };
    worksheet.columns.forEach(column => { column.width = 20; });

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${title}.xlsx`;
    link.click();
}
async function populateInventoryDetailsModal(inventoryId, categoryName) {
    const modal = document.getElementById('inventory-details-modal');
    const titleEl = document.getElementById('inventory-details-title');
    const tableContainer = document.getElementById('inventory-details-table-container');
    const addItemBtn = document.getElementById('add-item-from-details-btn');

    titleEl.textContent = `إدارة: ${categoryName}`;
    tableContainer.innerHTML = '<p style="text-align: center;">جاري تحميل القطع...</p>';

    try {
        let headers = [];
        let rowsHtml = '';

        if (categoryName === 'المركبات') {
            addItemBtn.innerHTML = '<i class="ph-bold ph-plus"></i> إضافة سيارة جديدة';
            const { data: vehicles, error } = await supabaseClient.from('vehicles').select('*, employee:assigned_employee_id(name)').order('created_at', { ascending: false });
            if (error) throw error;

            document.getElementById('inv-details-stat-total').textContent = vehicles.length;
            document.getElementById('inv-details-stat-instock').textContent = vehicles.filter(v => v.status === 'متوفر').length;
            document.getElementById('inv-details-stat-assigned').textContent = vehicles.filter(v => v.assigned_employee_id).length;
            document.getElementById('inv-details-stat-maintenance').textContent = vehicles.filter(v => v.status === 'صيانة').length;

            headers = ['نوع المركبة', 'رقم اللوحة', 'انتهاء الاستمارة', 'الحالة', 'الموظف المستلم', 'إجراءات'];
            rowsHtml = vehicles.map(v => `
                <tr data-searchable-text="${(v.vehicle_type || '').toLowerCase()} ${(v.license_plate || '').toLowerCase()} ${v.employee ? v.employee.name.toLowerCase() : ''}">
                    <td>${v.vehicle_type}</td>
                    <td>${v.license_plate}</td>
                    <td>${formatGregorianDate(v.registration_expiry_date)}</td>
                    <td><span class="status ${v.status === 'فعالة' ? 'active' : 'inactive'}">${v.status}</span></td>
                    <td>${v.employee ? v.employee.name : '-'}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-vehicle-btn" data-id="${v.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i> تعديل</button>
                    </td>
                </tr>
            `).join('');

        } else {
            addItemBtn.innerHTML = '<i class="ph-bold ph-plus"></i> إضافة قطعة جديدة';
            const { data: category, error: catError } = await supabaseClient.from('assets_inventory').select('defined_fields').eq('id', inventoryId).single();
            const { data: items, error: itemsError } = await supabaseClient.from('asset_items').select('*, employee:assigned_to_user_id(name)').eq('inventory_id', inventoryId).order('created_at', { ascending: false });
            if (catError || itemsError) throw catError || itemsError;

            document.getElementById('inv-details-stat-total').textContent = items.length;
            document.getElementById('inv-details-stat-instock').textContent = items.filter(i => i.status === 'متوفر في المخزن').length;
            document.getElementById('inv-details-stat-assigned').textContent = items.filter(i => i.status === 'مسلمة لموظف' || i.status === 'مسلمة لموقع').length;
            document.getElementById('inv-details-stat-maintenance').textContent = items.filter(i => i.status === 'صيانة').length;

            if (items.length === 0) {
                tableContainer.innerHTML = '<div class="empty-state"><i class="ph-bold ph-cube"></i><h4>المخزون فارغ</h4><p>لم يتم إضافة أي قطع لهذه الفئة بعد.</p></div>';
                return;
            }

            const fields = category.defined_fields || [];
            if (fields.length === 0 && items[0]?.details) {
                Object.keys(items[0].details).forEach(key => fields.push({ name: key }));
            }

            headers = [...fields.map(f => f.name), 'الحالة', 'المستلم', 'تاريخ التسليم', 'إجراءات'];

            rowsHtml = items.map(item => {
                const fieldCells = fields.map(f => `<td>${item.details[f.name] || '-'}</td>`).join('');
                const statusClass = item.status === 'متوفر في المخزن' ? 'active' : (item.status === 'مسلمة لموظف' || item.status === 'مسلمة لموقع' ? 'inactive' : 'pending');
                return `
                    <tr data-searchable-text="${Object.values(item.details || {}).join(' ').toLowerCase()} ${item.employee ? item.employee.name.toLowerCase() : ''}">
                        ${fieldCells}
                        <td><span class="status ${statusClass}">${item.status}</span></td>
                        <td>${item.employee ? item.employee.name : (item.location_name || '-')}</td>
                        <td>${item.assignment_date ? formatGregorianDate(item.assignment_date) : '-'}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-secondary btn-sm view-asset-history-btn" data-id="${item.id}" title="عرض السجل"><i class="ph-bold ph-list-dashes"></i></button>
                                <button class="btn btn-secondary btn-sm edit-admin-asset-btn" data-id="${item.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i></button>
                                <button class="btn btn-danger btn-sm delete-asset-item-btn" data-id="${item.id}" title="حذف"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        }

        tableContainer.innerHTML = `
            <table id="inventory-details-table">
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${rowsHtml}</tbody>
            </table>`;

    } catch (error) {
        tableContainer.innerHTML = `<p style="color:red;">حدث خطأ: ${error.message}</p>`;
    }
}
/**
 * دالة جديدة لتوليد حقول إدخال ديناميكية بناءً على قالب الفئة
 * @param {Array<object>} fields - مصفوفة الحقول المعرفة للفئة
 * @param {number} itemNumber - رقم القطعة التي يتم إضافتها (للعرض فقط)
 * @returns {string} - كود HTML للحقول
 */
function generateDynamicAssetItemFields(fields, itemNumber = 1) {
    if (!fields || fields.length === 0) {
        return `
            <div class="form-group asset-item-group">
                <strong>#${itemNumber}</strong>
                <div class="form-group">
                    <label>المعرّف / الرقم التسلسلي</label>
                    <input type="text" class="asset-detail" data-key="identifier" required>
                </div>
            </div>`;
    }
    const fieldsHtml = fields.map(field => `
        <div class="form-group">
            <label>${field.name}</label>
            <input type="text" class="asset-detail" data-key="${field.name}">
        </div>
    `).join('');

    return `
        <div class="form-group asset-item-group" style="padding: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
            <strong style="display: block; margin-bottom: 10px;">#${itemNumber}</strong>
            <div class="form-grid">${fieldsHtml}</div>
        </div>`;
}
async function fetchVisits() {
    const visitsContent = document.querySelector('#page-visits');
    visitsContent.innerHTML = `
        <div class="page-header"><h3>سجل الميدان</h3></div>
        <div class="tabs">
            <a href="#" class="tab-link active" data-tab="visits-log"><i class="ph-bold ph-car-profile"></i> سجل الزيارات</a>
            <a href="#" class="tab-link" data-tab="patrols-log"><i class="ph-bold ph-footprints"></i> سجل الجولات</a>
        </div>
        <div id="visits-log" class="tab-content active">
            <div id="visits-list-container"><p style="text-align: center;">جاري تحميل سجل الزيارات...</p></div>
        </div>
        <div id="patrols-log" class="tab-content">
            <div id="patrols-list-container"><p style="text-align: center;">جاري تحميل سجل الجولات...</p></div>
        </div>
    `;

    const listContainer = document.querySelector('#visits-list-container');

    try {
        const { data: visits, error: visitsError } = await supabaseClient
            .from('visits')
            .select('*')
            .order('visit_time', { ascending: false });

        if (visitsError) throw visitsError;

        if (visits.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center;">لا توجد زيارات مسجلة حالياً.</p>';
            return;
        }
        const userIds = [...new Set(visits.map(v => v.user_id).filter(Boolean))];
        const { data: users, error: usersError } = await supabaseClient
            .from('users')
            .select('auth_user_id, name, project, region')
            .in('auth_user_id', userIds);

        if (usersError) throw usersError;
        const usersMap = new Map(users.map(u => [u.auth_user_id, u]));
        const enrichedVisits = visits.map(visit => {
            return {
                ...visit,
                users: usersMap.get(visit.user_id) // إضافة بيانات المستخدم لكل زيارة
            };
        });
        let filteredVisits = enrichedVisits.filter(v => v.users); // استبعاد أي زيارات لم نجد لها مستخدم
        if (currentUser.role === 'ادارة العمليات' && currentUser.region) {
            filteredVisits = filteredVisits.filter(v => v.users.region === currentUser.region);
        } else if (currentUser.role === 'مشرف') {
             filteredVisits = filteredVisits.filter(v => v.user_id === currentUser.auth_user_id);
        }

        if (filteredVisits.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center;">لا توجد زيارات مسجلة في نطاق صلاحياتك حالياً.</p>';
            return;
        }
        listContainer.innerHTML = '';
        filteredVisits.forEach(visit => {
            const formattedDateTime = formatGregorianDateTime(visit.visit_time);
            let locationDisplay = 'غير محدد';
            if (visit.visit_snapshot && visit.visit_snapshot.location_info) {
                const info = visit.visit_snapshot.location_info;
                locationDisplay = `${info.contract_name} - ${info.site_name}`;
            } else {
                locationDisplay = `${(visit.users.project || []).join(', ')} - ${visit.location_name}`;
            }

            const card = `
                <div class="visit-card">
                    <div class="visit-icon"><i class="ph-fill ph-car-profile"></i></div>
                    <div class="visit-details">
                        <h4>زيارة إلى: ${locationDisplay}</h4>
                        <p class="visit-meta">
                            <span><i class="ph-bold ph-user-circle"></i> المشرف: ${visit.users.name}</span>
                            <span><i class="ph-bold ph-calendar"></i> ${formattedDateTime}</span>
                        </p>
                        <p class="visit-notes">${visit.notes || 'لا توجد ملاحظات.'}</p>
                    </div>
                </div>
            `;
            listContainer.insertAdjacentHTML('beforeend', card);
        });

    } catch (error) {
        console.error('خطأ في جلب الزيارات:', error);
        listContainer.innerHTML = `<p style="text-align: center; color: red;">حدث خطأ أثناء تحميل الزيارات. (${error.message})</p>`;
    }
}
async function loadAnnouncementsPage() {
    const container = document.getElementById('announcements-list-container');
    const form = document.getElementById('announcement-form');
    form.reset();
    document.getElementById('announcement-id').value = '';

    container.innerHTML = '<p style="text-align: center;">جاري تحميل الإعلانات...</p>';

    const { data: announcements, error } = await supabaseClient
        .from('announcements')
        .select('*')
        .order('start_date', { ascending: false });

    if (error) {
        container.innerHTML = '<p style="color:red;">حدث خطأ في جلب الإعلانات.</p>';
        return;
    }

    if (announcements.length === 0) {
        container.innerHTML = '<p style="text-align: center;">لا توجد إعلانات لعرضها.</p>';
        return;
    }

    container.innerHTML = announcements.map(ann => {
        const now = new Date();
        const startDate = new Date(ann.start_date);
        const endDate = new Date(ann.end_date);
        let status, statusClass;

        if (!ann.is_active) {
            status = 'غير نشط'; statusClass = 'inactive';
        } else if (now >= startDate && now <= endDate) {
            status = 'فعال الآن'; statusClass = 'active';
        } else if (now < startDate) {
            status = 'مجدول'; statusClass = 'pending';
        } else {
            status = 'منتهي'; statusClass = 'inactive';
        }

        return `
        <div class="announcement-manage-card type-${ann.type}">
            <div class="review-request-body">
                <p class="content-text">${ann.content}</p>
                <div class="meta-info">
                    <span><strong>الحالة:</strong> <span class="status ${statusClass}">${status}</span></span>
                    <span><strong>النوع:</strong> ${ann.type}</span>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary btn-sm edit-announcement-btn" data-id="${ann.id}"><i class="ph-bold ph-pencil-simple"></i> تعديل</button>
                    <button class="btn btn-danger btn-sm delete-announcement-btn" data-id="${ann.id}"><i class="ph-bold ph-trash"></i> حذف</button>
                </div>
            </div>
        </div>
        `;
    }).join('');
}
async function loadPatrolsHistory() {
    const container = document.getElementById('patrols-list-container');
    if (!container || !currentUser) return;
    if (currentUser.role === 'مشرف' && (!currentUser.project || currentUser.project.length === 0)) {
        container.innerHTML = '<p style="text-align: center;">لا يمكن عرض سجل الجولات لأنك غير معين على مشروع.</p>';
        return;
    }
    if (currentUser.role === 'ادارة العمليات' && !currentUser.region) {
        container.innerHTML = '<p style="text-align: center;">لا يمكن عرض سجل الجولات لأنك غير معين على منطقة.</p>';
        return;
    }

    container.innerHTML = '<p style="text-align: center;">جاري تحميل سجل الجولات...</p>';

    try {
        let query = supabaseClient
            .from('patrols')
            .select(`*, supervisor:supervisor_id!inner(name, project, region)`)
            .eq('status', 'completed')
            .order('start_time', { ascending: false });
        if (currentUser.role === 'ادارة العمليات' && !currentUser.is_ops_manager) {
            query = query.eq('supervisor.region', currentUser.region);
        } else if (currentUser.role === 'مشرف') {
            query = createProjectFilter(query, currentUser.project, 'supervisor.project');
        }

        const { data: patrols, error } = await query;

        if (error) throw error;

        if (patrols.length === 0) {
            container.innerHTML = '<p style="text-align: center;">لا توجد جولات مكتملة لعرضها في نطاق صلاحياتك.</p>';
            return;
        }

        container.innerHTML = '';
        patrols.forEach(patrol => {
            const startTime = new Date(patrol.start_time);
            const endTime = new Date(patrol.end_time);
            const durationMs = endTime - startTime;
            const durationMinutes = Math.round(durationMs / 60000);

            const card = `
                <div class="visit-card" style="border-right-color: #16a34a;">
                    <div class="visit-icon" style="color: #16a34a;"><i class="ph-fill ph-footprints"></i></div>
                    <div class="visit-details">
                        <h4>جولة للمشرف: ${patrol.supervisor ? patrol.supervisor.name : 'غير معروف'}</h4>
                        <p class="visit-meta">
                            <span><i class="ph-bold ph-calendar-check"></i> ${formatGregorianDate(startTime)}</span>
                            <span><i class="ph-bold ph-clock"></i> من ${startTime.toLocaleTimeString('en-US', {timeStyle: 'short'})} إلى ${endTime.toLocaleTimeString('en-US', {timeStyle: 'short'})}</span>
                            <span><i class="ph-bold ph-timer"></i> المدة: ${durationMinutes} دقيقة</span>
                        </p>
                        <p class="visit-notes">${patrol.notes || 'لا توجد ملاحظات.'}</p>
                    </div>
                    <div class="visit-actions">
                        <button class="btn btn-secondary view-patrol-path-btn" data-patrol-id="${patrol.id}">
                            <i class="ph-bold ph-map-trifold"></i> عرض المسار
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', card);
        });
    } catch (err) {
        container.innerHTML = `<p style="text-align: center; color: red;">حدث خطأ في جلب السجل: ${err.message}</p>`;
        console.error("Error loading patrols history:", err);
    }
}
async function loadVacancyTabData() {
    const listContainer = document.getElementById('vacancies-list-container');
    const requiredEl = document.getElementById('hr-stats-required');
    const assignedEl = document.getElementById('hr-stats-assigned');
    const gapEl = document.getElementById('hr-stats-gap');

    if (!listContainer) return;
    listContainer.innerHTML = '<p style="text-align: center;">جاري تحميل الشواغر...</p>';
    [requiredEl, assignedEl, gapEl].forEach(el => {
        if (el) el.textContent = '...';
    });

    try {
        const regionVal = document.getElementById('vc-filter-region').value || null;
        const cityVal = document.getElementById('vc-filter-city').value || null;
        const projectVal = document.getElementById('vc-filter-project').value || null;
        const locationVal = document.getElementById('vc-filter-location').value || null;
        const statusVal = document.getElementById('vc-filter-status').value;

        let vacanciesQuery = supabaseClient.from('job_vacancies').select('*, contracts(company_name)');
if (currentUser.region) {
    if (currentUser.role === 'ادارة الموارد البشرية' && !currentUser.is_hr_manager) {
        vacanciesQuery = vacanciesQuery.eq('region', currentUser.region);
    }
    else if (currentUser.role === 'ادارة العمليات' && !currentUser.is_ops_manager) {
        vacanciesQuery = vacanciesQuery.eq('region', currentUser.region);
    }
}
        if (regionVal) vacanciesQuery = vacanciesQuery.eq('region', regionVal);
        if (cityVal) vacanciesQuery = vacanciesQuery.eq('location', cityVal);
        if (projectVal) vacanciesQuery = vacanciesQuery.eq('project', projectVal);
        if (locationVal) vacanciesQuery = vacanciesQuery.eq('specific_location', locationVal);
        const { data: vacancies, error: vacanciesError } = await vacanciesQuery.order('created_at', { ascending: false });
        if (vacanciesError) throw vacanciesError;

        let assignedUsersQuery = supabaseClient.from('users').select('id, name, vacancy_id').not('vacancy_id', 'is', null);
if ((currentUser.role === 'ادارة الموارد البشرية' || currentUser.role === 'ادارة العمليات') && currentUser.region) {
    assignedUsersQuery = assignedUsersQuery.eq('region', currentUser.region);
}
        if (regionVal) assignedUsersQuery = assignedUsersQuery.eq('region', regionVal);
        if (cityVal) assignedUsersQuery = assignedUsersQuery.eq('city', cityVal);
        if (projectVal) assignedUsersQuery = assignedUsersQuery.filter('project', 'cs', `{${projectVal}}`);
        if (locationVal) assignedUsersQuery = assignedUsersQuery.eq('location', locationVal);
        const { data: assignedUsers, error: assignedUsersError } = await assignedUsersQuery;
        if (assignedUsersError) throw assignedUsersError;
let allAssignedUsersQuery = supabaseClient.from('users').select('id, name, vacancy_id').not('vacancy_id', 'is', null);
if ((currentUser.role === 'ادارة الموارد البشرية' || currentUser.role === 'ادارة العمليات') && currentUser.region) {
    allAssignedUsersQuery = allAssignedUsersQuery.eq('region', currentUser.region);
}
const { data: allAssignedUsers, error: allAssignedUsersError } = await allAssignedUsersQuery;
        if (allAssignedUsersError) throw allAssignedUsersError;
const { data: totalRequired, error: requiredError } = await supabaseClient.rpc('calculate_required_guards', {
    region_filter: regionVal || ((currentUser.role === 'ادارة الموارد البشرية' || currentUser.role === 'ادارة العمليات') ? currentUser.region : null),
    city_filter: cityVal,
    project_filter: projectVal,
    location_filter: locationVal
});
        if(requiredError) throw requiredError;

        const finalVacancies = vacancies.filter(vacancy => {
            if (!statusVal) return true;
            const isAssigned = allAssignedUsers.some(u => u.vacancy_id === vacancy.id);
            if (statusVal === 'open') return vacancy.status === 'open';
            if (statusVal === 'closed_assigned') return vacancy.status === 'closed' && isAssigned;
            if (statusVal === 'closed_empty') return vacancy.status === 'closed' && !isAssigned;
            return true;
        });

        const totalAssigned = assignedUsers.length;
        const gapValue = totalRequired - totalAssigned;

        requiredEl.textContent = totalRequired;
        assignedEl.textContent = totalAssigned;
        gapEl.textContent = gapValue > 0 ? gapValue : 0;


        if (gapValue > 0) { gapEl.classList.add('highlight-red'); } 
        else { gapEl.classList.remove('highlight-red'); }

        vacanciesExportData = finalVacancies.map(vacancy => {
{
    const assignedUser = allAssignedUsers.find(u => u.vacancy_id === vacancy.id);
    const shift = vacancy.schedule_details?.[0];
    const totalSalary = (vacancy.base_salary || 0) + (vacancy.housing_allowance || 0) + (vacancy.transport_allowance || 0) + (vacancy.other_allowances || 0);
    let statusText = '';
    if (vacancy.status === 'open') {
        statusText = 'مفتوح';
    } else {
        statusText = assignedUser ? `مغلق (${assignedUser.name})` : 'مغلق (فارغ)';
    }
    let shiftDescription = 'غير محدد';
    if (shift) {
        const defaultTime = createShiftTimeLabel({ periods: shift.periods });
        shiftDescription = `${shift.name || 'وردية'} ${defaultTime}`;
        if (shift.day_overrides && Object.keys(shift.day_overrides).length > 0) {
            shiftDescription += ' (مع استثناءات)';
        }
    }

    return {
        project: vacancy.project || (vacancy.contracts ? vacancy.contracts.company_name : 'غير محدد'),
        assigned_user: assignedUser ? assignedUser.name : 'لا يوجد',
        status: statusText,
        region: vacancy.region || 'غير محدد',
        city: vacancy.location || 'غير محدد',
        location: vacancy.specific_location || 'غير محدد',
        shift: shiftDescription, // <-- استخدام الوصف الجديد
        total_salary: totalSalary
    };
}
        });

        if (finalVacancies.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center;">لا توجد شواغر تطابق شروط الفلترة.</p>';
            return;
        }

        listContainer.innerHTML = `<div class="table-container"><table><thead><tr><th>المسمى الوظيفي</th><th>المشروع</th><th>الموقع المحدد</th><th>الحالة / الموظف المسؤول</th><th>إجراءات</th></tr></thead><tbody id="vacancies-table-body"></tbody></table></div>`;
        const tableBody = document.getElementById('vacancies-table-body');
        finalVacancies.forEach(vacancy => {
            const assignedUser = allAssignedUsers.find(u => u.vacancy_id === vacancy.id);
            let statusHtml;
            if (vacancy.status === 'open') {
                statusHtml = `<span class="status active" style="background-color: #dcfce7; color: #166534;">مفتوح</span>`;
            } else if (assignedUser) {
                statusHtml = `<span class="status inactive" style="background-color: #fee2e2; color: #991b1b;">مغلق (${assignedUser.name})</span>`;
            } else {
                statusHtml = `<span class="status pending" style="background-color: #fef9c3; color: #854d0e;">مغلق (فارغ)</span>`;
            }
            let deleteButtonHtml = '';
            if (currentUser.role === 'مدير النظام' || currentUser.can_delete_vacancies) {
                deleteButtonHtml = `<button class="btn-action delete-vacancy-btn" data-id="${vacancy.id}" title="حذف"><i class="ph-bold ph-trash"></i></button>`;
            }

            tableBody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${vacancy.title}</td>
                    <td>${vacancy.project || (vacancy.contracts ? vacancy.contracts.company_name : 'غير محدد')}</td>
                    <td>${vacancy.specific_location || 'غير محدد'}</td>
                    <td>${statusHtml}</td>
                    <td>
                        <div style="display: flex; gap: 5px; justify-content: flex-end;">
                            ${assignedUser ? `<button class="btn btn-secondary btn-sm swap-assignment-btn" data-vacancy-id="${vacancy.id}" data-current-user-id="${assignedUser.id}" data-current-user-name="${assignedUser.name}" title="تبديل الموظف"><i class="ph-bold ph-arrows-clockwise"></i></button>` : ''}
                            <button class="btn-action edit-vacancy-btn" data-id="${vacancy.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i></button>
                            ${deleteButtonHtml}
                        </div>
                    </td>
                </tr>
            `);
        });

    } catch (error) {
        console.error("Error loading vacancy data:", error);
        listContainer.innerHTML = `<p style="color:red;">حدث خطأ في تحميل بيانات الشواغر: ${error.message}</p>`;
    }
}
async function loadUnlinkedVacanciesReport() {
    const modal = document.getElementById('unlinked-vacancies-modal');
    const body = document.getElementById('unlinked-vacancies-body');
    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري البحث عن الشواغر الزائدة...</p>';

    try {
        const { data: vacancies, error } = await supabaseClient.rpc('get_unlinked_vacancies');
        if (error) throw error;

        if (vacancies.length === 0) {
            body.innerHTML = '<div class="empty-state"><h4>ممتاز!</h4><p>لا توجد أي شواغر زائدة أو غير مرتبطة في النظام حالياً.</p></div>';
            return;
        }

        body.innerHTML = `
            <p style="margin-bottom: 15px;">تم العثور على <strong>${vacancies.length}</strong> شاغر غير مرتبط بمتطلبات العقود الحالية (أو عقودها منتهية).</p>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>المسمى الوظيفي</th>
                            <th>المشروع</th>
                            <th>الموقع المحدد</th>
                            <th>الموظف المرتبط</th> <th>الحالة</th>
                            <th>إجراءات</th> </tr>
                    </thead>
                    <tbody>
                        ${vacancies.map(v => {
                            const empNameHtml = v.employee_name 
                                ? `<span style="color: var(--denied-color); font-weight: bold;">${v.employee_name}</span>` 
                                : '<span style="color: var(--text-secondary);">لا يوجد</span>';

                            return `
                            <tr>
                                <td>${v.title}</td>
                                <td>${v.project}</td>
                                <td>${v.specific_location || 'غير محدد'}</td>
                                <td>${empNameHtml}</td>
                                <td><span class="status ${v.status === 'open' ? 'active' : 'inactive'}">${v.status}</span></td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn-action edit-vacancy-btn" data-id="${v.id}" title="تعديل">
                                            <i class="ph-bold ph-pencil-simple"></i>
                                        </button>
                                        <button class="btn-action delete-unlinked-vacancy-btn" data-id="${v.id}" data-name="${v.title} في ${v.project}" title="حذف" style="color: #ef4444;">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            </div>
        `;

    } catch (err) {
        body.innerHTML = `<p style="color:red; text-align:center;">حدث خطأ أثناء إنشاء التقرير: ${err.message}</p>`;
        console.error("Unlinked Vacancies Error:", err);
    }
}
let hrFilterData = null; // متغير لتخزين بيانات الفلاتر (مناطق، مدن..) لتجنب إعادة تحميلها
async function getFilterData() {
    if (hrFilterData) return hrFilterData;
    const { data: contracts, error } = await supabaseClient.from('contracts').select('company_name, contract_locations');
    if (error) {
        console.error("Error fetching filter data:", error);
        return {};
    }

    const structuredData = {};
    contracts.forEach(contract => {
        const project = contract.company_name;
        if (!contract.contract_locations) return;
        contract.contract_locations.forEach(location => {
            const region = location.region;
            const city = location.city;
            const locationName = location.name;

            if (!region || !city || !project) return;
            if (!structuredData[region]) structuredData[region] = {};
            if (!structuredData[region][city]) structuredData[region][city] = {};
            if (!structuredData[region][city][project]) structuredData[region][city][project] = new Set();

            structuredData[region][city][project].add(locationName);
        });
    });

    for (const region in structuredData) {
        for (const city in structuredData[region]) {
            for (const project in structuredData[region][city]) {
                structuredData[region][city][project] = Array.from(structuredData[region][city][project]);
            }
        }
    }

    hrFilterData = structuredData;
    return hrFilterData;
}
async function getAvailableVacancySlots() {
    const { data: contracts, error: e1 } = await supabaseClient
        .from('contracts')
        .select('id, company_name, contract_locations')
        .eq('status', 'active');
    const { data: existingVacancies, error: e2 } = await supabaseClient
        .from('job_vacancies')
        .select('contract_id, specific_location, schedule_details');

    if (e1 || e2) {
        console.error("Error fetching data for available slots:", e1 || e2);
        return []; // إرجاع مصفوفة فارغة في حالة الخطأ
    }
    const existingCounts = existingVacancies.reduce((acc, vacancy) => {
        const contractId = vacancy.contract_id;
        const locationName = vacancy.specific_location;
        const shiftName = vacancy.schedule_details?.[0]?.name;

        if (contractId && locationName && shiftName) {
            const key = `${contractId}-${locationName}-${shiftName}`;
            acc[key] = (acc[key] || 0) + 1;
        }
        return acc;
    }, {});
    const availableSlots = contracts.map(contract => {
        if (!contract.contract_locations) return null;

        const availableLocations = contract.contract_locations.map(location => {
            if (!location.shifts) return null;

            const availableShifts = location.shifts.filter(shift => {
                const requiredCount = shift.guards_count || 0;
                const key = `${contract.id}-${location.name}-${shift.name}`;
                const existingCount = existingCounts[key] || 0;
                return requiredCount > existingCount; // إرجاع الوردية فقط إذا كان المطلوب أكبر من الموجود
            });

            if (availableShifts.length > 0) {
                return { ...location, shifts: availableShifts }; // إرجاع الموقع مع وردياته المتاحة فقط
            }
            return null;
        }).filter(Boolean); // إزالة المواقع التي ليس لديها شواغر متاحة

        if (availableLocations.length > 0) {
            return { ...contract, contract_locations: availableLocations }; // إرجاع العقد مع مواقعه المتاحة فقط
        }
        return null;
    }).filter(Boolean); // إزالة العقود التي ليس لديها شواغر متاحة

    return availableSlots;
}
async function initializeFilters(pagePrefix) {
    let regionSelectId;
    if (pagePrefix.startsWith('hr-')) {
        const suffix = pagePrefix.split('-')[1];
        regionSelectId = `hr-filter-region-${suffix}`;
    } else {
        regionSelectId = `${pagePrefix}-filter-region`;
    }

    const data = await getFilterData(); // الدالة القديمة ستبقى للعموم
    const regionSelect = document.getElementById(regionSelectId);
    if (!regionSelect) {
        console.error(`Filter element with ID "${regionSelectId}" not found.`);
        return;
    }

    let regions = Object.keys(data).sort();
    if (pagePrefix === 'ss' && currentUser) { // 'ss' هو المعرف الخاص بصفحة جداول المشرفين
        if (currentUser.role === 'ادارة العمليات' && currentUser.region) {
            regions = regions.filter(r => r === currentUser.region);
        } else if (currentUser.role === 'مشرف' && currentUser.assigned_locations) {
            const supervisorRegions = [...new Set(currentUser.assigned_locations.map(loc => loc.region))];
            regions = regions.filter(r => supervisorRegions.includes(r));
        }
    }

    regionSelect.innerHTML = '<option value="">كل المناطق</option>';
    regions.forEach(region => {
        regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
    });
}
async function initializeGeoFilters() {
    if (currentUser.role === 'مشرف') {
        document.getElementById('geo-filter-region').parentElement.style.display = 'none';
        const citySelect = document.getElementById('geo-filter-city');
        const projectSelect = document.getElementById('geo-filter-project');

        const { data: citiesAndProjects, error } = await supabaseClient.rpc('get_supervisor_cities_and_projects', { p_projects: currentUser.project });
        if (error) return;

        const cities = [...new Set(citiesAndProjects.map(item => item.city))];
        citySelect.innerHTML = '<option value="">كل المدن</option>';
        cities.forEach(city => citySelect.innerHTML += `<option value="${city}">${city}</option>`);
        citySelect.disabled = false;
    } else {
        document.getElementById('geo-filter-region').parentElement.style.display = 'block';
        initializeFilters('geo');
    }
}
async function initializeGuardAttendanceFilters() {
    if (currentUser.role === 'مشرف') {
        document.getElementById('ga-filter-region').parentElement.style.display = 'none';
        const citySelect = document.getElementById('ga-filter-city');
        const projectSelect = document.getElementById('ga-filter-project');
        const { data: citiesAndProjects, error } = await supabaseClient.rpc('get_supervisor_cities_and_projects', { p_projects: currentUser.project });
        if (error) return;

        const cities = [...new Set(citiesAndProjects.map(item => item.city))];
        citySelect.innerHTML = '<option value="">كل المدن</option>';
        cities.forEach(city => citySelect.innerHTML += `<option value="${city}">${city}</option>`);
        citySelect.disabled = false; // <-- هذا السطر سيقوم بتفعيل القائمة
    } else {
        document.getElementById('ga-filter-region').parentElement.style.display = 'block';
        initializeFilters('ga');
    }
}
function triggerDataLoad(pagePrefix) {
    if (pagePrefix === 'hr-employees') loadEmployeeTabData();
    else if (pagePrefix === 'hr-attlog') loadHrAttendanceLogPage();
    else if (pagePrefix === 'hr-penalties') loadPenaltiesPage();
    else if (pagePrefix === 'hr-attmgmt') loadAttendanceManagementPage();
    else if (pagePrefix === 'hr-payroll') {} // لا تفعل شيئاً لمسير الرواتب
    else if (pagePrefix === 'ga') loadGuardAttendancePage();
    else if (pagePrefix === 'geo') initializeMap();
    else if (pagePrefix === 'vc') loadVacancyTabData(); // <-- الإضافة الجديدة
}

document.addEventListener('change', async function(event) {
    const target = event.target;
    if (target.classList.contains('cascading-filter-ga')) {
        if (currentUser.role === 'مشرف') {
            const cityVal = document.getElementById('ga-filter-city').value;
            const projectSelect = document.getElementById('ga-filter-project');
            const locationSelect = document.getElementById('ga-filter-location');
            if (target.id === 'ga-filter-city') {
                resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
            } else if (target.id === 'ga-filter-project') {
                resetDropdowns([locationSelect], 0, ['اختر مشروعاً أولاً']);
            }
            const data = await getFilterData();
            if (target.id === 'ga-filter-city' && cityVal) {
                const supervisorProjects = currentUser.project || [];
                let projectsInCity = new Set();
                for (const region in data) {
                    if (data[region][cityVal]) {
                        Object.keys(data[region][cityVal]).forEach(project => {
                            if (supervisorProjects.includes(project)) projectsInCity.add(project);
                        });
                    }
                }
                const uniqueProjects = Array.from(projectsInCity).sort();
                if (uniqueProjects.length > 0) populateDropdown(projectSelect, uniqueProjects, 'كل المشاريع');
            } else if (target.id === 'ga-filter-project' && cityVal && projectSelect.value) {
                const selectedProject = projectSelect.value;
                let locations = [];
                for (const region in data) {
                    if (data[region][cityVal] && data[region][cityVal][selectedProject]) {
                        locations = data[region][cityVal][selectedProject];
                        break;
                    }
                }
                if (locations.length > 0) populateDropdown(locationSelect, locations, 'كل المواقع');
            }
        } else {
            const data = await getFilterData();
            const regionSelect = document.getElementById('ga-filter-region');
            const citySelect = document.getElementById('ga-filter-city');
            const projectSelect = document.getElementById('ga-filter-project');
            const locationSelect = document.getElementById('ga-filter-location');
            const regionVal = regionSelect.value, cityVal = citySelect.value, projectVal = projectSelect.value;
            if (target.id === 'ga-filter-region') {
                resetDropdowns([citySelect, projectSelect, locationSelect], 0, ['اختر منطقة أولاً', 'اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
                if (regionVal && data[regionVal]) populateDropdown(citySelect, Object.keys(data[regionVal]).sort(), 'كل المدن');
            } else if (target.id === 'ga-filter-city') {
                resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
                if (regionVal && cityVal && data[regionVal][cityVal]) populateDropdown(projectSelect, Object.keys(data[regionVal][cityVal]).sort(), 'كل المشاريع');
            } else if (target.id === 'ga-filter-project') {
                resetDropdowns([locationSelect], 0, ['اختر مشروعاً أولاً']);
                if (regionVal && cityVal && projectVal && data[regionVal][cityVal][projectVal]) populateDropdown(locationSelect, data[regionVal][cityVal][projectVal].sort(), 'كل المواقع');
            }
        }
        triggerDataLoad('ga');
        return;
    }
    if (target.classList.contains('cascading-filter-vc')) {
        const data = await getFilterData();
        const regionSelect = document.getElementById('vc-filter-region');
        const citySelect = document.getElementById('vc-filter-city');
        const projectSelect = document.getElementById('vc-filter-project');
        const locationSelect = document.getElementById('vc-filter-location');
        const regionVal = regionSelect.value, cityVal = citySelect.value, projectVal = projectSelect.value;
        if (target.id === 'vc-filter-region') {
            resetDropdowns([citySelect, projectSelect, locationSelect], 0, ['اختر منطقة', 'اختر مدينة', 'اختر مشروعاً']);
            if (regionVal && data[regionVal]) populateDropdown(citySelect, Object.keys(data[regionVal]).sort(), 'كل المدن');
        } else if (target.id === 'vc-filter-city') {
            resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة', 'اختر مشروعاً']);
            if (regionVal && cityVal && data[regionVal][cityVal]) populateDropdown(projectSelect, Object.keys(data[regionVal][cityVal]).sort(), 'كل المشاريع');
        } else if (target.id === 'vc-filter-project') {
            resetDropdowns([locationSelect], 0, ['اختر مشروعاً']);
            if (regionVal && cityVal && projectVal && data[regionVal][cityVal][projectVal]) populateDropdown(locationSelect, data[regionVal][cityVal][projectVal].sort(), 'كل المواقع');
        }
        triggerDataLoad('vc');
        return;
    }
if (target.classList.contains('cascading-filter-ss') || target.classList.contains('ss-filter-control')) {
    const data = await getFilterData();
    const regionSelect = document.getElementById('ss-filter-region');
    const citySelect = document.getElementById('ss-filter-city');
    const projectSelect = document.getElementById('ss-filter-project');
    const locationSelect = document.getElementById('ss-filter-location');

    if (target.id === 'ss-filter-region') {
        const regionVal = regionSelect.value;
        resetDropdowns([citySelect, projectSelect, locationSelect], 0, ['اختر منطقة أولاً', 'اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
        if (regionVal) {
            if (currentUser.role === 'مشرف' && currentUser.assigned_locations) {
                const citiesForRegion = [...new Set(currentUser.assigned_locations.filter(loc => loc.region === regionVal).map(loc => loc.city))];
                populateDropdown(citySelect, citiesForRegion.sort(), 'كل المدن');
            } else {
                if (data[regionVal]) populateDropdown(citySelect, Object.keys(data[regionVal]).sort(), 'كل المدن');
            }
        }
    } else if (target.id === 'ss-filter-city') {
        const regionVal = regionSelect.value;
        const cityVal = citySelect.value;
        resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
        if (regionVal && cityVal) {
            if (currentUser.role === 'مشرف' && currentUser.assigned_locations) {
                const projectsForCity = [...new Set(currentUser.assigned_locations.filter(loc => loc.region === regionVal && loc.city === cityVal).map(loc => loc.contract))];
                populateDropdown(projectSelect, projectsForCity.sort(), 'كل المشاريع');
            } else {
                if (data[regionVal]?.[cityVal]) populateDropdown(projectSelect, Object.keys(data[regionVal][cityVal]).sort(), 'كل المشاريع');
            }
        }
    } else if (target.id === 'ss-filter-project') {
        const regionVal = regionSelect.value;
        const cityVal = citySelect.value;
        const projectVal = projectSelect.value;
        resetDropdowns([locationSelect], 0, ['اختر مشروعاً أولاً']);
        if (regionVal && cityVal && projectVal) {
            if (currentUser.role === 'مشرف' && currentUser.assigned_locations) {
                const locationsForProject = [...new Set(currentUser.assigned_locations.filter(loc => loc.region === regionVal && loc.city === cityVal && loc.contract === projectVal).map(loc => loc.site))];
                populateDropdown(locationSelect, locationsForProject.sort(), 'كل المواقع');
            } else {
                if (data[regionVal]?.[cityVal]?.[projectVal]) populateDropdown(locationSelect, data[regionVal][cityVal][projectVal].sort(), 'كل المواقع');
            }
        }
    }

    loadSupervisorSchedulesPage();
}
    if (target.classList.contains('cascading-filter-geo')) {
    if (currentUser.role === 'مشرف') {
        const cityVal = document.getElementById('geo-filter-city').value;
        const projectSelect = document.getElementById('geo-filter-project');
        const locationSelect = document.getElementById('geo-filter-location');
        if (target.id === 'geo-filter-city') {
            resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
        } else if (target.id === 'geo-filter-project') {
            resetDropdowns([locationSelect], 0, ['اختر مشروعاً أولاً']);
        }
        const data = await getFilterData();
        if (target.id === 'geo-filter-city' && cityVal) {
            const supervisorProjects = currentUser.project || [];
            let projectsInCity = new Set();
            for (const region in data) {
                if (data[region][cityVal]) {
                    Object.keys(data[region][cityVal]).forEach(project => {
                        if (supervisorProjects.includes(project)) projectsInCity.add(project);
                    });
                }
            }
            const uniqueProjects = Array.from(projectsInCity).sort();
            if (uniqueProjects.length > 0) populateDropdown(projectSelect, uniqueProjects, 'كل المشاريع');
        } else if (target.id === 'geo-filter-project' && cityVal && projectSelect.value) {
            const selectedProject = projectSelect.value;
            let locations = [];
            for (const region in data) {
                if (data[region][cityVal] && data[region][cityVal][selectedProject]) {
                    locations = data[region][cityVal][selectedProject];
                    break;
                }
            }
            if (locations.length > 0) populateDropdown(locationSelect, locations, 'كل المواقع');
        }
    } else {
        const data = await getFilterData();
        const regionSelect = document.getElementById('geo-filter-region');
        const citySelect = document.getElementById('geo-filter-city');
        const projectSelect = document.getElementById('geo-filter-project');
        const locationSelect = document.getElementById('geo-filter-location');
        const regionVal = regionSelect.value, cityVal = citySelect.value, projectVal = projectSelect.value;
        if (target.id === 'geo-filter-region') {
            resetDropdowns([citySelect, projectSelect, locationSelect], 0, ['اختر منطقة أولاً', 'اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
            if (regionVal && data[regionVal]) populateDropdown(citySelect, Object.keys(data[regionVal]).sort(), 'كل المدن');
        } else if (target.id === 'geo-filter-city') {
            resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
            if (regionVal && cityVal && data[regionVal][cityVal]) populateDropdown(projectSelect, Object.keys(data[regionVal][cityVal]).sort(), 'كل المشاريع');
        } else if (target.id === 'geo-filter-project') {
            resetDropdowns([locationSelect], 0, ['اختر مشروعاً أولاً']);
            if (regionVal && cityVal && projectVal && data[regionVal][cityVal][projectVal]) populateDropdown(locationSelect, data[regionVal][cityVal][projectVal].sort(), 'كل المواقع');
        }
    }
    initializeMap();
    return;
}
    if (target.classList.contains('cascading-filter')) {
        const suffix = target.id.split('-').pop(); // employees, penalties, etc.
        const data = await getFilterData();
        const regionSelect = document.getElementById(`hr-filter-region-${suffix}`);
        const citySelect = document.getElementById(`hr-filter-city-${suffix}`);
        const projectSelect = document.getElementById(`hr-filter-project-${suffix}`);
        const locationSelect = document.getElementById(`hr-filter-location-${suffix}`);
        const regionVal = regionSelect.value, cityVal = citySelect.value, projectVal = projectSelect.value;
        if (target.id === `hr-filter-region-${suffix}`) {
            resetDropdowns([citySelect, projectSelect, locationSelect], 0, ['اختر منطقة أولاً', 'اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
            if (regionVal && data[regionVal]) populateDropdown(citySelect, Object.keys(data[regionVal]).sort(), 'كل المدن');
        } else if (target.id === `hr-filter-city-${suffix}`) {
            resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
            if (regionVal && cityVal && data[regionVal][cityVal]) populateDropdown(projectSelect, Object.keys(data[regionVal][cityVal]).sort(), 'كل المشاريع');
        } else if (target.id === `hr-filter-project-${suffix}`) {
            resetDropdowns([locationSelect], 0, ['اختر مشروعاً أولاً']);
            if (regionVal && cityVal && projectVal && data[regionVal][cityVal][projectVal]) populateDropdown(locationSelect, data[regionVal][cityVal][projectVal].sort(), 'كل المواقع');
        }
        triggerDataLoad(`hr-${suffix}`);
    }
});
document.addEventListener('input', function(event) {
    if (event.target.id.includes('-search')) {
        const pagePrefix = event.target.id.split('-')[0];
        triggerDataLoad(pagePrefix);
    }
});

document.addEventListener('change', function(event) {
    const target = event.target;
    if (target.classList.contains('ga-filter-control') && !target.classList.contains('cascading-filter-ga')) triggerDataLoad('ga');
    if (target.classList.contains('vc-filter-control') && !target.classList.contains('cascading-filter-vc')) triggerDataLoad('vc');
    if (target.classList.contains('geo-filter-control') && !target.classList.contains('cascading-filter-geo')) triggerDataLoad('geo');
    if (target.classList.contains('hr-filter-control') && !target.classList.contains('cascading-filter')) triggerDataLoad('hr-' + target.id.split('-').pop());
});

/**
 * دالة مساعدة لتعبئة قائمة منسدلة بالخيارات
 */
function populateDropdown(selectElement, options, placeholder) {
    let optionsHtml = `<option value="">${placeholder}</option>`;
    options.forEach(opt => {
        optionsHtml += `<option value="${opt}">${opt}</option>`;
    });
    selectElement.innerHTML = optionsHtml;
    selectElement.disabled = false;
}

/**
 * دالة مساعدة لإعادة تعيين القوائم المنسدلة
 */
function resetDropdowns(elements, startIndex, placeholders) {
    for (let i = startIndex; i < elements.length; i++) {
        elements[i].innerHTML = `<option value="">${placeholders[i]}</option>`;
        elements[i].disabled = true;
    }
}
document.body.addEventListener('change', async function(event) {
    const target = event.target;
    function updateMasterCheckboxState(masterCheckbox) {
        if (!masterCheckbox) return;
        
        const contractGroup = masterCheckbox.closest('.assignment-contract-group');
        const allSiteCheckboxes = contractGroup.querySelectorAll('.site-checkbox');
        const total = allSiteCheckboxes.length;
        const checkedCount = Array.from(allSiteCheckboxes).filter(cb => cb.checked).length;
        const header = contractGroup.querySelector('.assignment-contract-header');

        if (checkedCount === 0) {
            masterCheckbox.indeterminate = false;
            masterCheckbox.checked = false;
            header.classList.remove('all-selected');
        } else if (checkedCount === total) {
            masterCheckbox.indeterminate = false;
            masterCheckbox.checked = true;
            header.classList.add('all-selected');
        } else {
            masterCheckbox.indeterminate = true;
            header.classList.remove('all-selected');
        }
    }
    if (target.closest('#site-assignment-modal')) {
        if (target.classList.contains('master-checkbox')) {
            const masterCheckbox = target;
            const isChecked = masterCheckbox.checked;
            const siteCheckboxes = masterCheckbox.closest('.assignment-contract-group').querySelectorAll('.site-checkbox');

            siteCheckboxes.forEach(siteCheckbox => {
                siteCheckbox.checked = isChecked;
                const locationData = JSON.parse(siteCheckbox.dataset.location);
                const isAlreadyInArray = currentAssignedLocations.some(loc => loc.site === locationData.site && loc.contract === locationData.contract);

                if (isChecked && !isAlreadyInArray) {
                    currentAssignedLocations.push(locationData);
                } else if (!isChecked && isAlreadyInArray) {
                    currentAssignedLocations = currentAssignedLocations.filter(loc => !(loc.site === locationData.site && loc.contract === locationData.contract));
                }
            });
            updateMasterCheckboxState(masterCheckbox);
        }
        else if (target.classList.contains('site-checkbox')) {
            const siteCheckbox = target;
            const locationData = JSON.parse(siteCheckbox.dataset.location);

            if (siteCheckbox.checked) {
                if (!currentAssignedLocations.some(loc => loc.site === locationData.site && loc.contract === locationData.contract)) {
                    currentAssignedLocations.push(locationData);
                }
            } else {
                currentAssignedLocations = currentAssignedLocations.filter(loc => !(loc.site === locationData.site && loc.contract === locationData.contract));
            }
            const masterCheckbox = siteCheckbox.closest('.assignment-contract-group').querySelector('.master-checkbox');
            updateMasterCheckboxState(masterCheckbox);
        }
    }
    if (event.target.classList.contains('cascading-filter')) {
        const pagePrefix = event.target.id.split('-').pop();
        const regionSelect = document.getElementById(`hr-filter-region-${pagePrefix}`);
        const citySelect = document.getElementById(`hr-filter-city-${pagePrefix}`);
        const projectSelect = document.getElementById(`hr-filter-project-${pagePrefix}`);
        const locationSelect = document.getElementById(`hr-filter-location-${pagePrefix}`);

        const allDropdowns = [regionSelect, citySelect, projectSelect, locationSelect];
        const placeholders = ['الكل', 'اختر مدينة أولاً', 'اختر مشروعاً أولاً', 'اختر موقعاً أولاً'];

        const sourceId = event.target.id;
        const selectedValue = event.target.value;

        if (sourceId === regionSelect.id) {
            resetDropdowns(allDropdowns, 1, placeholders);
            if (selectedValue && hrFilterData[selectedValue]) {
                const cities = Object.keys(hrFilterData[selectedValue]);
                populateDropdown(citySelect, cities, 'كل المدن');
            }
        } else if (sourceId === citySelect.id) {
            resetDropdowns(allDropdowns, 2, placeholders);
            if (selectedValue && hrFilterData[regionSelect.value]?.[selectedValue]) {
                const projects = Object.keys(hrFilterData[regionSelect.value][selectedValue]);
                populateDropdown(projectSelect, projects, 'كل المشاريع');
            }
        } else if (sourceId === projectSelect.id) {
            resetDropdowns(allDropdowns, 3, placeholders);
            if (selectedValue && hrFilterData[regionSelect.value]?.[citySelect.value]?.[selectedValue]) {
                const locations = hrFilterData[regionSelect.value][citySelect.value][selectedValue];
                populateDropdown(locationSelect, locations, 'كل المواقع');
            }
        }
    }
    if (event.target.classList.contains('hr-filter-control')) {
        if (document.querySelector('#page-employees:not(.hidden)')) {
            loadEmployeeTabData();
        }
    }
});
document.addEventListener('input', function(event) {
    if (event.target.classList.contains('user-mgmt-filter')) {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            if (document.querySelector('#page-user-management:not(.hidden)')) {
                loadUserManagementPage();
            }
        }, 500);
    }
});
document.addEventListener('change', function(event) {
    if (event.target.classList.contains('user-mgmt-filter') && event.target.type === 'checkbox') {
        if (document.querySelector('#page-user-management:not(.hidden)')) {
            loadUserManagementPage();
        }
    }
});
document.body.addEventListener('keyup', function(event) {
    if (event.target.id.startsWith('hr-filter-search-')) {
        const suffix = event.target.id.split('-').pop(); // يستخرج اسم الصفحة مثل: employees, attlog
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            triggerDataLoad(`hr-${suffix}`); // يستدعي دالة التحديث للصفحة الصحيحة
        }, 500);
    }
});
document.body.addEventListener('keyup', function(event) {
    if (event.target.id === 'marketing-client-search-input') {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            loadMarketingClientsPage();
        }, 500);
    }
});
async function loadEmployeeTabData() {
    const container = document.getElementById('employees-list-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الموظفين...</p>';
    const searchVal = document.getElementById('employee-search-input').value;
    const roleVal = document.getElementById('employee-role-filter').value;
    const statusFilter = document.getElementById('employee-status-filter').value;
    const assignmentFilter = document.getElementById('employee-assignment-filter').value;
    const regionVal = document.getElementById('hr-filter-region-employees').value;
    const cityVal = document.getElementById('hr-filter-city-employees').value;
    const projectVal = document.getElementById('hr-filter-project-employees').value;
    const locationVal = document.getElementById('hr-filter-location-employees').value;

    let query = supabaseClient.from('users').select(`id, name, role, project, city, region, location, phone, employment_status, auth_user_id, id_number`).not('employment_status', 'eq', 'مؤرشف').in('role', ['حارس أمن', 'مشرف']);
    if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
        query = query.eq('region', currentUser.region);
    }
    if (searchVal) {
        query = query.or(`name.ilike.%${searchVal}%,id_number.ilike.%${searchVal}%`);
    }
    if (roleVal) {
        query = query.eq('role', roleVal);
    }
    if (statusFilter) {
        query = query.eq('employment_status', statusFilter);
    }
    if (assignmentFilter === 'assigned') {
        query = query.not('vacancy_id', 'is', null); // جلب المرتبطين بشاغر فقط
    } else if (assignmentFilter === 'unassigned') {
        query = query.is('vacancy_id', null); // جلب غير المرتبطين بشاغر (null)
    }

    if (regionVal) {
        query = query.eq('region', regionVal);
    }
    if (cityVal) {
        query = query.eq('city', cityVal);
    }
    if (projectVal) {
        query = query.filter('project', 'cs', `{${projectVal}}`);
    }
    if (locationVal) {
        query = query.eq('location', locationVal);
    }

    const { data: employees, error } = await query.order('name', { ascending: true });

    if (error) {
        container.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ في تحميل الموظفين.</p>';
        return console.error(error);
    }
    if (employees.length === 0) {
        container.innerHTML = '<p style="text-align: center;">لم يتم العثور على موظفين بهذه المواصفات.</p>';
        return;
    }
    container.innerHTML = `<table><thead><tr>
        <th>الاسم</th>
        <th>الدور</th>
        <th>رقم الجوال</th>
        <th>المشروع</th>
        <th>الحالة الوظيفية</th>
        <th>إجراءات</th>
    </tr></thead><tbody id="employees-table-body"></tbody></table>`;

    const tableBody = document.getElementById('employees-table-body');
    employees.forEach(emp => {
        let statusText = emp.employment_status || 'غير محدد';
        let statusClass = 'inactive';

        if (statusText === 'اساسي' || statusText === 'نشط') {
            statusText = 'أساسي';
            statusClass = 'active';
        } else if (statusText === 'بديل راحة' || statusText === 'تغطية') {
            statusClass = 'pending';
        }

        let projectDisplay = 'غير معين';
        if (Array.isArray(emp.project)) {
            projectDisplay = emp.project.join(' - ');
        } else if (emp.project) {
            projectDisplay = emp.project;
        }

        let isDisabled = false;
        let disabledTitle = '';
        if (currentUser.role === 'ادارة الموارد البشرية' && emp.role === 'مدير النظام') {
            isDisabled = true;
            disabledTitle = 'لا يمكن التعديل على مدير النظام';
        }

        tableBody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${emp.name || 'غير متوفر'}</td>
                <td>${emp.role || 'غير محدد'}</td>
                <td>${emp.phone || 'غير مسجل'}</td>
                <td>${projectDisplay}</td>
                <td>
                    <span class="status ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td>
                    <button class="btn btn-secondary edit-employee-btn" data-id="${emp.id}" ${isDisabled ? `disabled title="${disabledTitle}"` : ''}><i class="ph-bold ph-pencil-simple"></i> تعديل</button>
                    <button class="btn btn-secondary view-employee-btn" data-id-number="${emp.id_number}" title="عرض الملف" ${isDisabled ? `disabled title="${disabledTitle}"` : ''}><i class="ph-bold ph-eye"></i></button>
                    <button class="btn btn-danger admin-archive-user-btn" data-id="${emp.id}" data-name="${emp.name}" title="أرشفة" ${isDisabled ? `disabled title="${disabledTitle}"` : ''}><i class="ph-bold ph-archive"></i> تعطيل</button>
                </td>
            </tr>
        `);
    });
    
}
async function loadOperationsRequestsPage() {
    const container = document.getElementById('all-operations-requests-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلبات التوظيف...</p>';

    const { data: applications, error } = await supabaseClient
        .from('job_applications')
        .select(`*, job_vacancies!inner(title, project, specific_location)`)
        .eq('status', 'pending_supervisor')
        .eq('job_vacancies.project', currentUser.project);

    if (error) {
        container.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ.</p>';
        return console.error(error);
    }
    if (requests.length === 0) {
        container.innerHTML = '<p style="text-align: center;">لا توجد طلبات توظيف حالياً.</p>';
        return;
    }

    requests.sort((a, b) => (a.status === 'معلق' ? -1 : 1) - (b.status === 'معلق' ? -1 : 1));
    container.innerHTML = '';

    requests.forEach(request => {
        const requestTime = new Date(request.created_at).toLocaleDateString('ar-SA', { day: 'numeric', month: 'long' });
        const emp = request.details;
        let footerHtml = '';

        let headerStatusClass = 'status-pending';
        if (request.status === 'مقبول') headerStatusClass = 'status-approved';
        if (request.status === 'مرفوض') headerStatusClass = 'status-denied';

        if (request.status === 'معلق') {
            footerHtml = `<div class="review-request-footer">
                <button class="btn btn-success approve-request-btn" data-request-id="${request.id}" data-type="hiring"><i class="ph-bold ph-check"></i> قبول</button>
                <button class="btn btn-danger reject-request-btn" data-request-id="${request.id}" data-type="hiring"><i class="ph-bold ph-x"></i> رفض</button>
            </div>`;
        } else if (request.status === 'مرفوض' && request.rejection_reason) {
            footerHtml = `<div class="request-card-footer"><strong>سبب الرفض:</strong> ${request.rejection_reason}</div>`;
        }

        const cardHtml = `
        <div class="review-request-card">
            <div class="review-request-header ${headerStatusClass}"><h4>طلب توظيف</h4><span class="status-badge">${request.status}</span></div>
            <div class="review-request-body">
                <div class="request-meta-grid">
                    <div class="request-meta-item"><i class="ph-bold ph-user-circle"></i><span><strong>مقدم الطلب:</strong> ${request.users ? request.users.name : 'غير معروف'}</span></div>
                    <div class="request-meta-item"><i class="ph-bold ph-calendar"></i><span><strong>تاريخ الطلب:</strong> ${requestTime}</span></div>
                </div>
                <div class="request-main-details">
                    <h5>بيانات الموظف المقترح</h5>
                    <div class="request-meta-grid" style="grid-template-columns: 1fr 1fr; border:0; padding:0; margin-bottom:10px;">
                        <p><strong>الاسم:</strong> ${emp.name}</p>
                        <p><strong>الهوية:</strong> ${emp.id_number}</p>
                        <p><strong>الدور:</strong> ${emp.role}</p>
                        <p><strong>المشروع:</strong> ${emp.project || 'غير محدد'}</p>
                    </div>
                </div>
            </div>
            ${footerHtml}
        </div>`;
        container.insertAdjacentHTML('beforeend', cardHtml);
    });
}
function renderRequests(requests, containerId, requestTypeTranslation, approvalStage) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (!requests || requests.length === 0) { 
        container.innerHTML = `<div class="empty-state"><i class="ph-bold ph-list-checks"></i><h4>لا توجد طلبات</h4><p>القائمة فارغة حالياً.</p></div>`;
        return;
    }
    
    const pendingStatuses = [
        "معلق", 
        "بانتظار موافقة الموارد البشرية", 
        "بانتظار موافقة العمليات", 
        "بانتظار موافقة مدير العمليات", 
        "بانتظار موافقة المشرف", 
        "بانتظار موافقة الشؤون القانونية",
        "بانتظار موافقة مدير القسم",  // <-- تمت الإضافة
        "بانتظار موافقة القيادة العليا" // <-- تمت الإضافة
    ];
    requests.sort((a, b) => (pendingStatuses.includes(a.status) ? -1 : 1) - (pendingStatuses.includes(b.status) ? -1 : 1));
    
    container.innerHTML = '';
    requests.forEach(request => {
        const user = request.user || request.users || {}; // دعم التسميات المختلفة
        let detailsGridHtml = '';
        if (request.details) {
            if (request.request_type === 'leave') {
                detailsGridHtml = `
                    <div class="detail-box">
                        <label>نوع الإجازة</label>
                        <span><i class="ph-bold ph-suitcase"></i> ${request.details.type}</span>
                    </div>
                    <div class="detail-box">
                        <label>المدة</label>
                        <span><i class="ph-bold ph-timer"></i> ${request.details.days} أيام</span>
                    </div>
                    <div class="detail-box">
                        <label>من تاريخ</label>
                        <span>${formatGregorianDate(request.details.start_date)}</span>
                    </div>
                    <div class="detail-box">
                        <label>إلى تاريخ</label>
                        <span>${formatGregorianDate(request.details.end_date)}</span>
                    </div>
                    <div class="detail-box full-width">
                        <label>السبب</label>
                        <div class="reason-box">${request.details.reason}</div>
                    </div>
                `;
            } 
            else if (request.request_type === 'loan') {
                detailsGridHtml = `
                    <div class="detail-box">
                        <label>المبلغ المطلوب</label>
                        <span style="color: #f59e0b; font-size: 1.1rem;">${parseFloat(request.details.amount).toLocaleString('en-US')} ر.س</span>
                    </div>
                    <div class="detail-box full-width">
                        <label>سبب السلفة</label>
                        <div class="reason-box">${request.details.reason}</div>
                    </div>
                `;
            }
            else {
                detailsGridHtml = `
                    <div class="detail-box full-width">
                        <label>التفاصيل / السبب</label>
                        <div class="reason-box">${request.details.reason}</div>
                    </div>
                    ${request.details.replacement_guard_name ? `<div class="detail-box full-width" style="color: green;"><strong>البديل المقترح:</strong> ${request.details.replacement_guard_name}</div>` : ''}
                `;
            }
        }
        let footerHtml = '';
        if (pendingStatuses.includes(request.status)) {
            let buttonText = 'قبول ورفع';
            if (approvalStage.includes('final')) buttonText = 'اعتماد نهائي';
            if (request.request_type === 'loan' && approvalStage === 'hr_admin_final') buttonText = 'اعتماد وتحويل للمالية';
            
            footerHtml = `<div class="review-request-footer">
                <button class="btn btn-success request-action-button" 
                        data-approval-stage="${approvalStage}" 
                        data-action="approve" 
                        data-request-id="${request.id}" 
                        data-request-type="${request.request_type}" 
                        data-user-id="${request.user_id}" 
                        data-vacancy-id="${user.vacancy_id || ''}">
                    <i class="ph-bold ph-check"></i> ${buttonText}
                </button>
                <button class="btn btn-danger request-action-button" 
                        data-approval-stage="${approvalStage}" 
                        data-action="reject" 
                        data-request-id="${request.id}">
                    <i class="ph-bold ph-x"></i> رفض
                </button>
            </div>`;
        } else if (request.status === 'مرفوض') {
             footerHtml = `<div class="request-card-footer"><strong>سبب الرفض:</strong> ${request.rejection_reason || '-'}</div>`;
        }
        const icons = { 
            'permission': 'ph-clock-countdown', 'leave': 'ph-calendar-blank', 
            'loan': 'ph-hand-coins', 'resignation': 'ph-file-x' 
        };
        const titles = { 'permission': 'استئذان', 'leave': 'إجازة', 'loan': 'سلفة', 'resignation': 'استقالة' };
        const statusColor = request.status === 'مقبول' ? 'status-approved' : (request.status === 'مرفوض' ? 'status-denied' : 'status-pending');
        const cardHtml = `
        <div class="review-request-card" style="border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            
            <div class="review-request-header ${statusColor}" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                <h4 style="margin:0; display:flex; align-items:center; gap:8px; font-size: 1rem;">
                    <i class="ph-fill ${icons[request.request_type] || 'ph-file'}"></i> 
                    طلب ${titles[request.request_type] || 'إداري'}
                </h4>
                <span class="status-badge" style="background:rgba(255,255,255,0.2);">${request.status}</span>
            </div>

            <div class="review-request-body">
                
                <div class="request-user-info">
                    <div class="info-item full-width" style="border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px;">
                        <i class="ph-fill ph-user-circle" style="color: var(--accent-color); font-size: 1.2rem;"></i>
                        <strong>${user.name || 'غير معروف'}</strong>
                    </div>
                    <div class="info-item">
                        <i class="ph-bold ph-briefcase"></i>
                        <span>${user.role || 'غير محدد'}</span> </div>
                    <div class="info-item">
                        <i class="ph-bold ph-identification-badge"></i>
                        <span>${user.id_number || '-'}</span>
                    </div>
                </div>

                <div class="request-details-grid">
                    ${detailsGridHtml}
                </div>

                ${request.details?.attachment_url ? `
                <div style="margin-top: 10px;">
                    <button class="btn btn-secondary btn-sm view-financial-attachment-btn" data-url="${request.details.attachment_url}" style="width:100%">
                        <i class="ph-bold ph-paperclip"></i> عرض المرفق
                    </button>
                </div>` : ''}

            </div>
            ${footerHtml}
        </div>`;
        
        container.insertAdjacentHTML('beforeend', cardHtml);
    });
}
async function loadLeaveRequests() {
    const regularContainer = document.getElementById('all-leave-requests-container');
    const managerContainer = document.getElementById('hr-manager-leave-container');
    if (!regularContainer || !managerContainer) return;
    regularContainer.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
    let regularQuery = supabaseClient
        .from('employee_requests')
        .select(`*, users:user_id!inner(name, vacancy_id, region)`)
        .eq('request_type', 'leave')
        .eq('status', 'بانتظار موافقة الموارد البشرية') // <-- الحالة القديمة
        .order('created_at', { ascending: false });
    if (currentUser.role === 'ادارة الموارد البشرية' && !currentUser.is_hr_manager) {
        regularQuery = regularQuery.eq('users.region', currentUser.region);
    }
    
    const { data: regularData, error: regularError } = await regularQuery;
    if(regularError) { regularContainer.innerHTML = '<p style="color:red;">حدث خطأ</p>'; }
    else { renderRequests(regularData, 'all-leave-requests-container', 'إجازة', 'hr_final'); }
    if (currentUser.role === 'مدير النظام' || currentUser.is_hr_manager) {
        managerContainer.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
        let managerQuery = supabaseClient
            .from('employee_requests')
            .select(`*, users:user_id!inner(name, vacancy_id, region)`)
            .eq('request_type', 'leave')
            .eq('status', 'بانتظار موافقة مدير الموارد البشرية') // <-- الحالة الجديدة
            .order('created_at', { ascending: false });
        
        const { data: managerData, error: managerError } = await managerQuery;
        if(managerError) { managerContainer.innerHTML = '<p style="color:red;">حدث خطأ</p>'; }
        else { renderRequests(managerData, 'hr-manager-leave-container', 'إجازة', 'hr_manager_final'); }
    }
}
async function loadResignationRequests() {
    const regularContainer = document.getElementById('all-resignation-requests-container');
    const managerContainer = document.getElementById('hr-manager-resignation-container');
    if (!regularContainer || !managerContainer) return;
    regularContainer.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
    let regularQuery = supabaseClient
        .from('employee_requests')
        .select(`*, users:user_id!inner(name, vacancy_id, region)`)
        .eq('request_type', 'resignation') // <-- تعديل النوع
        .eq('status', 'بانتظار موافقة الموارد البشرية')
        .order('created_at', { ascending: false });

    if (currentUser.role === 'ادارة الموارد البشرية' && !currentUser.is_hr_manager) {
        regularQuery = regularQuery.eq('users.region', currentUser.region);
    }
    
    const { data: regularData, error: regularError } = await regularQuery;
    if(regularError) { regularContainer.innerHTML = '<p style="color:red;">حدث خطأ</p>'; }
    else { renderRequests(regularData, 'all-resignation-requests-container', 'استقالة', 'hr_final'); }
    if (currentUser.role === 'مدير النظام' || currentUser.is_hr_manager) {
        managerContainer.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
        let managerQuery = supabaseClient
            .from('employee_requests')
            .select(`*, users:user_id!inner(name, vacancy_id, region)`)
            .eq('request_type', 'resignation') // <-- تعديل النوع
            .eq('status', 'بانتظار موافقة مدير الموارد البشرية')
            .order('created_at', { ascending: false });
        
        const { data: managerData, error: managerError } = await managerQuery;
        if(managerError) { managerContainer.innerHTML = '<p style="color:red;">حدث خطأ</p>'; }
        else { renderRequests(managerData, 'hr-manager-resignation-container', 'استقالة', 'hr_manager_final'); }
    }
}
async function loadLoanRequests() {
    const regularContainer = document.getElementById('all-loan-requests-container');
    const managerContainer = document.getElementById('hr-manager-loan-container');
    if (!regularContainer || !managerContainer) return;
    regularContainer.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
    let regularQuery = supabaseClient
        .from('employee_requests')
        .select(`*, users:user_id!inner(name, vacancy_id, region)`)
        .eq('request_type', 'loan') // <-- تعديل النوع
        .eq('status', 'بانتظار موافقة الموارد البشرية')
        .order('created_at', { ascending: false });

    if (currentUser.role === 'ادارة الموارد البشرية' && !currentUser.is_hr_manager) {
        regularQuery = regularQuery.eq('users.region', currentUser.region);
    }
    
    const { data: regularData, error: regularError } = await regularQuery;
    if(regularError) { regularContainer.innerHTML = '<p style="color:red;">حدث خطأ</p>'; }
    else { renderRequests(regularData, 'all-loan-requests-container', 'سلفة', 'hr_final'); }
    if (currentUser.role === 'مدير النظام' || currentUser.is_hr_manager) {
        managerContainer.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
        let managerQuery = supabaseClient
            .from('employee_requests')
            .select(`*, users:user_id!inner(name, vacancy_id, region)`)
            .eq('request_type', 'loan') // <-- تعديل النوع
            .eq('status', 'بانتظار موافقة مدير الموارد البشرية')
            .order('created_at', { ascending: false });
        
        const { data: managerData, error: managerError } = await managerQuery;
        if(managerError) { managerContainer.innerHTML = '<p style="color:red;">حدث خطأ</p>'; }
        else { renderRequests(managerData, 'hr-manager-loan-container', 'سلفة', 'hr_manager_final'); }
    }
}
function calculateAndDisplayLogStats(records) {
    const stats = { absent: 0, completed: 0, permission: 0, withdrawal: 0 };
    if (!records) return;

    records.forEach(record => {
        if (!record.status) return;
        if (record.status.includes('غياب')) stats.absent++;
        if (record.status.includes('اكمل المناوبة')) stats.completed++;
        if (record.status.includes('استئذان')) stats.permission++;
        if (record.status.includes('انسحاب')) stats.withdrawal++;
    });

    const updateStat = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    updateStat('hr-log-stats-absent', stats.absent);
    updateStat('hr-log-stats-completed', stats.completed);
    updateStat('hr-log-stats-permission', stats.permission);
    updateStat('hr-log-stats-withdrawal', stats.withdrawal);
}

async function generateComprehensiveAttendanceReport(dateFrom, dateTo, filters, specificUsers = null) {
    const startDate = new Date(dateFrom + 'T00:00:00.000Z');
    const endDate = new Date(dateTo + 'T00:00:00.000Z');

    let filteredUsers;
    if (specificUsers) {
        filteredUsers = specificUsers;
    } else {
        let usersQuery = supabaseClient
            .from('users')
            .select(`id, name, start_of_work_date, region, project, city, location, id_number, job_vacancies!users_vacancy_id_fkey(schedule_details)`)
            .eq('role', 'حارس أمن');

        if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
            usersQuery = usersQuery.eq('region', currentUser.region);
        }

        if (filters.searchVal) usersQuery = usersQuery.or(`name.ilike.%${filters.searchVal}%,id_number.ilike.%${filters.searchVal}%`);
        if (filters.region) usersQuery = usersQuery.eq('region', filters.region);
        if (filters.city) usersQuery = usersQuery.eq('city', filters.city);
        if (filters.project) usersQuery = usersQuery.filter('project', 'cs', `{"${filters.project}"}`);
        if (filters.location) usersQuery = usersQuery.eq('location', filters.location);

        const { data, error: usersError } = await usersQuery;
        if (usersError) throw usersError;
        filteredUsers = data;
    }

    if (filteredUsers.length === 0) return [];

    const userIds = filteredUsers.map(u => u.id);
    const { data: realRecords, error: recordsError } = await supabaseClient
        .from('attendance')
        .select('*')
        .in('guard_id', userIds)
        .gte('created_at', startDate.toISOString())
        .lte('created_at', new Date(endDate.getTime() + 24 * 60 * 60 * 1000).toISOString());

    if (recordsError) throw recordsError;

    let comprehensiveReport = [];
    if (realRecords) {
        realRecords.forEach(record => {
            const userForRecord = filteredUsers.find(u => u.id === record.guard_id);
            if (userForRecord) {
                comprehensiveReport.push({ ...record, users: userForRecord });
            }
        });
    }

    return comprehensiveReport.filter(r => {
        if (filters.status && !r.status.includes(filters.status)) return false;
        return true;
    });
}

async function loadHrAttendanceLogPage() {
    const container = document.getElementById('hr-attendance-log-container');
    container.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
    try {
        let dateFrom = document.getElementById('att-log-date-from').value;
        let dateTo = document.getElementById('att-log-date-to').value;
        const filters = {
            searchVal: document.getElementById('hr-filter-search-attlog').value,
            region: document.getElementById('hr-filter-region-attlog').value,
            city: document.getElementById('hr-filter-city-attlog').value,
            project: document.getElementById('hr-filter-project-attlog').value,
            location: document.getElementById('hr-filter-location-attlog').value,
            status: document.getElementById('hr-filter-status-attlog').value,
        };

        let isDefaultView = false;
        if (!dateFrom || !dateTo) {
            isDefaultView = true;
            const today = new Date().toISOString().split('T')[0];
            dateFrom = today;
            dateTo = today;
        }

        const records = await generateComprehensiveAttendanceReport(dateFrom, dateTo, filters);
        calculateAndDisplayLogStats(records);

        if (!records || records.length === 0) {
            if (isDefaultView) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد سجلات لهذا اليوم. يمكنك استخدام الفلاتر أعلاه للبحث في تواريخ أخرى.</p>';
            } else {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد سجلات تطابق شروط الفلترة.</p>';
            }
        } else {
            renderAttendanceTable(container, records, new Set(), false);
        }
    } catch (err) {
        container.innerHTML = `<p style="color: red; text-align:center;">حدث خطأ: ${err.message}</p>`;
    }
    if (activeSubscription) supabaseClient.removeChannel(activeSubscription);
    activeSubscription = supabaseClient.channel('public:attendance:log').on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, () => loadHrAttendanceLogPage()).subscribe();
}
async function loadAttendanceManagementPage() {
    const container = document.getElementById('attendance-management-table-container');
    container.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';
    try {
        let dateFrom = document.getElementById('hr-filter-date-from-attmgmt').value;
        let dateTo = document.getElementById('hr-filter-date-to-attmgmt').value;
        const filters = {
            searchVal: document.getElementById('hr-filter-search-attmgmt').value,
            region: document.getElementById('hr-filter-region-attmgmt').value,
            city: document.getElementById('hr-filter-city-attmgmt').value,
            project: document.getElementById('hr-filter-project-attmgmt').value,
            location: document.getElementById('hr-filter-location-attmgmt').value,
            status: document.getElementById('hr-filter-status-attmgmt').value,
        };

        let recordsToDisplay = [];
        if (dateFrom && dateTo) {
            recordsToDisplay = await generateComprehensiveAttendanceReport(dateFrom, dateTo, filters);
        } else {
            let query = supabaseClient.from('attendance').select(`*, users:guard_id!inner(name, id_number, region, city, project, location, job_vacancies!users_vacancy_id_fkey(schedule_details))`).order('created_at', { ascending: false }).limit(50);
            if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
                query = query.eq('users.region', currentUser.region);
            }
            if (filters.searchVal) query = query.or(`name.ilike.%${filters.searchVal}%,id_number.ilike.%${filters.searchVal}%`, { foreignTable: 'users' });
            if (filters.region) query = query.eq('users.region', filters.region);
            if (filters.city) query = query.eq('users.city', filters.city);
            if (filters.project) query = query.filter('users.project', 'cs', `{"${filters.project}"}`);
            if (filters.location) query = query.eq('users.location', filters.location);
            if (filters.status) query = query.eq('status', filters.status);

            const { data, error } = await query;
            if (error) throw error;
            recordsToDisplay = data || [];
        }
        if (recordsToDisplay.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد سجلات تطابق شروط الفلترة.</p>';
        } else {
            renderAttendanceTable(container, recordsToDisplay, new Set(), true);
        }
    } catch(err) {
        container.innerHTML = `<p style="color: red; text-align:center;">حدث خطأ: ${err.message}</p>`;
    }
    if (activeSubscription) supabaseClient.removeChannel(activeSubscription);
    activeSubscription = supabaseClient.channel('public:attendance:management').on('postgres_changes', { event: '*', schema: 'public', table: 'attendance' }, () => loadAttendanceManagementPage()).subscribe();
}
async function generatePayroll() {
    const btn = document.getElementById('generate-payroll-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري المعالجة والحساب...';

    const resultsContainer = document.getElementById('payroll-results-container');
    const startDateString = document.getElementById('payroll-start-date').value;
    const endDateString = document.getElementById('payroll-end-date').value;
    const projectVal = document.getElementById('hr-filter-project-payroll').value;
    const regionVal = document.getElementById('hr-filter-region-payroll').value;
    const cityVal = document.getElementById('hr-filter-city-payroll').value;
    const locationVal = document.getElementById('hr-filter-location-payroll').value;

    if (!startDateString || !endDateString) {
        btn.disabled = false; btn.innerHTML = '<i class="ph-bold ph-calculator"></i> توليد المسير';
        return alert('الرجاء تحديد تاريخ البداية والنهاية.');
    }

    if (!projectVal) {
        btn.disabled = false; btn.innerHTML = '<i class="ph-bold ph-calculator"></i> توليد المسير';
        return alert('عفواً، يجب تحديد "المشروع" لإنشاء مسودة مسير منظمة.');
    }

    resultsContainer.innerHTML = '<p style="text-align: center;">جاري جلب الإعدادات وحساب الرواتب...</p>';

    try {
        const { data: settingsData, error: settingsError } = await supabaseClient.from('payroll_settings').select('*');
        if (settingsError) throw new Error("فشل تحميل إعدادات المسير");
        
        const config = settingsData.reduce((acc, item) => ({...acc, [item.setting_key]: item.setting_value}), {});
        const gosiPercent = parseFloat(config['gosi_percent'] || 9.75) / 100;
        const uniformCost = parseFloat(config['uniform_deduction'] || 150);
        const absenceRules = config['absence_rules'] || [];
        const latenessRules = config['lateness_rules'] || [];
        const startDate = new Date(startDateString);
        const endDate = new Date(endDateString);
        endDate.setHours(23, 59, 59, 999);
        
        const payrollMonth = startDate.getMonth() + 1;
        const payrollYear = startDate.getFullYear();
        const durationInMs = endDate - startDate;
        const durationInDays = Math.floor(durationInMs / (1000 * 60 * 60 * 24)) + 1;
        const daysBasis = config['calc_days_basis'] === 'actual' ? getDaysInMonth(payrollYear, payrollMonth) : 30;
        let attendanceQuery = supabaseClient
            .from('attendance')
            .select('guard_id') 
            .gte('created_at', startDate.toISOString())
            .lte('created_at', endDate.toISOString());
        attendanceQuery = attendanceQuery.like('shift_snapshot->>project', `%${projectVal}%`);
        if (regionVal) attendanceQuery = attendanceQuery.like('shift_snapshot->>region', `%${regionVal}%`);
        if (cityVal) attendanceQuery = attendanceQuery.like('shift_snapshot->>city', `%${cityVal}%`);
        if (locationVal) attendanceQuery = attendanceQuery.like('shift_snapshot->>location', `%${locationVal}%`);

        const { data: filteredAttendance, error: e1 } = await attendanceQuery;
        if (e1) throw e1;

        if (!filteredAttendance || filteredAttendance.length === 0) {
            throw new Error('لم يتم العثور على سجلات حضور لهذا المشروع في الفترة المحددة.');
        }

        const employeeIds = [...new Set(filteredAttendance.map(rec => rec.guard_id))];
        const [
            { data: allEmployees },
            { data: attendanceRecords },
            { data: penalties },
            { data: overtimeRecords }
        ] = await Promise.all([
            supabaseClient.from('users').select('*, job_vacancies!users_vacancy_id_fkey(*)').in('id', employeeIds),
            supabaseClient.from('attendance').select('*').in('guard_id', employeeIds).gte('created_at', startDate.toISOString()).lte('created_at', endDate.toISOString()),
            supabaseClient.from('penalties').select('*').in('user_id', employeeIds).gte('deduction_date', startDateString).lte('deduction_date', endDateString),
            supabaseClient.from('overtime_records').select('*').in('employee_id', employeeIds).gte('created_at', startDate.toISOString()).lte('created_at', endDate.toISOString())
        ]);
        const payrollDraftData = allEmployees.map(emp => {
            const empRecords = attendanceRecords.filter(r => r.guard_id === emp.id);
            
            const lastRecord = empRecords[empRecords.length - 1];
            const lastSnapshot = lastRecord?.shift_snapshot;
            const sourceData = lastSnapshot || emp.job_vacancies || emp;
            
            const basic = parseFloat(sourceData.base_salary || emp.basic_salary || 0);
            const housing = parseFloat(sourceData.housing_allowance || 0);
            const transport = parseFloat(sourceData.transport_allowance || 0);
            const other = parseFloat(sourceData.other_allowances || emp.other_allowance || 0);
            
            const totalSalary = basic + housing + transport + other;
            const dailyRate = totalSalary / daysBasis; // قيمة اليومية ثابتة بناءً على الراتب الشهري
            const recordStatuses = empRecords.map(r => r.status);
            const workedDays = recordStatuses.filter(s => s.includes('حاضر') || s.includes('اكمل')).length;
            const absentRecords = empRecords.filter(r => r.status.includes('غياب') && !r.is_excused && !r.status.includes('تم تغطيته'));
            const absentDays = absentRecords.length;
            const coveredDays = empRecords.filter(r => r.status.includes('تم تغطيته')).length;
            const withdrawalRecords = empRecords.filter(r => r.status.includes('انسحاب'));
            const totalRecords = workedDays + absentDays + coveredDays;
            let restDays = Math.max(0, durationInDays - totalRecords);
            if (workedDays === 0 && coveredDays === 0) restDays = 0;
            let totalAbsenceDeduction = 0;
            absentRecords.forEach((_, index) => {
                const penalty = calculateAbsencePenalty(index + 1, absenceRules, dailyRate);
                totalAbsenceDeduction += penalty.amount;
            });
            let totalLatenessDeduction = 0;
            let totalLatenessMinutes = 0;
            empRecords.forEach(rec => {
                if ((rec.status.includes('حاضر') || rec.status.includes('اكمل')) && rec.shift_snapshot?.schedule_details) {
                    const schedule = rec.shift_snapshot.schedule_details[0];
                    const period = schedule.periods ? schedule.periods[0] : schedule;
                    if (period && period.start_time) {
                        const shiftStart = new Date(`${rec.created_at.split('T')[0]}T${period.start_time}`);
                        const actualCheckin = new Date(rec.created_at);
                        const diffMs = actualCheckin - shiftStart;
                        if (diffMs > 60000) {
                            const minutes = Math.floor(diffMs / 60000);
                            totalLatenessMinutes += minutes;
                            totalLatenessDeduction += calculateLatenessPenalty(minutes, latenessRules, dailyRate);
                        }
                    }
                }
            });
            const empPenalties = penalties.filter(p => p.user_id === emp.id);
            const loanDeductions = empPenalties.filter(p => p.reason.includes('سلفة')).reduce((sum, p) => sum + (p.amount || 0), 0);
            const otherDeductions = empPenalties.filter(p => !p.reason.includes('سلفة')).reduce((sum, p) => sum + (p.amount || 0), 0);
            
            const gosiDeduction = emp.insurance_status === 'مسجل' ? (basic + housing) * gosiPercent : 0;
            const uniformDeduction = (emp.has_received_uniform === false) ? uniformCost : 0;
            const employeeOvertimeTotal = overtimeRecords.filter(o => o.employee_id === emp.id).reduce((sum, o) => sum + (o.overtime_pay || 0), 0);
            const payableDays = workedDays + restDays + coveredDays;
            const basePayForPeriod = payableDays * dailyRate;
            const grossPayable = basePayForPeriod + employeeOvertimeTotal;
            const totalDeductions = totalAbsenceDeduction + totalLatenessDeduction + loanDeductions + otherDeductions + gosiDeduction + uniformDeduction;
            const netSalary = grossPayable - totalDeductions;

            return {
                id: emp.id,
                name: emp.name,
                id_number: emp.id_number,
                role: emp.role,
                
                region: lastSnapshot?.region || emp.region || '-',
                city: lastSnapshot?.city || emp.city || '-',
                project: lastSnapshot?.project || (Array.isArray(emp.project) ? emp.project.join(', ') : emp.project) || '-',
                location: lastSnapshot?.location || emp.location || '-',
                basic_salary: basic,
                housing: housing,
                transport: transport,
                other: other,
                total_gross: totalSalary, // الراتب الشهري الكامل كمرجع
                daily_rate: parseFloat(dailyRate.toFixed(2)),
                worked_days: workedDays,
                rest_days: restDays,
                absent_days: absentDays,
                withdrawal_count: withdrawalRecords.length,
                covered_days: coveredDays,
                lateness_minutes: totalLatenessMinutes,
                deductions: {
                    absence: parseFloat(totalAbsenceDeduction.toFixed(2)),
                    lateness: parseFloat(totalLatenessDeduction.toFixed(2)),
                    gosi: parseFloat(gosiDeduction.toFixed(2)),
                    uniform: uniformDeduction,
                    loan: loanDeductions,
                    other: otherDeductions,
                    total: parseFloat(totalDeductions.toFixed(2))
                },
                additions: {
                    rest_allowance: 0, // تم دمج الراحة في basePayForPeriod، نترك هذا للمكافآت الإضافية
                    overtime: parseFloat(employeeOvertimeTotal.toFixed(2)),
                    gross_payable: parseFloat(grossPayable.toFixed(2)) // هذا المبلغ الصحيح للفترة
                },

                net_salary: parseFloat(netSalary.toFixed(2)),
                iban: emp.iban,
                bank_name: emp.bank_name,
                status: 'pending',
                note: ''
            };
        });
        const draftPayload = {
            month: payrollMonth,
            year: payrollYear,
            status: 'draft',
            created_by_user_id: currentUser.id,
            payroll_data: payrollDraftData
        };

        const { data: draft, error: draftError } = await supabaseClient
            .from('payroll_drafts')
            .insert(draftPayload)
            .select('id')
            .single();

        if (draftError) throw draftError;

        resultsContainer.innerHTML = `
            <div class="empty-state" style="border-color: #22c55e; background-color: #f0fdf4;">
                <i class="ph-bold ph-check-circle" style="color: #22c55e;"></i>
                <h4>تم إنشاء مسودة المسير بنجاح!</h4>
                <p>الفترة: ${durationInDays} يوم | الموظفين: ${payrollDraftData.length}</p>
                <button class="btn btn-primary" onclick="openPayrollDraftEditor('${draft.id}')">
                    <i class="ph-bold ph-pencil-simple"></i> فتح المسودة للمراجعة والتعديل
                </button>
            </div>
        `;

    } catch (err) {
        resultsContainer.innerHTML = `<p style="color: red;">حدث خطأ: ${err.message}</p>`;
        console.error("Payroll Gen Error:", err);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="ph-bold ph-calculator"></i> توليد المسير';
    }
}
async function generateComprehensiveAttendanceReport(dateFrom, dateTo, filters, specificUsers = null) {
    const startDate = new Date(dateFrom + 'T00:00:00.000Z');
    const endDate = new Date(dateTo + 'T00:00:00.000Z');

    let filteredUsers;
    if (specificUsers) {
        filteredUsers = specificUsers;
    } else {
        let usersQuery = supabaseClient
            .from('users')
            .select(`id, name, start_of_work_date, region, project, city, location, id_number, job_vacancies!users_vacancy_id_fkey(schedule_details)`)
            .eq('role', 'حارس أمن');
if (currentUser.role === 'ادارة الموارد البشرية' && currentUser.region) {
    usersQuery = usersQuery.eq('region', currentUser.region);
}

        if (filters.searchVal) usersQuery = usersQuery.or(`name.ilike.%${filters.searchVal}%,id_number.ilike.%${filters.searchVal}%`);
        if (filters.region) usersQuery = usersQuery.eq('region', filters.region);
        if (filters.city) usersQuery = usersQuery.eq('city', filters.city);
        if (filters.project) usersQuery = usersQuery.filter('project', 'cs', `{"${filters.project}"}`);
        if (filters.location) usersQuery = usersQuery.eq('location', filters.location);
        if (currentUser.role === 'ادارة العمليات' && currentUser.region) {
            usersQuery = usersQuery.eq('region', currentUser.region);
        }

        const { data, error: usersError } = await usersQuery;
        if (usersError) throw usersError;
        filteredUsers = data;
    }

    if (filteredUsers.length === 0) return [];

    const userIds = filteredUsers.map(u => u.id);
    const { data: realRecords, error: recordsError } = await supabaseClient
        .from('attendance')
        .select('*')
        .in('guard_id', userIds)
        .gte('created_at', startDate.toISOString())
        .lte('created_at', new Date(endDate.getTime() + 24 * 60 * 60 * 1000).toISOString());

    if (recordsError) throw recordsError;
    let comprehensiveReport = [];
    if (realRecords) {
        realRecords.forEach(record => {
            const userForRecord = filteredUsers.find(u => u.id === record.guard_id);
            if (userForRecord) {
                comprehensiveReport.push({ ...record, users: userForRecord });
            }
        });
    }
    return comprehensiveReport.filter(r => {
        if (filters.status && r.status !== filters.status) return false;
        return true;
    });
}

async function exportPayrollToExcel(data, filename) {
    if (data.length === 0) return alert('لا توجد بيانات للتصدير.');

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('مسير رواتب', {
        views: [{ rightToLeft: true }]
    });

    const headerStyle = {
        font: { name: 'Cairo', size: 12, bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } },
        alignment: { horizontal: 'center', vertical: 'middle' },
        border: { bottom: { style: 'thin', color: { argb: 'FF000000' } } }
    };
    const cellStyle = { font: { name: 'Cairo', size: 10 }, alignment: { horizontal: 'center', vertical: 'middle' } };
    const moneyStyle = { ...cellStyle, numFmt: '#,##0.00 "ر.س"' };
    const totalStyle = { ...moneyStyle, font: { ...cellStyle.font, bold: true }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE7E6E6' } } };

    worksheet.columns = Object.keys(data[0]).map(key => ({
        header: key, key: key, width: 18, style: cellStyle
    }));

    worksheet.addRows(data);
    const nonMoneyColumns = ['ايام العمل', 'ساعات العمل', 'راحة', 'ايام الغياب', 'استئذان', 'انسحاب', 'اجمالي تغطيات الموقع', 'ايام تغطية الموقع'];

    worksheet.eachRow({ includeEmpty: false }, function(row, rowNumber) {
        row.height = 25;
        row.eachCell({ includeEmpty: true }, function(cell, colNumber) {
            if (rowNumber === 1) {
                cell.style = headerStyle;
                return;
            }
            const key = worksheet.getColumn(colNumber).key;
            if (['اجمالي الراتب', 'مجموع الاستقطاعات', 'الصافي'].includes(key)) {
                cell.style = totalStyle;
            }
            if (typeof cell.value === 'number' && !nonMoneyColumns.includes(key)) {
                cell.numFmt = moneyStyle.numFmt;
            }
        });
    });

    workbook.xlsx.writeBuffer().then(function(buffer) {
        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename.replace('.csv', '.xlsx');
        link.click();
    });
}
async function loadHolidaysPage() {
    const container = document.getElementById('holidays-list-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل...</p>';

    const { data: holidays, error } = await supabaseClient
        .from('official_holidays')
        .select('*')
        .order('holiday_date', { ascending: false });

    if (error) {
        container.innerHTML = '<p style="color:red;">حدث خطأ في جلب العطلات.</p>';
        return console.error(error);
    }
    if (holidays.length === 0) {
        container.innerHTML = '<p style="text-align: center;">لا توجد عطلات مسجلة حالياً.</p>';
        return;
    }

    container.innerHTML = holidays.map(holiday => `
        <div class="attendance-card" style="padding: 15px; margin-bottom: 10px;">
            <div>
                <span>${holiday.description}</span>
                <p class="time">${new Date(holiday.holiday_date).toLocaleDateString('ar-SA')}</p>
            </div>
            <button class="btn-action delete-holiday-btn" data-id="${holiday.id}" title="حذف العطلة">
                <i class="ph-bold ph-trash"></i>
            </button>
        </div>
    `).join('');
}
async function fetchStatistics() {
    const safeUpdate = (selector, value) => {
        const element = document.querySelector(selector);
        if (element) { // يتحقق أولاً إذا كان العنصر موجوداً قبل محاولة التعديل
            element.textContent = value;
        }
    };
    const [
        { count: clientsCount, error: e1 },
        { count: usersCount, error: e2 },
        { count: visitsCount, error: e3 },
        { count: schedulesCount, error: e4 }
    ] = await Promise.all([
        supabaseClient.from('clients').select('*', { count: 'exact', head: true }),
        supabaseClient.from('users').select('*', { count: 'exact', head: true }),
        supabaseClient.from('visits').select('*', { count: 'exact', head: true }),
        supabaseClient.from('schedules').select('*', { count: 'exact', head: true })
    ]);

    if (e1 || e2 || e3 || e4) {
        console.error("خطأ في جلب الإحصائيات:", e1 || e2 || e3 || e4);
    }
    safeUpdate('#stats-clients h3', clientsCount || 0);
    safeUpdate('#stats-users h3', usersCount || 0);
    safeUpdate('#stats-visits h3', visitsCount || 0);
    safeUpdate('#stats-schedules h3', schedulesCount || 0);
}
navigator.serviceWorker.addEventListener('controllerchange', () => {
    sessionStorage.setItem('update_in_progress', 'true');
const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
if (isLocalhost) {
    window.location.href = '/';
} else {
    window.location.reload();
}
});

document.addEventListener('visibilitychange', () => {
    if (sessionStorage.getItem('update_in_progress')) return;

    if (document.visibilityState === 'visible') {
        if (updateCheckInterval) {
            clearInterval(updateCheckInterval);
            updateCheckInterval = null;
        }
        checkForUpdates();
    } else {
        if (updateCheckInterval) clearInterval(updateCheckInterval);
        updateCheckInterval = setInterval(checkForUpdates, 300000); // كل 5 دقائق
    }
});
document.addEventListener('DOMContentLoaded', async function() {
document.getElementById('settlement-add-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = document.getElementById('save-new-settlement-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الحفظ...';

    try {
        const files = document.getElementById('settlement-attachments').files;
        let attachmentUrls = []; // مصفوفة لتخزين روابط المرفقات
        if (files.length > 0) {
            const uploadPromises = Array.from(files).map(file => {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
                const filePath = `${currentUser.id}/${fileName}`; // استخدام auth_user_id
                return supabaseClient.storage
                    .from('settlement_attachments') // اسم الحاوية الصحيح
                    .upload(filePath, file);
            });
            
            const uploadResults = await Promise.all(uploadPromises);
            
            uploadResults.forEach(result => {
                if (result.error) {
                    throw new Error(`فشل رفع أحد المرفقات: ${result.error.message}`);
                }
                attachmentUrls.push(result.data.path); // حفظ المسار فقط
            });
        }
        const settlementData = {
            case_title: document.getElementById('settlement-title').value,
            case_type: document.getElementById('settlement-type').value,
            claimant: document.getElementById('settlement-claimant').value,
            respondent: document.getElementById('settlement-respondent').value,
            filing_date: document.getElementById('settlement-filing-date').value || null,
            settlement_amount_requested: parseFloat(document.getElementById('settlement-amount-requested').value) || null,
            summary: document.getElementById('settlement-summary').value,
            status: 'قيد التفاوض', // الحالة الافتراضية
            added_by_user_id: currentUser.id
        };
        const { data: newSettlement, error: insertError } = await supabaseClient
            .from('friendly_settlements')
            .insert(settlementData)
            .select('id') // طلب إرجاع ID الملف الجديد
            .single();

        if (insertError) throw insertError;
        if (attachmentUrls.length > 0) {
            await supabaseClient.from('settlement_updates').insert({
                settlement_id: newSettlement.id,
                update_date: new Date().toISOString().split('T')[0],
                description: 'المرفقات الأولية عند فتح الملف.',
                next_step: 'مراجعة أولية',
                attachment_urls: attachmentUrls,
                created_by_user_id: currentUser.id
            });
        }

        showToast('تم فتح ملف التسوية بنجاح.', 'success');
        document.getElementById('settlement-add-modal').classList.add('hidden');
        loadSettlementsPage(); // تحديث القائمة

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'حفظ وبدء تتبع الملف';
    }
});
document.body.addEventListener('submit', async function(event) {
    if (event.target.id === 'settlement-update-form') {
        event.preventDefault();
        const saveBtn = document.getElementById('save-settlement-update-btn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري...';

        try {
            const settlementId = document.getElementById('update-settlement-id').value;
            const files = document.getElementById('update-attachments').files;
            let attachmentUrls = [];

            if (files.length > 0) {
                const uploadPromises = Array.from(files).map(file => {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
                    const filePath = `${currentUser.id}/${settlementId}/${fileName}`;
                    return supabaseClient.storage
                        .from('settlement_attachments')
                        .upload(filePath, file);
                });
                const uploadResults = await Promise.all(uploadPromises);
                
                uploadResults.forEach(result => {
                    if (result.error) throw new Error(`فشل رفع مرفق: ${result.error.message}`);
                    attachmentUrls.push(result.data.path);
                });
            }

            const updateData = {
                settlement_id: settlementId,
                update_date: document.getElementById('update-date').value,
                description: document.getElementById('update-description').value,
                next_step: document.getElementById('update-next-step').value || null,
                attachment_urls: attachmentUrls.length > 0 ? attachmentUrls : null,
                created_by_user_id: currentUser.id
            };

            const { error: insertError } = await supabaseClient.from('settlement_updates').insert(updateData);
            if (insertError) throw insertError;

            showToast('تم إضافة التحديث بنجاح.', 'success');
            
            document.getElementById('settlement-view-modal').classList.add('hidden');
            loadSettlementsPage();

        } catch (error) {
            alert(`حدث خطأ: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="ph-bold ph-plus"></i> إضافة التحديث للسجل';
        }
    }
    if (event.target.id === 'settlement-close-form') {
        event.preventDefault();
        const closeBtn = document.getElementById('save-close-settlement-btn');
        
        if (!confirm('هل أنت متأكد من إنهاء هذا الملف؟ لا يمكن التراجع عن هذا الإجراء.')) {
            return;
        }

        closeBtn.disabled = true;
        closeBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الإنهاء...';

        try {
            const settlementId = document.getElementById('close-settlement-id').value;
            const outcome = document.getElementById('settlement-outcome').value;
            const summary = document.getElementById('close-summary').value;

            const updateData = {
                status: 'منتهية',
                outcome: outcome,
                settlement_amount_final: parseFloat(document.getElementById('settlement-amount-final').value) || null,
                summary: summary,
                closed_at: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('friendly_settlements')
                .update(updateData)
                .eq('id', settlementId);
            
            if (error) throw error;

            showToast('تم إنهاء الملف بنجاح.', 'success');
            document.getElementById('settlement-view-modal').classList.add('hidden');
            loadSettlementsPage();

        } catch (error) {
            alert(`حدث خطأ: ${error.message}`);
        } finally {
            closeBtn.disabled = false;
            closeBtn.innerHTML = '<i class="ph-bold ph-gavel"></i> تأكيد وإنهاء الملف';
        }
    }
});
    document.getElementById('lawsuit-add-form')?.addEventListener('submit', async function(event) {
        event.preventDefault();
        const saveBtn = document.getElementById('save-new-lawsuit-btn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الحفظ...';

        try {
            const files = document.getElementById('lawsuit-attachments').files;
            let attachmentUrls = []; // مصفوفة لتخزين روابط المرفقات
            if (files.length > 0) {
                const uploadPromises = Array.from(files).map(file => {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
                    const filePath = `${currentUser.id}/${fileName}`;
                    return supabaseClient.storage
                        .from('lawsuit_attachments') // اسم الحاوية الصحيح
                        .upload(filePath, file);
                });
                
                const uploadResults = await Promise.all(uploadPromises);
                uploadResults.forEach(result => {
                    if (result.error) {
                        throw new Error(`فشل رفع أحد المرفقات: ${result.error.message}`);
                    }
                    attachmentUrls.push(result.data.path); // حفظ المسار فقط
                });
            }
            const lawsuitData = {
                case_title: document.getElementById('lawsuit-title').value,
                case_number: document.getElementById('lawsuit-number').value || null,
                case_type: document.getElementById('lawsuit-type').value,
                plaintiff: document.getElementById('lawsuit-plaintiff').value,
                defendant: document.getElementById('lawsuit-defendant').value,
                court_name: document.getElementById('lawsuit-court').value || null,
                filing_date: document.getElementById('lawsuit-filing-date').value || null,
                summary: document.getElementById('lawsuit-summary').value,
                status: 'قيد النظر', // الحالة الافتراضية
                added_by_user_id: currentUser.id
            };
            const { data: newLawsuit, error: insertError } = await supabaseClient
                .from('lawsuits')
                .insert(lawsuitData)
                .select('id') // طلب إرجاع ID الدعوى الجديدة
                .single();

            if (insertError) throw insertError;
            if (attachmentUrls.length > 0) {
                await supabaseClient.from('lawsuit_updates').insert({
                    lawsuit_id: newLawsuit.id,
                    update_date: new Date().toISOString().split('T')[0],
                    description: 'المرفقات الأولية عند فتح الدعوى.',
                    next_step: 'مراجعة أولية',
                    attachment_urls: attachmentUrls, // حفظ مصفوفة الروابط
                    created_by_user_id: currentUser.id
                });
            }

            showToast('تم فتح الدعوى بنجاح.', 'success');
            document.getElementById('lawsuit-add-modal').classList.add('hidden');
            loadLawsuitsPage(); // تحديث القائمة

        } catch (error) {
            alert(`حدث خطأ: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'حفظ وبدء تتبع الدعوى';
        }
    });
    document.getElementById('blacklist-add-form')?.addEventListener('submit', async function(event) {
        event.preventDefault();
        const saveBtn = document.getElementById('save-to-blacklist-btn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الحفظ...';

        try {
            const name = document.getElementById('blacklist-name').value;
            const id_number = document.getElementById('blacklist-id-number').value;
            const reason = document.getElementById('blacklist-reason').value;
            const file = document.getElementById('blacklist-attachment').files[0];
            let attachmentUrl = null;
            const { data: existing, error: checkError } = await supabaseClient
                .from('employee_blacklist')
                .select('id')
                .eq('id_number', id_number)
                .limit(1)
                .single();
            
            if (existing) {
                throw new Error('هذا الموظف (بنفس رقم الهوية) موجود بالفعل في القائمة السوداء.');
            }
            if (checkError && checkError.code !== 'PGRST116') { // يتجاهل خطأ "عدم العثور على صف"
                throw checkError;
            }
            if (file) {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
                const filePath = `${currentUser.id}/${id_number}-${fileName}`;
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('blacklist_attachments') // اسم الحاوية التي أنشأناها
                    .upload(filePath, file);

                if (uploadError) {
                    throw new Error(`فشل رفع المرفق: ${uploadError.message}`);
                }
                attachmentUrl = uploadData.path; // حفظ المسار فقط
            }
            const recordData = {
                name: name,
                id_number: id_number,
                reason: reason,
                attachment_url: attachmentUrl,
                added_by_user_id: currentUser.id // ربط السجل بمن قام بالإضافة
            };
            const { error: insertError } = await supabaseClient.from('employee_blacklist').insert(recordData);
            if (insertError) throw insertError;

            showToast('تمت إضافة الموظف للقائمة السوداء بنجاح.', 'success');
            document.getElementById('blacklist-add-modal').classList.add('hidden');
            loadBlacklistPage(); // تحديث القائمة

        } catch (error) {
            alert(`حدث خطأ: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'حفظ في القائمة السوداء';
        }
    });
    document.body.addEventListener('submit', async function(event) {
        if (event.target.id === 'lawsuit-update-form') {
            event.preventDefault();
            const saveBtn = document.getElementById('save-lawsuit-update-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري...';

            try {
                const lawsuitId = document.getElementById('update-lawsuit-id').value;
                const files = document.getElementById('update-attachments').files;
                let attachmentUrls = [];
                if (files.length > 0) {
                    const uploadPromises = Array.from(files).map(file => {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
                        const filePath = `${currentUser.id}/${lawsuitId}/${fileName}`;
                        return supabaseClient.storage
                            .from('lawsuit_attachments')
                            .upload(filePath, file);
                    });
                    const uploadResults = await Promise.all(uploadPromises);
                    
                    uploadResults.forEach(result => {
                        if (result.error) throw new Error(`فشل رفع مرفق: ${result.error.message}`);
                        attachmentUrls.push(result.data.path);
                    });
                }
                const updateData = {
                    lawsuit_id: lawsuitId,
                    update_date: document.getElementById('update-date').value,
                    description: document.getElementById('update-description').value,
                    next_step: document.getElementById('update-next-step').value || null,
                    attachment_urls: attachmentUrls.length > 0 ? attachmentUrls : null,
                    created_by_user_id: currentUser.id
                };
                const { error: insertError } = await supabaseClient.from('lawsuit_updates').insert(updateData);
                if (insertError) throw insertError;

                showToast('تم إضافة التحديث بنجاح.', 'success');
                const modalBody = document.getElementById('lawsuit-view-body');
                modalBody.innerHTML = '<p style="text-align: center;">جاري تحديث السجل...</p>';
                document.getElementById('lawsuit-view-modal').classList.add('hidden');
                loadLawsuitsPage(); // تحديث القائمة الرئيسية لإظهار آخر إجراء

            } catch (error) {
                alert(`حدث خطأ: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="ph-bold ph-plus"></i> إضافة التحديث للسجل';
            }
        }
        if (event.target.id === 'lawsuit-close-form') {
            event.preventDefault();
            const closeBtn = document.getElementById('save-close-lawsuit-btn');
            
            if (!confirm('هل أنت متأكد من إنهاء هذه الدعوى؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }

            closeBtn.disabled = true;
            closeBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الإنهاء...';

            try {
                const lawsuitId = document.getElementById('close-lawsuit-id').value;
                const finalJudgment = document.getElementById('close-judgment').value;

                const updateData = {
                    status: 'منتهية',
                    final_judgment: finalJudgment,
                    closed_at: new Date().toISOString()
                };

                const { error } = await supabaseClient
                    .from('lawsuits')
                    .update(updateData)
                    .eq('id', lawsuitId);
                
                if (error) throw error;

                showToast('تم إنهاء الدعوى بنجاح.', 'success');
                document.getElementById('lawsuit-view-modal').classList.add('hidden');
                loadLawsuitsPage(); // تحديث القائمة الرئيسية

            } catch (error) {
                alert(`حدث خطأ: ${error.message}`);
            } finally {
                closeBtn.disabled = false;
                closeBtn.innerHTML = '<i class="ph-bold ph-gavel"></i> تأكيد وإنهاء الدعوى';
            }
        }
    });

    document.getElementById('assign-asset-form')?.addEventListener('submit', async function(event) {
        event.preventDefault();
        const assetId = document.getElementById('assign-asset-item-id').value;
        const employeeId = document.getElementById('assign-to-employee-select').value;
        const employeeName = document.getElementById('assign-to-employee-select').selectedOptions[0].text;

        if (!employeeId) return alert('الرجاء اختيار الموظف.');

        const updateData = {
            assigned_to_user_id: employeeId,
            status: 'مسلمة لموظف',
            assignment_date: document.getElementById('assign-date').value,
            condition: document.getElementById('assign-condition').value,
            notes: document.getElementById('assign-notes').value
        };

        const { error } = await supabaseClient.from('asset_items').update(updateData).eq('id', assetId);
        if (error) {
            alert('حدث خطأ: ' + error.message);
        } else {
            await supabaseClient.from('asset_history_log').insert({
                asset_item_id: assetId,
                event_description: `تم تسليم القطعة إلى الموظف: ${employeeName}`,
                performed_by_user_id: currentUser.id
            });

            showToast('تم تسليم العهدة بنجاح.', 'success');
            document.getElementById('assign-asset-modal').classList.add('hidden');
            loadAdminAssetsPage();
        }
    });
    document.getElementById('vehicle-contract-select')?.addEventListener('change', async function() {
        const contractId = this.value;
        const locationSelect = document.getElementById('vehicle-location-select');
        locationSelect.innerHTML = '<option value="">اختر عقداً أولاً</option>';
        locationSelect.disabled = true;

        if (contractId) {
            locationSelect.innerHTML = '<option value="">جاري تحميل المواقع...</option>';
            const { data: contract } = await supabaseClient.from('contracts').select('contract_locations').eq('id', contractId).single();
            if (contract && contract.contract_locations) {
                locationSelect.innerHTML = '<option value="">-- اختر موقعاً --</option>';
                locationSelect.innerHTML += contract.contract_locations.map(loc => `<option value="${loc.name}">${loc.name}</option>`).join('');
                locationSelect.disabled = false;
            }
        }
    });

document.getElementById('assign-guard-asset-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = this.querySelector('button[type="submit"]');
    saveBtn.disabled = true;

    try {
        const assetId = document.getElementById('ga-available-device-select').value;
        const employeeId = document.getElementById('ga-supervisor-select').value;
        const contractId = document.getElementById('ga-modal-contract-id').value;
        const locationName = document.getElementById('ga-modal-location-name').value;
        const employeeName = document.getElementById('ga-supervisor-select').selectedOptions[0].text;
        const contractName = document.querySelector(`.site-row[data-contract-id="${contractId}"]`).dataset.contractName;

        if (!assetId || !employeeId) throw new Error('الرجاء اختيار الجهاز والموظف المسؤول.');

        const { error } = await supabaseClient
            .from('asset_items')
            .update({
                status: 'مسلمة لموقع',
                assigned_to_user_id: employeeId,
                contract_id: contractId,
                location_name: locationName,
                assignment_date: new Date().toISOString().split('T')[0]
            })
            .eq('id', assetId);
        
        if (error) throw error;

        await supabaseClient.from('asset_history_log').insert({
            asset_item_id: assetId,
            event_description: `تم تسليم الجهاز لموقع (${locationName}) بعهدة الموظف: ${employeeName}`,
            performed_by_user_id: currentUser.id
        });

        showToast('تم تسليم الجهاز للموقع بنجاح.', 'success');
        this.reset(); // إفراغ النموذج
        populateGuardAssetModal(contractId, locationName, contractName); // تحديث بيانات النافذة
        loadGuardAssetsPage(); // تحديث الصفحة الرئيسية في الخلفية

    } catch (error) {
        
    } finally {
        saveBtn.disabled = false;
    }
});
    const ownershipSelect = document.getElementById('vehicle-ownership-type');
    if (ownershipSelect) {
        ownershipSelect.addEventListener('change', function() {
            const rentalFields = document.getElementById('vehicle-rental-fields');
            const rentalInputs = rentalFields.querySelectorAll('input');

            if (this.value === 'إيجار') {
                rentalFields.classList.remove('hidden');
                rentalInputs.forEach(input => input.required = true); // جعلها إجبارية
            } else {
                rentalFields.classList.add('hidden');
                rentalInputs.forEach(input => {
                    input.required = false; // جعلها غير إجبارية
                    input.value = ''; // إفراغ القيم عند الإخفاء
                });
            }
        });
    }
document.getElementById('add-edit-category-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = this.querySelector('button[type="submit"]');
    const categoryId = document.getElementById('category-id').value;
    const categoryName = document.getElementById('category-name').value.trim();

    if (!categoryName) return alert('الرجاء إدخال اسم الفئة.');

    saveBtn.disabled = true;

    try {
        const fields = [];
        document.querySelectorAll('#category-fields-container .category-field-row').forEach(row => {
            const fieldName = row.querySelector('.category-field-name').value.trim();
            if (fieldName) {
                fields.push({ name: fieldName }); // حالياً نحفظ الاسم فقط، يمكن تطويره لاحقاً
            }
        });

        const categoryData = {
            name: categoryName,
            defined_fields: fields
        };
        if (categoryId) {
            categoryData.id = categoryId;
        }
        const { error } = await supabaseClient.from('assets_inventory').upsert(categoryData);

        if (error) {
            throw new Error('قد يكون هذا الاسم مستخدماً بالفعل.');
        }

        showToast('تم حفظ الفئة بنجاح.', 'success');
        document.getElementById('add-edit-category-modal').classList.add('hidden');
        loadInventoryPage(); // إعادة تحميل الواجهة الرئيسية للمخزون

    } catch (err) {
        alert(`حدث خطأ: ${err.message}`);
    } finally {
        saveBtn.disabled = false;
    }
});
document.getElementById('add-asset-item-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = document.getElementById('save-asset-item-btn');
    saveBtn.disabled = true;

    try {
        const inventoryId = document.getElementById('asset-item-inventory-id').value;
        const itemsToInsert = [];
        const itemGroups = document.querySelectorAll('#asset-items-list-container .asset-item-group');

        itemGroups.forEach(group => {
            const details = {};
            group.querySelectorAll('.asset-detail').forEach(input => {
                if (input.value.trim()) {
                    details[input.dataset.key] = input.value.trim();
                }
            });

            if (Object.keys(details).length > 0) {
                itemsToInsert.push({
                    inventory_id: inventoryId,
                    status: 'في المخزن',
                    details: details
                });
            }
        });

        if (itemsToInsert.length === 0) {
            throw new Error('الرجاء تعبئة بيانات عهدة واحدة على الأقل.');
        }

        const { error } = await supabaseClient.from('asset_items').insert(itemsToInsert);
        if (error) throw error;

        showToast(`تم إضافة ${itemsToInsert.length} قطعة بنجاح!`, 'success');
        document.getElementById('add-asset-item-modal').classList.add('hidden');
        loadInventoryPage();

    } catch (error) {
        alert('خطأ في الحفظ: ' + error.message);
    } finally {
        saveBtn.disabled = false;
    }
});
document.getElementById('admin-asset-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = document.getElementById('save-admin-asset-btn');
    saveBtn.disabled = true;

    try {
        const assetItemId = document.getElementById('admin-asset-id').value;
        const employeeId = document.getElementById('admin-asset-employee').value;

        if (!assetItemId) throw new Error('لم يتم تحديد قطعة العهدة.');

        let dataToUpdate = {
            assignment_date: document.getElementById('admin-asset-date').value,
            condition: document.getElementById('admin-asset-condition').value,
            notes: document.getElementById('admin-asset-notes').value || null
        };

        const statusValue = document.getElementById('admin-asset-status').value;

        if (statusValue === 'مرتجع') {
            dataToUpdate.status = 'في المخزن';
            dataToUpdate.assigned_to_user_id = null;
            dataToUpdate.assignment_date = null;
        } else {
            dataToUpdate.status = statusValue === 'في الخدمة' ? 'مسلمة' : statusValue;
            if (employeeId) {
                dataToUpdate.assigned_to_user_id = employeeId;
                dataToUpdate.status = 'مسلمة'; // فرض الحالة إلى "مسلمة" عند اختيار موظف
            }
        }

        const { error } = await supabaseClient
            .from('asset_items')
            .update(dataToUpdate)
            .eq('id', assetItemId);

        if (error) throw error;

        showToast('تم حفظ البيانات بنجاح.', 'success');
        document.getElementById('admin-asset-modal').classList.add('hidden');
        loadAdminAssetsPage(); // تحديث القائمة الرئيسية
        const detailsModal = document.getElementById('inventory-details-modal');
        if (!detailsModal.classList.contains('hidden')) {
            const inventoryId = document.getElementById('add-item-from-details-btn').dataset.inventoryId;
            const categoryName = document.getElementById('add-item-from-details-btn').dataset.categoryName;
            populateInventoryDetailsModal(inventoryId, categoryName);
        }

    } catch (error) {
        alert('خطأ في الحفظ: ' + error.message);
    } finally {
        saveBtn.disabled = false;
    }
});
document.addEventListener('input', function(event) {
    if (event.target.classList.contains('admin-assets-filter')) {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            if (document.querySelector('#page-admin-assets:not(.hidden)')) {
                loadAdminAssetsPage();
            }
        }, 500);
    }
});

document.addEventListener('change', function(event) {
    if (event.target.classList.contains('admin-assets-filter')) {
        if (document.querySelector('#page-admin-assets:not(.hidden)')) {
            loadAdminAssetsPage();
        }
    }
});
function createAssetFieldsHtml(fields, itemNumber) {
    const fieldsHtml = fields.map(field => `
        <div class="form-group">
            <label>${field.name}</label>
            <input type="text" class="asset-detail-input" data-key="${field.name}" required>
        </div>
    `).join('');

    return `
        <div class="asset-item-form-group" style="padding: 15px; border: 1px dashed var(--border-color); border-radius: 8px; margin-bottom: 15px;">
            <strong style="display: block; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">القطعة #${itemNumber}</strong>
            <div class="form-grid">${fieldsHtml}</div>
        </div>
    `;
}
document.getElementById('add-item-category-select')?.addEventListener('change', async function() {
    const categoryId = this.value;
    const fieldsContainer = document.getElementById('dynamic-asset-fields-container');
    const addAnotherBtn = document.getElementById('add-another-asset-form-btn');
    addAnotherBtn.classList.add('hidden');
    fieldsContainer.innerHTML = '';
    
    if (!categoryId) {
        fieldsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">الرجاء اختيار فئة لعرض حقولها المخصصة.</p>';
        return;
    }

    fieldsContainer.innerHTML = '<p style="text-align: center;">جاري تحميل الحقول...</p>';
    const { data: category, error } = await supabaseClient
        .from('assets_inventory')
        .select('defined_fields')
        .eq('id', categoryId)
        .single();
    
    if (error || !category || !category.defined_fields) {
        fieldsContainer.innerHTML = '<p style="color:red;">خطأ في تحميل الحقول لهذه الفئة.</p>';
        return;
    }

    const fields = category.defined_fields;
    fieldsContainer.dataset.fields = JSON.stringify(fields); 
    fieldsContainer.dataset.itemCount = 1; // تعيين عداد القطع
    fieldsContainer.innerHTML = createAssetFieldsHtml(fields, 1);
    addAnotherBtn.classList.remove('hidden'); // إظهار زر "إضافة آخر"
});
document.getElementById('add-another-asset-form-btn')?.addEventListener('click', function() {
    const fieldsContainer = document.getElementById('dynamic-asset-fields-container');
    const fields = JSON.parse(fieldsContainer.dataset.fields || '[]');
    let itemCount = parseInt(fieldsContainer.dataset.itemCount || 1, 10) + 1;
    fieldsContainer.dataset.itemCount = itemCount;
    fieldsContainer.insertAdjacentHTML('beforeend', createAssetFieldsHtml(fields, itemCount));
});
document.getElementById('add-asset-item-form-new')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = document.getElementById('save-new-asset-item-btn');
    const modal = document.getElementById('add-admin-asset-item-modal');
    const assetItemId = modal.dataset.editId; // سنستخدم هذا لتحديد وضع التعديل

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الحفظ...';

    try {
        const itemFormGroups = document.querySelectorAll('#dynamic-asset-fields-container .asset-item-form-group');
        const itemsToProcess = [];
        itemFormGroups.forEach(group => {
            const details = {};
            group.querySelectorAll('.asset-detail-input').forEach(input => {
                const key = input.dataset.key;
                const value = input.value.trim();
                if (value) details[key] = value;
            });
            if (Object.keys(details).length > 0) itemsToProcess.push({ details });
        });

        if (itemsToProcess.length === 0) throw new Error('الرجاء تعبئة بيانات العهدة.');

        if (assetItemId) { // --- وضع التعديل ---
            const { error } = await supabaseClient
                .from('asset_items')
                .update({ details: itemsToProcess[0].details })
                .eq('id', assetItemId);
            if (error) throw error;
            await supabaseClient.from('asset_history_log').insert({
                asset_item_id: assetItemId,
                event_description: 'تم تعديل بيانات القطعة.',
                performed_by_user_id: currentUser.id
            });
            showToast('تم تعديل بيانات العهدة بنجاح!', 'success');

        } else { // --- وضع الإضافة ---
            const categoryId = document.getElementById('add-item-category-select').value;
            if (!categoryId) throw new Error('الرجاء اختيار الفئة.');
            
            const itemsToInsert = itemsToProcess.map(item => ({
                inventory_id: categoryId,
                status: 'متوفر في المخزن',
                details: item.details
            }));

            const { data: insertedItems, error } = await supabaseClient.from('asset_items').insert(itemsToInsert).select('id');
            if (error) throw error;
            const historyLogs = insertedItems.map(item => ({
                asset_item_id: item.id,
                event_description: 'تم إضافة القطعة إلى المخزون.',
                performed_by_user_id: currentUser.id
            }));
            await supabaseClient.from('asset_history_log').insert(historyLogs);
            showToast(`تم إضافة ${itemsToInsert.length} قطعة جديدة للمخزون!`, 'success');
        }

        modal.classList.add('hidden');
        loadAdminAssetsPage();

    } catch (error) {
        alert('حدث خطأ: ' + error.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> حفظ';
        delete modal.dataset.editId; // تنظيف وضع التعديل
    }
});
document.getElementById('vehicle-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = document.getElementById('save-vehicle-btn');
    saveBtn.disabled = true;

    try {
        const id = document.getElementById('vehicle-id').value;
        const vehicleData = {
            vehicle_type: document.getElementById('vehicle-type').value,
            license_plate: document.getElementById('vehicle-license-plate').value,
            registration_expiry_date: document.getElementById('vehicle-reg-expiry').value,
            status: document.getElementById('vehicle-status').value,
            ownership_type: document.getElementById('vehicle-ownership-type').value,
            rental_office_name: document.getElementById('vehicle-rental-office').value || null,
            rental_office_contact: document.getElementById('vehicle-rental-contact').value || null,
            assigned_employee_id: document.getElementById('vehicle-supervisor').value || null,
            contract_id: document.getElementById('vehicle-contract-select').value || null,
            location_name: document.getElementById('vehicle-location-select').value || null
        };

        let eventDescription = '';
        let vehicleIdForLog;

        if (id) { // حالة التعديل
            const { error } = await supabaseClient.from('vehicles').update(vehicleData).eq('id', id);
            if (error) throw error;
            eventDescription = 'تم تعديل بيانات المركبة.';
            vehicleIdForLog = id;
        } else { // حالة الإضافة
            const { data: newVehicle, error } = await supabaseClient.from('vehicles').insert(vehicleData).select().single();
            if (error) throw error;
            eventDescription = 'تمت إضافة المركبة إلى المخزون.';
            vehicleIdForLog = newVehicle.id;
        }

        await supabaseClient.from('vehicle_history_log').insert({
            vehicle_id: vehicleIdForLog,
            event_description: eventDescription,
            performed_by_user_id: currentUser.id
        });

        showToast('تم حفظ المركبة بنجاح.', 'success');
        document.getElementById('vehicle-modal').classList.add('hidden');
        
        if (document.querySelector('#page-vehicles:not(.hidden)')) {
            const activeTabId = document.querySelector('#page-vehicles .tab-link.active').dataset.tab;
            if (activeTabId === 'vehicle-management-tab') {
                loadAllVehiclesView();
            } else {
                loadVehicleAssignmentView();
            }
        }

    } catch (error) {
        alert('خطأ في الحفظ: ' + error.message);
    } finally {
        saveBtn.disabled = false;
    }
});
    document.getElementById('inventory-item-form')?.addEventListener('submit', async function(event) {
        event.preventDefault();
        const saveBtn = document.getElementById('save-inventory-item-btn');
        saveBtn.disabled = true;

        try {
            const id = document.getElementById('inventory-item-id').value;
            const newTotalQuantity = parseInt(document.getElementById('inventory-total-quantity').value);
            
            const itemData = {
                asset_type: document.getElementById('inventory-asset-type').value,
                total_quantity: newTotalQuantity,
                details: document.getElementById('inventory-details').value ? JSON.parse(document.getElementById('inventory-details').value) : null
            };

            if (id) { // حالة التعديل
                const { data: currentItem, error: fetchError } = await supabaseClient.from('assets_inventory').select('total_quantity, in_stock_quantity').eq('id', id).single();
                if(fetchError) throw fetchError;

                const quantityDifference = newTotalQuantity - currentItem.total_quantity;
                itemData.in_stock_quantity = currentItem.in_stock_quantity + quantityDifference;

                if (itemData.in_stock_quantity < 0) {
                    throw new Error('لا يمكن أن تكون الكمية الإجمالية أقل من عدد العهد الموزعة حالياً.');
                }

                const { error } = await supabaseClient.from('assets_inventory').update(itemData).eq('id', id);
                if (error) throw error;

            } else { // حالة الإضافة
                itemData.in_stock_quantity = newTotalQuantity; // عند الإضافة، المخزون = الإجمالي
                const { error } = await supabaseClient.from('assets_inventory').insert(itemData);
                if (error) throw error;
            }

            showToast('تم حفظ البيانات بنجاح.', 'success');
            document.getElementById('inventory-item-modal').classList.add('hidden');
            loadInventoryPage();

        } catch (error) {
            alert('حدث خطأ أثناء الحفظ: ' + error.message);
        } finally {
            saveBtn.disabled = false;
        }
    });
document.body.addEventListener('change', async function(event) {
    const checkbox = event.target;
    if (checkbox.classList.contains('ui-permission-checkbox')) {
        const userId = checkbox.dataset.userId;
        const pageId = checkbox.dataset.pageId;
        const isChecked = checkbox.checked;
        const actionText = isChecked ? 'منح' : 'سحب';

        checkbox.disabled = true;

        try {
            const { data: user, error: fetchError } = await supabaseClient
                .from('users')
                .select('auth_user_id, ui_permissions')
                .eq('id', userId)
                .single();
            if (fetchError) throw new Error(`لم يتم العثور على الموظف.`);

            const currentPermissions = user.ui_permissions?.allowed_pages || [];
            let updatedPermissions;
            if (isChecked) {
                updatedPermissions = [...new Set([...currentPermissions, pageId])];
            } else {
                updatedPermissions = currentPermissions.filter(p => p !== pageId);
            }

            const { error: updateError } = await supabaseClient
                .from('users')
                .update({ ui_permissions: { allowed_pages: updatedPermissions } })
                .eq('id', userId);
            if (updateError) throw updateError;

            showToast(`تم ${actionText} الصلاحية بنجاح.`, 'success');

        } catch (error) {
            showToast(`حدث خطأ: ${error.message}`, 'error');
            checkbox.checked = !isChecked; 
        } finally {
            checkbox.disabled = false;
        }
    }
});
document.body.addEventListener('change', async function(event) {
    const target = event.target;
    if (target.classList.contains('cascading-filter')) {
        const data = await getFilterData();
        const suffix = target.id.split('-').pop();
        const regionSelect = document.getElementById(`hr-filter-region-${suffix}`);
        const citySelect = document.getElementById(`hr-filter-city-${suffix}`);
        const projectSelect = document.getElementById(`hr-filter-project-${suffix}`);
        const locationSelect = document.getElementById(`hr-filter-location-${suffix}`);

        const regionVal = regionSelect.value;
        const cityVal = citySelect.value;
        const projectVal = projectSelect.value;

        if (target.id === regionSelect.id) {
            resetDropdowns([citySelect, projectSelect, locationSelect], 0, ['اختر منطقة', 'اختر مدينة', 'اختر مشروعاً']);
            if (regionVal && data[regionVal]) populateDropdown(citySelect, Object.keys(data[regionVal]).sort(), 'كل المدن');
        } else if (target.id === citySelect.id) {
            resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة', 'اختر مشروعاً']);
            if (regionVal && cityVal && data[regionVal][cityVal]) populateDropdown(projectSelect, Object.keys(data[regionVal][cityVal]).sort(), 'كل المشاريع');
        } else if (target.id === projectSelect.id) {
            resetDropdowns([locationSelect], 0, ['اختر مشروعاً']);
            if (regionVal && cityVal && projectVal && data[regionVal][cityVal][projectVal]) populateDropdown(locationSelect, data[regionVal][cityVal][projectVal].sort(), 'كل المواقع');
        }
    }
    if (target.classList.contains('hr-filter-control')) {
        if (document.querySelector('#page-hr-attendance-log:not(.hidden)')) loadHrAttendanceLogPage();
        if (document.querySelector('#page-attendance-management:not(.hidden)')) loadAttendanceManagementPage();
    }
});

document.body.addEventListener('input', function(event) {
    if (event.target.classList.contains('hr-filter-control') && event.target.type === 'text') {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            if (document.querySelector('#page-hr-attendance-log:not(.hidden)')) loadHrAttendanceLogPage();
            if (document.querySelector('#page-attendance-management:not(.hidden)')) loadAttendanceManagementPage();
        }, 500);
    }
});

    

    if (sessionStorage.getItem('update_in_progress')) {
        sessionStorage.removeItem('update_in_progress');
    }
document.addEventListener('change', async function(event) {
    const target = event.target;
    if (!target.classList.contains('cascading-filter')) return;

    const data = await getFilterData();
    const prefix = target.id.split('-')[1]; // hr, ga, ss, vc, geo
    const suffix = target.id.split('-').pop(); // employees, attlog, etc.
    const pageId = `${prefix}-${suffix}`;

    const regionSelect = document.getElementById(`${pageId}-region`) || document.getElementById(`hr-filter-region-${suffix}`);
    const citySelect = document.getElementById(`${pageId}-city`) || document.getElementById(`hr-filter-city-${suffix}`);
    const projectSelect = document.getElementById(`${pageId}-project`) || document.getElementById(`hr-filter-project-${suffix}`);
    const locationSelect = document.getElementById(`${pageId}-location`) || document.getElementById(`hr-filter-location-${suffix}`);

    if (!regionSelect || !citySelect || !projectSelect || !locationSelect) return;

    const allDropdowns = [citySelect, projectSelect, locationSelect];
    const placeholders = ['اختر منطقة أولاً', 'اختر مدينة أولاً', 'اختر مشروعاً أولاً'];

    const regionVal = regionSelect.value;
    const cityVal = citySelect.value;
    const projectVal = projectSelect.value;

    if (target.id === regionSelect.id) {
        resetDropdowns([citySelect, projectSelect, locationSelect], 0, placeholders);
        if (regionVal && data[regionVal]) {
            populateDropdown(citySelect, Object.keys(data[regionVal]).sort(), 'كل المدن');
        }
    } else if (target.id === citySelect.id) {
        resetDropdowns([projectSelect, locationSelect], 0, ['اختر مدينة أولاً', 'اختر مشروعاً أولاً']);
        if (regionVal && cityVal && data[regionVal][cityVal]) {
            populateDropdown(projectSelect, Object.keys(data[regionVal][cityVal]).sort(), 'كل المشاريع');
        }
    } else if (target.id === projectSelect.id) {
        resetDropdowns([locationSelect], 0, ['اختر مشروعاً أولاً']);
        if (regionVal && cityVal && projectVal && data[regionVal][cityVal][projectVal]) {
            populateDropdown(locationSelect, data[regionVal][cityVal][projectVal].sort(), 'كل المواقع');
        }
    }
    if (document.querySelector('#page-hr-attendance-log:not(.hidden)')) loadHrAttendanceLogPage();
    if (document.querySelector('#page-attendance-management:not(.hidden)')) loadAttendanceManagementPage();
    if (document.querySelector('#page-employees:not(.hidden)')) loadEmployeeTabData();
    if (document.querySelector('#page-penalties:not(.hidden)')) loadPenaltiesPage();
    if (document.querySelector('#page-vacancies:not(.hidden)')) loadVacancyTabData();
    if (document.querySelector('#page-supervisor-schedules:not(.hidden)')) loadSupervisorSchedulesPage();
});
const importContractsBtn = document.getElementById('import-contracts-btn');
const contractFileInput = document.getElementById('contract-import-input');

if (importContractsBtn && contractFileInput) {
    importContractsBtn.addEventListener('click', () => {
        const userChoice = confirm("هل تريد تحميل القالب أم رفع ملف؟\n\nاضغط 'OK' لتحميل القالب.\nاضغط 'Cancel' لرفع ملف موجود.");
        if (userChoice) {
            downloadContractTemplate();
        } else {
            contractFileInput.click();
        }
    });

    contractFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            processContractFile(file);
        }
    });
}
const addContractBtn = document.getElementById('add-contract-btn');
if(addContractBtn) {
    addContractBtn.addEventListener('click', () => {
    });
}
document.getElementById('announcement-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = document.getElementById('save-announcement-btn');
    saveBtn.disabled = true;

    const annId = document.getElementById('announcement-id').value;
    const selectedTargets = Array.from(document.querySelectorAll('input[name="ann_target"]:checked')).map(cb => cb.value);
    if (selectedTargets.length === 0) selectedTargets.push('all');

    const annData = {
        title: document.getElementById('announcement-title').value,
        content: document.getElementById('announcement-content').value,
        type: document.getElementById('announcement-type').value,
        start_date: new Date(document.getElementById('announcement-start-date').value).toISOString(),
        end_date: new Date(document.getElementById('announcement-end-date').value).toISOString(),
        is_active: true,
        created_by: currentUser.name,
        target_roles: selectedTargets // <-- الحقل الجديد
    };

    const { error } = annId
        ? await supabaseClient.from('announcements').update(annData).eq('id', annId)
        : await supabaseClient.from('announcements').insert(annData);

    if (error) {
        alert('حدث خطأ: ' + error.message);
    } else {
        alert('تم حفظ الإعلان بنجاح.');
        loadAnnouncementsPage(); // تحديث القائمة والنموذج
    }
    saveBtn.disabled = false;
});
if (localStorage.getItem('admin_session')) {
    document.getElementById('return-to-admin-banner').classList.remove('hidden');
    document.querySelector('.main-content').style.paddingTop = '60px';
}
document.addEventListener('change', (event) => {
    if (event.target.id === 'employee-insurance') {
        const amountGroup = document.getElementById('insurance-amount-group');
        if (event.target.value === 'مسجل') {
            amountGroup.classList.remove('hidden');
        } else {
            amountGroup.classList.add('hidden');
            document.getElementById('employee-insurance-amount').value = 0;
        }
    }
});

const penaltySearchInput = document.getElementById('penalty-employee-search');
    if(penaltySearchInput) {
        penaltySearchInput.addEventListener('keyup', () => {
            loadPenaltiesPage(penaltySearchInput.value);
        });
    }
const menuBtn = document.getElementById('menu-toggle-btn');
if (menuBtn) {
    menuBtn.innerHTML = '<i class="ph-bold ph-list"></i>';
}
    
    


    console.log('DOM fully loaded and parsed. Initializing listeners.');
    const { data: { session } } = await supabaseClient.auth.getSession();
if (session && session.user) {
    const { data: userProfile } = await supabaseClient
        .from('users')
        .select('*, can_edit_attendance, can_edit_contracts, can_delete_contracts, can_delete_vacancies, can_manage_admin_staff, is_ops_manager, is_hr_manager, is_contracts_manager, is_finance_manager, is_marketing_manager, is_legal_manager, ui_permissions')
        .eq('auth_user_id', session.user.id)
        .single();
    if (userProfile) {
        initializeUserSession(userProfile);
    } else {
        await supabaseClient.auth.signOut();
        document.getElementById('login-page').style.display = 'flex';
    }
} else {
    document.getElementById('login-page').style.display = 'flex';
}
const navLinks = document.querySelectorAll('.sidebar-nav a');
const pageContents = document.querySelectorAll('.page-content');
const mainTitle = document.getElementById('main-title');


navLinks.forEach(link => {
    link.addEventListener('click', function(event) {
        event.preventDefault();
        const href = this.getAttribute('href');
        if (href !== window.location.pathname) {
            history.pushState(null, '', href);
            handleRouteChange();
        }
    });
});

window.addEventListener('popstate', () => handleRouteChange());
document.addEventListener('change', async (event) => {
if (event.target.id === 'coverage-link-vacancy') {
    const vacancyId = event.target.value;
    const projectInput = document.getElementById('coverage-new-project');
    const locationInput = document.getElementById('coverage-new-location');
    const regionInput = document.getElementById('coverage-new-region');
    const cityInput = document.getElementById('coverage-new-city');
    const inputs = [projectInput, locationInput, regionInput, cityInput];
    inputs.forEach(input => {
        input.value = '';
        input.disabled = false;
    });

    if (vacancyId) {
        const { data: vacancy, error } = await supabaseClient
            .from('job_vacancies')
            .select('project, specific_location, region, location') // "location" هنا هو المدينة
            .eq('id', vacancyId)
            .single();
            
        if (vacancy) {
            projectInput.value = vacancy.project || '';
            locationInput.value = vacancy.specific_location || '';
            regionInput.value = vacancy.region || '';
            cityInput.value = vacancy.location || ''; // "location" هو المدينة
            inputs.forEach(input => input.disabled = true);
        }
    }
}
    if (event.target.id === 'vacancy-contract') {
    const contractId = event.target.value;
    const locationGroup = document.getElementById('vacancy-location-group');
    const shiftGroup = document.getElementById('vacancy-shift-group');
    const projectInput = document.getElementById('vacancy-project');
    const locationSelect = document.getElementById('vacancy-location-select');

    locationGroup.classList.add('hidden');
    shiftGroup.classList.add('hidden');
    projectInput.value = '';
    document.getElementById('vacancy-city').value = '';
    locationSelect.innerHTML = '';

    if (!contractId) return;

    const selectedContract = availableVacancyData.find(c => c.id == contractId);
    if (selectedContract) {
        projectInput.value = selectedContract.company_name;
        locationSelect.innerHTML = '<option value="">-- اختر موقعاً --</option>';
        selectedContract.contract_locations.forEach(loc => {
            locationSelect.innerHTML += `<option value="${loc.name}">${loc.name}</option>`;
        });
        locationGroup.classList.remove('hidden');
    }
}

if (event.target.id === 'vacancy-location-select') {
    const locationName = event.target.value;
    const contractId = document.getElementById('vacancy-contract').value;
    const shiftGroup = document.getElementById('vacancy-shift-group');
    const shiftSelect = document.getElementById('vacancy-shift-select');
    const cityInput = document.getElementById('vacancy-city');

    shiftGroup.classList.add('hidden');
    shiftSelect.innerHTML = '';
    cityInput.value = '';

    if (!locationName || !contractId) return;

    const selectedContract = availableVacancyData.find(c => c.id == contractId);
    const selectedLocation = selectedContract?.contract_locations.find(loc => loc.name === locationName);

    if (selectedLocation) {
        cityInput.value = selectedLocation.city || '';
        shiftSelect.innerHTML = '<option value="">-- اختر وردية --</option>';
        selectedLocation.shifts.forEach((shift, index) => {
            const shiftLabel = `${shift.name || `وردية ${index + 1}`} ${createShiftTimeLabel(shift)}`;
            shiftSelect.innerHTML += `<option value='${JSON.stringify(shift)}'>${shiftLabel}</option>`;
        });
        shiftGroup.classList.remove('hidden');
    }
}
    if (event.target.id === 'employee-contract' || event.target.id === 'employee-vacancy') {
    const contractSelect = document.getElementById('employee-contract');
    const vacancySelect = document.getElementById('employee-vacancy');
    const regionInput = document.getElementById('employee-region');
    const cityInput = document.getElementById('employee-city');
    const projectDisplay = document.getElementById('employee-project-display');
    const locationDisplay = document.getElementById('employee-location-display');
    const shiftDisplay = document.getElementById('employee-shift-display');

    const contractId = contractSelect.value;
    const vacancyId = vacancySelect.value;
    if (event.target.id === 'employee-vacancy' && vacancyId) {
        shiftDisplay.value = 'جاري جلب التفاصيل...';
        const { data: vacancy, error } = await supabaseClient
            .from('job_vacancies').select(`*`).eq('id', vacancyId).single();

        if (vacancy) {
            regionInput.value = vacancy.region || '';
            cityInput.value = vacancy.location || '';
            projectDisplay.value = vacancy.project || '';
            locationDisplay.value = vacancy.specific_location || '';
            contractSelect.value = vacancy.contract_id || '';

            const shift = vacancy.schedule_details?.[0];
            shiftDisplay.value = `${shift?.name || 'وردية'} ${createShiftTimeLabel(shift)}`;
        } else {
            shiftDisplay.value = '';
        }
    } 
    else if (event.target.id === 'employee-contract') {
    vacancySelect.innerHTML = '<option value="">جاري التحميل...</option>';
    shiftDisplay.value = '';
    locationDisplay.value = '';
    projectDisplay.value = '';
    const { data: assignedUsers, error: usersError } = await supabaseClient
        .from('users').select('vacancy_id').not('vacancy_id', 'is', null);
    const occupiedVacancyIds = usersError ? [] : assignedUsers.map(u => u.vacancy_id);

    let query = supabaseClient.from('job_vacancies').select('id, project, specific_location, schedule_details');

    if (contractId) {
        const { data: contract } = await supabaseClient.from('contracts').select('region, city, company_name').eq('id', contractId).single();
        if (contract) {
            regionInput.value = contract.region || '';
            cityInput.value = Array.isArray(contract.city) ? contract.city.join(', ') : (contract.city || '');
            projectDisplay.value = contract.company_name || '';
        }
        query = query.eq('contract_id', contractId);
    }
    let orFilter;
    if (occupiedVacancyIds.length > 0) {
        orFilter = `status.eq.open,and(status.eq.closed,id.not.in.(${occupiedVacancyIds.join(',')}))`;
    } else {
        orFilter = `status.eq.open,status.eq.closed`;
    }
    query = query.or(orFilter);

    const { data: availableVacancies, error } = await query;

    vacancySelect.innerHTML = '<option value="">غير مرتبط بشاغر</option>';
    if (availableVacancies && availableVacancies.length > 0) {
         vacancySelect.innerHTML += availableVacancies.map(v => {
            const shift = v.schedule_details?.[0];
            const shiftName = shift?.name || 'وردية';
            const shiftText = `${shiftName} ${createShiftTimeLabel(shift)}`;
            const optionText = `${v.project} - ${v.specific_location || 'موقع عام'} - ${shiftText}`;
            return `<option value="${v.id}">${optionText}</option>`;
        }).join('');
    }
}
    else if (event.target.id === 'employee-vacancy' && !vacancyId) {
        shiftDisplay.value = '';
    }
}
});
document.getElementById('employee-modal')?.addEventListener('input', (event) => {
    if (['assignment-filter-region', 'assignment-filter-contract', 'assignment-search-location'].includes(event.target.id)) {
        const filters = {
            region: document.getElementById('assignment-filter-region').value,
            contract: document.getElementById('assignment-filter-contract').value,
            search: document.getElementById('assignment-search-location').value
        };
        renderAssignmentLists(filters);
    }
});

document.getElementById('employee-modal')?.addEventListener('click', (event) => {
    const availableCard = event.target.closest('#assignment-available-locations .employee-card');
    if (availableCard) {
        const locationData = JSON.parse(availableCard.dataset.location);
        currentAssignedLocations.push(locationData);
        renderAssignmentLists({
            region: document.getElementById('assignment-filter-region').value,
            contract: document.getElementById('assignment-filter-contract').value,
            search: document.getElementById('assignment-search-location').value
        });
    }

    const assignedCardDeleteBtn = event.target.closest('#assignment-assigned-locations .delete-assignment-btn');
    if (assignedCardDeleteBtn) {
        const locationToRemove = JSON.parse(assignedCardDeleteBtn.dataset.location);
        currentAssignedLocations = currentAssignedLocations.filter(loc => 
            !(loc.site === locationToRemove.site && loc.contract === locationToRemove.contract)
        );
        renderAssignmentLists({
            region: document.getElementById('assignment-filter-region').value,
            contract: document.getElementById('assignment-filter-contract').value,
            search: document.getElementById('assignment-search-location').value
        });
    }
});
document.getElementById('marketing-event-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    try {
        const eventId = document.getElementById('marketing-event-id').value;
        const eventData = {
            event_title: document.getElementById('marketing-event-title').value,
            event_start: new Date(document.getElementById('marketing-event-start').value),
            event_end: document.getElementById('marketing-event-end').value ? new Date(document.getElementById('marketing-event-end').value) : null,
            contract_id: document.getElementById('marketing-event-contract').value || null,
            event_description: document.getElementById('marketing-event-description').value,
            user_id: currentUser.id,
            reminder_datetime: document.getElementById('marketing-reminder-datetime').value ? new Date(document.getElementById('marketing-reminder-datetime').value) : null,
            is_reminder_sent: false // إعادة تعيين حالة الإرسال عند كل تعديل
        };


        const { error } = eventId ?
            await supabaseClient.from('marketing_calendar').update(eventData).eq('id', eventId) :
            await supabaseClient.from('marketing_calendar').insert(eventData);

        if (error) throw error;
        showToast('تم حفظ الموعد بنجاح!', 'success');
        document.getElementById('marketing-event-modal').classList.add('hidden');
        loadMarketingCalendarPage();
    } catch (error) {
        alert('حدث خطأ أثناء الحفظ: ' + error.message);
    } finally {
        submitBtn.disabled = false;
    }
});
document.getElementById('legal-event-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    try {
        const eventId = document.getElementById('legal-event-id').value;
        const eventData = {
            event_title: document.getElementById('legal-event-title').value,
            event_start: new Date(document.getElementById('legal-event-start').value),
            event_end: document.getElementById('legal-event-end').value ? new Date(document.getElementById('legal-event-end').value) : null,
            case_number: document.getElementById('legal-case-number').value || null,
            event_description: document.getElementById('legal-event-description').value,
            user_id: currentUser.auth_user_id
        };

        const { error } = await supabaseClient.from('legal_calendar').upsert(eventData);

        if (error) throw error;
        showToast('تم حفظ الموعد بنجاح!', 'success');
        document.getElementById('legal-event-modal').classList.add('hidden');
        loadLegalCalendarPage();
    } catch (error) {
        alert('حدث خطأ أثناء الحفظ: ' + error.message);
    } finally {
        submitBtn.disabled = false;
    }
});

document.getElementById('assign-guard-asset-form')?.addEventListener('submit', async function(event) {
        event.preventDefault();
        const saveBtn = this.querySelector('button[type="submit"]');
        saveBtn.disabled = true;

        try {
            const { data: bravoInventory, error: invError } = await supabaseClient.from('assets_inventory').select('id').eq('asset_type', 'جهاز برافو').single();
            if (invError || !bravoInventory) throw new Error('لم يتم العثور على "جهاز برافو" في المخزون. يرجى إضافته أولاً من صفحة إدارة المخزون.');
            
            const assetData = {
                inventory_id: bravoInventory.id,
                assigned_by_user_id: document.getElementById('ga-supervisor-select').value,
                serial_number: document.getElementById('ga-serial-number').value,
                assignment_date: new Date().toISOString().split('T')[0],
                condition: 'غير محدد',
                status: 'في الخدمة',
                contract_id: document.getElementById('ga-modal-contract-id').value,
                location_name: document.getElementById('ga-modal-location-name').value
            };
            
            const { data, error } = await supabaseClient.functions.invoke('assign-asset-from-inventory', {
                body: { asset_data: assetData },
            });
            if (error) throw error;
            if (data.error) throw new Error(data.error);

            showToast('تم تسليم الجهاز بنجاح.', 'success');
            populateGuardAssetModal(assetData.contract_id, assetData.location_name);
            loadGuardAssetsPage();

        } catch (error) {
            alert('خطأ في الحفظ: ' + error.message);
        } finally {
            saveBtn.disabled = false;
        }
    });
document.addEventListener('change', function(event) {
    if (event.target.classList.contains('finance-filter-control')) {
        if (document.querySelector('#page-finance-new-request:not(.hidden)')) {
            loadFinanceNewRequestPage();
        }
        if (document.querySelector('#page-finance-ready-to-pay:not(.hidden)')) {
            loadFinanceReadyToPayPage();
        }
    }
});
document.addEventListener('input', function(event) {
    if (event.target.classList.contains('finance-filter-control')) {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            if (document.querySelector('#page-finance-new-request:not(.hidden)')) {
                loadFinanceNewRequestPage();
            }
            if (document.querySelector('#page-finance-ready-to-pay:not(.hidden)')) {
                loadFinanceReadyToPayPage();
            }
        }, 500);
    }
});

/**
 * مستمع أوامر لحفظ النماذج (Submit)
 */
document.addEventListener('submit', async function(event) {
if (event.target.id === 'supervisor-replacement-form') {
    event.preventDefault();
    const saveBtn = document.getElementById('save-resignation-replacement-btn');
    const requestId = document.getElementById('replacement-request-id').value;
    const replacementName = document.getElementById('replacement-guard-select').value;

    if (!replacementName) {
        return alert('الرجاء اختيار الحارس البديل أولاً.');
    }

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

    try {
        const { data: request, error: fetchError } = await supabaseClient
            .from('employee_requests')
            .select('details')
            .eq('id', requestId)
            .single();

        if (fetchError || !request) throw new Error('لم يتم العثور على الطلب.');

        const updatedDetails = { 
            ...request.details, 
            replacement_guard_name: replacementName 
        };
        const { error: updateError } = await supabaseClient
            .from('employee_requests')
            .update({ 
                status: 'بانتظار موافقة الشؤون القانونية',
                supervisor_approver_id: currentUser.id,
                details: updatedDetails
            })
            .eq('id', requestId);

        if (updateError) throw updateError;
        const { data: legalUsers } = await supabaseClient.from('users').select('id').eq('role', 'الشؤون القانونية');
        if (legalUsers && legalUsers.length > 0) {
            const legalIds = legalUsers.map(u => u.id);
            sendNotification(
                legalIds,
                'طلب استقالة بانتظار الاعتماد',
                `تم رفع طلب استقالة بانتظار موافقتكم النهائية.`,
                '/legal/resignations'
            );
        }

        showToast('تمت الموافقة ورفع الطلب للقانونية.', 'success');
        document.getElementById('supervisor-replacement-modal').classList.add('hidden');
        loadSupervisorResignationsPage(); // تحديث صفحة المشرف

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'موافقة ورفع للشؤون القانونية';
    }
}
if (event.target.id === 'financial-auditor-form') {
    event.preventDefault();
    const form = event.target;
    const saveBtn = form.querySelector('button[type="submit"]');
    const requestId = document.getElementById('financial-auditor-request-id').value;
    const pdfFile = document.getElementById('auditor-final-invoice-pdf').files[0];

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الرفع والحفظ...';

    try {
        const { data: request } = await supabaseClient.from('financial_requests').select('requesting_department').eq('id', requestId).single();
        const department = request?.requesting_department || 'unknown';
        let finalInvoiceUrl = null;
        if (pdfFile) {
            finalInvoiceUrl = await uploadFinancialAttachment(pdfFile, department, requestId);
        }
        const updateData = {
            status: 'أمر صرف جاهز',
            auditor_approver_id: currentUser.id,
            auditor_approved_at: new Date(),
            auditor_notes: document.getElementById('auditor-notes').value, // <--- إضافة الملاحظة
            final_invoice_pdf_url: finalInvoiceUrl,
            final_invoice_number: document.getElementById('auditor-invoice-number').value || null,
            final_invoice_date: document.getElementById('auditor-invoice-date').value || null,
            final_client_name: document.getElementById('auditor-client-name').value || null,
            final_statement: document.getElementById('auditor-statement').value || null,
            final_total_with_vat: parseFloat(document.getElementById('auditor-total-with-vat').value) || null
        };
        const { error: updateError } = await supabaseClient
            .from('financial_requests')
            .update(updateData)
            .eq('id', requestId);
        if (updateError) throw updateError;
        await supabaseClient.from('financial_requests_log').insert({
            request_id: requestId,
            user_id: currentUser.id,
            action_taken: 'تم الاعتماد من المدقق وإصدار الفاتورة'
        });
        const { data: financeUsers } = await supabaseClient.from('users').select('id').eq('role', 'المالية');
        if (financeUsers && financeUsers.length > 0) {
            const financeIds = financeUsers.map(u => u.id);
            sendNotification(financeIds, 'أمر صرف جاهز للدفع', `تم إصدار أمر صرف جديد وهو جاهز للدفع.`, '/finance/ready-to-pay');
        }

        showToast('تم اعتماد الطلب بنجاح.', 'success');
        document.getElementById('financial-auditor-modal').classList.add('hidden');
        loadAuditorApprovalsPage();
        loadFinanceReadyToPayPage();

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'اعتماد وإرسال لأوامر الصرف';
    }
}
    if (event.target.id === 'financial-payment-form') {
        event.preventDefault();
        const form = event.target;
        const saveBtn = form.querySelector('button[type="submit"]');
        const requestId = document.getElementById('financial-payment-request-id').value;
        const receiptFile = document.getElementById('payment-receipt-upload').files[0];

        if (!receiptFile) return alert('إرفاق إيصال الدفع إجباري لإكمال العملية.');

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الأرشفة...';

        try {
            const { data: request } = await supabaseClient.from('financial_requests').select('requesting_department, user_id, request_title').eq('id', requestId).single();
            const department = request?.requesting_department || 'unknown';
            const receiptUrl = await uploadFinancialAttachment(receiptFile, department, requestId);
            const updateData = {
                status: 'مكتمل',
                payment_receipt_url: receiptUrl,
                payment_notes: document.getElementById('payment-final-notes').value,
                payment_completed_by_id: currentUser.id,
                payment_completed_at: new Date()
            };

            const { error: updateError } = await supabaseClient
                .from('financial_requests')
                .update(updateData)
                .eq('id', requestId);
            if (updateError) throw updateError;
            await supabaseClient.from('financial_requests_log').insert({
                request_id: requestId,
                user_id: currentUser.id,
                action_taken: 'تم اعتماد الصرف وأرشفة الطلب'
            });
            if (request && request.user_id) {
                sendNotification(request.user_id, 'تم صرف طلبك المالي', `تم إكمال وصرف طلبك: "${request.request_title}"`, '/finance/new-request');
            }

            showToast('تمت عملية الصرف والأرشفة بنجاح.', 'success');
            document.getElementById('financial-payment-modal').classList.add('hidden');
            document.getElementById('financial-review-modal').classList.add('hidden');
            loadFinanceReadyToPayPage(); // تحديث قائمة الأوامر الجاهزة

        } catch (error) {
            alert(`حدث خطأ: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'تأكيد الدفع ونقل للأرشيف';
        }
    }

});
document.body.addEventListener('click', async function(event) {
const financeArchiveTab = event.target.closest('#page-finance-archive .tab-link');
if (financeArchiveTab) {
    event.preventDefault();
    const targetTabId = financeArchiveTab.dataset.tab;
    const page = financeArchiveTab.closest('.page-content');
    page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
    page.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    financeArchiveTab.classList.add('active');
    document.getElementById(targetTabId).classList.add('active');
    if (targetTabId === 'archive-approved-tab') {
        loadFinanceArchivePage('approved');
    } else if (targetTabId === 'archive-rejected-tab') {
        loadFinanceArchivePage('rejected');
    }
    return;
}
const addFinancialRequestBtn = event.target.closest('#add-new-financial-request-btn');
if (addFinancialRequestBtn) {
    event.preventDefault();
    openFinancialRequestModal();
    return;
}
const saveFinancialRequestBtn = event.target.closest('#save-financial-request-btn');
if (saveFinancialRequestBtn) {
    event.preventDefault();
    saveFinancialRequest(saveFinancialRequestBtn);
    return;
}

const openReviewBtn = event.target.closest('.open-financial-review-btn');
if (openReviewBtn) {
    event.preventDefault();
    const requestId = openReviewBtn.dataset.id;
    const stage = openReviewBtn.dataset.stage; // (cfo, ceo, auditor, payment, final_view)

    const modal = document.getElementById('financial-review-modal');
    const body = document.getElementById('financial-review-body');
    const approveBtn = document.getElementById('financial-review-approve-btn');
    const rejectBtn = document.getElementById('financial-review-reject-btn');

    body.innerHTML = '<p style="text-align: center;">جاري تحميل تفاصيل الطلب...</p>';
    modal.classList.remove('hidden');
    const { data: request, error } = await supabaseClient
        .from('financial_requests')
        .select(`*, user:users!financial_requests_user_id_fkey(name)`)
        .eq('id', requestId)
        .single();

    if (error) {
        body.innerHTML = `<p style="color:red;">${error.message}</p>`;
    } else {
        body.innerHTML = buildReviewModalBody(request);
        document.getElementById('financial-review-request-id').value = requestId;
        const notesContainer = document.getElementById('approval-notes-container');
        document.getElementById('approval-notes-input').value = ''; // تصفير الحقل

        if (stage === 'final_view') {
            approveBtn.classList.add('hidden');
            rejectBtn.classList.add('hidden');
            if(notesContainer) notesContainer.classList.add('hidden'); // إخفاء حقل الكتابة
            
        } else if (stage === 'auditor') {
            approveBtn.innerHTML = '<i class="ph-bold ph-file-pdf"></i> اعتماد وإصدار فاتورة';
            approveBtn.dataset.stage = 'auditor';
            approveBtn.classList.remove('hidden');
            rejectBtn.classList.remove('hidden');
            if(notesContainer) notesContainer.classList.add('hidden'); 
            
        } else {
            approveBtn.innerHTML = '<i class="ph-bold ph-check-circle"></i> موافقة واعتماد';
            approveBtn.dataset.stage = stage;
            approveBtn.classList.remove('hidden');
            rejectBtn.classList.remove('hidden');
            if(notesContainer) notesContainer.classList.remove('hidden'); // إظهار حقل الكتابة
        }
    }
    return;
}
const viewFinancialAttachmentBtn = event.target.closest('.view-financial-attachment-btn');
if (viewFinancialAttachmentBtn) {
    event.preventDefault();
    const fileUrl = viewFinancialAttachmentBtn.dataset.url;
    viewFinancialAttachmentBtn.disabled = true;
    viewFinancialAttachmentBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

    try {
        const { data, error } = await supabaseClient.storage
            .from('job-applications') // (الحاوية العامة لدينا)
            .createSignedUrl(fileUrl, 300); // 5 دقائق صلاحية

        if (error) throw error;
        window.open(data.signedUrl, '_blank'); // فتح المرفق في تبويب جديد

    } catch (error) {
        alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
    } finally {
        viewFinancialAttachmentBtn.disabled = false;
        viewFinancialAttachmentBtn.innerHTML = '<i class="ph-bold ph-eye"></i> عرض المرفق';
    }
    return;
}
const approveReviewBtn = event.target.closest('#financial-review-approve-btn');
if (approveReviewBtn) {
    event.preventDefault();
    const requestId = document.getElementById('financial-review-request-id').value;
    const stage = approveReviewBtn.dataset.stage;

    if (stage === 'cfo' || stage === 'ceo') {
        if (!confirm('هل أنت متأكد من الموافقة على هذا الطلب؟')) return;

        approveReviewBtn.disabled = true;
        try {
            let updateData = {};
            let nextStatus = '';
            let logAction = '';
            let notifyIds = [];
            let notifyMessage = '';
            let notifyLink = '';

            if (stage === 'cfo') {
                updateData = { status: 'بانتظار المدير التنفيذي', cfo_approver_id: currentUser.id, cfo_approved_at: new Date(), cfo_notes: document.getElementById('approval-notes-input').value };
                logAction = 'تمت الموافقة من المدير المالي';
                nextStatus = 'loadCeoApprovalsPage';
                const { data: ceoUsers } = await supabaseClient.from('users').select('id').eq('is_ceo', true);
                notifyIds = ceoUsers.map(u => u.id);
                notifyMessage = 'يوجد طلب صرف بانتظار موافقتك (المدير التنفيذي).';
                notifyLink = '/finance/ceo-approvals';

            } else if (stage === 'ceo') {
                updateData = { status: 'بانتظار المدقق المالي', ceo_approver_id: currentUser.id, ceo_approved_at: new Date(), ceo_notes: document.getElementById('approval-notes-input').value };
                logAction = 'تمت الموافقة من المدير التنفيذي';
                nextStatus = 'loadAuditorApprovalsPage';
                const { data: auditorUsers } = await supabaseClient.from('users').select('id').eq('is_auditor', true);
                notifyIds = auditorUsers.map(u => u.id);
                notifyMessage = 'يوجد طلب صرف بانتظار مراجعتك واعتمادك.';
                notifyLink = '/finance/auditor-approvals';
            }

            const { error: updateError } = await supabaseClient.from('financial_requests').update(updateData).eq('id', requestId);
            if (updateError) throw updateError;

            await supabaseClient.from('financial_requests_log').insert({ request_id: requestId, user_id: currentUser.id, action_taken: logAction });

            if (notifyIds.length > 0) {
                sendNotification(notifyIds, 'مطلوب موافقة على طلب صرف', notifyMessage, notifyLink);
            }

            showToast('تمت الموافقة بنجاح.', 'success');
            document.getElementById('financial-review-modal').classList.add('hidden');

            if (stage === 'cfo') loadCfoApprovalsPage();
            if (stage === 'ceo') loadCeoApprovalsPage();
            if (window[nextStatus]) window[nextStatus]();

        } catch (error) {
            alert(`حدث خطأ: ${error.message}`);
        } finally {
            approveReviewBtn.disabled = false;
        }

    } else if (stage === 'auditor') {
        const auditorModal = document.getElementById('financial-auditor-modal');
        auditorModal.querySelector('form').reset();
        document.getElementById('financial-auditor-request-id').value = requestId;
        document.getElementById('auditor-invoice-date').value = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16); // تعيين الوقت الحالي
        auditorModal.classList.remove('hidden');
        document.getElementById('financial-review-modal').classList.add('hidden');

    } else if (stage === 'payment') {
        const paymentModal = document.getElementById('financial-payment-modal');
        paymentModal.querySelector('form').reset();
        document.getElementById('financial-payment-request-id').value = requestId;
        paymentModal.classList.remove('hidden');
        document.getElementById('financial-review-modal').classList.add('hidden');
    }
    return;
}
const rejectReviewBtn = event.target.closest('#financial-review-reject-btn');
if (rejectReviewBtn) {
    event.preventDefault();
    const requestId = document.getElementById('financial-review-request-id').value;
    const reason = prompt('الرجاء كتابة سبب الرفض (إجباري):');

    if (!reason || !reason.trim()) return;

    rejectReviewBtn.disabled = true;

    try {
        const { data: request } = await supabaseClient.from('financial_requests').select('user_id').eq('id', requestId).single();
        const { error } = await supabaseClient
            .from('financial_requests')
            .update({ status: 'مرفوض', rejection_reason: reason })
            .eq('id', requestId);
        if (error) throw error;
        await supabaseClient.from('financial_requests_log').insert({
            request_id: requestId,
            user_id: currentUser.id,
            action_taken: 'تم رفض الطلب',
            notes: reason
        });
        if (request && request.user_id) {
            sendNotification(request.user_id, 'تم رفض طلب الصرف', `تم رفض طلبك. السبب: ${reason}`, '/finance/new-request');
        }

        showToast('تم رفض الطلب.', 'success');
        document.getElementById('financial-review-modal').classList.add('hidden');
        loadCfoApprovalsPage();
        loadCeoApprovalsPage();
        loadFinanceNewRequestPage(); // تحديث صفحة الموظف

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        rejectReviewBtn.disabled = false;
    }
    return;
}
const openAuditorBtn = event.target.closest('.open-auditor-review-btn');
if (openAuditorBtn) {
    event.preventDefault();
    const requestId = openAuditorBtn.dataset.id;
    const tempReviewBtn = document.createElement('button');
    tempReviewBtn.className = 'open-financial-review-btn';
    tempReviewBtn.dataset.id = requestId;
    tempReviewBtn.dataset.stage = 'auditor';
    document.body.appendChild(tempReviewBtn);
    tempReviewBtn.click();
    document.body.removeChild(tempReviewBtn);
    return;
}
const openPaymentBtn = event.target.closest('.open-payment-modal-btn');
if (openPaymentBtn) {
    event.preventDefault();
    const requestId = openPaymentBtn.dataset.id;
    const tempReviewBtn = document.createElement('button');
    tempReviewBtn.className = 'open-financial-review-btn';
    tempReviewBtn.dataset.id = requestId;
    tempReviewBtn.dataset.stage = 'payment'; // <-- إرسال المرحلة الجديدة

    document.body.appendChild(tempReviewBtn);
    tempReviewBtn.click();
    document.body.removeChild(tempReviewBtn);
    return;
}
const openArchiveBtn = event.target.closest('.open-archive-view-btn');
if (openArchiveBtn) {
    event.preventDefault();
    const requestId = openArchiveBtn.dataset.id;
    const modal = document.getElementById('financial-archive-view-modal');
    const body = document.getElementById('financial-archive-body');

    body.innerHTML = '<p style="text-align: center;">جاري تحميل السجل الكامل...</p>';
    modal.classList.remove('hidden');

    try {
        const { data: request, error } = await supabaseClient
            .from('financial_requests')
            .select(`*, user:users!financial_requests_user_id_fkey(name)`)
            .eq('id', requestId)
            .single();

        if (error || !request) throw new Error('لم يتم العثور على الطلب.');

        const { data: logs, error: logError } = await supabaseClient
            .from('financial_requests_log')
            .select(`*, user:users!financial_requests_log_user_id_fkey(name)`)
            .eq('request_id', requestId)
            .order('created_at', { ascending: true }); // ترتيب زمني

        if (logError) throw logError;
        const detailsHtml = buildReviewModalBody(request);
        const logsHtml = logs.map(log => `
            <div class="timeline-item">
                <div class="timeline-header">
                    <span>${log.user ? log.user.name : 'نظام'}</span>
                    <small>${formatGregorianDateTime(log.created_at)}</small>
                </div>
                <div class="timeline-body">
                    <p>${log.action_taken}</p>
                    ${log.notes ? `<div class="timeline-footer" style="color: var(--denied-color);"><strong>السبب:</strong> ${log.notes}</div>` : ''}
                </div>
            </div>
        `).join('');

        body.innerHTML = `
            ${detailsHtml}
            <div class="profile-card" style="margin-top: 20px;">
                <div class="profile-card-header"><h4>سجل الطلب </h4></div>
                <div class="details-body timeline" style="padding: 20px;">
                    ${logsHtml}
                </div>
            </div>
        `;

    } catch (err) {
        body.innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
    return;
}
const addNewSettlementBtn = event.target.closest('#add-new-settlement-btn');
if (addNewSettlementBtn) {
    const modal = document.getElementById('settlement-add-modal');
    const form = document.getElementById('settlement-add-form');
    form.reset();
    document.getElementById('settlement-filing-date').valueAsDate = new Date();
    document.getElementById('settlement-respondent').value = 'شركة اركانات';

    modal.classList.remove('hidden');
    return; // توقيف التنفيذ
}
const viewSettlementCard = event.target.closest('.settlement-card');
if (viewSettlementCard) {
    event.preventDefault();
    const settlementId = viewSettlementCard.dataset.id;
    const modal = document.getElementById('settlement-view-modal');
    const body = document.getElementById('settlement-view-body');
    
    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري تحميل تفاصيل الملف...</p>';

    try {
        const [
            { data: settlement, error: e1 },
            { data: updates, error: e2 }
        ] = await Promise.all([
            supabaseClient.from('friendly_settlements').select('*').eq('id', settlementId).single(),
            supabaseClient.from('settlement_updates').select('*, user:users(name)').eq('settlement_id', settlementId).order('update_date', { ascending: false })
        ]);

        if (e1 || !settlement) throw new Error('لم يتم العثور على الملف.');
        if (e2) throw e2;

        document.getElementById('settlement-view-title').textContent = `تفاصيل: ${settlement.case_title}`;
        let timelineHtml = '<div class="empty-state" style="padding: 20px;"><i class="ph-bold ph-list-dashes"></i><p>لم يتم تسجيل أي إجراءات لهذا الملف بعد.</p></div>';
        if (updates.length > 0) {
            timelineHtml = updates.map(up => `
                <div class="timeline-item">
                    <div class="timeline-header">
                        <span>${formatGregorianDate(up.update_date)}</span>
                        <small>بواسطة: ${up.user ? up.user.name : 'غير معروف'}</small>
                    </div>
                    <div class="timeline-body">
                        <p>${up.description}</p>
                        ${up.next_step ? `<div class="timeline-footer"><strong>الإجراء القادم:</strong> ${up.next_step}</div>` : ''}
                        ${up.attachment_urls && up.attachment_urls.length > 0 ? `
                            <div class="timeline-footer" style="padding-top: 10px;">
                                <strong>المرفقات:</strong> 
                                ${up.attachment_urls.map((url, index) => `
                                    <button class="btn btn-secondary btn-sm settlement-view-attachment-btn" data-url="${url}" style="margin-right: 5px;">
                                        <i class="ph-bold ph-paperclip"></i> مرفق ${index + 1}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        const addUpdateHtml = `
            <form id="settlement-update-form">
                <input type="hidden" id="update-settlement-id" value="${settlement.id}">
                <div class="form-group">
                    <label>وصف الإجراء / التحديث الجديد</label>
                    <textarea id="update-description" rows="3" placeholder="مثال: تم عقد الجلسة الأولى..." required></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>تاريخ الإجراء</label>
                        <input type="date" id="update-date" required>
                    </div>
                    <div class="form-group">
                        <label>الإجراء القادم (اختياري)</label>
                        <input type="text" id="update-next-step" placeholder="مثال: الجلسة القادمة يوم...">
                    </div>
                </div>
                <div class="form-group">
                    <label>إرفاق ملفات لهذا الإجراء (اختياري)</label>
                    <input type="file" id="update-attachments" multiple>
                </div>
                <div style="text-align: left;">
                    <button type="submit" id="save-settlement-update-btn" class="btn btn-primary">
                        <i class="ph-bold ph-plus"></i> إضافة التحديث للسجل
                    </button>
                </div>
            </form>
        `;
        const closeCaseHtml = `
            <form id="settlement-close-form">
                <input type="hidden" id="close-settlement-id" value="${settlement.id}">
                <div class="form-group">
                    <label for="settlement-outcome">نتيجة التسوية</label>
                    <select id="settlement-outcome" required>
                        <option value="">-- اختر النتيجة --</option>
                        <option value="تم الصلح">تم الصلح</option>
                        <option value="لم يتم الصلح">لم يتم الصلح</option>
                        <option value="تحولت لدعوى">تحولت لدعوى قضائية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="settlement-amount-final">المبلغ النهائي للتسوية (إن وجد)</label>
                    <input type="number" id="settlement-amount-final" placeholder="0">
                </div>
                <div class="form-group">
                    <label>ملخص الإنهاء / سبب الإغلاق</label>
                    <textarea id="close-summary" rows="4" placeholder="اكتب ملخصاً لكيفية انتهاء الملف..." required></textarea>
                </div>
                <div style="text-align: left;">
                    <button type="submit" id="save-close-settlement-btn" class="btn btn-danger">
                        <i class="ph-bold ph-gavel"></i> تأكيد وإنهاء الملف
                    </button>
                </div>
            </form>
        `;
        body.innerHTML = `
            <div class="settlement-details-grid">
                <div class="settlement-details-card">
                    <h4>التفاصيل الأساسية</h4>
                    <div class="details-body">
                        <p><strong>الطرف الأول (المدعي):</strong> ${settlement.claimant}</p>
                        <p><strong>الطرف الثاني:</strong> ${settlement.respondent}</p>
                        <p><strong>تاريخ فتح الملف:</strong> ${formatGregorianDate(settlement.filing_date)}</p>
                        <p><strong>المبلغ المطلوب:</strong> ${(settlement.settlement_amount_requested || 0).toLocaleString('ar-SA')} ر.س</p>
                        <p><strong>ملخص الطلب:</strong> ${settlement.summary || '-'}</p>
                    </div>
                </div>

                <div class="settlement-details-card">
                    <h4>سجل الإجراءات والتحديثات</h4>
                    <div class="details-body timeline">
                        ${timelineHtml}
                    </div>
                </div>

                ${settlement.status === 'قيد التفاوض' ? `
                <div class"settlement-details-card">
                    <h4>إضافة إجراء جديد</h4>
                    <div class="details-body">
                        ${addUpdateHtml}
                    </div>
                </div>
                ` : ''}

                <div class="settlement-details-card">
                    <h4>إنهاء ملف التسوية</h4>
                    <div class="details-body">
                        ${settlement.status === 'قيد التفاوض' ? closeCaseHtml : `
                            <p><strong>تم إغلاق هذا الملف.</strong></p>
                            <p><strong>النتيجة النهائية:</strong> ${settlement.outcome}</p>
                            <p><strong>المبلغ النهائي:</strong> ${(settlement.settlement_amount_final || 0).toLocaleString('ar-SA')} ر.س</p>
                            <p><strong>ملخص الإغلاق:</strong> ${settlement.summary}</p>
                            <p><strong>تاريخ الإغلاق:</strong> ${formatGregorianDate(settlement.closed_at)}</p>
                        `}
                    </div>
                </div>
            </div>
        `;
        
        const updateDateInput = document.getElementById('update-date');
        if(updateDateInput) updateDateInput.valueAsDate = new Date();

    } catch (err) {
        body.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
    return; // توقيف التنفيذ
}
const viewSettlementAttachmentBtn = event.target.closest('.settlement-view-attachment-btn');
if (viewSettlementAttachmentBtn) {
    const fileUrl = viewSettlementAttachmentBtn.dataset.url;
    viewSettlementAttachmentBtn.disabled = true;
    
    try {
        const { data, error } = await supabaseClient.storage
            .from('settlement_attachments') // اسم الحاوية الصحيح
            .createSignedUrl(fileUrl, 300); // صلاحية 5 دقائق

        if (error) throw error;
        window.open(data.signedUrl, '_blank');

    } catch (error) {
        alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
    } finally {
        viewSettlementAttachmentBtn.disabled = false;
    }
    return; // توقيف التنفيذ
}
    const permanentDeleteBtn = event.target.closest('.admin-permanent-delete-btn');
    if (permanentDeleteBtn) {
        const userId = permanentDeleteBtn.dataset.id;
        const authId = permanentDeleteBtn.dataset.authId;
        const userName = permanentDeleteBtn.dataset.name;
        if (!confirm(`تحذير خطير جداً!\nأنت على وشك حذف الموظف "${userName}" (ID: ${userId}) بشكل نهائي من النظام.\n\nسيتم حذف سجله من قاعدة البيانات (users) وحذفه من نظام المصادقة (auth).\n\nلا يمكن التراجع عن هذا الإجراء إطلاقاً. هل أنت متأكد؟`)) {
            return;
        }

        permanentDeleteBtn.disabled = true;
        permanentDeleteBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

        try {
            const { data, error } = await supabaseClient.functions.invoke('delete-employee', {
                body: { 
                    user_id: parseInt(userId), 
                    auth_user_id: authId 
                },
            });

            if (error || (data && data.error)) {
                throw new Error(error?.message || data.error);
            }

            showToast(`تم حذف الموظف ${userName} نهائياً.`, 'success');
            loadEmployeeArchive(); // إعادة تحميل قائمة الأرشيف

        } catch (err) {
            showToast(`فشلت عملية الحذف: ${err.message}`, 'error');
            permanentDeleteBtn.disabled = false;
            permanentDeleteBtn.innerHTML = '<i class="ph-bold ph-trash-simple"></i> حذف نهائي';
        }
    }
    const viewLawsuitCard = event.target.closest('.lawsuit-card');
    if (viewLawsuitCard) {
        event.preventDefault();
        const lawsuitId = viewLawsuitCard.dataset.id;
        const modal = document.getElementById('lawsuit-view-modal');
        const body = document.getElementById('lawsuit-view-body');
        
        modal.classList.remove('hidden');
        body.innerHTML = '<p style="text-align: center;">جاري تحميل تفاصيل الدعوى...</p>';

        try {
            const [
                { data: lawsuit, error: e1 },
                { data: updates, error: e2 }
            ] = await Promise.all([
                supabaseClient.from('lawsuits').select('*').eq('id', lawsuitId).single(),
                supabaseClient.from('lawsuit_updates').select('*, user:users(name)').eq('lawsuit_id', lawsuitId).order('update_date', { ascending: false })
            ]);

            if (e1 || !lawsuit) throw new Error('لم يتم العثور على الدعوى.');
            if (e2) throw e2;
            document.getElementById('lawsuit-view-title').textContent = `تفاصيل: ${lawsuit.case_title}`;
            let timelineHtml = '<div class="empty-state" style="padding: 20px;"><i class="ph-bold ph-list-dashes"></i><p>لم يتم تسجيل أي إجراءات لهذه الدعوى بعد.</p></div>';
            if (updates.length > 0) {
                timelineHtml = updates.map(up => `
                    <div class="timeline-item">
                        <div class="timeline-header">
                            <span>${formatGregorianDate(up.update_date)}</span>
                            <small>بواسطة: ${up.user ? up.user.name : 'غير معروف'}</small>
                        </div>
                        <div class="timeline-body">
                            <p>${up.description}</p>
                            ${up.next_step ? `<div class="timeline-footer"><strong>الإجراء القادم:</strong> ${up.next_step}</div>` : ''}
                            ${up.attachment_urls && up.attachment_urls.length > 0 ? `
                                <div class="timeline-footer" style="padding-top: 10px;">
                                    <strong>المرفقات:</strong> 
                                    ${up.attachment_urls.map((url, index) => `
                                        <button class="btn btn-secondary btn-sm lawsuit-view-attachment-btn" data-url="${url}" style="margin-right: 5px;">
                                            <i class="ph-bold ph-paperclip"></i> مرفق ${index + 1}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            const addUpdateHtml = `
                <form id="lawsuit-update-form">
                    <input type="hidden" id="update-lawsuit-id" value="${lawsuit.id}">
                    <div class="form-group">
                        <label>وصف الإجراء / التحديث الجديد</label>
                        <textarea id="update-description" rows="3" placeholder="مثال: تم حضور الجلسة الثانية..." required></textarea>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>تاريخ الإجراء</label>
                            <input type="date" id="update-date" required>
                        </div>
                        <div class="form-group">
                            <label>الإجراء القادم (اختياري)</label>
                            <input type="text" id="update-next-step" placeholder="مثال: الجلسة القادمة يوم...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>إرفاق ملفات لهذا الإجراء (اختياري)</label>
                        <input type="file" id="update-attachments" multiple>
                    </div>
                    <div style="text-align: left;">
                        <button type="submit" id="save-lawsuit-update-btn" class="btn btn-primary">
                            <i class="ph-bold ph-plus"></i> إضافة التحديث للسجل
                        </button>
                    </div>
                </form>
            `;
            const closeCaseHtml = `
                <form id="lawsuit-close-form">
                    <input type="hidden" id="close-lawsuit-id" value="${lawsuit.id}">
                    <div class="form-group">
                        <label>الحكم النهائي / سبب الإغلاق</label>
                        <textarea id="close-judgment" rows="4" placeholder="اكتب نص الحكم النهائي أو سبب إغلاق الدعوى..." required>${lawsuit.final_judgment || ''}</textarea>
                    </div>
                    <div style="text-align: left;">
                        <button type="submit" id="save-close-lawsuit-btn" class="btn btn-danger">
                            <i class="ph-bold ph-gavel"></i> تأكيد وإنهاء الدعوى
                        </button>
                    </div>
                </form>
            `;
            body.innerHTML = `
                <div class="lawsuit-details-grid">
                    <div class="lawsuit-details-card">
                        <h4>التفاصيل الأساسية</h4>
                        <div class="details-body">
                            <p><strong>المدعي:</strong> ${lawsuit.plaintiff}</p>
                            <p><strong>المدعى عليه:</strong> ${lawsuit.defendant}</p>
                            <p><strong>تاريخ الرفع:</strong> ${formatGregorianDate(lawsuit.filing_date)}</p>
                            <p><strong>ملخص القضية:</strong> ${lawsuit.summary}</p>
                        </div>
                    </div>

                    <div class="lawsuit-details-card">
                        <h4>سجل الإجراءات والتحديثات</h4>
                        <div class="details-body timeline">
                            ${timelineHtml}
                        </div>
                    </div>

                    ${lawsuit.status === 'قيد النظر' ? `
                    <div classs="lawsuit-details-card">
                        <h4>إضافة إجراء جديد</h4>
                        <div class="details-body">
                            ${addUpdateHtml}
                        </div>
                    </div>
                    ` : ''}

                    <div class="lawsuit-details-card">
                        <h4>إنهاء الدعوى</h4>
                        <div class="details-body">
                            ${lawsuit.status === 'قيد النظر' ? closeCaseHtml : `
                                <p><strong>تم إغلاق هذه الدعوى.</strong></p>
                                <p><strong>الحكم النهائي:</strong> ${lawsuit.final_judgment}</p>
                                <p><strong>تاريخ الإغلاق:</strong> ${formatGregorianDate(lawsuit.closed_at)}</p>
                            `}
                        </div>
                    </div>
                </div>
            `;
            const updateDateInput = document.getElementById('update-date');
            if(updateDateInput) updateDateInput.valueAsDate = new Date();

        } catch (err) {
            body.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
        }
        return; // توقيف التنفيذ
    }
    const viewLawsuitAttachmentBtn = event.target.closest('.lawsuit-view-attachment-btn');
    if (viewLawsuitAttachmentBtn) {
        const fileUrl = viewLawsuitAttachmentBtn.dataset.url;
        viewLawsuitAttachmentBtn.disabled = true;
        
        try {
            const { data, error } = await supabaseClient.storage
                .from('lawsuit_attachments') // اسم الحاوية الصحيح
                .createSignedUrl(fileUrl, 300); // صلاحية 5 دقائق

            if (error) throw error;
            window.open(data.signedUrl, '_blank');

        } catch (error) {
            alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
        } finally {
            viewLawsuitAttachmentBtn.disabled = false;
        }
        return; // توقيف التنفيذ
    }
    const addNewLawsuitBtn = event.target.closest('#add-new-lawsuit-btn');
    if (addNewLawsuitBtn) {
        const modal = document.getElementById('lawsuit-add-modal');
        const form = document.getElementById('lawsuit-add-form');
        form.reset(); // إفراغ الحقول
        const searchInput = document.getElementById('blacklist-fetch-user-search'); // (سنستخدم نفس ID الحقل الذكي للقائمة السوداء)
        const optionsContainer = document.getElementById('blacklist-fetch-user-options'); // (سنستخدم نفس ID الحقل الذكي)
        const hiddenInput = document.getElementById('blacklist-fetch-user'); // <<-- ✨ تم التصحيح هنا
        
        searchInput.value = '';
        hiddenInput.value = '';
        optionsContainer.innerHTML = '<div class="custom-select-option">جاري تحميل الموظفين...</div>';
        document.getElementById('lawsuit-defendant').value = 'شركة اركانات';
        document.getElementById('lawsuit-filing-date').valueAsDate = new Date();

        modal.classList.remove('hidden');
        (async () => {
            const { data: users, error } = await supabaseClient
                .from('users')
                .select('id, name, id_number')
                .not('employment_status', 'eq', 'مؤرشف')
                .order('name');

            if (error) {
                optionsContainer.innerHTML = '<div class="custom-select-option">خطأ في التحميل</div>';
            } else {
                const options = users.map(u => ({
                    id: u.id,
                    text: `${u.name} (${u.id_number})`,
                    details: { name: u.name, id_number: u.id_number } 
                }));
                setupSearchableSelect('blacklist-fetch-user', options); // (استخدام نفس البريفكس)
            }
        })();
        
        return; // توقيف التنفيذ
    }
    const viewBlacklistBtn = event.target.closest('.view-blacklist-details-btn, .blacklist-card');
    if (viewBlacklistBtn) {
        event.preventDefault();
        const recordId = viewBlacklistBtn.dataset.id;
        const modal = document.getElementById('blacklist-view-modal');
        const body = document.getElementById('blacklist-view-body');
        const deleteBtn = document.getElementById('blacklist-delete-btn');

        modal.classList.remove('hidden');
        body.innerHTML = '<p style="text-align: center;">جاري تحميل التفاصيل...</p>';
        deleteBtn.dataset.id = recordId; // تجهيز زر الحذف
        
        try {
            const { data, error } = await supabaseClient
                .from('employee_blacklist')
                .select('*')
                .eq('id', recordId)
                .single();
            
            if (error || !data) throw new Error('لم يتم العثور على السجل.');

            let attachmentHtml = '';
            if (data.attachment_url) {
                attachmentHtml = `
                    <hr style="margin: 20px 0;">
                    <button class="btn btn-primary" id="blacklist-view-attachment-btn" data-url="${data.attachment_url}" style="width: 100%;">
                        <i class="ph-bold ph-paperclip"></i> عرض المرفق
                    </button>
                `;
            } else {
                attachmentHtml = `
                    <hr style="margin: 20px 0;">
                    <p style="text-align: center; color: var(--text-secondary);">لا توجد مرفقات لهذا السجل.</p>
                `;
            }

            body.innerHTML = `
                <h4>الاسم: ${data.name}</h4>
                <h4>رقم الهوية: ${data.id_number}</h4>
                <hr style="margin: 20px 0;">
                <h4>سبب الإدراج:</h4>
                <p>${data.reason}</p>
                ${attachmentHtml}
            `;
            
            deleteBtn.dataset.attachmentUrl = data.attachment_url || ''; // تمرير رابط المرفق لزر الحذف

        } catch (err) {
            body.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
        }
        return; // توقيف التنفيذ
    }
    const viewBlacklistAttachmentBtn = event.target.closest('#blacklist-view-attachment-btn');
    if (viewBlacklistAttachmentBtn) {
        const fileUrl = viewBlacklistAttachmentBtn.dataset.url;
        viewBlacklistAttachmentBtn.disabled = true;
        
        try {
            const { data, error } = await supabaseClient.storage
                .from('blacklist_attachments') // اسم الحاوية الصحيح
                .createSignedUrl(fileUrl, 300);

            if (error) throw error;
            window.open(data.signedUrl, '_blank'); // فتح المرفق في تبويب جديد

        } catch (error) {
            alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
        } finally {
            viewBlacklistAttachmentBtn.disabled = false;
        }
        return; // توقيف التنفيذ
    }
    const deleteBlacklistBtn = event.target.closest('#blacklist-delete-btn');
    if (deleteBlacklistBtn) {
        const recordId = deleteBlacklistBtn.dataset.id;
        const attachmentUrl = deleteBlacklistBtn.dataset.attachmentUrl;
        
        if (!confirm('هل أنت متأكد من حذف هذا الموظف من القائمة السوداء نهائياً؟')) {
            return;
        }

        deleteBlacklistBtn.disabled = true;
        
        try {
            const { error: dbError } = await supabaseClient
                .from('employee_blacklist')
                .delete()
                .eq('id', recordId);
            
            if (dbError) throw dbError;
            if (attachmentUrl) {
                await supabaseClient.storage
                    .from('blacklist_attachments')
                    .remove([attachmentUrl]);
            }

            showToast('تم حذف الموظف من القائمة بنجاح.', 'success');
            document.getElementById('blacklist-view-modal').classList.add('hidden');
            loadBlacklistPage(); // تحديث القائمة

        } catch (error) {
            alert('حدث خطأ أثناء الحذف: ' + error.message);
        } finally {
            deleteBlacklistBtn.disabled = false;
        }
        return; // توقيف التنفيذ
    }
    const addToBlacklistBtn = event.target.closest('#add-to-blacklist-btn');
    if (addToBlacklistBtn) {
        const modal = document.getElementById('blacklist-add-modal');
        const form = document.getElementById('blacklist-add-form');
        form.reset(); // إفراغ الحقول
        const searchInput = document.getElementById('blacklist-fetch-user-search');
        const optionsContainer = document.getElementById('blacklist-fetch-user-options');
        const hiddenInput = document.getElementById('blacklist-fetch-user');
        
        searchInput.value = '';
        hiddenInput.value = '';
        optionsContainer.innerHTML = '<div class="custom-select-option">جاري تحميل الموظفين...</div>';
        
        modal.classList.remove('hidden');
        (async () => {
            const { data: users, error } = await supabaseClient
                .from('users')
                .select('id, name, id_number')
                .not('employment_status', 'eq', 'مؤرشف') // استبعاد المؤرشفين
                .order('name');

            if (error) {
                optionsContainer.innerHTML = '<div class="custom-select-option">خطأ في التحميل</div>';
            } else {
                const options = users.map(u => ({
                    id: u.id,
                    text: `${u.name} (${u.id_number})`,
                    details: { name: u.name, id_number: u.id_number } 
                }));
                setupSearchableSelect('blacklist-fetch-user', options); 
            }
        })();
        
        return; // توقيف التنفيذ
    }
const addNewViolationBtn = event.target.closest('#add-new-violation-btn');
if (addNewViolationBtn) {
    const modal = document.getElementById('vehicle-violation-modal');
    const form = document.getElementById('vehicle-violation-form');
    form.reset();
    document.getElementById('violation-type-other-group').classList.add('hidden');
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('violation-date').value = now.toISOString().split('T')[0];
    document.getElementById('violation-time').value = now.toISOString().split('T')[1].substring(0, 5);
    const vehicleSelectInput = document.getElementById('violation-vehicle-search');
    const vehicleOptionsContainer = document.getElementById('violation-vehicle-options');
    vehicleSelectInput.value = '';
    document.getElementById('violation-vehicle').value = ''; // <-- هنا تم التصحيح
    vehicleOptionsContainer.innerHTML = '<div class="custom-select-option">جاري تحميل المركبات...</div>';
    const userSelectInput = document.getElementById('violation-user-search');
    const userOptionsContainer = document.getElementById('violation-user-options');
    userSelectInput.value = '';
    document.getElementById('violation-user').value = ''; // <-- هنا تم التصحيح
    userOptionsContainer.innerHTML = '<div class="custom-select-option">جاري تحميل الموظفين...</div>';
    
    modal.classList.remove('hidden');
    (async () => {
        const { data: vehicles, error: vError } = await supabaseClient.from('vehicles').select('id, vehicle_type, license_plate').order('vehicle_type');
        if (vError) {
            vehicleOptionsContainer.innerHTML = '<div class="custom-select-option">خطأ في التحميل</div>';
        } else {
            const options = vehicles.map(v => ({ id: v.id, text: `${v.vehicle_type} (${v.license_plate})` }));
            setupSearchableSelect('violation-vehicle', options);
        }

        const { data: users, error: uError } = await supabaseClient.from('users').select('id, name, id_number').not('employment_status', 'eq', 'مؤرشف').order('name');
        if (uError) {
            userOptionsContainer.innerHTML = '<div class="custom-select-option">خطأ في التحميل</div>';
        } else {
            const options = users.map(u => ({ id: u.id, text: `${u.name} (${u.id_number})` }));
            setupSearchableSelect('violation-user', options);
        }
    })();
    
    return; // توقيف التنفيذ
}
if (event.target.id === 'violation-type') {
    const otherGroup = document.getElementById('violation-type-other-group');
    const otherInput = document.getElementById('violation-type-other');
    if (event.target.value === 'أخرى') {
        otherGroup.classList.remove('hidden');
        otherInput.required = true;
    } else {
        otherGroup.classList.add('hidden');
        otherInput.required = false;
        otherInput.value = '';
    }
    return; // توقيف التنفيذ
}
const viewViolationFileBtn = event.target.closest('.view-violation-file-btn');
if (viewViolationFileBtn) {
    const fileUrl = viewViolationFileBtn.dataset.url;
    if (!fileUrl) return alert('لا يوجد مسار ملف صالح.');

    viewViolationFileBtn.disabled = true;
    try {
        const { data, error } = await supabaseClient.storage
            .from('job-applications')
            .createSignedUrl(fileUrl, 300); // صلاحية 5 دقائق

        if (error) throw error;
        window.open(data.signedUrl, '_blank');

    } catch (error) {
        alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
    } finally {
        viewViolationFileBtn.disabled = false;
    }
    return; // توقيف التنفيذ
}
const saveViolationBtn = event.target.closest('#save-violation-btn');
if (saveViolationBtn) {
    event.preventDefault(); 
    
    const form = document.getElementById('vehicle-violation-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const fileInput = document.getElementById('violation-file-upload');
    const file = fileInput.files[0]; // اختياري

    saveViolationBtn.disabled = true;
    saveViolationBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الحفظ...';

    try {
        const vehicleId = document.getElementById('violation-vehicle').value; // <-- هنا تم التصحيح
        const userId = document.getElementById('violation-user').value; // <-- هنا تم التصحيح
        const violationType = document.getElementById('violation-type').value;
        
        let finalFilePath = null;
        if (file) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExt}`;
            const filePath = `vehicle_violations/${vehicleId}/${fileName}`;

            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('job-applications') 
                .upload(filePath, file);

            if (uploadError) throw uploadError;
            finalFilePath = uploadData.path;
        }
        const violationData = {
            vehicle_id: vehicleId,
            user_id: userId,
            created_by_user_id: currentUser.id,
            amount: parseFloat(document.getElementById('violation-amount').value),
            violation_type: violationType,
            violation_type_other: violationType === 'أخرى' ? document.getElementById('violation-type-other').value : null,
            violation_date: document.getElementById('violation-date').value,
            violation_time: document.getElementById('violation-time').value,
            responsibility: document.getElementById('violation-responsibility').value,
            status: document.getElementById('violation-status').value,
            file_url: finalFilePath // null إذا لم يتم رفع ملف
        };
        const { error: insertError } = await supabaseClient
            .from('vehicle_violations')
            .insert(violationData);

        if (insertError) throw insertError;

        showToast('تم حفظ المخالفة بنجاح!', 'success');
        document.getElementById('vehicle-violation-modal').classList.add('hidden');
        loadVehicleViolationsView(); // إعادة تحميل قائمة المخالفات

    } catch (error) {
        alert('حدث خطأ فادح: ' + error.message);
        console.error("Violation Save Error:", error);
    } finally {
        saveViolationBtn.disabled = false;
        saveViolationBtn.innerHTML = 'حفظ المخالفة';
    }
    return; // توقيف التنفيذ
}
const editInvoiceBtn = event.target.closest('.edit-invoice-btn');
if (editInvoiceBtn) {
    const invoiceId = editInvoiceBtn.dataset.invoiceId;
    const modal = document.getElementById('edit-invoice-modal');
    const form = document.getElementById('edit-invoice-form');
    form.reset();
    document.getElementById('edit-invoice-type-other-group').classList.add('hidden');
    const { data: invoice, error } = await supabaseClient
        .from('vehicle_invoices')
        .select('*, vehicle:vehicles(vehicle_type, license_plate)')
        .eq('id', invoiceId)
        .single();
        
    if (error || !invoice) {
        return alert('خطأ في جلب بيانات الفاتورة.');
    }
    document.getElementById('edit-invoice-id').value = invoice.id;
    document.getElementById('edit-invoice-old-file-path').value = invoice.file_url;
    document.getElementById('edit-invoice-vehicle-search').value = invoice.vehicle ? `${invoice.vehicle.vehicle_type} (${invoice.vehicle.license_plate})` : 'مركبة محذوفة';
    document.getElementById('edit-invoice-type').value = invoice.invoice_type;
    document.getElementById('edit-invoice-amount').value = invoice.amount;
    document.getElementById('edit-invoice-date').value = invoice.invoice_date;
    document.getElementById('edit-invoice-notes').value = invoice.notes || '';
    if (invoice.invoice_type === 'أخرى') {
        document.getElementById('edit-invoice-type-other-group').classList.remove('hidden');
        document.getElementById('edit-invoice-type-other').value = invoice.invoice_type_other || '';
    }
    
    modal.classList.remove('hidden');
    return;
}
const updateInvoiceBtn = event.target.closest('#update-invoice-btn');
if (updateInvoiceBtn) {
    event.preventDefault();
    const invoiceId = document.getElementById('edit-invoice-id').value;
    const fileInput = document.getElementById('edit-invoice-file-upload');
    const newFile = fileInput.files[0];
    let oldFilePath = document.getElementById('edit-invoice-old-file-path').value;

    updateInvoiceBtn.disabled = true;
    updateInvoiceBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الحفظ...';
    
    try {
        let finalFilePath = oldFilePath;
        if (newFile) {
            const fileExt = newFile.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExt}`;
            const vehicleId = document.getElementById('invoice-vehicle').value; // جلب من الحقل المخفي في النافذة الأولى
            const newPath = `vehicle_invoices/${vehicleId}/${fileName}`;
            
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('job-applications')
                .upload(newPath, newFile);
            
            if (uploadError) throw uploadError;
            finalFilePath = uploadData.path;
            if (oldFilePath) {
                await supabaseClient.storage.from('job-applications').remove([oldFilePath]);
            }
        }
        const invoiceType = document.getElementById('edit-invoice-type').value;
        const updateData = {
            amount: parseFloat(document.getElementById('edit-invoice-amount').value),
            invoice_type: invoiceType,
            invoice_type_other: invoiceType === 'أخرى' ? document.getElementById('edit-invoice-type-other').value : null,
            invoice_date: document.getElementById('edit-invoice-date').value,
            notes: document.getElementById('edit-invoice-notes').value || null,
            file_url: finalFilePath // المسار الجديد أو القديم
        };
        const { error: updateError } = await supabaseClient
            .from('vehicle_invoices')
            .update(updateData)
            .eq('id', invoiceId);
            
        if (updateError) throw updateError;
        
        showToast('تم تحديث الفاتورة بنجاح!', 'success');
        document.getElementById('edit-invoice-modal').classList.add('hidden');
        loadVehicleInvoicesView();

    } catch (error) {
        alert('حدث خطأ: ' + error.message);
    } finally {
        updateInvoiceBtn.disabled = false;
        updateInvoiceBtn.innerHTML = 'حفظ التعديلات';
    }
    return;
}
const deleteInvoiceBtn = event.target.closest('.delete-invoice-btn');
if (deleteInvoiceBtn) {
    const invoiceId = deleteInvoiceBtn.dataset.invoiceId;
    const fileUrl = deleteInvoiceBtn.dataset.fileUrl;
    
    if (!confirm('هل أنت متأكد من حذف هذه الفاتورة نهائياً؟ سيتم حذف المرفق أيضاً.')) {
        return;
    }
    
    deleteInvoiceBtn.disabled = true;
    
    try {
        const { error: dbError } = await supabaseClient
            .from('vehicle_invoices')
            .delete()
            .eq('id', invoiceId);
            
        if (dbError) throw dbError;
        if (fileUrl) {
            const { error: storageError } = await supabaseClient.storage
                .from('job-applications')
                .remove([fileUrl]);
            if (storageError) console.error("خطأ في حذف المرفق:", storageError.message);
        }
        
        showToast('تم حذف الفاتورة بنجاح.', 'success');
        loadVehicleInvoicesView(); // إعادة تحميل القائمة

    } catch (error) {
        alert('حدث خطأ: ' + error.message);
        deleteInvoiceBtn.disabled = false;
    }
    return;
}
if (event.target.id === 'edit-invoice-type') {
    const otherGroup = document.getElementById('edit-invoice-type-other-group');
    const otherInput = document.getElementById('edit-invoice-type-other');
    if (event.target.value === 'أخرى') {
        otherGroup.classList.remove('hidden');
        otherInput.required = true;
    } else {
        otherGroup.classList.add('hidden');
        otherInput.required = false;
        otherInput.value = '';
    }
    return;
}

const addNewInvoiceBtn = event.target.closest('#add-new-invoice-btn');
if (addNewInvoiceBtn) {
    const modal = document.getElementById('vehicle-invoice-modal');
    const form = document.getElementById('vehicle-invoice-form');
    form.reset();
    document.getElementById('invoice-id').value = ''; 
    document.getElementById('invoice-file-upload').required = true; 
    document.getElementById('invoice-type-other-group').classList.add('hidden'); 
    document.getElementById('invoice-date').valueAsDate = new Date();

    const vehicleSelectInput = document.getElementById('invoice-vehicle-search');
    const vehicleOptionsContainer = document.getElementById('invoice-vehicle-options');
    vehicleSelectInput.value = '';
    document.getElementById('invoice-vehicle').value = ''; // <-- هنا تم التصحيح
    vehicleOptionsContainer.innerHTML = '<div class="custom-select-option">جاري تحميل المركبات...</div>';

    modal.classList.remove('hidden');
    const { data: vehicles, error } = await supabaseClient
        .from('vehicles')
        .select('id, vehicle_type, license_plate')
        .order('vehicle_type');

    if (error) {
        vehicleOptionsContainer.innerHTML = '<div class="custom-select-option">خطأ في التحميل</div>';
    } else {
        const options = vehicles.map(v => ({
            id: v.id,
            text: `${v.vehicle_type} (${v.license_plate})`
        }));
        setupSearchableSelect('invoice-vehicle', options);
    }
    return; // توقيف التنفيذ
}
if (event.target.id === 'invoice-type') {
    const otherGroup = document.getElementById('invoice-type-other-group');
    const otherInput = document.getElementById('invoice-type-other');
    if (event.target.value === 'أخرى') {
        otherGroup.classList.remove('hidden');
        otherInput.required = true;
    } else {
        otherGroup.classList.add('hidden');
        otherInput.required = false;
        otherInput.value = '';
    }
    return; // توقيف التنفيذ
}
const viewInvoiceFileBtn = event.target.closest('.view-invoice-file-btn');
if (viewInvoiceFileBtn) {
    const fileUrl = viewInvoiceFileBtn.dataset.url;
    if (!fileUrl) return alert('لا يوجد مسار ملف صالح.');

    viewInvoiceFileBtn.disabled = true;
    try {
        const { data, error } = await supabaseClient.storage
            .from('job-applications') // اسم الحاوية صحيح بناءً على كود SQL
            .createSignedUrl(fileUrl, 300); // صلاحية 5 دقائق

        if (error) throw error;
        window.open(data.signedUrl, '_blank');

    } catch (error) {
        alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
    } finally {
        viewInvoiceFileBtn.disabled = false;
    }
    return; // توقيف التنفيذ
}
const saveInvoiceBtn = event.target.closest('#save-invoice-btn');
if (saveInvoiceBtn) {
    event.preventDefault(); // منع إرسال النموذج بالطريقة التقليدية
    
    const form = document.getElementById('vehicle-invoice-form');
    const fileInput = document.getElementById('invoice-file-upload');
    const file = fileInput.files[0];
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    if (!file) {
        return alert('الرجاء إرفاق ملف الفاتورة.');
    }

    saveInvoiceBtn.disabled = true;
    saveInvoiceBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الرفع والحفظ...';

    try {
        const vehicleId = document.getElementById('invoice-vehicle').value; // <-- تم التصحيح هنا
        const invoiceType = document.getElementById('invoice-type').value;
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const filePath = `vehicle_invoices/${vehicleId}/${fileName}`;

        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('job-applications') // استخدام نفس الحاوية
            .upload(filePath, file);

        if (uploadError) throw uploadError;
        const invoiceData = {
            vehicle_id: vehicleId,
            uploaded_by_user_id: currentUser.id,
            amount: parseFloat(document.getElementById('invoice-amount').value),
            invoice_type: invoiceType,
            invoice_type_other: invoiceType === 'أخرى' ? document.getElementById('invoice-type-other').value : null,
            invoice_date: document.getElementById('invoice-date').value,
            file_url: uploadData.path, // حفظ مسار الملف فقط
            notes: document.getElementById('invoice-notes').value || null
        };
        const { error: insertError } = await supabaseClient
            .from('vehicle_invoices')
            .insert(invoiceData);

        if (insertError) throw insertError;

        showToast('تم حفظ الفاتورة بنجاح!', 'success');
        document.getElementById('vehicle-invoice-modal').classList.add('hidden');
        loadVehicleInvoicesView(); // إعادة تحميل قائمة الفواتير

    } catch (error) {
        alert('حدث خطأ فادح: ' + error.message);
        console.error("Invoice Save Error:", error);
    } finally {
        saveInvoiceBtn.disabled = false;
        saveInvoiceBtn.innerHTML = 'حفظ الفاتورة';
    }
    return; // توقيف التنفيذ
}
    const deleteInventoryItemBtn = event.target.closest('.delete-asset-item-btn');
    if (deleteInventoryItemBtn) {
        const itemId = deleteInventoryItemBtn.dataset.id;
        const itemRow = deleteInventoryItemBtn.closest('tr');
        const itemIdentifier = itemRow.querySelector('td')?.textContent || 'القطعة المحددة';

        if (confirm(`هل أنت متأكد من حذف هذه القطعة (${itemIdentifier}) نهائياً؟ لا يمكن التراجع عن هذا الإجراء.`)) {
            try {
                const { data: item } = await supabaseClient.from('asset_items').select('status').eq('id', itemId).single();
                if (item && item.status !== 'متوفر في المخزن') {
                    throw new Error('لا يمكن حذف عهدة مسلمة لموظف أو موقع. يجب أولاً تسجيل ارتجاعها.');
                }

                const { error } = await supabaseClient.from('asset_items').delete().eq('id', itemId);
                if (error) throw error;

                showToast('تم حذف القطعة بنجاح.', 'success');
                itemRow.remove(); // تحديث الواجهة فوراً

            } catch (error) {
                alert(`فشل الحذف: ${error.message}`);
            }
        }
        return;
    }
    const addGeneralVehicleBtn = event.target.closest('#add-general-vehicle-btn');
    if (addGeneralVehicleBtn) {
        const modal = document.getElementById('vehicle-modal');
        document.getElementById('vehicle-modal-title').textContent = 'إضافة مركبة جديدة للمخزون';
        document.getElementById('vehicle-form').reset();
        document.getElementById('vehicle-id').value = '';
        document.getElementById('vehicle-contract-id').value = '';
        document.getElementById('vehicle-location-name').value = '';
        document.getElementById('vehicle-supervisor').innerHTML = '<option value="">-- غير مسلمة --</option>';
        document.getElementById('vehicle-status').value = 'متوفر'; // الحالة الافتراضية
        modal.classList.remove('hidden');
        return;
    }
    const viewVehicleHistoryBtn = event.target.closest('.view-vehicle-history-btn');
    if (viewVehicleHistoryBtn) {
        const vehicleId = viewVehicleHistoryBtn.dataset.id;
        const vehicleIdentifier = viewVehicleHistoryBtn.dataset.identifier;
        const modal = document.getElementById('vehicle-history-modal');
        const container = document.getElementById('vehicle-history-log-container');
        
        document.getElementById('history-vehicle-name').textContent = vehicleIdentifier;
        modal.classList.remove('hidden');
        container.innerHTML = '<p style="text-align: center;">جاري تحميل السجل...</p>';

        const { data: logs, error } = await supabaseClient
            .from('vehicle_history_log')
            .select('*, user:performed_by_user_id(name)')
            .eq('vehicle_id', vehicleId)
            .order('event_timestamp', { ascending: false });

        if (error || logs.length === 0) {
            container.innerHTML = '<p style="text-align: center;">لا توجد أحداث مسجلة لهذه المركبة.</p>';
        } else {
            container.innerHTML = logs.map(log => `
                <div class="visit-card" style="padding: 15px; margin-bottom: 10px; border-right-width: 3px;">
                    <div class="visit-details">
                        <p class="visit-notes">${log.event_description}</p>
                        <p class="visit-meta" style="padding:0; border:0; margin-top: 10px;">
                            <span><i class="ph-bold ph-user-circle"></i> ${log.user ? log.user.name : 'نظام'}</span>
                            <span><i class="ph-bold ph-calendar"></i> ${formatGregorianDateTime(log.event_timestamp)}</span>
                        </p>
                    </div>
                </div>
            `).join('');
        }
        return;
    }
const viewRecipientBtn = event.target.closest('.view-recipient-info-btn');
if (viewRecipientBtn) {
    const userId = viewRecipientBtn.dataset.userId;
    showRecipientInfo(userId);
    return;
}
    const manageInventoryBtn = event.target.closest('.manage-inventory-btn');
    if (manageInventoryBtn) {
        const inventoryId = manageInventoryBtn.dataset.inventoryId;
        const categoryName = manageInventoryBtn.dataset.categoryName;
        document.getElementById('inventory-details-modal').classList.remove('hidden');
        document.getElementById('add-item-from-details-btn').dataset.inventoryId = inventoryId;
        document.getElementById('add-item-from-details-btn').dataset.categoryName = categoryName;
        populateInventoryDetailsModal(inventoryId, categoryName);
        return;
    }
    document.getElementById('inventory-details-search')?.addEventListener('keyup', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const table = document.getElementById('inventory-details-table');
        if (!table) return;

        table.querySelectorAll('tbody tr').forEach(row => {
            const rowText = row.dataset.searchableText;
            if (rowText.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    const addNewBravoBtn = event.target.closest('#add-new-bravo-item-btn');
    if (addNewBravoBtn) {
        const modal = document.getElementById('add-admin-asset-item-modal');
        const categorySelect = document.getElementById('add-item-category-select');
        const fieldsContainer = document.getElementById('dynamic-asset-fields-container');
        modal.querySelector('form').reset();
        document.getElementById('add-another-asset-form-btn').classList.add('hidden');
        fieldsContainer.innerHTML = '<p style="text-align: center;">جاري تحميل الحقول...</p>';
        const { data: bravoCategory, error } = await supabaseClient
            .from('assets_inventory')
            .select('id, defined_fields')
            .eq('name', 'أجهزة برافو')
            .single();

        if (error || !bravoCategory) {
            return alert('خطأ: فئة "أجهزة برافو" غير موجودة في المخزون.');
        }
        document.getElementById('add-asset-item-modal-title').textContent = 'إضافة أجهزة برافو جديدة للمخزون';
        categorySelect.innerHTML = `<option value="${bravoCategory.id}" selected>أجهزة برافو</option>`;
        categorySelect.disabled = true; // منع المستخدم من تغيير الفئة

        const fields = bravoCategory.defined_fields || [{ name: 'الرقم التسلسلي' }]; // حقل افتراضي
        fieldsContainer.dataset.fields = JSON.stringify(fields);
        fieldsContainer.dataset.itemCount = 1;
        fieldsContainer.innerHTML = createAssetFieldsHtml(fields, 1);

        document.getElementById('add-another-asset-form-btn').classList.remove('hidden');
        modal.classList.remove('hidden');
        return;
    }
    if (event.target.closest('#add-admin-asset-item-modal .modal-close-btn')) {
        document.getElementById('add-item-category-select').disabled = false;
    }
    const assignAssetBtn = event.target.closest('.assign-asset-item-btn');
    if (assignAssetBtn) {
        const assetId = assignAssetBtn.dataset.id;
        const modal = document.getElementById('assign-asset-modal');
        const employeeSelect = document.getElementById('assign-to-employee-select');
        const { data: asset } = await supabaseClient.from('asset_items').select('details').eq('id', assetId).single();
        const identifier = asset.details?.identifier || asset.details?.serial_number || `قطعة رقم ${assetId}`;
        document.getElementById('assign-asset-item-name').textContent = identifier;
        
        document.getElementById('assign-asset-item-id').value = assetId;
        document.getElementById('assign-date').valueAsDate = new Date(); // تاريخ اليوم
        
        employeeSelect.innerHTML = '<option value="">جاري تحميل الموظفين...</option>';
        const adminRoles = ['ادارة العمليات', 'ادارة الموارد البشرية', 'ادارة العقود', 'المالية', 'التسويق', 'الشؤون القانونية', 'مدير النظام', 'ادارة العهد'];
        const { data: admins } = await supabaseClient.from('users').select('id, name').in('role', adminRoles);
        if (admins) {
            employeeSelect.innerHTML = '<option value="">-- اختر موظف --</option>';
            employeeSelect.innerHTML += admins.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }
        
        modal.classList.remove('hidden');
        return;
    }
    const returnAssetBtn = event.target.closest('.return-asset-item-btn');
    if (returnAssetBtn) {
        const assetId = returnAssetBtn.dataset.id;
        if (confirm('هل أنت متأكد من تسجيل ارتجاع هذه العهدة إلى المخزون؟')) {
            try {
                const { error } = await supabaseClient
                    .from('asset_items')
                    .update({
                        status: 'متوفر في المخزن',
                        assigned_to_user_id: null,
                        assignment_date: null,
                        condition: null,
                        notes: null
                    })
                    .eq('id', assetId);
                if (error) throw error;
                await supabaseClient.from('asset_history_log').insert({
                    asset_item_id: assetId,
                    event_description: 'تم تسجيل ارتجاع القطعة إلى المخزون.',
                    performed_by_user_id: currentUser.id
                });

                showToast('تم تسجيل الارتجاع بنجاح.', 'success');
                loadAdminAssetsPage();
            } catch (err) {
                alert('حدث خطأ: ' + err.message);
            }
        }
        return;
    }
    const editAssetItemBtn = event.target.closest('.edit-admin-asset-btn');
    if (editAssetItemBtn) {
        const assetId = editAssetItemBtn.dataset.id;
        const { data: asset, error } = await supabaseClient.from('asset_items').select('*, inventory:inventory_id(defined_fields)').eq('id', assetId).single();
        if (error || !asset) return alert('خطأ في جلب بيانات العهدة.');

        const modal = document.getElementById('add-admin-asset-item-modal');
        modal.dataset.editId = assetId; // وضع النافذة في "وضع التعديل"

        document.getElementById('add-asset-item-modal-title').textContent = 'تعديل بيانات قطعة عهدة';
        document.getElementById('add-item-category-select').innerHTML = `<option value="${asset.inventory_id}">تعديل ضمن نفس الفئة</option>`;
        document.getElementById('add-item-category-select').disabled = true;
        
        const fields = asset.inventory.defined_fields || [];
        const fieldsContainer = document.getElementById('dynamic-asset-fields-container');
        fieldsContainer.innerHTML = createAssetFieldsHtml(fields, 1);
        fields.forEach(field => {
            const input = fieldsContainer.querySelector(`.asset-detail-input[data-key="${field.name}"]`);
            if (input && asset.details[field.name]) {
                input.value = asset.details[field.name];
            }
        });

        document.getElementById('add-another-asset-form-btn').classList.add('hidden');
        modal.classList.remove('hidden');
        return;
    }
    const viewAssetHistoryBtn = event.target.closest('.view-asset-history-btn');
    if (viewAssetHistoryBtn) {
        const assetId = viewAssetHistoryBtn.dataset.id;
        const modal = document.getElementById('asset-history-modal');
        const container = document.getElementById('asset-history-log-container');
        
        modal.classList.remove('hidden');
        container.innerHTML = '<p style="text-align: center;">جاري تحميل السجل...</p>';

        const { data: item } = await supabaseClient.from('asset_items').select('details').eq('id', assetId).single();
        const identifier = item.details?.identifier || item.details?.serial_number || `قطعة رقم ${assetId}`;
        document.getElementById('history-asset-item-name').textContent = identifier;

        const { data: logs, error } = await supabaseClient
            .from('asset_history_log')
            .select('*, user:performed_by_user_id(name)')
            .eq('asset_item_id', assetId)
            .order('event_timestamp', { ascending: false });

        if (error) {
            container.innerHTML = '<p style="color:red;">خطأ في تحميل السجل.</p>';
        } else if (logs.length === 0) {
            container.innerHTML = '<p style="text-align: center;">لا توجد أحداث مسجلة لهذه القطعة.</p>';
        } else {
            container.innerHTML = logs.map(log => `
                <div class="visit-card" style="padding: 15px; margin-bottom: 10px; border-right-width: 3px;">
                    <div class="visit-details">
                        <p class="visit-notes">${log.event_description}</p>
                        <p class="visit-meta" style="padding:0; border:0; margin-top: 10px;">
                            <span><i class="ph-bold ph-user-circle"></i> ${log.user ? log.user.name : 'نظام'}</span>
                            <span><i class="ph-bold ph-calendar"></i> ${formatGregorianDateTime(log.event_timestamp)}</span>
                        </p>
                    </div>
                </div>
            `).join('');
        }
        return;
    }
    const addNewItemBtn = event.target.closest('#add-new-inventory-item-btn');
    if (addNewItemBtn) {
        const modal = document.getElementById('add-admin-asset-item-modal');
        const categorySelect = document.getElementById('add-item-category-select');
        const fieldsContainer = document.getElementById('dynamic-asset-fields-container');
        modal.querySelector('form').reset();
        fieldsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">الرجاء اختيار فئة لعرض حقولها المخصصة.</p>';
        document.getElementById('add-another-asset-form-btn').classList.add('hidden');
        categorySelect.innerHTML = '<option value="">جاري تحميل الفئات...</option>';
        const { data: categories, error } = await supabaseClient
            .from('assets_inventory')
            .select('id, name')
            .not('name', 'in', '("المركبات","أجهزة برافو")');
        
        if (error) {
            categorySelect.innerHTML = '<option value="">خطأ في التحميل</option>';
        } else {
            categorySelect.innerHTML = '<option value="">-- اختر فئة --</option>';
            categorySelect.innerHTML += categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }
        
        modal.classList.remove('hidden');
        return; // توقيف التنفيذ لمنع تداخل الأوامر
    }
if (event.target.closest('#export-inventory-btn')) {
    exportInventoryDetailsToExcel();
    return;
}
document.getElementById('inventory-details-search')?.addEventListener('keyup', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const table = document.getElementById('inventory-details-table');
    if (!table) return;

    table.querySelectorAll('tbody tr').forEach(row => {
        const rowText = row.textContent.toLowerCase();
        if (rowText.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
document.body.addEventListener('click', async function(event) {
    const btn = event.target.closest('.return-vehicle-btn');
    if (btn) {
        if(!confirm('هل أنت متأكد من استلام هذه المركبة؟ سيتم فك ارتباطها بالموظف وإعادتها "متوفرة".')) return;
        
        const vehicleId = btn.dataset.id;
        btn.disabled = true;
        btn.innerHTML = '...';

        try {
            const { error } = await supabaseClient
                .from('vehicles')
                .update({
                    assigned_employee_id: null,
                    status: 'فعالة' // تعود متوفرة
                })
                .eq('id', vehicleId);

            if (error) throw error;
            await supabaseClient.from('vehicle_history_log').insert({
                vehicle_id: vehicleId,
                event_description: 'تم استلام المركبة من الموظف (إنهاء خدمة)',
                performed_by_user_id: currentUser.id
            });

            showToast('تم استلام المركبة بنجاح.', 'success');
            btn.closest('.asset-row-action').remove();

        } catch (err) {
            alert('خطأ: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="ph-bold ph-check"></i> استلام';
        }
    }
});
    const returnAdminAssetBtn = event.target.closest('.return-admin-asset-btn');
    if (returnAdminAssetBtn) {
        const assetItemId = returnAdminAssetBtn.dataset.id;
        if (confirm('هل أنت متأكد من تسجيل ارتجاع هذه العهدة؟ سيتم إعادتها للمخزون.')) {
            try {
                const { error } = await supabaseClient
                    .from('asset_items')
                    .update({
                        status: 'في المخزن',
                        assigned_to_user_id: null,
                        assignment_date: null,
                        condition: null,
                        notes: null
                    })
                    .eq('id', assetItemId);

                if (error) throw error;

                showToast('تم تسجيل ارتجاع العهدة بنجاح.', 'success');
                loadAdminAssetsPage(); // تحديث القائمة

            } catch (err) {
                alert('خطأ: ' + err.message);
            }
        }
    }
const openVehiclesPageBtn = event.target.closest('.open-vehicles-page-btn');
if (openVehiclesPageBtn) {
    document.querySelector('.sidebar-nav a[data-page="page-vehicles"]').click();
    return; // توقف هنا لتجنب تداخل الأوامر
}
const addAnotherItemBtn = event.target.closest('#add-another-asset-item-btn');
if(addAnotherItemBtn) {
    const container = document.getElementById('asset-items-list-container');
    const fields = JSON.parse(container.dataset.fields || '[]');
    let itemCount = parseInt(container.dataset.itemCount || 1, 10) + 1;
    container.dataset.itemCount = itemCount;
    container.insertAdjacentHTML('beforeend', generateDynamicAssetItemFields(fields, itemCount));
    return;
}
const addAssetItemCardBtn = event.target.closest('.add-asset-item-card-btn');
if (addAssetItemCardBtn) {
    const inventoryId = addAssetItemCardBtn.dataset.inventoryId;
    const categoryName = addAssetItemCardBtn.dataset.categoryName;

    const modal = document.getElementById('add-asset-item-modal');
    document.getElementById('asset-item-modal-title').textContent = `إضافة "${categoryName}"`;
    document.getElementById('asset-item-inventory-id').value = inventoryId;

    const container = document.getElementById('asset-items-list-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الحقول المخصصة...</p>';
    modal.classList.remove('hidden');
    const { data: category, error } = await supabaseClient
        .from('assets_inventory')
        .select('defined_fields')
        .eq('id', inventoryId)
        .single();

    if (error || !category) {
        container.innerHTML = '<p style="color:red;">فشل تحميل الحقول.</p>';
    } else {
        const fields = category.defined_fields || [];
        container.innerHTML = generateDynamicAssetItemFields(fields, 1);
        container.dataset.fields = JSON.stringify(fields); // نخزن الحقول لاستخدامها في زر "إضافة آخر"
        container.dataset.itemCount = 1;
    }
    return;
}
    const resolveReportBtn = event.target.closest('.resolve-vehicle-report-btn');
    if (resolveReportBtn) {
        const reportId = resolveReportBtn.dataset.id;
        if (confirm('هل أنت متأكد من أن هذه المشكلة قد تم حلها؟')) {
            const { error } = await supabaseClient
                .from('vehicle_reports')
                .update({ status: 'تم الحل' })
                .eq('id', reportId);
            
            if (error) {
                alert('خطأ: ' + error.message);
            } else {
                showToast('تم تحديث حالة التقرير بنجاح.', 'success');
                loadVehicleReports(); // إعادة تحميل التبويب
            }
        }
    }
    const addAdminAssetBtn = event.target.closest('#add-admin-asset-btn');
if (addAdminAssetBtn) {
    const modal = document.getElementById('admin-asset-modal');
    document.getElementById('admin-asset-modal-title').textContent = 'تسليم عهدة جديدة';
    document.getElementById('admin-asset-form').reset();
    document.getElementById('admin-asset-id').value = ''; // <-- هنا تم التصحيح
    document.getElementById('admin-asset-item-group').classList.add('hidden');
    document.getElementById('admin-asset-item').value = ''; // تأكد أن هذا هو الاسم الصحيح
    document.getElementById('admin-asset-serial').value = '';
    document.getElementById('admin-asset-status').disabled = true;
    document.getElementById('admin-asset-date').valueAsDate = new Date();
    const { data: inventoryItems } = await supabaseClient.from('assets_inventory').select('id, name');
    setupSearchableSelect('admin-asset-type', inventoryItems.map(i => ({ id: i.id, text: i.name })));
    const adminRoles = ['ادارة العمليات', 'ادارة الموارد البشرية', 'ادارة العقود', 'المالية', 'التسويق', 'الشؤون القانونية', 'مدير النظام', 'ادارة العهد'];
    const { data: admins } = await supabaseClient.from('users').select('id, name').in('role', adminRoles);
    setupSearchableSelect('admin-asset-employee', admins.map(a => ({ id: a.id, text: a.name })));

    modal.classList.remove('hidden');
}
const editAdminAssetBtn = event.target.closest('.edit-admin-asset-btn');
if (editAdminAssetBtn) {
    const assetItemId = editAdminAssetBtn.dataset.id;
    const { data: asset, error } = await supabaseClient
        .from('asset_items')
        .select('*, inventory:inventory_id(name), employee:assigned_to_user_id(name, id)')
        .eq('id', assetItemId)
        .single();

    if (asset) {
        const modal = document.getElementById('admin-asset-modal');
        const employeeSearchInput = document.getElementById('admin-asset-employee-search');

        document.getElementById('admin-asset-modal-title').textContent = 'تعديل بيانات عهدة';
        document.getElementById('admin-asset-form').reset();

        document.getElementById('admin-asset-id').value = asset.id;
        document.getElementById('admin-asset-type-search').value = asset.inventory.name;
        document.getElementById('admin-asset-type-search').disabled = true;
        if (asset.employee) {
            employeeSearchInput.value = asset.employee.name;
            document.getElementById('admin-asset-employee').value = asset.employee.id;
            employeeSearchInput.disabled = true;
        } else {
            employeeSearchInput.value = '';
            employeeSearchInput.disabled = false;
            document.getElementById('admin-asset-employee').value = '';
            const adminRoles = ['ادارة العمليات', 'ادارة الموارد البشرية', 'ادارة العقود', 'المالية', 'التسويق', 'الشؤون القانونية', 'مدير النظام', 'ادارة العهد'];
            const { data: admins } = await supabaseClient.from('users').select('id, name').in('role', adminRoles);
            if (admins) {
                setupSearchableSelect('admin-asset-employee', admins.map(a => ({ id: a.id, text: a.name })));
            }
        }

        document.getElementById('admin-asset-item-search').disabled = true;
        document.getElementById('admin-asset-type').value = asset.inventory_id;
        document.getElementById('admin-asset-item').value = asset.id;
        document.getElementById('admin-asset-item-group').classList.remove('hidden');

        const serialNumber = asset.details?.serial_number || asset.details?.phone_number || asset.details?.identifier || Object.values(asset.details).join(' - ') || '-';
        document.getElementById('admin-asset-serial').value = serialNumber;
        document.getElementById('admin-asset-date').value = asset.assignment_date;
        document.getElementById('admin-asset-condition').value = asset.condition || 'جديد';
        document.getElementById('admin-asset-notes').value = asset.notes || '';

        const statusSelect = document.getElementById('admin-asset-status');
        statusSelect.disabled = false;
        statusSelect.value = asset.status === 'مسلمة' ? 'في الخدمة' : asset.status;

        modal.classList.remove('hidden');
    }
    return;
}
    const siteListItem = event.target.closest('.site-list-item');
    if (siteListItem) {
        document.querySelectorAll('.site-list-item').forEach(item => item.classList.remove('active'));
        siteListItem.classList.add('active');
        const contractId = siteListItem.dataset.contractId;
        const locationName = siteListItem.dataset.locationName;
        displayVehiclesForSite(contractId, locationName);
    }
const addVehicleBtn = event.target.closest('#add-general-vehicle-btn, #add-item-from-details-btn');
    if (addVehicleBtn) {
        const detailsModal = addVehicleBtn.closest('#inventory-details-modal');
        if (detailsModal && !document.getElementById('inventory-details-title').textContent.includes('المركبات')) {
        } else {
            const modal = document.getElementById('vehicle-modal');
            document.getElementById('vehicle-modal-title').textContent = 'إضافة مركبة جديدة للمخزون';
            document.getElementById('vehicle-form').reset();
            document.getElementById('vehicle-id').value = '';
            document.getElementById('vehicle-contract-select').value = '';
            const locationSelect = document.getElementById('vehicle-location-select');
            locationSelect.innerHTML = '<option value="">اختر عقداً أولاً</option>';
            locationSelect.disabled = true;
            document.getElementById('vehicle-supervisor').innerHTML = '<option value="">-- غير مسلمة --</option>';
            document.getElementById('vehicle-status').value = 'متوفر';
            
            modal.classList.remove('hidden');
            return;
        }
    }
    const editVehicleBtn = event.target.closest('.edit-vehicle-btn');
    if (editVehicleBtn) {
        const vehicleId = editVehicleBtn.dataset.id;
        const { data: vehicle, error } = await supabaseClient.from('vehicles').select('*, contract:contracts(*)').eq('id', vehicleId).single();
        if (vehicle) {
            const modal = document.getElementById('vehicle-modal');
            document.getElementById('vehicle-modal-title').textContent = 'تعديل بيانات مركبة';
            document.getElementById('vehicle-form').reset();
            
            document.getElementById('vehicle-id').value = vehicle.id;
            document.getElementById('vehicle-type').value = vehicle.vehicle_type;
            document.getElementById('vehicle-license-plate').value = vehicle.license_plate;
            document.getElementById('vehicle-reg-expiry').value = vehicle.registration_expiry_date;
            document.getElementById('vehicle-status').value = vehicle.status;
            document.getElementById('vehicle-ownership-type').value = vehicle.ownership_type || 'ملك';
            document.getElementById('vehicle-rental-office').value = vehicle.rental_office_name || '';
            document.getElementById('vehicle-rental-contact').value = vehicle.rental_office_contact || '';
            document.getElementById('vehicle-ownership-type').dispatchEvent(new Event('change'));

            const contractSelect = document.getElementById('vehicle-contract-select');
            const locationSelect = document.getElementById('vehicle-location-select');
            contractSelect.innerHTML = '<option value="">جاري التحميل...</option>';
            
            const { data: contracts } = await supabaseClient.from('contracts').select('id, company_name, contract_locations').eq('status', 'active');
            if (contracts) {
                contractSelect.innerHTML = '<option value="">-- اختر عقداً --</option>';
                contractSelect.innerHTML += contracts.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
                if (vehicle.contract_id) {
                    contractSelect.value = vehicle.contract_id;
                    const selectedContract = contracts.find(c => c.id === vehicle.contract_id);
                    if (selectedContract && selectedContract.contract_locations) {
                        locationSelect.innerHTML = '<option value="">-- اختر موقعاً --</option>';
                        locationSelect.innerHTML += selectedContract.contract_locations.map(loc => `<option value="${loc.name}">${loc.name}</option>`).join('');
                        locationSelect.disabled = false;
                        locationSelect.value = vehicle.location_name;
                    }
                }
            }

            const employeeSelect = document.getElementById('vehicle-supervisor');
            employeeSelect.innerHTML = '<option>جاري التحميل...</option>';
            
            let employees = [];
            if (vehicle.contract) {
                const { data: contractEmployees } = await supabaseClient.from('users').select('id, name').in('role', ['مشرف', 'حارس أمن']).contains('project', [vehicle.contract.company_name]);
                if (contractEmployees) employees = contractEmployees;
            } else {
                const { data: allEmployees } = await supabaseClient.from('users').select('id, name').in('role', ['مشرف', 'حارس أمن']);
                if (allEmployees) employees = allEmployees;
            }
            
            employeeSelect.innerHTML = '<option value="">-- غير مسلمة --</option>';
            employeeSelect.innerHTML += employees.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            employeeSelect.value = vehicle.assigned_employee_id || '';
            
            modal.classList.remove('hidden');
        }
        return;
    }
    const deleteVehicleBtn = event.target.closest('.delete-vehicle-btn');
    if(deleteVehicleBtn){
        const vehicleId = deleteVehicleBtn.dataset.id;
        if(confirm('هل أنت متأكد من حذف هذه المركبة؟')){
            const {error} = await supabaseClient.from('vehicles').delete().eq('id', vehicleId);
            if(error){
                alert('خطأ: ' + error.message);
            } else {
                showToast('تم حذف المركبة.', 'success');
                if (document.querySelector('#page-vehicles:not(.hidden)')) loadAllVehiclesView();
                if (document.querySelector('#inventory-details-modal:not(.hidden)')) {
                     const catName = document.getElementById('inventory-details-title').textContent.replace('إدارة: ', '');
                     const invId = document.getElementById('add-item-from-details-btn').dataset.inventoryId;
                     populateInventoryDetailsModal(invId, catName);
                }
            }
        }
    }
    const addInventoryBtn = event.target.closest('#add-inventory-item-btn');
    if (addInventoryBtn) {
        const modal = document.getElementById('inventory-item-modal');
        document.getElementById('inventory-modal-title').textContent = 'إضافة نوع عهدة جديد';
        document.getElementById('inventory-item-form').reset();
        document.getElementById('inventory-item-id').value = '';
        modal.classList.remove('hidden');
    }

    const editInventoryBtn = event.target.closest('.edit-inventory-item-btn');
    if (editInventoryBtn) {
        const itemId = editInventoryBtn.dataset.id;
        const { data, error } = await supabaseClient.from('assets_inventory').select('*').eq('id', itemId).single();
        if (data) {
            const modal = document.getElementById('inventory-item-modal');
            document.getElementById('inventory-modal-title').textContent = 'تعديل نوع عهدة';
            document.getElementById('inventory-item-id').value = data.id;
            document.getElementById('inventory-asset-type').value = data.asset_type;
            document.getElementById('inventory-total-quantity').value = data.total_quantity;
            document.getElementById('inventory-details').value = data.details ? JSON.stringify(data.details, null, 2) : '';
            modal.classList.remove('hidden');
        } else {
            alert('خطأ في جلب البيانات.');
        }
    }
const deleteInventoryBtn = event.target.closest('.delete-inventory-category-btn');
if (deleteInventoryBtn) {
    const categoryId = deleteInventoryBtn.dataset.id;
    const categoryName = deleteInventoryBtn.dataset.name;

    if (confirm(`هل أنت متأكد من حذف فئة "${categoryName}"؟ لا يمكن التراجع عن هذا الإجراء.`)) {
        try {
            const { count, error: countError } = await supabaseClient
                .from('asset_items')
                .select('*', { count: 'exact', head: true })
                .eq('inventory_id', categoryId);

            if (countError) throw countError;

            if (count > 0) {
                throw new Error(`لا يمكن حذف هذه الفئة لأنها تحتوي على ${count} قطعة. يجب عليك حذف جميع القطع أولاً من خلال زر "إدارة".`);
            }
            const { error: deleteError } = await supabaseClient
                .from('assets_inventory')
                .delete()
                .eq('id', categoryId);

            if (deleteError) throw deleteError;

            showToast(`تم حذف فئة "${categoryName}" بنجاح.`, 'success');
            loadInventoryPage(); // إعادة تحميل الواجهة

        } catch (error) {
            alert(`فشل الحذف: ${error.message}`);
        }
    }
    return;
}
    const editCategoryBtn = event.target.closest('.edit-inventory-category-btn');
    if (editCategoryBtn) {
        const categoryId = editCategoryBtn.dataset.id;
        const { data: category, error } = await supabaseClient.from('assets_inventory').select('id, name, defined_fields').eq('id', categoryId).single();
        if (error || !category) return alert('خطأ في جلب بيانات الفئة.');

        const modal = document.getElementById('add-edit-category-modal');
        document.getElementById('category-modal-title').textContent = `تعديل فئة: ${category.name}`;
        modal.querySelector('form').reset();
        document.getElementById('category-id').value = category.id;
        document.getElementById('category-name').value = category.name;
        
        const fieldsContainer = document.getElementById('category-fields-container');
        fieldsContainer.innerHTML = '';
        if (category.defined_fields && category.defined_fields.length > 0) {
            const fieldsHtml = category.defined_fields.map(field => `
                <div class="clause-item category-field-row">
                    <input type="text" class="clause-item-input category-field-name" value="${field.name}">
                    <button type="button" class="delete-btn delete-category-field-btn"><i class="ph-bold ph-trash"></i></button>
                </div>
            `).join('');
            fieldsContainer.innerHTML = fieldsHtml;
        }

        modal.classList.remove('hidden');
        return;
    }
    const addItemFromDetailsBtn = event.target.closest('#add-item-from-details-btn');
    if (addItemFromDetailsBtn) {
        const inventoryId = addItemFromDetailsBtn.dataset.inventoryId;
        const categoryName = addItemFromDetailsBtn.dataset.categoryName;

        const modal = document.getElementById('add-admin-asset-item-modal');
        const categorySelect = document.getElementById('add-item-category-select');
        const fieldsContainer = document.getElementById('dynamic-asset-fields-container');

        modal.querySelector('form').reset();
        document.getElementById('add-another-asset-form-btn').classList.add('hidden');
        fieldsContainer.innerHTML = '<p>جاري تحميل الحقول...</p>';

        const { data: category, error } = await supabaseClient
            .from('assets_inventory').select('defined_fields').eq('id', inventoryId).single();
        if (error || !category) return alert('خطأ في جلب بيانات الفئة.');

        document.getElementById('add-asset-item-modal-title').textContent = `إضافة قطع جديدة لفئة: ${categoryName}`;
        categorySelect.innerHTML = `<option value="${inventoryId}" selected>${categoryName}</option>`;
        categorySelect.disabled = true;

        const fields = category.defined_fields || [];
        fieldsContainer.dataset.fields = JSON.stringify(fields);
        fieldsContainer.dataset.itemCount = 1;
        fieldsContainer.innerHTML = createAssetFieldsHtml(fields, 1);

        document.getElementById('add-another-asset-form-btn').classList.remove('hidden');
        modal.classList.remove('hidden');
        return;
    }
const addOverrideBtn = event.target.closest('.add-day-override-btn');
if (addOverrideBtn) {
    const container = addOverrideBtn.closest('.shift-section-container').querySelector('.day-overrides-container');
    const newOverrideHtml = createDayOverrideHtml();
    container.insertAdjacentHTML('beforeend', newOverrideHtml);
}
const deleteOverrideBtn = event.target.closest('.delete-override-btn');
if (deleteOverrideBtn) {
    if (confirm('هل أنت متأكد من حذف هذا الاستثناء؟')) {
        deleteOverrideBtn.closest('.day-override-card').remove();
    }
}
const penaltyEmployeeItem = event.target.closest('.penalties-employee-item');
if (penaltyEmployeeItem) {
    document.querySelectorAll('.penalties-employee-item').forEach(item => item.classList.remove('active'));
    penaltyEmployeeItem.classList.add('active');
    const userId = penaltyEmployeeItem.dataset.userId;
    const userName = penaltyEmployeeItem.dataset.userName;
    loadPenaltyDetailsForEmployee(userId, userName);
}
const sendOtpBtn = event.target.closest('#send-otp-btn');
const resetPasswordBtn = event.target.closest('#reset-password-btn');

if (sendOtpBtn) {
    event.preventDefault();
    const idNumberInput = document.getElementById('reset-id-number');
    const idNumber = convertArabicNumeralsToEnglish(idNumberInput.value);

    if (!idNumber) return alert('الرجاء إدخال رقم الهوية.');

    sendOtpBtn.disabled = true;
    sendOtpBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';
        try {
            const { data, error } = await supabaseClient.functions.invoke('send-otp', {
                body: { id_number: idNumber },
            });

            if (error) throw error;
            if (data.error) throw new Error(data.error);
            document.getElementById('otp-step').classList.add('hidden');
            document.getElementById('reset-step').classList.remove('hidden');
            sendOtpBtn.classList.add('hidden');
            document.getElementById('reset-password-btn').classList.remove('hidden');

        } catch (error) {
        alert(error.message);
    } finally {
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = 'إرسال كود التحقق';
    }
    return; // توقيف التنفيذ
}

if (resetPasswordBtn) {
    event.preventDefault();
    resetPasswordBtn.disabled = true;
    resetPasswordBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';
    try {
        const idNumber = convertArabicNumeralsToEnglish(document.getElementById('reset-id-number').value);
        const otp = convertArabicNumeralsToEnglish(document.getElementById('reset-otp').value);
        const newPassword = document.getElementById('reset-new-password').value;
        const confirmPassword = document.getElementById('reset-confirm-password').value;

        if (newPassword.length < 6) throw new Error('كلمة المرور يجب أن لا تقل عن 6 أحرف.');
        if (newPassword !== confirmPassword) throw new Error('كلمتا المرور غير متطابقتين.');

        const { data, error } = await supabaseClient.functions.invoke('verify-otp-and-reset', {
            body: { id_number: idNumber, otp: otp, new_password: newPassword },
        });
        if (error) throw error; // هذا سيلتقطه الـ catch
        if (data.error) throw new Error(data.error); // هذا سيلتقطه الـ catch

        alert(data.message || 'تم إعادة تعيين كلمة المرور بنجاح!');

        const modal = document.getElementById('forgot-password-modal');
        modal.style.opacity = '0';
        setTimeout(() => { modal.style.display = 'none'; }, 300);

    } catch (error) {
        if (error.context && typeof error.context.json === 'function') {
            const errorData = await error.context.json();
            alert(errorData.error || 'حدث خطأ غير معروف.');
        } else {
            alert(error.message);
        }
    } finally {
        resetPasswordBtn.disabled = false;
        resetPasswordBtn.innerHTML = 'إعادة تعيين كلمة المرور';
    }
    return; // توقيف التنفيذ
}
const addPenaltyBtn = event.target.closest('.add-legal-penalty-btn');
if (addPenaltyBtn) {
    const userId = addPenaltyBtn.dataset.userId;
    const userName = addPenaltyBtn.dataset.userName;
    document.getElementById('legal-penalty-modal-title').textContent = `إضافة جزاء لـ: ${userName}`;
    document.getElementById('legal-penalty-user-id').value = userId;
    document.getElementById('legal-penalty-form').reset();
    document.getElementById('legal-penalty-date').valueAsDate = new Date();
    document.getElementById('add-legal-penalty-modal').classList.remove('hidden');
}

const viewHistoryBtn = event.target.closest('.view-legal-history-btn');
if (viewHistoryBtn) {
    const userId = viewHistoryBtn.dataset.userId;
    const historyContainer = document.getElementById(`history-for-${userId}`);
    const isHidden = historyContainer.classList.toggle('hidden');

    if (!isHidden) { // إذا تم فتح الحاوية
        historyContainer.innerHTML = '<p>جاري تحميل السجل...</p>';
        const { data, error } = await supabaseClient.from('legal_penalties').select('*').eq('user_id', userId).order('created_at', { ascending: false });
        if (error || data.length === 0) {
            historyContainer.innerHTML = '<p>لا يوجد سجل جزاءات لهذا الموظف.</p>';
        } else {
            historyContainer.innerHTML = data.map(p => `
                <div class="history-item">
                    <div>
                        <strong>${p.penalty_type} (${p.amount} ر.س)</strong>
                        <br><small style="color: var(--text-secondary);">${p.notes || ''}</small>
                    </div>
                    <small>${formatGregorianDate(p.created_at)}</small>
                </div>
            `).join('');
        }
    }
}

const sendAbsenceSmsBtn = event.target.closest('.send-absence-sms-btn');
if (sendAbsenceSmsBtn) {
    const phone = sendAbsenceSmsBtn.dataset.userPhone;
    const name = sendAbsenceSmsBtn.dataset.userName;
    if (!phone) return alert('لا يوجد رقم جوال مسجل لهذا الموظف.');
    if (confirm(`هل أنت متأكد من إرسال إشعار غياب للموظف: ${name}؟`)) {
        const message = `موظفنا العزيز.. نود إعلامك بأنه تم تسجيلك كـ'غياب' لهذا اليوم. يرجى التواصل مع الإدارة خلال 48 ساعة. - إدارة شؤون الموظفين`;
        sendAbsenceSmsBtn.disabled = true;
        await supabaseClient.functions.invoke('send-sms', { body: { to: phone, message } });
        showToast('تم إرسال إشعار الغياب بنجاح.', 'success');
        sendAbsenceSmsBtn.disabled = false;
    }
}
const lookupItem = event.target.closest('.lookup-result-item');
if (lookupItem) {
    const userId = lookupItem.dataset.userId;
    const detailsContainer = document.getElementById('legal-lookup-details');
    const placeholder = document.getElementById('legal-lookup-placeholder');
    document.querySelectorAll('.lookup-result-item').forEach(item => item.classList.remove('active'));
    lookupItem.classList.add('active');

    detailsContainer.classList.add('hidden');
    placeholder.classList.remove('hidden');
    placeholder.innerHTML = '<p style="text-align: center; margin-top: 50px;">جاري تحميل الملف الكامل...</p>';
            const { data: directData, error } = await supabaseClient
                .from('users')
                .select(`
                    id, name, id_number, phone, start_of_work_date, employment_status, role, iban, bank_name,
                    job_vacancies:job_vacancies!users_vacancy_id_fkey (
                        project, specific_location, base_salary, housing_allowance, transport_allowance, other_allowances,
                        contracts ( company_name, end_date )
                    )
                `)
                .eq('id', userId)
                .single();
        
            const [
                { data: attendanceData },
                { data: requestsData },
                { data: penaltiesData }
            ] = await Promise.all([
                supabaseClient.rpc('get_attendance_summary_for_user', { p_user_id: userId }),
                supabaseClient.rpc('get_requests_history_for_user', { p_user_id: userId }),
                supabaseClient.rpc('get_penalties_history_for_user', { p_user_id: userId })
            ]);
        
            let data = null;
            if (directData) {
                const v = directData.job_vacancies;
                data = {
                    personal_info: {
                        id: directData.id, name: directData.name, id_number: directData.id_number,
                        phone: directData.phone, start_date: directData.start_of_work_date,
                        status: directData.employment_status, role: directData.role
                    },
                    employment_info: v ? {
                        project: v.project, location: v.specific_location,
                        contract_name: v.contracts?.company_name,
                        contract_end_date: v.contracts?.end_date
                    } : {},
                    financial_info: v ? {
                        base_salary: v.base_salary, housing_allowance: v.housing_allowance,
                        transport_allowance: v.transport_allowance, other_allowances: v.other_allowances,
                        iban: directData.iban, bank_name: directData.bank_name
                    } : {
                        iban: directData.iban, bank_name: directData.bank_name
                    },
                    attendance_summary: attendanceData,
                    requests_history: requestsData,
                    penalties_history: penaltiesData
                };
            } else {
                if (error) console.error('Error fetching legal profile data:', error);
            }

    if (error) {
            placeholder.innerHTML = '<p style="color:red; text-align:center;">حدث خطأ في جلب بيانات الموظف.</p>';
        } else if (data) {
            displayLegalProfileData(data);
        } else {
            placeholder.innerHTML = `<div class"empty-state" style="margin-top: 50px; text-align: center; color: var(--text-secondary);">
                <i class="ph-bold ph-user-minus" style="font-size: 3rem; display: block; margin-bottom: 15px; color: var(--denied-color);"></i>
                <h4 style="color: var(--text-primary); font-size: 1.2rem;">لا يمكن عرض الملف</h4>
                <p>هذا الموظف غير مسكن على شاغر وظيفي حالياً، أو أن بياناته الأساسية غير مكتملة.</p>
            </div>`;
        }
}
const openSiteAssignmentBtn = event.target.closest('#open-site-assignment-modal-btn');
if (openSiteAssignmentBtn) {
    const mainModal = openSiteAssignmentBtn.closest('.modal-panel');
    const employeeId = mainModal.querySelector('#employee-id').value;
    const { data: employee, error } = await supabaseClient.from('users').select('name, assigned_locations').eq('id', employeeId).single();
    if (error) return alert('فشل في جلب بيانات المشرف.');

    const assignmentModal = document.getElementById('site-assignment-modal');
    document.getElementById('assignment-modal-supervisor-name').textContent = employee.name;
    populateSiteAssignmentModal(employee); 

    assignmentModal.classList.remove('hidden');
}
const saveAssignmentsBtn = event.target.closest('#save-site-assignments-btn');
if (saveAssignmentsBtn) {
    const summarySpan = document.getElementById('assigned-locations-summary');
    if (currentAssignedLocations.length > 0) {
        summarySpan.textContent = `${currentAssignedLocations.length} موقع معين.`;
    } else {
        summarySpan.textContent = 'لم يتم تحديد مواقع.';
    }
    document.getElementById('site-assignment-modal').classList.add('hidden');
}
const cancelAssignmentBtn = event.target.closest('.cancel-assignment-btn');
if (cancelAssignmentBtn) {
    const guardId = cancelAssignmentBtn.dataset.guardId;
    const guardName = cancelAssignmentBtn.dataset.guardName;

    const reason = prompt(`أنت على وشك إلغاء تكليف الحارس "${guardName}".\nالرجاء كتابة سبب الإلغاء:`);
    if (!reason || !reason.trim()) return;

    if (!confirm('هل أنت متأكد؟ سيتم إعادة فتح فرصة التغطية وإلغاء تكليف الحارس.')) return;

    cancelAssignmentBtn.disabled = true;

    try {
        const { data: guard, error: guardError } = await supabaseClient.from('users').select('employment_status, auth_user_id').eq('id', guardId).single();
        if (guardError) throw new Error('لم يتم العثور على بيانات الحارس.');
        const { data: assignment, error: assignmentError } = await supabaseClient
            .from('coverage_applicants')
            .select('id, shift_id, coverage_shifts!inner(status)')
            .eq('applicant_user_id', guardId)
            .eq('coverage_shifts.status', 'closed')
            .limit(1).single();

        if (assignmentError || !assignment) {
            throw new Error('لم يتم العثور على سجل تكليف فعال (shift assignment) لهذا الحارس. قد يكون السجل قديماً أو ملغياً.');
        }
        
        const shiftId = assignment.shift_id;
        const applicantId = assignment.id;
        await supabaseClient.from('coverage_shifts').update({ status: 'open' }).eq('id', shiftId);
        await supabaseClient.from('coverage_applicants').update({ status: 'cancelled_by_supervisor', rejection_reason: reason }).eq('id', applicantId);
        if (guard.employment_status === 'تغطية') {
            await supabaseClient.from('coverage_payments').delete().eq('coverage_shift_id', shiftId);
            if (guard.auth_user_id) {
                await supabaseClient.functions.invoke('delete-employee', { body: { user_id: guardId, auth_user_id: guard.auth_user_id } });
            }
        } else {
            const { error: overtimeDeleteError } = await supabaseClient
                .from('overtime_records')
                .delete()
                .eq('employee_id', guardId)
                .eq('coverage_shift_id', shiftId); // <-- نحذف بناءً على رقم الوردية (أضمن)

            if (overtimeDeleteError) {
                throw new Error(`فشل حذف سجل العمل الإضافي: ${overtimeDeleteError.message}`);
            }
        }
        sendNotification(guardId, 'إلغاء تكليف', `تم إلغاء تكليفك بتغطية وردية. السبب: ${reason}`);
        showToast(`تم إلغاء تكليف ${guardName} بنجاح.`, 'success');
        loadGuardAttendancePage();

    } catch (error) {
        alert('حدث خطأ أثناء إلغاء التكليف: ' + error.message);
        cancelAssignmentBtn.disabled = false;
    }
}
const proactiveCoverageBtn = event.target.closest('.proactive-coverage-btn');
if (proactiveCoverageBtn) {
    const warningMessage = `تنبيه هام! أنت على وشك إنشاء تغطية لهذه الوردية.

بالمتابعة، أنت:
1. تؤكد أن الموظف الأساسي لن يحضر.
2. تمنع الموظف الأساسي من تسجيل الحضور.
3. تتحمل المسؤولية الكاملة عن هذه التغطية.

هل أنت متأكد من المتابعة؟`;
    
    const confirmModal = document.getElementById('custom-confirm-modal');
    document.getElementById('custom-confirm-title').textContent = 'تأكيد إنشاء تغطية';
    document.getElementById('custom-confirm-message').textContent = warningMessage;
    const confirmBtn = document.getElementById('custom-confirm-yes-btn');
    confirmBtn.dataset.need = proactiveCoverageBtn.dataset.need;

    confirmModal.classList.remove('hidden');
}
const confirmProactiveCoverageBtn = event.target.closest('#custom-confirm-yes-btn');
if (confirmProactiveCoverageBtn && confirmProactiveCoverageBtn.dataset.need) {
    const needDataString = confirmProactiveCoverageBtn.dataset.need;
    const simulatedBtn = document.createElement('button');
    simulatedBtn.className = 'publish-coverage-btn';
    simulatedBtn.dataset.need = needDataString;
    document.body.appendChild(simulatedBtn);
    simulatedBtn.click();
    document.body.removeChild(simulatedBtn);
    document.getElementById('custom-confirm-modal').classList.add('hidden');
    delete confirmProactiveCoverageBtn.dataset.need;
}
const reviewReportBtn = event.target.closest('.review-custody-report-btn');
if (reviewReportBtn) {
    const reportId = reviewReportBtn.dataset.reportId;
    const modal = document.getElementById('review-custody-report-modal');
    const body = document.getElementById('review-report-body');
    const title = document.getElementById('review-report-title');
    const settleBtn = document.getElementById('settle-report-btn');

    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري تحميل تفاصيل التقرير...</p>';

    try {
        const { data: report, error } = await supabaseClient.from('custody_reports').select('*').eq('id', reportId).single();
        if (error) throw error;

        const snap = report.report_snapshot;
        title.textContent = `مراجعة تقرير المشرف: ${snap.supervisor_info.name}`;
        settleBtn.style.display = report.status === 'pending_finance_review' ? 'inline-flex' : 'none';
        body.innerHTML = `
            <div class="review-request-card" style="margin-bottom:20px;">
                <div class="review-request-body">
                    <p><strong>إجمالي المبلغ:</strong> ${report.total_amount.toFixed(2)} ر.س</p>
                    <p><strong>تاريخ الرفع:</strong> ${formatGregorianDate(report.submission_date)}</p>
                    <p><strong>الرصيد قبل:</strong> ${snap.balance_before_settlement.toFixed(2)} ر.س | <strong>الرصيد بعد:</strong> ${snap.balance_after_settlement.toFixed(2)} ر.س</p>
                </div>
            </div>
            <div class="table-container">
                <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>اسم الحارس</th>
                        <th>المشروع</th>
                        <th>الموقع</th>
                        <th>السبب</th>
                        <th>الوردية</th>
                        <th>المبلغ</th>
                        <th>القرار</th>
                        <th>ملاحظات المشرف</th>
                    </tr>
                </thead>
                <tbody>
                ${(snap.line_items || []).map(item => {
                    const decisionText = item.decision_info.decision === 'paid_from_custody' ? 'تم الصرف' : 'مستبعد';
                    return `
                        <tr>
                            <td>${item.covering_guard_info.name}</td>
                            <td>${item.shift_info.project || '-'}</td>
                            <td>${item.shift_info.location || '-'}</td>
                            <td>${item.shift_info.reason || '-'}</td>
                            <td>${createShiftTimeLabel(item.shift_info)}</td>
                            <td>${item.financial_info.payment_amount} ر.س</td>
                            <td>${decisionText}</td>
                            <td>${item.decision_info.notes || '-'}</td>
                        </tr>
                    `;
                }).join('')}
                </tbody>
                </table>
            </div>
        `;

    } catch(error) {
        body.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
const settleReportBtn = event.target.closest('#settle-report-btn');
if (settleReportBtn) {
    const reportId = reviewReportBtn.dataset.reportId; // Note: Assuming reviewReportBtn is in scope or find another way to get reportId if needed.
    const supervisorId = settleReportBtn.dataset.supervisorId; 

    if (!confirm('هل أنت متأكد من أرشفة كل العمليات المعروضة لهذا المشرف؟')) return;

    settleReportBtn.disabled = true;
    settleReportBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

    try {
        const { data: pendingPayments, error: fetchError } = await supabaseClient
            .from('coverage_payments')
            .select('id, payment_amount, transaction_snapshot')
            .eq('paid_by_supervisor_id', supervisorId)
            .in('status', ['paid_from_custody', 'excluded_by_supervisor'])
            .is('custody_report_id', null);

        if (fetchError) throw fetchError;
        if (pendingPayments.length === 0) throw new Error('لا توجد عمليات لأرشفتها.');

        const totalAmount = pendingPayments.reduce((sum, p) => sum + (p.payment_amount || 0), 0);
        const { data: supervisor } = await supabaseClient.from('users').select('name, custody_balance').eq('id', supervisorId).single();
        const balanceBefore = supervisor.custody_balance || 0;

        const reportSnapshot = {
            supervisor_info: { id: supervisorId, name: supervisor.name },
            balance_before_settlement: balanceBefore,
            balance_after_settlement: balanceBefore - totalAmount,
            line_items: pendingPayments.map(p => p.transaction_snapshot)
        };

        const { data: newReport, error: reportError } = await supabaseClient
            .from('custody_reports')
            .insert({
                supervisor_id: supervisorId,
                total_amount: totalAmount,
                status: 'settled',
                submission_date: new Date(),
                settled_by_user_id: currentUser.id,
                settled_at: new Date(),
                report_snapshot: reportSnapshot
            })
            .select('id')
            .single();

        if (reportError) throw reportError;

        const paymentIdsToUpdate = pendingPayments.map(p => p.id);
        const { error: updateError } = await supabaseClient
            .from('coverage_payments')
            .update({ custody_report_id: newReport.id })
            .in('id', paymentIdsToUpdate);

        if (updateError) throw updateError;
        await supabaseClient.from('users').update({ custody_balance: (balanceBefore - totalAmount) }).eq('id', supervisorId);


        showToast('تم اعتماد وأرشفة التقرير بنجاح!', 'success');
        document.getElementById('review-custody-report-modal').classList.add('hidden');
        document.querySelector('.tab-link[data-tab="finance-supervisors-list"]').click();

    } catch (error) {
        alert('حدث خطأ فادح: ' + error.message);
    } finally {
        settleReportBtn.disabled = false;
        settleReportBtn.innerHTML = '<i class="ph-bold ph-check-circle"></i> اعتماد وأرشفة كل العمليات';
    }
}
const viewProofBtn = event.target.closest('.view-proof-btn');
if (viewProofBtn) {
    const proofUrlPath = viewProofBtn.dataset.url;
    if (!proofUrlPath) return alert('لا يوجد مسار للملف.');

    viewProofBtn.disabled = true;
    try {
        const { data, error } = await supabaseClient.storage.from('job-applications').createSignedUrl(proofUrlPath, 300); // صلاحية 5 دقائق
        if (error) throw error;
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const zoomedImage = document.getElementById('zoomed-image');
        zoomedImage.src = data.signedUrl;
        imageViewerModal.classList.remove('hidden');

    } catch(error) {
        alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
    } finally {
        viewProofBtn.disabled = false;
    }
}
const viewReportBtn = event.target.closest('.view-supervisor-report-btn');
if (viewReportBtn) {
    const supervisorId = viewReportBtn.dataset.id;
    const supervisorName = viewReportBtn.dataset.name;

    if (supervisorId) {
        sessionStorage.setItem('report_supervisor_id', supervisorId);
        sessionStorage.setItem('report_supervisor_name', supervisorName);
        const page = viewReportBtn.closest('.page-content');
        page.querySelector('.tab-link[data-tab="finance-pending-reports"]').click();
    }
}
const supervisorCustodyTab = event.target.closest('#page-supervisor-custody .tab-link');
if (supervisorCustodyTab) {
    event.preventDefault();
    const page = supervisorCustodyTab.closest('.page-content');
    const targetTabId = supervisorCustodyTab.dataset.tab;

    page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
    page.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    supervisorCustodyTab.classList.add('active');
    document.getElementById(targetTabId).classList.add('active');

    if (targetTabId === 'custody-archive') {
        loadSupervisorCustodyArchive();
    }
}
const disburseBtn = event.target.closest('.disburse-custody-btn');
if (disburseBtn) {
    const supervisorId = disburseBtn.dataset.id;
    const supervisorName = disburseBtn.dataset.name;
    const currentBalance = parseFloat(disburseBtn.dataset.balance).toFixed(2);
    
    const modal = document.getElementById('disburse-custody-modal');
    document.getElementById('disburse-supervisor-id').value = supervisorId;
    document.getElementById('disburse-supervisor-info').textContent = `المشرف: ${supervisorName} | الرصيد الحالي: ${currentBalance} ر.س`;
    document.getElementById('disbursement-amount').value = '';
    
    modal.classList.remove('hidden');
}
const custodyViewDetailsBtn = event.target.closest('.custody-view-details-btn');
if (custodyViewDetailsBtn) {
    const modal = document.getElementById('applicant-details-modal');
    const body = document.getElementById('applicant-details-body');
    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري عرض البيانات...</p>';

    try {
        if (custodyViewDetailsBtn.dataset.details) {
            const application = JSON.parse(custodyViewDetailsBtn.dataset.details);
            if (application.users) {
                const userData = application.users;
                 body.innerHTML = `
                    <div class="contract-display"><h4>بيانات الموظف</h4><p><strong>الاسم:</strong> ${userData.name || ''}</p><p><strong>رقم الهوية:</strong> ${userData.id_number || ''}</p><p><strong>رقم الجوال:</strong> ${userData.phone || ''}</p><p><strong>الآيبان:</strong> ${userData.iban || ''}</p><hr><h4>المرفقات</h4><p style="text-align:center; color: var(--text-secondary);">هذا موظف حالي، لا توجد مرفقات إضافية.</p></div>`;
            } else {
                let idPhotoUrl = "https://placehold.co/400x250/e2e8f0/a0aec0?text=لا+يوجد+مرفق";
                let ibanCertUrl = "https://placehold.co/400x250/e2e8f0/a0aec0?text=لا+يوجد+مرفق";
                if (application.id_photo_url && application.iban_certificate_url) {
                    const { data: signedUrls } = await supabaseClient.storage.from('job-applications').createSignedUrls([application.id_photo_url, application.iban_certificate_url], 300);
                    if (signedUrls) {
                        idPhotoUrl = signedUrls.find(u => u.path === application.id_photo_url)?.signedUrl || idPhotoUrl;
                        ibanCertUrl = signedUrls.find(u => u.path === application.iban_certificate_url)?.signedUrl || ibanCertUrl;
                    }
                }
                body.innerHTML = `<div class="contract-display"><h4>بيانات المتقدم</h4><p><strong>الاسم:</strong> ${application.full_name || ''}</p><p><strong>رقم الهوية:</strong> ${application.id_number || ''}</p><p><strong>رقم الجوال:</strong> ${application.phone_number || ''}</p><p><strong>الآيبان:</strong> ${application.iban || ''}</p><hr><h4>المرفقات</h4><div class="attachments-grid"><div><h5>صورة الهوية</h5><img src="${idPhotoUrl}" alt="صورة الهوية" class="attachment-image viewable-image"></div><div><h5>شهادة الآيبان</h5><img src="${ibanCertUrl}" alt="شهادة الآيبان" class="attachment-image viewable-image"></div></div></div>`;
            }
        } 
        else if (custodyViewDetailsBtn.dataset.snapshot) {
            const snapshot = JSON.parse(custodyViewDetailsBtn.dataset.snapshot);
            const info = snapshot.covering_guard_info;

            let detailsHtml = `
                <div class="contract-display">
                        <h4>بيانات الموظف (من الأرشيف)</h4>
                <p><strong>الاسم:</strong> ${info.name || ''}</p>
                <p><strong>رقم الهوية:</strong> ${info.id_number || 'غير متوفر'}</p>
                <p><strong>رقم الجوال:</strong> ${info.phone || 'غير متوفر'}</p>
                <p><strong>اسم البنك:</strong> ${info.bank_name || 'غير متوفر'}</p>
                <p><strong>الآيبان:</strong> ${info.iban || ''}</p>
                <p><strong>نوع المتقدم:</strong> ${info.type || ''}</p>
                <hr>
                <h4>المرفقات</h4>
                <div class="attachments-grid" id="snapshot-attachments">
                    <p style="text-align:center; grid-column: 1 / -1;">جاري تحميل المرفقات...</p>
                </div>
            </div>`;
            body.innerHTML = detailsHtml;
            const attachmentsContainer = document.getElementById('snapshot-attachments');
            if (info.type === 'خارجي' && info.id_photo_url && info.iban_certificate_url) {
                const { data: signedUrls } = await supabaseClient.storage.from('job-applications').createSignedUrls([info.id_photo_url, info.iban_certificate_url], 300);
                if (signedUrls) {
                    const idPhotoUrl = signedUrls.find(u => u.path === info.id_photo_url)?.signedUrl;
                    const ibanCertUrl = signedUrls.find(u => u.path === info.iban_certificate_url)?.signedUrl;
                    attachmentsContainer.innerHTML = `
                        <div><h5>صورة الهوية</h5><img src="${idPhotoUrl}" alt="صورة الهوية" class="attachment-image viewable-image"></div>
                        <div><h5>شهادة الآيبان</h5><img src="${ibanCertUrl}" alt="شهادة الآيبان" class="attachment-image viewable-image"></div>
                    `;
                } else {
                    attachmentsContainer.innerHTML = '<p style="text-align:center;">خطأ في تحميل المرفقات.</p>';
                }
            } else {
                attachmentsContainer.innerHTML = '<p style="text-align:center;">لا توجد مرفقات لهذا المستخدم.</p>';
            }
        }
    } catch (error) {
        body.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
const confirmPaymentBtn = event.target.closest('.custody-confirm-payment-btn');
if (confirmPaymentBtn) {
    const paymentId = confirmPaymentBtn.dataset.paymentId;
    const modal = document.getElementById('confirm-payment-modal');
    modal.querySelector('form').reset(); // إفراغ الحقول
    document.getElementById('payment-id-for-confirmation').value = paymentId;
    modal.classList.remove('hidden');
}
const excludePaymentBtn = event.target.closest('.custody-exclude-btn');
if (excludePaymentBtn) {
    const paymentId = excludePaymentBtn.dataset.paymentId;
    const modal = document.getElementById('exclude-payment-modal');
    modal.querySelector('form').reset();
    document.getElementById('payment-id-for-exclusion').value = paymentId;
    modal.classList.remove('hidden');
}
const editSnapshotBtn = event.target.closest('.att-mgmt-edit-snapshot-btn');
if (editSnapshotBtn) {
    const attendanceId = editSnapshotBtn.dataset.id;
    const guardId = editSnapshotBtn.dataset.guardId;
    populateSnapshotModal(guardId, attendanceId);
}
const snapshotTab = event.target.closest('#edit-snapshot-modal .tab-link');
if (snapshotTab) {
    event.preventDefault();
    const modal = snapshotTab.closest('.modal-panel');
    modal.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
    modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    snapshotTab.classList.add('active');
    document.getElementById(snapshotTab.dataset.tab)?.classList.add('active');
}
if (event.target.id === 'snapshot-previous-select') {
    if(event.target.value) {
        const selectedSnapshot = JSON.parse(event.target.value);
        fillSnapshotManualForm(selectedSnapshot);
    }
}
const fetchCurrentBtn = event.target.closest('#fetch-current-snapshot-btn');
if (fetchCurrentBtn) {
    const guardId = document.getElementById('snapshot-guard-id').value;
    if (!guardId) return alert('خطأ: لم يتم العثور على معرّف الحارس.');

    fetchCurrentBtn.disabled = true;
    fetchCurrentBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

    try {
        const { data: user, error } = await supabaseClient
            .from('users')
            .select('*, job_vacancies!users_vacancy_id_fkey(*)')
            .eq('id', guardId)
            .single();

        if (error || !user || !user.job_vacancies) throw new Error('لم يتم العثور على بيانات الشاغر الحالي للحارس.');

        const vacancy = user.job_vacancies;
        const currentSnapshot = {
            project: vacancy.project,
            location: vacancy.specific_location,
            region: vacancy.region,
            city: vacancy.location,
            schedule_details: vacancy.schedule_details,
            base_salary: vacancy.base_salary,
            housing_allowance: vacancy.housing_allowance,
            transport_allowance: vacancy.transport_allowance,
            other_allowances: vacancy.other_allowances
        };
        fillSnapshotManualForm(currentSnapshot);
        document.querySelector('#edit-snapshot-modal .tab-link[data-tab="snapshot-manual-group"]').click();
        showToast('تم جلب البيانات الحالية بنجاح.', 'success');

    } catch (err) {
        alert(err.message);
    } finally {
        fetchCurrentBtn.disabled = false;
        fetchCurrentBtn.innerHTML = '<i class="ph-bold ph-download-simple"></i> جلب البيانات الحالية';
    }
}
const saveSnapshotBtn = event.target.closest('#save-snapshot-btn');
if (saveSnapshotBtn) {
    const attendanceId = document.getElementById('snapshot-attendance-id').value;
    if (!attendanceId) return alert('خطأ: لم يتم تحديد سجل الحضور.');

    saveSnapshotBtn.disabled = true;

    try {
        const newSnapshot = {
            project: document.getElementById('snapshot-manual-project').value,
            location: document.getElementById('snapshot-manual-location').value,
            region: document.getElementById('snapshot-manual-region').value,
            city: document.getElementById('snapshot-manual-city').value,
            schedule_details: JSON.parse(document.getElementById('snapshot-manual-schedule').value)
        };
        const { error } = await supabaseClient
            .from('attendance')
            .update({ shift_snapshot: newSnapshot })
            .eq('id', attendanceId);

        if (error) throw error;
        await supabaseClient.from('audit_logs').insert({ 
            user_name: currentUser.name, 
            action_type: 'تعديل لقطة الحضور', 
            details: { attendance_record_id: attendanceId } 
        });

        showToast('تم تحديث اللقطة بنجاح!', 'success');
        document.getElementById('edit-snapshot-modal').classList.add('hidden');
        loadAttendanceManagementPage(); // إعادة تحميل بيانات الصفحة

    } catch (err) {
        alert('حدث خطأ أثناء الحفظ. تأكد من أن صيغة JSON في حقل الوردية صحيحة.\\n' + err.message);
    } finally {
        saveSnapshotBtn.disabled = false;
    }
}
const addInferredRecordBtn = event.target.closest('.add-inferred-record-btn');
if (addInferredRecordBtn) {
    const guardId = addInferredRecordBtn.dataset.guardId;
    const guardName = addInferredRecordBtn.dataset.guardName;
    const recordDate = addInferredRecordBtn.dataset.date;

    const modal = document.getElementById('manual-attendance-modal');
    const userSelect = document.getElementById('manual-attendance-user-select');
    const checkinInput = document.getElementById('manual-checkin-time');
    const checkoutInput = document.getElementById('manual-checkout-time');
    modal.querySelector('.modal-body').querySelectorAll('input:not(#manual-checkin-time, #manual-checkout-time), select:not(#manual-attendance-user-select), textarea').forEach(el => el.value = '');
    userSelect.innerHTML = `<option value="${guardId}">${guardName}</option>`;
    userSelect.value = guardId;
    userSelect.disabled = true;
    const { data: user, error } = await supabaseClient.from('users').select('job_vacancies!users_vacancy_id_fkey(schedule_details)').eq('id', guardId).single();
    if (!error && user && user.job_vacancies) {
        const schedule = user.job_vacancies.schedule_details[0];
        const period = schedule.periods ? schedule.periods[0] : schedule; // يدعم كلا الشكلين
        if (period.start_time) {
            checkinInput.value = `${recordDate}T${period.start_time}`;
        }
        if (period.end_time) {
            let checkoutDate = new Date(`${recordDate}T${period.end_time}`);
            if (period.end_time < period.start_time) { // إذا كانت الوردية ليلية
                checkoutDate.setDate(checkoutDate.getDate() + 1);
            }
            const tzoffset = (new Date()).getTimezoneOffset() * 60000;
            const localISOTime = (new Date(checkoutDate - tzoffset)).toISOString().slice(0, 16);
            checkoutInput.value = localISOTime;
        }
    } else {
        checkinInput.value = `${recordDate}T08:00`; // وقت افتراضي في حال عدم وجود وردية
        checkoutInput.value = '';
    }
    
    modal.classList.remove('hidden');
}
if (event.target.closest('#manual-attendance-modal .modal-close-btn')) {
    document.getElementById('manual-attendance-user-select').disabled = false;
}
const deleteAttendanceBtn = event.target.closest('.att-mgmt-delete-btn');
if (deleteAttendanceBtn) {
    const recordId = deleteAttendanceBtn.dataset.id;
    if (confirm('هل أنت متأكد من حذف هذا السجل نهائياً؟ لا يمكن التراجع عن هذا الإجراء.')) {
        
        deleteAttendanceBtn.disabled = true;

        try {
            const { error } = await supabaseClient
                .from('attendance')
                .delete()
                .eq('id', recordId);

            if (error) throw error;
            
            showToast('تم حذف السجل بنجاح.', 'success');
            await supabaseClient.from('audit_logs').insert({ 
                user_name: currentUser.name, 
                action_type: 'حذف سجل حضور', 
                details: { deleted_record_id: recordId } 
            });
            loadAttendanceManagementPage();

        } catch (error) {
            showToast(`فشل حذف السجل: ${error.message}`, 'error');
            console.error("Attendance delete error:", error);
            deleteAttendanceBtn.disabled = false;
        }
    }
}
const restartTrackingBtn = event.target.closest('#restart-tracking-btn');
if (restartTrackingBtn) {
    restartTrackingBtn.disabled = true;
    restartTrackingBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';
    loadAttendancePage(); // إعادة تحميل منطق الصفحة بالكامل لمحاولة بدء التتبع من جديد
}
const openManualRecordModalBtn = event.target.closest('#add-manual-record-from-mgmt-btn');
if (openManualRecordModalBtn) {
    const modal = document.getElementById('manual-attendance-modal');
    const userSelect = document.getElementById('manual-attendance-user-select');
    modal.querySelector('.modal-body').querySelectorAll('input, select, textarea').forEach(el => {
        if (el.id !== 'manual-attendance-user-select') el.value = '';
    });
    userSelect.innerHTML = '<option value="">جاري تحميل الموظفين...</option>';
    const { data: users, error } = await supabaseClient.from('users').select('id, name').order('name');
    if (error) {
        userSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
    } else {
        userSelect.innerHTML = '<option value="">-- اختر الموظف --</option>';
        userSelect.innerHTML += users.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
    }

    modal.classList.remove('hidden');
}
const saveManualAttendanceBtn = event.target.closest('#save-manual-attendance-btn');
if (saveManualAttendanceBtn) {
    const userId = document.getElementById('manual-attendance-user-select').value;
    const checkinTime = document.getElementById('manual-checkin-time').value;
    const checkoutTime = document.getElementById('manual-checkout-time').value;
    const status = document.getElementById('manual-attendance-status').value;
    const notes = document.getElementById('manual-attendance-notes').value;

    if (!userId || !checkinTime || !status) {
        return alert('الرجاء اختيار الموظف وتحديد وقت الحضور والحالة على الأقل.');
    }
    if (checkoutTime && new Date(checkoutTime) < new Date(checkinTime)) {
        return alert('وقت الانصراف يجب أن يكون بعد وقت الحضور.');
    }

    saveManualAttendanceBtn.disabled = true;
    saveManualAttendanceBtn.textContent = 'جاري الحفظ...';

    try {
        const { data: user, error: userError } = await supabaseClient
            .from('users')
            .select('*, job_vacancies!users_vacancy_id_fkey(*)')
            .eq('id', userId)
            .single();

        if (userError || !user) throw new Error('لم يتم العثور على بيانات الموظف أو الشاغر المرتبط به.');

        const vacancy = user.job_vacancies;
        const shiftSnapshot = {
            project: vacancy ? vacancy.project : user.project,
            location: vacancy ? vacancy.specific_location : user.location,
            region: vacancy ? vacancy.region : user.region,
            city: vacancy ? vacancy.location : user.city,
            schedule_details: vacancy ? vacancy.schedule_details : null
        };

        const recordData = {
            guard_id: userId,
            guard_name: user.name,
            vacancy_id: user.vacancy_id,
            project: Array.isArray(user.project) ? user.project.join(', ') : user.project,
            location: user.location,
            region: user.region,
            city: user.city,
            created_at: new Date(checkinTime),
            checkout_at: checkoutTime ? new Date(checkoutTime) : null,
            status: status,
            notes: `سجل يدوي: ${notes}`,
            checkin_lat: 0,
            checkin_lon: 0,
            is_manual_entry: true,
            shift_snapshot: shiftSnapshot // <-- حفظ اللقطة مع السجل
        };

        const { error } = await supabaseClient.from('attendance').insert(recordData);
        if (error) throw error;

        showToast('تم إضافة السجل اليدوي بنجاح!', 'success');
        document.getElementById('manual-attendance-modal').classList.add('hidden');

        await supabaseClient.from('audit_logs').insert({ 
            user_name: currentUser.name, 
            action_type: 'إضافة سجل حضور يدوي', 
            details: { for_employee: user.name, check_in: checkinTime } 
        });

        if(document.querySelector('#page-attendance-management:not(.hidden)')) {
            loadAttendanceManagementPage();
        }

    } catch (error) {
        alert(`حدث خطأ أثناء حفظ السجل: ${error.message}`);
    } finally {
        saveManualAttendanceBtn.disabled = false;
        saveManualAttendanceBtn.textContent = 'حفظ السجل';
    }
}
const runEmployeeCheckBtn = event.target.closest('#run-employee-data-check-btn');
if (runEmployeeCheckBtn) {
    loadEmployeeDataIssuesReport();
}
const showUnlinkedReportBtn = event.target.closest('#show-unlinked-vacancies-report-btn');
if (showUnlinkedReportBtn) {
    loadUnlinkedVacanciesReport();
}
const deleteUnlinkedVacancyBtn = event.target.closest('.delete-unlinked-vacancy-btn');
if (deleteUnlinkedVacancyBtn) {
    const vacancyId = deleteUnlinkedVacancyBtn.dataset.id;
    const vacancyName = deleteUnlinkedVacancyBtn.dataset.name;
    if (confirm(`هل أنت متأكد من حذف هذا الشاغر الزائد نهائياً؟\n\n(${vacancyName})`)) {
        const { error } = await supabaseClient.from('job_vacancies').delete().eq('id', vacancyId);
        if (error) {
            alert('حدث خطأ أثناء الحذف.');
        } else {
            alert('تم حذف الشاغر بنجاح.');
            loadUnlinkedVacanciesReport(); // إعادة تحميل بيانات التقرير
            loadVacancyTabData(); // إعادة تحميل بيانات الصفحة الرئيسية لتحديث الإحصائيات
        }
    }
}
if (event.target.closest('#export-hr-log-btn')) {
    exportHrAttendanceLogToExcel();
}

const addPeriodBtn = event.target.closest('.add-period-btn');
if (addPeriodBtn) {
    const periodsContainer = addPeriodBtn.previousElementSibling;
    if (periodsContainer) { // التحقق من وجود الحاوية
        const newPeriodHtml = createPeriodHtml({}, 1); 
        periodsContainer.insertAdjacentHTML('beforeend', newPeriodHtml);
    }
    return; 
}

const deletePeriodBtn = event.target.closest('.delete-period-btn');
if (deletePeriodBtn) {
    const shiftCard = deletePeriodBtn.closest('.shift-entry-card');
    deletePeriodBtn.closest('.shift-period-item').remove();

    if(shiftCard) { // التحقق من وجود البطاقة
        const anyTimeInput = shiftCard.querySelector('.shift-time-input');
        if(anyTimeInput) {
            anyTimeInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
    return; 
}
const editAnnBtn = event.target.closest('.edit-announcement-btn');
if (editAnnBtn) {
    const annId = editAnnBtn.dataset.id;
    const { data, error } = await supabaseClient.from('announcements').select('*').eq('id', annId).single();
    
    if (data) {
        document.getElementById('announcement-id').value = data.id;
        document.getElementById('announcement-title').value = data.title || '';
        document.getElementById('announcement-content').value = data.content;
        document.getElementById('announcement-type').value = data.type;
        const toLocalISOString = (date) => {
            if (!date) return '';
            const d = new Date(date);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        };

        document.getElementById('announcement-start-date').value = toLocalISOString(data.start_date);
        document.getElementById('announcement-end-date').value = toLocalISOString(data.end_date);
        const targets = data.target_roles || ['all'];
        document.querySelectorAll('input[name="ann_target"]').forEach(cb => {
            cb.checked = targets.includes(cb.value);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        alert('حدث خطأ أثناء جلب بيانات الإعلان.');
        console.error(error);
    }
}
const deleteAnnBtn = event.target.closest('.delete-announcement-btn');
if (deleteAnnBtn) {
    if (confirm('هل أنت متأكد من حذف هذا الإعلان نهائياً؟')) {
        const annId = deleteAnnBtn.dataset.id;
        await supabaseClient.from('announcements').delete().eq('id', annId);
        loadAnnouncementsPage(); // تحديث القائمة
    }
}
const clearAnnFormBtn = event.target.closest('#clear-announcement-form');
if (clearAnnFormBtn) {
    document.querySelectorAll('input[name="ann_target"]').forEach(cb => {
        cb.checked = cb.value === 'all';
    });
    document.getElementById('announcement-form').reset();
    document.getElementById('announcement-id').value = '';
}
const exportVacanciesBtn = event.target.closest('#export-vacancies-btn');
if (exportVacanciesBtn) {
    exportVacanciesToExcel();
}
const viewOnMapBtn = event.target.closest('.view-on-map-btn');
if (viewOnMapBtn) {
    const guardId = viewOnMapBtn.dataset.guardId;
    window.zoomToGuardId = guardId;
    document.querySelector('a[data-page="page-geo"]').click();
}
const editAttendanceBtn = event.target.closest('.admin-edit-attendance-btn, .admin-manual-attendance-btn');
if (editAttendanceBtn) {
    let attendanceId = editAttendanceBtn.dataset.id; // نستخدم let ليمكن تغييرها
    const guardId = editAttendanceBtn.dataset.guardId;
    const guardName = editAttendanceBtn.dataset.name;

    const modal = document.getElementById('admin-edit-attendance-modal');
    document.getElementById('edit-attendance-title').textContent = `تعديل/تحضير: ${guardName}`;
    const toLocalISOString = (date) => {
        if (!date) return '';
        const d = new Date(date);
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 16);
    };
    document.getElementById('edit-attendance-id').value = '';
    document.getElementById('edit-attendance-status').value = 'حاضر';
    document.getElementById('edit-checkin-time').value = '';
    document.getElementById('edit-checkout-time').value = '';

    const checkinInput = document.getElementById('edit-checkin-time');
    checkinInput.dataset.guardId = guardId;
    checkinInput.dataset.guardName = guardName;
    const shiftDataString = editAttendanceBtn.dataset.shiftData; 
    if (shiftDataString) {
        checkinInput.dataset.shiftSnapshot = shiftDataString;
    } else {
        delete checkinInput.dataset.shiftSnapshot;
    }
    if (!attendanceId || attendanceId === 'undefined' || attendanceId === '') {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);

        const { data: existingRecord } = await supabaseClient
            .from('attendance')
            .select('id')
            .eq('guard_id', guardId)
            .gte('created_at', todayStart.toISOString())
            .order('created_at', { ascending: false }) // نأخذ الأحدث
            .limit(1)
            .single();

        if (existingRecord) {
            attendanceId = existingRecord.id; // وجدنا سجلاً! نستخدمه للتعديل
            console.log("تم العثور على سجل موجود، التحويل لوضع التعديل.");
        }
    }
    if (attendanceId && attendanceId !== 'undefined') {
        const { data: record, error } = await supabaseClient
            .from('attendance')
            .select('*')
            .eq('id', attendanceId)
            .single();

        if (!error && record) {
            document.getElementById('edit-attendance-id').value = record.id;
            document.getElementById('edit-attendance-status').value = record.status;

            if (record.created_at) {
                document.getElementById('edit-checkin-time').value = toLocalISOString(record.created_at);
            }
            if (record.checkout_at) {
                document.getElementById('edit-checkout-time').value = toLocalISOString(record.checkout_at);
            } else {
                 document.getElementById('edit-checkout-time').value = '';
            }
        }
    } 
        else {
            document.getElementById('edit-checkin-time').value = toLocalISOString(new Date());
        }
        const statusSelect = document.getElementById('edit-attendance-status');
        const checkoutGroup = document.getElementById('edit-checkout-time').closest('.form-group');
        const updateVisibility = () => {
            if (statusSelect.value === 'حاضر' || statusSelect.value === 'غياب') {
                checkoutGroup.classList.add('hidden');
                document.getElementById('edit-checkout-time').value = ''; // تصفير الوقت لمنع الخطأ
            } else {
                checkoutGroup.classList.remove('hidden');
            }
        };
        updateVisibility();
        statusSelect.onchange = updateVisibility;

        modal.classList.remove('hidden');
}
const saveAttendanceBtn = event.target.closest('#save-attendance-changes-btn');
if (saveAttendanceBtn) {
    const attendanceId = document.getElementById('edit-attendance-id').value;
    const checkinInput = document.getElementById('edit-checkin-time');
    const status = document.getElementById('edit-attendance-status').value;
    const checkinTime = checkinInput.value ? new Date(checkinInput.value) : new Date();
    const checkoutTimeInput = document.getElementById('edit-checkout-time').value;
    const checkoutTime = checkoutTimeInput ? new Date(checkoutTimeInput) : null;
    if (status === 'اكمل المناوبة' && !checkoutTime) {
        return alert('عفواً، يجب تحديد وقت الانصراف عند اختيار حالة "أكمل المناوبة".');
    }

    saveAttendanceBtn.disabled = true;
    saveAttendanceBtn.textContent = 'جاري الحفظ...';

    try {
        let actionType = '';

        if (attendanceId) {
            const { error } = await supabaseClient
                .from('attendance')
                .update({
                    status: status,
                    created_at: checkinTime,
                    checkout_at: checkoutTime,
                })
                .eq('id', attendanceId);
            if (error) throw error;
            actionType = 'تعديل سجل حضور';

        } else {
            const guardId = checkinInput.dataset.guardId;
            const guardName = checkinInput.dataset.guardName;
            let shiftSnapshot = null;
            if (checkinInput.dataset.shiftSnapshot) {
                shiftSnapshot = JSON.parse(checkinInput.dataset.shiftSnapshot);
            } else {
                const { data: user } = await supabaseClient.from('users').select('*, job_vacancies!users_vacancy_id_fkey(*)').eq('id', guardId).single();
                if (user) {
                    shiftSnapshot = {
                        project: user.job_vacancies?.project || user.project,
                        location: user.job_vacancies?.specific_location || user.location,
                        region: user.job_vacancies?.region || user.region,
                        city: user.job_vacancies?.location || user.city,
                        schedule_details: user.job_vacancies?.schedule_details || null
                    };
                }
            }

            const { error } = await supabaseClient.from('attendance').insert({
            guard_id: guardId,
            guard_name: guardName,
            status: status,
            created_at: checkinTime,
            checkout_at: checkoutTime,
            shift_snapshot: shiftSnapshot,
            is_manual_entry: true,
            notes: 'تسجيل يدوي من حضور الحراس',
            checkin_lat: 0,
            checkin_lon: 0
        });
            if (error) throw error;
            actionType = 'إنشاء سجل حضور يدوي';
        }
        await supabaseClient.from('audit_logs').insert({
            user_name: currentUser.name,
            action_type: actionType,
            details: { guard_id: checkinInput.dataset.guardId, status: status }
        });

        showToast('تم حفظ التغييرات بنجاح.', 'success');
        document.getElementById('admin-edit-attendance-modal').classList.add('hidden');
        if (document.querySelector('#page-guard-attendance:not(.hidden)')) loadGuardAttendancePage();
        if (document.querySelector('#page-attendance-management:not(.hidden)')) loadAttendanceManagementPage();

    } catch (error) {
        alert('حدث خطأ: ' + error.message);
    } finally {
        saveAttendanceBtn.disabled = false;
        saveAttendanceBtn.textContent = 'حفظ التعديلات';
    }
}
const adminResetPasswordBtn = event.target.closest('.admin-reset-password-btn');
if (adminResetPasswordBtn) {
    const authUserId = adminResetPasswordBtn.dataset.authId;
    const newPassword = prompt("الرجاء إدخال كلمة المرور الجديدة للمستخدم (6 أحرف على الأقل):");

    if (newPassword && newPassword.length >= 6) {
        if (confirm(`هل أنت متأكد من تغيير كلمة المرور؟`)) {
            adminResetPasswordBtn.disabled = true;

            const { data, error } = await supabaseClient.functions.invoke('update-employee-password', {
                body: { auth_id: authUserId, new_password: newPassword }
            });

            if (error || data.error) {
                showToast(error?.message || data.error, 'error');
            } else {
                showToast('تم تحديث كلمة المرور بنجاح!', 'success');
            }

            adminResetPasswordBtn.disabled = false;
        }
    } else if (newPassword) {
        alert('كلمة المرور قصيرة جدًا.');
    }
}
const loginAsBtn = event.target.closest('.admin-login-as-btn');
if (loginAsBtn) {
    const targetUserId = loginAsBtn.dataset.userId;
    const targetUserName = loginAsBtn.dataset.userName;
    if (confirm(`هل أنت متأكد من رغبتك في تسجيل الدخول بحساب "${targetUserName}"؟`)) {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            localStorage.setItem('admin_session', JSON.stringify(session));
            const { data, error } = await supabaseClient.functions.invoke('admin-impersonate', {
                body: { target_user_id: targetUserId }
            });

            if (error || data.error) throw new Error(error?.message || data.error);
            await supabaseClient.auth.setSession({
                access_token: data.access_token,
                refresh_token: session.refresh_token // يمكن استخدام نفس الرفرش توكن
            });
            location.reload();
        } catch (err) {
            alert(`فشل تسجيل الدخول: ${err.message}`);
        }
    }
}
const returnToAdminBtn = event.target.closest('#return-to-admin-btn');
if (returnToAdminBtn) {
    const adminSessionString = localStorage.getItem('admin_session');
    if (adminSessionString) {
        const adminSession = JSON.parse(adminSessionString);
        await supabaseClient.auth.setSession(adminSession);
        localStorage.removeItem('admin_session');
        location.reload();
    }
}
const adminAddUserBtn = event.target.closest('#admin-add-user-btn');
if (adminAddUserBtn) {
    document.getElementById('add-employee-btn').click();
}
const adminEditUserBtn = event.target.closest('.admin-edit-user-btn');
    if (adminEditUserBtn) {
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-employee-btn';
        editBtn.dataset.id = adminEditUserBtn.dataset.id;
        document.body.appendChild(editBtn); // إضافة الزر المؤقت للصفحة
        editBtn.click(); // الضغط عليه لتفعيل الأمر
        document.body.removeChild(editBtn); // حذف الزر المؤقت
    }
const adminDeleteUserBtn = event.target.closest('.admin-delete-user-btn');
    if (adminDeleteUserBtn) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-employee-btn';
        deleteBtn.dataset.id = adminDeleteUserBtn.dataset.id;
        deleteBtn.dataset.authId = adminDeleteUserBtn.dataset.authId;
        document.body.appendChild(deleteBtn); // إضافة الزر المؤقت للصفحة
        deleteBtn.click(); // الضغط عليه لتفعيل الأمر
        document.body.removeChild(deleteBtn); // حذف الزر المؤقت
    }
const adminArchiveUserBtn = event.target.closest('.admin-archive-user-btn');
if (adminArchiveUserBtn) {
    const userId = adminArchiveUserBtn.dataset.id;
    const userName = adminArchiveUserBtn.dataset.name;

    if (confirm(`هل أنت متأكد من أرشفة الموظف "${userName}"؟ سيتم تعطيل حسابه ونقله إلى الأرشيف.`)) {
        adminArchiveUserBtn.disabled = true;
        
        try {
            const { data: userToCheck } = await supabaseClient
                .from('users')
                .select('vacancy_id, job_vacancies(region, location)')
                .eq('id', userId)
                .single();
            if (userToCheck && userToCheck.job_vacancies) {
                await supabaseClient.from('users').update({
                    region: userToCheck.job_vacancies.region,
                    city: userToCheck.job_vacancies.location // في جدول الشواغر location تعني المدينة
                }).eq('id', userId);
            }
            const { data, error } = await supabaseClient.functions.invoke('archive-employee', {
                body: { user_id: parseInt(userId) },
            });

            if (error || (data && data.error)) {
                throw new Error(error?.message || data.error);
            }

           showToast(`تم أرشفة الموظف ${userName} وحفظ بيانات موقعه بنجاح.`, 'success');
            const activeDeptPage = document.querySelector('.page-content[data-department]:not(.hidden)');
            if (activeDeptPage) {
                loadDepartmentManagementPage(activeDeptPage.id);
            } else if (document.querySelector('#page-user-management:not(.hidden)')) {
                loadUserManagementPage();
            } else if (document.querySelector('#page-employees:not(.hidden)')) {
                loadEmployeeTabData();
            }

        } catch (err) {
            showToast(`فشلت الأرشفة: ${err.message}`, 'error');
            adminArchiveUserBtn.disabled = false;
        }
    }
}
const reactivateEmployeeBtn = event.target.closest('.reactivate-employee-btn');
if (reactivateEmployeeBtn) {
    const userId = reactivateEmployeeBtn.dataset.id;
    const authId = reactivateEmployeeBtn.dataset.authId;
    const userName = reactivateEmployeeBtn.dataset.name;

    if (confirm(`هل أنت متأكد من إعادة تفعيل الموظف "${userName}"؟ سيتمكن من تسجيل الدخول مجددًا وسيظهر في قوائم الموظفين النشطين.`)) {
        reactivateEmployeeBtn.disabled = true;
        reactivateEmployeeBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

        try {
            const { data, error } = await supabaseClient.functions.invoke('reactivate-employee', {
                body: { 
                    user_id: parseInt(userId), 
                    auth_id: authId 
                },
            });

            if (error || (data && data.error)) {
                throw new Error(error?.message || data.error);
            }

            showToast(`تمت إعادة تفعيل الموظف ${userName} بنجاح.`, 'success');
            loadEmployeeArchive(); // تحديث قائمة الأرشيف ليختفي منها الموظف

        } catch (err) {
            showToast(`فشلت عملية إعادة التفعيل: ${err.message}`, 'error');
            reactivateEmployeeBtn.disabled = false;
            reactivateEmployeeBtn.innerHTML = '<i class="ph-bold ph-arrow-counter-clockwise"></i> إعادة تفعيل';
        }
    }
}
const permissionCheckbox = event.target.closest('.permission-checkbox, .attendance-permission-checkbox, .contract-permission-checkbox, .vacancy-permission-checkbox');
if (permissionCheckbox) {
    const userId = permissionCheckbox.dataset.userId;
    const permission = permissionCheckbox.dataset.permission;
    const newState = permissionCheckbox.checked;
    const actionText = newState ? 'منح' : 'سحب';

    permissionCheckbox.disabled = true;

try {
    const { data: userToUpdate, error: fetchError } = await supabaseClient
        .from('users')
        .select('auth_user_id')
        .eq('id', userId)
        .single();

    if (fetchError) throw new Error(`لم يتم العثور على الموظف: ${fetchError.message}`);

    const { error: updateError } = await supabaseClient
        .from('users')
        .update({ [permission]: newState })
        .eq('id', userId);

    if (updateError) throw updateError;
    if (userToUpdate.auth_user_id) {
        await supabaseClient.functions.invoke('force-sign-out', {
            body: { auth_user_id: userToUpdate.auth_user_id }
        });
    }
    await supabaseClient.from('audit_logs').insert({
        user_name: currentUser.name,
        action_type: 'تغيير صلاحية',
        details: {
            target_user_id: userId,
            action: `${actionText} صلاحية (${permission})`
        }
    });

    showToast(`تم ${actionText} الصلاحية بنجاح. سيتم تسجيل خروج الموظف.`, 'success');

} catch (error) {
        console.error('Permission change error:', error);
        showToast('حدث خطأ أثناء تغيير الصلاحية.', 'error');
        permissionCheckbox.checked = !newState;
    } finally {
        permissionCheckbox.disabled = false;
    }
}
const contractPermissionCheckbox = event.target.closest('.contract-permission-checkbox');
if (contractPermissionCheckbox) {
    const userId = contractPermissionCheckbox.dataset.userId;
    const permission = contractPermissionCheckbox.dataset.permission; // 'can_edit_contracts' or 'can_delete_contracts'
    const newState = contractPermissionCheckbox.checked;
    const actionText = newState ? 'منح' : 'سحب';
    const permissionText = permission === 'can_edit_contracts' ? 'تعديل العقود' : 'حذف العقود';

    contractPermissionCheckbox.disabled = true;

    try {
        const { error } = await supabaseClient
            .from('users')
            .update({ [permission]: newState }) // تحديث العمود الصحيح ديناميكياً
            .eq('id', userId);

        if (error) throw error;

        await supabaseClient.from('audit_logs').insert({
            user_id: currentUser.auth_user_id,
            user_name: currentUser.name,
            action_type: 'تغيير صلاحية',
            details: {
                target_user_id: userId,
                action: `${actionText} صلاحية ${permissionText}`
            }
        });

        showToast(`تم ${actionText} صلاحية ${permissionText} بنجاح.`, 'success');

    } catch (error) {
        console.error('Contract permission change error:', error);
        showToast('حدث خطأ أثناء تغيير الصلاحية.', 'error');
        contractPermissionCheckbox.checked = !newState;
    } finally {
        contractPermissionCheckbox.disabled = false;
    }
}
const vacancyPermissionCheckbox = event.target.closest('.vacancy-permission-checkbox');
if (vacancyPermissionCheckbox) {
    const userId = vacancyPermissionCheckbox.dataset.userId;
    const permission = vacancyPermissionCheckbox.dataset.permission; // 'can_delete_vacancies'
    const newState = vacancyPermissionCheckbox.checked;
    const actionText = newState ? 'منح' : 'سحب';
    const permissionText = 'حذف الشواغر';

    vacancyPermissionCheckbox.disabled = true;

    try {
        const { error } = await supabaseClient
            .from('users')
            .update({ [permission]: newState })
            .eq('id', userId);

        if (error) throw error;

        await supabaseClient.from('audit_logs').insert({
            user_id: currentUser.auth_user_id,
            user_name: currentUser.name,
            action_type: 'تغيير صلاحية',
            details: {
                target_user_id: userId,
                action: `${actionText} صلاحية ${permissionText}`
            }
        });

        showToast(`تم ${actionText} صلاحية ${permissionText} بنجاح.`, 'success');

    } catch (error) {
        console.error('Vacancy permission change error:', error);
        showToast('حدث خطأ أثناء تغيير الصلاحية.', 'error');
        vacancyPermissionCheckbox.checked = !newState;
    } finally {
        vacancyPermissionCheckbox.disabled = false;
    }
}
const bellBtn = event.target.closest('#notification-bell-btn');
const notificationDropdown = document.getElementById('notification-dropdown');

if (bellBtn) {
    const isHidden = notificationDropdown.classList.contains('hidden');
    if (isHidden) {
        notificationDropdown.classList.remove('hidden');
        const content = document.getElementById('notification-list-content');
        content.innerHTML = '<p style="padding: 15px; text-align: center;">جاري التحميل...</p>';
        
        const { data, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .eq('user_id', currentUser.auth_user_id)
            .order('created_at', { ascending: false })
            .limit(10);
            
        if (error || data.length === 0) {
            content.innerHTML = '<p style="padding: 15px; text-align: center;">لا توجد إشعارات.</p>';
        } else {
            content.innerHTML = data.map(n => `
                <div class="notification-item" data-id="${n.id}">
                    <p>${n.title}</p>
                    <small>${new Date(n.created_at).toLocaleString('ar-SA')}</small>
                </div>
            `).join('');
        }
        document.getElementById('notification-count-badge').classList.add('hidden');
        await supabaseClient.from('notifications').update({ is_read: true }).eq('user_id', currentUser.auth_user_id);

    } else {
        notificationDropdown.classList.add('hidden');
    }
} else if (!event.target.closest('#notification-bell-container')) {
    notificationDropdown.classList.add('hidden');
}
if (event.target.closest('#open-feedback-modal-btn')) {
    document.getElementById('feedback-modal').classList.remove('hidden');
}
if (event.target.closest('#custom-alert-close-btn')) {
    document.getElementById('custom-alert-modal').classList.add('hidden');
}
const exportPendingBtn = event.target.closest('#export-pending-payments-btn');
if (exportPendingBtn) {
    if (pendingPaymentsData && pendingPaymentsData.length > 0) {
        const formattedData = pendingPaymentsData.map(p => ({
            "تاريخ الوردية": new Date(p.shift_date).toLocaleDateString('ar-SA'),
            "اسم المستلم": p.covering_guard_name,
            "الحارس الغائب": p.absent_guard_name || 'N/A',
            "المشروع": p.coverage_shifts?.project || 'غير محدد',
            "الموقع": p.coverage_shifts?.location || 'غير محدد',
            "مبلغ المستحق": p.payment_amount,
            "الآيبان": p.applicant_iban,
            "البنك": p.applicant_bank_name || '-'
        }));
        const filename = `مستحقات-بانتظار-الدفع-${new Date().toISOString().split('T')[0]}.xlsx`;
        exportPayrollToExcel(formattedData, filename); // استخدام نفس دالة التصدير
    } else {
        alert('لا توجد بيانات لتصديرها.');
    }
}
const exportAbsenteeBtn = event.target.closest('#export-absentee-report-btn');
if (exportAbsenteeBtn) {
    if (absenteeReportData && absenteeReportData.length > 0) {
        const filename = `تقرير-خصم-الغياب-${new Date().toISOString().split('T')[0]}.xlsx`;
        exportPayrollToExcel(absenteeReportData, filename);
    } else {
        alert('لا توجد بيانات لتصديرها.');
    }
}
    const rejectCoverageBtn = event.target.closest('.reject-coverage-assignment-btn');
    if (rejectCoverageBtn) {
        const shiftId = rejectCoverageBtn.dataset.shiftId;
        const applicantId = rejectCoverageBtn.dataset.applicantId;

        const reason = prompt('الرجاء كتابة سبب الاستبعاد:');
        if (!reason) return;

        try {
            await supabaseClient.from('coverage_shifts').update({ status: 'open' }).eq('id', shiftId);
            await supabaseClient.from('coverage_applicants').update({ status: 'rejected', rejection_reason: `تم الاستبعاد بواسطة العمليات: ${reason}` }).eq('id', applicantId);

            alert('تم استبعاد الموظف وإعادة فتح التغطية.');
            loadCoveragePage();

        } catch (error) {
            alert('حدث خطأ: ' + error.message);
        }
    }
const viewCoverageApplicantBtn = event.target.closest('.view-coverage-applicant-btn');
if (viewCoverageApplicantBtn) {
    const applicationId = viewCoverageApplicantBtn.dataset.appid;
    const modal = document.getElementById('applicant-details-modal');
    const body = document.getElementById('applicant-details-body');

    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري تحميل البيانات...</p>';

    try {
        const { data: application, error } = await supabaseClient
            .from('coverage_applicants')
            .select('*, users:users!coverage_applicants_applicant_user_id_fkey(*)')
            .eq('id', applicationId)
            .single();

        if (error || !application) throw new Error('خطأ في جلب بيانات المتقدم.');
        if (application.users) {
            const userData = application.users;
             body.innerHTML = `
                <div class="contract-display">
                    <h4>بيانات الموظف</h4>
                    <p><strong>الاسم:</strong> ${userData.name || ''}</p>
                    <p><strong>رقم الهوية:</strong> ${userData.id_number || ''}</p>
                    <p><strong>رقم الجوال:</strong> ${userData.phone || ''}</p>
                    <p><strong>اسم البنك:</strong> ${userData.bank_name || 'غير مسجل'}</p>
                    <p><strong>الآيبان:</strong> ${userData.iban || ''}</p>
                    <hr>
                    <h4>المرفقات</h4>
                    <p style="text-align:center; color: var(--text-secondary);">هذا موظف حالي، لا توجد مرفقات إضافية.</p>
                </div>
            `;
        } 
        else {
            let idPhotoUrl = "https://placehold.co/400x250/e2e8f0/a0aec0?text=لا+يوجد+مرفق";
            let ibanCertUrl = "https://placehold.co/400x250/e2e8f0/a0aec0?text=لا+يوجد+مرفق";

            if (application.id_photo_url && application.iban_certificate_url) {
                const { data: signedUrls } = await supabaseClient.storage.from('job-applications').createSignedUrls([application.id_photo_url, application.iban_certificate_url], 300);
                if (signedUrls) {
                    idPhotoUrl = signedUrls.find(u => u.path === application.id_photo_url)?.signedUrl || idPhotoUrl;
                    ibanCertUrl = signedUrls.find(u => u.path === application.iban_certificate_url)?.signedUrl || ibanCertUrl;
                }
            }

            body.innerHTML = `
                <div class="contract-display">
                    <h4>بيانات المتقدم</h4>
                    <p><strong>الاسم:</strong> ${application.full_name || ''}</p>
                    <p><strong>رقم الهوية:</strong> ${application.id_number || ''}</p>
                    <p><strong>رقم الجوال:</strong> ${application.phone_number || ''}</p>
                    <p><strong>اسم البنك:</strong> ${application.bank_name || 'غير مسجل'}</p>
                    <p><strong>الآيبان:</strong> ${application.iban || ''}</p>
                    <hr>
                    <h4>المرفقات (اضغط على الصورة للتكبير)</h4>
                    <div class="attachments-grid">
                        <div><h5>صورة الهوية</h5><img src="${idPhotoUrl}" alt="صورة الهوية" class="attachment-image viewable-image"></div>
                        <div><h5>شهادة الآيبان</h5><img src="${ibanCertUrl}" alt="شهادة الآيبان" class="attachment-image viewable-image"></div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        body.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
    const startAssignmentBtn = event.target.closest('#start-assignment-btn');
    if (startAssignmentBtn) {
        const selectedShiftItem = document.querySelector('.coverage-shift-item[style*="border-color: var(--accent-color)"]');
        if (!selectedShiftItem) return alert('الرجاء تحديد فرصة تغطية أولاً.');

        const shiftData = JSON.parse(selectedShiftItem.dataset.shiftId);
        document.getElementById('assignment-modal').classList.remove('hidden');
        populateAssignmentModal(shiftData);
    }
if (event.target.closest('#check-in-btn')) {
    const checkInBtn = event.target.closest('#check-in-btn');
    const attendanceStatus = document.getElementById('attendance-status');
    let isCheckinCancelled = false;

    const getLocation = (timeout) => new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true, timeout, maximumAge: 0
        });
    });

    const resetUI = () => {
        checkInBtn.disabled = false;
        checkInBtn.innerHTML = 'تسجيل حضور';
        attendanceStatus.innerHTML = `<p>حالتك الحالية: <strong>لم تسجل حضور بعد</strong></p>`;
    };

    const handleCancel = () => {
        isCheckinCancelled = true;
        showCustomAlert('تم الإلغاء', 'تم إلغاء عملية البحث عن الموقع.', 'info');
        resetUI();
    };
    (async () => {
        try {
            if (navigator.permissions) {
                const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                if (permissionStatus.state === 'denied') {
                    showLocationPermissionWarning(); // استدعاء دالة التعليمات
                    return; // توقف هنا
                }
            }

            const activeShift = JSON.parse(checkInBtn.dataset.activeShift);
            if (!activeShift || !activeShift.details.geofence_link) {
                throw new Error('لم يتم تحديد إحداثيات الموقع في العقد لهذه الوردية.');
            }

            const siteCoords = parseCoordinates(activeShift.details.geofence_link);
            const radius = activeShift.details.geofence_radius || 200;
            if (!siteCoords) throw new Error('إحداثيات موقع العمل غير صالحة.');

            checkInBtn.disabled = true;
            checkInBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري تحديد الموقع...';
            
            attendanceStatus.innerHTML = `
                <p style="color: var(--accent-color);">جاري البحث عن إشارة GPS دقيقة...</p>
                <p style="font-size: 0.9rem; color: var(--text-secondary);">الرجاء الانتظار في مكان مفتوح...</p>
                <button id="cancel-check-in-btn" class="btn btn-secondary btn-sm" style="margin-top: 10px;">إلغاء</button>
            `;
            document.getElementById('cancel-check-in-btn')?.addEventListener('click', handleCancel, { once: true });

            let checkinSuccessful = false;
            const MAX_ATTEMPTS = 5; // محاولات أقل لتسريع الاستجابة

            for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
                if (isCheckinCancelled) break;

                try {
                    const position = await getLocation(10000);
                    const accuracy = position.coords.accuracy;
                    const guardCoords = { lat: position.coords.latitude, lng: position.coords.longitude };
                    const distance = calculateDistance(siteCoords, guardCoords);
                    if ((accuracy < 100 && distance <= radius) || (attempt > 3 && distance <= radius)) {
                        const finalCheckTodayStart = new Date();
                        finalCheckTodayStart.setHours(0, 0, 0, 0);
                        const { data: finalCoverageCheck } = await supabaseClient
                            .from('coverage_shifts')
                            .select('id')
                            .eq('covered_user_id', currentUser.id)
                            .gte('created_at', finalCheckTodayStart.toISOString())
                            .in('status', ['open', 'pending_supervisor', 'pending_ops', 'closed']);

                        if (finalCoverageCheck && finalCoverageCheck.length > 0) {
                            throw new Error('لقد قام المشرف بطرح ورديتك للتغطية. لا يمكنك تسجيل الحضور.');
                        }
                        let periodNote = activeShift.type === 'coverage' ? 'تغطية وردية' : 'وردية أساسية';
                        if (activeShift.type === 'regular') {
                            const schedule = activeShift.snapshot.schedule_details[0];
                            const periods = schedule.periods || [schedule];
                        }
                        await supabaseClient.from('attendance').update({ status: 'انصراف تلقائي', checkout_at: new Date(), notes: 'إغلاق تلقائي' }).eq('guard_id', currentUser.id).is('checkout_at', null);
                        const { error: insertError } = await supabaseClient.from('attendance').insert({
                            guard_id: currentUser.id, guard_name: currentUser.name, vacancy_id: currentUser.vacancy_id,
                            project: activeShift.snapshot.project, location: activeShift.snapshot.location,
                            region: activeShift.snapshot.region, city: activeShift.snapshot.city,
                            checkin_lat: guardCoords.lat, checkin_lon: guardCoords.lng, status: 'حاضر',
                            shift_snapshot: activeShift.snapshot, notes: periodNote
                        });
                        
                        if (insertError) throw insertError;

                        showCustomAlert('نجاح', `تم تسجيل الحضور. (المسافة: ${Math.round(distance)}م)`, 'success');
                        loadAttendancePage();
                        checkinSuccessful = true;
                        break;
                    } else if (distance > radius && accuracy < 200) {
                        throw new Error(`أنت خارج نطاق الموقع بمسافة ${Math.round(distance - radius)} متر.`);
                    }
                } catch (geoError) {
                    if (geoError.code === 1) {
                        showLocationPermissionWarning(); // استدعاء التعليمات عند الرفض الفوري
                        isCheckinCancelled = true;
                        break;
                    }
                }
            }

            if (!checkinSuccessful && !isCheckinCancelled) {
                throw new Error("إشارة GPS ضعيفة. يرجى التحرك لمكان مكشوف والمحاولة مجدداً (تأكد انك متواجد في موقع العمل عن طريق زر موقع العمل).");
            }

        } catch (error) {
            if (!isCheckinCancelled) {
                showCustomAlert('تعذر تسجيل الحضور', error.message, 'error');
                resetUI();
            }
        }
    })();
}
const opsCoverageBtn = event.target.closest('.ops-coverage-action-btn');
if (opsCoverageBtn) {
    const applicantId = opsCoverageBtn.dataset.applicantId;
    const shiftId = opsCoverageBtn.dataset.shiftId;
    const action = opsCoverageBtn.dataset.action;

    opsCoverageBtn.disabled = true;

    try {
        if (action === 'approve_employee') {
            if (!confirm('هل أنت متأكد؟ سيتم تعيين هذا الموظف للتغطية كعمل إضافي.')) { opsCoverageActionBtn.disabled = false; return; }
            const { count: existingRecord } = await supabaseClient
                .from('overtime_records')
                .select('*', { count: 'exact', head: true })
                .eq('coverage_shift_id', shiftId);
                
            if (existingRecord > 0) {
                throw new Error('تم اعتماد هذه التغطية وصرف مستحقاتها مسبقاً.');
            }

            const { data: shift, error: e1 } = await supabaseClient.from('coverage_shifts').select('coverage_pay').eq('id', shiftId).single();
            const { data: applicant, error: e2 } = await supabaseClient.from('coverage_applicants').select('applicant_user_id, users(name)').eq('id', applicantId).single();
            if (e1 || e2) throw new Error('فشل جلب البيانات.');

            await supabaseClient.from('overtime_records').insert({
                employee_id: applicant.applicant_user_id,
                coverage_shift_id: shiftId,
                overtime_pay: shift.coverage_pay,
                approved_by: currentUser.id
            });
            
            await supabaseClient.from('coverage_applicants').update({ status: 'ops_final_approved' }).eq('id', applicantId);
            await supabaseClient.from('coverage_shifts').update({ status: 'closed' }).eq('id', shiftId);
            showToast('تم تعيين الموظف للتغطية بنجاح.', 'success');

            await updateOriginalAttendanceOnCoverage(shiftId, applicant.users.name);

        } else if (action === 'approve_external') {
            if (!confirm('هل أنت متأكد؟ سيتم إنشاء حساب مؤقت للمتقدم وإغلاق هذه التغطية.')) { opsCoverageBtn.disabled = false; return; }
            const { data: functionResponse, error } = await supabaseClient.functions.invoke('assign-coverage-guard', {
                body: { 
                    applicant_id: applicantId,
                    shift_id: shiftId 
                }
            });
        
            if (error || functionResponse.error) {
                throw new Error(error?.message || functionResponse.error);
            }
            const coveringGuardName = functionResponse.data.applicant_name;
            await updateOriginalAttendanceOnCoverage(shiftId, coveringGuardName);

            showToast('تم اعتماد المتقدم وتسكينه بنجاح. تم إغلاق التغطية.', 'success');

        } else if (action === 'reject') {
            const reason = prompt('الرجاء كتابة سبب الرفض:');
            if (reason) {
                await supabaseClient.from('coverage_applicants').update({ status: 'rejected', rejection_reason: reason }).eq('id', applicantId);
                showToast('تم رفض الطلب.', 'success');
            }
        }
        
        loadCoverageRequestsPage(); // إعادة تحميل الصفحة

    } catch (error) {
        showToast(`حدث خطأ: ${error.message}`, 'error');
    } finally {
        opsCoverageBtn.disabled = false;
    }
}
if (event.target.closest('.view-contract-btn')) {
    const contractId = event.target.closest('.view-contract-btn').dataset.id;
    const modal = document.getElementById('view-contract-modal');
    const body = document.getElementById('contract-view-body');
    const title = document.getElementById('view-contract-title');

    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري تحميل البيانات...</p>';

    const { data: contract, error } = await supabaseClient
        .from('contracts')
        .select('*')
        .eq('id', contractId)
        .single();

    if (error || !contract) {
        body.innerHTML = '<p style="color:red;">حدث خطأ في جلب بيانات العقد.</p>';
        return;
    }

    title.textContent = `تفاصيل عقد: ${contract.company_name}`;
    let detailsHtml = `
        <div class="contract-display">
            <h3>المعلومات الأساسية</h3>
            <p><strong>اسم المشروع:</strong> ${contract.company_name || 'غير محدد'}</p>
            <p><strong>تاريخ نهاية العقد:</strong> ${contract.end_date ? new Date(contract.end_date).toLocaleDateString('ar-SA') : 'غير محدد'}</p>

            <h3 style="margin-top: 25px;">ممثلين العقد</h3>
            <p><strong>الطرف الأول (اركانات):</strong> ${contract.party1_name || '-'} (${contract.party1_position || 'منصب غير محدد'}) - ${contract.party1_phone || '-'}</p>
            <p><strong>البريد الإلكتروني:</strong> ${contract.party1_email || '-'}</p>
            <p style="margin-top:10px;"><strong>الطرف الثاني (العميل):</strong> ${contract.party2_name || '-'} (${contract.party2_position || 'منصب غير محدد'}) - ${contract.party2_phone || '-'}</p>
            <p><strong>البريد الإلكتروني:</strong> ${contract.party2_email || '-'}</p>

            ${contract.commission_percentage ? `
                <h3 style="margin-top: 25px;">التفاصيل المالية</h3>
                <p><strong>نسبة العمولة:</strong> ${contract.commission_percentage}%</p>
            ` : ''}
            <hr>
            <h3>المواقع والورديات</h3>
        </div>
    `;

    if (contract.contract_locations && contract.contract_locations.length > 0) {
        detailsHtml += contract.contract_locations.map(location => {
            const shiftsHtml = (location.shifts || []).map(shift => {
                const dayMap = {Sun: 'الأحد', Mon: 'الاثنين', Tue: 'الثلاثاء', Wed: 'الأربعاء', Thu: 'الخميس', Fri: 'الجمعة', Sat: 'السبت'};
                const workDays = (shift.days || []).map(d => dayMap[d] || d).join('، ');
                const timeLabel = createShiftTimeLabel(shift);

                return `
                    <div class="shift-view-item">
                        <p><strong>الوردية:</strong> ${shift.name || 'بدون اسم'}</p>
                        <p><strong>عدد الحراس:</strong> ${shift.guards_count || 0}</p>
                        <p><strong>سعر الحارس:</strong> ${(shift.guard_price || 0).toLocaleString('en-US')} ر.س</p>
                        <p><strong>الوقت:</strong> ${timeLabel}</p>
                        <p><strong>أيام العمل:</strong> ${workDays || 'غير محددة'}</p>
                    </div>`;
            }).join('');

            return `
                <div class="location-view-group">
                    <h4><i class="ph-bold ph-map-pin-line"></i> موقع: ${location.name}</h4>
                    <p><strong>المنطقة:</strong> ${location.region || '-'} | <strong>المدينة:</strong> ${location.city || '-'}</p>
                    <p><strong>الدوريات:</strong> ${location.patrols_count || 0} (السعر: ${(location.patrols_price || 0).toLocaleString('en-US')} ر.س)</p>
                    <p><strong>المرافق:</strong> ${location.facilities_count || 0} (السعر: ${(location.facilities_price || 0).toLocaleString('en-US')} ر.س)</p>
                    <p><strong>الأجهزة:</strong> ${location.devices_count || 0} (السعر: ${(location.devices_price || 0).toLocaleString('en-US')} ر.س)</p>
                    ${location.terms ? `<p style="margin-top: 10px;"><strong>شروط خاصة بالموقع:</strong><br>${location.terms.replace(/\n/g, '<br>')}</p>` : ''}

                    <h5 style="margin-top:15px; margin-bottom:10px;">ورديات الموقع:</h5>
                    <div class="shifts-view-container">${shiftsHtml || '<p>لا توجد ورديات لهذا الموقع.</p>'}</div>
                </div>`;
        }).join('');
    } else {
        detailsHtml += '<p>لا توجد مواقع محددة في هذا العقد.</p>';
    }

    body.innerHTML = detailsHtml;
}

    if (event.target.closest('.edit-contract-btn')) {
        document.getElementById('contract-modal-search').value = ''; // تصفير البحث
    const contractId = event.target.closest('.edit-contract-btn').dataset.id;
    const { data: contract, error } = await supabaseClient.from('contracts').select('*').eq('id', contractId).single();

    if (error || !contract) { return alert('حدث خطأ في جلب بيانات العقد.'); }

    const modal = document.getElementById('contract-modal');
    const commissionGroup = document.getElementById('commission-group');
    const addCommissionBtn = document.getElementById('add-commission-btn');
    document.getElementById('contract-modal-title').textContent = 'تعديل العقد';
    document.getElementById('contract-id-hidden').value = contract.id;
    document.getElementById('contract-company-name').value = contract.company_name || '';
    document.getElementById('contract-end-date').value = contract.end_date || '';
    document.getElementById('contract-workdays-select').value = contract.work_days_policy || '6';
    document.getElementById('party1-name').value = contract.party1_name || '';
    document.getElementById('party1-phone').value = contract.party1_phone || '';
    document.getElementById('party1-position').value = contract.party1_position || '';
    document.getElementById('party1-email').value = contract.party1_email || '';
    document.getElementById('party2-name').value = contract.party2_name || '';
    document.getElementById('party2-phone').value = contract.party2_phone || '';
    document.getElementById('party2-position').value = contract.party2_position || '';
    document.getElementById('party2-email').value = contract.party2_email || '';

    if (contract.commission_percentage) {
        document.getElementById('commission-percentage').value = contract.commission_percentage;
        commissionGroup.classList.remove('hidden');
        addCommissionBtn.classList.add('hidden');
    } else {
        commissionGroup.classList.add('hidden');
        addCommissionBtn.classList.remove('hidden');
        document.getElementById('commission-percentage').value = '';
    }

    const locationsContainer = document.getElementById('locations-container');
    locationsContainer.innerHTML = '';

    if (contract.contract_locations && Array.isArray(contract.contract_locations)) {
        contract.contract_locations.forEach(locData => {
            const locationHtml = createLocationGroupHtml(locData);
            locationsContainer.insertAdjacentHTML('beforeend', locationHtml);
        });
    }

    modal.classList.remove('hidden');
    setTimeout(() => {
        const locationInputs = locationsContainer.querySelectorAll('.location-geofence-link');
        locationInputs.forEach((input, index) => {
            if (input.value.trim()) {
                setTimeout(() => {
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }, index * 1200); 
            }
        });
    }, 100);
}
if (event.target.closest('#add-location-from-input-btn')) {
    const input = document.getElementById('new-location-name-input');
    const locationName = input.value.trim();
    if (!locationName) return alert('الرجاء كتابة اسم الموقع أولاً.');

    const locationsContainer = document.getElementById('locations-container');
    const newLocationData = { name: locationName, shifts: [{}] }; 
    const newLocationHtml = createLocationGroupHtml(newLocationData); 

    locationsContainer.insertAdjacentHTML('beforeend', newLocationHtml);
    input.value = '';
}
    if (event.target.classList.contains('admin-staff-filter')) {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(loadAdminStaffData, 500);
    }
if (event.target.closest('#save-contract-btn')) {
    const saveBtn = event.target.closest('#save-contract-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'جاري التحقق والحفظ...';

    try {
        const contractId = document.getElementById('contract-id-hidden').value;
        const companyNameInput = document.getElementById('contract-company-name');
        const companyName = companyNameInput.value.trim(); 
        if (!companyName) throw new Error('اسم المشروع (العميل) مطلوب.');
        const usedLocationNames = new Set();

        const locationsData = Array.from(document.querySelectorAll('#locations-container .location-entry-card')).map(locCard => {
            const locationName = locCard.querySelector('.location-name-input').value.trim();
            
            if (!locationName) throw new Error('يوجد موقع بدون اسم. الرجاء تسمية جميع المواقع.');
            if (usedLocationNames.has(locationName.toLowerCase())) {
                throw new Error(`اسم الموقع "${locationName}" مكرر. يجب أن تكون أسماء المواقع فريدة داخل العقد.`);
            }
            usedLocationNames.add(locationName.toLowerCase());
            const usedShiftNames = new Set();

            const shifts = Array.from(locCard.querySelectorAll('.shift-entry-card')).map(shiftCard => {
                const shiftName = shiftCard.querySelector('.shift-name').value.trim();
                
                if (!shiftName) throw new Error(`يوجد وردية بدون اسم في الموقع "${locationName}".`);
                if (usedShiftNames.has(shiftName.toLowerCase())) {
                    throw new Error(`اسم الوردية "${shiftName}" مكرر في الموقع "${locationName}".`);
                }
                usedShiftNames.add(shiftName.toLowerCase());

                const defaultPeriods = Array.from(shiftCard.querySelectorAll('.default-periods .shift-period-item')).map(periodItem => {
                    const startTime = periodItem.querySelector('.shift-start-time').value;
                    const endTime = periodItem.querySelector('.shift-end-time').value;
                    if (!startTime || !endTime) return null;
                    if (startTime === endTime) {
                        throw new Error(`في الوردية "${shiftName}": وقت البداية والنهاية متطابقان (${startTime}). هذا غير مسموح.`);
                    }
                    return { start_time: startTime, end_time: endTime };
                }).filter(Boolean);

                if (defaultPeriods.length === 0) {
                }

                const days = Array.from(shiftCard.querySelectorAll('.days-selector input:checked')).map(input => input.value);
                const dayOverrides = {};
                const overrideCards = shiftCard.querySelectorAll('.day-override-card');
                overrideCards.forEach(overrideCard => {
                    const day = overrideCard.querySelector('.override-day-select').value;
                    if (day) {
                        const overridePeriods = Array.from(overrideCard.querySelectorAll('.override-periods .shift-period-item')).map(pItem => ({
                            start_time: pItem.querySelector('.shift-start-time').value,
                            end_time: pItem.querySelector('.shift-end-time').value,
                        })).filter(p => p.start_time && p.end_time);

                        if (overridePeriods.length > 0) {
                            dayOverrides[day] = { periods: overridePeriods };
                        }
                    }
                });

                return {
                    name: shiftName, // الاسم المنظف
                    guards_count: parseInt(shiftCard.querySelector('.shift-guards-count').value) || 0,
                    work_hours: parseFloat(shiftCard.querySelector('.shift-work-hours').value) || 0,
                    guard_price: parseFloat(shiftCard.querySelector('.shift-guard-price').value) || 0,
                    days: days,
                    periods: defaultPeriods,
                    day_overrides: Object.keys(dayOverrides).length > 0 ? dayOverrides : null
                };
            }).filter(Boolean);
            let geofenceLink = locCard.querySelector('.location-geofence-link')?.value.trim() || null;
            if (geofenceLink) geofenceLink = geofenceLink.replace(/\s/g, ''); // إزالة أي مسافة داخل الرابط

            return {
                name: locationName, // الاسم المنظف
                region: locCard.querySelector('.location-region-select')?.value || '',
                city: locCard.querySelector('.location-city-input')?.value.trim() || '',
                geofence_link: geofenceLink,
                geofence_radius: parseInt(locCard.querySelector('.location-geofence-radius')?.value, 10) || 200,
                patrols_count: parseInt(locCard.querySelector('.location-patrols-count').value) || 0,
                patrols_price: parseFloat(locCard.querySelector('.location-patrols-price').value) || 0,
                facilities_count: parseInt(locCard.querySelector('.location-facilities-count').value) || 0,
                facilities_price: parseFloat(locCard.querySelector('.location-facilities-price').value) || 0,
                devices_count: parseInt(locCard.querySelector('.location-devices-count').value) || 0,
                devices_price: parseFloat(locCard.querySelector('.location-devices-price').value) || 0,
                terms: locCard.querySelector('.location-terms').value.trim() || '',
                shifts: shifts
            };
        });

        const contractData = {
            company_name: companyName, // الاسم المنظف
            end_date: document.getElementById('contract-end-date').value || null,
            work_days_policy: document.getElementById('contract-workdays-select').value,
            party1_name: document.getElementById('party1-name').value.trim() || null,
            party1_phone: document.getElementById('party1-phone').value.trim() || null,
            party1_position: document.getElementById('party1-position').value.trim() || null,
            party1_email: document.getElementById('party1-email').value.trim() || null,
            party2_name: document.getElementById('party2-name').value.trim() || null,
            party2_phone: document.getElementById('party2-phone').value.trim() || null,
            party2_position: document.getElementById('party2-position').value.trim() || null,
            party2_email: document.getElementById('party2-email').value.trim() || null,
            
            commission_percentage: parseFloat(document.getElementById('commission-percentage').value) || null,
            contract_locations: locationsData,
            status: 'active'
        };

        const { error } = contractId
            ? await supabaseClient.from('contracts').update(contractData).eq('id', contractId)
            : await supabaseClient.from('contracts').insert([contractData]);

        if (error) throw error;

        showToast('تم حفظ العهد والبيانات بنجاح!', 'success');
        document.getElementById('contract-modal').classList.add('hidden');
        fetchContracts();

    } catch (error) {
        alert('⚠️ تنبيه: ' + error.message);
        console.error('Save Contract Error:', error);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'حفظ العقد';
    }
}
if (event.target.closest('.delete-location-card-btn')) {
    if (confirm('هل أنت متأكد من حذف هذا الموقع وكل وردياته؟')) {
        event.target.closest('.location-entry-card').remove();
    }
}
if (event.target.closest('.add-shift-to-card-btn')) {
    const shiftsContainer = event.target.previousElementSibling;
    const newShiftHtml = createShiftGroupHtml();
    shiftsContainer.insertAdjacentHTML('beforeend', newShiftHtml);
}
if (event.target.closest('.delete-shift-btn')) {
    event.target.closest('.shift-entry-card').remove();
}
if (event.target.closest('.delete-period-btn')) {
    event.target.closest('.shift-period-item').remove();
}
if (event.target.closest('#add-contract-btn')) {
    document.getElementById('contract-modal-search').value = ''; // تصفير البحث
        const modal = document.getElementById('contract-modal');
        document.getElementById('contract-modal-title').textContent = 'إضافة عقد جديد';
        document.getElementById('contract-id-hidden').value = '';
        document.getElementById('contract-company-name').value = '';
        document.getElementById('contract-end-date').value = '';
        document.getElementById('locations-container').innerHTML = '';
        document.getElementById('new-location-name-input').value = '';
        modal.classList.remove('hidden');
    }
if (event.target.closest('#add-city-btn')) {
    const cityInput = document.getElementById('contract-city-input');
    const cityName = cityInput.value.trim();
    if (cityName) {
        document.getElementById('contract-cities-tags').innerHTML += `<span class="tag-item">${cityName}<i class="ph-bold ph-x remove-tag"></i></span>`;
        cityInput.value = '';
    }
}
if (event.target.classList.contains('remove-tag')) {
    event.target.parentElement.remove();
}
if (event.target.classList.contains('region-tag')) {
    event.target.classList.toggle('selected');
}
if (event.target.closest('.delete-shift-btn')) {
    const shiftIndexToDelete = parseInt(event.target.closest('.delete-shift-btn').dataset.shiftIndex, 10);
    if (activeLocationIndex !== -1) {
        contractEditorState.locations[activeLocationIndex].shifts.splice(shiftIndexToDelete, 1);
        renderContractEditor();
    }
}
    const addHolidayBtn = event.target.closest('#add-holiday-btn');
    if (addHolidayBtn) {
        const holidayDate = document.getElementById('holiday-date').value;
        const description = document.getElementById('holiday-description').value;

        if (!holidayDate || !description) {
            return alert('الرجاء إدخال التاريخ والوصف للعطلة.');
        }

        addHolidayBtn.disabled = true;
        addHolidayBtn.textContent = 'جاري الإضافة...';

        const { error } = await supabaseClient.from('official_holidays').insert({ holiday_date: holidayDate, description: description });
        if (error) {
            alert('حدث خطأ أثناء إضافة العطلة. قد يكون هذا التاريخ مسجلاً من قبل.');
            console.error(error);
        } else {
            alert('تمت إضافة العطلة بنجاح.');
            document.getElementById('holiday-date').value = '';
            document.getElementById('holiday-description').value = '';
            loadHolidaysPage(); // تحديث القائمة
        }

        addHolidayBtn.disabled = false;
        addHolidayBtn.textContent = 'إضافة العطلة';
    }
    const deleteHolidayBtn = event.target.closest('.delete-holiday-btn');
    if (deleteHolidayBtn) {
        const holidayId = deleteHolidayBtn.dataset.id;
        if (confirm('هل أنت متأكد من حذف هذه العطلة الرسمية؟')) {
            const { error } = await supabaseClient.from('official_holidays').delete().eq('id', holidayId);
            if (error) {
                alert('حدث خطأ أثناء الحذف.');
            } else {
                alert('تم حذف العطلة.');
                loadHolidaysPage(); // تحديث القائمة
            }
        }
    }
const hrOpsTab = event.target.closest('#page-hr-ops-hiring .tab-link');
if (hrOpsTab) {
    if (hrOpsTab.dataset.tab === 'hr-new-reviews') {
        loadHrOpsHiringPage('new');
    } else if (hrOpsTab.dataset.tab === 'hr-archive-reviews') {
        loadHrOpsHiringPage('archive');
    }
}
const archiveTab = event.target.closest('#page-requests-archive .tab-link');
if (archiveTab) {
    event.preventDefault();
    const targetTabId = archiveTab.dataset.tab;
    document.querySelectorAll('#page-requests-archive .tab-link').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#page-requests-archive .tab-content').forEach(c => c.classList.remove('active'));
    archiveTab.classList.add('active');
    document.getElementById(targetTabId).classList.add('active');
    if (targetTabId === 'archive-leave-tab') loadArchivePage('leave');
    if (targetTabId === 'archive-loan-tab') loadArchivePage('loan');
    if (targetTabId === 'archive-resignation-tab') loadArchivePage('resignation');
}
    if (event.target.id === 'hr-attendance-search-btn') {
        const filters = {
            dateFrom: document.getElementById('hr-attendance-from').value,
            dateTo: document.getElementById('hr-attendance-to').value,
            status: document.getElementById('hr-attendance-status').value,
            project: document.getElementById('hr-attendance-project').value,
            location: document.getElementById('hr-attendance-location').value
        };
        if (filters.dateTo) {
            let toDate = new Date(filters.dateTo);
            toDate.setHours(23, 59, 59, 999);
            filters.dateTo = toDate.toISOString();
        }
        loadHrAttendanceLogPage(filters);
    }
        if (event.target.id === 'att-mgmt-search-btn') {
            const filters = {
                searchTerm: document.getElementById('att-mgmt-search-input').value,
                dateFrom: document.getElementById('att-mgmt-date-from').value,
                dateTo: document.getElementById('att-mgmt-date-to').value,
            };
            loadAttendanceManagementPage(filters);
        }
const attMgmtEditBtn = event.target.closest('.att-mgmt-edit-btn');
if (attMgmtEditBtn) {
    const recordId = attMgmtEditBtn.dataset.id;
    const guardName = attMgmtEditBtn.dataset.name;
    const modal = document.getElementById('admin-edit-attendance-modal');
    document.getElementById('edit-attendance-title').textContent = `تعديل سجل: ${guardName}`;
    document.getElementById('edit-attendance-id').value = '';
    document.getElementById('edit-attendance-status').value = 'حاضر';
    document.getElementById('edit-checkin-time').value = '';
    document.getElementById('edit-checkout-time').value = '';
    const toLocalISOString = (date) => {
        if (!date) return '';
        const d = new Date(date);
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 16);
    };
    const { data: record, error } = await supabaseClient
        .from('attendance')
        .select('*')
        .eq('id', recordId)
        .single();

    if (record) {
        document.getElementById('edit-attendance-id').value = record.id;
        document.getElementById('edit-attendance-status').value = record.status;
        document.getElementById('edit-checkin-time').value = toLocalISOString(record.created_at);
        document.getElementById('edit-checkout-time').value = toLocalISOString(record.checkout_at);
    } else {
        alert('لم يتم العثور على السجل. قد يكون قد تم حذفه.');
        return;
    }

    modal.classList.remove('hidden');
}
    const mapSearchBtn = event.target.closest('#map-search-btn');
    if (mapSearchBtn) {
        const searchTerm = document.getElementById('map-search-input').value.toLowerCase();
        if (!searchTerm) return;

        const foundGuard = allGuardsOnMap.find(g => g.name.toLowerCase().includes(searchTerm));
        
        if (foundGuard && guardMarkers.has(foundGuard.id)) {
            const marker = guardMarkers.get(foundGuard.id);
            map.setView(marker.getLatLng(), 16); // تقريب الخريطة على الحارس
            marker.openPopup(); // فتح النافذة المنبثقة
        } else {
            alert('لم يتم العثور على حارس بهذا الاسم.');
        }
    }
const sendToAllBtn = event.target.closest('#send-to-all-guards-btn');
if (sendToAllBtn) {
    if (currentlyDisplayedGuardIds.length === 0) {
        return alert('لا يوجد حراس ظاهرون في القائمة حالياً لإرسال توجيه لهم.');
    }

    const modal = document.getElementById('send-directive-modal');
    document.getElementById('send-directive-modal-title').textContent = `إرسال توجيه إلى ${currentlyDisplayedGuardIds.length} حارس (المفلترين)`;
    document.getElementById('directive-recipient-id').value = 'filtered';
    document.getElementById('directive-content').value = '';
    modal.classList.remove('hidden');
}
    const addHRPenaltyBtn = event.target.closest('.add-penalty-btn');
    if (addHRPenaltyBtn) {
        const modal = document.getElementById('add-penalty-modal');
        const userId = addHRPenaltyBtn.dataset.userId;
        const userName = addHRPenaltyBtn.dataset.userName;

        document.getElementById('penalty-modal-title').textContent = `إضافة عقوبة جديدة لـ: ${userName}`;
        document.getElementById('penalty-user-id').value = userId;
        document.getElementById('penalty-reason').value = '';
        document.getElementById('penalty-amount').value = '';
        document.getElementById('penalty-date').valueAsDate = new Date();
        modal.classList.remove('hidden');
    }

    const saveHRPenaltyBtn = event.target.closest('#save-penalty-btn');
    if (saveHRPenaltyBtn) {
        const penaltyData = {
            user_id: document.getElementById('penalty-user-id').value,
            reason: document.getElementById('penalty-reason').value,
            amount: parseFloat(document.getElementById('penalty-amount').value) || 0,
            deduction_date: document.getElementById('penalty-date').value
        };

        if (!penaltyData.reason || penaltyData.amount <= 0 || !penaltyData.deduction_date) {
            return alert('الرجاء تعبئة جميع الحقول بشكل صحيح.');
        }

        saveHRPenaltyBtn.disabled = true;
        saveHRPenaltyBtn.textContent = 'جاري الحفظ...';

        const { error } = await supabaseClient.from('penalties').insert(penaltyData);
        if (error) {
            alert('حدث خطأ أثناء حفظ العقوبة: ' + error.message);
        } else {
            alert('تم تسجيل العقوبة بنجاح!');
            document.getElementById('add-penalty-modal').classList.add('hidden');
        }
        
        saveHRPenaltyBtn.disabled = false;
        saveHRPenaltyBtn.textContent = 'حفظ وتطبيق الخصم';
    }
    const changePasswordBtn = event.target.closest('#change-password-btn');
    if (changePasswordBtn) {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;

        if (!newPassword || newPassword.length < 6) {
            return alert('كلمة المرور الجديدة يجب أن لا تقل عن 6 أحرف.');
        }
        if (newPassword !== confirmPassword) {
            return alert('كلمتا المرور غير متطابقتين.');
        }

        changePasswordBtn.disabled = true;
        changePasswordBtn.textContent = 'جاري التحديث...';

        try {
            const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
            if (error) throw error;
            alert('تم تحديث كلمة المرور بنجاح!');
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
        } catch (error) {
            alert(`حدث خطأ أثناء تحديث كلمة المرور: ${error.message}`);
        } finally {
            changePasswordBtn.disabled = false;
            changePasswordBtn.textContent = 'تحديث كلمة المرور';
        }
    }
const editCoverageBtn = event.target.closest('.edit-coverage-btn');
if (editCoverageBtn) {
    const shiftId = editCoverageBtn.dataset.shiftId;
    const { data: shift, error } = await supabaseClient.from('coverage_shifts').select('*').eq('id', shiftId).single();

    if (error || !shift) {
        return showToast('حدث خطأ في جلب بيانات التغطية.', 'error');
    }

    const modal = document.getElementById('create-coverage-modal');
    document.getElementById('coverage-edit-id').value = shift.id;
    document.getElementById('coverage-new-project').value = shift.project;
    document.getElementById('coverage-new-location').value = shift.location;
    document.getElementById('coverage-new-region').value = shift.region;
    document.getElementById('coverage-new-city').value = shift.city;
    document.getElementById('coverage-new-start-time').value = shift.start_time;
    document.getElementById('coverage-new-end-time').value = shift.end_time;
    document.getElementById('coverage-new-pay').value = shift.coverage_pay;
    document.getElementById('coverage-new-reason').value = shift.reason;
    
    const vacancySelect = document.getElementById('coverage-link-vacancy');
    vacancySelect.disabled = true; // لا يمكن تغيير الربط بعد الإنشاء
    vacancySelect.innerHTML = `<option value="">${shift.linked_vacancy_id ? 'مرتبطة بشاغر (لا يمكن التغيير)' : 'غير مرتبطة بشاغر'}</option>`;
    
    modal.classList.remove('hidden');
}
const deleteCoverageBtn = event.target.closest('.delete-coverage-btn');
if (deleteCoverageBtn) {
    const shiftId = deleteCoverageBtn.dataset.shiftId;
    if (confirm('هل أنت متأكد من حذف هذه التغطية بشكل نهائي؟ سيعود الاحتياج للظهور مرة أخرى إذا كان مرتبطاً بغياب أو نقص.')) {

        deleteCoverageBtn.disabled = true;

        const { error } = await supabaseClient.from('coverage_shifts').delete().eq('id', shiftId);

        if (error) {
            showToast('حدث خطأ أثناء الحذف.', 'error');
            deleteCoverageBtn.disabled = false;
        } else {
            showToast('تم حذف التغطية بنجاح.', 'success');
            loadCoverageKanbanPage(); 
        }
    }
}
const publishBtn = event.target.closest('.publish-coverage-btn');
if (publishBtn) {
    const needDataString = publishBtn.dataset.need;
    if (needDataString) {
        document.getElementById('save-published-coverage-btn')._originalCard = publishBtn.closest('.kanban-card');
        const originalCard = publishBtn.closest('.kanban-card');
        document.getElementById('save-published-coverage-btn')._originalCard = originalCard;

        document.getElementById('publish-need-data').value = needDataString;
        document.getElementById('publish-coverage-pay').value = '';
        document.getElementById('publish-coverage-modal').classList.remove('hidden');
    }
}
const savePublishedCoverageBtn = event.target.closest('#save-published-coverage-btn');
if (savePublishedCoverageBtn) {
    event.preventDefault();
    const saveBtn = savePublishedCoverageBtn;
    saveBtn.disabled = true;

    try {
        const need = JSON.parse(document.getElementById('publish-need-data').value);
        const pay = parseFloat(document.getElementById('publish-coverage-pay').value);

        if (!pay || pay <= 0) {
            throw new Error('الرجاء إدخال قيمة تغطية صحيحة.');
        }

        let cleanProjectName = need.project;
        if (Array.isArray(cleanProjectName)) {
            cleanProjectName = cleanProjectName.join('');
        } else if (typeof cleanProjectName === 'string') {
            cleanProjectName = cleanProjectName.replace(/[\[\]",]/g, '').trim();
        }

        const schedule = (need.schedule_details && need.schedule_details[0]) ? need.schedule_details[0] : {};
        const firstPeriod = schedule.periods ? schedule.periods[0] : schedule;

        const shiftData = {
            project: cleanProjectName,
            location: need.location,
            city: need.city,
            region: need.region,
            start_time: firstPeriod.start_time || null,
            end_time: firstPeriod.end_time || null,
            coverage_pay: pay,
            reason: need.absent_guard_id ? `غياب: ${need.absent_guard_name}` : (need.absent_guard_name || 'نقص قوى'),
            status: 'open',
            created_by: currentUser.id,
            covered_user_id: need.absent_guard_id || null,
            linked_vacancy_id: need.vacancy_id || null,
        };

        const { error } = await supabaseClient.from('coverage_shifts').insert(shiftData);
        if (error) throw error;

        showToast('تم طرح فرصة التغطية بنجاح.', 'success');
        document.getElementById('publish-coverage-modal').classList.add('hidden');
        if (saveBtn._originalCard) {
            saveBtn._originalCard.style.transition = 'opacity 0.5s, transform 0.5s';
            saveBtn._originalCard.style.opacity = '0';
            saveBtn._originalCard.style.transform = 'scale(0.9)';
            setTimeout(() => {
                saveBtn._originalCard.remove();
                delete saveBtn._originalCard; // تنظيف الذاكرة
            }, 500);
        }

        loadCoverageKanbanPage(); // تحديث اللوحة بالكامل من قاعدة البيانات

    } catch (error) {
        const errorMessage = error.details || error.message;
        alert(errorMessage);
        console.error("Save Coverage Error:", error);
    } finally {
        saveBtn.disabled = false;
    }
}
const reviewApplicantsBtn = event.target.closest('.review-applicants-btn');
if (reviewApplicantsBtn) {
    const shiftId = reviewApplicantsBtn.dataset.shiftId;
    const modal = document.getElementById('review-applicants-modal');
    const container = document.getElementById('review-applicants-list-container');

    modal.classList.remove('hidden');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل المتقدمين...</p>';

    const { data: applicants, error } = await supabaseClient
        .from('coverage_applicants')
        .select(`*, users:applicant_user_id(name)`)
        .eq('shift_id', shiftId)
        .order('created_at');

    if (error) {
        container.innerHTML = '<p style="color:red;">حدث خطأ في جلب البيانات.</p>';
    } else if (applicants.length === 0) {
        container.innerHTML = '<p style="text-align: center;">لا يوجد متقدمون حالياً.</p>';
    } else {
        container.innerHTML = `
            <div class="table-container" style="padding:0; box-shadow:none;">
                <table>
                    <thead><tr><th>الاسم</th><th>نوع المتقدم</th><th>الإجراء</th></tr></thead>
                    <tbody>
                        ${applicants.map(app => {
                            const applicantName = app.users ? app.users.name : app.full_name;
                            const applicantType = app.users ? 'موظف حالي (عمل إضافي)' : 'متقدم خارجي';

                            let actionButton = '';
                            if (currentUser.role === 'مشرف' && app.status === 'pending_supervisor') {
                                actionButton = `<button class="btn btn-primary btn-sm nominate-coverage-applicant-btn" data-appid="${app.id}" data-shiftid="${shiftId}">ترشيح</button>`;
                            } else if (currentUser.role === 'ادارة العمليات' && app.status === 'pending_ops') {
                                const actionType = app.users ? 'approve_employee' : 'approve_external';
                                actionButton = `<button class="btn btn-success btn-sm ops-coverage-action-btn" data-action="${actionType}" data-applicant-id="${app.id}" data-shift-id="${shiftId}">اعتماد مباشر</button>`;
                            } else {
                                actionButton = `<span class="status pending">${app.status}</span>`;
                            }

                            return `
                                <tr>
                                    <td>${applicantName}</td>
                                    <td><span class="status ${app.users ? 'pending' : 'active'}">${applicantType}</span></td>
                                    <td>
                                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                            <button class="btn btn-secondary btn-sm view-coverage-applicant-btn" data-appid="${app.id}" title="عرض التفاصيل"><i class="ph-bold ph-eye"></i></button>
                                            ${actionButton}
                                        </div>
                                    </td>
                                </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
}
const nominateCoverageBtn = event.target.closest('.nominate-coverage-applicant-btn');
if (nominateCoverageBtn) {
    const applicationId = nominateCoverageBtn.dataset.appid;
    const shiftId = nominateCoverageBtn.dataset.shiftid;

    if (!confirm('هل أنت متأكد من ترشيح هذا المتقدم؟ سيتم إرسال طلبه لمدير العمليات.')) return;

    nominateCoverageBtn.disabled = true;
    nominateCoverageBtn.textContent = 'جاري...';

    try {
        const { error: e1 } = await supabaseClient.from('coverage_applicants')
            .update({ status: 'pending_ops', supervisor_approver_id: currentUser.id })
            .eq('id', applicationId);
        if (e1) throw e1;
        await supabaseClient.from('coverage_shifts').update({ status: 'pending_ops' }).eq('id', shiftId);
        await supabaseClient.from('coverage_applicants')
            .update({ status: 'not_nominated' })
            .eq('shift_id', shiftId)
            .not('id', 'eq', applicationId);

        showToast('تم ترشيح المتقدم بنجاح.', 'success');
        document.getElementById('review-applicants-modal').classList.add('hidden');
        loadCoverageKanbanPage(); // تحديث اللوحة

    } catch (error) {
        showToast('حدث خطأ أثناء عملية الترشيح: ' + error.message, 'error');
    } finally {
        nominateCoverageBtn.disabled = false;
        nominateCoverageBtn.textContent = 'ترشيح';
    }
}
const enableNotificationsBtn = event.target.closest('#enable-notifications-btn');
if (enableNotificationsBtn) {
    enableNotificationsBtn.disabled = true;
    setupPushNotifications(enableNotificationsBtn); // استدعاء الدالة الجديدة
}
const forgotPasswordLink = event.target.closest('#forgot-password-link');
if (forgotPasswordLink) {
    event.preventDefault();
    const modal = document.getElementById('forgot-password-modal');
    if (modal) {
        modal.querySelector('#otp-step').classList.remove('hidden');
        modal.querySelector('#reset-step').classList.add('hidden');
        modal.querySelector('#send-otp-btn').classList.remove('hidden');
        modal.querySelector('#reset-password-btn').classList.add('hidden');
        modal.querySelector('form').reset();

        modal.classList.remove('hidden');
    }
    return; // توقيف التنفيذ هنا
}
const togglePasswordBtn = event.target.closest('.toggle-password');
if (togglePasswordBtn) {
    const passwordInput = togglePasswordBtn.previousElementSibling;
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        togglePasswordBtn.classList.remove('ph-eye-slash');
        togglePasswordBtn.classList.add('ph-eye');
    } else {
        passwordInput.type = 'password';
        togglePasswordBtn.classList.remove('ph-eye');
        togglePasswordBtn.classList.add('ph-eye-slash');
    }
    return;
}
const menuToggleBtn = event.target.closest('#menu-toggle-btn');
if (menuToggleBtn) {
    document.querySelector('.sidebar').classList.toggle('open');
}
    const clearTimeFilterBtn = event.target.closest('#ga-clear-time-filter');
    if (clearTimeFilterBtn) {
        document.getElementById('ga-filter-time-from').value = '';
        document.getElementById('ga-filter-time-to').value = '';
        loadGuardAttendancePage(); // إعادة تحميل البيانات بعد مسح الفلتر
    }
const swapBtn = event.target.closest('.swap-assignment-btn');
if (swapBtn) {
    const modal = document.getElementById('swap-employee-modal');
    const vacancyId = swapBtn.dataset.vacancyId;
    const currentUserId = swapBtn.dataset.currentUserId;
    const currentUserName = swapBtn.dataset.currentUserName;
    document.getElementById('swap-vacancy-id').value = vacancyId;
    document.getElementById('swap-current-user-id').value = currentUserId;
    document.getElementById('swap-current-user-name').value = currentUserName;
    const employeeSelect = document.getElementById('swap-new-employee-select');
    employeeSelect.innerHTML = '<option value="">جاري تحميل الموظفين...</option>';
    const { data: employees, error } = await supabaseClient
        .from('users')
        .select('id, name')
        .eq('employment_status', 'نشط')
        .eq('role', 'حارس أمن')
        .not('id', 'eq', currentUserId);

    if (error) {
        employeeSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
    } else {
        employeeSelect.innerHTML = '<option value="">-- اختر موظفاً بديلاً --</option>';
        employeeSelect.innerHTML += employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
    }
    
    modal.classList.remove('hidden');
}
const saveSwapBtn = event.target.closest('#save-swap-btn');
if (saveSwapBtn) {
    const vacancy_A_Id = document.getElementById('swap-vacancy-id').value;
    const employee_A_Id = document.getElementById('swap-current-user-id').value;
    const employee_B_Id = document.getElementById('swap-new-employee-select').value;

    if (!employee_B_Id) return alert('الرجاء اختيار الموظف البديل.');

    saveSwapBtn.disabled = true;
    saveSwapBtn.textContent = 'جاري التبديل...';

    try {
        const { data: employeeB_Data, error: e1 } = await supabaseClient
            .from('users').select('vacancy_id').eq('id', employee_B_Id).single();
        if (e1) throw e1;
        const vacancy_B_Id = employeeB_Data.vacancy_id; // قد يكون null
        const { error: e2 } = await supabaseClient
            .from('users').update({ vacancy_id: vacancy_B_Id }).eq('id', employee_A_Id);
        if (e2) throw e2;
        const { error: e3 } = await supabaseClient
            .from('users').update({ vacancy_id: vacancy_A_Id }).eq('id', employee_B_Id);
        if (e3) throw e3;

        alert('تم تبديل الموظفين بنجاح.');
        document.getElementById('swap-employee-modal').classList.add('hidden');
        loadVacancyTabData(); // تحديث القائمة

    } catch (error) {
        alert('حدث خطأ أثناء عملية التبديل: ' + error.message);
    } finally {
        saveSwapBtn.disabled = false;
        saveSwapBtn.textContent = 'حفظ التبديل';
    }
}
const finalApproveBtn = event.target.closest('#final-approve-btn');
if (finalApproveBtn) {
    event.preventDefault();
    const submitBtn = finalApproveBtn;
    
    if (!confirm("هل أنت متأكد من اعتماد هذا المرشح؟ سيتم إنشاء حساب له وربطه بالشاغر.")) {
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري التوظيف...';

    const applicationId = document.getElementById('review-app-id').value;
    const vacancyId = document.getElementById('review-vacancy-id').value;

    try {
        const password = document.getElementById('review-password').value;
        const profileData = {
        name: document.getElementById('review-full-name').value,
        id_number: document.getElementById('review-id-number').value,
        phone: document.getElementById('review-phone').value,
        iban: document.getElementById('review-iban').value,
        bank_name: document.getElementById('review-bank-name').value,
        vacancy_id: vacancyId,
        start_of_work_date: new Date().toISOString().split('T')[0],
        employment_status: 'اساسي', // <-- ✨ السطر الجديد والمهم ✨
        status: 'active',
        insurance_status: 'غير مسجل'
    };

        const { data: vacancy } = await supabaseClient
            .from('job_vacancies').select('title, project, specific_location, contract_id, region, location')
            .eq('id', vacancyId).single();

       profileData.role = 'حارس أمن'; // <-- الإصلاح الأول: تعيين الدور بشكل ثابت وصحيح
        profileData.contract_id = vacancy.contract_id;
        profileData.project = [vacancy.project];
        profileData.location = vacancy.specific_location; // هذا هو الموقع الدقيق
        profileData.region = vacancy.region; // <-- الإصلاح الثاني: إضافة المنطقة من الشاغر
        profileData.city = vacancy.location
        console.log('Sending this data to function:', profileData);
        const { data: functionResponse, error: invokeError } = await supabaseClient.functions.invoke('create-employee', { body: { password, ...profileData } });

        if (invokeError) throw new Error(`فشل استدعاء الدالة: ${invokeError.message}`);
        if (functionResponse.error) throw new Error(functionResponse.error);

        const newUserId = functionResponse.data.id;
        if (!newUserId) throw new Error("لم يتم استلام ID الموظف الجديد من السيرفر.");
        await supabaseClient.from('job_vacancies').update({ status: 'closed' }).eq('id', vacancyId);
        await supabaseClient.from('job_applications').update({ status: 'approved', ops_approver_id: currentUser.id }).eq('id', applicationId);

        alert(`اكتملت العملية بنجاح!`);
        
        document.getElementById('ops-review-applicant-modal').classList.add('hidden');
        loadOpsNomineesPage();
        loadVacancyTabData();
        loadEmployeeTabData();

    } catch(error) {
        alert('حدث خطأ: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="ph-bold ph-user-plus"></i> اعتماد نهائي وتوظيف';
    }
}
const viewNewHireBtn = event.target.closest('.view-new-hire-details-btn');
if (viewNewHireBtn) {
    viewNewHireBtn.classList.add('view-applicant-details-btn');
    viewNewHireBtn.click();
    viewNewHireBtn.classList.remove('view-applicant-details-btn');
}
const hrAcknowledgeBtn = event.target.closest('.hr-acknowledge-hire-btn');
if (hrAcknowledgeBtn) {
    const applicationId = hrAcknowledgeBtn.dataset.appid;
    if (confirm('هل أنت متأكد من مراجعة هذا التوظيف؟')) {
        const { error } = await supabaseClient.from('job_applications').update({ status: 'hr_acknowledged' }).eq('id', applicationId);
        if (error) { alert('حدث خطأ'); } else { alert('تم تأكيد المراجعة.'); loadHrOpsHiringPage(); }
    }
}
const opsReviewBtn = event.target.closest('.ops-review-applicant-btn');
if (opsReviewBtn) {
    const applicationId = opsReviewBtn.dataset.appid;
    const modal = document.getElementById('ops-review-applicant-modal');
    const formBody = document.getElementById('ops-review-form-body');
    
    modal.classList.remove('hidden');
    formBody.innerHTML = '<p style="text-align: center;">جاري تحميل بيانات المرشح...</p>';

    const { data: application, error } = await supabaseClient
        .from('job_applications')
        .select('*, job_vacancies(*)')
        .eq('id', applicationId)
        .single();
    
    if (error || !application) {
        formBody.innerHTML = '<p style="color:red;">خطأ في جلب البيانات.</p>';
        return;
    }

    document.getElementById('review-app-id').value = application.id;
    document.getElementById('review-vacancy-id').value = application.vacancy_id;

    const appData = application.applicant_data;
    const vacancy = application.job_vacancies;
const shift = vacancy.schedule_details?.[0]; // <-- جلب تفاصيل الوردية

    const signedUrlsToGenerate = [];
    if (application.id_photo_url) signedUrlsToGenerate.push(application.id_photo_url);
    if (application.iban_certificate_url) signedUrlsToGenerate.push(application.iban_certificate_url);
    let idPhotoUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 150 100'%3E%3Crect width='150' height='100' fill='%23f0f2f5'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Cairo, sans-serif' font-size='12' fill='%23a0aec0'%3Eلا يوجد مرفق%3C/text%3E%3C/svg%3E";
    let ibanCertUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 150 100'%3E%3Crect width='150' height='100' fill='%23f0f2f5'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Cairo, sans-serif' font-size='12' fill='%23a0aec0'%3Eلا يوجد مرفق%3C/text%3E%3C/svg%3E";

    if (signedUrlsToGenerate.length > 0) {
        const { data: signedUrls, error: urlError } = await supabaseClient
            .storage.from('job-applications').createSignedUrls(signedUrlsToGenerate, 300);
        if (!urlError) {
            idPhotoUrl = signedUrls.find(u => u.path === application.id_photo_url)?.signedUrl || idPhotoUrl;
            ibanCertUrl = signedUrls.find(u => u.path === application.iban_certificate_url)?.signedUrl || ibanCertUrl;
        }
    }

    formBody.innerHTML = `
        <h4>1. المعلومات الشخصية (قابلة للتعديل)</h4>
        <div class="form-grid">
            <div class="form-group"><label>الاسم الكامل</label><input type="text" id="review-full-name" value="${appData.full_name || ''}"></div>
            <div class="form-group"><label>رقم الهوية</label><input type="text" id="review-id-number" value="${appData.id_number || ''}"></div>
            <div class="form-group"><label>رقم الجوال</label><input type="tel" id="review-phone" value="${appData.phone || ''}"></div>
            <div class="form-group"><label>اسم البنك</label><input type="text" id="review-bank-name" value="${appData.bank_name || ''}"></div>
        </div>
        <div class="form-group" style="margin-top:20px;">
            <label>رقم الآيبان</label><input type="text" id="review-iban" value="${appData.iban || ''}">
        </div>
        <hr>
        <h4>2. المرفقات (اضغط على الصورة للتكبير)</h4>
        <div class="attachments-grid">
            <div>
                <h5>صورة الهوية</h5>
                <img src="${idPhotoUrl}" alt="صورة الهوية" class="attachment-image viewable-image">
            </div>
            <div>
                <h5>شهادة الآيبان</h5>
                <img src="${ibanCertUrl}" alt="شهادة الآيبان" class="attachment-image viewable-image">
            </div>
        </div>
        <hr>
        <h4>3. معلومات التوظيف (للتأكيد)</h4>
        <div class="form-grid">
            <div class="form-group"><label>المسمى الوظيفي</label><input type="text" id="review-title" value="${vacancy.title}" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label>المشروع</label><input type="text" id="review-project" value="${vacancy.project}" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label>الموقع</label><input type="text" id="review-location" value="${vacancy.specific_location}" readonly style="background-color: #e9ecef;"></div>
        </div>
        <div class="form-group" style="margin-top:20px;">
            <label>الوردية المحددة</label>
            <input type="text" value="${shift ? `${shift.name || 'وردية'} ${createShiftTimeLabel(shift)}` : 'غير محددة'}" readonly style="background-color: #e9ecef; text-align: center; font-weight: bold;">
        </div>
        <hr>
        <h4>4. كلمة المرور</h4>
        <div class="form-group"><label>كلمة مرور مؤقتة</label><input type="text" id="review-password" value="${appData.id_number}"></div>
    `;
}
const opsRejectBtn = event.target.closest('.ops-reject-applicant-btn');
if (opsRejectBtn) {
    const applicationId = opsRejectBtn.dataset.appid;
    const vacancyId = opsRejectBtn.dataset.vid;

    const reason = prompt("الرجاء إدخال سبب الرفض (سيظهر للمشرف):");
    if (!reason) return;

    if (confirm('هل أنت متأكد من رفض هذا المرشح؟ سيتم إعادة فتح باب الترشيح للمشرف.')) {
        try {
            const { error } = await supabaseClient.rpc('reject_nominee', {
                application_id_to_reject: applicationId,
                related_vacancy_id: vacancyId,
                rejection_reason_text: reason
            });

            if (error) throw error;

            showToast('تم رفض المرشح بنجاح.', 'success');
            opsRejectBtn.closest('.review-request-card').remove();

        } catch (error) {
            alert('حدث خطأ: ' + error.message);
        }
    }
}
const viewApplicantBtn = event.target.closest('.view-applicant-details-btn');
if (viewApplicantBtn) {
    const applicationId = viewApplicantBtn.dataset.appid;
    const modal = document.getElementById('applicant-details-modal');
    const body = document.getElementById('applicant-details-body');
    
    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري تحميل البيانات...</p>';

    try {
        const { data: application, error } = await supabaseClient
            .from('job_applications')
            .select('*')
            .eq('id', applicationId)
            .single();
        if (error || !application) throw new Error('خطأ في جلب بيانات المتقدم.');

        const signedUrlsToGenerate = [];
        if (application.id_photo_url) signedUrlsToGenerate.push(application.id_photo_url);
        if (application.iban_certificate_url) signedUrlsToGenerate.push(application.iban_certificate_url);
        let idPhotoUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 150 100'%3E%3Crect width='150' height='100' fill='%23f0f2f5'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Cairo, sans-serif' font-size='12' fill='%23a0aec0'%3Eلا يوجد مرفق%3C/text%3E%3C/svg%3E";
        let ibanCertUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 150 100'%3E%3Crect width='150' height='100' fill='%23f0f2f5'/%3E%3Ctext x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Cairo, sans-serif' font-size='12' fill='%23a0aec0'%3Eلا يوجد مرفق%3C/text%3E%3C/svg%3E";

        if (signedUrlsToGenerate.length > 0) {
            const { data: signedUrls, error: urlError } = await supabaseClient
                .storage.from('job-applications').createSignedUrls(signedUrlsToGenerate, 300);
            if (!urlError) {
                idPhotoUrl = signedUrls.find(u => u.path === application.id_photo_url)?.signedUrl || idPhotoUrl;
                ibanCertUrl = signedUrls.find(u => u.path === application.iban_certificate_url)?.signedUrl || ibanCertUrl;
            }
        }
        
        const appData = application.applicant_data;
        body.innerHTML = `
            <div class="contract-display">
                <h4>بيانات المتقدم</h4>
                <p><strong>الاسم:</strong> ${appData.full_name || ''}</p>
                <p><strong>رقم الهوية:</strong> ${appData.id_number || ''}</p>
                <p><strong>رقم الجوال:</strong> ${appData.phone || ''}</p>
                <p><strong>اسم البنك:</strong> ${appData.bank_name || 'غير مسجل'}</p>
                <p><strong>الآيبان:</strong> ${appData.iban || ''}</p>
                <hr>
                <h4>المرفقات (اضغط على الصورة للتكبير)</h4>
                <div class="attachments-grid">
                    <div>
                        <h5>صورة الهوية</h5>
                        <img src="${idPhotoUrl}" alt="صورة الهوية" class="attachment-image viewable-image">
                    </div>
                    <div>
                        <h5>شهادة الآيبان</h5>
                        <img src="${ibanCertUrl}" alt="شهادة الآيبان" class="attachment-image viewable-image">
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        body.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
const nominateBtn = event.target.closest('.nominate-applicant-btn');
if (nominateBtn) {
    const applicationId = nominateBtn.dataset.appid;
    const vacancyId = nominateBtn.dataset.vid;

    if (!confirm('هل أنت متأكد من ترشيح هذا المتقدم؟ سيتم إخفاء باقي المتقدمين وإرسال هذا الطلب لمدير العمليات.')) {
        return;
    }

    nominateBtn.disabled = true;
    nominateBtn.textContent = 'جاري...';

    try {
        const { error: e1 } = await supabaseClient
            .from('job_applications')
            .update({ status: 'pending_ops', supervisor_approver_id: currentUser.id })
            .eq('id', applicationId);
        if (e1) throw e1;
        const { error: e2 } = await supabaseClient
            .from('job_applications')
            .update({ status: 'not_nominated' })
            .eq('vacancy_id', vacancyId)
            .not('id', 'eq', applicationId); // كل الطلبات ما عدا الطلب المرشح
        if (e2) console.warn("Could not update other applicants:", e2);

        alert('تم ترشيح المتقدم بنجاح!');
        loadSupervisorApplicationsPage(); // إعادة تحميل الصفحة لإخفاء المجموعة

    } catch (error) {
        alert('حدث خطأ أثناء عملية الترشيح: ' + error.message);
        console.error('Nomination Error:', error);
    } finally {
        nominateBtn.disabled = false;
        nominateBtn.textContent = 'ترشيح';
    }
}

const supervisorPermissionBtn = event.target.closest('.supervisor-permission-action-btn');
if (supervisorPermissionBtn) {
    event.stopPropagation();
    const requestId = supervisorPermissionBtn.dataset.requestId;
    const action = supervisorPermissionBtn.dataset.action;
    let updateData = {};
    supervisorPermissionBtn.disabled = true;

    try {
        if (action === 'approve') {
            if (!confirm('هل أنت متأكد من الموافقة ورفع الطلب للعمليات؟')) {
                supervisorPermissionBtn.disabled = false; return;
            }
            updateData = { 
                status: 'بانتظار موافقة العمليات', 
                supervisor_approver_id: currentUser.id 
            };
            const { data: requestDetails } = await supabaseClient.from('employee_requests').select('users:user_id(name)').eq('id', requestId).single();
            const { data: opsManagers, error: opsError } = await supabaseClient
                .from('users')
                .select('id')
                .eq('role', 'ادارة العمليات')
                .eq('region', currentUser.region);

            if (!opsError && opsManagers) {
                const opsIds = opsManagers.map(ops => ops.id);
                sendNotification(
                    opsIds,
                    'طلب استئذان بانتظار المراجعة',
                    `تم رفع طلب استئذان من الموظف ${requestDetails.users.name} وهو بانتظار موافقتك.`,
                    '#'
                );
            }

        } else {
            const reason = prompt('الرجاء كتابة سبب الرفض:');
            if (!reason) { supervisorPermissionBtn.disabled = false; return; }
            updateData = { 
                status: 'مرفوض', 
                rejection_reason: reason,
                supervisor_approver_id: currentUser.id
            };
        }

        const { error } = await supabaseClient.from('employee_requests').update(updateData).eq('id', requestId);
        if (error) throw error;

        alert('تم تحديث الطلب بنجاح.');
        loadSupervisorPermissionRequestsPage();

    } catch(error) {
        alert('حدث خطأ أثناء تحديث الطلب.');
        console.error(error);
    } finally {
        supervisorPermissionBtn.disabled = false;
    }
    return;
}
if (event.target.closest('.modal-close-btn')) {
    const modal = event.target.closest('.modal-overlay');
    if (modal.id === 'employee-modal') {
        const assignmentGroup = modal.querySelector('#manager-assignment-group');
        if (assignmentGroup) {
             assignmentGroup.classList.add('hidden');
        }
    }
    
    modal.classList.add('hidden');
    return;
}
if (event.target.closest('#add-commission-btn')) {
    document.getElementById('commission-group').classList.remove('hidden');
    event.target.closest('#add-commission-btn').classList.add('hidden');
}
const myDirectiveTab = event.target.closest('#page-my-directives .tab-link');
if (myDirectiveTab) {
    event.preventDefault();
    const targetTabId = myDirectiveTab.dataset.tab;

    document.querySelectorAll('#page-my-directives .tab-link').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#page-my-directives .tab-content').forEach(c => c.classList.remove('active'));
    myDirectiveTab.classList.add('active');
    document.getElementById(targetTabId).classList.add('active');
    if (targetTabId === 'supervisor-directives-history') {
        loadSupervisorDirectivesHistory();
    }
}
const visitPatrolTab = event.target.closest('#page-visits .tab-link');
if (visitPatrolTab) {
    event.preventDefault();
    const targetTabId = visitPatrolTab.dataset.tab;

    document.querySelectorAll('#page-visits .tab-link').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#page-visits .tab-content').forEach(c => c.classList.remove('active'));
    visitPatrolTab.classList.add('active');
    document.getElementById(targetTabId).classList.add('active');

    if (targetTabId === 'patrols-log') {
        loadPatrolsHistory();
    }
}
const viewPathBtn = event.target.closest('.view-patrol-path-btn');
if (viewPathBtn) {
    event.preventDefault();
    const patrolId = viewPathBtn.dataset.patrolId;
    viewPatrolPath(patrolId);
}
const addVisitLogBtn = event.target.closest('#add-visit-log-btn');
if (event.target.closest('#add-visit-log-btn')) {
    const modal = document.getElementById('add-visit-modal');
    const locationSelect = document.getElementById('visit-client-select');
    const visitTimeInput = document.getElementById('visit-time-input');

    if (!currentUser || !currentUser.assigned_locations || currentUser.assigned_locations.length === 0) {
        return alert('أنت غير معين على أي مواقع حالياً لتسجيل زيارة لها.');
    }

    modal.classList.remove('hidden');

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    visitTimeInput.value = now.toISOString().slice(0, 16);
    locationSelect.innerHTML = currentUser.assigned_locations.map(loc => 
        `<option value='${JSON.stringify({ site: loc.site, contract: loc.contract })}'>
            ${loc.contract} - ${loc.site}
        </option>`
    ).join('');
}
const directiveActionBtn = event.target.closest('.directive-action-btn');
if (directiveActionBtn) {
    const directiveId = directiveActionBtn.dataset.directiveId;
    const action = directiveActionBtn.dataset.action;
    let updateData = { status: action, updated_at: new Date() };

    if (action === 'accepted') {
        const notes = prompt('هل لديك أي ملاحظات؟ (اختياري)');
        if (notes !== null) {
            updateData.acceptance_notes = notes;
        }
    } else if (action === 'rejected') {
        const reason = prompt('الرجاء كتابة سبب الرفض:');
        if (reason) {
            updateData.rejection_reason = reason;
        } else {
            return; 
        }
    }

    directiveActionBtn.disabled = true;

    try {
        const { error } = await supabaseClient
            .from('directives')
            .update(updateData)
            .eq('id', directiveId);

        if (error) throw error;
        const { data: directiveDetails, error: detailsError } = await supabaseClient
            .from('directives')
            .select('sender_id, content')
            .eq('id', directiveId)
            .single();

        if (!detailsError && directiveDetails) {
            const senderId = directiveDetails.sender_id;
            const recipientName = currentUser.name;
            const actionText = action === 'accepted' ? 'قبل' : 'رفض';

            const notificationTitle = `تم الرد على توجيهك`;
            let notificationBody = `${actionText} ${recipientName} توجيهك: "${directiveDetails.content.substring(0, 50)}..."`;
            if (updateData.acceptance_notes) {
                notificationBody += `\nالملاحظات: ${updateData.acceptance_notes}`;
            } else if (updateData.rejection_reason) {
                notificationBody += `\nالسبب: ${updateData.rejection_reason}`;
            }
            await sendNotification(senderId, notificationTitle, notificationBody, '/my-directives');
            const { data: senderData, error: senderError } = await supabaseClient
                .from('users')
                .select('phone')
                .eq('id', senderId)
                .single();

            if (senderError) {
                console.error('Could not fetch sender phone for SMS:', senderError.message);
            } else if (senderData && senderData.phone) {
                await supabaseClient.functions.invoke('send-sms', {
                    body: { to: senderData.phone, message: notificationBody } // سيتم إرسال النص المحدث
                });
            }
        }

        alert('تم تسجيل ردك بنجاح.');
        loadMyDirectivesPage(); 

    } catch (error) {
        alert('حدث خطأ أثناء الرد على التوجيه.');
        console.error(error);
        directiveActionBtn.disabled = false;
    }
}

const sendDirectiveBtn = event.target.closest('#send-directive-btn');
if (sendDirectiveBtn) {
    const recipientId = document.getElementById('directive-recipient-id').value;
    const content = document.getElementById('directive-content').value;

    if (!content.trim()) return alert('الرجاء كتابة نص التوجيه.');

    sendDirectiveBtn.disabled = true;
    sendDirectiveBtn.textContent = 'جاري الإرسال...';

    try {
        let targetUserIds = [];
        if (recipientId === 'filtered') {
            targetUserIds = currentlyDisplayedGuardIds;
        } else if (recipientId === 'all') {
            const supervisorProjects = [...new Set(currentUser.assigned_locations.map(loc => loc.contract))];
            let query = supabaseClient.from('users').select('id');
            query = createProjectFilter(query, supervisorProjects).eq('role', 'حارس أمن');
            const { data: allUsers, error: usersError } = await query;
            if (usersError) throw usersError;
            targetUserIds = allUsers.map(user => user.id);
        } else {
            targetUserIds = [parseInt(recipientId)];
        }

        if (targetUserIds.length === 0) {
            throw new Error('لم يتم تحديد أي مستلمين.');
        }
        const { error } = await supabaseClient.functions.invoke('send-directive-with-sms', {
            body: {
                recipientIds: targetUserIds,
                content: content,
                senderId: currentUser.id,
                senderName: currentUser.name,
                senderRole: currentUser.role // الإضافة الجديدة
            },
        });

        if (error) {
            throw new Error(`فشل إرسال التوجيه: ${error.message}`);
        }

        alert(`تم إرسال التوجيه بنجاح إلى ${targetUserIds.length} موظف.`);
        document.getElementById('send-directive-modal').classList.add('hidden');

    } catch (error) {
        alert('حدث خطأ أثناء إرسال التوجيه: ' + error.message);
    } finally {
        sendDirectiveBtn.disabled = false;
        sendDirectiveBtn.textContent = 'إرسال';
    }
}
const directiveTab = event.target.closest('#page-directives-ops .tab-link');
if (directiveTab) {
    event.preventDefault();
    const targetTabId = directiveTab.dataset.tab;
    document.querySelectorAll('#page-directives-ops .tab-link').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#page-directives-ops .tab-content').forEach(c => c.classList.remove('active'));
    directiveTab.classList.add('active');
    document.getElementById(targetTabId).classList.add('active');
    if (targetTabId === 'ops-directives-history') {
        loadOpsDirectivesHistory();
    }
}
const openDirectiveModalBtn = event.target.closest('.open-directive-modal-btn');
if (openDirectiveModalBtn) {
    const recipientId = openDirectiveModalBtn.dataset.recipientId;
    const recipientName = openDirectiveModalBtn.dataset.recipientName;
    
    const modal = document.getElementById('send-directive-modal');
    document.getElementById('send-directive-modal-title').textContent = `إرسال توجيه إلى: ${recipientName}`;
    document.getElementById('directive-recipient-id').value = recipientId;
    document.getElementById('directive-content').value = ''; // إفراغ الحقل عند الفتح

    modal.classList.remove('hidden');
}
const hrCoverageBtn = event.target.closest('.hr-coverage-action-btn');
if (hrCoverageBtn) {
    const applicantId = hrCoverageBtn.dataset.applicantId;
    const shiftId = hrCoverageBtn.dataset.shiftId;
    const action = hrCoverageBtn.dataset.action;

    hrCoverageBtn.disabled = true;
    hrCoverageBtn.textContent = 'جاري...';

    try {
        if (action === 'approve') {
            if (!confirm('هل أنت متأكد من القبول النهائي؟ سيتم إنشاء حساب للموظف وإغلاق الوردية.')) {
                hrCoverageBtn.disabled = false; hrCoverageBtn.innerHTML = '<i class="ph-bold ph-check-circle"></i> قبول نهائي وتعيين'; return;
            }
            const { data: applicant, error: applicantError } = await supabaseClient.from('coverage_applicants').select('*, coverage_shifts(*)').eq('id', applicantId).single();
            if (applicantError || !applicant) throw new Error('لا يمكن العثور على بيانات المتقدم.');
            const profileData = {
            name: document.getElementById('review-full-name').value,
            id_number: document.getElementById('review-id-number').value,
            phone: document.getElementById('review-phone').value,
            iban: document.getElementById('review-iban').value,
            bank_name: document.getElementById('review-bank-name').value,
            vacancy_id: vacancyId,
            start_of_work_date: new Date().toISOString().split('T')[0],
            employment_status: 'اساسي', // <-- ✨ السطر الجديد والمهم ✨
            status: 'active',
            insurance_status: 'غير مسجل'
        };
            const { data: functionResponse, error: functionError } = await supabaseClient.functions.invoke('create-employee', {
                body: { password: profileData.id_number, ...profileData }
            });

            if (functionError) throw new Error(`فشل في إنشاء الموظف: ${functionError.message}`);
            if (functionResponse.error) throw new Error(`خطأ من الخادم: ${functionResponse.error}`);
            await supabaseClient.from('coverage_applicants').update({ status: 'hr_approved' }).eq('id', applicantId);
            await supabaseClient.from('coverage_shifts').update({ status: 'closed' }).eq('id', shiftId);
            await supabaseClient.from('coverage_applicants').update({ status: 'rejected', rejection_reason: 'تم اختيار متقدم آخر' }).eq('shift_id', shiftId).not('id', 'eq', applicantId);

            alert(`تم إنشاء حساب الموظف بنجاح! \nاسم المستخدم: ${profileData.id_number}\nكلمة المرور: ${profileData.id_number}\nالرجاء إبلاغ الموظف بتغيير كلمة المرور بعد أول تسجيل دخول.`);

        } else { // الرفض
            const reason = prompt("الرجاء كتابة سبب الرفض:");
            if (reason) {
                const { error } = await supabaseClient.from('coverage_applicants').update({ status: 'rejected', rejection_reason: reason }).eq('id', applicantId);
                if (error) throw error;
                alert('تم رفض المتقدم.');
            }
        }
        
        loadCoverageRequestsPage(); // تحديث الواجهة

    } catch (error) {
        alert(`حدث خطأ فادح: ${error.message}`);
    } finally {
        hrCoverageBtn.disabled = false;
        hrCoverageBtn.innerHTML = '<i class="ph-bold ph-check-circle"></i> قبول نهائي وتعيين';
    }
}

/**
 * دالة متكاملة لتهيئة وتسجيل الإشعارات (النسخة النهائية والمستقرة)
 * @param {HTMLButtonElement} btn - الزر الذي تم الضغط عليه لتحديث حالته
 */
async function setupPushNotifications(btn) {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('المتصفح لا يدعم الإشعارات.');
        btn.disabled = false;
        return;
    }

    try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            throw new Error('تم رفض إذن الإشعارات.');
        }

        const readySW = await navigator.serviceWorker.ready;
        const fcmToken = await messaging.getToken({ 
            vapidKey: config.vapidKey,
            serviceWorkerRegistration: readySW
        });

        if (fcmToken) {
            console.log('New FCM Token obtained for this device:', fcmToken);
            const { data: user, error: fetchError } = await supabaseClient
                .from('users')
                .select('fcm_token')
                .eq('id', currentUser.id)
                .single();
            if (fetchError) throw fetchError;
            const currentTokens = user.fcm_token || []; // إذا كان الحقل فارغاً، نبدأ بقائمة فارغة
            if (currentTokens.includes(fcmToken)) {
                console.log('Token already registered for this device.');
            } else {
                console.log('Adding new token to the list.');
                currentTokens.push(fcmToken);
            }
            const { error: updateError } = await supabaseClient
                .from('users')
                .update({ fcm_token: currentTokens })
                .eq('id', currentUser.id);
            if (updateError) throw updateError;

            alert('تم تفعيل الإشعارات لهذا الجهاز بنجاح!');
            btn.style.color = '#22c55e';
        } else {
             throw new Error('لم يتمكن من الحصول على توكن.');
        }

    } catch (err) {
        console.error('حدث خطأ أثناء إعداد الإشعارات:', err);
        alert(`فشل تفعيل الإشعارات:\n${err.message}`);
    } finally {
        btn.disabled = false;
    }
}
async function loadSupervisorDirectivesHistory() {
    const container = document.getElementById('supervisor-history-list-container');
    if (!container || !currentUser) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل السجل...</p>';
    const { data: directives, error } = await supabaseClient
        .from('directives')
        .select(`
            *, 
            recipient:recipient_id (
                id, name, phone,
                job_vacancies:users_vacancy_id_fkey(schedule_details)
            )
        `)
        .eq('sender_id', currentUser.id)
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ في جلب السجل.</p>';
        return console.error(error);
    }

    if (directives.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-clock-counter-clockwise"></i><h4>السجل فارغ</h4><p>لم تقم بإرسال أي توجيهات بعد.</p></div>';
        return;
    }
    container.innerHTML = directives.map(d => {
        if (!d.recipient) return ''; // تجاهل التوجيهات التي لم يتم العثور على مستلم لها

        const recipient = d.recipient;
        const schedule = recipient.job_vacancies?.schedule_details?.[0];
        const shiftTimeHtml = schedule ? createShiftTimeLabel(schedule) : '(وردية غير محددة)';

        const formattedWhatsAppNumber = formatPhoneNumberForWhatsApp(recipient.phone);
        const callButtonHtml = recipient.phone ? `<a href="tel:${recipient.phone}" class="btn btn-secondary btn-sm" title="اتصال مباشر"><i class="ph-bold ph-phone-call"></i></a>` : '';
        const whatsappButtonHtml = formattedWhatsAppNumber ? `<a href="https://wa.me/${formattedWhatsAppNumber}" target="_blank" class="btn btn-success btn-sm" title="محادثة واتساب"><i class="ph-bold ph-whatsapp-logo"></i></a>` : '';

        let statusHtml;
        switch(d.status) {
            case 'accepted':
                statusHtml = `<div class="directive-response accepted"><i class="ph-bold ph-check-circle"></i><div><strong>تم القبول:</strong><p>${d.acceptance_notes || 'لا توجد ملاحظات.'}</p></div></div>`;
                break;
            case 'rejected':
                statusHtml = `<div class="directive-response rejected"><i class="ph-bold ph-x-circle"></i><div><strong>تم الرفض:</strong><p>${d.rejection_reason || 'لم يتم تحديد سبب.'}</p></div></div>`;
                break;
            default:
                statusHtml = `<div class="directive-response pending"><i class="ph-bold ph-hourglass-high"></i><p>بانتظار الرد من الحارس...</p></div>`;
        }

        return `
            <div class="directive-history-card">
                <div class="directive-card-header">
                    <div class="recipient-info">
                        <h5>إلى: ${recipient.name}</h5>
                        <span><i class="ph-bold ph-clock"></i> ${shiftTimeHtml}</span>
                    </div>
                    <div class="recipient-actions">
                        ${callButtonHtml}
                        ${whatsappButtonHtml}
                    </div>
                </div>
                <div class="directive-content">
                    <p>${d.content}</p>
                    <small>${formatGregorianDateTime(d.created_at)}</small>
                </div>
                ${statusHtml}
            </div>
        `;
    }).join('');
}
if (event.target.closest('#logout-btn, #logout-btn-mobile')) {
    event.preventDefault();
    if (confirm('هل أنت متأكد من رغبتك في تسجيل الخروج؟')) {
        try {
            const { error } = await supabaseClient.auth.signOut();
            if (error && !error.message.includes('Auth session missing')) {
                throw error; 
            }
            currentUser = null;
            sessionStorage.clear();
            localStorage.removeItem('admin_session');
            document.querySelector('.dashboard-container').classList.add('hidden');
            document.getElementById('login-page').style.display = 'flex';
            history.pushState(null, '', '/');

        } catch (err) {
            alert('حدث خطأ غير متوقع أثناء تسجيل الخروج: ' + err.message);
        }
    }
}
if (event.target.id === 'export-payroll-btn') {
    if (payrollExportData && payrollExportData.length > 0) {
        const startDate = document.getElementById('payroll-start-date').value;
        const endDate = document.getElementById('payroll-end-date').value;
        const filename = `مسير رواتب من ${startDate} إلى ${endDate}.xlsx`;
        exportPayrollToExcel(payrollExportData, filename); // استدعاء الدالة الجديدة
    } else {
        alert('لا توجد بيانات لتصديرها. يرجى توليد المسير أولاً.');
    }
}
if (event.target.id === 'generate-payroll-btn') {
    generatePayroll();
}

const requestActionBtn = event.target.closest('.request-action-button');
if (requestActionBtn) {
    event.stopPropagation();
    const btn = requestActionBtn;
    btn.disabled = true;

    const action = btn.dataset.action;
    const requestId = btn.dataset.requestId;
    const stage = btn.dataset.approvalStage;
    const requestType = btn.dataset.requestType;
    const userId = btn.dataset.userId;
    const vacancyId = btn.dataset.vacancyId;

    
    try {
        let updateData = {};
        let successMessage = '';
        let notifyTarget = null; // (نظام الإشعارات الجديد)

        if (action === 'reject') {
            const reason = prompt('الرجاء إدخال سبب الرفض:');
            if (!reason) { btn.disabled = false; return; }
            if (stage === 'reject_supervisor') {
                updateData = { status: 'مرفوض', rejection_reason: reason, supervisor_approver_id: currentUser.id };
            } else {
                updateData = { status: 'مرفوض', rejection_reason: reason };
            }
            successMessage = 'تم رفض الطلب بنجاح.';

        } else if (action === 'approve') {
            if (!confirm('هل أنت متأكد من الموافقة على هذا الإجراء؟')) { btn.disabled = false; return; }

            switch (stage) {
                case 'hr_admin_final':
                    updateData = { 
                        status: 'مقبول',
                        hr_approver_id: currentUser.id // اعتماد مباشر من الموارد
                    };
                    if (requestType === 'loan') {
                        updateData.status = 'بانتظار الصرف من المالية';
                        successMessage = 'تم اعتماد السلفة وتحويلها للمالية.';
                        notifyTarget = { role: 'المالية', link: '/finance/loans', type: 'سلفة' };
                    } else {
                        successMessage = 'تم قبول الطلب الإداري واعتماده نهائياً.';
                        notifyTarget = { userId: userId, link: '/admin-requests', type: requestType };
                    }
                    if (requestType === 'resignation') {
                    }
                    break;
                case 'supervisor_permission_approval':
                    updateData = { 
                        status: 'بانتظار موافقة العمليات',
                        supervisor_approver_id: currentUser.id
                    };
                    successMessage = 'تمت الموافقة، وتم رفع الطلب للعمليات.';
                    notifyTarget = { role: 'ادارة العمليات', region: currentUser.region, link: '/permission-requests', type: 'استئذان' };
                    break;
                case 'cmd_approval':
                    updateData = { 
                        status: 'مقبول',
                        ops_approver_id: currentUser.id // نسجل من الذي وافق
                    };
                    successMessage = 'تم اعتماد الاستئذان.';
                    if (action === 'approve') {
                        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                        const { data: openRecord } = await supabaseClient
                            .from('attendance')
                            .select('id')
                            .eq('guard_id', userId)
                            .is('checkout_at', null)
                            .gte('created_at', todayStart.toISOString())
                            .limit(1)
                            .single();

                        if (openRecord) {
                            await supabaseClient.from('attendance').update({ 
                                checkout_at: new Date(), 
                                status: 'استئذان', 
                                linked_request_id: requestId 
                            }).eq('id', openRecord.id);
                            successMessage += ' وتم تسجيل خروجه من النظام.';
                        }
                    }
                    notifyTarget = { userId: userId, link: '/admin-requests', type: 'استئذان' };
                    break;
                case 'ops_final_approval': // (هذا الاسم القديم لمسار الاستئذان، سنبقيه)
                    updateData = { 
                        status: 'بانتظار مراجعة الموارد البشرية', 
                        ops_approver_id: currentUser.id 
                    };
                    successMessage = 'تم اعتماد الاستئذان ورفعه لمراجعة الموارد البشرية.';
                    notifyTarget = { role: 'ادارة الموارد البشرية', region: currentUser.region, link: '/penalties', type: 'استئذان' };
                    break;
                case 'hr_final': // (الاسم القديم لمسار الموارد البشرية، سنستخدمه للإجازة)
                    updateData = { 
                        status: 'بانتظار موافقة الموارد البشرية',
                        ops_approver_id: currentUser.id // (نعتبر أن هذا هو موظف العمليات)
                    };
                    successMessage = 'تمت موافقة العمليات، وتم رفع الطلب للموارد البشرية.';
                    notifyTarget = { role: 'ادارة الموارد البشرية', region: currentUser.region, link: '/leave-requests', type: 'إجازة' };
                    break;

                case 'hr_manager_final': // (الموافقة النهائية للإجازة من مدير الموارد)
                    updateData = { 
                        status: 'مقبول',
                        hr_manager_approver_id: currentUser.id
                    };
                    successMessage = 'تمت الموافقة النهائية على الإجازة.';

                    if (vacancyId) { // إخلاء الشاغر
                        await supabaseClient.from('users').update({ vacancy_id: null, employment_status: 'اجازة' }).eq('id', userId);
                        await supabaseClient.from('job_vacancies').update({ status: 'open' }).eq('id', vacancyId);
                        successMessage += ' وتم إخلاء الشاغر الوظيفي.';
                    }
                    notifyTarget = { userId: userId, link: '/my-requests', type: 'إجازة' };
                    break;
                case 'loan_hr_approval': // (مسار جديد سنضيفه)
                    updateData = { 
                        status: 'بانتظار الصرف من المالية',
                        hr_approver_id: currentUser.id
                    };
                    successMessage = 'تمت موافقة الموارد البشرية، وتم رفع الطلب للمالية.';
                    notifyTarget = { role: 'المالية', link: '/finance/loans', type: 'سلفة' };
                    break;
                case 'hr_permission_review':
                    if (action === 'approve') {
                        updateData = { status: 'مقبول', hr_approver_id: currentUser.id };
                        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                        const { data: openAttendance } = await supabaseClient.from('attendance').select('id').eq('guard_id', userId).is('checkout_at', null).gte('created_at', todayStart.toISOString()).limit(1).single();
                        if (openAttendance) {
                            await supabaseClient.from('attendance').update({ checkout_at: new Date(), status: 'استئذان', linked_request_id: requestId }).eq('id', openAttendance.id);
                            successMessage = 'تم قبول الاستئذان وتسجيل خروج الموظف تلقائياً.';
                        } else {
                            successMessage = 'تم قبول الاستئذان (الموظف لم يكن مسجلاً للحضور).';
                        }
                        notifyTarget = { userId: userId, link: '/my-requests', type: 'استئذان' };
                    }
                    break;
            }
        }

        const { error } = await supabaseClient.from('employee_requests').update(updateData).eq('id', requestId);
        if (error) throw error;
        if (notifyTarget) {
            const { data: requestDetails } = await supabaseClient.from('employee_requests').select('users:user_id(name)').eq('id', requestId).single();
            const recipientName = requestDetails?.users?.name || 'غير معروف';
            let managerIds = [];

            if (notifyTarget.role) {
                let managerQuery = supabaseClient.from('users').select('id').eq('role', notifyTarget.role);
                if (notifyTarget.region) {
                    managerQuery = managerQuery.eq('region', notifyTarget.region);
                }
                const { data: managers } = await managerQuery;
                if (managers) managerIds = managers.map(m => m.id);
            } else if (notifyTarget.userId) {
                managerIds = [notifyTarget.userId];
            }

            sendNotification(
                managerIds,
                `تحديث على طلب ${notifyTarget.type}`,
                (notifyTarget.userId) ? 
                    `تمت ${action === 'approve' ? 'الموافقة على' : 'رفض'} طلب ${notifyTarget.type} الذي قدمته.` :
                    `تم رفع طلب ${notifyTarget.type} من ${recipientName} وهو بانتظار مراجعتك.`,
                notifyTarget.link
            );
        }

        alert(successMessage);

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        btn.disabled = false;
        if (document.querySelector('#page-leave-requests:not(.hidden)')) loadLeaveRequests();
        if (document.querySelector('#page-resignation-requests:not(.hidden)')) loadResignationRequests();
        if (document.querySelector('#page-loan-requests:not(.hidden)')) loadLoanRequests();
        if (document.querySelector('#page-ops-review-requests:not(.hidden)')) loadOpsReviewRequestsPage();
        if (document.querySelector('#page-penalties:not(.hidden)')) loadPenaltiesPage();
    }
    return;
}
    if (event.target.classList.contains('vehicle-filter-control')) {
        loadAllVehiclesView();
    }
if (event.target.closest('#view-available-slots-btn')) {
    const modal = document.getElementById('available-slots-modal');
    const body = document.getElementById('available-slots-body');
    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري حساب الشواغر المتاحة...</p>';

    try {
        const userRegion = (currentUser.role === 'ادارة الموارد البشرية' || currentUser.role === 'ادارة العمليات') ? currentUser.region : null;
        const { data: availableSlots, error } = await supabaseClient.rpc('get_available_slots_report', {
            p_user_region: userRegion
        });

                if (error) throw error;

        if (!availableSlots || availableSlots.length === 0) {
            body.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد شواغر متاحة حالياً ضمن نطاق صلاحياتك.</p>';
        } else {
            let resultsHtml = `<div class="table-container"><table>
                <thead><tr><th>المشروع (العقد)</th><th>الموقع</th><th>الوردية</th><th>المطلوب</th><th>المنشأ</th><th>المتبقي</th></tr></thead><tbody>`;

            availableSlots.forEach(slot => {
                const shift_for_label = { start_time: slot.start_time, end_time: slot.end_time };
                const shift_time_label = createShiftTimeLabel(shift_for_label);
                
                resultsHtml += `<tr>
                    <td>${slot.contract_name}</td>
                    <td>${slot.location_name}</td>
                    <td>${slot.shift_name} ${shift_time_label}</td>
                    <td>${slot.required_guards}</td>
                    <td>${slot.created_vacancies}</td>
                    <td><strong style="color: #22c55e;">${slot.remaining_slots}</strong></td>
                </tr>`;
            });

            resultsHtml += '</tbody></table></div>';
            body.innerHTML = resultsHtml;
        }

    } catch (error) {
        body.innerHTML = `<p style="text-align: center; color: red;">${error.message}</p>`;
    }
}

    const editEmployeeBtn = event.target.closest('.edit-employee-btn');
if (editEmployeeBtn) {
    const userId = editEmployeeBtn.dataset.id;
    if (!userId) return;

    const { data: employee, error } = await supabaseClient.from('users').select('*, has_received_uniform, job_vacancies!users_vacancy_id_fkey(*)').eq('id', userId).single();
    if (error || !employee) {
        console.error('Employee fetch error:', error);
        return alert('حدث خطأ في جلب بيانات الموظف.');
    }

    const modal = document.getElementById('employee-modal');
        const passwordGroup = document.getElementById('employee-password-group');
        if (currentUser.role === 'مدير النظام') {
            passwordGroup.classList.remove('hidden');
        } else {
            passwordGroup.classList.add('hidden');
        }
    const fieldRoles = ['حارس أمن', 'مشرف'];
    if (fieldRoles.includes(employee.role)) {
        populateRoleDropdown('field');
    } else {
        populateRoleDropdown('admin');
    }
    document.getElementById('employee-modal-title').textContent = 'تعديل بيانات الموظف';
    document.getElementById('employee-id').value = employee.id;
    document.getElementById('employee-auth-id').value = employee.auth_user_id;
    document.getElementById('employee-creation-mode').value = 'update';
    document.getElementById('employee-name').value = employee.name || '';
    document.getElementById('employee-id-number').value = employee.id_number || '';
    document.getElementById('employee-phone').value = employee.phone || '';
    document.getElementById('employee-role').value = employee.role || 'حارس أمن';
    document.getElementById('employee-start-date').value = employee.start_of_work_date;
    document.getElementById('employee-basic-salary').value = employee.basic_salary || '';
    document.getElementById('employee-housing-salary').value = employee.housing_allowance || '';
    document.getElementById('employee-transport-salary').value = employee.transport_allowance || '';
    document.getElementById('employee-other-salary').value = employee.other_allowance || '';
    const branchSelect = document.getElementById('employee-branch'); // للإداريين
    const fieldBranchSelect = document.getElementById('field-employee-branch'); // للحراس
    const shiftSelect = document.getElementById('employee-branch-shift');
    const { data: branchesList } = await supabaseClient.from('company_branches').select('id, name');
    
    if (branchesList) {
        branchSelect.innerHTML = '<option value="">-- اختر الفرع --</option>';
        branchSelect.innerHTML += branchesList.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        branchSelect.value = employee.branch_id || '';
        fieldBranchSelect.innerHTML = '<option value="">-- اختر الفرع --</option>';
        fieldBranchSelect.innerHTML += branchesList.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        fieldBranchSelect.value = employee.branch_id || ''; // استخدام نفس العمود
        if (employee.branch_id) {
            branchSelect.dispatchEvent(new Event('change', { bubbles: true }));
            setTimeout(() => {
                if (employee.branch_shift_id) {
                    shiftSelect.value = employee.branch_shift_id;
                }
            }, 800); 
        }
    }
    document.getElementById('employee-password').value = '';
    document.getElementById('employee-password').placeholder = 'اتركه فارغاً لعدم التغيير';
    document.getElementById('employee-iban').value = employee.iban || '';
    document.getElementById('employee-bank-name').value = employee.bank_name || '';
    document.getElementById('employee-insurance').value = employee.insurance_status || 'غير مسجل';
    document.getElementById('employee-insurance-amount').value = employee.insurance_deduction_amount || 0;
    document.getElementById('employee-status').value = employee.employment_status || 'اساسي';
    document.getElementById('employee-uniform-received').checked = employee.has_received_uniform;
    document.getElementById('employee-id-number').disabled = true;
    document.getElementById('employee-project-display').value = employee.project || '';
    document.getElementById('employee-location-display').value = employee.location || '';
    document.getElementById('employee-region').value = employee.region || '';
    document.getElementById('employee-city').value = employee.city || '';

    const shiftDisplay = document.getElementById('employee-shift-display');
    const assignedVacancy = employee.job_vacancies;
    if (employee.employment_status === 'بديل راحة') {
        shiftDisplay.value = 'جدول ديناميكي (يغطي أيام الراحة)';
    } else if (assignedVacancy && assignedVacancy.schedule_details?.[0]) {
        const shift = assignedVacancy.schedule_details[0];
        shiftDisplay.value = `${shift.name || 'وردية'} ${createShiftTimeLabel(shift)}`;
    } else {
        shiftDisplay.value = 'لا توجد وردية محددة';
    }
    toggleManagerialFields(employee.role); // إظهار/إخفاء قسم الصلاحيات

    if (employee.role === 'ادارة العمليات' || employee.role === 'مشرف') {
        document.getElementById('assign-region-select').value = employee.region || '';
        currentAssignedLocations = employee.assigned_locations || [];
        const summarySpan = document.getElementById('assigned-locations-summary');
        if (currentAssignedLocations.length > 0) {
            summarySpan.textContent = `${currentAssignedLocations.length} موقع معين.`;
        } else {
            summarySpan.textContent = 'لم يتم تحديد مواقع.';
        }
    }

    const vacancySelect = document.getElementById('employee-vacancy');
    const contractSelect = document.getElementById('employee-contract');
    contractSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    vacancySelect.innerHTML = '<option value="">جاري التحميل...</option>';
    const [{ data: allContracts, error: e1 }, { data: allVacancies, error: e2 }, { data: assignedUsers, error: e3 }] = await Promise.all([
        supabaseClient.from('contracts').select('id, company_name').eq('status', 'active'),
        supabaseClient.from('job_vacancies').select('id, status, contract_id'),
        supabaseClient.from('users').select('vacancy_id').not('vacancy_id', 'is', null)
    ]);

    if (e1 || e2 || e3) { console.error("Error fetching data for employee modal", e1 || e2 || e3); }

    const occupiedVacancyIds = new Set(assignedUsers.map(u => u.vacancy_id));
    const contractsWithAvailableSlots = new Set();
    allVacancies.forEach(vacancy => {
        const isAvailable = (vacancy.status === 'open') || (vacancy.status === 'closed' && !occupiedVacancyIds.has(vacancy.id));
        if ((isAvailable && vacancy.contract_id) || (employee.contract_id && vacancy.contract_id === employee.contract_id)) {
            contractsWithAvailableSlots.add(vacancy.contract_id);
        }
    });

    const filteredContracts = allContracts.filter(contract => contractsWithAvailableSlots.has(contract.id));

    contractSelect.innerHTML = '<option value="">غير تابع لعقد</option>';
    if (filteredContracts.length > 0) {
        contractSelect.innerHTML += filteredContracts.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
    }
    contractSelect.value = employee.contract_id || '';

    const contractId = employee.contract_id;
    const assignedVacancyId = employee.vacancy_id;
    const { data: assignedIdsData, error: assignedIdsError } = await supabaseClient.from('users').select('vacancy_id').not('vacancy_id', 'is', null).not('id', 'eq', employee.id);
    if (assignedIdsError) console.error("Error fetching assigned vacancy IDs:", assignedIdsError);
    const otherAssignedVacancyIds = (assignedIdsData || []).map(u => u.vacancy_id);

    let query = supabaseClient.from('job_vacancies').select('id, project, specific_location, schedule_details');
    let openFilter = 'status.eq.open';
    if (contractId) { openFilter += `,contract_id.eq.${contractId}`; }
    let orConditions = [`and(${openFilter})`];

    if (assignedVacancyId) { orConditions.push(`id.eq.${assignedVacancyId}`); }

    let closedEmptyFilter = 'status.eq.closed';
    if (otherAssignedVacancyIds.length > 0) { closedEmptyFilter += `,id.not.in.(${otherAssignedVacancyIds.join(',')})`; }
    if (contractId) { closedEmptyFilter += `,contract_id.eq.${contractId}`; }
    orConditions.push(`and(${closedEmptyFilter})`);

    query = query.or(orConditions.join(','));
    const { data: relevantVacancies, error: queryError } = await query;
    if(queryError) { console.error("Error fetching relevant vacancies:", queryError); }

    vacancySelect.innerHTML = '<option value="">غير مرتبط بشاغر</option>';
    if (relevantVacancies.length > 0) {
        vacancySelect.innerHTML += relevantVacancies.map(v => {
            const shift = v.schedule_details?.[0];
            const shiftName = shift?.name || 'وردية';
            const shiftText = `${shiftName} ${createShiftTimeLabel(shift)}`;
            const optionText = `${v.project} - ${v.specific_location || 'موقع عام'} - ${shiftText}`;
            return `<option value="${v.id}">${optionText}</option>`;
        }).join('');
    }
    vacancySelect.value = assignedVacancyId || '';

    modal.classList.remove('hidden');
}
if (event.target.closest('.view-vacancy-details-btn')) {
    const vacancyId = event.target.closest('.view-vacancy-details-btn').dataset.id;
    const { data: vacancy, error } = await supabaseClient.from('job_vacancies').select('*').eq('id', vacancyId).single();
    if (error) return alert('خطأ في جلب تفاصيل الشاغر.');

    const detailsBody = document.getElementById('vacancy-details-body');
    const totalSalary = (vacancy.base_salary || 0) + (vacancy.housing_allowance || 0) + (vacancy.transport_allowance || 0) + (vacancy.other_allowances || 0);

    detailsBody.innerHTML = `
        <div class="contract-display">
            <p><strong>المسمى الوظيفي:</strong> ${vacancy.title}</p>
            <p><strong>المشروع:</strong> ${vacancy.project}</p>
            <p><strong>الموقع المحدد:</strong> ${vacancy.specific_location || 'غير محدد'}</p>
            <p><strong>المدينة:</strong> ${vacancy.location}</p>
            <p><strong>المنطقة:</strong> ${vacancy.region}</p>
            <hr>
            <p><strong>الراتب الأساسي:</strong> ${vacancy.base_salary.toLocaleString('ar-SA')} ر.س</p>
            <p><strong>البدلات:</strong> ${(totalSalary - vacancy.base_salary).toLocaleString('ar-SA')} ر.س</p>
            <p><strong>إجمالي الراتب:</strong> ${totalSalary.toLocaleString('ar-SA')} ر.س</p>
        </div>
    `;
    document.getElementById('view-vacancy-details-modal').classList.remove('hidden');
}
    const deleteEmployeeBtn = event.target.closest('.delete-employee-btn');
    if (deleteEmployeeBtn) {
        const userId = deleteEmployeeBtn.dataset.id;
        const authUserId = deleteEmployeeBtn.dataset.authId;

        if (confirm('هل أنت متأكد من حذف هذا الموظف بشكل نهائي؟ لا يمكن التراجع عن هذا الإجراء.')) {
            deleteEmployeeBtn.disabled = true;
            deleteEmployeeBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

            try {
                const { data, error } = await supabaseClient.functions.invoke('delete-employee', {
                    body: { 
                        user_id: userId,
                        auth_user_id: authUserId
                    },
                });

                if (error || data.error) {
                    throw new Error(error?.message || data.error);
                }

                alert('تم حذف الموظف بنجاح!');
                loadEmployeeTabData();
                loadVacancyTabData(); 

            } catch (err) {
                alert(`حدث خطأ أثناء حذف الموظف: ${err.message}`);
                console.error("Delete employee error:", err);
                deleteEmployeeBtn.disabled = false;
                deleteEmployeeBtn.innerHTML = '<i class="ph-bold ph-trash"></i> حذف';
            }
        }
    }
    if (event.target.closest('.delete-vacancy-btn')) {
        const vacancyId = event.target.closest('.delete-vacancy-btn').dataset.id;
        if (confirm('هل أنت متأكد من رغبتك في حذف هذا الشاغر؟')) {
            const { error } = await supabaseClient.from('job_vacancies').delete().eq('id', vacancyId);
            if (error) {
                alert('حدث خطأ أثناء حذف الشاغر.');
            } else {
                loadVacancyTabData();
            }
        }
    }
if (event.target.closest('#add-location-btn')) {
    const container = document.getElementById('locations-container');
    container.insertAdjacentHTML('beforeend', createLocationGroupHtml());
}
if (event.target.closest('.delete-location-btn')) {
    event.target.closest('.location-group').remove();
}
if (event.target.closest('.add-shift-btn')) {
    const shiftsContainer = event.target.closest('.shifts-section').querySelector('.shifts-container');
    shiftsContainer.insertAdjacentHTML('beforeend', createShiftGroupHtml());
}
if (event.target.closest('.delete-shift-btn')) {
    event.target.closest('.shift-group').remove();
}
if (event.target.closest('.delete-contract-btn')) {
    const contractId = event.target.closest('.delete-contract-btn').dataset.id;
    if (confirm('هل أنت متأكد من رغبتك في حذف هذا العقد؟ سيتم حذف كل ما يتعلق به.')) {
        const { error } = await supabaseClient.from('contracts').delete().eq('id', contractId);
        if (error) {
            alert('حدث خطأ أثناء حذف العقد.');
            console.error("Delete contract error:", error);
        } else {
            alert('تم حذف العقد بنجاح.');
            fetchContracts(); // إعادة تحميل القائمة
        }
    }
}
const approveHiringBtn = event.target.closest('.approve-request-btn[data-type="hiring"]');
if (approveHiringBtn) {
    const requestId = approveHiringBtn.dataset.requestId;
    if (!requestId) return;

    if (confirm('هل أنت متأكد من الموافقة؟ سيتم إنشاء حساب للموظف وإغلاق الشاغر المرتبط به.')) {
        approveHiringBtn.disabled = true;
        approveHiringBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

        try {
            const { data: request, error: requestError } = await supabaseClient
                .from('employee_requests')
                .select('details')
                .eq('id', requestId)
                .single();
            
            if (requestError) throw new Error(`لم يتم العثور على الطلب: ${requestError.message}`);
            
            const employeeDetails = request.details;
            const vacancyId = employeeDetails.vacancy_id;

            if (!employeeDetails.password || employeeDetails.password.length < 6) {
                throw new Error('لا يمكن الموافقة على الطلب. لم يتم تحديد كلمة مرور للموظف أو أنها قصيرة جداً.');
            }
            const { password, ...profileData } = employeeDetails;
            const { data: functionResponse, error: functionError } = await supabaseClient.functions.invoke('create-employee', {
                body: { password, ...profileData }
            });

            if (functionError) throw new Error(`فشل في إنشاء الموظف: ${functionError.message}`);
            if (functionResponse.error) throw new Error(`خطأ من الخادم: ${functionResponse.error}`);
            if (vacancyId) {
                const { error: vacancyError } = await supabaseClient
                    .from('job_vacancies')
                    .update({ status: 'closed' }) // <--- هنا يتم إغلاق الشاغر
                    .eq('id', vacancyId);
                
                if (vacancyError) {
                    console.warn(`تم إنشاء الموظف ولكن فشل إغلاق الشاغر ${vacancyId}:`, vacancyError);
                }
            }
            const { error: updateRequestError } = await supabaseClient
                .from('employee_requests')
                .update({ status: 'مقبول' })
                .eq('id', requestId);
            
            if (updateRequestError) throw new Error(`فشل تحديث حالة الطلب: ${updateRequestError.message}`);

            alert('تمت الموافقة على الطلب وإنشاء الموظف بنجاح!');
            if (typeof loadOperationsRequestsPage === 'function') loadOperationsRequestsPage();
            if (typeof loadVacancyTabData === 'function') loadVacancyTabData();


        } catch (error) {
            alert(`حدث خطأ: ${error.message}`);
            console.error("Hiring Approval Error:", error);
            approveHiringBtn.disabled = false;
            approveHiringBtn.innerHTML = '<i class="ph-bold ph-check"></i> قبول';
        }
    }
}
const rejectHiringBtn = event.target.closest('.reject-request-btn[data-type="hiring"]');
if (rejectHiringBtn) {
    const requestId = rejectHiringBtn.dataset.requestId;
    if (!requestId) return;

    const reason = prompt('الرجاء إدخال سبب الرفض:');
    if (reason && reason.trim() !== '') {
        rejectHiringBtn.disabled = true;
        rejectHiringBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

        const { error } = await supabaseClient
            .from('employee_requests')
            .update({ status: 'مرفوض', rejection_reason: reason })
            .eq('id', requestId);

        if (error) {
            alert('حدث خطأ أثناء رفض الطلب.');
            rejectHiringBtn.disabled = false;
            rejectHiringBtn.innerHTML = '<i class="ph-bold ph-x"></i> رفض';
        } else {
            alert('تم رفض طلب التوظيف.');
            if (typeof loadOperationsRequestsPage === 'function') loadOperationsRequestsPage();
        }
    }
}
if (event.target.closest('#add-employee-btn')) {
    const modal = document.getElementById('employee-modal');
    populateRoleDropdown('field'); // تحديد أننا نريد إضافة موظف ميداني
    toggleManagerialFields('حارس أمن'); // <-- تحديث الواجهة فوراً
    modal.querySelector('.modal-body').querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'select-one') el.selectedIndex = 0;
        else el.value = '';
    });
    document.getElementById('employee-modal-title').textContent = 'إضافة موظف جديد';
    document.getElementById('employee-creation-mode').value = 'direct';
    document.getElementById('employee-id-number').disabled = false;
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    document.getElementById('employee-start-date').value = `${year}-${month}-${day}`;
    const contractSelect = document.getElementById('employee-contract');
    const vacancySelect = document.getElementById('employee-vacancy');
    const fieldBranchSelect = document.getElementById('field-employee-branch');
    fieldBranchSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    const { data: fieldBranches } = await supabaseClient.from('company_branches').select('id, name');
    fieldBranchSelect.innerHTML = '<option value="">-- اختر الفرع --</option>';
    if (fieldBranches) {
        fieldBranches.forEach(b => {
            fieldBranchSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
        });
    }
    contractSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    vacancySelect.innerHTML = '<option value="">جاري التحميل...</option>';

    const [
        { data: allContracts, error: e1 },
        { data: allVacancies, error: e2 },
        { data: assignedUsers, error: e3 }
    ] = await Promise.all([
        supabaseClient.from('contracts').select('id, company_name').eq('status', 'active'),
        supabaseClient.from('job_vacancies').select('id, status, contract_id'),
        supabaseClient.from('users').select('vacancy_id').not('vacancy_id', 'is', null)
    ]);

    if (e1 || e2 || e3) { console.error("Error fetching data for employee modal", e1 || e2 || e3); }

    const occupiedVacancyIds = new Set(assignedUsers.map(u => u.vacancy_id));
    const contractsWithAvailableSlots = new Set();
    allVacancies.forEach(vacancy => {
        const isAvailable = (vacancy.status === 'open') || (vacancy.status === 'closed' && !occupiedVacancyIds.has(vacancy.id));
        if (isAvailable && vacancy.contract_id) {
            contractsWithAvailableSlots.add(vacancy.contract_id);
        }
    });

    const filteredContracts = allContracts.filter(contract => contractsWithAvailableSlots.has(contract.id));

    contractSelect.innerHTML = '<option value="">غير تابع لعقد</option>';
    if (filteredContracts.length > 0) {
        contractSelect.innerHTML += filteredContracts.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
    }

    vacancySelect.innerHTML = '<option value="">غير مرتبط بشاغر</option>';
    const openVacancies = allVacancies.filter(v => v.status === 'open');
    if (openVacancies.length > 0) {
        const { data: detailedOpenVacancies } = await supabaseClient.from('job_vacancies').select('id, project, specific_location, schedule_details').in('id', openVacancies.map(v => v.id));
        if(detailedOpenVacancies) {
            const vacancyOptions = detailedOpenVacancies.map(v => {
                const shift = v.schedule_details?.[0];
                const shiftText = `${shift?.name || 'وردية'} ${createShiftTimeLabel(shift)}`;
                return `<option value="${v.id}">${v.project} - ${v.specific_location || 'موقع عام'} - ${shiftText}</option>`;
            }).join('');
            vacancySelect.innerHTML += vacancyOptions;
        }
    }
    toggleManagerialFields('حارس أمن'); // <-- تحديث الواجهة فوراً
    document.getElementById('employee-password-group').classList.add('hidden');
    modal.classList.remove('hidden');
}
if (event.target.closest('#add-admin-staff-btn')) {
    const modal = document.getElementById('employee-modal');
    toggleManagerialFields('ادارة العمليات'); // <-- تحديث الواجهة فوراً
    populateRoleDropdown('admin');
    modal.querySelector('.modal-body').querySelectorAll('input, select, textarea').forEach(el => {
        if (el.id === 'employee-role') return;
        if (el.type === 'select-one') el.selectedIndex = 0;
        else el.value = '';
    });

    document.getElementById('employee-modal-title').textContent = 'إضافة موظف إداري جديد';
    document.getElementById('employee-creation-mode').value = 'direct';
    document.getElementById('employee-id-number').disabled = false;
toggleManagerialFields('ادارة العمليات');
    const branchSelect = document.getElementById('employee-branch');
    branchSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    const { data: branches } = await supabaseClient.from('company_branches').select('id, name');
    if (branches) {
        branchSelect.innerHTML = '<option value="">-- اختر الفرع --</option>';
        branchSelect.innerHTML += branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
    }

    modal.classList.remove('hidden');
}
if (event.target.closest('#save-employee-btn')) {
    const saveBtn = event.target.closest('#save-employee-btn');
    const creationMode = document.getElementById('employee-creation-mode').value;
    const employeeId = document.getElementById('employee-id').value;
    const authId = document.getElementById('employee-auth-id').value;

    saveBtn.disabled = true;
    saveBtn.textContent = 'جاري الحفظ...';

    try {
        const role = document.getElementById('employee-role').value;
        const assignedShiftElement = document.getElementById('employee-shift');
        const assignedShift = (assignedShiftElement && assignedShiftElement.value) ? JSON.parse(assignedShiftElement.value) : null;

        let profileData = {
            has_received_uniform: document.getElementById('employee-uniform-received').checked,
            name: document.getElementById('employee-name').value,
            start_of_work_date: document.getElementById('employee-start-date').value || null,
            phone: document.getElementById('employee-phone').value,
            iban: document.getElementById('employee-iban').value,
            role: role,
            employment_status: document.getElementById('employee-status').value,
            insurance_status: document.getElementById('employee-insurance').value,
            insurance_deduction_amount: parseFloat(document.getElementById('employee-insurance-amount').value) || 0,
            bank_name: document.getElementById('employee-bank-name').value,
            project: null,
            location: null,
            city: null,
            region: null,
            vacancy_id: null,
            contract_id: null,
            assigned_shift: null,
            assigned_locations: null,
            basic_salary: parseFloat(document.getElementById('employee-basic-salary').value) || 0,
            housing_allowance: parseFloat(document.getElementById('employee-housing-salary').value) || 0,
            transport_allowance: parseFloat(document.getElementById('employee-transport-salary').value) || 0,
            other_allowance: parseFloat(document.getElementById('employee-other-salary').value) || 0,
            branch_id: (role === 'حارس أمن' || role === 'مشرف') 
                ? (document.getElementById('field-employee-branch').value || null) 
                : (document.getElementById('employee-branch').value || null),
            
            branch_shift_id: document.getElementById('employee-branch-shift').value || null
        };

        if (role === 'ادارة العمليات' || role === 'مشرف') {
            profileData.region = document.getElementById('assign-region-select').value;
            profileData.assigned_locations = currentAssignedLocations;
            const uniqueContracts = [...new Set(currentAssignedLocations.map(loc => loc.contract))];
            profileData.project = uniqueContracts;

        } else if (role === 'حارس أمن') {
            profileData.vacancy_id = document.getElementById('employee-vacancy').value || null;
            profileData.contract_id = document.getElementById('employee-contract').value || null;
            const singleProject = document.getElementById('employee-project-display').value;
            profileData.project = singleProject ? [singleProject] : [];
            profileData.location = document.getElementById('employee-location-display').value;
            profileData.city = document.getElementById('employee-city').value;
            profileData.region = document.getElementById('employee-region').value;
        }

        if (profileData.employment_status === 'بديل راحة') {
            profileData.assigned_shift = null;
        }

        if (!profileData.name || !profileData.role) throw new Error('الرجاء تعبئة حقول الاسم والدور.');

        if (creationMode === 'update') {
            const passwordInput = document.getElementById('employee-password');
            const passwordGroup = document.getElementById('employee-password-group');
            const newPassword = passwordInput.value;
            if (!passwordGroup.classList.contains('hidden') && newPassword && newPassword.trim() !== '') {
                if (newPassword.length < 6) throw new Error('كلمة المرور يجب أن تكون 6 أحرف على الأقل.');
                if (!authId) throw new Error('لا يمكن تحديث كلمة المرور. معرّف المصادقة الخاص بالموظف مفقود.');

                const { data, error: passwordError } = await supabaseClient.functions.invoke('update-employee-password', {
                    body: { auth_id: authId, new_password: newPassword }
                });
                if (passwordError || (data && data.error)) throw new Error(passwordError?.message || data.error || 'فشل تحديث كلمة المرور.');
            }

            const { error: updateError } = await supabaseClient.from('users').update(profileData).eq('id', employeeId);
            if (updateError) throw updateError;

            if (profileData.vacancy_id && profileData.employment_status !== 'اجازة') {
                await supabaseClient.from('job_vacancies').update({ status: 'closed' }).eq('id', profileData.vacancy_id);
            }
            alert('تم تحديث بيانات الموظف بنجاح.');

        } else { 
            const fullProfileData = { ...profileData, id_number: document.getElementById('employee-id-number').value };
            const newPassword = document.getElementById('employee-id-number').value; // Password is now the ID number
            if (!fullProfileData.id_number || fullProfileData.id_number.length < 6) throw new Error('يجب إدخال رقم هوية (6 أرقام على الأقل) للموظف الجديد.');

            const { data, error } = await supabaseClient.functions.invoke('create-employee', { body: { password: newPassword, ...fullProfileData } });

            if (error) throw error;
            if (data.error) throw new Error(data.error);

            if (profileData.vacancy_id) await supabaseClient.from('job_vacancies').update({ status: 'closed' }).eq('id', profileData.vacancy_id);
            alert('تم إنشاء الموظف بنجاح.');
        }

        document.getElementById('employee-modal').classList.add('hidden');
        if (typeof loadEmployeeTabData === 'function') loadEmployeeTabData();
        if (typeof loadVacancyTabData === 'function') loadVacancyTabData();

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
        console.error("Save/Update Employee Error:", error);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'حفظ الموظف';
        document.getElementById('employee-id-number').disabled = false;
    }
}
    if (event.target.closest('.tab-link')) {
        event.preventDefault();
        const tabLink = event.target.closest('.tab-link');
        const targetTabId = tabLink.dataset.tab;
        tabLink.parentElement.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tabLink.classList.add('active');
        document.getElementById(targetTabId).classList.add('active');
        if (targetTabId === 'hr-tab-vacancies') loadVacancyTabData();
        if (targetTabId === 'hr-tab-employees') loadEmployeeTabData();
    }
    function createClauseItemHtml(clauseText = '') {
        return `
            <div class="clause-item">
                <input type="text" class="clause-item-input" placeholder="اكتب نص البند هنا..." value="${clauseText}">
                <button class="delete-btn delete-clause-item-btn" title="حذف البند"><i class="ph-bold ph-trash"></i></button>
            </div>
        `;
    }
    function createClauseGroupHtml(group = { title: '', clauses: [''] }) {
        const groupId = `group_${Date.now()}_${Math.random()}`;
        const clausesHtml = group.clauses.map(clause => createClauseItemHtml(clause)).join('');

        return `
            <div class="clause-group" id="${groupId}">
                <div class="clause-group-header">
                    <div class="form-group">
                        <label>عنوان المجموعة</label>
                        <input type="text" class="clause-group-title" placeholder="مثال: التزامات الطرف الأول" value="${group.title}">
                    </div>
                    <button class="delete-btn delete-clause-group-btn" title="حذف المجموعة كاملة"><i class="ph-bold ph-x-circle"></i></button>
                </div>
                <div class="clause-items-list">
                    ${clausesHtml}
                </div>
                <div class="clause-group-footer">
                    <button class="btn btn-secondary add-clause-item-btn"><i class="ph-bold ph-plus"></i> إضافة بند لهذه المجموعة</button>
                </div>
            </div>
        `;
    }
    if (event.target.closest('#add-clause-group-btn')) {
        document.getElementById('clause-groups-container').insertAdjacentHTML('beforeend', createClauseGroupHtml());
    }
    if (event.target.closest('.add-clause-item-btn')) {
        const list = event.target.closest('.clause-group').querySelector('.clause-items-list');
        list.insertAdjacentHTML('beforeend', createClauseItemHtml());
    }
    if (event.target.closest('.delete-clause-group-btn')) {
        event.target.closest('.clause-group').remove();
    }
    if (event.target.closest('.delete-clause-item-btn')) {
        event.target.closest('.clause-item').remove();
    }
if (event.target.closest('#add-vacancy-btn')) {
    const modal = document.getElementById('vacancy-modal');
    const contractSelect = document.getElementById('vacancy-contract');
    availableVacancyData = await getAvailableVacancySlots();
    if (availableVacancyData.length === 0) {
        return alert('لا توجد أي شواغر متاحة في العقود النشطة حالياً.');
    }
    document.getElementById('vacancy-modal-title').textContent = 'إضافة شاغر جديد';
    document.getElementById('vacancy-id').value = '';
    document.getElementById('vacancy-title').value = 'حارس أمن';
    document.getElementById('vacancy-project').value = '';
    document.getElementById('vacancy-city').value = '';
    document.getElementById('vacancy-status').value = 'open';
    document.getElementById('vacancy-base-salary').value = 0;
    document.getElementById('vacancy-housing').value = 0;
    document.getElementById('vacancy-transport').value = 0;
    document.getElementById('vacancy-other').value = 0;
    document.getElementById('vacancy-location-group').classList.add('hidden');
    document.getElementById('vacancy-shift-group').classList.add('hidden');
    document.getElementById('vacancy-location-select').innerHTML = '';
    document.getElementById('vacancy-shift-select').innerHTML = '';
    contractSelect.innerHTML = '<option value="">-- اختر عقداً --</option>';
    contractSelect.innerHTML += availableVacancyData.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');

    modal.classList.remove('hidden');
}
if (event.target.closest('.edit-vacancy-btn')) {
    const vacancyId = event.target.closest('.edit-vacancy-btn').dataset.id;
    const { data: vacancy, error } = await supabaseClient
        .from('job_vacancies')
        .select('*, contracts(*)')
        .eq('id', vacancyId)
        .single();

    if (error || !vacancy) {
        return alert('خطأ في جلب بيانات الشاغر للتعديل.');
    }

    const modal = document.getElementById('vacancy-modal');
    document.getElementById('vacancy-modal-title').textContent = 'تعديل شاغر وظيفي';
    document.getElementById('vacancy-id').value = vacancy.id;
    document.getElementById('vacancy-title').value = vacancy.title;
    document.getElementById('vacancy-project').value = vacancy.project;
    document.getElementById('vacancy-city').value = vacancy.location; 
    document.getElementById('vacancy-status').value = vacancy.status;
    document.getElementById('vacancy-base-salary').value = vacancy.base_salary;
    document.getElementById('vacancy-housing').value = vacancy.housing_allowance;
    document.getElementById('vacancy-transport').value = vacancy.transport_allowance;
    document.getElementById('vacancy-other').value = vacancy.other_allowances;
    const contractSelect = document.getElementById('vacancy-contract');
    const locationGroup = document.getElementById('vacancy-location-group');
    const locationSelect = document.getElementById('vacancy-location-select');
    const shiftGroup = document.getElementById('vacancy-shift-group');
    const shiftSelect = document.getElementById('vacancy-shift-select');

    const { data: contracts } = await supabaseClient.from('contracts').select('id, company_name, contract_locations');
    contractSelect.innerHTML = '<option value="">-- اختر عقداً --</option>';
    if (contracts) {
        contractSelect.innerHTML += contracts.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
    }
    contractSelect.value = vacancy.contract_id;

    const selectedContractData = contracts.find(c => c.id === vacancy.contract_id);
    if (selectedContractData && selectedContractData.contract_locations) {
        locationSelect.innerHTML = '<option value="">-- اختر موقعاً --</option>';
        selectedContractData.contract_locations.forEach(loc => {
            locationSelect.innerHTML += `<option value="${loc.name}">${loc.name}</option>`;
        });
        locationSelect.value = vacancy.specific_location;
        locationGroup.classList.remove('hidden');
    }

    if (vacancy.specific_location && selectedContractData && selectedContractData.contract_locations) {
        const selectedLocationData = selectedContractData.contract_locations.find(l => l.name === vacancy.specific_location);
        if (selectedLocationData && selectedLocationData.shifts) {
            shiftSelect.innerHTML = '<option value="">-- اختر وردية --</option>';
            selectedLocationData.shifts.forEach(shift => {
                const shiftLabel = `${shift.name || 'وردية'} ${createShiftTimeLabel(shift)}`;
                shiftSelect.innerHTML += `<option value='${JSON.stringify(shift)}'>${shiftLabel}</option>`;
            });

            if (vacancy.schedule_details && vacancy.schedule_details[0]) {
                shiftSelect.value = JSON.stringify(vacancy.schedule_details[0]);
            }
            shiftGroup.classList.remove('hidden');
        }
    }

    modal.classList.remove('hidden');
}

if (event.target.closest('#save-vacancy-btn')) {
    const saveBtn = event.target.closest('#save-vacancy-btn');
    const id = document.getElementById('vacancy-id').value;
    saveBtn.disabled = true;
    saveBtn.textContent = 'جاري الحفظ...';

    try {
        const selectedShiftElement = document.getElementById('vacancy-shift-select');
        const shiftDetails = selectedShiftElement.value ? JSON.parse(selectedShiftElement.value) : null;

        if (!shiftDetails) {
            throw new Error('الرجاء اختيار وردية للشاغر.');
        }

        const contractId = document.getElementById('vacancy-contract').value;
        const locationName = document.getElementById('vacancy-location-select').value;
        let locationRegion = '';
        if (contractId && locationName) {
            const { data: contract } = await supabaseClient.from('contracts').select('contract_locations').eq('id', contractId).single();
            if (contract && contract.contract_locations) {
                const selectedLocation = contract.contract_locations.find(loc => loc.name === locationName);
                if (selectedLocation) {
                    locationRegion = selectedLocation.region || '';
                }
            }
        }

        const vacancyData = {
            title: document.getElementById('vacancy-title').value,
            contract_id: contractId || null,
            project: document.getElementById('vacancy-project').value.trim(),
            location: document.getElementById('vacancy-city').value.trim(),
            region: locationRegion, // <-- استخدام المنطقة الصحيحة من الموقع
            specific_location: locationName,
            status: document.getElementById('vacancy-status').value,
            base_salary: parseFloat(document.getElementById('vacancy-base-salary').value) || 0,
            housing_allowance: parseFloat(document.getElementById('vacancy-housing').value) || 0,
            transport_allowance: parseFloat(document.getElementById('vacancy-transport').value) || 0,
            other_allowances: parseFloat(document.getElementById('vacancy-other').value) || 0,
            work_days_count: shiftDetails.days.length,
            work_hours: shiftDetails.work_hours,
            schedule_details: [shiftDetails]
        };

        if (!vacancyData.title || !vacancyData.project) throw new Error('الرجاء إدخال المسمى الوظيفي والمشروع.');

        const { data, error } = id
            ? await supabaseClient.from('job_vacancies').update(vacancyData).eq('id', id).select().single()
            : await supabaseClient.from('job_vacancies').insert([vacancyData]).select().single();

        if (error) throw error;

        alert('تم حفظ الشاغر بنجاح!');
        document.getElementById('vacancy-modal').classList.add('hidden');
        loadVacancyTabData();

    } catch (error) {
        alert('حدث خطأ أثناء حفظ الشاغر: ' + error.message);
        console.error(error);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'حفظ الشاغر';
    }
}
if (event.target.closest('.delete-vacancy-btn')) {
    const vacancyId = event.target.closest('.delete-vacancy-btn').dataset.id;
    if (confirm('هل أنت متأكد من رغبتك في حذف هذا الشاغر؟')) {
        const { error } = await supabaseClient.from('job_vacancies').delete().eq('id', vacancyId);
        if (error) {
            alert('حدث خطأ أثناء حذف الشاغر.');
        } else {
            loadVacancyTabData();
        }
    }
}
const addVisitBtn = event.target.closest('#add-visit-btn');
if (addVisitBtn) {
    const modal = document.getElementById('add-visit-modal');
    const clientSelect = document.getElementById('visit-client-select');
    const visitTimeInput = document.getElementById('visit-time-input');
    modal.classList.remove('hidden');
    clientSelect.innerHTML = '<option>جاري تحميل المواقع...</option>';
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    visitTimeInput.value = now.toISOString().slice(0, 16);
    const { data: clients, error } = await supabaseClient.from('clients').select('id, name');

    if (error || !clients) {
        clientSelect.innerHTML = '<option>خطأ في تحميل المواقع</option>';
    } else {
        clientSelect.innerHTML = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
}
if (event.target.closest('#submit-visit-btn')) {
    const submitVisitBtn = event.target.closest('#submit-visit-btn');
    const modal = document.getElementById('add-visit-modal');
    const selectedLocationData = JSON.parse(document.getElementById('visit-client-select').value);
    const visitTime = document.getElementById('visit-time-input').value;
    const notes = document.getElementById('visit-notes-textarea').value;

    if (!selectedLocationData || !visitTime || !notes.trim()) {
        return alert('الرجاء تعبئة جميع الحقول.');
    }

    submitVisitBtn.disabled = true;
    submitVisitBtn.textContent = 'جاري الحفظ...';

    try {
        const { data: contract, error: contractError } = await supabaseClient
            .from('contracts')
            .select('id, company_name, region, city')
            .eq('company_name', selectedLocationData.contract)
            .single();

        if (contractError || !contract) throw new Error('لم يتم العثور على العقد المرتبط بالموقع.');

        const visitSnapshot = {
            supervisor_info: { id: currentUser.id, auth_id: currentUser.auth_user_id, name: currentUser.name, role: currentUser.role },
            location_info: { contract_id: contract.id, contract_name: contract.company_name, site_name: selectedLocationData.site, region: contract.region, city: contract.city },
            visit_details: { timestamp: visitTime, notes: notes }
        };

        const visitData = {
            user_id: currentUser.auth_user_id,
            contract_id: contract.id,
            location_name: selectedLocationData.site,
            visit_time: visitTime,
            notes: notes,
            visit_snapshot: visitSnapshot
        };

        const { error } = await supabaseClient.from('visits').insert(visitData);
        if (error) throw error;

        alert('تم تسجيل الزيارة بنجاح.');
        modal.classList.add('hidden');
        if (typeof fetchVisits === 'function') fetchVisits();
        if (typeof loadMyVisitsPage === 'function') loadMyVisitsPage();

    } catch (error) {
        alert('حدث خطأ أثناء حفظ الزيارة: ' + error.message);
        console.error('Visit Log Error:', error);
    } finally {
        submitVisitBtn.disabled = false;
        submitVisitBtn.textContent = 'حفظ الزيارة';
    }
}
 const requestTransferBtn = event.target.closest('#request-transfer-btn');
if (requestTransferBtn) {
    const modal = document.getElementById('guard-transfer-modal');
    const guardSelect = document.getElementById('transfer-guard-select');
    const clientSelect = document.getElementById('transfer-client-select');
    modal.classList.remove('hidden');
    guardSelect.innerHTML = '<option>جاري تحميل الحراس...</option>';
    clientSelect.innerHTML = '<option>جاري تحميل المواقع...</option>';
    const { data: guards, error: guardsError } = await supabaseClient
        .from('users')
        .select('id, name')
        .eq('supervisor_id', currentUser.id);

    if (guardsError || !guards) {
        guardSelect.innerHTML = '<option>خطأ في تحميل الحراس</option>';
    } else {
        guardSelect.innerHTML = guards.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
    }
    const { data: clients, error: clientsError } = await supabaseClient.from('clients').select('id, name');

    if (clientsError || !clients) {
        clientSelect.innerHTML = '<option>خطأ في تحميل المواقع</option>';
    } else {
        clientSelect.innerHTML = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
}
const submitTransferBtn = event.target.closest('#submit-transfer-request-btn');
if (submitTransferBtn) {
    const modal = document.getElementById('guard-transfer-modal');
    const guardId = document.getElementById('transfer-guard-select').value;
    const clientId = document.getElementById('transfer-client-select').value;
    const reason = document.getElementById('transfer-reason').value;

    if (!guardId || !clientId || !reason.trim()) {
        alert('الرجاء تعبئة جميع الحقول.');
        return;
    }

    submitTransferBtn.disabled = true;
    submitTransferBtn.textContent = 'جاري الإرسال...';
    const { error } = await supabaseClient
        .from('visits')
        .insert({
            supervisor_id: currentUser.id, // هذا هو الاسم الصحيح لعمود المشرف
            client_id: clientId,
            visit_time: visitTime,
            notes: notes
        });

    if (error) {
        alert('حدث خطأ أثناء إرسال الطلب.');
        console.error('Transfer Request Error:', error);
    } else {
        alert('تم إرسال طلب النقل بنجاح.');
        modal.classList.add('hidden');
    }

    submitTransferBtn.disabled = false;
    submitTransferBtn.textContent = 'إرسال طلب النقل';
}
    const requestCard = event.target.closest('.request-action-card');
    if (requestCard) {
        const requestType = requestCard.dataset.requestType;
        if (requestType) {
            if (requestType === 'loan') {
                const loanButton = document.getElementById('loan-request-btn');
                if (loanButton.disabled) {
                    const reason = loanButton.querySelector('h4').textContent;
                    showCustomAlert('طلب مرفوض', `عفواً، لا يمكنك طلب سلفة حالياً. السبب: ${reason}`, 'error');
                    return;
                }
                const maxLoan = parseFloat(loanButton.dataset.maxLoan || '0');
                const modal = document.getElementById('loan-request-modal');
                const policyInfo = document.getElementById('loan-policy-info');
                
                policyInfo.textContent = `الحد الأقصى المسموح لك هو: ${maxLoan.toLocaleString('ar-SA')} ر.س (25% من راتبك الأساسي).`;
                document.getElementById('loan-amount').max = maxLoan; // تحديد الحد الأقصى في الحقل
                
                if (modal) modal.classList.remove('hidden');

            } else {
                const modalId = `${requestType}-request-modal`;
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.remove('hidden');
            }
        }
    }
const startPatrolBtn = event.target.closest('#start-patrol-btn');
if (startPatrolBtn) {
    if (!confirm('هل أنت متأكد من رغبتك في بدء جولة ميدانية الآن؟')) return;

    startPatrolBtn.disabled = true;
    startPatrolBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري البدء...';

    const { data: newPatrol, error } = await supabaseClient
        .from('patrols')
        .insert({ supervisor_id: currentUser.id, status: 'active' })
        .select() // <-- طلب إعادة بيانات السجل الجديد
        .single();

    if (error || !newPatrol) {
        alert('حدث خطأ أثناء بدء الجولة.');
        console.error(error);
    } else {
        alert('تم بدء الجولة بنجاح! التتبع المباشر فعال الآن.');
        startPatrolTracking(newPatrol.id); // <-- تشغيل التتبع باستخدام معرف الجولة الجديدة
    }
    loadSupervisorPatrolPage();
    startPatrolBtn.disabled = false;
    startPatrolBtn.innerHTML = 'بدء الجولة';
}
const endPatrolBtn = event.target.closest('#end-patrol-btn');
if (endPatrolBtn) {
    const patrolId = endPatrolBtn.dataset.patrolId;
    const modal = document.getElementById('end-patrol-modal');
    document.getElementById('active-patrol-id').value = patrolId;
    document.getElementById('patrol-notes').value = ''; // إفراغ الحقل
    modal.classList.remove('hidden');
}
const confirmEndPatrolBtn = event.target.closest('#confirm-end-patrol-btn');
if (confirmEndPatrolBtn) {
    const patrolId = document.getElementById('active-patrol-id').value;
    const notes = document.getElementById('patrol-notes').value;

    confirmEndPatrolBtn.disabled = true;
    confirmEndPatrolBtn.textContent = 'جاري الحفظ...';

    stopPatrolTracking(); // <-- إيقاف التتبع أولاً

    const { error } = await supabaseClient
        .from('patrols')
        .update({ end_time: new Date(), status: 'completed', notes: notes })
        .eq('id', patrolId);

    if (error) {
        alert('حدث خطأ أثناء إنهاء الجولة. قد تحتاج لبدء التتبع مرة أخرى.');
        console.error(error);
    } else {
        alert('تم إنهاء الجولة وحفظ المسار بنجاح.');
        document.getElementById('end-patrol-modal').classList.add('hidden');
    }
    loadSupervisorPatrolPage();
    confirmEndPatrolBtn.disabled = false;
    confirmEndPatrolBtn.textContent = 'تأكيد وإنهاء الجولة';
}
const checkOutBtn = event.target.closest('#check-out-btn');
if (checkOutBtn) {
    checkOutBtn.disabled = true;
    checkOutBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> التحقق...';

    try {
        const { data: openRecord, error: recordError } = await supabaseClient
            .from('attendance')
            .select('*')
            .eq('id', checkOutBtn.dataset.attendanceId)
            .single();

        if (recordError || !openRecord) throw new Error('لم يتم العثور على سجل الحضور المفتوح.');
        let schedule;
        if (openRecord.shift_snapshot && openRecord.shift_snapshot.schedule_details) {
            schedule = openRecord.shift_snapshot.schedule_details[0];
        } else {
            const { data: userWithVacancy } = await supabaseClient.from('users').select('*, job_vacancies!users_vacancy_id_fkey(*)').eq('id', currentUser.id).single();
            schedule = userWithVacancy?.job_vacancies?.schedule_details?.[0];
        }

        if (!schedule) throw new Error('لا يمكن تحديد جدول العمل الخاص بك.');

        const periods = schedule.periods || [schedule];
        let currentPeriod = null;
            const checkinTime = new Date(openRecord.created_at);
for (const period of periods) {
    const [startHours, startMinutes] = period.start_time.split(':').map(Number);
    const [endHours, endMinutes] = period.end_time.split(':').map(Number);

    let periodStartTime = new Date(checkinTime.getFullYear(), checkinTime.getMonth(), checkinTime.getDate(), startHours, startMinutes);
    let periodEndTime = new Date(checkinTime.getFullYear(), checkinTime.getMonth(), checkinTime.getDate(), endHours, endMinutes);
    if (period.end_time < period.start_time) {
        if (checkinTime.getHours() < startHours) { // حضر بعد منتصف الليل لوردية بدأت بالأمس
            periodStartTime.setDate(periodStartTime.getDate() - 1);
        } else { // حضر قبل منتصف الليل لوردية ستنتهي غداً
            periodEndTime.setDate(periodEndTime.getDate() + 1);
        }
    }
    const gracePeriodStart = new Date(periodStartTime.getTime() - 16 * 60000);
    if (checkinTime >= gracePeriodStart && checkinTime < periodEndTime) {
        currentPeriod = period;
        break;
    }
}
if (!currentPeriod) {
    console.warn("Could not find period in snapshot, attempting fallback with current schedule...");
    const { data: userWithVacancy } = await supabaseClient.from('users').select('*, job_vacancies!users_vacancy_id_fkey(*)').eq('id', currentUser.id).single();
    const currentSchedule = userWithVacancy?.job_vacancies?.schedule_details?.[0];

    if (currentSchedule) {
        const currentPeriods = currentSchedule.periods || [currentSchedule];
        for (const period of currentPeriods) {
            const [startHours, startMinutes] = period.start_time.split(':').map(Number);
            const [endHours, endMinutes] = period.end_time.split(':').map(Number);
            let periodStartTime = new Date(checkinTime.getFullYear(), checkinTime.getMonth(), checkinTime.getDate(), startHours, startMinutes);
            let periodEndTime = new Date(checkinTime.getFullYear(), checkinTime.getMonth(), checkinTime.getDate(), endHours, endMinutes);
            if (period.end_time < period.start_time) {
                if (checkinTime.getHours() < startHours) { periodStartTime.setDate(periodStartTime.getDate() - 1); } 
                else { periodEndTime.setDate(periodEndTime.getDate() + 1); }
            }
            const gracePeriodStart = new Date(periodStartTime.getTime() - 16 * 60000);
            if (checkinTime >= gracePeriodStart && checkinTime < periodEndTime) {
                currentPeriod = period;
                break;
            }
        }
    }
}

let newStatus = 'اكمل المناوبة';
let proceedToCheckout = true; // نفترض أن الانصراف مسموح به بشكل افتراضي
const now = new Date();
if (currentPeriod) {
    const [endHours, endMinutes] = currentPeriod.end_time.split(':').map(Number);
    const shiftEndTime = new Date(checkinTime);
    shiftEndTime.setHours(endHours, endMinutes, 0, 0);

    if (shiftEndTime < checkinTime) {
        shiftEndTime.setDate(shiftEndTime.getDate() + 1);
    }

    const gracePeriodStartTime = new Date(shiftEndTime.getTime() - 15 * 60000);

    if (now < gracePeriodStartTime) {
        const warningMessage = "تنبيه! ورديتك لم تنته بعد.\n\nهل أنت متأكد؟ سيتم تسجيل هذا الإجراء كـ 'انسحاب (انصراف مبكر)'.";
        if (confirm(warningMessage)) {
            newStatus = 'انسحاب (انصراف مبكر)';
            proceedToCheckout = true;
        } else {
            checkOutBtn.disabled = false;
            checkOutBtn.innerHTML = 'تسجيل انصراف';
            proceedToCheckout = false; // نمنع الانصراف
        }
    } else {
        proceedToCheckout = true;
    }
} else {
    console.warn('Period not found for checkout. Allowing checkout without early-leave check.');
    proceedToCheckout = true;
}

if (proceedToCheckout) {
    stopPersistentTracking();
    const { error } = await supabaseClient
        .from('attendance')
        .update({
            checkout_at: new Date(),
            status: newStatus,
            notes: openRecord.notes ? `اكمل ${openRecord.notes}` : 'اكمل المناوبة'
        })
        .eq('id', openRecord.id);

    if (error) throw error;

    showToast('تم تسجيل انصرافك بنجاح.', 'success');
    loadAttendancePage();
}

    } catch (error) {
        showCustomAlert('خطأ', error.message, 'error');
        const btn = document.getElementById('check-out-btn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'تسجيل انصراف';
        }
    }
}
const staleFixBtn = event.target.closest('#stale-checkin-fix-btn');
if (staleFixBtn) {
    const recordId = staleFixBtn.dataset.recordId;
    if (!confirm('سيقوم هذا الإجراء بإغلاق ورديتك السابقة الآن، لتتمكن من بدء ورديتك الجديدة. هل أنت متأكد؟')) {
        return;
    }

    staleFixBtn.disabled = true;
    staleFixBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري المعالجة...';

    try {
        const { error } = await supabaseClient
            .from('attendance')
            .update({
                checkout_at: new Date(), // إغلاقه في الوقت الحالي
                status: 'اكمل المناوبة',
                notes: 'إغلاق يدوي لسجل منسي'
            })
            .eq('id', recordId);

        if (error) throw error;

        showToast('تمت معالجة السجل القديم بنجاح.', 'success');
        loadAttendancePage();

    } catch (error) {
        alert(`حدث خطأ أثناء المعالجة: ${error.message}`);
        staleFixBtn.disabled = false;
        staleFixBtn.innerHTML = 'تسجيل انصراف للفترة السابقة وبدء الفترة الجديدة';
    }
}

    const submitRequestBtn = event.target.closest('.btn-submit-request');
if (submitRequestBtn) {
    event.preventDefault();

    const requestType = submitRequestBtn.dataset.requestType;
    if (!requestType || !currentUser) return;

    const modal = submitRequestBtn.closest('.modal-overlay');
    let details = {};
    let isValid = true;
    let requestTypeText = ''; 
    let newStatus = ''; 
    let notifyToRole = ''; 
    let notifyLink = '#';
    const isFieldStaff = ['حارس أمن', 'مشرف'].includes(currentUser.role);
    const managerMap = {
        'ادارة الموارد البشرية': 'is_hr_manager',
        'ادارة العمليات': 'is_ops_manager',
        'ادارة العقود': 'is_contracts_manager',
        'المالية': 'is_finance_manager',
        'التسويق': 'is_marketing_manager',
        'الشؤون القانونية': 'is_legal_manager'
    };

    switch (requestType) {
        case 'permission':
            const permissionReason = modal.querySelector('#permission-reason').value;
            if (!permissionReason.trim()) { alert('اكتب السبب.'); isValid = false; }
            details = { reason: permissionReason };
            requestTypeText = 'استئذان';
            
            if (isFieldStaff) {
                newStatus = 'بانتظار موافقة المشرف';
                notifyToRole = 'مشرف';
                notifyLink = '/supervisor-permission-requests';
            } else {
                newStatus = 'بانتظار موافقة مدير القسم'; 
                notifyToRole = managerMap[currentUser.role] || 'مدير النظام'; 
                notifyLink = '/high-command'; // المدراء يرون الطلبات في تبويب "طلبات القسم"
            }
            break;

        case 'leave':
            const leaveType = modal.querySelector('#leave-type').value;
            const leaveStartDate = modal.querySelector('#leave-start-date').value;
            const leaveEndDate = modal.querySelector('#leave-end-date').value;
            const leaveReason = modal.querySelector('#leave-reason').value;
            if (!leaveType || !leaveStartDate || !leaveEndDate) { alert('بيانات ناقصة'); isValid = false; }
            const start = new Date(leaveStartDate);
            const end = new Date(leaveEndDate);
            const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
            details = { type: leaveType, start_date: leaveStartDate, end_date: leaveEndDate, days: diffDays, reason: leaveReason };
            requestTypeText = 'إجازة';
            newStatus = 'بانتظار موافقة الموارد البشرية';
            notifyToRole = 'ادارة الموارد البشرية';
            notifyLink = '/leave-requests';
            break;

        case 'loan':
            const loanAmount = parseFloat(modal.querySelector('#loan-amount').value);
            const loanReason = modal.querySelector('#loan-reason').value;
            if (!loanAmount) { alert('مبلغ خطأ'); isValid = false; }
            details = { amount: loanAmount, reason: loanReason };
            requestTypeText = 'سلفة';
            newStatus = 'بانتظار موافقة الموارد البشرية';
            notifyToRole = 'ادارة الموارد البشرية';
            notifyLink = '/loan-requests';
            break;

        case 'resignation':
            const resReason = modal.querySelector('#resignation-reason').value;
            if (!resReason) { alert('اكتب السبب'); isValid = false; }
            details = { reason: resReason };
            requestTypeText = 'استقالة';
            newStatus = 'بانتظار موافقة الموارد البشرية';
            notifyToRole = 'ادارة الموارد البشرية';
            notifyLink = '/resignation-requests';
            break;
    }

    if (!isValid) return;

    submitRequestBtn.disabled = true;
    submitRequestBtn.textContent = 'جاري الإرسال...';

    try {
        let attachmentUrl = null;
        const fileInput = modal.querySelector('input[type="file"]');
        if (fileInput?.files.length > 0) {
            attachmentUrl = await uploadFinancialAttachment(fileInput.files[0], 'employee_requests', currentUser.id);
            details.attachment_url = attachmentUrl;
        }

        const { error } = await supabaseClient.from('employee_requests').insert([{
            user_id: currentUser.id,
            request_type: requestType,
            details: details,
            status: newStatus
        }]);

        if (error) throw error;
        let managerQuery = supabaseClient.from('users').select('id');
        
        if (notifyToRole.startsWith('is_')) {
            managerQuery = managerQuery.eq(notifyToRole, true);
        } else {
            managerQuery = managerQuery.eq('role', notifyToRole);
            if (isFieldStaff && currentUser.region) managerQuery = managerQuery.eq('region', currentUser.region);
        }

        const { data: managers } = await managerQuery;
        if (managers?.length > 0) {
            sendNotification(managers.map(m => m.id), `طلب ${requestTypeText}`, `من: ${currentUser.name}`, notifyLink);
        }

        alert('تم الإرسال.');
        modal.classList.add('hidden');
        if(isFieldStaff) loadMyRequestsPage(); else loadAdminRequestsPage();

    } catch (error) {
        alert(error.message);
    } finally {
        submitRequestBtn.disabled = false;
        submitRequestBtn.textContent = 'إرسال الطلب';
    }
}
const actionBtn = event.target.closest('[data-action]');
if (actionBtn && actionBtn.dataset.requestId) {
    const requestId = actionBtn.dataset.requestId;
    const action = actionBtn.dataset.action;
    let success = false; // متغير لتتبع نجاح العملية

    if (action === 'approve') {
        if (confirm('هل أنت متأكد من قبول هذا الطلب؟')) {
            const { error } = await supabaseClient
                .from('employee_requests')
                .update({ status: 'مقبول' }) // تحديث الحالة إلى "مقبول"
                .eq('id', requestId);

            if (error) {
                alert('حدث خطأ أثناء قبول الطلب.');
                console.error('Approval error:', error);
            } else {
                alert('تم قبول الطلب بنجاح.');
                success = true;
            }
        }
    } else if (action === 'reject') {
        const reason = prompt('الرجاء إدخال سبب الرفض:');
        if (reason) { // نتأكد أن المشرف أدخل سبباً ولم يضغط "إلغاء"
            const { error } = await supabaseClient
                .from('employee_requests')
                .update({ status: 'مرفوض', rejection_reason: reason }) // تحديث الحالة وسبب الرفض
                .eq('id', requestId);

            if (error) {
                alert('حدث خطأ أثناء رفض الطلب.');
                console.error('Rejection error:', error);
            } else {
                alert('تم رفض الطلب.');
                success = true;
            }
        }
    }

    if (success) {
        loadPermissionRequests();
    }
}
    
});
document.body.addEventListener('change', function(event) {
    const target = event.target;
    if (target.classList.contains('shift-time-input')) {
        const shiftCard = target.closest('.shift-entry-card');
        if (shiftCard) {
            let totalHours = 0;
            const periods = shiftCard.querySelectorAll('.shift-period-item');
            periods.forEach(period => {
                const startTime = period.querySelector('.shift-start-time').value;
                const endTime = period.querySelector('.shift-end-time').value;
                if (startTime && endTime) {
                    const start = new Date(`1970-01-01T${startTime}`);
                    const end = new Date(`1970-01-01T${endTime}`);
                    let diff = (end - start) / (1000 * 60 * 60);
                    if (diff < 0) { diff += 24; }
                    totalHours += diff;
                }
            });
            const workHoursInput = shiftCard.querySelector('.shift-work-hours');
            if(workHoursInput) {
               workHoursInput.value = totalHours.toFixed(2);
            }
        }
    }
});
document.getElementById('confirm-payment-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const paymentId = document.getElementById('payment-id-for-confirmation').value;
    const notes = document.getElementById('payment-notes').value;
    const proofFile = document.getElementById('payment-proof-upload').files[0];

    if (!confirm('هل أنت متأكد من أنك قمت بتسليم المبلغ للحارس؟ هذا الإجراء نهائي.')) return;

    submitBtn.disabled = true;
    submitBtn.textContent = 'جاري التوثيق...';

    try {
        let proofUrl = null;
        if (proofFile) {
            const fileExt = proofFile.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
            const filePath = `payment-proofs/${currentUser.id}/${paymentId}-${fileName}`;
            const { data, error } = await supabaseClient.storage.from('job-applications').upload(filePath, proofFile);
            if (error) throw new Error('فشل رفع ملف الإثبات.');
            proofUrl = data.path;
        }
        const { data: paymentData, error: e1 } = await supabaseClient.from('coverage_payments').select('*').eq('id', paymentId).single();
        if (e1 || !paymentData) throw new Error('فشل جلب بيانات الدفعة الأساسية.');
        const { data: shiftData, error: e2 } = await supabaseClient.from('coverage_shifts').select('*').eq('id', paymentData.coverage_shift_id).single();
        if (e2) console.warn('لم يتم العثور على تفاصيل الوردية.');
        const { data: applicantData, error: e3 } = await supabaseClient.from('coverage_applicants').select('*, users:users!coverage_applicants_applicant_user_id_fkey(*)').eq('id', paymentData.applicant_id).single();
        if (e3) console.warn('لم يتم العثور على تفاصيل المتقدم.');
        const snapshot = {
                    covering_guard_info: {
            id: applicantData?.users?.id,
            name: paymentData.covering_guard_name,
            id_number: applicantData?.users?.id_number || applicantData?.id_number,
            phone: applicantData?.users?.phone || applicantData?.phone_number,
            iban: paymentData.applicant_iban,
            bank_name: applicantData?.users?.bank_name || applicantData?.bank_name,
            type: applicantData?.users ? 'موظف حالي' : 'خارجي',
            id_photo_url: applicantData?.id_photo_url || null,
            iban_certificate_url: applicantData?.iban_certificate_url || null
        },
            shift_info: shiftData,
            financial_info: {
                payment_amount: paymentData.payment_amount
            },
            decision_info: {
                supervisor_id: currentUser.id,
                supervisor_name: currentUser.name,
                decision: 'paid_from_custody',
                notes: notes,
                timestamp: new Date().toISOString(),
                payment_proof_url: proofUrl
            }
        };
        const { error: updateError } = await supabaseClient
            .from('coverage_payments')
            .update({
                status: 'paid_from_custody',
                decision_notes: notes,
                payment_proof_url: proofUrl,
                transaction_snapshot: snapshot,
                paid_by_supervisor_id: currentUser.id,
                decision_at: new Date()
            })
            .eq('id', paymentId);
        if (updateError) throw updateError;
        const newBalance = (currentUser.custody_balance || 0) - paymentData.payment_amount;
        await supabaseClient.from('users').update({ custody_balance: newBalance }).eq('id', currentUser.id);
        const tempAuthId = applicantData?.users?.auth_user_id;
        if (applicantData?.applicant_user_id && tempAuthId) {
            await supabaseClient.functions.invoke('delete-employee', { body: { user_id: applicantData.applicant_user_id, auth_user_id: tempAuthId } });
        }

        showToast('تم توثيق عملية الصرف بنجاح!', 'success');
        document.getElementById('confirm-payment-modal').classList.add('hidden');
        loadSupervisorCustodyPage(); // تحديث الصفحة

    } catch (error) {
        alert('حدث خطأ فادح: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'تأكيد الصرف النهائي';
    }
});
document.getElementById('exclude-payment-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const paymentId = document.getElementById('payment-id-for-exclusion').value;
    const reason = document.getElementById('exclusion-reason').value;

    if (!confirm('هل أنت متأكد من استبعاد هذه العملية؟ لن يتم صرف المبلغ للحارس.')) return;

    submitBtn.disabled = true;
    submitBtn.textContent = 'جاري الاستبعاد...';
    
    try {
        const { data: paymentData, error: e1 } = await supabaseClient.from('coverage_payments').select('*').eq('id', paymentId).single();
        if (e1 || !paymentData) throw new Error('فشل جلب بيانات الدفعة الأساسية.');

        const { data: shiftData, error: e2 } = await supabaseClient.from('coverage_shifts').select('*').eq('id', paymentData.coverage_shift_id).single();
        if (e2) console.warn('لم يتم العثور على تفاصيل الوردية.');

        const { data: applicantData, error: e3 } = await supabaseClient.from('coverage_applicants').select('*, users:users!coverage_applicants_applicant_user_id_fkey(*)').eq('id', paymentData.applicant_id).single();
        if (e3) console.warn('لم يتم العثور على تفاصيل المتقدم.');

        const snapshot = {
            covering_guard_info: {
            id: applicantData?.users?.id,
            name: paymentData.covering_guard_name,
            id_number: applicantData?.users?.id_number || applicantData?.id_number,
            phone: applicantData?.users?.phone || applicantData?.phone_number,
            iban: paymentData.applicant_iban,
            bank_name: applicantData?.users?.bank_name || applicantData?.bank_name,
            type: applicantData?.users ? 'موظف حالي' : 'خارجي',
            id_photo_url: applicantData?.id_photo_url || null,
            iban_certificate_url: applicantData?.iban_certificate_url || null
        },
            shift_info: shiftData,
            financial_info: {
                payment_amount: paymentData.payment_amount
            },
            decision_info: {
                supervisor_id: currentUser.id,
                supervisor_name: currentUser.name,
                decision: 'paid_from_custody',
                notes: notes,
                timestamp: new Date().toISOString(),
                payment_proof_url: proofUrl
            }
        };


        await supabaseClient.from('coverage_payments').update({
            status: 'excluded_by_supervisor',
            decision_notes: reason,
            transaction_snapshot: snapshot,
            paid_by_supervisor_id: currentUser.id,
            decision_at: new Date()
        }).eq('id', paymentId);
        const tempAuthId = applicantData?.users?.auth_user_id;
        if (applicantData?.applicant_user_id && tempAuthId) {
            await supabaseClient.functions.invoke('delete-employee', { body: { user_id: applicantData.applicant_user_id, auth_user_id: tempAuthId } });
        }

        showToast('تم استبعاد العملية بنجاح.', 'success');
        document.getElementById('exclude-payment-modal').classList.add('hidden');
        loadSupervisorCustodyPage();

    } catch (error) {
        alert('حدث خطأ: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'تأكيد الاستبعاد';
    }
});
document.getElementById('disburse-custody-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const supervisorId = document.getElementById('disburse-supervisor-id').value;
    const amount = parseFloat(document.getElementById('disbursement-amount').value);

    if (!supervisorId || !amount || amount <= 0) {
        return alert('الرجاء إدخال مبلغ صحيح.');
    }

    if (!confirm(`هل أنت متأكد من صرف مبلغ ${amount} ريال؟`)) return;

    submitBtn.disabled = true;

    try {
        const { data: supervisor, error: fetchError } = await supabaseClient
            .from('users')
            .select('custody_balance')
            .eq('id', supervisorId)
            .single();
        if (fetchError) throw new Error('فشل في جلب رصيد المشرف الحالي.');

        const balanceBefore = supervisor.custody_balance || 0;
        const balanceAfter = balanceBefore + amount;
        const { error: updateError } = await supabaseClient
            .from('users')
            .update({ custody_balance: balanceAfter })
            .eq('id', supervisorId);
        if (updateError) throw updateError;
        const { error: logError } = await supabaseClient
            .from('custody_disbursements')
            .insert({
                finance_user_id: currentUser.id,
                supervisor_user_id: supervisorId,
                amount: amount,
                supervisor_balance_before: balanceBefore,
                supervisor_balance_after: balanceAfter
            });
        if (logError) throw logError;

        showToast('تم صرف العهدة بنجاح.', 'success');
        document.getElementById('disburse-custody-modal').classList.add('hidden');
        loadFinanceSupervisorsOverview(); // تحديث القائمة

    } catch (error) {
        alert('حدث خطأ فادح: ' + error.message);
    } finally {
        submitBtn.disabled = false;
    }
});
document.body.addEventListener('click', function(event) {
    const openAbsenceModalBtn = event.target.closest('.open-manual-absence-btn');
    if (openAbsenceModalBtn) {
        event.preventDefault();
        const guardId = openAbsenceModalBtn.dataset.guardId;
        const guardName = openAbsenceModalBtn.dataset.guardName;
        const shiftSnapshot = openAbsenceModalBtn.dataset.shiftSnapshot;
        const shiftStart = openAbsenceModalBtn.dataset.shiftStart;
        let shiftEnd = openAbsenceModalBtn.dataset.shiftEnd;
        const isOvernight = openAbsenceModalBtn.dataset.isOvernight === 'true';
        const recordIdToOverwrite = openAbsenceModalBtn.dataset.recordIdToOverwrite || '';
        if (isOvernight) {
            const endDate = new Date(shiftEnd);
            endDate.setDate(endDate.getDate() + 1);
            const tzoffset = (new Date()).getTimezoneOffset() * 60000;
            shiftEnd = (new Date(endDate - tzoffset)).toISOString().slice(0, 16);
        }
        const modal = document.getElementById('manual-absence-modal');
        document.getElementById('manual-absence-guard-id').value = guardId;
        document.getElementById('manual-absence-guard-name').value = guardName;
        document.getElementById('manual-absence-guard-name-display').textContent = guardName;
        document.getElementById('manual-absence-shift-snapshot').value = shiftSnapshot;
        document.getElementById('manual-absence-shift-start').value = shiftStart;
        document.getElementById('manual-absence-shift-end').value = shiftEnd;
        document.getElementById('manual-absence-notes').value = ''; // إفراغ الملاحظات
        document.getElementById('manual-absence-record-id').value = recordIdToOverwrite; // حفظ الـ ID في الحقل المخفي

        modal.classList.remove('hidden');
    }
});
document.getElementById('manual-absence-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const saveBtn = document.getElementById('save-manual-absence-btn');
    const notes = document.getElementById('manual-absence-notes').value;
    const guardId = document.getElementById('manual-absence-guard-id').value;
    const shiftStartTime = new Date(document.getElementById('manual-absence-shift-start').value);
    const recordIdToOverwrite = document.getElementById('manual-absence-record-id').value;


    if (!notes.trim()) {
        return alert('الرجاء كتابة ملاحظة (سبب الغياب).');
    }

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i>';

    try {
    const isExcused = document.getElementById('manual-absence-with-excuse').checked;
    const file = document.getElementById('manual-absence-attachment').files[0];
    let attachmentUrl = null;
    if (isExcused && file) {
        const fileExt = file.name.split('.').pop();
        const fileName = `${guardId}-${Date.now()}.${fileExt}`;
        const filePath = `public/absence_excuses/${fileName}`;

        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('job-applications') // استخدام نفس الحاوية العامة
            .upload(filePath, file);

        if (uploadError) {
            throw new Error(`فشل رفع المرفق: ${uploadError.message}`);
        }
        attachmentUrl = uploadData.path;
    }
    if (!recordIdToOverwrite) {
        const { count: existingCount, error: checkError } = await supabaseClient
            .from('attendance')
            .select('*', { count: 'exact', head: true }) 
            .eq('guard_id', guardId)
            .gte('created_at', shiftStartTime.toISOString().split('T')[0] + 'T00:00:00.000Z')
            .lte('created_at', shiftStartTime.toISOString().split('T')[0] + 'T23:59:59.999Z');

        if (checkError) {
             throw new Error('خطأ أثناء التحقق من السجلات: ' + checkError.message);
        }
        if (existingCount > 0) {
            throw new Error('يوجد سجل حضور أو غياب مسجل مسبقاً لهذا الحارس اليوم.');
        }
    }

    const snapshot = JSON.parse(document.getElementById('manual-absence-shift-snapshot').value);
    const excuseText = isExcused ? ' (بعذر)' : '';

    const recordData = {
        guard_id: guardId,
        guard_name: document.getElementById('manual-absence-guard-name').value,
        shift_snapshot: snapshot,
        created_at: shiftStartTime.toISOString(),
        checkout_at: new Date(document.getElementById('manual-absence-shift-end').value).toISOString(),
        status: 'غياب',
        notes: `غياب يدوي${excuseText} (${currentUser.name}): ${notes}`,
        is_manual_entry: true,
        vacancy_id: snapshot.schedule_details[0]?.vacancy_id || null,
        project: snapshot.project,
        location: snapshot.location,
        region: snapshot.region,
        city: snapshot.city,
        is_excused: isExcused, 
        attachment_url: attachmentUrl,
        submitted_by_id: currentUser.id, // تسجيل هوية المشرف الذي رفع الغياب
        hr_review_status: 'pending_review' // تحديد أن هذا الغياب يحتاج مراجعة
    };
    let error;
    if (recordIdToOverwrite) {
        const { error: updateError } = await supabaseClient
            .from('attendance')
            .update(recordData)
            .eq('id', recordIdToOverwrite);
        error = updateError;
    } else {
        const { error: insertError } = await supabaseClient.from('attendance').insert(recordData);
        error = insertError;
    }
    if (error) throw error;

    showToast('تم تسجيل الغياب بنجاح.', 'success');
    document.getElementById('manual-absence-modal').classList.add('hidden');
    if (typeof loadGuardAttendancePage === 'function') {
        loadGuardAttendancePage();
    }

} catch (error) {
    alert('حدث خطأ: ' + error.message);
} finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = 'تأكيد وتسجيل الغياب';
    document.getElementById('manual-absence-form').reset();
    document.getElementById('absence-attachment-group').classList.add('hidden');
}
});
const absenceExcuseCheckbox = document.getElementById('manual-absence-with-excuse');
const attachmentGroup = document.getElementById('absence-attachment-group');

if (absenceExcuseCheckbox && attachmentGroup) {
    absenceExcuseCheckbox.addEventListener('change', function() {
        attachmentGroup.classList.toggle('hidden', !this.checked);
        if (!this.checked) {
            document.getElementById('manual-absence-attachment').value = '';
        }
    });
}

}); // <-- هذا هو القوس المهم الذي كان مفقوداً ويغلق DOMContentLoaded
document.body.addEventListener('click', async function(event) {
const openResignationModalBtn = event.target.closest('.open-supervisor-resignation-modal-btn');
if (openResignationModalBtn) {
    event.preventDefault();
    const requestId = openResignationModalBtn.dataset.requestId;
    const modal = document.getElementById('supervisor-replacement-modal');
    const select = document.getElementById('replacement-guard-select');

    document.getElementById('replacement-request-id').value = requestId;
    select.innerHTML = '<option value="">جاري تحميل الحراس المتاحين...</option>';
    modal.classList.remove('hidden');
    const { data: availableGuards, error } = await supabaseClient
        .from('users')
        .select('id, name, id_number')
        .eq('role', 'حارس أمن')
        .is('vacancy_id', null) // (الأهم: جلب المتاحين فقط)
        .not('employment_status', 'eq', 'مؤرشف')
        .order('name');

    if (error) {
        select.innerHTML = '<option value="">خطأ في التحميل</option>';
    } else if (availableGuards.length === 0) {
        select.innerHTML = '<option value="">لا يوجد حراس متاحون حالياً</option>';
    } else {
        select.innerHTML = '<option value="">-- اختر الحارس البديل --</option>';
        select.innerHTML += availableGuards.map(g => `<option value="${g.name}">${g.name} (${g.id_number})</option>`).join('');
    }
    return;
}
const openLegalReviewBtn = event.target.closest('.open-legal-resignation-review-btn');
if (openLegalReviewBtn) {
    event.preventDefault();
    const requestId = openLegalReviewBtn.dataset.requestId;
    const userId = openLegalReviewBtn.dataset.userId;
    const vacancyId = openLegalReviewBtn.dataset.vacancyId;

    const modal = document.getElementById('legal-review-modal');
    const container = document.getElementById('legal-review-details-container');

    document.getElementById('legal-review-request-id').value = requestId;
    document.getElementById('legal-review-user-id').value = userId;
    document.getElementById('legal-review-vacancy-id').value = vacancyId;

    container.innerHTML = '<p style="text-align: center;">جاري تحميل تفاصيل الطلب...</p>';
    modal.classList.remove('hidden');
    const { data: request, error } = await supabaseClient
        .from('employee_requests')
        .select('details, user:users!financial_requests_user_id_fkey(name)')
        .eq('id', requestId)
        .single();

    if (error || !request) {
        container.innerHTML = '<p style="color:red;">خطأ في جلب بيانات الطلب.</p>';
    } else {
        container.innerHTML = `
            <p><strong>الموظف مقدم الطلب:</strong> ${request.user.name}</p>
            <p><strong>السبب المذكور:</strong> ${request.details.reason}</p>
            <hr>
            <p style="font-weight:bold;"><strong>الحارس البديل المقترح:</strong> ${request.details.replacement_guard_name || 'لم يحدد'}</p>
        `;
    }
    return;
}
const finalApproveResignationBtn = event.target.closest('#final-approve-resignation-btn');
if (finalApproveResignationBtn) {
    event.preventDefault();
    const requestId = document.getElementById('legal-review-request-id').value;
    const userId = document.getElementById('legal-review-user-id').value;
    const vacancyId = document.getElementById('legal-review-vacancy-id').value;

    if (!confirm('هل أنت متأكد؟ سيتم اعتماد الاستقالة وتعطيل حساب الموظف فوراً.')) return;

    finalApproveResignationBtn.disabled = true;
    finalApproveResignationBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري المعالجة...';

    try {
        const { error: e1 } = await supabaseClient
            .from('employee_requests')
            .update({ 
                status: 'مقبول',
                legal_approver_id: currentUser.id 
            })
            .eq('id', requestId);
        if (e1) throw e1;
        let preservedLocationData = {};
        if (vacancyId) {
            const { data: vacData } = await supabaseClient
                .from('job_vacancies')
                .select('region, location') // location في جدول الشواغر تعني المدينة
                .eq('id', vacancyId)
                .single();
            
            if (vacData) {
                preservedLocationData = {
                    region: vacData.region,
                    city: vacData.location // حفظ المدينة
                };
            }
        }
        const { error: e2 } = await supabaseClient
            .from('users')
            .update({ 
                employment_status: 'مستقيل', 
                vacancy_id: null,
                ...preservedLocationData // دمج البيانات المحفوظة (المنطقة والمدينة)
            })
            .eq('id', userId);
        if (e2) throw e2;
        if (vacancyId) {
            await supabaseClient.from('job_vacancies').update({ status: 'open' }).eq('id', vacancyId);
        }

        showToast('تم اعتماد الاستقالة، وتم حفظ بيانات آخر موقع للموظف.', 'success');
        document.getElementById('legal-review-modal').classList.add('hidden');
        loadLegalResignationsPage(); // تحديث قائمة القانونية

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        finalApproveResignationBtn.disabled = false;
        finalApproveResignationBtn.innerHTML = 'اعتماد نهائي (وتعطيل الحساب)';
    }
    return;
}
const finalRejectResignationBtn = event.target.closest('#final-reject-resignation-btn');
if (finalRejectResignationBtn) {
    event.preventDefault();
    const requestId = document.getElementById('legal-review-request-id').value;
    const reason = prompt('الرجاء كتابة سبب الرفض:');
    if (!reason) return;

    finalRejectResignationBtn.disabled = true;
    try {
        await supabaseClient.from('employee_requests').update({ status: 'مرفوض', rejection_reason: reason }).eq('id', requestId);
        showToast('تم رفض الطلب.', 'success');
        document.getElementById('legal-review-modal').classList.add('hidden');
        loadLegalResignationsPage();
    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        finalRejectResignationBtn.disabled = false;
    }
    return;
}
const viewAbsenceAttachmentBtn = event.target.closest('.hr-view-absence-attachment-btn');
if (viewAbsenceAttachmentBtn) {
    event.preventDefault();
    const fileUrl = viewAbsenceAttachmentBtn.dataset.url;
    if (!fileUrl) return alert('لا يوجد مسار ملف صالح.');

    viewAbsenceAttachmentBtn.disabled = true;
    try {
        const { data, error } = await supabaseClient.storage
            .from('job-applications') // الحاوية العامة
            .createSignedUrl(fileUrl, 300); // صلاحية 5 دقائق

        if (error) throw error;
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const zoomedImage = document.getElementById('zoomed-image');
        zoomedImage.src = data.signedUrl;
        imageViewerModal.classList.remove('hidden');

    } catch (error) {
        alert('فشل في إنشاء رابط آمن للملف: ' + error.message);
    } finally {
        viewAbsenceAttachmentBtn.disabled = false;
    }
    return;
}
const approveAbsenceBtn = event.target.closest('.hr-approve-absence-btn');
if (approveAbsenceBtn) {
    event.preventDefault();
    const attendanceId = approveAbsenceBtn.dataset.id;
    const isExcused = approveAbsenceBtn.dataset.excused === 'true'; // تحويلها إلى boolean
    const actionText = isExcused ? 'بعذر' : 'بدون عذر';

    if (!confirm(`هل أنت متأكد من اعتماد هذا الغياب كـ "${actionText}"؟`)) {
        return;
    }

    approveAbsenceBtn.disabled = true;

    try {
        const { error } = await supabaseClient
            .from('attendance')
            .update({
                is_excused: isExcused, // تحديث الحالة النهائية
                hr_review_status: 'reviewed', // تغيير الحالة إلى "تمت المراجعة"
                hr_reviewed_by_id: currentUser.id // تسجيل هوية المراجع
            })
            .eq('id', attendanceId);

        if (error) throw error;

        showToast('تم اعتماد الغياب بنجاح.', 'success');
        loadPendingAbsences(); // إعادة تحميل قائمة المراجعة

    } catch (error) {
        alert('حدث خطأ: ' + error.message);
        approveAbsenceBtn.disabled = false;
    }
    return;
}
    const addVehicleToSiteBtn = event.target.closest('.add-vehicle-to-site-btn');
    if (addVehicleToSiteBtn) {
        const contractId = addVehicleToSiteBtn.dataset.contractId;
        const locationName = addVehicleToSiteBtn.dataset.locationName;

        if (!contractId || !locationName) return alert('خطأ: بيانات الموقع غير موجودة.');

        const modal = document.getElementById('vehicle-modal');
        document.getElementById('vehicle-modal-title').textContent = `إضافة مركبة لموقع: ${locationName}`;
        document.getElementById('vehicle-form').reset();
        document.getElementById('vehicle-id').value = '';
        const contractSelect = document.getElementById('vehicle-contract-select');
        const locationSelect = document.getElementById('vehicle-location-select');
        const { data: contracts } = await supabaseClient.from('contracts').select('id, company_name, contract_locations').eq('status', 'active');
        if (contracts) {
            contractSelect.innerHTML = '<option value="">-- اختر عقداً --</option>';
            contractSelect.innerHTML += contracts.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
            contractSelect.value = contractId; // تحديد العقد تلقائياً
        }
        const selectedContract = contracts.find(c => c.id == contractId);
        if (selectedContract && selectedContract.contract_locations) {
            locationSelect.innerHTML = '<option value="">-- اختر موقعاً --</option>';
            locationSelect.innerHTML += selectedContract.contract_locations.map(loc => `<option value="${loc.name}">${loc.name}</option>`).join('');
            locationSelect.value = locationName; // تحديد الموقع تلقائياً
            locationSelect.disabled = false;
        }

        document.getElementById('vehicle-status').value = 'فعالة';
        modal.classList.remove('hidden');
        return;
    }
const manageSiteAssetsBtn = event.target.closest('.manage-site-assets-btn');
if (manageSiteAssetsBtn) {
    const contractId = manageSiteAssetsBtn.dataset.contractId;
    const locationName = manageSiteAssetsBtn.dataset.locationName;
    const contractName = manageSiteAssetsBtn.closest('.site-row').dataset.contractName;
    
    document.getElementById('guard-asset-modal').classList.remove('hidden');
    populateGuardAssetModal(contractId, locationName, contractName);
    return;
}
const returnGuardAssetBtnNew = event.target.closest('.return-guard-asset-btn-new');
if (returnGuardAssetBtnNew) {
    const assetId = returnGuardAssetBtnNew.dataset.id;
    if (confirm('هل أنت متأكد من تسجيل ارتجاع هذا الجهاز إلى المخزون؟')) {
        try {
            const { error } = await supabaseClient
                .from('asset_items')
                .update({
                    status: 'متوفر في المخزن',
                    assigned_to_user_id: null,
                    contract_id: null,
                    location_name: null,
                    assignment_date: null
                })
                .eq('id', assetId);
            if (error) throw error;

            await supabaseClient.from('asset_history_log').insert({
                asset_item_id: assetId,
                event_description: 'تم تسجيل ارتجاع الجهاز إلى المخزون.',
                performed_by_user_id: currentUser.id
            });

            showToast('تم تسجيل الارتجاع بنجاح.', 'success');
            const contractId = document.getElementById('ga-modal-contract-id').value;
            const locationName = document.getElementById('ga-modal-location-name').value;
            const contractName = document.querySelector(`.site-row[data-contract-id="${contractId}"]`).dataset.contractName;
            
            populateGuardAssetModal(contractId, locationName, contractName); // تحديث بيانات النافذة
            loadGuardAssetsPage(); // تحديث الصفحة الرئيسية في الخلفية
        } catch (err) {
            alert('حدث خطأ: ' + err.message);
        }
    }
    return;
}
    const returnGuardAssetBtnOld = event.target.closest('.return-guard-asset-btn-old');
    if (returnGuardAssetBtnOld) {
        const assetId = returnGuardAssetBtnOld.dataset.id;
        if (confirm('هل أنت متأكد من تسجيل ارتجاع هذا الجهاز القديم؟ سيتم حذفه من السجلات القديمة.')) {
            try {
                const { error } = await supabaseClient.from('deployed_assets').delete().eq('id', assetId);
                if (error) throw error;

                showToast('تم تسجيل الارتجاع بنجاح.', 'success');
                const contractId = document.getElementById('ga-modal-contract-id').value;
                const locationName = document.getElementById('ga-modal-location-name').value;
                const contractName = document.querySelector(`.site-row[data-contract-id="${contractId}"]`).dataset.contractName;
                
                populateGuardAssetModal(contractId, locationName, contractName);
                loadGuardAssetsPage();
            } catch (err) {
                alert('حدث خطأ: ' + err.message);
            }
        }
        return;
    }


    const editClientBtn = event.target.closest('.edit-client-status-btn');
    if (editClientBtn) {
        const modal = document.getElementById('marketing-client-modal');
        const starsContainer = document.getElementById('marketing-client-rating-stars');
        document.getElementById('marketing-contract-id').value = editClientBtn.dataset.contractId;
        document.getElementById('marketing-client-status').value = editClientBtn.dataset.status;
        document.getElementById('marketing-last-contact').value = editClientBtn.dataset.contactDate;
        document.getElementById('marketing-notes').value = editClientBtn.dataset.notes;
        const currentRating = parseInt(editClientBtn.dataset.rating) || 0;
        starsContainer.dataset.rating = currentRating;
        Array.from(starsContainer.children).forEach(star => {
            const starValue = parseInt(star.dataset.value);
            if (starValue <= currentRating) {
                star.classList.replace('ph-bold', 'ph-fill');
                star.style.color = '#f59e0b';
            } else {
                star.classList.replace('ph-fill', 'ph-bold');
                star.style.color = '#cbd5e1';
            }
        });

        modal.classList.remove('hidden');
    }
    const starInput = event.target.closest('#marketing-client-rating-stars i');
    if (starInput) {
        const container = starInput.parentElement;
        const rating = starInput.dataset.value;
        container.dataset.rating = rating; // تخزين التقييم في الحاوية
        Array.from(container.children).forEach(star => {
            if (star.dataset.value <= rating) {
                star.classList.replace('ph-bold', 'ph-fill');
                star.style.color = '#f59e0b';
            } else {
                star.classList.replace('ph-fill', 'ph-bold');
                star.style.color = '#cbd5e1';
            }
        });
    }
    const saveMarketingBtn = event.target.closest('#save-marketing-data-btn');
    if (saveMarketingBtn) {
        saveMarketingBtn.disabled = true;
        saveMarketingBtn.textContent = 'جاري الحفظ...';

        try {
            const contractId = document.getElementById('marketing-contract-id').value;
            const rating = document.getElementById('marketing-client-rating-stars').dataset.rating || null;

            const marketingData = {
                contract_id: contractId,
                client_status: document.getElementById('marketing-client-status').value,
                last_contact_date: document.getElementById('marketing-last-contact').value || null,
                notes: document.getElementById('marketing-notes').value,
                client_rating: rating ? parseInt(rating) : null
            };

            const { error } = await supabaseClient
                .from('marketing_client_data')
                .upsert(marketingData, { onConflict: 'contract_id' });

            if (error) throw error;

            showToast('تم حفظ البيانات بنجاح!', 'success');
            document.getElementById('marketing-client-modal').classList.add('hidden');
            loadMarketingClientsPage();

        } catch (error) {
            console.error('Error saving marketing data:', error);
            alert('حدث خطأ أثناء الحفظ.');
        } finally {
            saveMarketingBtn.disabled = false;
            saveMarketingBtn.textContent = 'حفظ التغييرات';
        }
    }
const addEventBtn = event.target.closest('#add-marketing-event-btn');
if (addEventBtn) {
    const modal = document.getElementById('marketing-event-modal');
    document.getElementById('marketing-event-modal-title').textContent = 'إضافة موعد جديد';
    document.getElementById('marketing-event-form').reset();
    document.getElementById('marketing-event-id').value = '';
    const contractSelect = document.getElementById('marketing-event-contract');
    contractSelect.innerHTML = '<option value="">جاري تحميل العملاء...</option>';
    const { data: contracts, error } = await supabaseClient.from('contracts').select('id, company_name').eq('status', 'active');
    if (contracts) {
        contractSelect.innerHTML = '<option value="">بدون ربط</option>' + contracts.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
    }
    modal.classList.remove('hidden');
}
const editEventBtn = event.target.closest('.edit-marketing-event-btn, .fc-event-edit-btn');
if (editEventBtn) {
    const eventData = JSON.parse(editEventBtn.dataset.event);
    const modal = document.getElementById('marketing-event-modal');
    document.getElementById('marketing-event-modal-title').textContent = 'تعديل موعد';
    document.getElementById('marketing-event-form').reset();
    const toLocalISOString = (date) => date ? new Date(new Date(date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
    document.getElementById('marketing-event-id').value = eventData.id;
    document.getElementById('marketing-event-title').value = eventData.event_title;
    document.getElementById('marketing-event-start').value = toLocalISOString(eventData.event_start);
    document.getElementById('marketing-event-end').value = toLocalISOString(eventData.event_end);
    document.getElementById('marketing-event-description').value = eventData.event_description || '';
    document.getElementById('marketing-reminder-datetime').value = toLocalISOString(eventData.reminder_datetime);
    const contractSelect = document.getElementById('marketing-event-contract');
    contractSelect.innerHTML = '<option value="">جاري تحميل العملاء...</option>';
    const { data: contracts, error } = await supabaseClient.from('contracts').select('id, company_name').eq('status', 'active');
    if (contracts) {
        contractSelect.innerHTML = '<option value="">بدون ربط</option>' + contracts.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
        contractSelect.value = eventData.contract_id || '';
    }

    modal.classList.remove('hidden');
}
    const deleteEventBtn = event.target.closest('#delete-marketing-event-btn');
if (deleteEventBtn) {
    const eventId = document.getElementById('marketing-event-id').value;
    if (!eventId) {
        return alert('لا يمكن حذف موعد لم يتم حفظه بعد.');
    }

    if (confirm('هل أنت متأكد من حذف هذا الموعد نهائيًا؟')) {
        const { error } = await supabaseClient.from('marketing_calendar').delete().eq('id', eventId);
        if (error) {
            alert('حدث خطأ أثناء الحذف.');
        } else {
            showToast('تم حذف الموعد بنجاح.', 'success');
            document.getElementById('marketing-event-modal').classList.add('hidden');
            loadMarketingCalendarPage();
        }
    }
}

document.getElementById('delete-legal-event-btn')?.addEventListener('click', async function() {
    const eventId = document.getElementById('legal-event-id').value;
    if (!eventId) return;

    if (confirm('هل أنت متأكد من حذف هذا الموعد نهائيًا؟')) {
        const { error } = await supabaseClient.from('legal_calendar').delete().eq('id', eventId);
        if (error) {
            alert('حدث خطأ أثناء الحذف.');
        } else {
            showToast('تم حذف الموعد بنجاح.', 'success');
            document.getElementById('legal-event-modal').classList.add('hidden');
            loadLegalCalendarPage();
        }
    }
});


const addLegalEventBtn = event.target.closest('#add-legal-event-btn');
if (addLegalEventBtn) {
    openLegalEventModal(); // فتح نافذة فارغة
}

});
document.body.addEventListener('input', function(event) {
    if (event.target.id === 'assignment-modal-search-location') {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            const filters = {
                region: document.getElementById('assignment-modal-filter-region').value,
                contract: document.getElementById('assignment-modal-filter-contract').value,
                search: document.getElementById('assignment-modal-search-location').value
            };
            renderAssignmentLists(filters);
        }, 300); // الانتظار 300 مللي ثانية بعد توقف المستخدم عن الكتابة
    }
});
const loginForm = document.getElementById('login-form');
if (loginForm) {
    loginForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        console.log('%c--- بدأنا عملية تسجيل الدخول (النظام الجديد) ---', 'color: blue; font-weight: bold;');

        const idNumber = convertArabicNumeralsToEnglish(document.getElementById('id-number').value);
        const password = convertArabicNumeralsToEnglish(document.getElementById('password').value);
        const loginBtn = loginForm.querySelector('button[type="submit"]');

        if (!idNumber || !password) {
            return alert('الرجاء إدخال رقم الهوية وكلمة المرور.');
        }

        loginBtn.innerHTML = 'جاري التحقق...';
        loginBtn.disabled = true;
       const loginEmail = `${idNumber}@arknat-system.com`;
        const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
            email: loginEmail,
            password: password,
        });

        if (authError) {
            console.error('!!! فشل تسجيل الدخول:', authError.message);
            alert('رقم الهوية أو كلمة المرور غير صحيحة.');
            loginBtn.disabled = false;
            loginBtn.innerHTML = 'تسجيل الدخول';
            return;
        }
        if (authData.user) {
            const { data: userProfile, error: profileError } = await supabaseClient
                .from('users')
                .select('*')
                .eq('auth_user_id', authData.user.id) // الربط باستخدام هوية المصادقة
                .single();

            if (profileError || !userProfile) {
                console.error('!!! لم يتم العثور على ملف تعريف للمستخدم:', profileError);
                alert('حدث خطأ أثناء جلب بيانات المستخدم.');
                await supabaseClient.auth.signOut();
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'تسجيل الدخول';
                return;
            }

            await supabaseClient.from('audit_logs').insert({ user_id: userProfile.auth_user_id, user_name: userProfile.name, action_type: 'تسجيل دخول ناجح', details: { role: userProfile.role } });
initializeUserSession(userProfile);
        }

        loginBtn.disabled = false;
        loginBtn.innerHTML = 'تسجيل الدخول';
        console.log('%c--- انتهت عملية تسجيل الدخول ---', 'color: blue; font-weight: bold;');
    });
/**
 * دالة للبحث عن سجل غياب/انسحاب/استئذان وتحديثه عند تأكيد التغطية
 * @param {number} shiftId - معرّف وردية التغطية التي تمت
 * @param {string} coveringGuardName - اسم الحارس الذي قام بالتغطية
 */
async function updateOriginalAttendanceOnCoverage(shiftId, coveringGuardName) {
    if (!shiftId || !coveringGuardName) return;

    try {
        const { data: coverageShift, error: shiftError } = await supabaseClient
            .from('coverage_shifts')
            .select('covered_user_id, created_at')
            .eq('id', shiftId)
            .single();
        if (shiftError || !coverageShift || !coverageShift.covered_user_id) {
            console.log('No absent guard linked to this coverage, skipping attendance update.');
            return;
        }

        const absentGuardId = coverageShift.covered_user_id;
        const shiftDate = new Date(coverageShift.created_at).toISOString().split('T')[0];
        const { data: attendanceRecord, error: attendanceError } = await supabaseClient
            .from('attendance')
            .select('id, status')
            .eq('guard_id', absentGuardId)
            .like('created_at', `${shiftDate}%`) // البحث في اليوم المحدد
            .in('status', ['غياب', 'انسحاب', 'استئذان']) // نبحث فقط عن هذه الحالات
            .limit(1)
            .single();

        if (attendanceError || !attendanceRecord) {
            console.log(`No relevant attendance record found for guard ${absentGuardId} on ${shiftDate}.`);
            return;
        }
        const newStatus = `${attendanceRecord.status} (تم تغطيته)`;
        const newNotes = `تمت التغطية بواسطة: ${coveringGuardName}`;

        const { error: updateError } = await supabaseClient
            .from('attendance')
            .update({ status: newStatus, notes: newNotes })
            .eq('id', attendanceRecord.id);

        if (updateError) throw updateError;

        console.log(`Successfully updated attendance record ${attendanceRecord.id} for the absent guard.`);

    } catch (error) {
        console.error("Error in updateOriginalAttendanceOnCoverage:", error);
    }
}
}
async function loadMyRequestsPage() {
    const requestsContent = document.querySelector('#page-my-requests');
    requestsContent.innerHTML = `
        <div class="page-header"><h3>رفع طلب جديد</h3></div>
        <div class="requests-actions-container">
            <button class="request-action-card" data-request-type="permission" style="--card-color: #0d6efd;"><i class="ph-fill ph-clock-countdown"></i><h4>طلب استئذان</h4></button>
            <button class="request-action-card" data-request-type="leave" style="--card-color: #198754;"><i class="ph-fill ph-calendar-blank"></i><h4>طلب إجازة</h4></button>
            <button class="request-action-card" data-request-type="loan" id="loan-request-btn" style="--card-color: #ffc107;"><i class="ph-fill ph-hand-coins"></i><h4>طلب سلفة</h4></button>
            <button class="request-action-card" data-request-type="resignation" style="--card-color: #dc3545;"><i class="ph-fill ph-file-x"></i><h4>طلب استقالة</h4></button>
        </div>
        <div class="page-header" style="margin-top: 40px;"><h3>متابعة طلباتك السابقة</h3></div>
        <div id="past-requests-list"><p style="text-align: center; padding: 20px; color: var(--text-secondary);">جاري تحميل طلباتك...</p></div>
    `;
    const pastRequestsList = document.getElementById('past-requests-list');
    if (!currentUser) {
        pastRequestsList.innerHTML = '<p>الرجاء تسجيل الدخول لعرض طلباتك.</p>';
        return;
    }
    const loanButton = document.getElementById('loan-request-btn');
    if (loanButton) {
        loanButton.disabled = true;
        loanButton.style.opacity = '0.6';
        loanButton.style.cursor = 'not-allowed';
        loanButton.querySelector('h4').textContent = 'جاري التحقق...';

        try {
            const { data: vacancyData, error: vacancyError } = await supabaseClient
                .from('job_vacancies')
                .select('base_salary')
                .eq('id', currentUser.vacancy_id)
                .single();

            if (vacancyError || !vacancyData || !vacancyData.base_salary || vacancyData.base_salary === 0) {
                throw new Error('لم يتم تحديد الراتب الأساسي لك.');
            }
            const baseSalary = vacancyData.base_salary;
            const maxLoan = baseSalary * 0.25;
            const fifteenDaysAgo = new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString();
            const { data: absenceCheck, error: absenceError } = await supabaseClient
                .from('attendance')
                .select('id')
                .eq('guard_id', currentUser.id)
                .eq('status', 'غياب')
                .gte('created_at', fifteenDaysAgo);

            if (absenceError) throw absenceError;

            if (absenceCheck && absenceCheck.length > 0) {
                loanButton.querySelector('h4').textContent = 'غير مؤهل (بسبب الغياب)';
            } else {
                loanButton.disabled = false;
                loanButton.style.opacity = '1';
                loanButton.style.cursor = 'pointer';
                loanButton.querySelector('h4').textContent = 'طلب سلفة';
                loanButton.dataset.maxLoan = maxLoan; // تخزين الحد الأقصى في الزر
            }

        } catch (error) {
            console.error("Loan Eligibility Error:", error.message);
            loanButton.querySelector('h4').textContent = 'غير متاح حالياً';
        }
    }
    const { data: requests, error } = await supabaseClient
        .from('employee_requests')
        .select('*')
        .eq('user_id', currentUser.id) // فلترة الطلبات للمستخدم الحالي فقط
        .order('created_at', { ascending: false }); // عرض الأحدث أولاً

    if (error) {
        console.error('خطأ في جلب الطلبات:', error);
        pastRequestsList.innerHTML = '<p>حدث خطأ أثناء تحميل الطلبات.</p>';
        return;
    }
    if (requests.length === 0) {
        pastRequestsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">لا توجد طلبات سابقة لعرضها.</p>';
    } else {
        pastRequestsList.innerHTML = '';
        requests.forEach(request => {
            let statusClass, statusText;
            switch (request.status) {
                case 'مقبول':
                    statusClass = 'approved'; statusText = 'مقبول'; break;
                case 'مرفوض':
                    statusClass = 'denied'; statusText = 'مرفوض'; break;
                case 'بانتظار موافقة مدير العمليات':
                    statusClass = 'pending'; statusText = 'بانتظار موافقة المدير'; break;
                case 'بانتظار موافقة الموارد البشرية':
                    statusClass = 'pending'; statusText = 'بانتظار موافقة الموارد'; break;
                case 'بانتظار مراجعة الموارد البشرية':
                    statusClass = 'pending'; statusText = 'قيد المراجعة النهائية'; break;
                default:
                    statusClass = 'pending'; statusText = 'معلق';
            }
            let requestTypeText;
            switch(request.request_type) {
                case 'leave': requestTypeText = 'طلب إجازة'; break;
                case 'loan': requestTypeText = 'طلب سلفة'; break;
                case 'permission': requestTypeText = 'طلب استئذان'; break;
                case 'resignation': requestTypeText = 'طلب استقالة'; break;
                default: requestTypeText = request.request_type;
            }

            const requestCard = `
                <div class="request-card">
                    <div class="request-card-header">
                        <h4>${requestTypeText}</h4>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="request-card-body">
                        <p><strong>تاريخ الطلب:</strong> ${formatGregorianDate(request.created_at)}</p>
                        ${request.details && request.details.reason ? `<p><strong>السبب:</strong> ${request.details.reason}</p>` : ''}
                        ${request.details && request.details.days ? `<p><strong>عدد الأيام:</strong> ${request.details.days}</p>` : ''}
                        ${request.details && request.details.amount ? `<p><strong>المبلغ:</strong> ${request.details.amount} ر.س</p>` : ''}
                    </div>
                    ${request.status === 'مرفوض' && request.rejection_reason ? `
                    <div class="request-card-footer">
                        <strong>سبب الرفض:</strong> ${request.rejection_reason}
                    </div>` : ''}
                </div>
            `;
            pastRequestsList.insertAdjacentHTML('beforeend', requestCard);
        });
    }
    if (activeSubscription) supabaseClient.removeChannel(activeSubscription); // <-- تعديل: إيقاف الاشتراك القديم أولاً
    activeSubscription = supabaseClient
        .channel(`public:employee_requests:user:${currentUser.id}`)
        .on(
            'postgres_changes',
            { 
                event: '*', 
                schema: 'public', 
                table: 'employee_requests',
                filter: `user_id=eq.${currentUser.id}`
            },
            (payload) => {
                console.log('Realtime update for my requests!', payload);
                loadMyRequestsPage();
            }
        )
        .subscribe();
    
    console.log('Subscribed to my personal requests.');
}
document.addEventListener('DOMContentLoaded', () => {
const dataEntryPage = document.getElementById('page-hr-data-entry');
if(dataEntryPage) {
    const downloadBtn = document.getElementById('download-template-btn');
    downloadBtn.addEventListener('click', downloadEmployeeTemplate);
    const uploadBtn = document.getElementById('upload-employees-file-btn');
    const fileInput = document.getElementById('employees-file-input');
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            processEmployeeFile(file);
        }
    });
}
document.getElementById('feedback-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const content = document.getElementById('feedback-content').value;
    if (!content.trim()) return alert('الرجاء كتابة محتوى الرسالة.');

    const feedbackData = {
        user_id: currentUser?.auth_user_id || null,
        user_name: currentUser?.name || 'زائر',
        feedback_type: document.getElementById('feedback-type').value,
        content: content,
        status: 'جديدة'
    };

    const { error } = await supabaseClient.from('feedback').insert(feedbackData);
    if (error) {
        alert('حدث خطأ أثناء الإرسال.');
    } else {
        alert('تم إرسال رسالتك بنجاح. شكراً لك.');
        document.getElementById('feedback-modal').classList.add('hidden');
        this.reset();
    }
});
document.getElementById('hr-send-sms-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const submitBtn = document.getElementById('hr-submit-sms-btn');
    const recipient = document.getElementById('sms-recipient').value;
    const message = document.getElementById('sms-content').value;

    if (!recipient || !message) {
        return alert('الرجاء إدخال رقم الجوال ونص الرسالة.');
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الإرسال...';

    try {
        const { data, error } = await supabaseClient.functions.invoke('send-sms', {
            body: { to: recipient, message: message },
        });

        if (error) throw error;
        if (data.error) throw new Error(data.error);

        alert('تم إرسال الرسالة بنجاح!');
        this.reset(); // إفراغ الحقول بعد النجاح
    } catch (err) {
        alert(`فشل إرسال الرسالة: ${err.message}`);
        console.error("SMS Sending Error:", err);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="ph-bold ph-paper-plane-right"></i> إرسال الرسالة';
    }
});
    const imageViewerModal = document.getElementById('image-viewer-modal');
    if (!imageViewerModal) return; 

    const zoomedImage = document.getElementById('zoomed-image');
    const closeBtn = imageViewerModal.querySelector('.modal-close-btn');
    const closeModal = () => {
        imageViewerModal.classList.add('hidden');
        zoomedImage.src = ''; // إفراغ الصورة لمنع ظهورها للحظة عند الفتح مرة أخرى
    };
    document.addEventListener('click', function(event) {
const addNewCategoryBtn = event.target.closest('#add-new-asset-category-btn');
if (addNewCategoryBtn) {
    const modal = document.getElementById('add-edit-category-modal');
    document.getElementById('category-modal-title').textContent = 'إضافة فئة عهدة جديدة';
    modal.querySelector('form').reset();
    document.getElementById('category-id').value = '';
    document.getElementById('category-fields-container').innerHTML = '';

    modal.classList.remove('hidden');
    return;
}
const addFieldBtn = event.target.closest('#add-category-field-btn');
if (addFieldBtn) {
    const container = document.getElementById('category-fields-container');
    const fieldHtml = `
        <div class="clause-item category-field-row">
            <input type="text" class="clause-item-input category-field-name" placeholder="اكتب اسم الحقل هنا (مثال: الرقم التسلسلي)">
            <button type="button" class="delete-btn delete-category-field-btn" title="حذف الحقل"><i class="ph-bold ph-trash"></i></button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', fieldHtml);
    return;
}
const deleteFieldBtn = event.target.closest('.delete-category-field-btn');
if (deleteFieldBtn) {
    deleteFieldBtn.closest('.category-field-row').remove();
    return;
}


        const target = event.target;
        if (target.classList.contains('viewable-image')) {
            if (target.src && !target.src.endsWith('placeholder.png')) {
                zoomedImage.src = target.src;
                imageViewerModal.classList.remove('hidden');
            } else {
                alert('لا يمكن عرض هذه الصورة حالياً.');
            }
        }
    });
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    imageViewerModal.addEventListener('click', (event) => {
        if (event.target === imageViewerModal) {
            closeModal();
        }
    });
async function initializeContractFilters() {
    const data = await getFilterData(); // إعادة استخدام الدالة الموجودة لجلب البيانات
    const regionSelect = document.getElementById('contract-filter-region');
    if (!regionSelect) return;

    const regions = Object.keys(data).sort();
    regionSelect.innerHTML = '<option value="">كل المناطق</option>';
    regions.forEach(region => {
        regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
    });
}
document.body.addEventListener('change', async function(event) {
    if (event.target.classList.contains('cascading-filter-contracts')) {
        const regionSelect = document.getElementById('contract-filter-region');
        const citySelect = document.getElementById('contract-filter-city');

        citySelect.innerHTML = '<option value="">اختر منطقة أولاً</option>';
        citySelect.disabled = true;

        const selectedRegion = regionSelect.value;
        if (selectedRegion) {
            const data = await getFilterData();
            if (data[selectedRegion]) {
                const cities = Object.keys(data[selectedRegion]).sort();
                let optionsHtml = '<option value="">كل المدن</option>';
                cities.forEach(city => {
                    optionsHtml += `<option value="${city}">${city}</option>`;
                });
                citySelect.innerHTML = optionsHtml;
                citySelect.disabled = false;
            }
        }
        fetchContracts(); // تحديث القائمة عند تغيير المنطقة
    }
    if (event.target.id === 'contract-filter-city') {
        fetchContracts();
    }
});
document.body.addEventListener('keyup', function(event) {
    if (event.target.id === 'contract-filter-search') {
        fetchContracts();
    }
    
});
});
document.addEventListener('customSelect:change', async (event) => {
    if (event.target.id === 'blacklist-fetch-user') { // <-- تم تغيير الـ ID هنا
        const hiddenInput = event.target;
        const searchInput = document.getElementById('blacklist-fetch-user-search');
        const optionsContainer = document.getElementById('blacklist-fetch-user-options');
        const optionElement = optionsContainer.querySelector(`.custom-select-option[data-value="${hiddenInput.value}"]`);

        if (optionElement && optionElement.dataset.details) {
            try {
                const details = JSON.parse(optionElement.dataset.details);
                if (document.getElementById('blacklist-add-modal').classList.contains('hidden')) {
                    document.getElementById('lawsuit-plaintiff').value = details.name || '';
                } else {
                    document.getElementById('blacklist-name').value = details.name || '';
                    document.getElementById('blacklist-id-number').value = details.id_number || '';
                }
            } catch (e) {
                console.error("Error parsing fetch details:", e);
            }
        }
    }
    if (event.target.id === 'admin-asset-type') {
    const inventoryId = event.target.value;
    const itemGroup = document.getElementById('admin-asset-item-group');
    const serialInput = document.getElementById('admin-asset-serial');
    document.getElementById('admin-asset-item').value = ''; // <-- هنا تم التصحيح
    document.getElementById('admin-asset-item-search').value = '';
    serialInput.value = '';

    if (inventoryId) {
        itemGroup.classList.remove('hidden'); // إظهار حقل اختيار القطعة
        const { data: items } = await supabaseClient
            .from('asset_items')
            .select('id, details')
            .eq('inventory_id', inventoryId)
            .eq('status', 'في المخزن');

        const options = (items || []).map(item => {
            const details = item.details || {};
            const text = Object.values(details).join(' - ') || `قطعة رقم ${item.id}`;
            return { id: item.id, text: text, details: details };
        });

        setupSearchableSelect('admin-asset-item', options);
    } else {
        itemGroup.classList.add('hidden'); // إخفاء الحقل إذا لم يتم اختيار شيء
    }
}
if (event.target.id === 'admin-asset-item') {
    const hiddenInput = event.target;
    const searchInput = document.getElementById('admin-asset-item-search');
    const optionsContainer = document.getElementById('admin-asset-item-options');
    const optionElement = optionsContainer.querySelector(`.custom-select-option[data-value="${hiddenInput.value}"]`);

    if (optionElement && optionElement.dataset.details) {
        try {
            const details = JSON.parse(optionElement.dataset.details);
            const serialNumber = details.serial_number || details.phone_number || details.identifier || 'لا يوجد';
            document.getElementById('admin-asset-serial').value = serialNumber;
        } catch (e) {
            console.error("Error parsing item details:", e);
            document.getElementById('admin-asset-serial').value = 'خطأ في البيانات';
        }
    }
}
});

/**
 * دالة مساعدة لتعبئة حقول الإدخال اليدوي في نافذة تعديل اللقطة
 * @param {object} snapshot - كائن اللقطة المراد عرض بياناته
 */
function fillSnapshotManualForm(snapshot) {
    if (!snapshot) return;
    document.getElementById('snapshot-manual-project').value = snapshot.project || '';
    document.getElementById('snapshot-manual-location').value = snapshot.location || '';
    document.getElementById('snapshot-manual-region').value = snapshot.region || '';
    document.getElementById('snapshot-manual-city').value = snapshot.city || '';
    document.getElementById('snapshot-manual-schedule').value = snapshot.schedule_details ? JSON.stringify(snapshot.schedule_details, null, 2) : '';
}

/**
 * دالة لجلب البيانات وتعبئة نافذة تعديل اللقطة
/**
 * دالة لجلب البيانات وتعبئة نافذة تعديل اللقطة
 * @param {string} guardId - معرّف الحارس
 * @param {string} attendanceId - معرّف سجل الحضور
 */
async function populateSnapshotModal(guardId, attendanceId) {
    const modal = document.getElementById('edit-snapshot-modal');
    const select = document.getElementById('snapshot-previous-select');
    select.innerHTML = '<option value="">جاري التحميل...</option>';
    document.getElementById('snapshot-attendance-id').value = attendanceId;
    document.getElementById('snapshot-guard-id').value = guardId;

    try {
        const { data: snapshots, error } = await supabaseClient.rpc('get_distinct_snapshots_for_guard', { p_guard_id: Number(guardId) });

        if (error) {
            console.error("RPC Error:", error);
            throw new Error('حدث خطأ أثناء جلب السجلات السابقة.');
        }

        if (!snapshots || snapshots.length === 0) {
            select.innerHTML = '<option value="">لا توجد سجلات سابقة</option>';
        } else {
            select.innerHTML = '<option value="">-- اختر من السجلات السابقة --</option>';
            snapshots.forEach(item => {
                const snapshot = item.shift_snapshot;
                if (snapshot) {
                    const optionText = `${snapshot.project || 'N/A'} - ${snapshot.location || 'N/A'} (${snapshot.schedule_details?.[0]?.name || ' وردية'})`;
                    const option = document.createElement('option');
                    option.value = JSON.stringify(snapshot);
                    option.textContent = optionText;
                    select.appendChild(option);
                }
            });
        }
        modal.classList.remove('hidden');

    } catch (err) {
        alert(err.message);
        select.innerHTML = '<option value="">فشل التحميل</option>';
    }
}
async function loadSupervisorCustodyPage() {
    if (!currentUser) return;
    const balanceAmountEl = document.getElementById('custody-balance-amount');
    balanceAmountEl.textContent = `${(currentUser.custody_balance || 0).toFixed(2)} ر.س`;
    const pendingContainer = document.getElementById('supervisor-pending-payments-container');
    pendingContainer.innerHTML = '<p style="text-align: center;">جاري تحميل التغطيات المكتملة...</p>';

    try {
        const { data: payments, error } = await supabaseClient
            .from('coverage_payments')
            .select(`
                *,
                coverage_shifts!inner(project, location, start_time, end_time, created_at),
                coverage_applicants!inner(full_name, id_number, phone_number, iban, id_photo_url, iban_certificate_url, users:users!coverage_applicants_applicant_user_id_fkey(*))
            `)
            .eq('status', 'pending_supervisor_payment')
            .in('coverage_shifts.project', currentUser.project)
            .order('created_at', { ascending: true, foreignTable: 'coverage_shifts' });

        if (error) throw error;

        const now = new Date();
        const endedShifts = payments.filter(p => {
            const shift = p.coverage_shifts;
            if (!shift || !shift.created_at || !shift.end_time || !shift.start_time) return false;
            const shiftDate = new Date(shift.created_at);
            const [endHours, endMinutes] = shift.end_time.split(':');
            let shiftEndDateTime = new Date(shiftDate);
            shiftEndDateTime.setHours(endHours, endMinutes, 0, 0);
            if (shift.end_time < shift.start_time) {
                shiftEndDateTime.setDate(shiftEndDateTime.getDate() + 1);
            }
            return now > shiftEndDateTime;
        });

        if (endedShifts.length === 0) {
            pendingContainer.innerHTML = '<p style="text-align: center;">لا توجد عمليات تغطية مكتملة بانتظار الصرف حالياً.</p>';
            return;
        }

        pendingContainer.innerHTML = endedShifts.map(payment => {
            const shift = payment.coverage_shifts;
            const applicantDetails = JSON.stringify(payment.coverage_applicants);
            return `
                <div class="review-request-card">
                    <div class="review-request-header status-pending">
                        <h4>مستحق صرف: ${payment.payment_amount} ر.س</h4>
                    </div>
                    <div class="review-request-body">
                        <p><strong>الحارس:</strong> ${payment.covering_guard_name}</p>
                        <p><strong>الموقع:</strong> ${shift.project} - ${shift.location}</p>
                        <p><strong>تاريخ الوردية:</strong> ${formatGregorianDate(payment.shift_date)}</p>
                    </div>
                    <div class="review-request-footer">
                        <button class="btn btn-secondary btn-sm custody-view-details-btn" data-details='${applicantDetails}'>
                            <i class="ph-bold ph-eye"></i> عرض التفاصيل
                        </button>
                        <button class="btn btn-danger btn-sm custody-exclude-btn" data-payment-id="${payment.id}">
                            <i class="ph-bold ph-x-circle"></i> استبعاد
                        </button>
                        <button class="btn btn-success btn-sm custody-confirm-payment-btn" data-payment-id="${payment.id}">
                            <i class="ph-bold ph-check-circle"></i> تأكيد الصرف
                        </button>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error("Error fetching pending payments:", error);
        pendingContainer.innerHTML = '<p style="color:red;">حدث خطأ في جلب البيانات.</p>';
    }
}

async function loadSupervisorCustodyArchive() {
    const container = document.getElementById('supervisor-custody-archive-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الأرشيف...</p>';

    try {
        const { data: payments, error } = await supabaseClient
            .from('coverage_payments')
            .select('id, decision_at, transaction_snapshot, applicant_id')
            .eq('paid_by_supervisor_id', currentUser.id)
            .in('status', ['paid_from_custody', 'excluded_by_supervisor'])
            .order('decision_at', { ascending: false });

        if (error) throw error;

        if (payments.length === 0) {
            container.innerHTML = '<p style="text-align: center;">الأرشيف فارغ حالياً.</p>';
            return;
        }

        container.innerHTML = `
            <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>تاريخ الإجراء</th>
                        <th>اسم الحارس</th>
                        <th>الموقع</th>
                        <th>المدينة</th>
                        <th>السبب</th>
                        <th>القرار</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    ${payments.map(p => {
                        const snap = p.transaction_snapshot;
                        if (!snap) return ''; 

                        const decision = snap.decision_info.decision;
                        const statusClass = decision === 'paid_from_custody' ? 'active' : 'inactive';
                        const statusText = decision === 'paid_from_custody' ? 'تم الصرف' : 'مستبعد';
                        return `
                            <tr>
                                <td>${formatGregorianDateTime(p.decision_at)}</td>
                                <td>${snap.covering_guard_info.name}</td>
                                <td>${snap.shift_info.project}</td>
                                <td>${snap.shift_info.city || '-'}</td>
                                <td>${snap.shift_info.reason || '-'}</td>
                                <td><span class="status ${statusClass}">${statusText}</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm custody-view-details-btn" data-snapshot='${JSON.stringify(snap)}'>
                                        <i class="ph-bold ph-eye"></i> عرض التفاصيل
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

    } catch (error) {
        console.error("Error loading supervisor archive:", error);
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
async function loadFinanceCustodyPage() {
    loadFinanceSupervisorsOverview();

    const page = document.getElementById('page-finance-custody');
    if (page && !page.dataset.listenerAttached) {
        page.querySelector('.tabs').addEventListener('click', (event) => {
            event.preventDefault();
            const tabLink = event.target.closest('.tab-link');
            if (!tabLink) return;

            page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            page.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabLink.dataset.tab)?.classList.add('active');
            
            if (tabLink.dataset.tab === 'finance-supervisors-list') loadFinanceSupervisorsOverview();
            if (tabLink.dataset.tab === 'finance-pending-reports') {
    const supervisorId = sessionStorage.getItem('report_supervisor_id');
    const supervisorName = sessionStorage.getItem('report_supervisor_name');

    if (supervisorId && supervisorName) {
        loadFinancePendingReportForSupervisor(supervisorId, supervisorName);
        sessionStorage.removeItem('report_supervisor_id');
        sessionStorage.removeItem('report_supervisor_name');
    } else {
        loadFinancePendingReports();
    }
}
            if (tabLink.dataset.tab === 'finance-archive-reports') loadFinanceArchiveReports();
            if (tabLink.dataset.tab === 'finance-disbursement-log') loadFinanceDisbursementLog();
        });
        page.dataset.listenerAttached = 'true';
    }
}

async function loadFinanceSupervisorsOverview() {
    const container = document.getElementById('finance-supervisors-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل بيانات المشرفين...</p>';

    try {
        const { data: supervisors, error } = await supabaseClient
            .from('users')
            .select('id, name, region, city, project, custody_balance')
            .eq('role', 'مشرف')
            .order('name');
        
        if (error) throw error;
        container.innerHTML = `
            <table>
                <thead><tr><th>اسم المشرف</th><th>المنطقة</th><th>المشاريع</th><th>رصيد العهدة</th><th>الإجراء</th></tr></thead>
                <tbody>
                    ${supervisors.map(sup => `
                        <tr>
                            <td>${sup.name}</td>
                            <td>${sup.region || '-'}</td>
                            <td>${(sup.project || []).join(', ') || '-'}</td>
                            <td><strong>${(sup.custody_balance || 0).toFixed(2)} ر.س</strong></td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-primary btn-sm view-supervisor-report-btn" data-id="${sup.id}" data-name="${sup.name}">
                                        <i class="ph-bold ph-file-text"></i> عرض التقرير
                                    </button>
                                    <button class="btn btn-secondary btn-sm disburse-custody-btn" data-id="${sup.id}" data-name="${sup.name}" data-balance="${sup.custody_balance || 0}">
                                        <i class="ph-bold ph-hand-coins"></i> صرف عهدة
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    } catch (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}

async function loadFinanceDisbursementLog() {
    const container = document.getElementById('finance-disbursement-log-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل سجل الصرف...</p>';

    try {
        const { data: logs, error } = await supabaseClient
            .from('custody_disbursements')
            .select(`*, finance:finance_user_id(name), supervisor:supervisor_user_id(name, city)`)
            .order('created_at', { ascending: false });

        if (error) throw error;
        
        container.innerHTML = `
            <table>
                <thead><tr><th>الوقت</th><th>موظف المالية</th><th>المشرف المستلم</th><th>المدينة</th><th>المبلغ</th><th>الرصيد قبل</th><th>الرصيد بعد</th></tr></thead>
                <tbody>
                    ${logs.map(log => `
                        <tr>
                            <td>${formatGregorianDateTime(log.created_at)}</td>
                            <td>${log.finance.name}</td>
                            <td>${log.supervisor.name}</td>
                            <td>${log.supervisor.city || '-'}</td>
                            <td style="color: #16a34a; font-weight: bold;">${log.amount.toFixed(2)} ر.س</td>
                            <td>${log.supervisor_balance_before.toFixed(2)} ر.س</td>
                            <td>${log.supervisor_balance_after.toFixed(2)} ر.س</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    } catch (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
async function loadFinancePendingReportForSupervisor(supervisorId, supervisorName) {
    const container = document.getElementById('finance-pending-reports-container');
    container.innerHTML = `<p style="text-align: center;">جاري تحميل تقرير المشرف: ${supervisorName}...</p>`;

    try {
        const { data: payments, error } = await supabaseClient
            .from('coverage_payments')
            .select('*')
            .eq('paid_by_supervisor_id', supervisorId)
            .in('status', ['paid_from_custody', 'excluded_by_supervisor'])
            .is('custody_report_id', null)
            .order('decision_at', { ascending: false });

        if (error) throw error;

        if (payments.length === 0) {
            container.innerHTML = `<p style="text-align: center;">لا توجد عمليات منجزة من قبل هذا المشرف بانتظار المراجعة.</p>`;
            return;
        }

        container.innerHTML = `
            <div class="page-header" style="border:0; padding-bottom:0;">
                <h4>تقرير المصروفات للمشرف: ${supervisorName}</h4>
                <button id="settle-report-btn" class="btn btn-success" data-supervisor-id="${supervisorId}">
                    <i class="ph-bold ph-check-circle"></i> اعتماد وأرشفة كل العمليات
                </button>
            </div>
            <div class="table-container" style="margin-top: 15px;">
                <table class="attendance-log-table">
                    <thead>
                        <tr>
                            <th>تاريخ الإجراء</th>
                            <th>اسم الحارس</th>
                            <th>المشروع / الموقع</th>
                            <th>السبب</th>
                            <th>المبلغ</th>
                            <th>القرار</th>
                            <th>ملاحظات المشرف</th>
                            <th>إثبات الدفع</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payments.map(p => {
                            const snap = p.transaction_snapshot;
                            if (!snap) return '';

                            const decision = snap.decision_info.decision;
                            const statusText = decision === 'paid_from_custody' ? 'تم الصرف' : 'مستبعد';
                            const statusClass = decision === 'paid_from_custody' ? 'active' : 'inactive';

                            const proofBtn = snap.decision_info.payment_proof_url 
                                ? `<button class="btn btn-secondary btn-sm view-proof-btn" data-url="${snap.decision_info.payment_proof_url}">عرض</button>` 
                                : '-';

                            return `
                                <tr>
                                    <td>${formatGregorianDateTime(p.decision_at)}</td>
                                    <td>${snap.covering_guard_info.name}</td>
                                    <td>${snap.shift_info.project} - ${snap.shift_info.location}</td>
                                    <td>${snap.shift_info.reason || '-'}</td>
                                    <td>${snap.financial_info.payment_amount} ر.س</td>
                                    <td><span class="status ${statusClass}">${statusText}</span></td>
                                    <td>${snap.decision_info.notes || '-'}</td>
                                    <td>${proofBtn}</td>
                                </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
async function loadFinancePendingReports() {
    const container = document.getElementById('finance-pending-reports-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل التقارير...</p>';

    try {
        const { data: reports, error } = await supabaseClient
            .from('custody_reports')
            .select('*, supervisor:supervisor_id(name)')
            .eq('status', 'pending_finance_review')
            .order('submission_date');

        if (error) throw error;
        if (reports.length === 0) {
            container.innerHTML = '<p style="text-align: center;">لا توجد تقارير بانتظار المراجعة حالياً.</p>';
            return;
        }

        container.innerHTML = reports.map(report => `
            <div class="review-request-card">
                <div class="review-request-header status-pending">
                    <h4>تقرير من: ${report.supervisor.name}</h4>
                </div>
                <div class="review-request-body">
                    <p><strong>تاريخ الرفع:</strong> ${formatGregorianDate(report.submission_date)}</p>
                    <p><strong>إجمالي المبلغ:</strong> ${report.total_amount.toFixed(2)} ر.س</p>
                </div>
                <div class="review-request-footer">
                    <button class="btn btn-primary review-custody-report-btn" data-report-id="${report.id}">
                        <i class="ph-bold ph-file-text"></i> مراجعة واعتماد التقرير
                    </button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
async function loadFinanceArchiveReports() {
    const container = document.getElementById('finance-archive-reports-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الأرشيف...</p>';

    try {
        const { data: reports, error } = await supabaseClient
            .from('custody_reports')
            .select('*, supervisor:supervisor_id(name), settled_by:settled_by_user_id(name)')
            .eq('status', 'settled')
            .order('settled_at', { ascending: false });

        if (error) throw error;
        if (reports.length === 0) {
            container.innerHTML = '<p style="text-align: center;">الأرشيف فارغ حالياً.</p>';
            return;
        }
        
        container.innerHTML = `
            <table>
            <thead><tr><th>تاريخ الاعتماد</th><th>اسم المشرف</th><th>إجمالي المبلغ</th><th>تم الاعتماد بواسطة</th><th>إجراء</th></tr></thead>
            <tbody>
                ${reports.map(r => `
                    <tr>
                        <td>${formatGregorianDateTime(r.settled_at)}</td>
                        <td>${r.supervisor.name}</td>
                        <td>${r.total_amount.toFixed(2)} ر.س</td>
                        <td>${r.settled_by.name}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm review-custody-report-btn" data-report-id="${r.id}">
                                <i class="ph-bold ph-eye"></i> عرض
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
            </table>`;
    } catch (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}
async function getFilteredAttendanceData(filters = {}) {
    let guardsQuery = supabaseClient.from('users').select(`
        *, 
        job_vacancies:users_vacancy_id_fkey(
            schedule_details, project, specific_location, region, location, base_salary, 
            housing_allowance, transport_allowance, other_allowances, work_hours
        )
    `).eq('role', 'حارس أمن').in('employment_status', ['اساسي', 'تغطية', 'بديل راحة']);

    if (currentUser.role === 'مشرف' && currentUser.assigned_locations && currentUser.assigned_locations.length > 0) {
        const siteFilterString = createSupervisorSiteFilter(currentUser.assigned_locations);
        guardsQuery = guardsQuery.or(siteFilterString);
    }
    else if (currentUser.role === 'ادارة العمليات') {
        if (!currentUser.is_ops_manager && currentUser.region) {
             guardsQuery = guardsQuery.eq('region', currentUser.region);
        }
    }
    if (filters.region) guardsQuery = guardsQuery.eq('region', filters.region);
    if (filters.city) guardsQuery = guardsQuery.eq('city', filters.city);
    if (filters.project) guardsQuery = guardsQuery.filter('project', 'ov', `{"${filters.project}"}`);
    if (filters.location) guardsQuery = guardsQuery.eq('location', filters.location);
    if (filters.searchVal) guardsQuery = guardsQuery.or(`name.ilike.%${filters.searchVal}%,id_number.ilike.%${filters.searchVal}%`);

    const { data: allGuardsInScope, error: guardsError } = await guardsQuery;
    if (guardsError) throw guardsError;

    const guardIds = allGuardsInScope.map(g => g.id);
    if (guardIds.length === 0) return { finalFilteredGuards: [] };
    const yesterday = new Date(Date.now() - 36 * 60 * 60 * 1000).toISOString();
    const { data: attendanceRecords, error: e1 } = await supabaseClient.from('attendance').select('*').in('guard_id', guardIds).gte('created_at', yesterday);
    if (e1) throw e1;
    const coverageGuardsIds = allGuardsInScope.filter(g => g.employment_status === 'تغطية').map(g => g.id);
    let coverageMap = new Map();
    
    if (coverageGuardsIds.length > 0) {
        const todayDate = new Date().toISOString().split('T')[0];
        const { data: coverages } = await supabaseClient
            .from('coverage_applicants')
            .select('applicant_user_id, coverage_shifts!inner(reason, project, location, start_time, end_time)')
            .in('applicant_user_id', coverageGuardsIds)
            .in('status', ['ops_final_approved', 'hr_approved'])
            .gte('created_at', yesterday); 

        if (coverages) {
            coverages.forEach(c => {
                coverageMap.set(c.applicant_user_id, c.coverage_shifts);
            });
        }
    }
    const processedGuards = allGuardsInScope.map(guard => {
        const allTodayRecords = attendanceRecords?.filter(r => r.guard_id === guard.id) || [];
        if (guard.employment_status === 'تغطية' && coverageMap.has(guard.id)) {
            const shiftDetails = coverageMap.get(guard.id);
            guard.coverageInfo = {
                isCoverage: true,
                reason: shiftDetails.reason, // هنا السبب (غياب فلان / نقص قوى)
                shiftDetails: shiftDetails
            };
        }

        const statusInfo = getGuardStatus(guard, allTodayRecords);
        return { ...guard, statusInfo };
    });
    const finalFilteredGuards = processedGuards.filter(guard => {
        if (!guard.statusInfo) return false;
        if (filters.isActiveOnly && !isShiftCurrentlyActive(guard.job_vacancies?.schedule_details?.[0]) && !guard.coverageInfo) return false;
        if (filters.statusVal && guard.statusInfo.text !== filters.statusVal) return false;
        const statusText = guard.statusInfo.text;
        const alwaysShowStatus = ['حاضر', 'متأخر', 'استئذان', 'انسحاب', 'وردية قادمة'];
        if (alwaysShowStatus.includes(statusText)) return true;
        if (statusText === 'غياب') {
             const schedule = guard.coverageInfo ? guard.coverageInfo.shiftDetails : guard.job_vacancies?.schedule_details?.[0];
             if (isShiftCurrentlyActive(schedule)) return true;
             if (schedule) {
                 const today = new Date();
                 const scheduleForToday = getScheduleForDate(schedule, today);
                 
                 if (scheduleForToday && scheduleForToday.periods) {
                     const lastPeriod = scheduleForToday.periods[scheduleForToday.periods.length - 1];
                     if (lastPeriod && lastPeriod.end_time) {
                        const [endH, endM] = lastPeriod.end_time.split(':').map(Number);
                        let shiftEndTime = new Date();
                        shiftEndTime.setHours(endH, endM, 0, 0);
                        const [startH, startM] = scheduleForToday.periods[0].start_time.split(':').map(Number);
                        if (lastPeriod.end_time < scheduleForToday.periods[0].start_time) {
                            if (today.getHours() >= startH) {
                                shiftEndTime.setDate(shiftEndTime.getDate() + 1);
                            }
                        }
                        const showUntil = new Date(shiftEndTime.getTime() + 10 * 60 * 1000);
                        return today < showUntil;
                     }
                 }
            }
        }
        return false; // إخفاء في باقي الحالات (مثل الغياب لوردية انتهت منذ فترة)
    });
    
    return { finalFilteredGuards };
}
async function loadEmployeeArchive() {
    const container = document.getElementById('admin-archive-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل أرشيف الموظفين...</p>';
    const searchInput = document.getElementById('archive-search-input');
    const searchTerm = searchInput.value.trim();

    try {
        let query = supabaseClient
            .from('users')
            .select('id, name, role, project, auth_user_id, id_number') // إضافة id_number للبحث
            .eq('employment_status', 'مؤرشف');

        if (searchTerm) {
            query = query.or(`name.ilike.%${searchTerm}%,id_number.ilike.%${searchTerm}%`);
        }
        
        const { data: archivedUsers, error } = await query.order('name', { ascending: true });

        if (error) throw error;

        if (archivedUsers.length === 0) {
            container.innerHTML = '<p style="text-align: center;">أرشيف الموظفين فارغ حاليًا.</p>';
            return;
        }

        container.innerHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الدور</th>
                            <th>آخر مشروع</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${archivedUsers.map(user => `
                            <tr>
                                <td>${user.name}</td>
                                <td>${user.role}</td>
                                <td>${(Array.isArray(user.project) ? user.project.join(', ') : user.project) || 'غير محدد'}</td>
                                <td>
                                    <button class="btn btn-success btn-sm reactivate-employee-btn" data-id="${user.id}" data-auth-id="${user.auth_user_id}" data-name="${user.name}">
                                        <i class="ph-bold ph-arrow-counter-clockwise"></i> إعادة تفعيل
                                    </button>
                                    <button class="btn btn-danger btn-sm admin-permanent-delete-btn" data-id="${user.id}" data-auth-id="${user.auth_user_id}" data-name="${user.name}" title="حذف نهائي">
                                        <i class="ph-bold ph-trash-simple"></i> حذف نهائي
                                    </button>
                                    </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        if (!searchInput.dataset.listenerAttached) {
            searchInput.addEventListener('keyup', () => {
                clearTimeout(hrDebounceTimer);
                hrDebounceTimer = setTimeout(loadEmployeeArchive, 500);
            });
            searchInput.dataset.listenerAttached = 'true';
        }
        
    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">حدث خطأ: ${err.message}</p>`;
        console.error("Error loading employee archive:", err);
    }
}
async function renderAssignmentLists(filter = {}) {
    const availableContainer = document.getElementById('assignment-modal-available-locations');
    const assignedContainer = document.getElementById('assignment-modal-assigned-locations');
    if (!availableContainer || !assignedContainer) return;

    availableContainer.innerHTML = '<p style="text-align: center;">جاري البحث...</p>';
    const { data: availableLocations, error } = await supabaseClient.rpc('search_available_sites', {
        p_region: filter.region || null,
        p_contract: filter.contract || null,
        p_search_term: filter.search || null,
        p_assigned_locations: currentAssignedLocations
    });

    if (error) {
        availableContainer.innerHTML = '<p style="color:red">خطأ في البحث.</p>';
        return;
    }

    if (availableLocations.length > 0) {
        availableContainer.innerHTML = availableLocations.map(loc => `
            <div class="hiring-card employee-card" style="cursor: pointer; border-left-color: #22c55e;" data-location='${JSON.stringify(loc)}'>
                <h5>${loc.site}</h5>
                <p style="font-size: 0.8rem;"><strong>العقد:</strong> ${loc.contract}</p>
            </div>
        `).join('');
    } else {
        availableContainer.innerHTML = '<p style="text-align: center;">لا توجد مواقع متاحة تطابق الفلترة.</p>';
    }
    if (currentAssignedLocations.length > 0) {
        assignedContainer.innerHTML = currentAssignedLocations.map(loc => `
            <div class="hiring-card" style="border-left: 4px solid var(--denied-color);">
                <div class="hiring-card-header">
                    <h5>${loc.site}</h5>
                    <button class="btn-action delete-assignment-btn" title="إزالة" data-location='${JSON.stringify(loc)}'><i class="ph-bold ph-x-circle"></i></button>
                </div>
                <p style="font-size: 0.8rem;"><strong>العقد:</strong> ${loc.contract}</p>
            </div>
        `).join('');
    } else {
        assignedContainer.innerHTML = '<p style="text-align: center;">لم يتم تعيين أي مواقع.</p>';
    }
}
async function loadMarketingClientsPage() {
    const container = document.getElementById('marketing-clients-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل بيانات العملاء...</p>';

    try {
        const searchTerm = document.getElementById('marketing-client-search-input')?.value || '';
        let contractsQuery = supabaseClient
            .from('contracts')
            .select('id, company_name, end_date, party2_name, party2_phone')
            .eq('status', 'active');

        if (searchTerm) {
            contractsQuery = contractsQuery.or(`company_name.ilike.%${searchTerm}%,party2_name.ilike.%${searchTerm}%`);
        }
        
        const { data: contracts, error: contractsError } = await contractsQuery;
        if (contractsError) throw contractsError;
        const { data: marketingData, error: marketingError } = await supabaseClient
            .from('marketing_client_data')
            .select('*');
        if (marketingError) throw marketingError;
        const marketingMap = new Map(marketingData.map(item => [item.contract_id, item]));

        if (contracts.length === 0) {
            container.innerHTML = '<p style="text-align: center;">لا توجد عقود عملاء تطابق بحثك.</p>';
            return;
        }

        container.innerHTML = ''; // مسح رسالة التحميل
        contracts.forEach(client => {
            const clientData = marketingMap.get(client.id) || {};
            const contract_id = client.id; 

            const daysRemaining = client.end_date ? Math.ceil((new Date(client.end_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            let progressColor = 'green';
            let progressText = daysRemaining !== null ? `متبقي ${daysRemaining} يوم` : 'تاريخ الانتهاء غير محدد';

            if (daysRemaining === null) {
                progressColor = 'grey';
            } else if (daysRemaining <= 30) {
                progressColor = 'red';
            } else if (daysRemaining <= 90) {
                progressColor = 'orange';
            }

            const ratingHtml = renderStars(clientData.client_rating);

            const clientCardHtml = `
                <div class="contract-card">
                    <div class="contract-card-header">
                        <h4>${client.company_name}</h4>
                    </div>
                    <div class="contract-card-body">
                        <div class="info-line" style="margin-bottom: 15px;">
                            <div style="width: 100%;">
                                <small>${progressText}</small>
                                <div style="background-color: #e5e7eb; border-radius: 5px; height: 10px; overflow: hidden;">
                                    <div style="width: ${daysRemaining ? Math.max(0, (100 - (daysRemaining / 365 * 100))) : 0}%; height: 100%; background-color: ${progressColor};"></div>
                                </div>
                            </div>
                        </div>
                        <div class="info-line">
                            <i class="ph-bold ph-user"></i>
                            <strong>ممثل العميل:</strong> ${client.party2_name || 'غير مسجل'}
                        </div>
                        <div class="info-line">
                            <i class="ph-bold ph-phone"></i>
                            <strong>رقم التواصل:</strong> ${client.party2_phone || 'غير مسجل'}
                        </div>
                        <hr>
                        <div class="info-line">
                            <i class="ph-bold ph-info"></i>
                            <strong>حالة العميل:</strong> <span class="status pending">${clientData.client_status || 'لم تحدد'}</span>
                        </div>
                    </div>
                    <div class="contract-card-footer" style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="client-rating-display" style="font-size: 1.2rem;">
                            ${ratingHtml}
                        </div>
                        <button class="btn btn-secondary edit-client-status-btn" 
                            data-contract-id="${contract_id}" 
                            data-status="${clientData.client_status || 'جديد'}" 
                            data-notes="${clientData.notes || ''}"
                            data-contact-date="${clientData.last_contact_date || ''}"
                            data-rating="${clientData.client_rating || 0}">
                            تعديل الحالة
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', clientCardHtml);
        });

    } catch (error) {
        console.error("Error loading marketing clients:", error);
        container.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ أثناء تحميل البيانات.</p>';
    }
}
async function loadMarketingCalendarPage() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    try {
    const { data: events, error } = await supabaseClient
        .from('marketing_calendar')
        .select(`*, contracts(company_name)`)
        .eq('user_id', currentUser.id);

    if (error) throw error;
        const now = new Date();
        const filteredEvents = events.filter(event => {
            if (event.event_end) {
                return new Date(event.event_end) >= now;
            }
            const eventStart = new Date(event.event_start);
            const endOfDay = new Date(eventStart);
            endOfDay.setHours(23, 59, 59, 999);
            return endOfDay >= now;
        });
        const formattedEvents = filteredEvents.map(event => ({
            id: event.id,
            title: event.event_title,
            start: event.event_start,
            end: event.event_end,
            extendedProps: {
                ...event // تخزين كل بيانات الموعد الأصلية هنا
            }
        }));
const calendar = new FullCalendar.Calendar(calendarEl, {
    headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    initialView: 'dayGridMonth',
    locale: 'ar',
    buttonText: {
        today: 'اليوم', month: 'شهر', week: 'أسبوع', day: 'يوم'
    },
    events: formattedEvents,
        eventContent: function(arg) {
        const props = arg.event.extendedProps;
        const clientName = props.contracts ? props.contracts.company_name : null;
    

    const editButtonHtml = `<a class="fc-event-edit-btn" data-event='${JSON.stringify(props)}'><i class="ph-bold ph-pencil-simple"></i></a>`;

        let eventHtml = `<div class="fc-event-main-custom"><b>${arg.event.title}</b>`;
        if (clientName) {
            eventHtml += `<small><i class="ph-fill ph-handshake"></i> ${clientName}</small>`;
        }
        eventHtml += '</div>';

        return { html: editButtonHtml + eventHtml };
    },

    eventMouseEnter: function(info) {
        const tooltip = document.getElementById('event-tooltip');
        const props = info.event.extendedProps;
        const clientName = props.contracts ? props.contracts.company_name : null;

        let tooltipHtml = `
            <h4 style="margin: 0 0 10px 0; font-size: 1.1em;">${info.event.title}</h4>
            <p style="margin: 0 0 5px 0; font-size: 0.9em;"><i class="ph-fill ph-clock"></i> ${formatGregorianDateTime(info.event.start)}</p>
        `;

        if (clientName) {
            tooltipHtml += `<p style="margin: 0 0 5px 0; font-size: 0.9em;"><i class="ph-fill ph-handshake"></i> ${clientName}</p>`;
        }
        if (props.event_description) {
            tooltipHtml += `<hr style="margin: 10px 0;"><p style="margin: 0; font-size: 0.9em;">${props.event_description}</p>`;
        }

        tooltip.innerHTML = tooltipHtml;
        tooltip.classList.remove('hidden');
        const rect = info.el.getBoundingClientRect();
        tooltip.style.left = `${rect.left + window.scrollX}px`;
        tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
    },

    eventMouseLeave: function(info) {
        document.getElementById('event-tooltip').classList.add('hidden');
    },

    eventClick: function(info) {
        info.jsEvent.preventDefault();
        document.getElementById('event-tooltip').classList.add('hidden'); // إخفاء النافذة قبل فتح نافذة التعديل

        const editBtn = document.createElement('button');
        editBtn.className = 'edit-marketing-event-btn';
        editBtn.dataset.event = JSON.stringify(info.event.extendedProps);
        editBtn.click();
    },

    dateClick: function(info) {
        const addBtn = document.getElementById('add-marketing-event-btn');
        addBtn.click();
        setTimeout(() => {
            const startDateInput = document.getElementById('marketing-event-start');
            if (startDateInput) {
                const date = new Date(info.dateStr);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                startDateInput.value = date.toISOString().slice(0, 16);
            }
        }, 100);
    }
});

calendar.render();

    } catch (error) {
        console.error("Error loading marketing calendar:", error);
        calendarEl.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ أثناء تحميل التقويم.</p>';
    }
}


async function loadLegalCalendarPage() {
    const calendarEl = document.getElementById('legal-calendar');
    if (!calendarEl) return;

    try {
        const { data: events, error } = await supabaseClient
            .from('legal_calendar')
            .select('*')
            .eq('user_id', currentUser.auth_user_id);

        if (error) throw error;
        const now = new Date();
        const filteredEvents = events.filter(event => {
            if (event.event_end) {
                return new Date(event.event_end) >= now;
            }
            const eventStart = new Date(event.event_start);
            const endOfDay = new Date(eventStart);
            endOfDay.setHours(23, 59, 59, 999);
            return endOfDay >= now;
        });

        const formattedEvents = filteredEvents.map(event => ({
            id: event.id,
            title: event.event_title,
            start: event.event_start,
            end: event.event_end,
            extendedProps: { ...event },
            backgroundColor: '#ef4444',
            borderColor: '#dc2626'
        }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            initialView: 'dayGridMonth',
            locale: 'ar',
            buttonText: {
                today: 'اليوم', month: 'شهر', week: 'أسبوع', day: 'يوم'
            },
            events: formattedEvents,
            
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                openLegalEventModal(info.event.extendedProps);
            },
            dateClick: function(info) {
                openLegalEventModal(null, info.dateStr);
            },

            eventDidMount: function(info) {
                new tippy(info.el, {
                    content: `<strong>${info.event.title}</strong><br><small>${info.event.extendedProps.event_description || 'لا يوجد وصف'}</small>`,
                    allowHTML: true,
                });
            }
        });

        calendar.render();

    } catch (error) {
        console.error("Error loading legal calendar:", error);
        calendarEl.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ أثناء تحميل التقويم.</p>';
    }
}
async function loadLegalPenaltiesPage() {
    const searchInput = document.getElementById('legal-penalties-search-input');
    const pageContainer = document.getElementById('page-legal-penalties');
    searchInput.addEventListener('keyup', () => {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length >= 3) {
                searchAndDisplayEmployeesForPenalties(searchTerm);
            } else {
                document.getElementById('legal-penalties-employee-list').innerHTML = '<p style="text-align: center;">اكتب 3 أحرف على الأقل للبحث.</p>';
            }
        }, 500);
    });
    pageContainer.querySelector('.tabs').addEventListener('click', (event) => {
        event.preventDefault();
        const tabLink = event.target.closest('.tab-link');
        if (!tabLink) return;

        pageContainer.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        pageContainer.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        
        tabLink.classList.add('active');
        const targetTabId = tabLink.dataset.tab;
        document.getElementById(targetTabId).classList.remove('hidden');

        if (targetTabId === 'legal-penalties-absence-tab') {
            loadDailyAbsenceReport();
        }
    });
}
async function loadDailyAbsenceReport() {
    const container = document.getElementById('legal-absence-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل قائمة الغياب لهذا اليوم...</p>';

    try {
        const { data: absentEmployees, error } = await supabaseClient.rpc('get_todays_absent_employees');
        if (error) throw error;
        const now = new Date();
        const trulyAbsent = absentEmployees.filter(emp => {
            if (!emp.missed_shift || !emp.missed_shift.start_time) return false;
            const [startHours, startMinutes] = emp.missed_shift.start_time.split(':').map(Number);
            const shiftStartTime = new Date();
            shiftStartTime.setHours(startHours, startMinutes, 0, 0);
            const gracePeriodEnd = new Date(shiftStartTime.getTime() + 30 * 60 * 1000); // 30 دقيقة سماح
            return now > gracePeriodEnd;
        });

        if (trulyAbsent.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 30px;">👍 لا يوجد موظفون غائبون حالياً.</p>';
            return;
        }

        container.innerHTML = trulyAbsent.map(emp => {
            const projectDisplay = Array.isArray(emp.project) ? emp.project.join(', ') : (emp.project || 'غير محدد');
            const shiftTime = emp.missed_shift ? createShiftTimeLabel(emp.missed_shift) : 'وردية غير محددة';
            return `
                <div class="contract-card">
                    <div class="contract-card-header">
                        <h4>${emp.user_name}</h4>
                    </div>
                    <div class="contract-card-body">
                        <div class="info-line"><i class="ph-bold ph-briefcase"></i><strong>المشروع:</strong> ${projectDisplay}</div>
                        <div class="info-line"><i class="ph-bold ph-map-pin"></i><strong>الموقع:</strong> ${emp.location}</div>
                        <div class="info-line"><i class="ph-bold ph-clock"></i><strong>الوردية الفائتة:</strong> ${shiftTime}</div>
                    </div>
                    <div class="contract-card-footer">
                        <button class="btn btn-danger send-absence-sms-btn" data-user-phone="${emp.user_phone}" data-user-name="${emp.user_name}">
                            <i class="ph-bold ph-paper-plane-tilt"></i> إرسال إشعار غياب
                        </button>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error("Error loading daily absence report:", error);
        container.innerHTML = '<p style="text-align: center; color: red;">حدث خطأ أثناء تحميل قائمة الغياب.</p>';
    }
}
async function searchAndDisplayEmployeesForPenalties(searchTerm) {
    const container = document.getElementById('legal-penalties-employee-list');
    container.innerHTML = '<p style="text-align: center;">جاري البحث...</p>';
    const { data: employees, error } = await supabaseClient
        .from('users')
        .select('id, name, role, project, employment_status, phone')
        .or(`name.ilike.%${searchTerm}%,id_number.ilike.%${searchTerm}%`)
        .not('employment_status', 'eq', 'مؤرشف');
    if (error) { container.innerHTML = '<p style="color:red;">حدث خطأ أثناء البحث.</p>'; return; }
    if (employees.length === 0) { container.innerHTML = '<p style="text-align: center;">لا توجد نتائج تطابق بحثك.</p>'; return; }
    container.innerHTML = employees.map(emp => {
        const projectDisplay = Array.isArray(emp.project) ? emp.project.join(', ') : (emp.project || 'غير محدد');
        return `
            <div class="attendance-card">
                <div>
                    <span>${emp.name}</span>
                    <p class="time">${emp.role} - ${projectDisplay}</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary view-legal-history-btn" data-user-id="${emp.id}"><i class="ph-bold ph-list-dashes"></i> عرض السجل</button>
                    <button class="btn btn-danger add-legal-penalty-btn" data-user-id="${emp.id}" data-user-name="${emp.name}"><i class="ph-bold ph-plus-circle"></i> إضافة جزاء</button>
                </div>
            </div>
            <div id="history-for-${emp.id}" class="hidden" style="margin: -10px 10px 10px; padding: 15px; background-color: #f8f9fa; border-radius: 0 0 8px 8px;"></div>
        `;
    }).join('');
}
document.getElementById('legal-penalty-form')?.addEventListener('submit', async function(event) {
    event.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    try {
        const penaltyData = {
            user_id: document.getElementById('legal-penalty-user-id').value,
            penalty_type: document.getElementById('legal-penalty-type').value,
            amount: parseFloat(document.getElementById('legal-penalty-amount').value) || 0,
            deduction_date: document.getElementById('legal-penalty-date').value,
            notes: document.getElementById('legal-penalty-notes').value,
            created_by_id: currentUser.auth_user_id
        };

        if (!penaltyData.user_id || !penaltyData.penalty_type || !penaltyData.deduction_date || !penaltyData.notes) {
            throw new Error('الرجاء تعبئة جميع الحقول الإجبارية.');
        }

        const { data: newPenalty, error } = await supabaseClient.from('legal_penalties').insert(penaltyData).select().single();
        if (error) throw error;
        
        showToast('تم حفظ الجزاء بنجاح.', 'success');
        document.getElementById('add-legal-penalty-modal').classList.add('hidden');
        if (newPenalty.amount > 0) {
            const { data: user } = await supabaseClient.from('users').select('phone').eq('id', newPenalty.user_id).single();
            if (user && user.phone) {
                if (confirm('هل تود إرسال إشعار SMS للموظف بهذا الخصم؟')) {
                    const message = `موظفنا العزيز.. نحيطك علماً بأنه تم تسجيل خصم إداري بقيمة ${newPenalty.amount} ريال سعودي، سيتم تطبيقه في مسير الرواتب القادم. السبب: ${newPenalty.notes}. - إدارة الشؤون القانونية`;
                    await supabaseClient.functions.invoke('send-sms', { body: { to: user.phone, message } });
                    showToast('تم إرسال إشعار الخصم.', 'success');
                }
            }
        }

    } catch(error) {
        alert('حدث خطأ: ' + error.message);
    } finally {
        submitBtn.disabled = false;
    }
});
async function loadLegalEmployeeLookupPage() {
    const searchInput = document.getElementById('legal-lookup-input');
    const resultsContainer = document.getElementById('legal-lookup-results');
    searchInput.value = '';
    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); margin-top: 20px;">ابدا البحث لعرض النتائج</p>';
    document.getElementById('legal-lookup-details').classList.add('hidden');
    document.getElementById('legal-lookup-placeholder').classList.remove('hidden');
    searchInput.addEventListener('keyup', () => {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(async () => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length < 3) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); margin-top: 20px;">اكتب 3 أحرف على الأقل للبحث</p>';
                return;
            }

            resultsContainer.innerHTML = '<p style="text-align: center;">جاري البحث...</p>';
            const { data, error } = await supabaseClient
                .from('users')
                .select('id, name, id_number, role')
                .or(`name.ilike.%${searchTerm}%,id_number.ilike.%${searchTerm}%`)
                .limit(10);

            if (error) {
                resultsContainer.innerHTML = '<p style="color:red;">خطأ في البحث.</p>';
            } else if (data.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center;">لا توجد نتائج.</p>';
            } else {
                resultsContainer.innerHTML = data.map(user => `
                    <div class="lookup-result-item" data-user-id="${user.id}">
                        <h5>${user.name}</h5>
                        <p>${user.role} - ${user.id_number}</p>
                    </div>
                `).join('');
            }
        }, 500);
    });
}

/**
 * دالة لجلب وعرض الموظفين المدرجين في القائمة السوداء
 */
async function loadBlacklistPage() {
    const container = document.getElementById('blacklist-cards-container');
    const searchInput = document.getElementById('blacklist-search-input');
    if (!container || !searchInput) return;

    container.innerHTML = '<p style="text-align: center;">جاري تحميل القائمة...</p>';

    try {
        const searchTerm = searchInput.value.trim();

        let query = supabaseClient
            .from('employee_blacklist')
            .select('*')
            .order('created_at', { ascending: false });

        if (searchTerm) {
            query = query.or(`name.ilike.%${searchTerm}%,id_number.ilike.%${searchTerm}%`);
        }

        const { data, error } = await query;
        if (error) throw error;

        if (data.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-user-minus"></i><h4>القائمة فارغة</h4><p>لم يتم إدراج أي موظفين في القائمة السوداء بعد.</p></div>';
            return;
        }

        container.innerHTML = data.map(item => `
            <div class="blacklist-card" data-id="${item.id}" style="cursor: pointer;">
                <div class="contract-card-header">
                    <h4>${item.name}</h4>
                </div>
                <div class="contract-card-body">
                    <p class="info-line" style="color: #991b1b;">
                        <i class="ph-bold ph-identification-card" style="color: #ef4444;"></i>
                        <strong>رقم الهوية:</strong> ${item.id_number}
                    </p>
                </div>
                <div class="contract-card-footer" style="justify-content: flex-start;">
                    <button class="btn btn-secondary view-blacklist-details-btn" data-id="${item.id}">
                        <i class="ph-bold ph-eye"></i> عرض التفاصيل والسبب
                    </button>
                </div>
            </div>
        `).join('');

    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
    if (!searchInput.dataset.listenerAttached) {
        searchInput.addEventListener('keyup', () => {
            clearTimeout(hrDebounceTimer);
            hrDebounceTimer = setTimeout(loadBlacklistPage, 500);
        });
        searchInput.dataset.listenerAttached = 'true';
    }
}

/**
 * دالة لجلب وعرض الدعاوى القضائية
 */
async function loadLawsuitsPage() {
    const container = document.getElementById('lawsuit-cards-container');
    const searchInput = document.getElementById('lawsuit-search-input');
    if (!container || !searchInput) return;

    container.innerHTML = '<p style="text-align: center;">جاري تحميل الدعاوى...</p>';

    try {
        const searchTerm = searchInput.value.trim().toLowerCase();
        const { data, error } = await supabaseClient.rpc('get_lawsuits_with_latest_update');
        if (error) throw error;

        let lawsuits = data.map(item => ({
            ...item.lawsuit_data, // بيانات الدعوى الأساسية
            latest_update: item.latest_update // بيانات آخر تحديث
        }));
        if (searchTerm) {
            lawsuits = lawsuits.filter(l =>
                l.case_title.toLowerCase().includes(searchTerm) ||
                (l.case_number && l.case_number.toLowerCase().includes(searchTerm)) ||
                l.plaintiff.toLowerCase().includes(searchTerm) ||
                l.defendant.toLowerCase().includes(searchTerm)
            );
        }

        if (lawsuits.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-scales"></i><h4>لا توجد دعاوى</h4><p>لم يتم العثور على دعاوى قضائية تطابق بحثك.</p></div>';
            return;
        }
        container.innerHTML = lawsuits.map(l => {
            const statusClass = l.status === 'قيد النظر' ? 'status-active' : 'status-closed';
            let latestUpdateHtml = '<p>لم يتم تسجيل أي إجراءات بعد.</p>';
            if (l.latest_update) {
                latestUpdateHtml = `
                    <p class="latest-update-info">
                        <strong>آخر إجراء (${formatGregorianDate(l.latest_update.update_date)}):</strong>
                        ${l.latest_update.description.substring(0, 100)}...
                    </p>
                `;
            }

            return `
                <div class="lawsuit-card ${statusClass}" data-id="${l.id}" style="cursor: pointer;">
                    <div class="lawsuit-card-header">
                        <h4>${l.case_title}</h4>
                        <span class="status ${l.status === 'قيد النظر' ? 'pending' : 'inactive'}">${l.status}</span>
                    </div>
                    <div class="lawsuit-card-body">
                        <div class="info-bit"><i class="ph-bold ph-user"></i><div><p>المدعي</p><strong>${l.plaintiff}</strong></div></div>
                        <div class="info-bit"><i class="ph-bold ph-buildings"></i><div><p>المدعى عليه</p><strong>${l.defendant}</strong></div></div>
                        <div class="info-bit"><i class="ph-bold ph-bank"></i><div><p>المحكمة</p><strong>${l.court_name || 'غير محدد'}</strong></div></div>
                        <div class="info-bit"><i class="ph-bold ph-barcode"></i><div><p>رقم الدعوى</p><strong>${l.case_number || 'غير محدد'}</strong></div></div>
                    </div>
                    <div class="lawsuit-card-footer">
                        ${latestUpdateHtml}
                    </div>
                </div>
            `;
        }).join('');

    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
    if (!searchInput.dataset.listenerAttached) {
        searchInput.addEventListener('keyup', () => {
            clearTimeout(hrDebounceTimer);
            hrDebounceTimer = setTimeout(loadLawsuitsPage, 500);
        });
        searchInput.dataset.listenerAttached = 'true';
    }
}
function displayLegalProfileData(data) {
    const p = data.personal_info;
    const e = data.employment_info;
    const f = data.financial_info;
    const a = data.attendance_summary;
    const r = data.requests_history;
    const pen = data.penalties_history;

    document.getElementById('legal-profile-name').textContent = p.name || '-';
    document.getElementById('legal-profile-id').textContent = p.id_number || '-';
    document.getElementById('legal-profile-phone').textContent = p.phone || '-';
    document.getElementById('legal-profile-start-date').textContent = p.start_date ? formatGregorianDate(p.start_date) : '-';
    
    const statusEl = document.getElementById('legal-profile-status');
    statusEl.textContent = p.status || 'غير محدد';
    statusEl.className = `status ${p.status === 'اساسي' ? 'active' : 'inactive'}`;
    
    document.getElementById('legal-profile-project').textContent = e.project || '-';
    document.getElementById('legal-profile-location').textContent = e.location || '-';
    document.getElementById('legal-profile-contract').textContent = e.contract_name || '-';
    document.getElementById('legal-profile-contract-end').textContent = e.contract_end_date ? formatGregorianDate(e.contract_end_date) : '-';
    
    document.getElementById('legal-profile-bank').textContent = f.bank_name || '-';
    document.getElementById('legal-profile-iban').textContent = f.iban || '-';
    const totalSalary = (f.base_salary || 0) + (f.housing_allowance || 0) + (f.transport_allowance || 0) + (f.other_allowances || 0);
    document.getElementById('legal-profile-salary').textContent = totalSalary > 0 ? `${totalSalary.toLocaleString('ar-SA')} ر.س` : '-';
    
    document.getElementById('legal-summary-absent').textContent = a?.absent_days || 0;
    document.getElementById('legal-summary-withdrawal').textContent = a?.withdrawals || 0;
    document.getElementById('legal-summary-permission').textContent = a?.permissions || 0;

    const requestsContainer = document.getElementById('legal-history-requests');
    if (r && r.length > 0) {
        requestsContainer.innerHTML = r.map(req => `<div class="history-item"><div><strong>${req.type}</strong> (${req.status})<br><small>${req.reason || ''}</small></div><small>${formatGregorianDate(req.date)}</small></div>`).join('');
    } else {
        requestsContainer.innerHTML = '<p>لا يوجد سجل طلبات.</p>';
    }

    const penaltiesContainer = document.getElementById('legal-history-penalties');
    if (pen && pen.length > 0) {
        penaltiesContainer.innerHTML = pen.map(p => `<div class="history-item"><div><strong>${p.reason}</strong><br><small>${p.amount} ر.س</small></div><small>${formatGregorianDate(p.date)}</small></div>`).join('');
    } else {
        penaltiesContainer.innerHTML = '<p>لا يوجد سجل عقوبات.</p>';
    }

    document.getElementById('legal-lookup-details').classList.remove('hidden');
    document.getElementById('legal-lookup-placeholder').classList.add('hidden');
}
function openLegalEventModal(eventData = null, dateStr = null) {
    const modal = document.getElementById('legal-event-modal');
    const form = document.getElementById('legal-event-form');
    form.reset(); // إفراغ الحقول

    const toLocalISOString = (date) => date ? new Date(new Date(date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';

    if (eventData) { // حالة التعديل
        document.getElementById('legal-event-modal-title').textContent = 'تعديل موعد';
        document.getElementById('legal-event-id').value = eventData.id;
        document.getElementById('legal-event-title').value = eventData.event_title;
        document.getElementById('legal-event-start').value = toLocalISOString(eventData.event_start);
        document.getElementById('legal-event-end').value = toLocalISOString(eventData.event_end);
        document.getElementById('legal-case-number').value = eventData.case_number || '';
        document.getElementById('legal-reminder-datetime').value = toLocalISOString(eventData.reminder_datetime); // <<< سطر جديد
        document.getElementById('legal-event-description').value = eventData.event_description || '';
        document.getElementById('delete-legal-event-btn').classList.remove('hidden');
    } else { // حالة الإضافة
        document.getElementById('legal-event-modal-title').textContent = 'إضافة موعد جديد';
        document.getElementById('legal-event-id').value = '';
        if (dateStr) {
            const date = new Date(dateStr);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('legal-event-start').value = date.toISOString().slice(0, 16);
        }
        document.getElementById('delete-legal-event-btn').classList.add('hidden');
    }

    modal.classList.remove('hidden');
}

let allContractsForVehicles = []; // لتخزين بيانات العقود لتجنب إعادة تحميلها
function renderVehicleContractsList(searchTerm = '') {
    const listContainer = document.getElementById('vehicle-contracts-sites-list');
    if (!listContainer) return;

    const lowerCaseSearchTerm = searchTerm.toLowerCase();

    const filteredContracts = allContractsForVehicles.map(contract => {
        const matchingLocations = contract.contract_locations.filter(loc => 
            loc.name.toLowerCase().includes(lowerCaseSearchTerm) || 
            contract.company_name.toLowerCase().includes(lowerCaseSearchTerm)
        );
        if (matchingLocations.length > 0) {
            return { ...contract, contract_locations: matchingLocations };
        }
        return null;
    }).filter(Boolean);

    if (filteredContracts.length === 0) {
        listContainer.innerHTML = '<p style="text-align: center;">لا توجد نتائج بحث.</p>';
        return;
    }

    listContainer.innerHTML = filteredContracts.map(contract => `
        <details class="attendance-accordion" open>
            <summary>${contract.company_name}</summary>
            <div class="content" style="padding: 5px 10px;">
                ${contract.contract_locations.map(location => `
                    <div class="lookup-result-item site-list-item" data-contract-id="${contract.id}" data-location-name="${location.name}">
                        <h5>${location.name}</h5>
                    </div>
                `).join('')}
            </div>
        </details>
    `).join('');
}
async function displayVehiclesForSite(contractId, locationName) {
    const placeholder = document.getElementById('vehicles-for-site-placeholder');
    const content = document.getElementById('vehicles-for-site-content');
    const title = document.getElementById('site-vehicles-title');
    const container = document.getElementById('site-vehicles-container');

    placeholder.classList.add('hidden');
    content.classList.remove('hidden');
    title.textContent = `مركبات موقع: ${locationName}`;
    container.innerHTML = '<p>جاري تحميل المركبات...</p>';

    try {
        const { data: vehicles, error } = await supabaseClient
            .from('vehicles')
            .select('*, users:assigned_supervisor_id(name)')
            .eq('contract_id', contractId)
            .eq('location_name', locationName);

        if (error) throw error;
        
        if (vehicles.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-car"></i><h4>لا توجد مركبات</h4><p>لم يتم تسجيل أي مركبات لهذا الموقع بعد.</p></div>';
            return;
        }

        container.innerHTML = vehicles.map(v => {
            const expiryDate = new Date(v.registration_expiry_date);
            const today = new Date();
            const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            let expiryHtml = '';
            if (daysDiff < 0) {
                expiryHtml = `<span style="color:var(--denied-color);">منتهية</span>`;
            } else if (daysDiff <= 30) {
                expiryHtml = `<span style="color:var(--pending-color);">متبقي ${daysDiff} يوم</span>`;
            } else {
                expiryHtml = `<span style="color:var(--approved-color);">سارية</span>`;
            }

            return `
                <div class="contract-card">
                    <div class="contract-card-header"><h4>${v.vehicle_type} - ${v.license_plate}</h4></div>
                    <div class="contract-card-body">
                        <p class="info-line"><strong>حالة الاستمارة:</strong> ${expiryHtml}</p>
                        <p class="info-line"><strong>المشرف المسؤول:</strong> ${v.users ? v.users.name : 'غير محدد'}</p>
                        <p class="info-line"><strong>الحالة:</strong> <span class="status ${v.status === 'فعالة' ? 'active' : 'inactive'}">${v.status}</span></p>
                    </div>
                    <div class="contract-card-footer">
                        <button class="btn btn-secondary edit-vehicle-btn" data-id="${v.id}"><i class="ph-bold ph-pencil-simple"></i> تعديل</button>
                        <button class="btn btn-danger delete-vehicle-btn" data-id="${v.id}"><i class="ph-bold ph-trash"></i> حذف</button>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
}
async function loadVehiclesPage() {
    const page = document.getElementById('page-vehicles');
    if (!page.dataset.listenerAttached) {
        page.querySelector('.tabs').addEventListener('click', (e) => {
            e.preventDefault();
            const tabLink = e.target.closest('.tab-link');
            if (!tabLink) return;

            page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            page.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            tabLink.classList.add('active');
            const targetTabId = tabLink.dataset.tab;
            document.getElementById(targetTabId).classList.add('active');

            if (targetTabId === 'vehicle-assignment-tab') {
                loadVehicleAssignmentView();
            } else if (targetTabId === 'vehicle-management-tab') {
                loadAllVehiclesView();
            } else if (targetTabId === 'vehicle-invoices-tab') {
                loadVehicleInvoicesView();
                } else if (targetTabId === 'vehicle-violations-tab') {
                loadVehicleViolationsView();
            
            }
        });
        
        page.dataset.listenerAttached = 'true';
    }
    const activeTabId = page.querySelector('.tab-link.active').dataset.tab;
    if (activeTabId === 'vehicle-assignment-tab') {
        loadVehicleAssignmentView();
    } else if (activeTabId === 'vehicle-management-tab') {
        loadAllVehiclesView();
    } else if (activeTabId === 'vehicle-invoices-tab') {
        loadVehicleInvoicesView();
    } else if (activeTabId === 'vehicle-violations-tab') {
        loadVehicleViolationsView();
    }
}
async function loadAllVehiclesView() {
    const container = document.getElementById('all-vehicles-container');
    const supervisorFilter = document.getElementById('all-vehicles-supervisor-filter');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل كل المركبات...</p>';

    if (supervisorFilter.options.length <= 1) {
        const { data: employees } = await supabaseClient.from('users').select('id, name').in('role', ['مشرف', 'حارس أمن']);
        if (employees) {
            supervisorFilter.innerHTML = '<option value="">كل الموظفين</option>';
            supervisorFilter.innerHTML += employees.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }
    }

    try {
        const filters = {
            search: document.getElementById('all-vehicles-search').value,
            supervisor: supervisorFilter.value,
            status: document.getElementById('all-vehicles-status-filter').value
        };

        
        if (filters.search) query = query.or(`vehicle_type.ilike.%${filters.search}%,license_plate.ilike.%${filters.search}%`);
        if (filters.supervisor) query = query.eq('assigned_employee_id', filters.supervisor);
        if (filters.status) query = query.eq('status', filters.status);
        let query = supabaseClient.from('vehicles').select('*, users:assigned_employee_id(id, name), contracts:contract_id(company_name), insurance_expiry_date');
        if (filters.search) query = query.or(`vehicle_type.ilike.%${filters.search}%,license_plate.ilike.%${filters.search}%`);
        if (filters.supervisor) query = query.eq('assigned_employee_id', filters.supervisor);
        if (filters.status) query = query.eq('status', filters.status);

        const { data: vehicles, error } = await query.order('created_at', { ascending: false });
        if (error) throw error;

        if (vehicles.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-car"></i><h4>لا توجد مركبات</h4><p>لم يتم العثور على مركبات تطابق شروط الفلترة.</p></div>';
            return;
        }

        container.innerHTML = vehicles.map(v => {
            const expiryDate = new Date(v.registration_expiry_date);
            const today = new Date();
            today.setHours(0,0,0,0);
            const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

            let expiryClass = 'status-ok';
            let expiryText = `سارية (${daysDiff} يوم متبقي)`;

            if (daysDiff < 0) {
                expiryClass = 'status-error';
                expiryText = 'منتهية';
            } else if (daysDiff <= 30) {
                expiryClass = 'status-warning';
                expiryText = `ستنتهي خلال ${daysDiff} يوم`;
            }
            
            const identifier = `${v.vehicle_type} - ${v.license_plate}`;
            let insuranceHtml = '';
            if (v.insurance_expiry_date) {
                const insuranceExpiryDate = new Date(v.insurance_expiry_date);
                const insuranceDaysDiff = Math.ceil((insuranceExpiryDate - today) / (1000 * 60 * 60 * 24));
                
                let insuranceClass = 'status-ok';
                let insuranceText = `ساري (${insuranceDaysDiff} يوم متبقي)`;

                if (insuranceDaysDiff < 0) {
                    insuranceClass = 'status-error';
                    insuranceText = 'منتهي';
                } else if (insuranceDaysDiff <= 30) {
                    insuranceClass = 'status-warning';
                    insuranceText = `سينتهي خلال ${insuranceDaysDiff} يوم`;
                }
                insuranceHtml = `<span class="status-badge ${insuranceClass === 'status-error' ? 'denied' : (insuranceClass === 'status-warning' ? 'pending' : 'approved')}" style="margin-right: 5px;">التأمين: ${insuranceText}</span>`;
            } else {
                insuranceHtml = `<span class="status-badge pending" style="margin-right: 5px;">التأمين: غير مسجل</span>`;
            }
            let recipientInfoBtn = '';
            if (v.users && v.users.id) {
                recipientInfoBtn = `<button class="btn btn-secondary btn-sm view-recipient-info-btn" data-user-id="${v.users.id}" title="عرض بيانات المستلم" style="margin-left: 5px;"><i class="ph-bold ph-user-list"></i></button>`;
            }

            return `
                <div class="contract-card">
                    <div class="contract-card-header"><h4><i class="ph-fill ph-car" style="margin-left: 8px;"></i>${identifier}</h4></div>
                    <div class="contract-card-body">
                        <div class="info-line"><i class="ph-bold ph-buildings"></i><strong>المشروع:</strong> ${v.contracts ? v.contracts.company_name : 'غير محدد'}</div>
                        <div class="info-line"><i class="ph-bold ph-map-pin"></i><strong>الموقع:</strong> ${v.location_name || 'غير محدد'}</div>
                        <div class="info-line" style="display: flex; align-items: center; justify-content: space-between;">
                            <span><i class="ph-bold ph-user-circle"></i><strong>الموظف المستلم:</strong> ${v.users ? v.users.name : 'غير مسلمة'}</span>
                            ${recipientInfoBtn} 
                        </div>
                    </div>
                    <div class="contract-card-footer" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        
                        <div class="vehicle-status-badges">
                            <span class="status ${v.status === 'فعالة' ? 'active' : 'inactive'}">${v.status}</span>
                            <span class="status-badge ${expiryClass === 'status-error' ? 'denied' : (expiryClass === 'status-warning' ? 'pending' : 'approved')}">الاستمارة: ${expiryText}</span>
                            ${insuranceHtml}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-secondary btn-sm view-vehicle-history-btn" data-id="${v.id}" data-identifier="${identifier}"><i class="ph-bold ph-list-dashes"></i> السجل</button>
                            <button class="btn btn-secondary btn-sm edit-vehicle-btn" data-id="${v.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i> تعديل</button>
                            <button class="btn btn-danger btn-sm delete-vehicle-btn" data-id="${v.id}" title="حذف"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
}
async function loadVehicleAssignmentView() {
    const container = document.getElementById('vehicle-deficit-cards-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحليل العقود وحساب النقص في المركبات...</p>';

    try {
        const { data: contracts, error: conError } = await supabaseClient.from('contracts').select('id, company_name, contract_locations').eq('status', 'active');
        if (conError) throw conError;
        const { data: deployedVehicles, error: depError } = await supabaseClient.from('vehicles').select('contract_id, location_name');
        if (depError) throw depError;
        const deployedMap = deployedVehicles.reduce((map, vehicle) => {
            const key = `${vehicle.contract_id}-${vehicle.location_name}`;
            map[key] = (map[key] || 0) + 1;
            return map;
        }, {});
        const sitesWithDeficit = [];
        contracts.forEach(contract => {
            if (contract.contract_locations) {
                contract.contract_locations.forEach(location => {
                    const required = location.patrols_count || 0;
                    if (required > 0) {
                        const key = `${contract.id}-${location.name}`;
                        const deployed = deployedMap[key] || 0;
                        const deficit = required - deployed;
                        if (deficit > 0) {
                            sitesWithDeficit.push({
                                contractId: contract.id,
                                contractName: contract.company_name,
                                locationName: location.name,
                                deficit: deficit
                            });
                        }
                    }
                });
            }
        });

        if (sitesWithDeficit.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا يوجد نقص</h4><p>كل المواقع التي تتطلب مركبات لديها العدد الكافي حالياً.</p></div>';
            return;
        }
        container.innerHTML = sitesWithDeficit.map(site => `
            <div class="contract-card">
                <div class="contract-card-header"><h4>${site.contractName}</h4></div>
                <div class="contract-card-body">
                    <p class="info-line"><i class="ph-bold ph-map-pin"></i><strong>الموقع:</strong> ${site.locationName}</p>
                    <p class="info-line" style="font-size: 1.2rem; color: var(--denied-color); font-weight: bold;"><i class="ph-bold ph-warning-circle"></i><strong>النقص الحالي:</strong> ${site.deficit} مركبة</p>
                </div>
                <div class="contract-card-footer">
                    <button class="btn btn-primary add-vehicle-to-site-btn" data-contract-id="${site.contractId}" data-location-name="${site.locationName}" data-contract-name="${site.contractName}">
                        <i class="ph-bold ph-plus-circle"></i> إضافة مركبة لهذا الموقع
                    </button>
                </div>
            </div>
        `).join('');

    } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
}


async function loadAdminAssetsPage() {
    const container = document.getElementById('admin-assets-list-container');
    const categoryFilter = document.getElementById('admin-assets-category-filter');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل العهد...</p>';

    try {
        if (categoryFilter.options.length <= 1) {
            const { data: categories, error } = await supabaseClient
                .from('assets_inventory')
                .select('id, name')
                .not('name', 'in', '("المركبات","أجهزة برافو")'); // استبعاد الفئات الخاصة
            
            if (error) throw error;
            
            categories.forEach(cat => {
                categoryFilter.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        }
        const { data: excludedCategories, error: catError } = await supabaseClient
            .from('assets_inventory')
            .select('id')
            .in('name', ['المركبات', 'أجهزة برافو']);

        if (catError) throw catError;
        const excludedCategoryIds = excludedCategories.map(c => c.id);
        const searchTerm = document.getElementById('admin-assets-search-input').value.toLowerCase();
        const categoryId = categoryFilter.value;
        const status = document.getElementById('admin-assets-status-filter').value;
        let query = supabaseClient
            .from('asset_items')
            .select(`
                id, details, assignment_date, status, condition,
                inventory:inventory_id(name),
                employee:assigned_to_user_id(name, role)
            `);
        if (excludedCategoryIds.length > 0) {
            query = query.not('inventory_id', 'in', `(${excludedCategoryIds.join(',')})`);
        }
        if (categoryId) {
            query = query.eq('inventory_id', categoryId);
        }
        if (status) {
            query = query.eq('status', status);
        }
        if (searchTerm) {
            query = query.or(`details->>identifier.ilike.%${searchTerm}%,details->>serial_number.ilike.%${searchTerm}%,employee.name.ilike.%${searchTerm}%`, { foreignTable: 'employee' });
        }

        const { data: assets, error } = await query.order('created_at', { ascending: false });
        if (error) throw error;

        if (assets.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا توجد عهد</h4><p>لم يتم العثور على عهد تطابق شروط الفلترة.</p></div>';
            return;
        }
        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>الفئة</th>
                        <th>المُعرّف (الرقم التسلسلي)</th>
                        <th>الموظف المستلم</th>
                        <th>تاريخ التسليم</th>
                        <th>الحالة</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    ${assets.map(asset => {
                        const identifier = asset.details?.identifier || asset.details?.serial_number || Object.values(asset.details || {}).join(' - ') || '-';
                        
                        let statusClass = 'pending';
                        if (asset.status === 'متوفر في المخزن') statusClass = 'active';
                        if (asset.status === 'مسلمة لموظف') statusClass = 'inactive';
                        if (asset.status === 'تالف') statusClass = 'denied';

                        let actionButtons = '';
                        if (asset.status === 'متوفر في المخزن') {
                            actionButtons = `<button class="btn btn-success btn-sm assign-asset-item-btn" data-id="${asset.id}" title="تسليم لموظف"><i class="ph-bold ph-user-plus"></i></button>`;
                        } else if (asset.status === 'مسلمة لموظف') {
                            actionButtons = `<button class="btn btn-danger btn-sm return-asset-item-btn" data-id="${asset.id}" title="تسجيل ارتجاع"><i class="ph-bold ph-arrow-counter-clockwise"></i></button>`;
                        }

                        return `
                            <tr>
                                <td>${asset.inventory.name}</td>
                                <td>${identifier}</td>
                                <td>${asset.employee ? asset.employee.name : '-'}</td>
                                <td>${asset.assignment_date ? formatGregorianDate(asset.assignment_date) : '-'}</td>
                                <td><span class="status ${statusClass}">${asset.status}</span></td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        ${actionButtons}
                                        <button class="btn btn-secondary btn-sm edit-admin-asset-btn" data-id="${asset.id}" title="تعديل"><i class="ph-bold ph-pencil-simple"></i></button>
                                        <button class="btn btn-secondary btn-sm view-asset-history-btn" data-id="${asset.id}" title="عرض السجل"><i class="ph-bold ph-list-dashes"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `
                    }).join('')}
                </tbody>
            </table>
        `;
    } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
        console.error("Error loading admin assets:", err);
    }
}
async function populateGuardAssetModal(contractId, locationName, contractName) {
    const modal = document.getElementById('guard-asset-modal');
    const deployedListContainer = document.getElementById('deployed-guard-assets-list');
    const availableDeviceSelect = document.getElementById('ga-available-device-select');
    const employeeSelect = document.getElementById('ga-supervisor-select');

    document.getElementById('guard-asset-modal-title').textContent = `إدارة أجهزة موقع: ${locationName}`;
    document.getElementById('ga-modal-contract-id').value = contractId;
    document.getElementById('ga-modal-location-name').value = locationName;
    deployedListContainer.innerHTML = '<p>جاري تحميل الأجهزة المسلمة...</p>';
    availableDeviceSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    employeeSelect.innerHTML = '<option value="">جاري التحميل...</option>';

    try {
        const { data: bravoCategory, error: bravoError } = await supabaseClient.from('assets_inventory').select('id').eq('name', 'أجهزة برافو').single();
        if (bravoError || !bravoCategory) {
            throw new Error('فئة "أجهزة برافو" غير معرفة في المخزون. يرجى التأكد من اسمها في صفحة إدارة المخزون.');
        }

        const [
            { data: deployedAssets },
            { data: availableAssets },
            { data: employees }
        ] = await Promise.all([
            supabaseClient.from('asset_items').select('*, employee:assigned_to_user_id(name)').eq('contract_id', contractId).eq('location_name', locationName),
            supabaseClient.from('asset_items').select('id, details').eq('inventory_id', bravoCategory.id).eq('status', 'متوفر في المخزن'),
            supabaseClient.from('users').select('id, name').in('role', ['مشرف', 'حارس أمن']).contains('project', [contractName])
        ]);

        if (deployedAssets && deployedAssets.length > 0) {
            deployedListContainer.innerHTML = `
                <table><thead><tr><th>الرقم التسلسلي</th><th>الموظف المسؤول</th><th>الإجراء</th></tr></thead><tbody>
                ${deployedAssets.map(asset => `
                    <tr>
                        <td>${asset.details?.['الرقم التسلسلي'] || asset.details?.identifier || '-'}</td>
                        <td>${asset.employee ? asset.employee.name : 'غير محدد'}</td>
                        <td><button class="btn btn-danger btn-sm return-guard-asset-btn-new" data-id="${asset.id}" title="إرجاع للمخزن"><i class="ph-bold ph-arrow-counter-clockwise"></i></button></td>
                    </tr>
                `).join('')}
                </tbody></table>`;
        } else {
            deployedListContainer.innerHTML = '<p>لم يتم تسليم أي أجهزة لهذا الموقع بعد.</p>';
        }

        if (availableAssets && availableAssets.length > 0) {
            availableDeviceSelect.innerHTML = '<option value="">-- اختر جهاز --</option>';
            availableDeviceSelect.innerHTML += availableAssets.map(asset => {
                const identifier = asset.details?.['الرقم التسلسلي'] || asset.details?.identifier || `جهاز ID: ${asset.id}`;
                return `<option value="${asset.id}">${identifier}</option>`;
            }).join('');
        } else {
            availableDeviceSelect.innerHTML = '<option value="">لا توجد أجهزة متاحة</option>';
        }
        
        if (employees && employees.length > 0) {
            employeeSelect.innerHTML = '<option value="">-- اختر موظف --</option>';
            employeeSelect.innerHTML += employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        } else {
             employeeSelect.innerHTML = '<option value="">لا يوجد موظفين</option>';
        }

    } catch (err) {
        alert(err.message);
    }
}
async function loadGuardAssetsPage() {
    const container = document.getElementById('guard-assets-sites-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحليل العقود وحساب الاحتياج...</p>';

    try {
        const { data: bravoCategory, error: invError } = await supabaseClient
            .from('assets_inventory')
            .select('id, name')
            .eq('name', 'أجهزة برافو')
            .single();

        if (invError || !bravoCategory) {
            document.getElementById('guard-asset-stats-required').textContent = 0;
            document.getElementById('guard-asset-stats-deployed').textContent = 0;
            document.getElementById('guard-asset-stats-deficit').textContent = 0;
            document.getElementById('guard-asset-stats-instock').textContent = 0;
            throw new Error('فئة "أجهزة برافو" غير موجودة. يرجى إضافتها أولاً من صفحة "إدارة المخزون".');
        }

        const bravoCategoryId = bravoCategory.id;
        const [
            { data: contracts, error: conError },
            { data: deployedAssets, error: depError },
            { count: inStockCount, error: stockError }
        ] = await Promise.all([
            supabaseClient.from('contracts').select('id, company_name, contract_locations').eq('status', 'active'),
            supabaseClient.from('asset_items').select('contract_id, location_name').eq('inventory_id', bravoCategoryId).eq('status', 'مسلمة لموقع'),
            supabaseClient.from('asset_items').select('*', { count: 'exact', head: true }).eq('inventory_id', bravoCategoryId).eq('status', 'متوفر في المخزن')
        ]);
        
        if (conError || depError || stockError) throw conError || depError || stockError;
        const deployedMap = deployedAssets.reduce((map, asset) => {
            const key = `${asset.contract_id}-${asset.location_name}`;
            map[key] = (map[key] || 0) + 1;
            return map;
        }, {});

        let totalRequired = 0;
        const sitesData = [];

        contracts.forEach(contract => {
            if (contract.contract_locations) {
                contract.contract_locations.forEach(location => {
                    const required = location.devices_count || 0;
                    if (required > 0) {
                        totalRequired += required;
                        const key = `${contract.id}-${location.name}`;
                        const deployed = deployedMap[key] || 0;
                        sitesData.push({
                            contractId: contract.id,
                            contractName: contract.company_name,
                            locationName: location.name,
                            required: required,
                            deployed: deployed,
                            deficit: required - deployed
                        });
                    }
                });
            }
        });

        const totalDeployed = deployedAssets.length;
        document.getElementById('guard-asset-stats-required').textContent = totalRequired;
        document.getElementById('guard-asset-stats-deployed').textContent = totalDeployed;
        document.getElementById('guard-asset-stats-deficit').textContent = totalRequired - totalDeployed;
        document.getElementById('guard-asset-stats-instock').textContent = inStockCount || 0;
        if (sitesData.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا يوجد احتياج</h4><p>لا توجد أي عقود حالية تتطلب أجهزة برافو.</p></div>';
            return;
        }

        container.innerHTML = `
            <table><thead><tr>
                <th>المشروع (العقد)</th><th>الموقع</th><th>المطلوب</th><th>المسلم</th><th>العجز</th><th>الإجراء</th>
            </tr></thead><tbody>
            ${sitesData.map(site => `
                <tr class="site-row" data-contract-id="${site.contractId}" data-contract-name="${site.contractName}">
                    <td>${site.contractName}</td>
                    <td>${site.locationName}</td>
                    <td>${site.required}</td>
                    <td><strong style="color: var(--approved-color);">${site.deployed}</strong></td>
                    <td><strong style="color: ${site.deficit > 0 ? 'var(--denied-color)' : '#6b7280'};">${site.deficit}</strong></td>
                    <td><button class="btn btn-primary btn-sm manage-site-assets-btn" data-contract-id="${site.contractId}" data-location-name="${site.locationName}">إدارة الأجهزة</button></td>
                </tr>
            `).join('')}
            </tbody></table>`;

    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">${err.message}</p>`;
    }
}
async function loadAssetReportsPage() {
    const page = document.getElementById('page-asset-reports');
    if (!page.dataset.listenerAttached) {
        page.querySelector('.tabs').addEventListener('click', (e) => {
            e.preventDefault();
            const tabLink = e.target.closest('.tab-link');
            if (!tabLink) return;

            page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            page.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            tabLink.classList.add('active');
            const targetTabId = tabLink.dataset.tab;
            document.getElementById(targetTabId).classList.add('active');

            if (targetTabId === 'vehicle-reports-tab') {
                loadVehicleReports();
            } else if (targetTabId === 'deployed-assets-report-tab') {
                loadDeployedAssetsInventoryReport();
            }
        });
        page.dataset.listenerAttached = 'true';
    }
    loadVehicleReports();
}
async function loadVehicleReports() {
    const container = document.getElementById('vehicle-reports-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل التقارير...</p>';
    try {
        const { data: reports, error } = await supabaseClient
            .from('vehicle_reports')
            .select(`*, vehicle:vehicles(vehicle_type, license_plate), reporter:reported_by_user_id(name)`)
            .order('created_at', { ascending: false });

        if (error) throw error;
        if (reports.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا توجد تقارير</h4><p>لم يتم رفع أي تقارير بخصوص المركبات بعد.</p></div>';
            return;
        }

        container.innerHTML = `
            <table><thead><tr>
                <th>تاريخ البلاغ</th><th>المركبة</th><th>نوع البلاغ</th><th>المشرف</th><th>الحالة</th><th>الإجراء</th>
            </tr></thead><tbody>
            ${reports.map(r => `
                <tr>
                    <td>${formatGregorianDateTime(r.created_at)}</td>
                    <td>${r.vehicle.vehicle_type} (${r.vehicle.license_plate})</td>
                    <td>${r.report_type}</td>
                    <td>${r.reporter.name}</td>
                    <td><span class="status ${r.status === 'جديد' ? 'inactive' : 'active'}">${r.status}</span></td>
                    <td>
                        ${r.status === 'جديد' ? `<button class="btn btn-success btn-sm resolve-vehicle-report-btn" data-id="${r.id}">تم الحل</button>` : '-'}
                    </td>
                </tr>
            `).join('')}
            </tbody></table>`;
    } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
}
async function loadDeployedAssetsInventoryReport() {
    const container = document.getElementById('deployed-assets-report-container');
    container.innerHTML = '<p style="text-align: center;">جاري تحميل تقرير الجرد...</p>';
    try {
        const { data: assets, error } = await supabaseClient
            .from('deployed_assets')
            .select(`*, inventory:assets_inventory(asset_type), employee:users!deployed_assets_assigned_to_user_id_fkey(name, role)`)
            .in('status', ['في الخدمة', 'صيانة']) // جلب العهد التي لم تتم إعادتها فقط
            .order('assignment_date', { ascending: false });

        if (error) throw error;
        if (assets.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا توجد عهد مسلمة</h4><p>لم يتم تسليم أي عهد للموظفين حالياً.</p></div>';
            return;
        }
        
        container.innerHTML = `
            <table><thead><tr>
                <th>نوع العهدة</th><th>الرقم التسلسلي</th><th>الموظف المستلم</th><th>دوره الوظيفي</th><th>تاريخ التسليم</th><th>الحالة</th>
            </tr></thead><tbody>
            ${assets.map(a => `
                <tr>
                    <td>${a.inventory.asset_type}</td>
                    <td>${a.serial_number || '-'}</td>
                    <td>${a.employee.name}</td>
                    <td>${a.employee.role}</td>
                    <td>${formatGregorianDate(a.assignment_date)}</td>
                    <td><span class="status ${a.status === 'في الخدمة' ? 'active' : 'pending'}">${a.status}</span></td>
                </tr>
            `).join('')}
            </tbody></table>`;
    } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
}
function setupSearchableSelect(prefix, optionsData) {
    const searchInput = document.getElementById(`${prefix}-search`);
    const optionsContainer = document.getElementById(`${prefix}-options`);
    const hiddenInput = document.getElementById(prefix);

    if (!searchInput || !optionsContainer || !hiddenInput) {
        console.error(`خطأ في الإعداد: واحد أو أكثر من عناصر الواجهة مفقود للـ prefix: "${prefix}".`);
        return; 
    }

    function renderOptions(filter = '') {
        optionsContainer.innerHTML = '';
        const filteredOptions = optionsData.filter(opt => opt.text.toLowerCase().includes(filter.toLowerCase()));

        if(filteredOptions.length === 0) {
            optionsContainer.innerHTML = '<div class="custom-select-option" style="color: #999;">لا توجد نتائج</div>';
            return;
        }

        filteredOptions.forEach(option => {
            const optionEl = document.createElement('div');
            optionEl.className = 'custom-select-option';
            optionEl.textContent = option.text;
            optionEl.dataset.value = option.id;
            optionEl.dataset.details = JSON.stringify(option.details || {});

            if (hiddenInput.value == option.id) {
                optionEl.classList.add('selected');
            }

            optionEl.addEventListener('mousedown', (e) => {
                e.preventDefault();
                hiddenInput.value = option.id;
                searchInput.value = option.text;
                optionsContainer.style.display = 'none';
                hiddenInput.dispatchEvent(new Event('customSelect:change', { bubbles: true }));
                setTimeout(() => optionsContainer.style.display = '', 200);
            });
            optionsContainer.appendChild(optionEl);
        });
    }

    renderOptions();

    searchInput.addEventListener('input', () => {
        renderOptions(searchInput.value);
    });

    searchInput.value = '';
    hiddenInput.value = '';
}

/**
 * دالة لجلب كل بيانات الموظف وعرضها في نافذة "للقراءة فقط"
 * @param {string} idNumber - رقم هوية الموظف
 */
async function populateEmployeeViewModal(idNumber) {
    const modal = document.getElementById('view-employee-modal');
    const body = document.getElementById('view-employee-body');
    const title = document.getElementById('view-employee-title');

    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري تحميل البيانات...</p>';

    try {
        const [
            { data: user, error: userError },
            { data: jobApp, error: jobAppError },
            { data: covApp, error: covAppError }
        ] = await Promise.all([
            supabaseClient.from('users').select('*').eq('id_number', idNumber).single(),
            supabaseClient.from('job_applications').select('id_photo_url, iban_certificate_url').eq('applicant_data->>id_number', idNumber).limit(1).single(),
            supabaseClient.from('coverage_applicants').select('id_photo_url, iban_certificate_url').eq('id_number', idNumber).limit(1).single()
        ]);

        if (userError || !user) throw new Error('لم يتم العثور على بيانات الموظف.');
        const attachments = jobApp || covApp;
        title.textContent = `ملف الموظف: ${user.name}`;
        let detailsHtml = `
            <div class="contract-display">
                <h3>المعلومات الأساسية</h3>
                <p><strong>الاسم:</strong> ${user.name || '-'}</p>
                <p><strong>رقم الهوية:</strong> ${user.id_number || '-'}</p>
                <p><strong>رقم الجوال:</strong> ${user.phone || '-'}</p>
                <p><strong>الدور:</strong> ${user.role || '-'}</p>
                <p><strong>تاريخ المباشرة:</strong> ${formatGregorianDate(user.start_of_work_date)}</p>
                <p><strong>الحالة:</strong> ${user.employment_status || '-'}</p>
                
                <h3 style="margin-top: 20px;">المعلومات المالية</h3>
                <p><strong>اسم البنك:</strong> ${user.bank_name || '-'}</p>
                <p><strong>الآيبان:</strong> ${user.iban || '-'}</p>
                
                <h3 style="margin-top: 20px;">المرفقات</h3>
                <div id="attachments-view-container" class="attachments-grid">
                    <p style="text-align: center; grid-column: 1 / -1;">جاري تحميل المرفقات...</p>
                </div>
            </div>
        `;
        body.innerHTML = detailsHtml;
        const attachmentsContainer = document.getElementById('attachments-view-container');
        if (attachments && attachments.id_photo_url && attachments.iban_certificate_url) {
            const urlsToFetch = [attachments.id_photo_url, attachments.iban_certificate_url];
            
            const { data: signedUrls, error: urlError } = await supabaseClient.storage
                .from('job-applications') // اسم الحاوية صحيح بناءً على الكود عندك
                .createSignedUrls(urlsToFetch, 300); // 5 دقائق صلاحية

            if (urlError) throw urlError;

            const idPhotoUrl = signedUrls.find(u => u.path === attachments.id_photo_url)?.signedUrl;
            const ibanCertUrl = signedUrls.find(u => u.path === attachments.iban_certificate_url)?.signedUrl;

            attachmentsContainer.innerHTML = `
                <div>
                    <h5>صورة الهوية</h5>
                    <img src="${idPhotoUrl || ''}" alt="صورة الهوية" class="attachment-image viewable-image">
                </div>
                <div>
                    <h5>شهادة الآيبان</h5>
                    <img src="${ibanCertUrl || ''}" alt="شهادة الآيبان" class="attachment-image viewable-image">
                </div>
            `;
        } else {
            attachmentsContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">لا توجد مرفقات مسجلة لهذا الموظف.</p>';
        }

    } catch (error) {
        body.innerHTML = `<p style="text-align: center; color: var(--denied-color);">${error.message}</p>`;
        console.error("Error populating view modal:", error);
    }
}
document.body.addEventListener('click', function(event) {
    const viewEmployeeBtn = event.target.closest('.view-employee-btn');
    if (viewEmployeeBtn) {
        event.preventDefault();
        const idNumber = viewEmployeeBtn.dataset.idNumber;
        if (idNumber) {
            populateEmployeeViewModal(idNumber);
        } else {
            alert('خطأ: رقم هوية الموظف غير موجود.');
        }
    }
});

/**
 * دالة لجلب وعرض ملفات التسوية الودية
 */
async function loadSettlementsPage() {
    const container = document.getElementById('settlement-cards-container');
    const searchInput = document.getElementById('settlement-search-input');
    if (!container || !searchInput) return;

    container.innerHTML = '<p style="text-align: center;">جاري تحميل ملفات التسوية...</p>';

    try {
        const searchTerm = searchInput.value.trim().toLowerCase();
        const { data: settlementsJSON, error } = await supabaseClient.rpc('get_settlements_with_latest_update');
        if (error) throw error;
        let settlements = settlementsJSON.map(item => ({
            ...item.settlement_data, // بيانات الملف
            latest_update: item.latest_update // آخر تحديث (قد يكون null)
        }));
        if (searchTerm) {
            settlements = settlements.filter(s =>
                s.case_title.toLowerCase().includes(searchTerm) ||
                s.claimant.toLowerCase().includes(searchTerm)
            );
        }

        if (settlements.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-handshake"></i><h4>لا توجد ملفات تسوية</h4><p>لم يتم العثور على ملفات تطابق بحثك.</p></div>';
            return;
        }
        container.innerHTML = settlements.map(s => {
            let statusClass = 'status-active'; // (قيد التفاوض)
            if (s.outcome === 'تم الصلح') statusClass = 'status-closed';
            else if (s.outcome === 'لم يتم الصلح' || s.outcome === 'تحولت لدعوى') statusClass = 'status-failed';
            let latestUpdateText = 'لم يتم تسجيل إجراءات بعد.';
            if (s.latest_update && s.latest_update.description) {
                latestUpdateText = `(${formatGregorianDate(s.latest_update.update_date)}): ${s.latest_update.description.substring(0, 100)}...`;
            }

            return `
                <div class="settlement-card ${statusClass}" data-id="${s.id}">
                    <div class="settlement-card-header">
                        <h4>${s.case_title}</h4>
                        <span class="status ${statusClass === 'status-active' ? 'pending' : (statusClass === 'status-closed' ? 'active' : 'inactive')}">${s.status}</span>
                    </div>
                    <div class="settlement-card-body">
                        <div class="info-bit"><i class="ph-bold ph-user"></i><div><p>الطرف الأول (المدعي)</p><strong>${s.claimant}</strong></div></div>
                        <div class="info-bit"><i class="ph-bold ph-buildings"></i><div><p>الطرف الثاني (المدعى عليه)</p><strong>${s.respondent}</strong></div></div>
                        <div class="info-bit"><i class="ph-bold ph-money"></i><div><p>المبلغ المطلوب</p><strong>${(s.settlement_amount_requested || 0).toLocaleString('ar-SA')} ر.س</strong></div></div>
                        <div class="info-bit"><i class="ph-bold ph-calendar"></i><div><p>تاريخ فتح الملف</p><strong>${formatGregorianDate(s.filing_date)}</strong></div></div>
                    </div>
                    <div class="settlement-card-footer">
                        <p style="margin:0; font-size: 0.95rem;"><strong>آخر إجراء:</strong> ${latestUpdateText}</p>
                    </div>
                </div>
            `;
        }).join('');

    } catch (err) {
        container.innerHTML = `<p style="color:red; text-align:center;">${err.message}</p>`;
    }
    if (!searchInput.dataset.listenerAttached) {
        searchInput.addEventListener('keyup', () => {
            clearTimeout(hrDebounceTimer);
            hrDebounceTimer = setTimeout(loadSettlementsPage, 500);
        });
        searchInput.dataset.listenerAttached = 'true';
    }
}

/**
 * دالة مساعدة لإنشاء رابط آمن لعرض المرفقات
 */
async function createSignedAttachmentUrl(bucket, path) {
    try {
        const { data, error } = await supabaseClient.storage
            .from(bucket)
            .createSignedUrl(path, 300); // 5 دقائق صلاحية
        if (error) throw error;
        return data.signedUrl;
    } catch (error) {
        console.error('Error creating signed URL:', error);
        return null;
    }
}

/**
 * الخطوة 3.2 (أ): تحميل صفحة "طلب صرف" الجديدة (للموظف)
 * (ستعرض هذه الدالة كل طلبات القسم الخاصة بالموظف)
 */
async function loadFinanceNewRequestPage() {
    const container = document.getElementById('department-financial-requests-container');
    if (!container || !currentUser) return;

    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلبات القسم...</p>';

    try {
        const searchTerm = document.getElementById('finance-request-search').value;
        const statusFilter = document.getElementById('finance-request-status-filter').value;
        let query = supabaseClient
            .from('financial_requests')
            .select(`
                id, created_at, user_id, request_title, amount, status, rejection_reason,
                user:users!financial_requests_user_id_fkey(name)
            `)
            .eq('requesting_department', currentUser.role) // أهم فلتر: جلب طلبات قسم الموظف فقط
            .order('created_at', { ascending: false });
        if (statusFilter) {
            query = query.eq('status', statusFilter);
        }
        if (searchTerm) {
            query = query.or(`request_title.ilike.%${searchTerm}%,users!financial_requests_user_id_fkey.name.ilike.%${searchTerm}%`);
        }
        const { data: requests, error } = await query;
        if (error) throw error;

        if (requests.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-list-checks"></i><h4>لا توجد طلبات</h4><p>لم يتم تقديم أي طلبات صرف من هذا القسم بعد.</p></div>';
            return;
        }
        container.innerHTML = `
            <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>تاريخ الطلب</th>
                        <th>مقدم الطلب</th>
                        <th>عنوان الطلب</th>
                        <th>المبلغ</th>
                        <th>الحالة الحالية</th>
                        <th>ملاحظات</th>
                    </tr>
                </thead>
                <tbody>
                    ${requests.map(req => {
                        let statusClass = 'pending';
                        if (req.status.includes('جاهز')) statusClass = 'active';
                        if (req.status.includes('مرفوض')) statusClass = 'inactive';

                        return `
                            <tr>
                                <td>${formatGregorianDate(req.created_at)}</td>
                                <td>${req.user ? req.user.name : 'غير معروف'}</td>
                                <td>${req.request_title}</td>
                                <td>${req.amount.toLocaleString('ar-SA')} ر.س</td>
                                <td><span class="status ${statusClass}">${req.status}</span></td>
                                <td>${req.rejection_reason || ''}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

    } catch (error) {
        console.error("Error loading department financial requests:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
    }
    if (activeSubscription) supabaseClient.removeChannel(activeSubscription);
    activeSubscription = supabaseClient
        .channel(`public:financial_requests:${currentUser.role}`)
        .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'financial_requests', filter: `requesting_department=eq.${currentUser.role}` },
            (payload) => {
                console.log('Department financial request update received!', payload);
                loadFinanceNewRequestPage();
            }
        )
        .subscribe();
}

/**
 * الخطوة 3.2 (ب): تحميل صفحة موافقات المدير المالي (CFO)
 */

/**
 * دالة مساعدة (جديدة) لرسم قائمة الطلبات للمدراء
 */
function renderFinancialRequestList(container, requests, pageType) {
    if (!requests || requests.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-list-checks"></i><h4>لا توجد طلبات</h4><p>لا توجد طلبات بانتظار المراجعة في هذه المرحلة حالياً.</p></div>';
        return;
    }

    container.innerHTML = requests.map(req => {
        let buttonHtml = '';
        if (pageType === 'cfo') {
            buttonHtml = `<button class="btn btn-primary btn-sm open-financial-review-btn" data-id="${req.id}" data-stage="cfo">مراجعة وموافقة</button>`;
        } else if (pageType === 'ceo') {
            buttonHtml = `<button class="btn btn-primary btn-sm open-financial-review-btn" data-id="${req.id}" data-stage="ceo">مراجعة وموافقة</button>`;
        } else if (pageType === 'auditor') {
            buttonHtml = `<button class="btn btn-primary btn-sm open-auditor-review-btn" data-id="${req.id}">مراجعة وإصدار فاتورة</button>`;
        }

        return `
            <div class="review-request-card">
                <div class="review-request-header status-pending">
                    <h4>${req.request_title}</h4>
                    <span class="status-badge">${req.amount.toLocaleString('ar-SA')} ر.س</span>
                </div>
                <div class="review-request-body">
                    <div class="request-meta-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="request-meta-item"><i class="ph-bold ph-user-circle"></i><span><strong>المقدم:</strong> ${req.user ? req.user.name : 'غير معروف'}</span></div>
                        <div class="request-meta-item"><i class="ph-bold ph-buildings"></i><span><strong>القسم:</strong> ${req.requesting_department}</span></div>
                        <div class="request-meta-item"><i class="ph-bold ph-info"></i><span><strong>النوع:</strong> ${req.request_type}</span></div>
                        <div class="request-meta-item"><i class="ph-bold ph-calendar"></i><span><strong>التاريخ:</strong> ${formatGregorianDate(req.created_at)}</span></div>
                    </div>
                </div>
                <div class="review-request-footer">
                    ${buttonHtml}
                </div>
            </div>
        `;
    }).join('');
}

/**
 * (النسخة الكاملة) تحميل صفحة موافقات المدير المالي (CFO)
 */
async function loadCfoApprovalsPage() {
    const container = document.getElementById('cfo-approvals-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات بانتظار موافقتك...</p>';

    const { data: requests, error } = await supabaseClient
        .from('financial_requests')
        .select(`*, user:users!financial_requests_user_id_fkey(name)`)
        .eq('status', 'بانتظار المدير المالي')
        .order('created_at', { ascending: true });

    if (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    } else {
        renderFinancialRequestList(container, requests, 'cfo');
    }
}

/**
 * (النسخة الكاملة) تحميل صفحة موافقات المدير التنفيذي (CEO)
 */
async function loadCeoApprovalsPage() {
    const container = document.getElementById('ceo-approvals-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات بانتظار موافقتك...</p>';

    const { data: requests, error } = await supabaseClient
        .from('financial_requests')
        .select(`*, user:users!financial_requests_user_id_fkey(name)`)
        .eq('status', 'بانتظار المدير التنفيذي')
        .order('created_at', { ascending: true });

    if (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    } else {
        renderFinancialRequestList(container, requests, 'ceo');
    }
}

/**
 * (النسخة الكاملة) تحميل صفحة موافقات المدقق المالي (Auditor)
 */
async function loadAuditorApprovalsPage() {
    const container = document.getElementById('auditor-approvals-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات بانتظار المراجعة...</p>';

    const { data: requests, error } = await supabaseClient
        .from('financial_requests')
        .select(`*, user:users!financial_requests_user_id_fkey(name)`)
        .eq('status', 'بانتظار المدقق المالي')
        .order('created_at', { ascending: true });

    if (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    } else {
        renderFinancialRequestList(container, requests, 'auditor');
    }
}

/**
 * (النسخة الكاملة) تحميل صفحة أوامر الصرف الجاهزة (للمالية)
 */
async function loadFinanceReadyToPayPage() {
    const container = document.getElementById('ready-to-pay-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل أوامر الصرف الجاهزة...</p>';

    try {
        const searchTerm = document.getElementById('ready-to-pay-search').value;
        const deptFilter = document.getElementById('ready-to-pay-dept-filter').value;

        let query = supabaseClient
            .from('financial_requests')
            .select(`*, user:users!financial_requests_user_id_fkey(name)`)
            .eq('status', 'أمر صرف جاهز')
            .order('auditor_approved_at', { ascending: false });

        if (deptFilter) {
            query = query.eq('requesting_department', deptFilter);
        }
        if (searchTerm) {
            query = query.or(`request_title.ilike.%${searchTerm}%,final_invoice_number.ilike.%${searchTerm}%,final_client_name.ilike.%${searchTerm}%,users!financial_requests_user_id_fkey.name.ilike.%${searchTerm}%`);
        }

        const { data: requests, error } = await query;
        if (error) throw error;

        if (requests.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-printer"></i><h4>لا توجد أوامر صرف</h4><p>لا توجد طلبات جاهزة للدفع حالياً.</p></div>';
            return;
        }

        container.innerHTML = `
            <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>رقم الطلب/الفاتورة</th>
                        <th>العميل (المفوتر)</th>
                        <th>القسم الطالب</th>
                        <th>العنوان</th>
                        <th>المبلغ</th>
                        <th>تاريخ الاعتماد</th>
                        <th>ملاحظات المدقق</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    ${requests.map(req => {
                        const isPayroll = req.request_type === 'رواتب ومسيرات';
                        const rowStyle = isPayroll ? 'background-color: #f0fdf4;' : ''; 
                        const icon = isPayroll ? '<i class="ph-bold ph-users-three" style="color:#16a34a"></i>' : '<i class="ph-bold ph-file-text"></i>';

                        const bankFileBtn = isPayroll 
                            ? `<button class="btn btn-info btn-sm export-bank-file-btn" data-id="${req.linked_draft_id}" title="تحميل ملف البنك CSV"><i class="ph-bold ph-bank"></i> ملف البنك</button>`
                            : '';

                        const displayId = req.final_invoice_number || String(req.id).substring(0, 8);
                        const clientName = req.final_client_name || '-';
                        const amountEnglish = req.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                        return `
                            <tr style="${rowStyle}">
                                <td><strong>${displayId}</strong></td>
                                <td>${clientName}</td>
                                <td>${req.requesting_department}</td>
                                <td><div style="display:flex; align-items:center; gap:5px;">${icon} ${req.request_title}</div></td>
                                <td style="font-weight:bold; color:#16a34a; direction: ltr;">${amountEnglish} SAR</td>
                                <td>${formatGregorianDateTime(req.auditor_approved_at)}</td>
                                <td style="max-width: 200px; font-size: 0.85rem; color: #666;">${req.auditor_notes || '-'}</td>
                                <td>
                                    <div style="display: flex; gap: 5px; justify-content: flex-end;">
                                        ${bankFileBtn}
                                        <button class="btn btn-secondary btn-sm open-financial-review-btn" data-id="${req.id}" data-stage="final_view" title="عرض التفاصيل"><i class="ph-bold ph-eye"></i></button>
                                        <button class="btn btn-success btn-sm open-payment-modal-btn" data-id="${req.id}" title="تسجيل الدفع"><i class="ph-bold ph-check-fat"></i> صرف</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

    } catch (error) {
        console.error("Error loading ready-to-pay:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
    }
}
/**
 * (النسخة الكاملة) تحميل صفحة أرشيف الطلبات المالية (للمالية)
 */
async function loadFinanceArchivePage(tab = 'approved') {
    const containerId = (tab === 'approved') ? 'archive-approved-container' : 'archive-rejected-container';
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '<p style="text-align: center;">جاري تحميل الأرشيف...</p>';

    const statusFilter = (tab === 'approved') ? 'مكتمل' : 'مرفوض';

    try {
        const searchTerm = document.getElementById('archive-filter-search').value;
        const deptFilter = document.getElementById('archive-filter-department').value;
        const typeFilter = document.getElementById('archive-filter-type').value;
        const { data: requests, error } = await supabaseClient
            .rpc('search_financial_archive', {
                p_status: statusFilter,
                p_search: searchTerm ? `%${searchTerm}%` : null,  // (إضافة %%) للبحث
                p_dept: deptFilter || null,
                p_type: typeFilter ? `%${typeFilter}%` : null // (إضافة %%) للبحث
            });

        if (error) throw error;

        if (requests.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-archive-box"></i><h4>الأرشيف فارغ</h4><p>لا توجد طلبات في هذا القسم تطابق بحثك.</p></div>';
            return;
        }
        container.innerHTML = `
            <table class="attendance-log-table">
                <thead>
                    <tr>
                        <th>تاريخ الإغلاق</th>
                        <th>مقدم الطلب</th>
                        <th>القسم</th>
                        <th>عنوان الطلب</th>
                        <th>رقم الفاتورة</th>
                        <th>المبلغ</th>
                        <th>الحالة</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody>
                    ${requests.map(req => `
                        <tr>
                            <td>${formatGregorianDateTime(req.payment_completed_at)}</td>
                            <td>${req.user_name || 'غير معروف'}</td>
                            <td>${req.requesting_department}</td>
                            <td>${req.request_title}</td>
                            <td>${req.final_invoice_number || '-'}</td>
                            <td>${req.amount.toLocaleString('en-US')} ر.س</td>
                            <td><span class="status ${tab === 'approved' ? 'active' : 'inactive'}">${req.status}</span></td>
                            <td>
                                <button class="btn btn-secondary btn-sm open-archive-view-btn" data-id="${req.id}" title="عرض التفاصيل الكاملة"><i class="ph-bold ph-eye"></i></button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

    } catch (error) {
        console.error("Error loading archive:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
    }
}
document.addEventListener('change', function(event) {
    if (event.target.classList.contains('finance-archive-filter')) {
        const activeTab = document.querySelector('#page-finance-archive .tab-link.active').dataset.tab === 'archive-approved-tab' ? 'approved' : 'rejected';
        loadFinanceArchivePage(activeTab);
    }
});
document.addEventListener('input', function(event) {
    if (event.target.classList.contains('finance-archive-filter')) {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            const activeTab = document.querySelector('#page-finance-archive .tab-link.active').dataset.tab === 'archive-approved-tab' ? 'approved' : 'rejected';
            loadFinanceArchivePage(activeTab);
        }, 500);
    }
});

/**
 * الخطوة 3.5 (ب): دالة فتح "النافذة الذكية" لطلب الصرف
 * (سيتم برمجتها في الخطوة التالية)
 */
async function openFinancialRequestModal() {
    const modal = document.getElementById('financial-request-modal');
    const form = document.getElementById('financial-request-form');
    form.reset();
    const legalFields = document.getElementById('financial-legal-fields');
    const generalFields = document.getElementById('financial-general-fields');
    const requestTypeSelect = document.getElementById('financial-request-type');
    const titleInput = document.getElementById('financial-request-title-input');
    document.getElementById('financial-payment-details-iban').classList.add('hidden');
    document.getElementById('financial-payment-details-sadad').classList.add('hidden');
    document.getElementById('financial-request-type-other-group').classList.add('hidden');
    const requestTypes = {
        'ادارة الموارد البشرية': ['انتداب موظفين', 'تامين طبي', 'تامينات اجتماعية', 'مكافئات موظفين', 'منصة امن', 'اخرى'],
        'التسويق': ['تذاكر طيران', 'فنادق', 'شحن الغرفه التجارية', 'اشتراكات برامج', 'اخرى'],
        'ادارة العهد': ['فاتورة منصة تم', 'اخرى','رصيد للجوالات', 'اوراق', 'حبر الطابعه', 'صيانة الطابعات', 'فواتير اجهزة الاتصال اللاسلكية', 'اخرى'],
        'المالية': ['ايجارات فروع الشركة', 'فواتير انترنت', 'كهرباء', 'العمولات البنكية', 'عمولات المسوقين', 'اخرى'],
        'الشؤون القانونية': ['مخالصة نهاية خدمة'], // (حالة خاصة)
        'مدير النظام': ['مصروفات إدارية', 'مشتريات مكتبية', 'ايجارات فروع الشركة', 'فواتير انترنت', 'كهرباء', 'اخرى'],
        'ادارة العمليات': ['مصروفات تشغيلية', 'اخرى'], // (قسم مضاف)
        'ادارة العقود': ['مصروفات العقود', 'اخرى'] // (قسم مضاف)
    };

    const userRole = currentUser.role;
    let options = requestTypes[userRole] || ['اخرى']; // قائمة افتراضية إذا لم يتم العثور على القسم
    if (userRole === 'الشؤون القانونية') {
        legalFields.classList.remove('hidden');
        generalFields.classList.add('hidden');
        document.getElementById('financial-request-title').textContent = 'تقديم مخالصة نهاية خدمة';
        titleInput.value = 'مخالصة نهاية خدمة'; // تعبئة العنوان تلقائياً
        const employeeSelect = document.getElementById('legal-request-employee');
        employeeSelect.innerHTML = '<option value="">جاري تحميل الموظفين...</option>';
        const { data: employees, error } = await supabaseClient
            .from('users')
            .select('id, name')
            .in('role', ['حارس أمن', 'مشرف']) // يمكن تعديلها لتشمل الإداريين
            .not('employment_status', 'eq', 'مؤرشف');

        if (employees) {
            employeeSelect.innerHTML = '<option value="">-- اختر موظف --</option>';
            employeeSelect.innerHTML += employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
        }

    } else {
        legalFields.classList.add('hidden');
        generalFields.classList.remove('hidden');
        document.getElementById('financial-request-title').textContent = 'تقديم طلب صرف جديد';
        titleInput.value = ''; // إفراغ العنوان
        requestTypeSelect.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
    }

    modal.classList.remove('hidden');
}

/**
 * الخطوة 3.5 (ج): دالة حفظ "طلب الصرف" الجديد
 * (سيتم برمجتها في الخطوة التالية)
 */
async function saveFinancialRequest(saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="ph-fill ph-spinner-gap animate-spin"></i> جاري الإرسال...';

    try {
        const userRole = currentUser.role;
        const requestData = {
            user_id: currentUser.id,
            requesting_department: userRole,
            status: 'بانتظار المدير المالي',
            payment_details: {}
        };
        if (userRole === 'الشؤون القانونية') {
            const selectedEmployeeId = document.getElementById('legal-request-employee').value;
            if (!selectedEmployeeId) throw new Error('الرجاء اختيار الموظف صاحب المخالصة.');

            requestData.request_type = 'مخالصة نهاية خدمة';
            requestData.request_title = 'مخالصة نهاية خدمة - ' + document.getElementById('legal-request-employee').selectedOptions[0].text;
            requestData.amount = (
                (parseFloat(document.getElementById('legal-salary').value) || 0) +
                (parseFloat(document.getElementById('legal-bonus').value) || 0) +
                (parseFloat(document.getElementById('legal-leave').value) || 0) +
                (parseFloat(document.getElementById('legal-case-amount').value) || 0)
            );
            requestData.payment_method = 'iban'; // المخالصة دائماً آيبان
            const { data: empData } = await supabaseClient.from('users').select('name, iban, bank_name').eq('id', selectedEmployeeId).single();
            requestData.payment_details = {
                beneficiary_name: empData.name,
                bank_name: empData.bank_name,
                iban: empData.iban
            };

        } else {
            requestData.request_title = document.getElementById('financial-request-title-input').value;
            requestData.request_type = document.getElementById('financial-request-type').value;
            requestData.amount = parseFloat(document.getElementById('financial-request-amount').value);
            requestData.payment_method = document.getElementById('financial-payment-method').value;
            requestData.notes = document.getElementById('financial-request-notes').value;

            if (requestData.request_type === 'اخرى') {
                requestData.request_type = document.getElementById('financial-request-type-other').value;
            }

            if (requestData.payment_method === 'iban') {
                requestData.payment_details = {
                    beneficiary_name: document.getElementById('iban-beneficiary-name').value,
                    bank_name: document.getElementById('iban-bank-name').value,
                    iban: document.getElementById('iban-number').value
                };
            } else if (requestData.payment_method === 'sadad') {
                requestData.payment_details = {
                    biller_name: document.getElementById('sadad-biller-name').value,
                    biller_number: document.getElementById('sadad-biller-number').value
                };
            }
        }
        if (!requestData.request_title || !requestData.amount || requestData.amount <= 0) {
            throw new Error('الرجاء تعبئة عنوان الطلب والمبلغ بشكل صحيح.');
        }
        const { data: newRequest, error: insertError } = await supabaseClient
            .from('financial_requests')
            .insert(requestData)
            .select('id')
            .single();

        if (insertError) throw insertError;
        const newRequestId = newRequest.id;
        let fileURLs = {};
        if (userRole === 'الشؤون القانونية') {
            const resignationFile = document.getElementById('legal-attach-resignation').files[0];
            const clearanceFile = document.getElementById('legal-attach-clearance').files[0];
            const judgmentFile = document.getElementById('legal-attach-judgment').files[0];
            const [resUrl, clrUrl, judUrl] = await Promise.all([
                uploadFinancialAttachment(resignationFile, userRole, newRequestId),
                uploadFinancialAttachment(clearanceFile, userRole, newRequestId),
                uploadFinancialAttachment(judgmentFile, userRole, newRequestId)
            ]);
            requestData.payment_details.attachments = {
                resignation: resUrl,
                clearance: clrUrl,
                judgment: judUrl
            };

        } else {
            const invoiceFile = document.getElementById('financial-request-attachment').files[0];
            if (invoiceFile) {
                fileURLs.invoice_attachment_url = await uploadFinancialAttachment(invoiceFile, userRole, newRequestId);
            }
        }
        const updateData = {
            payment_details: requestData.payment_details,
            ...fileURLs // إضافة رابط الفاتورة الأولية
        };

        const { error: updateError } = await supabaseClient
            .from('financial_requests')
            .update(updateData)
            .eq('id', newRequestId);

        if (updateError) throw updateError;
        await supabaseClient.from('financial_requests_log').insert({
            request_id: newRequestId,
            user_id: currentUser.id,
            action_taken: `تم تقديم الطلب بواسطة ${currentUser.name}`
        });
        const { data: cfoUsers, error: cfoError } = await supabaseClient
            .from('users')
            .select('id')
            .eq('is_cfo', true);

        if (cfoError) console.error("Error fetching CFO:", cfoError);
        if (cfoUsers && cfoUsers.length > 0) {
            const cfoIds = cfoUsers.map(user => user.id);
            sendNotification(
                cfoIds,
                'طلب صرف جديد بانتظار موافقتك',
                `تم تقديم طلب صرف جديد من قسم ${userRole} بواسطة ${currentUser.name}.`,
                '/finance/cfo-approvals'
            );
        }
        showToast('تم إرسال طلب الصرف بنجاح.', 'success');
        document.getElementById('financial-request-modal').classList.add('hidden');
        loadFinanceNewRequestPage(); // تحديث قائمة طلبات القسم

    } catch (error) {
        alert(`حدث خطأ: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'إرسال الطلب للمراجعة';
    }
}

/**
 * الخطوة 3.5 (د): مستمعات لتغيير الحقول داخل النافذة الذكية
 */
document.addEventListener('change', function(event) {
    const target = event.target;
    if (target.id === 'financial-request-type') {
        const otherGroup = document.getElementById('financial-request-type-other-group');
        const otherInput = document.getElementById('financial-request-type-other');
        if (target.value === 'اخرى') {
            otherGroup.classList.remove('hidden');
            otherInput.required = true;
        } else {
            otherGroup.classList.add('hidden');
            otherInput.required = false;
        }
    }
    if (target.id === 'financial-payment-method') {
        const ibanFields = document.getElementById('financial-payment-details-iban');
        const sadadFields = document.getElementById('financial-payment-details-sadad');
        const ibanInputs = ibanFields.querySelectorAll('input');
        const sadadInputs = sadadFields.querySelectorAll('input');

        if (target.value === 'iban') {
            ibanFields.classList.remove('hidden');
            sadadFields.classList.add('hidden');
            ibanInputs.forEach(input => input.required = true);
            sadadInputs.forEach(input => input.required = false);
        } else if (target.value === 'sadad') {
            ibanFields.classList.add('hidden');
            sadadFields.classList.remove('hidden');
            ibanInputs.forEach(input => input.required = false);
            sadadInputs.forEach(input => input.required = true);
        } else {
            ibanFields.classList.add('hidden');
            sadadFields.classList.add('hidden');
            ibanInputs.forEach(input => input.required = false);
            sadadInputs.forEach(input => input.required = false);
        }
    }
});

/**
 * الخطوة 3.5 (هـ): مستمع لحساب الإجمالي (لقسم الشؤون القانونية)
 */
document.addEventListener('input', function(event) {
    const target = event.target;
    if (target.id === 'legal-salary' || target.id === 'legal-bonus' || target.id === 'legal-leave') {
        const salary = parseFloat(document.getElementById('legal-salary').value) || 0;
        const bonus = parseFloat(document.getElementById('legal-bonus').value) || 0;
        const leave = parseFloat(document.getElementById('legal-leave').value) || 0;
        const total = salary + bonus + leave;
        document.getElementById('legal-total').value = total.toLocaleString('ar-SA') + ' ر.س';
    }
});
/**
 * دالة مساعدة لرفع ملف مرفق (فاتورة أو غيرها)
 * @param {File} file - الملف المأخوذ من <input type="file">
 * @param {string} department - اسم القسم (لإنشاء مجلد خاص به)
 * @param {number} requestId - معرّف الطلب لربط الملف به
 * @returns {Promise<string>} - يُرجع مسار الملف (path) في Storage
 */
async function uploadFinancialAttachment(file, department, requestId) {
    if (!file) return null;
    const departmentPaths = {
        'ادارة الموارد البشرية': 'hr',
        'تقنية المعلومات': 'it',
        'التسويق': 'marketing',
        'ادارة العهد': 'assets',
        'المالية': 'finance',
        'الشؤون القانونية': 'legal',
        'مدير النظام': 'admin',
        'ادارة العمليات': 'ops',
        'ادارة العقود': 'contracts',
        'مشرف': 'supervisor',
        'حارس أمن': 'guard'
    };
    const safeDepartment = departmentPaths[department] || 'general';

    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
    const filePath = `financial_requests/${safeDepartment}/${requestId}/${fileName}`;

    const { data, error } = await supabaseClient.storage
        .from('job-applications') // (استخدام الحاوية العامة الموجودة لدينا)
        .upload(filePath, file);

    if (error) {
        throw new Error(`فشل رفع المرفق (${file.name}): ${error.message} (Invalid key: ${filePath})`);
    }

    return data.path; // إرجاع المسار فقط
}
/**
 * دالة مساعدة لبناء كود HTML لعرض تفاصيل طلب الصرف
 * @param {object} request - كائن الطلب الكامل من قاعدة البيانات
 * @returns {string} - كود HTML
 */
/**
 * دالة مساعدة لبناء كود HTML لعرض تفاصيل طلب الصرف
 * @param {object} request - كائن الطلب الكامل من قاعدة البيانات
 * @returns {string} - كود HTML
 */
function buildReviewModalBody(request) {
    if (!request) return '<p>لم يتم العثور على بيانات الطلب.</p>';

    let detailsHtml = '';
    let attachmentSection = '';
    if (request.request_type === 'رواتب ومسيرات' && request.linked_draft_id) {
        attachmentSection = `
            <div class="info-bit" style="grid-column: 1 / -1; background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px dashed #bae6fd;">
                <i class="ph-bold ph-users-three" style="color: #0ea5e9; font-size: 1.5rem;"></i>
                <div style="width: 100%;">
                    <p style="font-weight: bold; color: #0369a1; margin-bottom: 5px;">ملف مسير الرواتب</p>
                    <p style="font-size: 0.9rem; color: #555;">هذا الطلب عبارة عن مسير رواتب إلكتروني. يمكنك مراجعة التفاصيل الكاملة لكل موظف.</p>
                    <button type="button" class="btn btn-primary btn-sm" onclick="openPayrollDraftEditor('${request.linked_draft_id}', true)" style="margin-top: 10px; width: 100%;">
                        <i class="ph-bold ph-table"></i> فتح كشف المسير الكامل (للمراجعة)
                    </button>
                </div>
            </div>
        `;
    } 
    else if (request.invoice_attachment_url) {
        attachmentSection = `
            <div class="info-bit" style="grid-column: 1 / -1; background: #fffbeb; padding: 10px; border-radius: 6px;">
                <i class="ph-bold ph-paperclip" style="color: #f59e0b;"></i>
                <div>
                    <p>الفاتورة الأولية المرفقة</p>
                    <button type="button" class="btn btn-secondary btn-sm view-financial-attachment-btn" data-url="${request.invoice_attachment_url}">
                        <i class="ph-bold ph-eye"></i> عرض المرفق
                    </button>
                </div>
            </div>
        `;
    }

    detailsHtml += attachmentSection;
    if (request.payment_method === 'iban') {
        detailsHtml += `
            <div class="info-bit"><i class="ph-bold ph-bank"></i><div><p>اسم المستفيد</p><strong>${request.payment_details?.beneficiary_name || '-'}</strong></div></div>
            <div class="info-bit"><i class="ph-bold ph-credit-card"></i><div><p>رقم الآيبان</p><strong>${request.payment_details?.iban || '-'}</strong></div></div>
        `;
    } else if (request.payment_method === 'bank_file') {
        detailsHtml += `
            <div class="info-bit" style="grid-column: 1 / -1;"><i class="ph-bold ph-file-csv"></i><div><p>طريقة الدفع</p><strong>ملف رواتب بنكي (Bulk Payment)</strong></div></div>
        `;
    }
    detailsHtml += `
        <div class="info-bit" style="grid-column: 1 / -1;"><i class="ph-bold ph-note"></i><div><p>ملاحظات</p>
            <strong>${request.notes || 'لا توجد ملاحظات'}</strong>
        </div></div>
    `;
    if (request.cfo_notes) detailsHtml += `<div class="info-bit" style="grid-column: 1 / -1; background: #f0fdf4; padding: 8px;"><small>المدير المالي:</small> <strong>${request.cfo_notes}</strong></div>`;
    if (request.ceo_notes) detailsHtml += `<div class="info-bit" style="grid-column: 1 / -1; background: #fff7ed; padding: 8px;"><small>المدير التنفيذي:</small> <strong>${request.ceo_notes}</strong></div>`;

    return `
        <div class="profile-card" style="box-shadow: none; padding: 0;">
            <div class="profile-card-header">
                <h4>${request.request_title}</h4>
                <span class="status-badge pending">${request.status}</span>
            </div>
            <div class="profile-card-body" style="padding: 20px 0 0 0;">
                <div class="profile-grid" style="gap: 15px;">
                    <div class="info-bit"><i class="ph-bold ph-user"></i><div><p>المصدر</p><strong>${request.requesting_department}</strong></div></div>
                    <div class="info-bit"><i class="ph-bold ph-money"></i><div><p>المبلغ الإجمالي</p><strong>${request.amount.toLocaleString('en-US')} ر.س</strong></div></div>
                    <hr style="grid-column: 1 / -1;">
                    ${detailsHtml}
                </div>
            </div>
        </div>
    `;
}

/**
 * 1. تحميل صفحة استقالات المشرف (المسار الجديد)
 * (تستخدم دالة SQL لتطبيق الصلاحيات)
 */

/**
 * (النسخة الكاملة) تحميل صفحة استقالات المشرف
 * (تستخدم دالة SQL لتطبيق الصلاحيات)
 */
async function loadSupervisorResignationsPage() {
    const container = document.getElementById('supervisor-resignations-container');
    if (!container || !currentUser) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلبات الاستقالة...</p>';

    try {
        const { data, error } = await supabaseClient.rpc('get_supervisor_pending_requests', {
            p_supervisor_id: currentUser.id,
            p_request_type: 'resignation'
        });

        if (error) throw error;
        const userIds = data.map(r => r.user_id);
        if (userIds.length > 0) {
            const { data: usersData, error: usersError } = await supabaseClient
                .from('users')
                .select('id, name, vacancy_id')
                .in('id', userIds);
            if (usersError) throw usersError;
            const requestsWithUsers = data.map(req => ({
                ...req,
                user: usersData.find(u => u.id === req.user_id)
            }));

            renderRequests(requestsWithUsers, 'supervisor-resignations-container', 'استقالة', 'supervisor_approval');
        } else {
             renderRequests([], 'supervisor-resignations-container', 'استقالة', 'supervisor_approval');
        }


    } catch (error) {
        console.error("Error loading supervisor resignations:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
    }
}

/**
 * (النسخة الكاملة) تحميل صفحة استقالات الشؤون القانونية
 */
async function loadLegalResignationsPage() {
    const container = document.getElementById('legal-resignations-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات بانتظار الاعتماد...</p>';

    try {
        const { data: requests, error } = await supabaseClient
            .from('employee_requests')
            .select(`*, user:users!employee_requests_user_id_fkey(name, vacancy_id)`)
            .eq('request_type', 'resignation')
            .eq('status', 'بانتظار موافقة الشؤون القانونية')
            .order('created_at', { ascending: true });

        if (error) throw error;

        renderRequests(requests, 'legal-resignations-container', 'استقالة', 'legal_approval');

    } catch (error) {
        console.error("Error loading legal resignations:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
    }
}

/**
 * 3. تحميل صفحة السلف للمالية (المسار الجديد)
 */
async function loadFinanceLoansPage() {
    const container = document.getElementById('finance-loans-container');
    if (!container) return;
    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلبات السلف بانتظار الصرف...</p>';

    try {
        const { data: requests, error } = await supabaseClient
            .from('employee_requests')
            .select(`*, user:users!employee_requests_user_id_fkey(name)`)
            .eq('request_type', 'loan')
            .eq('status', 'بانتظار الصرف من المالية')
            .order('created_at', { ascending: true });

        if (error) throw error;
        renderRequests(requests, 'finance-loans-container', 'سلفة', 'finance_view');

    } catch (error) {
        console.error("Error loading finance loans:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
    }
}
async function fetchAddressFromCoords(lat, lng, displayElement) {
    displayElement.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري جلب اسم الموقع...';
    displayElement.style.color = 'var(--accent-color)';

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`);
        
        if (!response.ok) throw new Error('فشل الاتصال');
        
        const data = await response.json();
        
        if (data && data.display_name) {
            const parts = data.display_name.split(', ');
            const shortAddress = parts.slice(0, 4).join('، ');
            
            displayElement.innerHTML = `<i class="ph-bold ph-map-pin"></i> ${shortAddress}`;
            displayElement.style.color = '#16a34a'; // لون أخضر للتأكيد
        } else {
            displayElement.textContent = 'لم يتم العثور على عنوان معروف لهذه الإحداثيات.';
            displayElement.style.color = '#6b7280';
        }
    } catch (error) {
        console.error("Geocoding error:", error);
        displayElement.textContent = 'تعذر تحديد اسم الموقع (تأكد من صحة الإحداثيات).';
        displayElement.style.color = '#ef4444'; // لون أحمر
    }
}
document.body.addEventListener('input', function(event) {
    if (event.target.classList.contains('location-geofence-link')) {
        const inputField = event.target;
        const addressDisplay = inputField.parentElement.querySelector('.coords-address-preview');
        const rawValue = inputField.value.trim();
        if (!rawValue) {
            addressDisplay.textContent = '';
            return;
        }
        let match = rawValue.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/) || // رابط جوجل القديم
                    rawValue.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/) || // رابط بحث
                    rawValue.match(/^(-?\d+\.\d+),\s*(-?\d+\.\d+)$/) || // إحداثيات مباشرة
                    rawValue.match(/maps\.google\.com\/[0-9]*(-?\d+\.\d+),(-?\d+\.\d+)/); // الرابط الطويل

        if (match && match.length >= 3) {
            const lat = match[1];
            const lng = match[2];
            clearTimeout(inputField.geoTimer);
            inputField.geoTimer = setTimeout(() => {
                fetchAddressFromCoords(lat, lng, addressDisplay);
            }, 800);
        } else {
            addressDisplay.textContent = ''; // لا نعرض شيئاً إذا لم تكن الصيغة صحيحة بعد
        }
    }
});
const showExtraGuardsBtn = document.getElementById('show-extra-guards-report-btn');
if (showExtraGuardsBtn) {
    showExtraGuardsBtn.addEventListener('click', loadExtraGuardsReport);
}
async function loadExtraGuardsReport() {
    const modal = document.getElementById('extra-guards-modal');
    const body = document.getElementById('extra-guards-body');
    modal.classList.remove('hidden');
    body.innerHTML = '<p style="text-align: center;">جاري فحص قاعدة البيانات...</p>';

    try {
        const { data: guards, error } = await supabaseClient.rpc('get_problematic_employees');
        if (error) throw error;

        if (guards.length === 0) {
            body.innerHTML = '<div class="empty-state"><h4>النظام نظيف!</h4><p>لا يوجد حراس زائدين أو غير مرتبطين حالياً.</p></div>';
            return;
        }

        body.innerHTML = `
            <p style="margin-bottom: 15px; color: var(--denied-color);">تم العثور على <strong>${guards.length}</strong> حارس بحاجة للمراجعة (زائدين أو بياناتهم غير مكتملة).</p>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الدور</th>
                            <th>الحالة</th>
                            <th>سبب الظهور هنا</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${guards.map(g => `
                            <tr>
                                <td>${g.name}</td>
                                <td>${g.role}</td>
                                <td>${g.employment_status}</td>
                                <td style="font-weight:bold; color:#b91c1c;">${g.reason}</td>
                                <td>
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        <button class="btn btn-secondary btn-sm edit-employee-btn" data-id="${g.id}" title="تعديل البيانات">
                                            <i class="ph-bold ph-pencil-simple"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-employee-btn" data-id="${g.id}" title="حذف نهائي">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

    } catch (err) {
        body.innerHTML = `<p style="color:red; text-align:center;">حدث خطأ: ${err.message}</p>`;
    }
}
function normalizeArabic(text) {
    if (!text) return "";
    return text
        .replace(/([أإآ])/g, 'ا')
        .replace(/ة/g, 'ه')
        .replace(/ى/g, 'ي')
        .replace(/[ًٌٍَُِّْ]/g, ''); // إزالة التشكيل
}
document.body.addEventListener('input', function(e) {
    if (e.target.id === 'contract-modal-search') {
        const rawTerm = e.target.value.trim();
        const term = normalizeArabic(rawTerm.toLowerCase()); // تطبيع نص البحث
        
        const locationCards = document.querySelectorAll('#locations-container .location-entry-card');
        let firstMatch = null;

        locationCards.forEach(card => {
            const locationNameInput = card.querySelector('.location-name-input');
            const rawLocName = locationNameInput ? locationNameInput.value : '';
            const locationName = normalizeArabic(rawLocName.toLowerCase());
            const shiftCards = card.querySelectorAll('.shift-entry-card');
            let hasMatchingShift = false;

            shiftCards.forEach(shift => {
                const shiftNameInput = shift.querySelector('.shift-name');
                const rawShiftName = shiftNameInput ? shiftNameInput.value : '';
                const shiftName = normalizeArabic(rawShiftName.toLowerCase());
                if (term !== '' && shiftName.includes(term)) {
                    hasMatchingShift = true;
                    shift.style.border = '2px solid var(--accent-color)';
                    shift.style.backgroundColor = '#eff6ff';
                } else {
                    shift.style.border = '';
                    shift.style.backgroundColor = '';
                }
            });
            if (term === '') {
                card.style.display = 'block';
            } else if (locationName.includes(term) || hasMatchingShift) {
                card.style.display = 'block';
                if (!firstMatch) firstMatch = card; 
            } else {
                card.style.display = 'none';
            }
        });
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
});
function createEditSchedulePeriodRow(start = '', end = '') {
    return `
        <div class="edit-period-row" style="display: flex; gap: 10px; align-items: flex-end;">
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label style="font-size: 0.8rem; color: var(--text-secondary);">من</label>
                <input type="time" class="edit-period-start" value="${start}">
            </div>
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label style="font-size: 0.8rem; color: var(--text-secondary);">إلى</label>
                <input type="time" class="edit-period-end" value="${end}">
            </div>
            <button type="button" class="btn btn-danger btn-sm remove-period-btn" style="height: 42px; padding: 0 15px;" title="حذف الفترة">
                <i class="ph-bold ph-trash"></i>
            </button>
        </div>
    `;
}
document.body.addEventListener('click', function(event) {
    const btn = event.target.closest('.edit-guard-schedule-btn');
    if (btn) {
        const vacancyId = btn.dataset.vacancyId;
        let scheduleData = {};
        try { 
            scheduleData = JSON.parse(btn.dataset.schedule); 
        } catch(e) { 
            console.error("Error parsing schedule:", e);
        }
        
        if (!vacancyId || vacancyId === 'null') return alert('هذا الحارس غير مرتبط بشاغر، لا يمكن تعديل جدوله.');

        const modal = document.getElementById('edit-guard-schedule-modal');
        const periodsContainer = document.getElementById('edit-schedule-periods-container');
        
        document.getElementById('edit-schedule-vacancy-id').value = vacancyId;
        document.getElementById('edit-schedule-current-json').value = JSON.stringify(scheduleData);
        periodsContainer.innerHTML = '';
        let periods = scheduleData.periods || [];
        if (periods.length === 0 && scheduleData.start_time) {
            periods.push({ start_time: scheduleData.start_time, end_time: scheduleData.end_time });
        }
        if (periods.length === 0) {
            periods.push({ start_time: '', end_time: '' });
        }
        periods.forEach(p => {
            periodsContainer.insertAdjacentHTML('beforeend', createEditSchedulePeriodRow(p.start_time, p.end_time));
        });
        const days = scheduleData.days || [];
        document.querySelectorAll('input[name="edit-schedule-days"]').forEach(cb => {
            cb.checked = days.includes(cb.value);
        });

        modal.classList.remove('hidden');
    }
    if (event.target.closest('#add-period-to-schedule-btn')) {
        const container = document.getElementById('edit-schedule-periods-container');
        container.insertAdjacentHTML('beforeend', createEditSchedulePeriodRow());
    }
    if (event.target.closest('.remove-period-btn')) {
        const row = event.target.closest('.edit-period-row');
        const container = document.getElementById('edit-schedule-periods-container');
        if (container.children.length > 1) {
            row.remove();
        } else {
            row.querySelector('.edit-period-start').value = '';
            row.querySelector('.edit-period-end').value = '';
        }
    }
});
document.body.addEventListener('click', async function(event) {
    const btn = event.target.closest('#save-guard-schedule-btn');
    
    if (btn) {
        event.preventDefault(); // منع أي تداخل افتراضي
        const vacancyIdInput = document.getElementById('edit-schedule-vacancy-id');
        const container = document.getElementById('edit-schedule-periods-container');
        
        if (!vacancyIdInput || !container) {
            alert('خطأ تشخيصي: لم يتم العثور على الحقول المخفية في النافذة. تأكد من كود HTML.');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'جاري الحفظ...';

        try {
            const vacancyId = vacancyIdInput.value;
            const periodRows = container.querySelectorAll('.edit-period-row');
            const newPeriods = [];
            let totalWorkHours = 0;

            periodRows.forEach(row => {
                const start = row.querySelector('.edit-period-start').value;
                const end = row.querySelector('.edit-period-end').value;
                
                if (start && end) {
                    newPeriods.push({ start_time: start, end_time: end });
                    const s = new Date(`1970-01-01T${start}`);
                    const e = new Date(`1970-01-01T${end}`);
                    let diff = (e - s) / (1000 * 60 * 60);
                    if (diff < 0) diff += 24;
                    totalWorkHours += diff;
                }
            });

            const selectedDays = Array.from(document.querySelectorAll('input[name="edit-schedule-days"]:checked')).map(cb => cb.value);

            if (newPeriods.length === 0 || selectedDays.length === 0) {
                throw new Error('الرجاء تحديد فترة عمل واحدة على الأقل واختيار أيام العمل.');
            }
            const oldScheduleJson = document.getElementById('edit-schedule-current-json').value;
            const oldSchedule = oldScheduleJson ? JSON.parse(oldScheduleJson) : {};

            const newSchedule = {
                ...oldSchedule, 
                days: selectedDays,
                periods: newPeriods,
                start_time: newPeriods[0].start_time,
                end_time: newPeriods[0].end_time,
                work_hours: parseFloat(totalWorkHours.toFixed(2))
            };
            const { error } = await supabaseClient
                .from('job_vacancies')
                .update({ 
                    schedule_details: [newSchedule],
                    work_hours: newSchedule.work_hours,
                    work_days_count: selectedDays.length
                })
                .eq('id', vacancyId);

            if (error) throw error;

            showToast('تم تحديث جدول الحارس بنجاح.', 'success');
            document.getElementById('edit-guard-schedule-modal').classList.add('hidden');
            if (typeof loadSupervisorSchedulesPage === 'function') {
                loadSupervisorSchedulesPage();
            }

        } catch (error) {
            alert('حدث خطأ: ' + error.message);
            console.error(error);
        } finally {
            btn.disabled = false;
            btn.textContent = 'حفظ التغييرات';
        }
    }
});

async function loadEndOfServicePage() {
    const page = document.getElementById('page-end-of-service');
    const tabs = page.querySelectorAll('.tab-link');
    const newTabs = [];
    tabs.forEach(t => {
        const clone = t.cloneNode(true);
        t.parentNode.replaceChild(clone, t);
        newTabs.push(clone);
    });

    newTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            page.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
            if (tab.dataset.tab === 'eos-new-tab') fetchSettlements('new');
            else fetchSettlements('archived');
        });
    });
    const searchInput = document.getElementById('eos-search-input');
    searchInput.addEventListener('keyup', () => {
        clearTimeout(hrDebounceTimer);
        hrDebounceTimer = setTimeout(() => {
            const activeTab = page.querySelector('.tab-link.active').dataset.tab;
            fetchSettlements(activeTab === 'eos-new-tab' ? 'new' : 'archived');
        }, 500);
    });
    fetchSettlements('new');
}

async function fetchSettlements(type) {
    const containerId = type === 'new' ? 'eos-new-list' : 'eos-archived-list';
    const container = document.getElementById(containerId);
    const searchTerm = document.getElementById('eos-search-input').value.trim();
    
    container.innerHTML = '<p style="text-align: center;">جاري التحميل...</p>';

    try {
        let query = supabaseClient
            .from('users')
            .select('id, name, id_number, role, start_of_work_date, project, phone, employment_status, settlement_archived')
            .eq('employment_status', 'مستقيل'); // الشرط الأساسي: أن يكون مستقيل

        if (type === 'new') {
            query = query.or('settlement_archived.is.null,settlement_archived.eq.false');
        } else {
            query = query.eq('settlement_archived', true);
        }

        if (searchTerm) {
            query = query.or(`name.ilike.%${searchTerm}%,id_number.ilike.%${searchTerm}%`);
        }
        const { data: users, error } = await query.order('created_at', { ascending: false });

        if (error) throw error;

        if (users.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا توجد بيانات</h4><p>لا يوجد موظفين في هذه القائمة حالياً.</p></div>';
            return;
        }

        container.innerHTML = users.map(user => {
            const projectDisplay = Array.isArray(user.project) ? user.project.join(', ') : (user.project || 'غير محدد');
            const actionBtn = type === 'new' 
                ? `<button class="btn btn-success btn-sm archive-settlement-btn" data-id="${user.id}" data-name="${user.name}"><i class="ph-bold ph-archive-box"></i> أرشفة (تمت التسوية)</button>`
                : `<span class="status active"><i class="ph-bold ph-check"></i> مؤرشفة</span>`;

            return `
                <div class="review-request-card">
                    <div class="review-request-header ${type === 'new' ? 'status-pending' : 'status-approved'}">
                        <h4>${user.name}</h4>
                        <span>${user.id_number}</span>
                    </div>
                    <div class="review-request-body">
                        <div class="request-meta-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="request-meta-item"><i class="ph-bold ph-briefcase"></i><span>${user.role}</span></div>
                            <div class="request-meta-item"><i class="ph-bold ph-map-pin"></i><span>${projectDisplay}</span></div>
                            <div class="request-meta-item"><i class="ph-bold ph-calendar"></i><span>تعيين: ${formatGregorianDate(user.start_of_work_date)}</span></div>
                            <div class="request-meta-item"><i class="ph-bold ph-phone"></i><span>${user.phone || '-'}</span></div>
                        </div>
                    </div>
                    <div class="review-request-footer" style="justify-content: space-between;">
                        <button class="btn btn-secondary btn-sm view-settlement-report-btn" data-id="${user.id}">
                            <i class="ph-bold ph-file-text"></i> عرض البطاقة
                        </button>
                        ${actionBtn}
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error(error);
        container.innerHTML = `<p style="color:red;">حدث خطأ: ${error.message}</p>`;
    }
}
document.body.addEventListener('click', async function(event) {
    const viewBtn = event.target.closest('.view-settlement-report-btn');
    if (viewBtn) {
        const userId = viewBtn.dataset.id;
        const modal = document.getElementById('eos-report-modal');
        const body = document.getElementById('eos-report-body');
        
        modal.classList.remove('hidden');
        body.innerHTML = '<p style="text-align:center;">جاري حساب المستحقات...</p>';
        await generateSettlementReport(userId, body);
    }
    const archiveBtn = event.target.closest('.archive-settlement-btn');
    if (archiveBtn) {
        const userId = archiveBtn.dataset.id;
        const userName = archiveBtn.dataset.name;
        
        if(confirm(`هل أنت متأكد من أرشفة مخالصة الموظف "${userName}"؟\nهذا يعني أنه استلم مستحقاته وسيتم نقله للأرشيف.`)) {
            try {
                const { error } = await supabaseClient
                    .from('users')
                    .update({ settlement_archived: true })
                    .eq('id', userId);
                
                if(error) throw error;
                
                showToast('تمت أرشفة المخالصة بنجاح.', 'success');
                fetchSettlements('new'); 
            } catch(err) {
                alert('حدث خطأ: ' + err.message);
            }
        }
    }
});
async function generateSettlementReport(userId, containerElement) {
    try {
        const { data: user, error: userError } = await supabaseClient
            .from('users')
            .select('*, job_vacancies!users_vacancy_id_fkey(*)')
            .eq('id', userId)
            .single();

        if (userError) throw userError;

        const { data: assets } = await supabaseClient.from('asset_items').select('*, inventory:inventory_id(name)').eq('assigned_to_user_id', userId).neq('status', 'في المخزن');
        const { data: vehicles } = await supabaseClient.from('vehicles').select('*').eq('assigned_employee_id', userId);
        const startDate = new Date(user.start_of_work_date);
        const today = new Date();
        let years = today.getFullYear() - startDate.getFullYear();
        let months = today.getMonth() - startDate.getMonth();
        let days = today.getDate() - startDate.getDate();
        if (days < 0) { months--; days += 30; }
        if (months < 0) { years--; months += 12; }
        
        const totalServiceYears = years + (months/12) + (days/365);
        const annualLeaveEntitlement = user.annual_leave_days || 21;
        const totalAccruedLeave = (totalServiceYears) * annualLeaveEntitlement;
        
        const { data: takenLeaves } = await supabaseClient.from('employee_requests').select('details').eq('user_id', userId).eq('request_type', 'leave').eq('status', 'مقبول');
        let daysTaken = 0;
        if (takenLeaves) takenLeaves.forEach(req => daysTaken += parseInt(req.details.days || 0));
        const remainingLeaveBalance = Math.max(0, totalAccruedLeave - daysTaken);
        const vacancy = user.job_vacancies || {};
        const basicSalary = user.basic_salary || vacancy.base_salary || 0;
        const totalSalary = basicSalary + (user.housing_allowance || vacancy.housing_allowance || 0) + (user.transport_allowance || vacancy.transport_allowance || 0) + (user.other_allowance || vacancy.other_allowances || 0);
        const dailyRate = totalSalary > 0 ? (totalSalary / 30) : 0;
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString();
        const { data: attendance } = await supabaseClient.from('attendance').select('status').eq('guard_id', userId).gte('created_at', startOfMonth);
        const workDaysCount = attendance ? attendance.filter(r => r.status.includes('حاضر') || r.status.includes('اكمل')).length : 0;
        const absentDaysCount = attendance ? attendance.filter(r => r.status.includes('غياب')).length : 0;
        
        const earnedSalary = workDaysCount * dailyRate;
        const absenceDeduction = absentDaysCount * dailyRate;
        
        let gratuity = 0;
        if (totalServiceYears <= 5) {
            gratuity = totalServiceYears * 0.5 * totalSalary;
        } else {
            gratuity = (5 * 0.5 * totalSalary) + ((totalServiceYears - 5) * totalSalary);
        }
        containerElement.innerHTML = `
            <div class="settlement-report-card">
                <div class="settlement-header">
                    <div>
                        <h2 style="margin:0;">مخالصة نهائية وإخلاء طرف</h2>
                        <p style="margin:5px 0 0 0; opacity:0.8;">تاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                    <div style="text-align:left;">
                        <h3>${user.name}</h3>
                        <p>رقم الهوية: ${user.id_number}</p>
                        <p>مدة الخدمة: ${years} سنة، ${months} شهر، ${days} يوم</p>
                    </div>
                </div>
                
                <div class="settlement-body">
                    <div class="settlement-section">
                        <h5><i class="ph-bold ph-calculator"></i> تفاصيل المستحقات</h5>
                        
                        <div class="calc-row"><span>راتب الشهر الحالي (${workDaysCount} يوم عمل)</span><span>${earnedSalary.toFixed(2)} ر.س</span></div>
                        <div class="calc-row"><span>بدل الإجازات (${remainingLeaveBalance.toFixed(2)} يوم)</span><span>${(remainingLeaveBalance * dailyRate).toFixed(2)} ر.س</span></div>
                        <div class="calc-row" style="background-color:#eff6ff; font-weight:bold;"><span>مكافأة نهاية الخدمة (تقديري)</span><span>${gratuity.toFixed(2)} ر.س</span></div>
                        <div class="calc-row" style="color:var(--denied-color);"><span>خصومات غياب/سلف</span><span>- ${absenceDeduction.toFixed(2)} ر.س</span></div>
                        
                        <div style="background:#1f2937; color:white; padding:15px; border-radius:8px; margin-top:20px; text-align:center;">
                            <small>صافي المبلغ المستحق للصرف</small>
                            <div style="font-size:1.8rem; font-weight:bold;">
                                ${((remainingLeaveBalance * dailyRate) + earnedSalary + gratuity - absenceDeduction).toLocaleString()} ر.س
                            </div>
                        </div>
                    </div>

                    <div class="settlement-section">
                        <h5><i class="ph-bold ph-package"></i> العُهد المعلقة (يجب استلامها)</h5>
                        ${renderAssetsListWithActions(assets, vehicles)}
                    </div>
                </div>
                
                <div class="no-print" style="padding:20px; text-align:center; border-top:1px solid #eee;">
                    <p class="text-secondary">تنبيه: تأكد من استلام كافة العهد (بالضغط على الأزرار أعلاه) قبل طباعة المخالصة وتوقيعها.</p>
                </div>

                <div class="print-only" style="display:none; padding:40px; margin-top:50px; border-top:2px dashed #000;">
                    <div style="display:flex; justify-content:space-between;">
                        <div style="text-align:center;">
                            <p><strong>توقيع الموظف</strong></p>
                            <br><br>.........................
                        </div>
                        <div style="text-align:center;">
                            <p><strong>مدير الموارد البشرية</strong></p>
                            <br><br>.........................
                        </div>
                        <div style="text-align:center;">
                            <p><strong>الختم</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        `;

    } catch (error) {
        containerElement.innerHTML = `<p style="color:red;">خطأ: ${error.message}</p>`;
    }
}
function renderAssetsListWithActions(assets, vehicles) {
    let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
    let hasAssets = false;

    if (vehicles && vehicles.length > 0) {
        hasAssets = true;
        vehicles.forEach(v => {
            html += `
            <div class="asset-row-action" style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; border:1px solid #e5e7eb; border-radius:6px;">
                <span><i class="ph-bold ph-car"></i> ${v.vehicle_type} (${v.license_plate})</span>
                <button class="btn btn-secondary btn-sm return-vehicle-btn" data-id="${v.id}" title="استلام وإخلاء طرف"><i class="ph-bold ph-check"></i> استلام</button>
            </div>`;
        });
    }
    
    if (assets && assets.length > 0) {
        hasAssets = true;
        assets.forEach(a => {
            const name = a.inventory ? a.inventory.name : 'عهدة';
            const detail = a.details?.identifier || a.details?.serial_number || '';
            html += `
            <div class="asset-row-action" style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; border:1px solid #e5e7eb; border-radius:6px;">
                <span><i class="ph-bold ph-cube"></i> ${name} (${detail})</span>
                <button class="btn btn-secondary btn-sm return-admin-asset-btn" data-id="${a.id}" title="استلام وإخلاء طرف"><i class="ph-bold ph-check"></i> استلام</button>
            </div>`;
        });
    }

    if (!hasAssets) {
        return `<div style="text-align:center; padding:20px; color:#16a34a; background:#f0fdf4; border-radius:8px;">
            <i class="ph-bold ph-check-circle" style="font-size:2rem;"></i><br>
            الموظف بريء الذمة من العهد.
        </div>`;
    }

    html += '</div>';
    return html;
}
const SYSTEM_PAGES_MAP = [
    { id: 'page-admin-dashboard', name: 'لوحة تحكم النظام' },
    { id: 'page-user-management', name: 'إدارة المستخدمين' },
    { id: 'page-employees', name: 'إدارة الحراس والمشرفين' },
    { id: 'page-admin-staff', name: 'إدارة موظفي الإدارة' },
    { id: 'page-contracts', name: 'إدارة العقود' },
    { id: 'page-vacancies', name: 'إدارة الشواغر' },
    { id: 'page-payroll', name: 'مسير الرواتب' },
    { id: 'page-attendance-management', name: 'إدارة الحضور' },
    { id: 'page-hr-attendance-log', name: 'سجل الحضور' },
    { id: 'page-leave-requests', name: 'طلبات الإجازات' },
    { id: 'page-resignation-requests', name: 'طلبات الاستقالة' },
    { id: 'page-finance-new-request', name: 'الطلبات المالية' },
    { id: 'page-inventory', name: 'إدارة المخزون' },
    { id: 'page-vehicles', name: 'إدارة المركبات' }
];
async function loadHighCommandPage() {
    const page = document.getElementById('page-high-command');
    if (!page) return;
    if (currentUser.name !== 'High Commander') {
        alert('ليس لديك صلاحية الوصول لهذه الصفحة.');
        return;
    }
    page.querySelectorAll('.tab-link').forEach(tab => {
        const newTab = tab.cloneNode(true);
        tab.parentNode.replaceChild(newTab, tab);
        
        newTab.addEventListener('click', (e) => {
            e.preventDefault();
            page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            page.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });
            
            newTab.classList.add('active');
            const targetId = newTab.dataset.tab;
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.classList.add('active');
                targetContent.style.display = 'block';
                
                if (targetId === 'cmd-branches-tab') loadBranchesList();
                if (targetId === 'cmd-staff-tab') loadCmdStaffList();
            }
        });
    });
    const firstTab = page.querySelector('a[data-tab="cmd-branches-tab"]');
    if (firstTab) firstTab.click();
}

async function loadBranchesList() {
    const container = document.getElementById('cmd-branches-list');
    container.innerHTML = '<p style="text-align:center;">جاري التحميل...</p>';

    const { data: branches, error } = await supabaseClient.from('company_branches').select('*').order('created_at');

    if (error) {
        container.innerHTML = `<p style="color:red;">خطأ: ${error.message}</p>`;
        return;
    }

    if (branches.length === 0) {
        container.innerHTML = '<div class="empty-state"><h4>لا توجد فروع</h4><p>قم بإضافة المقر الرئيسي والفروع.</p></div>';
        return;
    }

    container.innerHTML = `
        <table class="attendance-log-table">
            <thead><tr><th>اسم الفرع</th><th>الإحداثيات</th><th>النطاق</th><th>إجراء</th></tr></thead>
            <tbody>
                ${branches.map(b => `
                    <tr>
                        <td><strong>${b.name}</strong></td>
                        <td style="direction:ltr;">${b.coordinates}</td>
                        <td>${b.radius} متر</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-secondary btn-sm manage-branch-shifts-btn" data-id="${b.id}" data-name="${b.name}" title="إدارة أوقات الدوام">
                                    <i class="ph-bold ph-clock"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-branch-btn" data-id="${b.id}" title="حذف الفرع">
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}
document.body.addEventListener('submit', async function(event) {
    if (event.target.id === 'cmd-branch-form') {
        event.preventDefault(); // <--- هذا السطر يمنع تحديث الصفحة
        
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري الحفظ...';

        try {
            const name = document.getElementById('cmd-branch-name').value;
            const coords = document.getElementById('cmd-branch-coords').value;
            const radius = parseInt(document.getElementById('cmd-branch-radius').value);

            const { error } = await supabaseClient
                .from('company_branches')
                .insert({ name: name, coordinates: coords, radius: radius });
            
            if (error) throw error;

            showToast('تمت إضافة الفرع بنجاح', 'success');
            document.getElementById('cmd-branch-modal').classList.add('hidden');
            loadBranchesList();

        } catch (error) {
            alert('خطأ: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'حفظ الفرع';
        }
    }
});
document.getElementById('cmd-add-branch-btn')?.addEventListener('click', () => {
    document.getElementById('cmd-branch-form').reset();
    document.getElementById('cmd-branch-modal').classList.remove('hidden');
});

async function loadCmdStaffList() {
    const container = document.getElementById('cmd-staff-list');
    const search = document.getElementById('cmd-staff-search').value;
    
    container.innerHTML = '<p style="text-align:center;">جاري تحميل الموظفين...</p>';

    let query = supabaseClient.from('users')
        .select('id, name, role, id_number, branch_id, company_branches(name)')
        .not('role', 'in', '("حارس أمن","مشرف")') // فقط الإداريين
        .not('employment_status', 'eq', 'مؤرشف');

    if (search) query = query.or(`name.ilike.%${search}%,id_number.ilike.%${search}%`);

    const { data: users, error } = await query;

    if (error) {
        container.innerHTML = `<p style="color:red;">خطأ: ${error.message}</p>`;
        return;
    }

    container.innerHTML = `
        <table class="attendance-log-table">
            <thead><tr><th>الموظف</th><th>الدور</th><th>الفرع الحالي</th><th>إعدادات</th></tr></thead>
            <tbody>
                ${users.map(u => `
                    <tr>
                        <td>${u.name}<br><small>${u.id_number}</small></td>
                        <td><span class="status pending">${u.role}</span></td>
                        <td>${u.company_branches?.name || '<span style="color:red;">غير محدد</span>'}</td>
                        <td>
                            <button class="btn btn-primary btn-sm open-cmd-employee-btn" data-id="${u.id}">
                                <i class="ph-bold ph-gear"></i> الرواتب والصلاحيات
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}
document.getElementById('cmd-staff-search')?.addEventListener('keyup', () => {
    clearTimeout(hrDebounceTimer);
    hrDebounceTimer = setTimeout(loadCmdStaffList, 500);
});
document.body.addEventListener('click', async (e) => {
    const btn = e.target.closest('.open-cmd-employee-btn');
    if (btn) {
        const userId = btn.dataset.id;
        const modal = document.getElementById('cmd-employee-modal');
        const [userRes, branchRes] = await Promise.all([
            supabaseClient.from('users').select('*').eq('id', userId).single(),
            supabaseClient.from('company_branches').select('id, name')
        ]);
        
        const user = userRes.data;
        const branches = branchRes.data;
        document.getElementById('cmd-employee-id').value = user.id;
        document.getElementById('cmd-employee-name').textContent = user.name;
        const branchSelect = document.getElementById('cmd-emp-branch');
        const shiftSelect = document.getElementById('cmd-emp-shift'); // القائمة الجديدة
        
        branchSelect.innerHTML = '<option value="">-- اختر الفرع --</option>';
        branches.forEach(b => {
            branchSelect.innerHTML += `<option value="${b.id}" ${user.branch_id === b.id ? 'selected' : ''}>${b.name}</option>`;
        });
        shiftSelect.innerHTML = '<option value="">-- اختر الفرع أولاً --</option>';
        shiftSelect.disabled = true;

        if (user.branch_id) {
            shiftSelect.innerHTML = '<option>جاري التحميل...</option>';
            const { data: shifts } = await supabaseClient
                .from('branch_shifts')
                .select('id, name, start_time, end_time')
                .eq('branch_id', user.branch_id);
            
            if (shifts && shifts.length > 0) {
                shiftSelect.innerHTML = '<option value="">-- اختر وقت الدوام --</option>';
                shifts.forEach(s => {
                    const timeLabel = `${s.name} (${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)})`;
                    shiftSelect.innerHTML += `<option value="${s.id}" ${user.branch_shift_id === s.id ? 'selected' : ''}>${timeLabel}</option>`;
                });
                shiftSelect.disabled = false;
            } else {
                shiftSelect.innerHTML = '<option value="">لا توجد أوقات مسجلة لهذا الفرع</option>';
            }
        }
        document.getElementById('cmd-emp-exempt').checked = user.is_exempt_from_attendance;
        document.getElementById('cmd-salary-basic').value = user.basic_salary || 0;
        document.getElementById('cmd-salary-housing').value = user.housing_allowance || 0;
        document.getElementById('cmd-salary-transport').value = user.transport_allowance || 0;
        document.getElementById('cmd-salary-other').value = user.other_allowance || 0;
        document.getElementById('cmd-leave-balance').value = user.annual_leave_days || 21;
        updateTotalSalary(); // حساب الإجمالي
        const permContainer = document.getElementById('cmd-permissions-container');
        const userPermissions = user.ui_permissions?.allowed_pages || [];
        
        permContainer.innerHTML = SYSTEM_PAGES_MAP.map(page => `
            <label style="background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid #e5e7eb; display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="checkbox" class="cmd-perm-check" value="${page.id}" ${userPermissions.includes(page.id) ? 'checked' : ''}>
                <span style="font-size:0.9rem; font-weight:600;">${page.name}</span>
            </label>
        `).join('');

        modal.classList.remove('hidden');
    }
    if (e.target.closest('.delete-branch-btn')) {
        if (confirm('حذف هذا الفرع؟')) {
            const id = e.target.closest('.delete-branch-btn').dataset.id;
            await supabaseClient.from('company_branches').delete().eq('id', id);
            loadBranchesList();
        }
    }
});
const salaryInputs = ['cmd-salary-basic', 'cmd-salary-housing', 'cmd-salary-transport', 'cmd-salary-other'];
salaryInputs.forEach(id => {
    document.getElementById(id)?.addEventListener('input', updateTotalSalary);
});

function updateTotalSalary() {
    let total = 0;
    salaryInputs.forEach(id => total += parseFloat(document.getElementById(id).value) || 0);
    document.getElementById('cmd-salary-total').value = total.toLocaleString() + ' ر.س';
}
document.body.addEventListener('submit', async function(event) {
    if (event.target.id === 'cmd-employee-form') {
        event.preventDefault(); // <--- منع تحديث الصفحة
        
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'جاري الحفظ...';

        try {
            const userId = document.getElementById('cmd-employee-id').value;
            const selectedPermissions = Array.from(document.querySelectorAll('.cmd-perm-check:checked')).map(cb => cb.value);

            const updateData = {
                branch_id: document.getElementById('cmd-emp-branch').value || null,
                branch_shift_id: document.getElementById('cmd-emp-shift').value || null,
                is_exempt_from_attendance: document.getElementById('cmd-emp-exempt').checked,
                basic_salary: parseFloat(document.getElementById('cmd-salary-basic').value) || 0,
                housing_allowance: parseFloat(document.getElementById('cmd-salary-housing').value) || 0,
                transport_allowance: parseFloat(document.getElementById('cmd-salary-transport').value) || 0,
                other_allowance: parseFloat(document.getElementById('cmd-salary-other').value) || 0,
                annual_leave_days: parseInt(document.getElementById('cmd-leave-balance').value) || 21,
                ui_permissions: { allowed_pages: selectedPermissions } // تحديث الصلاحيات
            };

            const { error } = await supabaseClient
                .from('users')
                .update(updateData)
                .eq('id', userId);

            if (error) throw error;

            showToast('تم حفظ الإعدادات والصلاحيات بنجاح', 'success');
            document.getElementById('cmd-employee-modal').classList.add('hidden');
            loadCmdStaffList();

        } catch (err) {
            alert('خطأ: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'حفظ كافة الإعدادات';
        }
    }
});

async function loadAdminAttendancePage() {
    if (attendancePageInterval) { clearInterval(attendancePageInterval); attendancePageInterval = null; }
    stopPersistentTracking(); // إيقاف تتبع الحراس

    const statusContainer = document.getElementById('admin-att-status-container');
    const checkInBtn = document.getElementById('admin-check-in-btn');
    const checkOutBtn = document.getElementById('admin-check-out-btn');
    const locBtnContainer = document.getElementById('admin-location-btn-container');
    const locationMsg = document.getElementById('admin-location-msg');
    checkInBtn.classList.add('hidden');
    checkOutBtn.classList.add('hidden');
    locBtnContainer.innerHTML = '';
    locationMsg.innerHTML = '';

    if (!currentUser) return;
    if (currentUser.is_exempt_from_attendance) {
        statusContainer.innerHTML = `
            <div class="lockout-message" style="background-color: #f0fdf4; border-color: #22c55e;">
                <h4 style="color: #15803d;"><i class="ph-bold ph-check-circle"></i> معفي من البصمة</h4>
                <p>أنت معفي من تسجيل الحضور والانصراف. النظام يعتبرك حاضراً تلقائياً.</p>
            </div>`;
        return;
    }
    if (!currentUser.branch_id) {
        statusContainer.innerHTML = `<div class="lockout-message"><h4>غير مرتبط بفرع</h4><p>لم يتم ربطك بفرع أو مقر عمل حتى الآن. يرجى مراجعة الإدارة.</p></div>`;
        return;
    }

    try {
        const { data: branch, error: branchError } = await supabaseClient
            .from('company_branches')
            .select('*')
            .eq('id', currentUser.branch_id)
            .single();

        if (branchError || !branch) throw new Error('تعذر تحميل بيانات الفرع.');
        if (branch.coordinates) {
            const coords = branch.coordinates.replace(/\s/g, '');
            locBtnContainer.innerHTML = `<a href="https://www.google.com/maps/search/?api=1&query=${coords}" target="_blank" class="btn btn-secondary btn-sm" style="width: auto;"><i class="ph-bold ph-map-pin"></i> موقع العمل: ${branch.name}</a>`;
        }
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);

        const { data: activeRecord, error: recError } = await supabaseClient
            .from('attendance')
            .select('*')
            .eq('guard_id', currentUser.id) // نستخدم نفس العمود ID للموظف
            .gte('created_at', todayStart.toISOString())
            .is('checkout_at', null) // لم يسجل خروج
            .eq('status', 'حاضر')
            .limit(1)
            .single();

        if (activeRecord) {
            statusContainer.innerHTML = `<p style="color: var(--accent-color); font-size: 1.2rem;">أنت مسجل <strong>حاضر</strong> منذ: ${formatTimeAMPM(new Date(activeRecord.created_at).toTimeString().slice(0,5))}</p>`;
            checkOutBtn.dataset.recordId = activeRecord.id; // تخزين الـ ID في الزر
            checkOutBtn.classList.remove('hidden');
        } else {
            statusContainer.innerHTML = `<p>لست مسجلاً حالياً. يمكنك تسجيل الدخول عند الوصول للمقر.</p>`;
            checkInBtn.dataset.branchLat = branch.coordinates.split(',')[0].trim();
            checkInBtn.dataset.branchLng = branch.coordinates.split(',')[1].trim();
            checkInBtn.dataset.branchRadius = branch.radius;
            checkInBtn.dataset.branchName = branch.name;
            
            checkInBtn.classList.remove('hidden');
        }

    } catch (err) {
        console.error(err);
        statusContainer.innerHTML = `<p style="color:red;">حدث خطأ: ${err.message}</p>`;
    }
}
document.getElementById('btn-admin-checkin')?.addEventListener('click', async function() {
    const btn = this;
    const msgBox = document.getElementById('admin-att-message');
    if (!navigator.geolocation) {
        return alert('المتصفح لا يدعم تحديد الموقع.');
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري التوثيق...';
    msgBox.innerHTML = '';

    navigator.geolocation.getCurrentPosition(async (position) => {
        try {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            const branchLat = parseFloat(btn.dataset.lat);
            const branchLng = parseFloat(btn.dataset.lng);
            const radius = parseInt(btn.dataset.radius);
            const distance = calculateDistance(
                { lat: userLat, lng: userLng },
                { lat: branchLat, lng: branchLng }
            );

            const effectiveDistance = distance - accuracy;

            if (effectiveDistance <= radius) {
                const { data: freshUser, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userError || !freshUser) throw new Error('تعذر جلب بيانات الملف الوظيفي.');
                const snapshot = {
                    project: 'إداري',
                    location: btn.dataset.branchName,
                    region: freshUser.region || 'المركز الرئيسي',
                    city: freshUser.city || 'الرياض',
                    base_salary: freshUser.basic_salary || 0,
                    housing_allowance: freshUser.housing_allowance || 0,
                    transport_allowance: freshUser.transport_allowance || 0,
                    other_allowances: freshUser.other_allowance || 0,
                    
                    role: freshUser.role,
                    branch_id: freshUser.branch_id,
                    schedule_details: [{
                        name: 'دوام إداري',
                        start_time: '08:00', 
                        end_time: '16:00'
                    }]
                };
                const { error } = await supabaseClient.from('attendance').insert({
                    guard_id: currentUser.id,
                    guard_name: currentUser.name,
                    project: 'إداري',
                    location: btn.dataset.branchName,
                    region: snapshot.region,
                    city: snapshot.city,
                    status: 'حاضر',
                    checkin_lat: userLat,
                    checkin_lon: userLng,
                    notes: 'حضور إداري عبر النظام',
                    is_manual_entry: false,
                    shift_snapshot: snapshot // <--- حفظ النسخة هنا
                });

                if (error) throw error;

                showToast('تم تسجيل الحضور وتوثيق البيانات بنجاح', 'success');
                loadAdminAttendancePage();

            } else {
                const diff = Math.round(distance - radius);
                msgBox.innerHTML = `<div style="color:#b91c1c; background:#fef2f2; padding:10px; border-radius:8px; border:1px solid #fecaca;">
                    <strong>🚫 خارج النطاق!</strong><br>
                    أنت تبعد مسافة ${Math.round(distance)} متر.<br>
                    يجب الاقتراب ${diff} متر.<br>
                    <small>(دقة GPS: ${Math.round(accuracy)} م)</small>
                </div>`;
                btn.disabled = false;
                btn.innerHTML = '<i class="ph-bold ph-sign-in"></i> تسجيل دخول';
            }

        } catch (err) {
            alert('حدث خطأ: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="ph-bold ph-sign-in"></i> تسجيل دخول';
        }
    }, (error) => {
        let errorMsg = "تعذر تحديد الموقع.";
        if (error.code === 1) errorMsg = "يجب تفعيل صلاحية الموقع من المتصفح.";
        else if (error.code === 2) errorMsg = "إشارة GPS ضعيفة.";
        
        msgBox.innerHTML = `<p style="color:red;">${errorMsg}</p>`;
        btn.disabled = false;
        btn.innerHTML = '<i class="ph-bold ph-sign-in"></i> تسجيل دخول';
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
});
document.body.addEventListener('click', async (e) => {
    const btn = e.target.closest('#admin-check-out-btn');
    if (!btn) return;

    const recordId = btn.dataset.recordId;
    
    if(!confirm('هل أنت متأكد من تسجيل الانصراف')) return;

    btn.disabled = true;
    btn.innerHTML = 'جاري الانصراف...';

    try {
        const { error } = await supabaseClient
            .from('attendance')
            .update({
                checkout_at: new Date().toISOString(),
                status: 'اكمل المناوبة' // الحالة الطبيعية
            })
            .eq('id', recordId);

        if (error) throw error;

        showToast('تم تسجيل الانصراف بنجاح 👋', 'success');
        loadAdminAttendancePage();

    } catch (err) {
        alert('فشل التسجيل: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="ph-bold ph-sign-out"></i> تسجيل انصراف';
    }
});

async function loadAdminMonitorPage(isAutoRefresh = false) {
    if (typeof isAutoRefresh === 'object') isAutoRefresh = false;

    const presentContainer = document.getElementById('admin-monitor-list');
    const absentContainer = document.getElementById('admin-absent-list');
    const countPresentEl = document.getElementById('monitor-count-present');
    const countAbsentEl = document.getElementById('monitor-count-absent');
    if (!presentContainer || !absentContainer) return;
    if (!isAutoRefresh) {
        if (presentContainer.innerHTML.trim() === '') presentContainer.innerHTML = '<p style="text-align:center;">جاري تحديث الحضور...</p>';
        if (absentContainer.innerHTML.trim() === '') absentContainer.innerHTML = '<p style="text-align:center;">جاري البحث عن الغائبين...</p>';
        if (countPresentEl) countPresentEl.textContent = '...';
        if (countAbsentEl) countAbsentEl.textContent = '...';
    }

    try {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        let employeesQuery = supabaseClient
            .from('users')
            .select('id, name, role, phone, branch_id')
            .not('role', 'in', '("حارس أمن","مشرف")') // إداريين فقط
            .not('employment_status', 'eq', 'مؤرشف');
        if (currentUser.name !== 'High Commander' && currentUser.role !== 'مدير النظام') {
            employeesQuery = employeesQuery.eq('role', currentUser.role);
        }
        let attendanceQuery = supabaseClient
            .from('attendance')
            .select(`
                id, status, created_at, checkout_at, checkin_lat, checkin_lon, location,
                guard_id
            `)
            .eq('project', 'إداري')
            .gte('created_at', todayStart.toISOString());
        const [employeesRes, attendanceRes] = await Promise.all([employeesQuery, attendanceQuery]);

        if (employeesRes.error) throw employeesRes.error;
        if (attendanceRes.error) throw attendanceRes.error;

        const allEmployees = employeesRes.data || [];
        const todayRecords = attendanceRes.data || [];
        const presentList = [];
        const absentList = [];
        const attendanceMap = new Map();
        todayRecords.forEach(rec => attendanceMap.set(rec.guard_id, rec));

        allEmployees.forEach(emp => {
            const record = attendanceMap.get(emp.id);
            
            if (record) {
                if (record.status === 'حاضر' && !record.checkout_at) {
                    presentList.push({ ...emp, record });
                }
            } else {
                absentList.push(emp);
            }
        });
        if (countPresentEl) countPresentEl.textContent = presentList.length;
        if (countAbsentEl) countAbsentEl.textContent = absentList.length;
        if (presentList.length === 0) {
            presentContainer.innerHTML = '<div class="empty-state"><h4>لا يوجد حضور</h4><p>الجميع غادر أو لم يحضر أحد بعد.</p></div>';
        } else {
            presentContainer.innerHTML = `
                <table class="attendance-log-table">
                    <thead><tr><th>الموظف</th><th>القسم</th><th>وقت الحضور</th><th>الموقع</th><th>إجراءات</th></tr></thead>
                    <tbody>
                        ${presentList.map(item => {
                            const checkInTime = new Date(item.record.created_at).toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'});
                            const mapsLink = `http://googleusercontent.com/maps.google.com/?q=${item.record.checkin_lat},${item.record.checkin_lon}`;
                            return `
                                <tr>
                                    <td><strong>${item.name}</strong></td>
                                    <td>${item.role}</td>
                                    <td style="color:var(--approved-color); font-weight:bold;">${checkInTime}</td>
                                    <td><a href="${mapsLink}" target="_blank" class="btn btn-secondary btn-sm"><i class="ph-bold ph-map-pin"></i> ${item.record.location || 'موقع'}</a></td>
                                    <td>
                                        <button class="btn btn-danger btn-sm force-withdraw-btn" data-id="${item.record.id}" data-name="${item.name}">
                                            <i class="ph-bold ph-sign-out"></i> تسجيل انسحاب
                                        </button>
                                    </td>
                                </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;
        }
        if (absentList.length === 0) {
            absentContainer.innerHTML = '<div class="empty-state"><h4>مكتمل</h4><p>جميع الموظفين سجلوا حضورهم اليوم.</p></div>';
        } else {
            absentContainer.innerHTML = `
                <table class="attendance-log-table">
                    <thead><tr><th>الموظف</th><th>الدور</th><th>رقم الجوال</th><th>إجراء</th></tr></thead>
                    <tbody>
                        ${absentList.map(emp => `
                            <tr>
                                <td><strong>${emp.name}</strong></td>
                                <td>${emp.role}</td>
                                <td>${emp.phone || '-'}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm manager-mark-absent-btn" data-id="${emp.id}" data-name="${emp.name}">
                                        <i class="ph-bold ph-user-minus"></i> رفع غياب
                                    </button>
                                </td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
        }
        if (!adminMonitorInterval) {
            console.log('تم تفعيل التحديث التلقائي (المتواجدين + الغائبين).');
            adminMonitorInterval = setInterval(() => {
                loadAdminMonitorPage(true); // تحديث صامت
            }, 15000);
        }

    } catch (err) {
        console.error(err);
        const errorHtml = `<p style="color:red; text-align:center;">حدث خطأ: ${err.message}</p>`;
        presentContainer.innerHTML = errorHtml;
        absentContainer.innerHTML = errorHtml;
    }
}
document.body.addEventListener('click', async (e) => {
    const btn = e.target.closest('.manager-mark-absent-btn');
    if (btn) {
        const userId = btn.dataset.id;
        const userName = btn.dataset.name;

        const reason = prompt(`أنت بصدد رفع غياب للموظف "${userName}".\nالرجاء كتابة ملاحظة (سبب الغياب إن وجد):`);
        if (reason === null) return; // إلغاء

        btn.disabled = true;
        btn.innerHTML = 'جاري الرفع...';

        try {
            const { data: user } = await supabaseClient.from('users').select('*').eq('id', userId).single();
            
            const snapshot = {
                project: 'إداري',
                role: user.role,
                base_salary: user.basic_salary || 0,
                housing_allowance: user.housing_allowance || 0,
                transport_allowance: user.transport_allowance || 0,
                other_allowances: user.other_allowance || 0,
            };
            const { error } = await supabaseClient.from('attendance').insert({
                guard_id: userId,
                guard_name: user.name,
                project: 'إداري',
                status: 'غياب',
                created_at: new Date().toISOString(), // وقت الرفع
                notes: `تم رفع الغياب بواسطة المدير (${currentUser.name}): ${reason}`,
                is_manual_entry: true,
                checkin_lat: 0, checkin_lon: 0,
                shift_snapshot: snapshot,
                submitted_by_id: currentUser.id, 
                hr_review_status: 'pending_review' // ليظهر للموارد البشرية للمراجعة
            });

            if (error) throw error;

            showToast(`تم رفع غياب ${userName} بنجاح.`, 'success');

            loadAdminMonitorPage(); // تحديث القائمة (سينتقل من قائمة الغائبين إلى المسجلين)

        } catch (err) {
            alert('خطأ: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="ph-bold ph-user-minus"></i> رفع غياب';
        }
    }
});
document.getElementById('refresh-monitor-btn')?.addEventListener('click', loadAdminMonitorPage);
document.body.addEventListener('click', async (e) => {
    const btn = e.target.closest('.force-withdraw-btn');
    if (btn) {
        const recordId = btn.dataset.id;
        const empName = btn.dataset.name;

        if (!confirm(`تحذير: هل أنت متأكد من تسجيل "انسحاب" للموظف ${empName}؟\nسيتم إغلاق الوردية فوراً وحسابها كخروج مبكر.`)) return;

        btn.disabled = true;
        btn.textContent = 'جاري التنفيذ...';

        try {
            const { error } = await supabaseClient
                .from('attendance')
                .update({
                    checkout_at: new Date().toISOString(),
                    status: 'انسحاب', // الحالة تتغير إلى انسحاب
                    notes: `تم تسجيل انسحاب إداري بواسطة: ${currentUser.name}`
                })
                .eq('id', recordId);

            if (error) throw error;

            showToast(`تم تسجيل انسحاب ${empName} بنجاح.`, 'success');
            loadAdminMonitorPage(); // تحديث القائمة

        } catch (err) {
            alert('فشل الإجراء: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="ph-bold ph-sign-out"></i> تسجيل انسحاب';
        }
    }
});

let adminPayrollData = []; // لتخزين البيانات للتصدير

async function loadAdminPayrollPage() {
    const now = new Date();
    document.getElementById('admin-payroll-month').value = now.getMonth() + 1;
    document.getElementById('admin-payroll-year').value = now.getFullYear();
}
document.getElementById('btn-generate-admin-payroll')?.addEventListener('click', async () => {
    const container = document.getElementById('admin-payroll-result');
    const month = parseInt(document.getElementById('admin-payroll-month').value);
    const year = parseInt(document.getElementById('admin-payroll-year').value);

    container.innerHTML = '<p style="text-align:center;">جاري تحليل السجلات واستخراج البيانات المالية...</p>';
    
    try {
        const startDate = new Date(year, month - 1, 1).toISOString();
        const endDate = new Date(year, month, 0, 23, 59, 59).toISOString();
        const { data: employees, error: empError } = await supabaseClient
            .from('users')
            .select('*')
            .not('role', 'in', '("حارس أمن","مشرف")')
            .not('employment_status', 'eq', 'مؤرشف')
            .order('name');

        if (empError) throw empError;
        const { data: attendance, error: attError } = await supabaseClient
            .from('attendance')
            .select('guard_id, status, created_at, checkout_at, shift_snapshot')
            .eq('project', 'إداري')
            .gte('created_at', startDate)
            .lte('created_at', endDate)
            .order('created_at', { ascending: false }); // الأحدث أولاً

        if (attError) throw attError;
        adminPayrollData = employees.map(emp => {
            const empRecords = attendance.filter(r => r.guard_id === emp.id);
            const recordWithSnapshot = empRecords.find(r => r.shift_snapshot && r.shift_snapshot.base_salary !== undefined);
            
            let basic, housing, transport, other;

            if (recordWithSnapshot) {
                const snap = recordWithSnapshot.shift_snapshot;
                basic = snap.base_salary || 0;
                housing = snap.housing_allowance || 0;
                transport = snap.transport_allowance || 0;
                other = snap.other_allowances || 0;
            } else {
                basic = emp.basic_salary || 0;
                housing = emp.housing_allowance || 0;
                transport = emp.transport_allowance || 0;
                other = emp.other_allowance || 0;
            }

            const totalSalary = basic + housing + transport + other;
            const dailyRate = totalSalary / 30;
            const absentDays = empRecords.filter(r => r.status === 'غياب').length;
            const withdrawalCount = empRecords.filter(r => r.status === 'انسحاب').length;
            let overtimeHours = 0;
            empRecords.forEach(r => {
                if (r.status === 'حاضر' || r.status === 'اكمل المناوبة') {
                    if (r.created_at && r.checkout_at) {
                        const start = new Date(r.created_at);
                        const end = new Date(r.checkout_at);
                        const hoursWorked = (end - start) / (1000 * 60 * 60);
                        if (hoursWorked > 8) { 
                            overtimeHours += (hoursWorked - 8);
                        }
                    }
                }
            });
            const absenceDeduction = absentDays * dailyRate;
            const withdrawalDeduction = withdrawalCount * dailyRate; 
            const totalDeductions = absenceDeduction + withdrawalDeduction;

            const netSalary = totalSalary - totalDeductions;

            return {
                name: emp.name,
                role: emp.role,
                source: recordWithSnapshot ? 'سجل موثق (Snapshot)' : 'الملف الحالي',
                totalSalary: totalSalary,
                absentDays: absentDays,
                withdrawalCount: withdrawalCount,
                deductions: totalDeductions,
                netSalary: netSalary,
                overtime: overtimeHours.toFixed(1)
            };
        });
        renderAdminPayrollTable(container);

    } catch (err) {
        container.innerHTML = `<p style="color:red;">خطأ: ${err.message}</p>`;
    }
});

function renderAdminPayrollTable(container) {
    if (adminPayrollData.length === 0) {
        container.innerHTML = '<div class="empty-state"><h4>لا توجد بيانات</h4><p>لا يوجد موظفين أو سجلات لهذا الشهر.</p></div>';
        return;
    }

    container.innerHTML = `
        <table class="attendance-log-table">
            <thead>
                <tr>
                    <th>الموظف</th>
                    <th>الراتب الإجمالي</th>
                    <th>الغياب (أيام)</th>
                    <th>الانسحاب (مرات)</th>
                    <th>الخصومات</th>
                    <th>العمل الإضافي (ساعات)</th>
                    <th>صافي الراتب</th>
                </tr>
            </thead>
            <tbody>
                ${adminPayrollData.map(row => `
                    <tr>
                        <td><strong>${row.name}</strong><br><small>${row.role}</small></td>
                        <td>${row.totalSalary.toLocaleString()} ر.س</td>
                        <td style="color:${row.absentDays > 0 ? 'red' : 'inherit'}">${row.absentDays}</td>
                        <td style="color:${row.withdrawalCount > 0 ? 'orange' : 'inherit'}">${row.withdrawalCount}</td>
                        <td style="color:red;">${row.deductions.toFixed(2)} ر.س</td>
                        <td style="color:#22c55e; font-weight:bold;">${row.overtime}</td>
                        <td><strong style="color:#15803d; font-size:1.1rem;">${row.netSalary.toLocaleString(undefined, {maximumFractionDigits: 2})} ر.س</strong></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}
document.getElementById('export-admin-payroll-btn')?.addEventListener('click', () => {
    if (adminPayrollData.length === 0) return alert('لا توجد بيانات لتصديرها');
    const exportData = adminPayrollData.map(row => ({
        "اسم الموظف": row.name,
        "القسم": row.role,
        "الراتب الإجمالي": row.totalSalary,
        "أيام الغياب": row.absentDays,
        "مرات الانسحاب": row.withdrawalCount,
        "إجمالي الخصومات": row.deductions.toFixed(2),
        "ساعات الإضافي (رصد)": row.overtime,
        "صافي الراتب": row.netSalary.toFixed(2)
    }));

    const month = document.getElementById('admin-payroll-month').options[document.getElementById('admin-payroll-month').selectedIndex].text;
    exportPayrollToExcel(exportData, `مسير_الإداريين_${month}.xlsx`);
});

async function loadAdminRequestsPage() {
    const container = document.getElementById('admin-requests-list');
    if (!currentUser) return;
    const loanBtn = document.getElementById('admin-loan-btn');
    if (loanBtn) {
        const basicSalary = currentUser.basic_salary || 0;
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
        const { count: absenceCount } = await supabaseClient
            .from('attendance')
            .select('*', { count: 'exact', head: true })
            .eq('guard_id', currentUser.id)
            .eq('status', 'غياب')
            .gte('created_at', thirtyDaysAgo);
            
        if (basicSalary === 0) {
            loanBtn.disabled = true;
            loanBtn.querySelector('h4').textContent = 'الراتب غير محدد';
            loanBtn.style.opacity = '0.6';
        } else if (absenceCount > 2) { // مثال: أكثر من يومين غياب يمنع السلفة
            loanBtn.disabled = true;
            loanBtn.querySelector('h4').textContent = 'غير مؤهل (بسبب الغياب)';
            loanBtn.style.opacity = '0.6';
        } else {
            loanBtn.disabled = false;
            loanBtn.querySelector('h4').textContent = 'طلب سلفة';
            loanBtn.style.opacity = '1';
            loanBtn.dataset.maxLoan = (basicSalary * 0.25).toFixed(0);
        }
        loanBtn.onclick = (e) => {
            e.preventDefault();
            if(loanBtn.disabled) return;
            
            const modal = document.getElementById('loan-request-modal');
            const amountInput = document.getElementById('loan-amount');
            const infoText = document.getElementById('loan-policy-info');
            
            amountInput.value = '';
            amountInput.max = loanBtn.dataset.maxLoan;
            infoText.textContent = `الحد الأقصى المسموح لك: ${loanBtn.dataset.maxLoan} ر.س`;
            const submitBtn = modal.querySelector('.btn-submit-request');
            submitBtn.dataset.requestType = 'loan'; 
            
            modal.classList.remove('hidden');
        };
    }
    container.innerHTML = '<p style="text-align: center;">جاري تحميل طلباتك...</p>';
    const { data: requests, error } = await supabaseClient
        .from('employee_requests')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = '<p style="color:red;">حدث خطأ في جلب الطلبات.</p>';
        return;
    }

    if (requests.length === 0) {
        container.innerHTML = '<div class="empty-state"><h4>لا توجد طلبات</h4><p>لم تقم برفع أي طلبات حتى الآن.</p></div>';
        return;
    }
    container.innerHTML = requests.map(req => {
        let statusBadge = '';
        let statusMessage = '';
        let cardBorderColor = '';

        if (req.status === 'مقبول') {
            statusBadge = '<span class="status active"><i class="ph-bold ph-check-circle"></i> مقبول نهائياً</span>';
            cardBorderColor = 'var(--approved-color)';
        } else if (req.status === 'مرفوض') {
            statusBadge = '<span class="status inactive"><i class="ph-bold ph-x-circle"></i> مرفوض</span>';
            cardBorderColor = 'var(--denied-color)';
        } else {
            statusBadge = `<span class="status pending"><i class="ph-bold ph-hourglass"></i> ${req.status}</span>`;
            cardBorderColor = 'var(--pending-color)';
        }
        let detailsHtml = '';
        const details = req.details || {};
        
        if (req.request_type === 'permission') {
            detailsHtml = `<p><strong>السبب:</strong> ${details.reason}</p>`;
        } else if (req.request_type === 'leave') {
            detailsHtml = `
                <p><strong>النوع:</strong> ${details.type}</p>
                <p><strong>من:</strong> ${formatGregorianDate(details.start_date)} <strong>إلى:</strong> ${formatGregorianDate(details.end_date)}</p>
                <p><strong>المدة:</strong> ${details.days} أيام</p>
            `;
        } else if (req.request_type === 'loan') {
            detailsHtml = `<p><strong>المبلغ:</strong> ${details.amount} ر.س</p><p><strong>السبب:</strong> ${details.reason}</p>`;
        } else if (req.request_type === 'resignation') {
            detailsHtml = `<p><strong>سبب الاستقالة:</strong> ${details.reason}</p>`;
        }
        const rejectionHtml = (req.status === 'مرفوض' && req.rejection_reason) 
            ? `<div style="margin-top:10px; padding:10px; background:#fef2f2; border-radius:6px; color:#991b1b; font-size:0.9rem;"><strong>سبب الرفض:</strong> ${req.rejection_reason}</div>` 
            : '';

        return `
            <div class="review-request-card" style="border-right: 5px solid ${cardBorderColor};">
                <div class="review-request-header" style="background: white; color: var(--text-primary); border-bottom: 1px solid #e5e7eb;">
                    <h4 style="display:flex; align-items:center; gap:10px;">
                        ${getRequestIcon(req.request_type)} 
                        ${getRequestTitle(req.request_type)}
                    </h4>
                    ${statusBadge}
                </div>
                <div class="review-request-body">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:10px;">تاريخ الرفع: ${formatGregorianDateTime(req.created_at)}</small>
                    ${detailsHtml}
                    ${rejectionHtml}
                </div>
            </div>
        `;
    }).join('');
}
function getRequestTitle(type) {
    const titles = { 'permission': 'استئذان', 'leave': 'إجازة', 'loan': 'سلفة', 'resignation': 'استقالة' };
    return titles[type] || type;
}
function getRequestIcon(type) {
    const icons = { 
        'permission': '<i class="ph-fill ph-clock-countdown" style="color:#0d6efd;"></i>', 
        'leave': '<i class="ph-fill ph-calendar-blank" style="color:#198754;"></i>', 
        'loan': '<i class="ph-fill ph-hand-coins" style="color:#ffc107;"></i>', 
        'resignation': '<i class="ph-fill ph-file-x" style="color:#dc3545;"></i>' 
    };
    return icons[type] || '';
}

async function loadHrAdminReviews() {
    const container = document.getElementById('hr-admin-reviews-container');
    const activeTab = document.querySelector('#page-hr-admin-reviews .tab-link.active');
    const filterType = activeTab ? activeTab.dataset.filter : 'all';

    container.innerHTML = '<p style="text-align: center;">جاري تحميل الطلبات...</p>';

    try {
        let query = supabaseClient
            .from('employee_requests')
            .select(`*, user:users!user_id!inner(id, name, role, id_number, project)`)
            .eq('status', 'بانتظار موافقة الموارد البشرية')
            .not('user.role', 'in', '("حارس أمن","مشرف")')
            .order('created_at', { ascending: false });
        if (filterType !== 'all') {
            query = query.eq('request_type', filterType);
        }

        const { data: requests, error } = await query;

        if (error) throw error;

        if (requests.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-check-circle"></i><h4>لا توجد طلبات</h4><p>لا توجد طلبات معلقة للموظفين الإداريين حالياً.</p></div>';
            return;
        }
        renderRequests(requests, 'hr-admin-reviews-container', 'إداري', 'hr_admin_final');

    } catch (err) {
        console.error(err);
        container.innerHTML = `<p style="color:red;">حدث خطأ: ${err.message}</p>`;
    }
}
document.querySelector('#page-hr-admin-reviews .tabs')?.addEventListener('click', (e) => {
    e.preventDefault();
    const targetTab = e.target.closest('.filter-tab');
    
    if (targetTab) {
        document.querySelectorAll('#page-hr-admin-reviews .filter-tab').forEach(t => t.classList.remove('active'));
        targetTab.classList.add('active');
        loadHrAdminReviews();
    }
});

async function loadAdminHistoryPage() {
    if (!document.getElementById('admin-hist-from').value) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('admin-hist-from').value = today;
        document.getElementById('admin-hist-to').value = today;
    }
    
    fetchAdminHistory(); // تحميل مبدئي
}

async function fetchAdminHistory() {
    const container = document.getElementById('admin-history-container');
    const fromDate = document.getElementById('admin-hist-from').value;
    const toDate = document.getElementById('admin-hist-to').value;
    const search = document.getElementById('admin-hist-search').value.toLowerCase();

    container.innerHTML = '<p style="text-align:center;">جاري البحث...</p>';
    let query = supabaseClient
        .from('attendance')
        .select('*, guard:guard_id(name, id_number)')
        .eq('project', 'إداري') // <--- الفلتر الأساسي للعزل
        .gte('created_at', fromDate + 'T00:00:00')
        .lte('created_at', toDate + 'T23:59:59')
        .order('created_at', { ascending: false });

    const { data: records, error } = await query;

    if (error) {
        container.innerHTML = `<p style="color:red;">خطأ: ${error.message}</p>`;
        return;
    }
    const filtered = records.filter(r => !search || (r.guard && r.guard.name.toLowerCase().includes(search)));

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><h4>لا توجد سجلات</h4><p>لم يتم العثور على بيانات في هذه الفترة.</p></div>';
        return;
    }
    container.innerHTML = `
        <table class="attendance-log-table">
            <thead>
                <tr>
                    <th>الموظف</th>
                    <th>التاريخ</th>
                    <th>دخول</th>
                    <th>خروج</th>
                    <th>الحالة</th>
                    <th>ملاحظات</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody>
                ${filtered.map(rec => {
                    const date = formatGregorianDate(rec.created_at);
                    const inTime = new Date(rec.created_at).toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'});
                    const outTime = rec.checkout_at ? new Date(rec.checkout_at).toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'}) : '-';
                    
                    return `
                        <tr>
                            <td>${rec.guard?.name || 'غير معروف'}</td>
                            <td>${date}</td>
                            <td style="color:#16a34a;">${inTime}</td>
                            <td style="color:#dc2626;">${outTime}</td>
                            <td><span class="status ${rec.status === 'اكمل المناوبة' ? 'active' : 'pending'}">${rec.status}</span></td>
                            <td><small>${rec.notes || '-'}</small></td>
                            <td>
                                <div style="display:flex; gap:5px;">
                                    <button class="btn btn-secondary btn-sm edit-admin-rec-btn" 
                                        data-id="${rec.id}" 
                                        data-user-id="${rec.guard_id}"
                                        data-status="${rec.status}"
                                        data-in="${rec.created_at}"
                                        data-out="${rec.checkout_at || ''}"
                                        data-notes="${rec.notes || ''}">
                                        <i class="ph-bold ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-admin-rec-btn" data-id="${rec.id}">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}
document.getElementById('btn-admin-hist-search')?.addEventListener('click', fetchAdminHistory);
async function openAdminRecordModal(isEdit, data = null) {
    const modal = document.getElementById('admin-record-modal');
    const form = document.getElementById('admin-record-form');
    form.reset();
    const select = document.getElementById('admin-rec-user');
    select.innerHTML = '<option>جاري التحميل...</option>';
    const { data: users } = await supabaseClient
        .from('users')
        .select('id, name')
        .not('role', 'in', '("حارس أمن","مشرف")') // إداريين فقط
        .order('name');
        
    select.innerHTML = '<option value="">اختر الموظف</option>';
    users.forEach(u => {
        select.innerHTML += `<option value="${u.id}">${u.name}</option>`;
    });

    if (isEdit && data) {
        document.getElementById('admin-record-title').textContent = 'تعديل سجل';
        document.getElementById('admin-rec-id').value = data.id;
        select.value = data.userId;
        select.disabled = true; // منع تغيير الموظف عند التعديل
        document.getElementById('admin-rec-status').value = data.status;
        const toLocalISO = (d) => d ? new Date(new Date(d).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
        document.getElementById('admin-rec-in').value = toLocalISO(data.in);
        document.getElementById('admin-rec-out').value = toLocalISO(data.out);
        document.getElementById('admin-rec-notes').value = data.notes;
    } else {
        document.getElementById('admin-record-title').textContent = 'إضافة سجل جديد';
        document.getElementById('admin-rec-id').value = '';
        select.disabled = false;
    }
    
    modal.classList.remove('hidden');
}
document.getElementById('btn-add-admin-record')?.addEventListener('click', () => openAdminRecordModal(false));
document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('.edit-admin-rec-btn');
    if (btn) {
        const data = {
            id: btn.dataset.id,
            userId: btn.dataset.userId,
            status: btn.dataset.status,
            in: btn.dataset.in,
            out: btn.dataset.out,
            notes: btn.dataset.notes
        };
        openAdminRecordModal(true, data);
    }
});
document.body.addEventListener('click', async (e) => {
    const btn = e.target.closest('.delete-admin-rec-btn');
    if (btn) {
        if(!confirm('حذف هذا السجل نهائياً؟')) return;
        await supabaseClient.from('attendance').delete().eq('id', btn.dataset.id);
        showToast('تم الحذف', 'success');
        fetchAdminHistory();
    }
});

document.body.addEventListener('submit', async (e) => {
    if (e.target.id === 'admin-record-form') {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true;
        btn.textContent = 'جاري الحفظ والتوثيق...';

        try {
            const id = document.getElementById('admin-rec-id').value;
            const userId = document.getElementById('admin-rec-user').value;
            const { data: user, error: userError } = await supabaseClient
                .from('users')
                .select('*, company_branches(name, coordinates)')
                .eq('id', userId)
                .single();
            
            if (userError || !user) throw new Error('تعذر جلب بيانات الموظف لتوثيق السجل.');
            const snapshot = {
                project: 'إداري',
                location: user.company_branches?.name || 'مقر غير محدد',
                region: user.region || 'المركز الرئيسي',
                city: user.city || 'الرياض',
                base_salary: user.basic_salary || 0,
                housing_allowance: user.housing_allowance || 0,
                transport_allowance: user.transport_allowance || 0,
                other_allowances: user.other_allowance || 0,
                role: user.role,
                branch_id: user.branch_id,
                schedule_details: [{
                    name: 'دوام إداري',
                    start_time: '08:00', // افتراضي
                    end_time: '16:00'    // افتراضي
                }]
            };
            const payload = {
                guard_id: userId,
                guard_name: user.name,
                project: 'إداري',
                location: snapshot.location,
                region: snapshot.region,
                city: snapshot.city,
                
                status: document.getElementById('admin-rec-status').value,
                created_at: new Date(document.getElementById('admin-rec-in').value).toISOString(),
                checkout_at: document.getElementById('admin-rec-out').value ? new Date(document.getElementById('admin-rec-out').value).toISOString() : null,
                notes: document.getElementById('admin-rec-notes').value,
                shift_snapshot: snapshot, // <--- هنا يتم حفظ النسخة
                is_manual_entry: true,
                checkin_lat: 0, 
                checkin_lon: 0
            };
            let error;
            if (id) {
                const { error: updateError } = await supabaseClient.from('attendance').update(payload).eq('id', id);
                error = updateError;
            } else {
                const { error: insertError } = await supabaseClient.from('attendance').insert(payload);
                error = insertError;
            }

            if (error) throw error;

            showToast('تم حفظ السجل وتوثيق بيانات الموظف بنجاح', 'success');
            document.getElementById('admin-record-modal').classList.add('hidden');
            fetchAdminHistory();

        } catch (err) {
            alert('خطأ: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'حفظ السجل';
        }
    }
});
async function loadCmdInbox() {
    const container = document.getElementById('cmd-requests-container');
    container.innerHTML = '<p style="text-align:center;">جاري التحميل...</p>';

    try {
        let query = supabaseClient
            .from('employee_requests')
            .select(`*, user:users!user_id!inner(id, name, role, id_number)`)
            .eq('status', 'بانتظار موافقة مدير القسم');
        if (currentUser.name === 'High Commander') {
        } else {
            query = query.eq('user.role', currentUser.role);
        }

        const { data: requests, error } = await query.order('created_at', { ascending: false });

        if (error) throw error;

        if (requests.length === 0) {
            container.innerHTML = '<div class="empty-state"><h4>لا توجد طلبات</h4><p>صندوق الوارد فارغ.</p></div>';
            return;
        }

        renderRequests(requests, 'cmd-requests-container', 'استئذان إداري', 'cmd_approval');

    } catch (err) {
        container.innerHTML = `<p style="color:red;">خطأ: ${err.message}</p>`;
    }
}

async function loadDeptPermissionsPage() {
    const container = document.getElementById('dept-permissions-container');
    
    if (!container) {
        console.error("❌ لم يتم العثور على الصندوق: dept-permissions-container");
        return;
    }
    
    container.innerHTML = '<p style="text-align: center;">جاري الاتصال بقاعدة البيانات...</p>';

    try {
        let query = supabaseClient
            .from('employee_requests')
            .select(`*, user:users!user_id(id, name, role, id_number, region, vacancy_id)`) 
            .eq('request_type', 'permission')
            .eq('status', 'بانتظار موافقة مدير القسم')
            .order('created_at', { ascending: false });

        const { data: allRequests, error } = await query;

        if (error) throw error;
        let filteredRequests = [];

        if (currentUser.name === 'High Commander' || currentUser.role === 'مدير النظام') {
             filteredRequests = allRequests;
        } else {
            filteredRequests = allRequests.filter(req => 
                req.user && req.user.role === currentUser.role
            );
        }
        if (filteredRequests.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-check-circle"></i><h4>لا توجد طلبات</h4><p>لا توجد طلبات استئذان معلقة في قسمك حالياً.</p></div>';
            return;
        }
        renderRequests(filteredRequests, 'dept-permissions-container', 'استئذان إداري', 'cmd_approval');

    } catch (err) {
        console.error("Error loading dept permissions:", err);
        container.innerHTML = `<p style="color:red; text-align:center;">حدث خطأ: ${err.message}</p>`;
    }
}
async function loadPayrollSettingsPage() {
    console.log("Loading Payroll Settings...");
    const page = document.getElementById('page-payroll-settings');
    const tabs = page.querySelectorAll('.tab-link');
    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            page.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            page.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });
    const { data: settings, error } = await supabaseClient.from('payroll_settings').select('*');
    if (error) return alert('فشل تحميل الإعدادات: ' + error.message);
    const config = settings.reduce((acc, item) => ({...acc, [item.setting_key]: item.setting_value}), {});
    document.getElementById('conf-gosi-percent').value = config['gosi_percent'] || 9.75;
    document.getElementById('conf-uniform-deduction').value = config['uniform_deduction'] || 150;
    document.getElementById('conf-calc-days-basis').value = config['calc_days_basis'] || '30';
    document.getElementById('conf-overtime-normal').value = config['overtime_rate_normal'] || 1.5;
    document.getElementById('conf-overtime-holiday').value = config['overtime_rate_holiday'] || 2.0;
    const absenceContainer = document.getElementById('absence-rules-container');
    absenceContainer.innerHTML = '';
    const absenceRules = config['absence_rules'] || [];
    absenceRules.forEach(rule => {
        renderAbsenceRuleRow(rule);
    });
    const latenessContainer = document.getElementById('lateness-rules-container');
    latenessContainer.innerHTML = '';
    const latenessRules = config['lateness_rules'] || [];
    latenessRules.forEach(rule => {
        renderLatenessRuleRow(rule);
    });
}
function renderAbsenceRuleRow(rule = {count: '', action: 'deduct', value: 1, note: ''}) {
    const container = document.getElementById('absence-rules-container');
    const rowId = `abs-rule-${Date.now()}-${Math.random()}`;
    
    const html = `
    <div class="form-grid absence-rule-row" id="${rowId}" style="grid-template-columns: 1fr 1fr 1fr 2fr auto; align-items: end; margin-bottom: 10px; background: #fff; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">المرة رقم</label><input type="number" class="rule-count" value="${rule.count}" placeholder="1"></div>
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">الإجراء</label>
            <select class="rule-action">
                <option value="deduct" ${rule.action === 'deduct' ? 'selected' : ''}>خصم أيام</option>
                <option value="deduct_warning" ${rule.action === 'deduct_warning' ? 'selected' : ''}>خصم + إنذار</option>
                <option value="warning" ${rule.action === 'warning' ? 'selected' : ''}>إنذار فقط</option>
            </select>
        </div>
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">القيمة (أيام)</label><input type="number" class="rule-value" value="${rule.value}" step="0.25"></div>
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">وصف العقوبة</label><input type="text" class="rule-note" value="${rule.note}" placeholder="مثال: خصم يوم واحد"></div>
        <button class="btn btn-danger btn-sm delete-rule-btn" onclick="document.getElementById('${rowId}').remove()"><i class="ph-bold ph-trash"></i></button>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}

function renderLatenessRuleRow(rule = {min: 0, max: 0, deduct_ratio: 0, note: ''}) {
    const container = document.getElementById('lateness-rules-container');
    const rowId = `lat-rule-${Date.now()}-${Math.random()}`;
    
    const html = `
    <div class="form-grid lateness-rule-row" id="${rowId}" style="grid-template-columns: 1fr 1fr 1fr 2fr auto; align-items: end; margin-bottom: 10px; background: #fff; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">من دقيقة</label><input type="number" class="rule-min" value="${rule.min}"></div>
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">إلى دقيقة</label><input type="number" class="rule-max" value="${rule.max}"></div>
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">الخصم (نسبة من اليوم)</label><input type="number" class="rule-ratio" value="${rule.deduct_ratio}" step="0.25" placeholder="0.25 = ربع يوم"></div>
        <div class="form-group" style="margin:0;"><label style="font-size:0.8rem">الوصف</label><input type="text" class="rule-note" value="${rule.note}"></div>
        <button class="btn btn-danger btn-sm delete-rule-btn" onclick="document.getElementById('${rowId}').remove()"><i class="ph-bold ph-trash"></i></button>
    </div>`;
    container.insertAdjacentHTML('beforeend', html);
}
document.addEventListener('click', (e) => {
    if (e.target.closest('#add-absence-rule-btn')) renderAbsenceRuleRow();
    if (e.target.closest('#add-lateness-rule-btn')) renderLatenessRuleRow();
});
document.getElementById('save-payroll-settings-btn')?.addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.textContent = 'جاري الحفظ...';

    try {
        const absenceRows = document.querySelectorAll('.absence-rule-row');
        const absenceRules = Array.from(absenceRows).map(row => ({
            count: parseInt(row.querySelector('.rule-count').value) || 0,
            action: row.querySelector('.rule-action').value,
            value: parseFloat(row.querySelector('.rule-value').value) || 0,
            note: row.querySelector('.rule-note').value
        })).sort((a, b) => a.count - b.count); // ترتيب حسب المرة
        const latenessRows = document.querySelectorAll('.lateness-rule-row');
        const latenessRules = Array.from(latenessRows).map(row => ({
            min: parseInt(row.querySelector('.rule-min').value) || 0,
            max: parseInt(row.querySelector('.rule-max').value) || 0,
            deduct_ratio: parseFloat(row.querySelector('.rule-ratio').value) || 0,
            note: row.querySelector('.rule-note').value
        })).sort((a, b) => a.min - b.min);

        const updates = [
            { setting_key: 'gosi_percent', setting_value: document.getElementById('conf-gosi-percent').value, category: 'general' },
            { setting_key: 'uniform_deduction', setting_value: document.getElementById('conf-uniform-deduction').value, category: 'general' },
            { setting_key: 'calc_days_basis', setting_value: document.getElementById('conf-calc-days-basis').value, category: 'general' },
            { setting_key: 'overtime_rate_normal', setting_value: document.getElementById('conf-overtime-normal').value, category: 'overtime' },
            { setting_key: 'overtime_rate_holiday', setting_value: document.getElementById('conf-overtime-holiday').value, category: 'overtime' },
            { setting_key: 'absence_rules', setting_value: absenceRules, category: 'absence' },
            { setting_key: 'lateness_rules', setting_value: latenessRules, category: 'lateness' }
        ];

        const { error } = await supabaseClient.from('payroll_settings').upsert(updates, { onConflict: 'setting_key' });
        if (error) throw error;

        showToast('تم حفظ إعدادات المسير بنجاح!', 'success');

    } catch (err) {
        alert('خطأ في الحفظ: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> حفظ كافة الإعدادات';
    }
});
function calculateAbsencePenalty(count, rules, dailyRate) {
    const sortedRules = rules.sort((a, b) => a.count - b.count);
    let rule = sortedRules.find(r => r.count === count);
    if (!rule && count > sortedRules[sortedRules.length - 1]?.count) {
        rule = sortedRules[sortedRules.length - 1];
    }

    if (!rule) return { amount: 0, note: '' };

    const deduction = (rule.value || 0) * dailyRate;
    return { amount: deduction, note: rule.note };
}
function calculateLatenessPenalty(minutes, rules, dailyRate) {
    const rule = rules.find(r => minutes >= r.min && minutes <= r.max);
    
    if (!rule) return 0; // لا يوجد خصم لهذه المدة
    return (rule.deduct_ratio || 0) * dailyRate;
}

let currentDraftId = null;
let isDraftReadOnlyMode = false;
let currentDraftData = []; // لتخزين البيانات محلياً أثناء التعديل
async function openPayrollDraftEditor(draftId, isReadOnly = false) {
    const modal = document.getElementById('payroll-draft-editor-modal');
    const tbody = document.getElementById('draft-table-body');
    
    currentDraftId = draftId;
    isDraftReadOnlyMode = isReadOnly; // حفظ الوضع

    modal.classList.remove('hidden');
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding: 30px;"><i class="ph-bold ph-spinner animate-spin"></i> جاري تحميل البيانات...</td></tr>';
    const saveBtn = document.getElementById('save-draft-changes-btn');
    const submitManagerBtn = document.getElementById('submit-to-manager-btn');
    const approveBtn = document.getElementById('approve-draft-btn');
    saveBtn.classList.add('hidden');
    submitManagerBtn.classList.add('hidden');
    approveBtn.classList.add('hidden');

    try {
        const { data: draft, error } = await supabaseClient
            .from('payroll_drafts')
            .select('*')
            .eq('id', draftId)
            .single();

        if (error) throw error;

        document.getElementById('draft-editor-title').textContent = `مسير رواتب شهر ${draft.month} / ${draft.year}`;
        currentDraftDetails = { month: draft.month, year: draft.year };
        currentDraftData = draft.payroll_data;
        if (!isReadOnly) {
            if (draft.status === 'draft') {
                saveBtn.classList.remove('hidden');
                submitManagerBtn.classList.remove('hidden');
            } else if (draft.status === 'pending_manager') {
                if (currentUser.role === 'مدير النظام' || currentUser.is_hr_manager) {
                    approveBtn.classList.remove('hidden'); // اعتماد نهائي للمالية
                }
            }
        } else {
             document.getElementById('draft-status-badge').textContent = 'للمراجعة المالية';
             document.getElementById('draft-status-badge').className = 'status-badge approved';
        }
        
        renderDraftTable();
        updateDraftTotal();

    } catch (err) {
        alert('خطأ: ' + err.message);
        modal.classList.add('hidden');
    }
}
function renderDraftTable() {
    const tbody = document.getElementById('draft-table-body');
    const searchTerm = document.getElementById('draft-search-input').value.toLowerCase();
    
    tbody.innerHTML = '';

    currentDraftData.forEach((emp, index) => {
        if (searchTerm && !emp.name.toLowerCase().includes(searchTerm)) return;

        const row = document.createElement('tr');
        row.dataset.index = index;
        const fmt = (n) => n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const createCell = (fieldPath, value, type = 'number') => {
            if (isDraftReadOnlyMode) {
                return `<span style="padding: 8px; display: block;">${type === 'number' ? fmt(value) : value}</span>`;
            } else {
                const step = type === 'number' ? 'step="0.01"' : '';
                const inputClass = type === 'number' ? (fieldPath.includes('deductions') ? 'deduct' : 'add') : '';
                return `<input type="${type}" class="draft-input ${inputClass}" data-field="${fieldPath}" value="${value}" ${step}>`;
            }
        };
        const loanVal = emp.deductions.loan || 0;
        const otherVal = emp.deductions.other || 0;

        row.innerHTML = `
            <td style="position: sticky; right: 0; background: white; z-index: 11;"><strong>${emp.name}</strong></td>
            <td>${emp.id_number}</td>
            <td>${emp.region}</td>
            <td>${emp.project}</td>
            <td>${emp.location}</td>
            
            <td>${fmt(emp.basic_salary)}</td>
            <td>${fmt(emp.housing)}</td>
            <td>${fmt(emp.transport)}</td>
            <td>${fmt(emp.other)}</td>
            <td style="background: #f9fafb; font-weight:bold;">${fmt(emp.total_gross)}</td>
            <td>${fmt(emp.daily_rate)}</td>

            <td>${emp.worked_days}</td>
            <td>${emp.rest_days}</td>
            <td>${emp.absent_days}</td>
            <td>${emp.withdrawal_count}</td>
            <td>${emp.covered_days}</td>

            <td>${createCell('additions.rest_allowance', emp.additions.rest_allowance)}</td>
            <td>${createCell('additions.overtime', emp.additions.overtime)}</td>
            <td style="background: #ecfdf5; font-weight:bold;" class="gross-payable-cell">${fmt(emp.additions.gross_payable)}</td>

            <td>${createCell('deductions.absence', emp.deductions.absence)}</td>
            <td>${createCell('deductions.lateness', emp.deductions.lateness)}</td>
            <td>${createCell('deductions.gosi', emp.deductions.gosi)}</td>
            <td>${createCell('deductions.uniform', emp.deductions.uniform)}</td>
            <td>${createCell('deductions.loan', loanVal)}</td>
            <td>${createCell('deductions.other', otherVal)}</td>
            <td style="background: #fef2f2; font-weight:bold;" class="total-deductions-cell">${fmt(emp.deductions.total)}</td>

            <td style="position: sticky; left: 0; background: #dcfce7; z-index: 11; font-weight: bold; color: #166534;" class="net-salary-cell">
                ${fmt(emp.net_salary)}
            </td>
            
            <td>${emp.bank_name || '-'}</td>
            <td>${emp.iban || '-'}</td>
            <td>${createCell('note', emp.note || '', 'text')}</td>
        `;
        tbody.appendChild(row);
    });

    if (!isDraftReadOnlyMode) {
        addInputListeners(); // تفعيل التعديل فقط إذا لم يكن للقراءة
    }
}
function addInputListeners() {
    document.querySelectorAll('.draft-input').forEach(input => {
        input.addEventListener('input', (e) => {
            const row = e.target.closest('tr');
            const index = row.dataset.index;
            const fieldPath = e.target.dataset.field.split('.');
            const newValue = e.target.value; // نحتفظ بها كنص أولاً للتحقق
            if (fieldPath[0] === 'note') {
                currentDraftData[index].note = newValue;
            } else {
                const val = parseFloat(newValue) || 0;
                currentDraftData[index][fieldPath[0]][fieldPath[1]] = val;
                const emp = currentDraftData[index];
                const workedPay = (emp.worked_days * emp.daily_rate); // تقريبي
                const newGrossPayable = workedPay + emp.additions.rest_allowance + emp.additions.overtime;
                const newTotalDeductions = 
                    emp.deductions.absence + 
                    emp.deductions.lateness + 
                    emp.deductions.gosi + 
                    emp.deductions.uniform + 
                    emp.deductions.loan + 
                    emp.deductions.other;
                const newNet = newGrossPayable - newTotalDeductions;
                emp.additions.gross_payable = newGrossPayable;
                emp.deductions.total = newTotalDeductions;
                emp.net_salary = newNet;
                const fmt = (n) => n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                row.querySelector('.gross-payable-cell').textContent = fmt(newGrossPayable);
                row.querySelector('.total-deductions-cell').textContent = fmt(newTotalDeductions);
                row.querySelector('.net-salary-cell').textContent = fmt(newNet);
                
                updateDraftTotal();
            }
            
            e.target.style.backgroundColor = '#fffbeb';
            e.target.style.borderColor = '#f59e0b';
        });
    });
}

function updateDraftTotal() {
    const total = currentDraftData.reduce((sum, emp) => sum + (emp.net_salary || 0), 0);
    document.getElementById('draft-total-net').textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2});
}
document.getElementById('draft-search-input')?.addEventListener('keyup', renderDraftTable);

async function loadPayrollDashboardPage() {
    const container = document.getElementById('payroll-dashboard-grid');
    const monthSelect = document.getElementById('payroll-dash-month');
    const yearSelect = document.getElementById('payroll-dash-year');
    if (monthSelect.options.length === 0) {
        const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
        monthSelect.innerHTML = months.map((m, i) => `<option value="${i+1}" ${i+1 === new Date().getMonth()+1 ? 'selected' : ''}>${m}</option>`).join('');
        const currentYear = new Date().getFullYear();
        yearSelect.innerHTML = `<option value="${currentYear}">${currentYear}</option><option value="${currentYear-1}">${currentYear-1}</option>`;
        
        monthSelect.addEventListener('change', loadPayrollDashboardPage);
        yearSelect.addEventListener('change', loadPayrollDashboardPage);
        document.getElementById('refresh-payroll-dash-btn').addEventListener('click', loadPayrollDashboardPage);
    }

    container.innerHTML = '<div style="width:100%; text-align:center; padding:50px;"><i class="ph-bold ph-spinner animate-spin" style="font-size:2rem; color:var(--accent-color);"></i><br><br>جاري تحليل هيكل المشاريع والمسيرات...</div>';

    try {
        const selectedMonth = parseInt(monthSelect.value);
        const selectedYear = parseInt(yearSelect.value);
        const { data: contracts, error: conError } = await supabaseClient
            .from('contracts')
            .select('id, company_name, region, contract_locations')
            .eq('status', 'active');
        
        if (conError) throw conError;
        const { data: drafts, error: draftError } = await supabaseClient
            .from('payroll_drafts')
            .select('id, status, payroll_data')
            .eq('month', selectedMonth)
            .eq('year', selectedYear);

        if (draftError) throw draftError;
        const { data: financialRequests, error: finError } = await supabaseClient
            .from('financial_requests')
            .select('linked_draft_id, status')
            .eq('request_type', 'رواتب ومسيرات');

        if (finError) throw finError;
        const hierarchy = {};

        contracts.forEach(contract => {
            const region = contract.region || 'مناطق أخرى';
            if (!hierarchy[region]) hierarchy[region] = [];
            const projectDraft = drafts.find(d => d.payroll_data.some(emp => emp.project === contract.company_name));
            const projectStatus = analyzePayrollStatus(projectDraft, financialRequests, contract.company_name, null);

            const locationsList = Array.isArray(contract.contract_locations) ? contract.contract_locations : [];
            const projectObj = {
                name: contract.company_name,
                status: projectStatus,
                locations: []
            };
            locationsList.forEach(loc => {
                const locationDraft = drafts.find(d => d.payroll_data.some(emp => emp.project === contract.company_name && emp.location === loc.name));
                
                projectObj.locations.push({
                    name: loc.name,
                    status: analyzePayrollStatus(locationDraft, financialRequests, contract.company_name, loc.name)
                });
            });

            hierarchy[region].push(projectObj);
        });
        container.innerHTML = '';
        
        if (Object.keys(hierarchy).length === 0) {
            container.innerHTML = '<p style="text-align:center;">لا توجد عقود نشطة.</p>';
            return;
        }

        for (const [region, projects] of Object.entries(hierarchy)) {
            const regionSection = document.createElement('div');
            regionSection.className = 'dashboard-region-section';
            
            let projectsHtml = '';
            projects.forEach(proj => {
                let locationsHtml = '';
                if (proj.locations.length > 0) {
                    locationsHtml = `<div class="project-card-body" style="background:white;">
                        <div style="padding: 10px 20px; background: #f9fafb; font-size: 0.85rem; color: #6b7280; border-bottom: 1px solid #e5e7eb;">فروع المشروع</div>`;
                    
                    proj.locations.forEach(loc => {
                        let locActionBtn = loc.status.actionBtn;
                        if (loc.status.code === 'missing' && proj.status.code !== 'missing') {
                            locActionBtn = `<span style="color:#16a34a; font-size:0.85rem;"><i class="ph-bold ph-check"></i> ضمن المشروع</span>`;
                        }

                        locationsHtml += `
                            <div class="location-row">
                                <span style="display:flex; align-items:center;"><i class="ph-bold ph-map-pin" style="margin-left:5px; color:#9ca3af;"></i> ${loc.name}</span>
                                ${locActionBtn}
                            </div>
                        `;
                    });
                    locationsHtml += `</div>`;
                }

                projectsHtml += `
                    <div class="dashboard-project-card">
                        <div class="project-card-header">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="status-dot" style="background-color: ${proj.status.color}"></div>
                                <h5>${proj.name}</h5>
                            </div>
                            ${proj.status.actionBtn}
                        </div>
                        ${locationsHtml}
                    </div>
                `;
            });

            regionSection.innerHTML = `
                <div class="dashboard-region-title"><i class="ph-fill ph-globe-hemisphere-east"></i> ${region}</div>
                <div class="dashboard-projects-grid">${projectsHtml}</div>
            `;
            container.appendChild(regionSection);
        }

    } catch (err) {
        console.error(err);
        container.innerHTML = `<p style="color:red; text-align:center;">حدث خطأ: ${err.message}</p>`;
    }
}
function analyzePayrollStatus(draft, financialRequests, projectName, locationName) {
    let status = 'missing';
    let statusText = 'لم يتم الرفع';
    let statusColor = '#ef4444'; // أحمر
    let actionBtn = '';
    const locArg = locationName ? `'${locationName}'` : 'null';

    if (draft) {
        const finReq = financialRequests.find(fr => fr.linked_draft_id === draft.id);

        if (finReq) {
            if (finReq.status === 'مكتمل') {
                status = 'paid';
                statusText = 'تم الصرف';
                statusColor = '#16a34a'; // أخضر
                actionBtn = `<button class="btn btn-sm btn-secondary" onclick="openPayrollDraftEditor('${draft.id}')" style="font-size:0.8rem;">عرض الأرشيف</button>`;
            } else {
                status = 'pending_finance';
                statusText = `لدى المالية (${finReq.status})`;
                statusColor = '#f59e0b'; // برتقالي
                actionBtn = `<button class="btn btn-sm btn-secondary" onclick="openPayrollDraftEditor('${draft.id}')" style="font-size:0.8rem;">متابعة</button>`;
            }
        } else {
            if (draft.status === 'pending_manager') {
                status = 'review';
                statusText = 'بانتظار اعتمادك (المدير)';
                statusColor = '#9333ea'; // بنفسجي مميز
                actionBtn = `<button class="btn btn-sm btn-primary" onclick="openPayrollDraftEditor('${draft.id}')" style="font-size:0.8rem;">مراجعة واعتماد</button>`;
            } else if (draft.status === 'approved_by_hr') { 
                status = 'error';
                statusText = 'خطأ في الرفع';
                statusColor = '#ef4444';
                actionBtn = `<button class="btn btn-sm btn-danger" onclick="openPayrollDraftEditor('${draft.id}')">إعادة المحاولة</button>`;
            } else {
                status = 'draft';
                statusText = 'قيد التجهيز (عند الموظف)';
                statusColor = '#64748b'; // رمادي
                actionBtn = `<button class="btn btn-sm btn-secondary" onclick="openPayrollDraftEditor('${draft.id}')" style="font-size:0.8rem;">فتح المسودة</button>`;
            }
        }
    } else {
        status = 'missing';
        statusText = 'لم يتم الرفع';
        statusColor = '#ef4444';
        actionBtn = `<button class="btn btn-primary btn-sm" onclick="goToGeneratePayroll('${projectName}', ${locArg})" style="font-size:0.8rem;">إنشاء مسير</button>`;
    }

    return { code: status, label: statusText, color: statusColor, actionBtn: actionBtn };
}
function goToGeneratePayroll(projectName, locationName) {
    document.querySelector('a[data-page="page-payroll"]').click();
    setTimeout(async () => {
        document.getElementById('payroll-start-date').value = ''; 
        document.getElementById('payroll-end-date').value = ''; 
        const dashMonth = document.getElementById('payroll-dash-month').value;
        const dashYear = document.getElementById('payroll-dash-year').value;
        const startDate = new Date(dashYear, dashMonth - 1, 1);
        const endDate = new Date(dashYear, dashMonth, 0);
        const formatDate = (d) => d.toISOString().split('T')[0];
        document.getElementById('payroll-start-date').value = formatDate(startDate);
        document.getElementById('payroll-end-date').value = formatDate(endDate);
        let msg = `تم تحديد التواريخ تلقائياً لشهر ${dashMonth}/${dashYear}.\n\nالرجاء الآن من الفلاتر:\n1. اختر "المنطقة".\n2. اختر "المدينة".\n3. تأكد من اختيار المشروع: "${projectName}".`;
        if (locationName) msg += `\n4. اختر الموقع: "${locationName}".`;
        
        alert(msg);

    }, 500);
}
document.getElementById('submit-to-manager-btn')?.addEventListener('click', async function() {
    if (!confirm('هل أنت متأكد من إرسال المسير للمدير للمراجعة؟\nلن تتمكن من تعديله بعد الإرسال.')) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري الإرسال...';

    try {
        const { error } = await supabaseClient
            .from('payroll_drafts')
            .update({ 
                payroll_data: currentDraftData, // حفظ آخر تعديلات
                status: 'pending_manager' // التغيير للحالة الوسيطة
            })
            .eq('id', currentDraftId);

        if (error) throw error;
        const { data: managers } = await supabaseClient.from('users').select('id').eq('is_hr_manager', true);
        if (managers && managers.length > 0) {
            const managerIds = managers.map(u => u.id);
            sendNotification(managerIds, 'مسير بانتظار المراجعة', 'تم رفع مسير جديد للمراجعة والاعتماد.', '/payroll-dashboard');
        }

        showToast('تم إرسال المسير للمدير بنجاح.', 'success');
        document.getElementById('payroll-draft-editor-modal').classList.add('hidden');
        if (document.querySelector('#page-payroll:not(.hidden)')) {
            document.getElementById('payroll-results-container').innerHTML = '<p style="text-align:center;">تم إرسال المسير. يمكنك متابعته من اللوحة.</p>';
        }

    } catch (err) {
        alert('خطأ: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="ph-bold ph-paper-plane-right"></i> إرسال للمدير للمراجعة';
    }
});
function getSaudiBankCode(bankName, iban) {
    const name = bankName ? bankName.trim().toLowerCase() : ''; // تحويل لحروف صغيرة للمقارنة
    const cleanIban = iban ? iban.replace(/\s/g, '').toUpperCase() : '';
    const bankMapping = {
        'RJHI': ['الراجحي', 'rajhi', 'alrajhi', 'al rajhi', 'al-rajhi'],
        'NCB':  ['الأهلي', 'alahli', 'ncb', 'snb', 'البنك الأهلي', 'national commercial bank'],
        'RIYAD': ['الرياض', 'riyad', 'riyadh', 'bank alriyadh'],
        'INMA': ['الإنماء', 'alinma', 'inma', 'bank alinma'],
        'BILAD': ['البلاد', 'albilad', 'bilad', 'bank albilad'],
        'ANB':  ['العربي', 'anb', 'arab', 'arab national'],
        'SAIB': ['الاستثمار', 'saib', 'investment', 'saudi investment'],
        'BSF':  ['الفرنسي', 'fransi', 'bsf', 'banque saudi fransi'],
        'SAB':  ['ساب', 'الأول', 'sab', 'sabb', 'alawwal'],
        'JAZIRA': ['الجزيرة', 'jazira', 'aljazira'],
        'SAMBA': ['سامبا', 'samba'], // (مدمج مع الأهلي غالباً لكن قد يستخدم)
        'GIB':  ['الخليج', 'gib', 'gulf'],
        'YNB':  ['الوطني', 'ynb']
    };
    for (const [code, keywords] of Object.entries(bankMapping)) {
        if (keywords.some(keyword => name.includes(keyword))) {
            return code;
        }
    }
    if (cleanIban.length >= 6) {
        const bankId = cleanIban.substring(4, 6); // الرقمين الخامس والسادس في الآيبان
        const ibanMap = {
            '80': 'RJHI',  // الراجحي
            '10': 'NCB',   // الأهلي
            '20': 'RIYAD', // الرياض
            '90': 'INMA',  // الإنماء
            '15': 'BILAD', // البلاد
            '30': 'ANB',   // العربي
            '05': 'SAIB',  // الاستثمار
            '55': 'BSF',   // الفرنسي
            '45': 'SAB',   // ساب/الأول
            '60': 'JAZIRA',// الجزيرة
            '40': 'NCB',   // سامبا (أصبح أهلي)
            '50': 'SAB'    // الأول (أصبح ساب)
        };
        if (ibanMap[bankId]) return ibanMap[bankId];
    }
    return ''; 
}
document.body.addEventListener('click', async function(event) {
    const btn = event.target.closest('.export-bank-file-btn');
    if (btn) {
        const draftId = btn.dataset.id;
        btn.disabled = true;
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري المعالجة...';

        try {
            const { data: draft, error } = await supabaseClient
                .from('payroll_drafts')
                .select('payroll_data, month, year')
                .eq('id', draftId)
                .single();

            if (error) throw error;
            if (!draft.payroll_data || draft.payroll_data.length === 0) throw new Error('لا توجد بيانات.');
            const csvHeader = "عنوان الموظف,رقم الهوية او الإقامة,اسم الموظف,إجمالي الراتب,رقم الحساب,البنك\n";

            const csvRows = draft.payroll_data.map(emp => {
                const location = (emp.location || 'غير محدد').replace(/,/g, ' ').trim();
                const nationalId = emp.id_number || '';
                const name = (emp.name || '').replace(/,/g, ' ').trim();
                const amount = (parseFloat(emp.net_salary) || 0).toFixed(2);
                const iban = (emp.iban || '').replace(/\s/g, '').toUpperCase();
                const bankCode = getSaudiBankCode(emp.bank_name, iban);
                return `${location},${nationalId},"${name}",${amount},${iban},${bankCode}`;
            }).join('\n');
            const csvContent = "\uFEFF" + csvHeader + csvRows;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `BankTransfer_${draft.month}_${draft.year}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (err) {
            alert('فشل تصدير الملف: ' + err.message);
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ph-bold ph-bank"></i> ملف البنك';
        }
    }
});

document.body.addEventListener('click', async function(event) {
    const saveDraftBtn = event.target.closest('#save-draft-changes-btn');
    if (saveDraftBtn) {
        saveDraftBtn.disabled = true;
        saveDraftBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري الحفظ...';

        try {
            const { error } = await supabaseClient
                .from('payroll_drafts')
                .update({ payroll_data: currentDraftData })
                .eq('id', currentDraftId);

            if (error) throw error;
            showToast('تم حفظ تعديلات المسودة.', 'success');
        } catch (err) {
            alert('فشل الحفظ: ' + err.message);
        } finally {
            saveDraftBtn.disabled = false;
            saveDraftBtn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> حفظ التغييرات';
        }
        return;
    }
    const exportDraftBtn = event.target.closest('#export-draft-excel-btn');
    if (exportDraftBtn) {
        exportDraftBtn.disabled = true;
        exportDraftBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري التصدير...';

        try {
            const exportData = prepareExportData(currentDraftData); // استخدام دالة التجهيز بالأسفل
            const firstEmp = currentDraftData[0];
            const projectName = firstEmp ? (firstEmp.project || 'عام') : 'عام';
            const filename = `مسير_${projectName}_${currentDraftDetails.month}-${currentDraftDetails.year}.xlsx`;

            await exportPayrollToExcel(exportData, filename);
        } catch (err) {
            alert('خطأ في التصدير: ' + err.message);
        } finally {
            exportDraftBtn.disabled = false;
            exportDraftBtn.innerHTML = '<i class="ph-bold ph-file-xls"></i> تصدير Excel';
        }
        return;
    }
    const submitManagerBtn = event.target.closest('#submit-to-manager-btn');
    if (submitManagerBtn) {
        if (!confirm('هل أنت متأكد من إرسال المسير للمدير للمراجعة؟\nلن تتمكن من تعديله بعد الإرسال.')) return;

        submitManagerBtn.disabled = true;
        submitManagerBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري الإرسال...';

        try {
            const { error } = await supabaseClient
                .from('payroll_drafts')
                .update({ 
                    payroll_data: currentDraftData, 
                    status: 'pending_manager' 
                })
                .eq('id', currentDraftId);

            if (error) throw error;
            const { data: managers } = await supabaseClient.from('users').select('id').eq('is_hr_manager', true);
            if (managers && managers.length > 0) {
                sendNotification(managers.map(u => u.id), 'مسير بانتظار المراجعة', 'تم رفع مسير جديد للمراجعة والاعتماد.', '/payroll-dashboard');
            }

            showToast('تم إرسال المسير للمدير بنجاح.', 'success');
            document.getElementById('payroll-draft-editor-modal').classList.add('hidden');
            if (document.querySelector('#page-payroll:not(.hidden)')) {
                document.getElementById('payroll-results-container').innerHTML = '<p style="text-align:center;">تم إرسال المسير.</p>';
            }
        } catch (err) {
            alert('خطأ: ' + err.message);
            submitManagerBtn.disabled = false;
            submitManagerBtn.innerHTML = '<i class="ph-bold ph-paper-plane-right"></i> إرسال للمدير للمراجعة';
        }
        return;
    }
    const approveBtn = event.target.closest('#approve-draft-btn');
    if (approveBtn) {
        if (!confirm('هل أنت متأكد من اعتماد هذا المسير؟\nسيتم إغلاق التعديل ورفع طلب مالي تلقائي لدورة الاعتماد.')) return;

        approveBtn.disabled = true;
        approveBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري الرفع...';

        try {
            const totalNet = currentDraftData.reduce((sum, row) => sum + (parseFloat(row.net_salary) || 0), 0);
            const firstEmp = currentDraftData[0];
            const projectName = firstEmp ? (firstEmp.project || 'مشروع') : 'عام';
            const requestTitle = `مسير رواتب ${currentDraftDetails.month}/${currentDraftDetails.year} - ${projectName}`;
            const financePayload = {
                user_id: currentUser.id,
                requesting_department: 'ادارة الموارد البشرية',
                request_type: 'رواتب ومسيرات',
                request_title: requestTitle,
                amount: totalNet,
                status: 'بانتظار المدير المالي',
                linked_draft_id: currentDraftId,
                payment_method: 'bank_file',
                notes: `تم اعتماد المسير. عدد الموظفين: ${currentDraftData.length}`
            };

            const { error: financeError } = await supabaseClient.from('financial_requests').insert(financePayload);
            if (financeError) throw new Error('فشل إنشاء الطلب المالي: ' + financeError.message);
            const { error: draftError } = await supabaseClient
                .from('payroll_drafts')
                .update({ 
                    payroll_data: currentDraftData,
                    status: 'approved_by_hr'
                })
                .eq('id', currentDraftId);
            if (draftError) throw draftError;
            const employeesToUpdateUniform = currentDraftData.filter(p => p.deductions.uniform > 0).map(p => p.id);
            if (employeesToUpdateUniform.length > 0) {
                await supabaseClient.from('users').update({ has_received_uniform: true }).in('id', employeesToUpdateUniform);
            }
            const { data: cfoUsers } = await supabaseClient.from('users').select('id').eq('is_cfo', true);
            if (cfoUsers && cfoUsers.length > 0) {
                sendNotification(cfoUsers.map(u => u.id), 'مسير رواتب جديد', `تم رفع ${requestTitle} للاعتماد.`, '/finance/cfo-approvals');
            }
            const exportData = prepareExportData(currentDraftData);
            const filename = `مسير_${projectName}_${currentDraftDetails.month}-${currentDraftDetails.year}.xlsx`;
            await exportPayrollToExcel(exportData, filename);

            showToast('تم الاعتماد والرفع بنجاح!', 'success');
            document.getElementById('payroll-draft-editor-modal').classList.add('hidden');
            
            if (document.querySelector('#page-payroll-dashboard:not(.hidden)')) {
                loadPayrollDashboardPage();
            }

        } catch (err) {
            alert('خطأ: ' + err.message);
            console.error(err);
        } finally {
            approveBtn.disabled = false;
            approveBtn.innerHTML = '<i class="ph-bold ph-check-fat"></i> اعتماد ورفع للمالية';
        }
        return;
    }
});
function prepareExportData(data) {
    return data.map(row => ({
        "اسم الموظف": row.name,
        "رقم الهوية": row.id_number,
        "المنطقة": row.region,
        "المشروع": row.project,
        "الموقع": row.location,
        "الراتب الاساسي": row.basic_salary,
        "بدل السكن": row.housing,
        "بدل نقل": row.transport,
        "بدلات اخرى": row.other,
        "اجمالي الراتب": row.total_gross,
        "قيمة اليومية": row.daily_rate,
        "ايام العمل": row.worked_days,
        "راحة": row.rest_days,
        "ايام الغياب": row.absent_days,
        "انسحاب": row.withdrawal_count,
        "ايام تغطية الموقع": row.covered_days,
        "بدل راحة": row.additions.rest_allowance,
        "عمل اضافي": row.additions.overtime,
        "المستحق": row.additions.gross_payable,
        "خصم الغياب": row.deductions.absence,
        "خصم التأخير": row.deductions.lateness,
        "استقطاع تأمينات": row.deductions.gosi,
        "خصم الزي": row.deductions.uniform,
        "سلفة": row.deductions.loan,
        "خصومات اخرى": row.deductions.other,
        "مجموع الاستقطاعات": row.deductions.total,
        "الصافي": row.net_salary,
        "البنك": row.bank_name,
        "الآيبان": row.iban,
        "ملاحظات": row.note || ''
    }));
}
document.body.addEventListener('click', async (e) => {
    const btn = e.target.closest('.manage-branch-shifts-btn');
    if (btn) {
        const branchId = btn.dataset.id;
        const branchName = btn.dataset.name;
        
        const modal = document.getElementById('branch-shifts-modal');
        document.getElementById('branch-shifts-title').textContent = `أوقات الدوام - فرع: ${branchName}`;
        document.getElementById('manage-shifts-branch-id').value = branchId;
        document.getElementById('add-branch-shift-form').reset();
        
        modal.classList.remove('hidden');
        loadBranchShifts(branchId);
    }
    const deleteShiftBtn = e.target.closest('.delete-branch-shift-btn');
    if (deleteShiftBtn) {
        if(confirm('هل أنت متأكد من حذف وقت الدوام هذا؟')) {
            const shiftId = deleteShiftBtn.dataset.id;
            const branchId = document.getElementById('manage-shifts-branch-id').value;
            
            const { error } = await supabaseClient.from('branch_shifts').delete().eq('id', shiftId);
            if(error) alert('خطأ: ' + error.message);
            else loadBranchShifts(branchId);
        }
    }
});
async function loadBranchShifts(branchId) {
    const container = document.getElementById('branch-shifts-list');
    container.innerHTML = '<p style="text-align:center;">جاري التحميل...</p>';
    
    const { data: shifts, error } = await supabaseClient
        .from('branch_shifts')
        .select('*')
        .eq('branch_id', branchId)
        .order('start_time');

    if (error) {
        container.innerHTML = `<p style="color:red;">خطأ: ${error.message}</p>`;
        return;
    }

    if (shifts.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>لا توجد أوقات دوام مسجلة لهذا الفرع.</p></div>';
        return;
    }
    const dayMap = {Sun: 'الأحد', Mon: 'الاثنين', Tue: 'الثلاثاء', Wed: 'الأربعاء', Thu: 'الخميس', Fri: 'الجمعة', Sat: 'السبت'};

    container.innerHTML = `
        <table class="attendance-log-table">
            <thead><tr><th>المسمى</th><th>الوقت</th><th>الأيام</th><th>إجراء</th></tr></thead>
            <tbody>
                ${shifts.map(s => {
                    const daysStr = (s.work_days || []).map(d => dayMap[d] || d).join('، ');
                    const timeStr = `${formatTimeAMPM(s.start_time.slice(0,5))} - ${formatTimeAMPM(s.end_time.slice(0,5))}`;
                    return `
                        <tr>
                            <td>${s.name}</td>
                            <td style="direction:ltr;">${timeStr}</td>
                            <td><small>${daysStr}</small></td>
                            <td><button class="btn btn-danger btn-sm delete-branch-shift-btn" data-id="${s.id}"><i class="ph-bold ph-trash"></i></button></td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}
document.body.addEventListener('submit', async function(e) {
    if (e.target.id === 'add-branch-shift-form') {
        e.preventDefault(); // <--- هذا السطر يمنع تحديث الصفحة
        
        const form = e.target;
        const btn = form.querySelector('button[type="submit"]');
        const branchId = document.getElementById('manage-shifts-branch-id').value;
        const selectedDays = Array.from(form.querySelectorAll('.weekdays-selector input:checked')).map(cb => cb.value);
        
        if(selectedDays.length === 0) return alert('الرجاء اختيار يوم عمل واحد على الأقل.');

        btn.disabled = true;
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> جاري الحفظ...';
        
        try {
            const shiftData = {
                branch_id: branchId,
                name: document.getElementById('new-shift-name').value,
                start_time: document.getElementById('new-shift-start').value,
                end_time: document.getElementById('new-shift-end').value,
                work_days: selectedDays
            };

            const { error } = await supabaseClient.from('branch_shifts').insert(shiftData);
            if(error) throw error;
            
            showToast('تمت إضافة الوقت بنجاح', 'success');
            form.reset(); // إفراغ الحقول
            form.querySelectorAll('.weekdays-selector input').forEach(cb => cb.checked = true);
            
            loadBranchShifts(branchId); // تحديث القائمة
            
        } catch(err) {
            alert('خطأ: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ph-bold ph-plus"></i> إضافة الوقت';
        }
    }
});
document.body.addEventListener('change', async function(event) {
    if (event.target.id === 'cmd-emp-branch' || event.target.id === 'employee-branch') {
        const branchId = event.target.value;
        const targetShiftSelectId = event.target.id === 'cmd-emp-branch' ? 'cmd-emp-shift' : 'employee-branch-shift';
        const shiftSelect = document.getElementById(targetShiftSelectId);
        shiftSelect.innerHTML = '<option value="">جاري التحميل...</option>';
        shiftSelect.disabled = true;

        if (!branchId) {
            shiftSelect.innerHTML = '<option value="">-- اختر الفرع أولاً --</option>';
            return;
        }

        const { data: shifts, error } = await supabaseClient
            .from('branch_shifts')
            .select('id, name, start_time, end_time')
            .eq('branch_id', branchId);

        if (error) {
            console.error("Error fetching shifts:", error);
            shiftSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
            return;
        }

        if (shifts && shifts.length > 0) {
            shiftSelect.innerHTML = '<option value="">-- اختر وقت الدوام --</option>';
            shifts.forEach(s => {
                const start = s.start_time.slice(0, 5);
                const end = s.end_time.slice(0, 5);
                const timeLabel = typeof formatTimeAMPM === 'function' 
                    ? `${s.name} (${formatTimeAMPM(start)} - ${formatTimeAMPM(end)})`
                    : `${s.name} (${start} - ${end})`;
                    
                shiftSelect.innerHTML += `<option value="${s.id}">${timeLabel}</option>`;
            });
            shiftSelect.disabled = false;
        } else {
            shiftSelect.innerHTML = '<option value="">لا توجد أوقات مسجلة لهذا الفرع</option>';
        }
    }
});
